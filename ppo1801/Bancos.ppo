#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 7 ".\.\Prg\Bancos.prg"
_HB_CLASS TBancos ; function TBancos ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TBancos", iif( .T., { @TMant() }, { @HBObject() } ), @TBancos() ) ) ;

   _HB_MEMBER { cName } ; oClass:AddMultiData(, "Bancos", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cName"}, .F. )

   _HB_MEMBER { cMru } ; oClass:AddMultiData(, "gc_central_bank_euro_16", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cMru"}, .F. )

   _HB_MEMBER { cBitmap } ; oClass:AddMultiData(, ( 104 + ( 0 * 256 ) + ( 63 * 65536 ) ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cBitmap"}, .F. )

   _HB_MEMBER Create( cPath) AS CLASS TBancos; oClass:AddMethod( "Create", @TBancos_Create(), nScope + iif( .T., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER New( cPath, oWndParent, oMenuItem) AS CLASS TBancos; oClass:AddMethod( "New", @TBancos_New(), nScope + iif( .T., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles( lExclusive); oClass:AddMethod( "OpenFiles", @TBancos_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TBancos_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TBancos_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode); oClass:AddMethod( "Resource", @TBancos_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lPreSave( oGet, nMode); oClass:AddMethod( "lPreSave", @TBancos_lPreSave(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )






   _HB_MEMBER GetCuentaBancaria(); oClass:AddInline( "GetCuentaBancaria", {|Self | ( ( Self ) ), ( ::oDbf:FieldGetByName( "cPaisIBAN" )   +  ::oDbf:FieldGetByName( "cCtrlIBAN" )   +  ::oDbf:FieldGetByName( "cEntBnc" )     +  ::oDbf:FieldGetByName( "cSucBnc" )     +  ::oDbf:FieldGetByName( "cDigBnc" )     +  ::oDbf:FieldGetByName( "cCtaBnc" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TBancos ;



static FUNCTION TBancos_Create( cPath ) ; local Self AS CLASS TBancos := QSelf() AS CLASS TBancos

   If( cPath == nil, cPath := cPatEmp(), ) ;

   ::cPath              := cPath
   ::oDbf               := nil

RETURN ( Self )



static FUNCTION TBancos_New( cPath, oWndParent, oMenuItem ) ; local Self AS CLASS TBancos := QSelf() AS CLASS TBancos

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;

   if oMenuItem <> nil
      ::nLevel          := Auth():Level( oMenuItem )
   else
      ::nLevel          := Auth():Level( "01106" )
   end

   ::cPath              := cPath
   ::oWndParent         := oWndParent
   ::oDbf               := nil

   ::lAutoButtons       := .T.
   ::lCreateShell       := .F.

   ::cBitmap            := ( 104 + ( 0 * 256 ) + ( 63 * 65536 ) )

RETURN ( Self )



static FUNCTION TBancos_OpenFiles( lExclusive, cPath ) ; local Self AS CLASS TBancos := QSelf() AS CLASS TBancos

   local lOpen          := .T.
   local oError
   local oBlock

   If( lExclusive == nil, lExclusive := .F., ) ;
   If( cPath == nil, cPath := cPatEmp(), ) ;

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf         := ::DefineFiles( cPath )
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

   RECOVER USING oError

      lOpen             := .F.

      ::CloseFiles()

      msgStop( ErrorMessage( oError ), "Imposible abrir las bases de datos de bancos" )

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TBancos_CloseFiles( ) ; local Self AS CLASS TBancos := QSelf() AS CLASS TBancos

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   ::oDbf               := nil

RETURN .T.



static FUNCTION TBancos_DefineFiles( cPath, cDriver ) ; local Self AS CLASS TBancos := QSelf() AS CLASS TBancos

   local oDbf

   If( cPath == nil, cPath := ::cPath, ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   oDbf := DbfServer( "Bancos.Dbf", "Bancos" ):New( "Bancos.Dbf", "Bancos", ( cDriver ), "Bancos de empresa", ( cPath ) )

      oDbf:AddField( "cCodBnc", "C", 4, 0, "@!",,,, "Código", .F., 60, .F., {} )
      oDbf:AddField( "cNomBnc", "C", 50, 0, "@!",,,, "Nombre", .F., 300, .F., {} )
      oDbf:AddField( "cNomSuc", "C", 50, 0,,,,, "Nombre sucursal", .F.,, .T., {} )
      oDbf:AddField( "cDirBnc", "C", 35, 0,,,,, "Domicilio del banco", .F.,, .T., {} )
      oDbf:AddField( "cPobBnc", "C", 25, 0,,,,, "Población del banco", .F.,, .T., {} )
      oDbf:AddField( "cProBnc", "C", 20, 0,,,,, "Provincia del banco", .F.,, .T., {} )
      oDbf:AddField( "cPosBnc", "C", 15, 0,,,,, "Código postal del banco", .F.,, .T., {} )
      oDbf:AddField( "cTlfBnc", "C", 20, 0,,,,, "Teléfono del banco", .F.,, .T., {} )
      oDbf:AddField( "cFaxBnc", "C", 20, 0,,,,, "Fax del banco", .F.,, .T., {} )
      oDbf:AddField( "cPCoBnc", "C", 35, 0,,,,, "Persona de contacto", .F.,, .T., {} )
      oDbf:AddField( "cEntBnc", "C", 4, 0, "@!",,,, "Entidad", .F., 60, .F., {} )
      oDbf:AddField( "cOfiBnc", "C", 4, 0, "@!",,,, "Oficina", .F., 60, .F., {} )

      oDbf:AddIndex( "cCodBnc", "Bancos.Cdx", "cCodBnc",,, .F., .F., "Código",,, .T., .F. )
      oDbf:AddIndex( "cNomBnc", "Bancos.Cdx", "cNomBnc",,, .F., .F., "Nombre",,, .T., .F. )



RETURN ( oDbf )



static FUNCTION TBancos_Resource( nMode ) ; local Self AS CLASS TBancos := QSelf() AS CLASS TBancos

    local oDlg
   local oGet  := Array( 14 )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "banco", "Bancos",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






      oGet[ 1 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::oDbf:cCodBnc, ::oDbf:cCodBnc:= u ) }, oDlg,, "@!", {||    NotValid( oGet[ 1 ], ::oDbf:cAlias, .T., "0" )},,,,,, .T., {||     ( nMode == 1 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 2 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:cNomBnc, ::oDbf:cNomBnc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 3 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbf:cNomSuc, ::oDbf:cNomSuc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 4 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbf:cDirBnc, ::oDbf:cDirBnc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 5 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::oDbf:cPobBnc, ::oDbf:cPobBnc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 6 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::oDbf:cProBnc, ::oDbf:cProBnc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 7 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::oDbf:cPosBnc, ::oDbf:cPosBnc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 8 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::oDbf:cTlfBnc, ::oDbf:cTlfBnc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 9 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::oDbf:cFaxBnc, ::oDbf:cFaxBnc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oGet[ 10 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::oDbf:cPCoBnc, ::oDbf:cPCoBnc:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      oGet[ 11 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::oDbf:cEntBnc, ::oDbf:cEntBnc:= u ) }, oDlg,, "9999",,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      oGet[ 12 ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::oDbf:cOfiBnc, ::oDbf:cOfiBnc:= u ) }, oDlg,, "9999",,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TButton():ReDefine( 500, {||( if( ::lPreSave( oGet, nMode ), oDlg:end( 1 ), ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 550, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| if( ::lPreSave( oGet, nMode ), oDlg:end( 1 ), ) } )
   end

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )



static FUNCTION TBancos_lPreSave( oGet, nMode ) ; local Self AS CLASS TBancos := QSelf() AS CLASS TBancos

   if ( nMode == 1 .OR. nMode == 4 ) .AND. !oGet[ 1 ]:lValid()
      Return .F.
   end

   if Empty( ::oDbf:cNomBnc )
      MsgStop( "El nombre del banco no puede estar vacío." )
      oGet[ 2 ]:SetFocus()
      Return .F.
   end

RETURN .T.







_HB_CLASS TCuentasBancarias ; function TCuentasBancarias ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TCuentasBancarias", iif( .T., { @TMant() }, { @HBObject() } ), @TCuentasBancarias() ) ) ;

   _HB_MEMBER { cMru } ; oClass:AddMultiData(, "gc_central_bank_euro_text_16", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cMru"}, .F. )

   _HB_MEMBER { oBanco } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBanco"}, .F. )

   _HB_MEMBER { oPedCliP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPedCliP"}, .F. )
   _HB_MEMBER { oAlbCliP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliP"}, .F. )
   _HB_MEMBER { oFacCliP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliP"}, .F. )
   _HB_MEMBER { oFacPrvP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacPrvP"}, .F. )

   _HB_MEMBER { lBreak } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lBreak"}, .F. )

   _HB_MEMBER { oGetSaldoActual } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetSaldoActual"}, .F. )
   _HB_MEMBER { nGetSaldoActual } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nGetSaldoActual"}, .F. )

   _HB_MEMBER Create( cPath) AS CLASS TCuentasBancarias; oClass:AddMethod( "Create", @TCuentasBancarias_Create(), nScope + iif( .T., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER New( cPath, oWndParent, oMenuItem) AS CLASS TCuentasBancarias; oClass:AddMethod( "New", @TCuentasBancarias_New(), nScope + iif( .T., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles( lExclusive); oClass:AddMethod( "OpenFiles", @TCuentasBancarias_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TCuentasBancarias_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenService( lExclusive); oClass:AddMethod( "OpenService", @TCuentasBancarias_OpenService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseService(); oClass:AddMethod( "CloseService", @TCuentasBancarias_CloseService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TCuentasBancarias_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @TCuentasBancarias_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode); oClass:AddMethod( "Resource", @TCuentasBancarias_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lEndResource( oGet, nMode); oClass:AddMethod( "lEndResource", @TCuentasBancarias_lEndResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lLoadBanco( aGet, nMode); oClass:AddMethod( "lLoadBanco", @TCuentasBancarias_lLoadBanco(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nSaldoActual(); oClass:AddMethod( "nSaldoActual", @TCuentasBancarias_nSaldoActual(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER nSaldoSesion( cCta, cTurRec); oClass:AddMethod( "nSaldoSesion", @TCuentasBancarias_nSaldoSesion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TCuentasBancarias ;



static FUNCTION TCuentasBancarias_Create( cPath ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   If( cPath == nil, cPath := cPatEmp(), ) ;

   ::cPath              := cPath
   ::oDbf               := nil

RETURN ( Self )



static FUNCTION TCuentasBancarias_New( cPath, oWndParent, oMenuItem ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;

   if oMenuItem <> nil
      ::nLevel          := Auth():Level( oMenuItem )
   else
      ::nLevel          := Auth():Level( "01106" )
   end

   ::cPath              := cPath
   ::oWndParent         := oWndParent
   ::oDbf               := nil

   ::lAutoButtons       := .T.
   ::lCreateShell       := .F.

RETURN ( Self )



static FUNCTION TCuentasBancarias_OpenFiles( lExclusive ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   local lOpen          := .T.
   local oError
   local oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   If( lExclusive == nil, lExclusive := .F., ) ;

   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf         := ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

      ::oPedCliP := DbfServer( "PedCliP.Dbf", "PedCliP" ):NewOpen( "PedCliP.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oPedCliP:AddBag( "PedCliP.Cdx" ) ; ::oPedCliP:AddBag( ) ; ::oPedCliP:AutoIndex()

      ::oAlbCliP := DbfServer( "AlbCliP.Dbf", "AlbCliP" ):NewOpen( "AlbCliP.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbCliP:AddBag( "AlbCliP.Cdx" ) ; ::oAlbCliP:AddBag( ) ; ::oAlbCliP:AutoIndex()

      ::oFacCliP        := TDataCenter():oFacCliP()

      ::oFacPrvP := DbfServer( "FacPrvP.Dbf", "FacPrvP" ):NewOpen( "FacPrvP.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacPrvP:AddBag( "FacPrvP.Cdx" ) ; ::oFacPrvP:AddBag( ) ; ::oFacPrvP:AutoIndex()

      ::oBanco          := TBancos():Create()
      ::oBanco:OpenFiles()

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir las bases de datos de cuentas bancarias" )

      ::CloseFiles()

      lOpen             := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TCuentasBancarias_CloseFiles( ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   if !Empty( ::oPedCliP ) .AND. ( ::oPedCliP:Used() )
      ::oPedCliP:end()
   end

   if !Empty( ::oAlbCliP ) .AND. ( ::oAlbCliP:Used() )
      ::oAlbCliP:end()
   end

   if !Empty( ::oFacCliP )
      ::oFacCliP:End()
   end

   if !Empty( ::oFacPrvP )
      ::oFacPrvP:End()
   end

   if !Empty( ::oBanco )
      ::oBanco:End()
   end

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   ::oDbf         := nil
   ::oFacCliP     := nil
   ::oFacPrvP     := nil
   ::oBanco       := nil

RETURN .T.



static FUNCTION TCuentasBancarias_OpenService( lExclusive, cPath ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   local lOpen          := .T.
   local oError
   local oBlock

   If( lExclusive == nil, lExclusive := .F., ) ;

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf         := ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

   RECOVER USING oError

      lOpen             := .F.

      ::CloseService()

      msgStop( ErrorMessage( oError ), "Imposible abrir las bases de datos de bancos" )

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TCuentasBancarias_CloseService( ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   if !Empty( ::oDbf ) .AND. ::oDbf:Used()
      ::oDbf:End()
   end

RETURN ( .T. )



static FUNCTION TCuentasBancarias_DefineFiles( cPath, cDriver ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   local oDbf

   If( cPath == nil, cPath := ::cPath, ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   oDbf := DbfServer( "EmpBnc.Dbf", "EmpBnc" ):New( "EmpBnc.Dbf", "EmpBnc", ( cDriver ), "Cuentas bancarias", ( cPath ) )

      oDbf:AddField( "cCodBnc", "C", 3, 0, "@!",,,, "Código", .F., 60, .F., {} )

      oDbf:AddField( "cPaisIBAN", "C", 2, 0,,,,, "País IBAN", .F.,, .T., {} )
      oDbf:AddField( "cCtrlIBAN", "C", 2, 0,,,,, "Dígito de control IBAN", .F.,, .T., {} )

      oDbf:AddField( "cEntBnc", "C", 4, 0,,,,, "Entidad bancaria", .F.,, .T., {} )
      oDbf:AddField( "cSucBnc", "C", 4, 0,,,,, "Sucursal bancaria", .F.,, .T., {} )
      oDbf:AddField( "cDigBnc", "C", 2, 0,,,,, "Dígito control", .F.,, .T., {} )
      oDbf:AddField( "cCtaBnc", "C", 10, 0,,,,, "Cuenta", .F.,, .T., {} )
      oDbf:AddField( "cNomBnc", "C", 50, 0,,,,, "Nombre del banco", .F., 300, .F., {} )



      oDbf:AddField( "bCtaBnc", "B", 14, 0,,,, {|| oDbf:FieldGetByName( "cPaisIBAN" ) + oDbf:FieldGetByName( "cCtrlIBAN" ) + "-" + oDbf:FieldGetByName( "cEntBnc" ) + "-" + oDbf:FieldGetByName( "cSucBnc" ) + "-" + oDbf:FieldGetByName( "cDigBnc" ) + "-" + oDbf:FieldGetByName( "cCtaBnc" ) }, "Cuenta bancaria", .F., 200, .F., {} )

      oDbf:AddField( "cDirBnc", "C", 35, 0,,,,, "Domicilio del banco", .F.,, .T., {} )
      oDbf:AddField( "cPobBnc", "C", 25, 0,,,,, "Población del banco", .F.,, .T., {} )
      oDbf:AddField( "cProBnc", "C", 20, 0,,,,, "Provincia del banco", .F.,, .T., {} )
      oDbf:AddField( "cCPBnc", "C", 15, 0,,,,, "Código postal", .F.,, .T., {} )
      oDbf:AddField( "cTlfBnc", "C", 20, 0, "@!",,,, "Teléfono", .F., 60, .F., {} )
      oDbf:AddField( "cFaxBnc", "C", 20, 0, "@!",,,, "Fax", .F., 60, .F., {} )
      oDbf:AddField( "cPContBnc", "C", 35, 0,,,,, "Persona de contacto", .F., 160, .F., {} )
      oDbf:AddField( "cPaiBnc", "C", 4, 0, "@!",,,, "Pais", .F., 120, .F., {} )
      oDbf:AddField( "nSalIni", "N", 16, 0,,,,, "Saldo inicial", .F.,, .T., {} )

      oDbf:AddIndex( "cCodBnc", "EmpBnc.Cdx", "cCodBnc",,, .F., .F., "Código",,, .T., .F. )
      oDbf:AddIndex( "cNomBnc", "EmpBnc.Cdx", "cNomBnc",,, .F., .F., "Nombre",,, .T., .F. )
      oDbf:AddIndex( "cCtaBnc", "EmpBnc.Cdx", "cPaisIBAN + cCtrlIBAN + cEntBnc + cSucBnc + cDigBnc + cCtaBnc",,, .F., .F., "Cuenta",,, .T., .F. )



RETURN ( oDbf )



static FUNCTION TCuentasBancarias_Activate( ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return ( Self )
   end





   if ::oWndParent <> nil
      ::oWndParent:CloseAll()
   end

   if Empty( ::oDbf ) .OR. !::oDbf:Used()
      ::lOpenFiles      := ::OpenFiles()
   end





   if ::lOpenFiles

      if !::lCreateShell
         ::CreateShell( ::nLevel )
      end

      ::oWndBrw:GralButtons( Self )






      ::oWndBrw:NewAt( "gc_document_empty_chart_",,, {||( TFastCuentasBancarias():New():Play() )}, "Rep(o)rting", "O",,, 32,, .F. )

      ::oWndBrw:EndButtons( Self )

      if ::cHtmlHelp <> nil
         ::oWndBrw:cHtmlHelp  := ::cHtmlHelp
      end

      ::oWndBrw:Activate( , , , , , , , , , , , , , , , , {|| ::CloseFiles() } )

   end

RETURN ( Self )



static FUNCTION TCuentasBancarias_Resource( nMode ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

    local oDlg
   local aGet
   local oBmpBancos

   aGet                 := Array( ::oDbf:FieldCount() )

   ::lBreak             := .F.

   if Empty( ::oDbf:cPaisIBAN )
      ::oDbf:cPaisIBAN  := "ES"
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "cuentas bancarias", "BancoEmpresa",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmpBancos := TBitmap():ReDefine( 600, "gc_office_building_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )







      aGet[ ::oDbf:FieldPos( "cCodBnc" ) ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::oDbf:cCodBnc, ::oDbf:cCodBnc:= u ) }, oDlg,, "@!", {||    ( NotValid( aGet[ ::oDbf:FieldPos( "cCodBnc" ) ], ::oDbf:cAlias, .T., "0" ) )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,,, nil,,, )






      aGet[ ::oDbf:FieldPos( "cNomBnc" ) ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::oDbf:cNomBnc, ::oDbf:cNomBnc:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "Lupa",, )

      aGet[ ::oDbf:FieldPos( "cNomBnc" ) ]:bHelp   := {|| ::lLoadBanco( aGet, nMode ) }





      aGet[ ::oDbf:FieldPos( "cDirBnc" ) ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::oDbf:cDirBnc, ::oDbf:cDirBnc:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ::oDbf:FieldPos( "cPobBnc" ) ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::oDbf:cPobBnc, ::oDbf:cPobBnc:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ::oDbf:FieldPos( "cCPBnc" ) ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, ::oDbf:cCPBnc, ::oDbf:cCPBnc:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ::oDbf:FieldPos( "cProBnc" ) ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, ::oDbf:cProBnc, ::oDbf:cProBnc:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ::oDbf:FieldPos( "cTlfBnc" ) ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, ::oDbf:cTlfBnc, ::oDbf:cTlfBnc:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ::oDbf:FieldPos( "cFaxBnc" ) ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, ::oDbf:cFaxBnc, ::oDbf:cFaxBnc:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ::oDbf:FieldPos( "cPContBnc" ) ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, ::oDbf:cPContBnc, ::oDbf:cPContBnc:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ ::oDbf:FieldPos( "cPaisIBAN" ) ] := TGetHlp():ReDefine( 370, { | u | If( PCount()==0, ::oDbf:cPaisIBAN, ::oDbf:cPaisIBAN:= u ) }, oDlg,, "@!", {||    ( lIbanDigit( ::oDbf:cPaisIBAN, ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cCtrlIBAN" ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ ::oDbf:FieldPos( "cCtrlIBAN" ) ] := TGetHlp():ReDefine( 380, { | u | If( PCount()==0, ::oDbf:cCtrlIBAN, ::oDbf:cCtrlIBAN:= u ) }, oDlg,,, {||    ( lIbanDigit( ::oDbf:cPaisIBAN, ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cCtrlIBAN" ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ ::oDbf:FieldPos( "cEntBnc" ) ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, ::oDbf:cEntBnc, ::oDbf:cEntBnc:= u ) }, oDlg,,, {||    (  lCalcDC( ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cDigBnc" ) ], ::oDbf:cPaisIBAN ) .AND. lIbanDigit( ::oDbf:cPaisIBAN, ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cCtrlIBAN" ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ ::oDbf:FieldPos( "cSucBnc" ) ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, ::oDbf:cSucBnc, ::oDbf:cSucBnc:= u ) }, oDlg,,, {||    (  lCalcDC( ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cDigBnc" ) ], ::oDbf:cPaisIBAN ) .AND. lIbanDigit( ::oDbf:cPaisIBAN, ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cCtrlIBAN" ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ ::oDbf:FieldPos( "cDigBnc" ) ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, ::oDbf:cDigBnc, ::oDbf:cDigBnc:= u ) }, oDlg,,, {||    (  lCalcDC( ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cDigBnc" ) ], ::oDbf:cPaisIBAN ) .AND. lIbanDigit( ::oDbf:cPaisIBAN, ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cCtrlIBAN" ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ ::oDbf:FieldPos( "cCtaBnc" ) ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, ::oDbf:cCtaBnc, ::oDbf:cCtaBnc:= u ) }, oDlg,, "9999999999", {||    (  lCalcDC( ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cDigBnc" ) ], ::oDbf:cPaisIBAN ) .AND. lIbanDigit( ::oDbf:cPaisIBAN, ::oDbf:cEntBnc, ::oDbf:cSucBnc, ::oDbf:cDigBnc, ::oDbf:cCtaBnc, aGet[ ::oDbf:FieldPos( "cCtrlIBAN" ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ ::oDbf:FieldPos( "nSalIni" ) ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, ::oDbf:nSalIni, ::oDbf:nSalIni:= u ) }, oDlg,, cPorDiv(),,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      ::oGetSaldoActual := TGetHlp():ReDefine( 360, { | u | If( PCount()==0, ::nGetSaldoActual, ::nGetSaldoActual:= u ) }, oDlg,, cPorDiv(),,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      TBtnBmp():ReDefine( 361, "gc_recycle_16",,,,, {|| ::nSaldoActual() }, oDlg, .F., , .F. )









      TButton():ReDefine( 500, {||( ::lEndResource( aGet, oDlg, nMode ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 550, {||( ::lBreak := .T., SysRefresh(), oDlg:End() )}, oDlg,,, .F.,,,, .T. )





      if ( nMode <> 3 )
         oDlg:AddFastKey( 116, {|| ::lEndResource( aGet, oDlg, nMode ) } )
      end



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if !Empty( oBmpBancos )
      oBmpBancos:end()
   end

RETURN ( oDlg:nResult == 1 )



static FUNCTION TCuentasBancarias_lEndResource( aGet, oDlg, nMode ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   if ( nMode == 1 .OR. nMode == 4 ) .AND. !aGet[ ::oDbf:FieldPos( "cCodBnc" ) ]:lValid()
      Return .F.
   end

   if Empty( ::oDbf:cNomBnc )
      MsgStop( "El nombre del banco no puede estar vacío." )
      aGet[ ::oDbf:FieldPos( "cNomBnc" ) ]:SetFocus()
      Return .F.
   end

   if Empty( ::oDbf:cCtaBnc )
      MsgStop( "La cuenta del banco no puede estar vacío." )
      aGet[ ::oDbf:FieldPos( "cCtaBnc" ) ]:SetFocus()
      Return .F.
   end

   oDlg:End( 1 )

RETURN .T.



static FUNCTION TCuentasBancarias_lLoadBanco( aGet, nMode ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   local cBanco   := ""
   local cCuenta  := ""

   ::oBanco:Buscar( aGet[ ::oDbf:FieldPos( "cNomBnc" ) ], "cCodBnc" )

   cBanco         := aGet[ ::oDbf:FieldPos( "cNomBnc" ) ]:VarGet()

   aGet[ ::oDbf:FieldPos( "cNomBnc" ) ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cNomBnc" ) )
   aGet[ ::oDbf:FieldPos( "cDirBnc" ) ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cDirBnc" ) )
   aGet[ ::oDbf:FieldPos( "cPobBnc" ) ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cPobBnc" ) )
   aGet[ ::oDbf:FieldPos( "cProBnc" ) ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cProBnc" ) )
   aGet[ ::oDbf:FieldPos( "cCPBnc" )  ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cPosBnc" ) )
   aGet[ ::oDbf:FieldPos( "cTlfBnc" ) ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cTlfBnc" ) )
   aGet[ ::oDbf:FieldPos( "cFaxBnc" ) ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cFaxBnc" ) )
   aGet[ ::oDbf:FieldPos( "cPContBnc")]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cPcoBnc" ) )

   aGet[ ::oDbf:FieldPos( "cEntBnc" ) ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cEntBnc" ) )
   aGet[ ::oDbf:FieldPos( "cSucBnc" ) ]:cText( oRetFld( cBanco, ::oBanco:oDbf, "cOfiBnc" ) )
   aGet[ ::oDbf:FieldPos( "cDigBnc" ) ]:cText( Space( 2 ) )
   aGet[ ::oDbf:FieldPos( "cCtaBnc" ) ]:cText( Space( 10 ) )

Return .T.



static FUNCTION TCuentasBancarias_nSaldoActual( cCta ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   local nOrd
   local nSaldo      := 0

   If( cCta == nil, cCta := ::oDbf:bCtaBnc, ) ;

   if Empty( cCta )
      Return ( nSaldo )
   end

   CursorWait()





   nOrd              := ::oDbf:OrdSetFocus( "cCtaBnc" )

   if ::oDbf:Seek( cCta )
      nSaldo         := ::oDbf:nSalIni
   end

   ::oDbf:OrdSetFocus( nOrd )





   nOrd              := ::oPedCliP:OrdSetFocus( "lCtaBnc" )

   if ::oPedCliP:Seek( cCta )

      while !::lBreak .AND. ::oPedCliP:cEntEmp + ::oPedCliP:cSucEmp + ::oPedCliP:cDigEmp + ::oPedCliP:cCtaEmp == cCta .AND. !::oPedCliP:Eof()

         nSaldo      += ::oPedCliP:nImporte

         ::oPedCliP:Skip()

      end

   end

   ::oPedCliP:OrdSetFocus( nOrd )





   nOrd              := ::oAlbCliP:OrdSetFocus( "lCtaBnc" )

   if ::oAlbCliP:Seek( cCta )

      while !::lBreak .AND. ::oAlbCliP:cEntEmp + ::oAlbCliP:cSucEmp + ::oAlbCliP:cDigEmp + ::oAlbCliP:cCtaEmp == cCta .AND. !::oAlbCliP:Eof()

         nSaldo      += ::oAlbCliP:nImporte

         ::oAlbCliP:Skip()

      end

   end

   ::oAlbCliP:OrdSetFocus( nOrd )





   nOrd              := ::oFacCliP:OrdSetFocus( "lCtaBnc" )

   if ::oFacCliP:Seek( cCta )

      while !::lBreak .AND. ::oFacCliP:cEntEmp + ::oFacCliP:cSucEmp + ::oFacCliP:cDigEmp + ::oFacCliP:cCtaEmp == cCta .AND. !::oFacCliP:Eof()

         nSaldo      += ::oFacCliP:nImporte

         ::oFacCliP:Skip()

      end

   end

   ::oFacCliP:OrdSetFocus( nOrd )





   nOrd              := ::oFacPrvP:OrdSetFocus( "lCtaBnc" )

   if ::oFacPrvP:Seek( cCta )

      while !::lBreak .AND. ::oFacPrvP:cEntEmp + ::oFacPrvP:cSucEmp + ::oFacPrvP:cDigEmp + ::oFacPrvP:cCtaEmp == cCta .AND. !::oFacPrvP:Eof()

         nSaldo      -= ::oFacPrvP:nImporte

         ::oFacPrvP:Skip()

      end

   end

   ::oFacPrvP:OrdSetFocus( nOrd )

   if !Empty( ::oGetSaldoActual )
      ::oGetSaldoActual:cText( nSaldo )
   end

   CursorWE()

Return ( nSaldo )



static FUNCTION TCuentasBancarias_nSaldoSesion( cCta, cTurRec ) ; local Self AS CLASS TCuentasBancarias := QSelf() AS CLASS TCuentasBancarias

   local nOrd
   local nSaldo      := 0

   if Empty( cCta )
      Return ( nSaldo )
   end

   if Empty( cTurRec )
      Return ( nSaldo )
   end

   CursorWait()





   nOrd              := ::oDbf:OrdSetFocus( "cCtaBnc" )

   if ::oDbf:Seek( cCta )
      nSaldo         := ::oDbf:nSalIni
   end

   ::oDbf:OrdSetFocus( nOrd )





   nOrd              := ::oFacCliP:OrdSetFocus( "lCtaBnc" )

   if ::oFacCliP:Seek( cCta )

      while !::lBreak .AND. ::oFacCliP:cEntEmp + ::oFacCliP:cSucEmp + ::oFacCliP:cDigEmp + ::oFacCliP:cCtaEmp == cCta .AND. !::oFacCliP:Eof()

         if ::oFacCliP:cTurRec <> cTurRec
            nSaldo   += ::oFacCliP:nImporte
         end

         ::oFacCliP:Skip()

      end

   end

   ::oFacCliP:OrdSetFocus( nOrd )





   nOrd              := ::oFacPrvP:OrdSetFocus( "lCtaBnc" )

   if ::oFacPrvP:Seek( cCta )

      while !::lBreak .AND. ::oFacPrvP:cEntEmp + ::oFacPrvP:cSucEmp + ::oFacPrvP:cDigEmp + ::oFacPrvP:cCtaEmp == cCta .AND. !::oFacPrvP:Eof()

         if ::oFacPrvP:cTurRec <> cTurRec
            nSaldo   -= ::oFacPrvP:nImporte
         end

         ::oFacPrvP:Skip()

      end

   end

   ::oFacPrvP:OrdSetFocus( nOrd )

   if !Empty( ::oGetSaldoActual )
      ::oGetSaldoActual:cText( nSaldo )
   end

   CursorWE()

Return ( nSaldo )








_HB_CLASS TFastCuentasBancarias ; function TFastCuentasBancarias ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFastCuentasBancarias", iif( .T., { @TFastReportInfGen() }, { @HBObject() } ), @TFastCuentasBancarias() ) ) ;

   _HB_MEMBER { cResource } ; oClass:AddMultiData(, "ReportingDialog", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cResource"}, .F. )

   _HB_MEMBER { oPedCliP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPedCliP"}, .F. )
   _HB_MEMBER { oAlbCliP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliP"}, .F. )
   _HB_MEMBER { oFacCliP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliP"}, .F. )
   _HB_MEMBER { oFacPrvP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacPrvP"}, .F. )

   _HB_MEMBER lResource( cFld); oClass:AddMethod( "lResource", @TFastCuentasBancarias_lResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TFastCuentasBancarias_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TFastCuentasBancarias_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Create(); oClass:AddMethod( "Create", @TFastCuentasBancarias_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lGenerate(); oClass:AddMethod( "lGenerate", @TFastCuentasBancarias_lGenerate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lValidRegister(); oClass:AddMethod( "lValidRegister", @TFastCuentasBancarias_lValidRegister(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DataReport( oFr); oClass:AddMethod( "DataReport", @TFastCuentasBancarias_DataReport(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER StartDialog(); oClass:AddMethod( "StartDialog", @TFastCuentasBancarias_StartDialog(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER BuildTree( oTree, lSubNode); oClass:AddMethod( "BuildTree", @TFastCuentasBancarias_BuildTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AddPedidosClientes(); oClass:AddMethod( "AddPedidosClientes", @TFastCuentasBancarias_AddPedidosClientes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AddAlbaranesClientes(); oClass:AddMethod( "AddAlbaranesClientes", @TFastCuentasBancarias_AddAlbaranesClientes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AddRecibosClientes(); oClass:AddMethod( "AddRecibosClientes", @TFastCuentasBancarias_AddRecibosClientes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AddRecibosProveedores(); oClass:AddMethod( "AddRecibosProveedores", @TFastCuentasBancarias_AddRecibosProveedores(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CalculaSaldo(); oClass:AddMethod( "CalculaSaldo", @TFastCuentasBancarias_CalculaSaldo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER TreeReportingChanged(); oClass:AddMethod( "TreeReportingChanged", @TFastCuentasBancarias_TreeReportingChanged(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFastCuentasBancarias ;



static FUNCTION TFastCuentasBancarias_lResource( cFld ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   ::lNewInforme     := .T.
   ::lDefCondiciones := .F.

   if !::NewResource()
      return .F.
   end

   if !::lGrupoEntidadesBancarias( .T. )
      return .F.
   end

   if !::lGrupoCliente( .T. )
      return .F.
   end

   if !::lGrupoProveedor( .T. )
      return .F.
   end

RETURN .T.



static FUNCTION TFastCuentasBancarias_OpenFiles( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   local lOpen    := .T.
   local oError
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      ::oPedCliP := DbfServer( "PedCliP.Dbf", "PedCliP" ):NewOpen( "PedCliP.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oPedCliP:AddBag( "PedCliP.Cdx" ) ; ::oPedCliP:AddBag( ) ; ::oPedCliP:AutoIndex()

      ::oAlbCliP := DbfServer( "AlbCliP.Dbf", "AlbCliP" ):NewOpen( "AlbCliP.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbCliP:AddBag( "AlbCliP.Cdx" ) ; ::oAlbCliP:AddBag( ) ; ::oAlbCliP:AutoIndex()

      ::oFacCliP  := TDataCenter():oFacCliP()

      ::oFacPrvP := DbfServer( "FacPrvP.Dbf", "FacPrvP" ):NewOpen( "FacPrvP.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacPrvP:AddBag( "FacPrvP.Cdx" ) ; ::oFacPrvP:AddBag( ) ; ::oFacPrvP:AutoIndex()

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de informes de cuentas bancarias." )

      ::CloseFiles()

      lOpen       := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TFastCuentasBancarias_CloseFiles( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   if !Empty( ::oPedCliP ) .AND. ( ::oPedCliP:Used() )
      ::oPedCliP:end()
   end

   if !Empty( ::oAlbCliP ) .AND. ( ::oAlbCliP:Used() )
      ::oAlbCliP:end()
   end

   if !Empty( ::oFacCliP ) .AND. ( ::oFacCliP:Used() )
      ::oFacCliP:end()
   end

   if !Empty( ::oFacPrvP ) .AND. ( ::oFacPrvP:Used() )
      ::oFacPrvP:end()
   end

   if !Empty( ::oCuentasBancarias )
      ::oCuentasBancarias:End()
   end

RETURN .T.



static FUNCTION TFastCuentasBancarias_Create( uParam ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   ::AddField( "cTipDoc",  "C", 30, 0, {|| "" },   "Tipo de documento"                             )
   ::AddField( "cSerFac" , "C",  1, 0, {|| "" },   "Serie de recibo"                               )
   ::AddField( "nNumFac",  "N",  9, 0, {|| "" },   "Número de recibo"                              )
   ::AddField( "cSufFac",  "C",  2, 0, {|| "" },   "Sufijo de recibo"                              )
   ::AddField( "cCodCli",  "C", 12, 0, {|| "@!" }, "Código cliente"                                )
   ::AddField( "cCodPrv",  "C", 12, 0, {|| "@!" }, "Código proveedor"                              )
   ::AddField( "dCobRec",  "D",  8, 0, {|| "" },   "Fecha de cobro"                                )
   ::AddField( "dEmiRec",  "D",  8, 0, {|| "" },   "Fecha de emisión"                              )
   ::AddField( "cCodCta",  "C",  3, 0, {|| "" },   "Código de la cuenta bancaria"                  )
   ::AddField( "cEntEmp",  "C",  4, 0, {|| "@!" }, "Entidad de la cuenta de la empresa"            )
   ::AddField( "cSucEmp",  "C",  4, 0, {|| "@!" }, "Sucursal de la cuenta de la empresa"           )
   ::AddField( "cDigEmp",  "C",  2, 0, {|| "@!" }, "Dígito de control de la cuenta de la empresa"  )
   ::AddField( "cCtaEmp",  "C", 10, 0, {|| "@!" }, "Cuenta bancaria de la empresa"                 )
   ::AddField( "nTotImp",  "N", 16, 6, {|| "" },   "Importe recibo"                                )
   ::AddField( "nSalImp",  "N", 16, 6, {|| "" },   "Saldo recibo"                                  )

   ::AddTmpIndex( "cCtaEmp", "cCodCta + Dtos( dCobRec )" )

RETURN ( self )



static FUNCTION TFastCuentasBancarias_lGenerate( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   ::oDbf:Zap()

   do case
      case ::cReportType == "Informe de cuentas bancarias"

         ::AddPedidosClientes()

         ::AddAlbaranesClientes()

         ::AddRecibosClientes()

         ::AddRecibosProveedores()

         ::CalculaSaldo()

      otherwise

         msgStop( "Tipo de informe no valido.", ::cReportType )

   end

RETURN ( ::oDbf:LastRec() > 0 )



static FUNCTION TFastCuentasBancarias_lValidRegister( cCtaBnc ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

Return ( cCtaBnc >= ::oGrupoCuentasBancarias:Cargo:Desde .AND. cCtaBnc <= ::oGrupoCuentasBancarias:Cargo:Hasta )



static FUNCTION TFastCuentasBancarias_AddPedidosClientes( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   local cExp
   local cCta

   ::oPedCliP:OrdSetFocus( "dEntrega" )

   cExp                 := '!lPasado .and. dEntrega >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. dEntrega <= Ctod( "' + Dtoc( ::dFinInf ) + '" ) .and. '
   cExp                 += 'cCodCli >= "' + ::oGrupoCliente:Cargo:Desde + '" .and. cCodCli <= "' + ::oGrupoCliente:Cargo:Hasta + '"'

   ::oPedCliP:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oPedCliP:cFile ), ::oPedCliP:OrdKey(), ( cExp ), , , , , , , , .T. )

   ::oMtrInf:cText      := "Procesando recibos de clientes"
   ::oMtrInf:SetTotal( ::oPedCliP:OrdKeyCount() )

   ::oPedCliP:GoTop()
   while !::lBreak .AND. !::oPedCliP:Eof()

      cCta              := oRetFld( ::oPedCliP:cEntEmp + ::oPedCliP:cSucEmp + ::oPedCliP:cDigEmp + ::oPedCliP:cCtaEmp, ::oCuentasBancarias:oDbf, "cCodBnc", "cCtaBnc" )

      if ::lValidRegister( cCta )

         ::oDbf:Append()

         ::oDbf:cCodPrv := ""
         ::oDbf:cCodCta := cCta
         ::oDbf:cTipDoc := "Entregas pedidos"
         ::oDbf:cSerFac := ::oPedCliP:cSerPed
         ::oDbf:nNumFac := ::oPedCliP:nNumPed
         ::oDbf:cSufFac := ::oPedCliP:cSufPed
         ::oDbf:cCodCli := ::oPedCliP:cCodCli
         ::oDbf:dEmiRec := ::oPedCliP:dEntrega
         ::oDbf:dCobRec := ::oPedCliP:dEntrega
         ::oDbf:cEntEmp := ::oPedCliP:cEntEmp
         ::oDbf:cSucEmp := ::oPedCliP:cSucEmp
         ::oDbf:cDigEmp := ::oPedCliP:cDigEmp
         ::oDbf:cCtaEmp := ::oPedCliP:cCtaEmp
         ::oDbf:nTotImp := ::oPedCliP:nImporte

         ::oDbf:Save()

      end

      ::oPedCliP:Skip()

      ::oMtrInf:AutoInc()

   end

   ::oPedCliP:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oPedCliP:cFile ) )

RETURN ( Self )



static FUNCTION TFastCuentasBancarias_AddAlbaranesClientes( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   local cExp
   local cCta

   ::oAlbCliP:OrdSetFocus( "dEntrega" )

   cExp                 := '!lPasado .and. dEntrega >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. dEntrega <= Ctod( "' + Dtoc( ::dFinInf ) + '" ) .and. '
   cExp                 += 'cCodCli >= "' + ::oGrupoCliente:Cargo:Desde + '" .and. cCodCli <= "' + ::oGrupoCliente:Cargo:Hasta + '"'

   ::oAlbCliP:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oAlbCliP:cFile ), ::oAlbCliP:OrdKey(), ( cExp ), , , , , , , , .T. )

   ::oMtrInf:cText      := "Procesando recibos de clientes"
   ::oMtrInf:SetTotal( ::oAlbCliP:OrdKeyCount() )

   ::oAlbCliP:GoTop()
   while !::lBreak .AND. !::oAlbCliP:Eof()

      cCta              := oRetFld( ::oAlbCliP:cEntEmp + ::oAlbCliP:cSucEmp + ::oAlbCliP:cDigEmp + ::oAlbCliP:cCtaEmp, ::oCuentasBancarias:oDbf, "cCodBnc", "cCtaBnc" )

      if ::lValidRegister( cCta )

         ::oDbf:Append()

         ::oDbf:cCodPrv := ""
         ::oDbf:cCodCta := cCta
         ::oDbf:cTipDoc := "Entregas albraranes"
         ::oDbf:cSerFac := ::oAlbCliP:cSerAlb
         ::oDbf:nNumFac := ::oAlbCliP:nNumAlb
         ::oDbf:cSufFac := ::oAlbCliP:cSufAlb
         ::oDbf:cCodCli := ::oAlbCliP:cCodCli
         ::oDbf:dEmiRec := ::oAlbCliP:dEntrega
         ::oDbf:dCobRec := ::oAlbCliP:dEntrega
         ::oDbf:cEntEmp := ::oAlbCliP:cEntEmp
         ::oDbf:cSucEmp := ::oAlbCliP:cSucEmp
         ::oDbf:cDigEmp := ::oAlbCliP:cDigEmp
         ::oDbf:cCtaEmp := ::oAlbCliP:cCtaEmp
         ::oDbf:nTotImp := ::oAlbCliP:nImporte

         ::oDbf:Save()

      end

      ::oAlbCliP:Skip()

      ::oMtrInf:AutoInc()

   end

   ::oAlbCliP:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oAlbCliP:cFile ) )

RETURN ( Self )



static FUNCTION TFastCuentasBancarias_AddRecibosClientes( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   local cExp
   local cCta

   ::oFacCliP:OrdSetFocus( "dEntrada" )

   cExp                 := 'lCobrado .and. dEntrada >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. dEntrada <= Ctod( "' + Dtoc( ::dFinInf ) + '" ) .and. '
   cExp                 += 'cCodCli >= "' + ::oGrupoCliente:Cargo:Desde + '" .and. cCodCli <= "' + ::oGrupoCliente:Cargo:Hasta + '"'

   ::oFacCliP:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oFacCliP:cFile ), ::oFacCliP:OrdKey(), ( cExp ), , , , , , , , .T. )

   ::oMtrInf:cText      := "Procesando recibos de clientes"
   ::oMtrInf:SetTotal( ::oFacCliP:OrdKeyCount() )

   ::oFacCliP:GoTop()
   while !::lBreak .AND. !::oFacCliP:Eof()

      cCta              := oRetFld( ::oFacCliP:cEntEmp + ::oFacCliP:cSucEmp + ::oFacCliP:cDigEmp + ::oFacCliP:cCtaEmp, ::oCuentasBancarias:oDbf, "cCodBnc", "cCtaBnc" )

      if ::lValidRegister( cCta )

         ::oDbf:Append()

         ::oDbf:cCodPrv := ""
         ::oDbf:cCodCta := cCta
         ::oDbf:cTipDoc := "Recibos clientes"
         ::oDbf:cSerFac := ::oFacCliP:cSerie
         ::oDbf:nNumFac := ::oFacCliP:nNumFac
         ::oDbf:cSufFac := ::oFacCliP:cSufFac
         ::oDbf:cCodCli := ::oFacCliP:cCodCli
         ::oDbf:dEmiRec := ::oFacCliP:dPreCob
         ::oDbf:dCobRec := ::oFacCliP:dEntrada
         ::oDbf:cEntEmp := ::oFacCliP:cEntEmp
         ::oDbf:cSucEmp := ::oFacCliP:cSucEmp
         ::oDbf:cDigEmp := ::oFacCliP:cDigEmp
         ::oDbf:cCtaEmp := ::oFacCliP:cCtaEmp
         ::oDbf:nTotImp := ::oFacCliP:nImporte

         ::oDbf:Save()

      end

      ::oFacCliP:Skip()

      ::oMtrInf:AutoInc()

   end

   ::oFacCliP:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oFacCliP:cFile ) )

RETURN ( Self )



static FUNCTION TFastCuentasBancarias_AddRecibosProveedores( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   local cExp
   local cCta

   ::oFacPrvP:OrdSetFocus( "dEntrada" )

   cExp                 := 'lCobrado .and. dEntrada >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. dEntrada <= Ctod( "' + Dtoc( ::dFinInf ) + '" ) .and. '
   cExp                 += 'cCodPrv >= "' + ::oGrupoCliente:Cargo:Desde + '" .and. cCodPrv <= "' + ::oGrupoCliente:Cargo:Hasta + '"'

   ::oFacPrvP:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oFacPrvP:cFile ), ::oFacPrvP:OrdKey(), ( cExp ), , , , , , , , .T. )

   ::oMtrInf:cText      := "Procesando recibos de proveedores"
   ::oMtrInf:SetTotal( ::oFacPrvP:OrdKeyCount() )

   ::oFacPrvP:GoTop()
   while !::lBreak .AND. !::oFacPrvP:Eof()

      cCta              := oRetFld( ::oFacPrvP:cEntEmp + ::oFacPrvP:cSucEmp + ::oFacPrvP:cDigEmp + ::oFacPrvP:cCtaEmp, ::oCuentasBancarias:oDbf, "cCodBnc", "cCtaBnc" )

      if ::lValidRegister( cCta )

         ::oDbf:Append()

         ::oDbf:cCodCli := ""
         ::oDbf:cCodCta := cCta
         ::oDbf:cTipDoc := "Recibos proveedores"
         ::oDbf:cCodPrv := ::oFacPrvP:cCodPrv
         ::oDbf:cSerFac := ::oFacPrvP:cSerFac
         ::oDbf:nNumFac := ::oFacPrvP:nNumFac
         ::oDbf:cSufFac := ::oFacPrvP:cSufFac
         ::oDbf:dEmiRec := ::oFacPrvP:dPreCob
         ::oDbf:dCobRec := ::oFacPrvP:dEntrada
         ::oDbf:cEntEmp := ::oFacPrvP:cEntEmp
         ::oDbf:cSucEmp := ::oFacPrvP:cSucEmp
         ::oDbf:cDigEmp := ::oFacPrvP:cDigEmp
         ::oDbf:cCtaEmp := ::oFacPrvP:cCtaEmp
         ::oDbf:nTotImp := - ::oFacPrvP:nImporte

         ::oDbf:Save()

      end

      ::oFacPrvP:Skip()

      ::oMtrInf:AutoInc()

   end

   ::oFacPrvP:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oFacPrvP:cFile ) )

RETURN ( Self )



static FUNCTION TFastCuentasBancarias_CalculaSaldo( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   local nSaldo         := 0
   local cCuenta        := ""

   ::oMtrInf:cText      := "Calcula saldo"
   ::oMtrInf:SetTotal( ::oDbf:OrdKeyCount() )

   ::oDbf:GoTop()
   while !::lBreak .AND. !::oDbf:Eof()

      if cCuenta <> ::oDbf:cCodCta
         cCuenta        := ::oDbf:cCodCta
         nSaldo         := oRetFld( cCuenta, ::oCuentasBancarias:oDbf, "nSalIni", "cCodBnc" )
      end

      ::oDbf:FieldPutByName( "nSalImp", ::oDbf:nTotImp + nSaldo )

      nSaldo            := ::oDbf:nSalImp

      ::oDbf:Skip()

      ::oMtrInf:AutoInc()

   end

RETURN ( Self )



static FUNCTION TFastCuentasBancarias_StartDialog( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   ::CreateTreeImageList()

   ::BuildTree( ::oTreeReporting, .F. )

RETURN ( Self )



static FUNCTION TFastCuentasBancarias_BuildTree( oTree, lLoadFile ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   local aReports

   If( oTree == nil, oTree := ::oTreeReporting, ) ;
   If( lLoadFile == nil, lLoadFile := .T., ) ;

   aReports          := {  {  "Title" => "Informe de cuentas bancarias", "Image" => 17, "Type" => "Informe de cuentas bancarias", "Directory" => "Cuentas bancarias", "File" => "Informe.fr3"  } }

   ::BuildNode( aReports, oTree, lLoadFile )

   oTree:ExpandAll()

RETURN ( Self )



static FUNCTION TFastCuentasBancarias_DataReport( oFr ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   ::oFastReport:SetWorkArea(       "Informe", ::oDbf:nArea )
   ::oFastReport:SetFieldAliases(   "Informe", cObjectsToReport( ::oDbf ) )

   ::oFastReport:SetWorkArea(       "Empresa", ::oDbfEmp:nArea )
   ::oFastReport:SetFieldAliases(   "Empresa", cItemsToReport( aItmEmp() ) )

   ::oFastReport:SetWorkArea(       "Cuentas bancarias", ::oCuentasBancarias:oDbf:nArea )
   ::oFastReport:SetFieldAliases(   "Cuentas bancarias", cObjectsToReport( ::oCuentasBancarias:oDbf ) )

   ::oFastReport:SetWorkArea(       "Clientes", ::oDbfCli:nArea )
   ::oFastReport:SetFieldAliases(   "Clientes", cItemsToReport( aItmCli() ) )

   ::oFastReport:SetWorkArea(       "Proveedores", ::oDbfPrv:nArea )
   ::oFastReport:SetFieldAliases(   "Proveedores", cItemsToReport( aItmPrv() ) )

   ::oFastReport:SetWorkArea(       "Recibos de clientes", ::oFacCliP:nArea )
   ::oFastReport:SetFieldAliases(   "Recibos de clientes", cItemsToReport( aItmRecCli() ) )

   ::oFastReport:SetWorkArea(       "Recibos de proveedores", ::oFacPrvP:nArea )
   ::oFastReport:SetFieldAliases(   "Recibos de proveedores", cItemsToReport( aItmRecPrv() ) )

   ::oFastReport:SetMasterDetail(   "Informe", "Empresa",               {|| cCodEmp() } )
   ::oFastReport:SetMasterDetail(   "Informe", "Cuentas bancarias",     {|| ::oDbf:cCodCta } )
   ::oFastReport:SetMasterDetail(   "Informe", "Clientes",              {|| ::oDbf:cCodCli } )
   ::oFastReport:SetMasterDetail(   "Informe", "Proveedores",           {|| ::oDbf:cCodPrv } )
   ::oFastReport:SetMasterDetail(   "Informe", "Recibos de clientes",   {|| ::oDbf:cSerFac + Str( ::oDbf:nNumFac, 9 ) + ::oDbf:cSufFac } )
   ::oFastReport:SetMasterDetail(   "Informe", "Recibos de proveedores",{|| ::oDbf:cSerFac + Str( ::oDbf:nNumFac, 9 ) + ::oDbf:cSufFac } )

   ::oFastReport:SetResyncPair(     "Informe", "Empresa" )
   ::oFastReport:SetResyncPair(     "Informe", "Cuentas bancarias" )
   ::oFastReport:SetResyncPair(     "Informe", "Cliente" )
   ::oFastReport:SetResyncPair(     "Informe", "Proveedores" )
   ::oFastReport:SetResyncPair(     "Informe", "Recibos de clientes" )
   ::oFastReport:SetResyncPair(     "Informe", "Recibos de proveedores" )

   ::AddVariable()

Return ( Self )



static FUNCTION TFastCuentasBancarias_TreeReportingChanged( ) ; local Self AS CLASS TFastCuentasBancarias := QSelf() AS CLASS TFastCuentasBancarias

   if ::oTreeReporting:GetSelText() == "Listado"
      ::lHideFecha()
   else
      ::lShowFecha()
   end

Return ( Self )



Function isBancos()

   local oError
   local oBlock

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   with object ( TBancos():Create() )

      :oDbf       := :DefineFiles()

      if !lExistTable( :oDbf:cFile )
         :oDbf:Create()
         :oDbf:Activate( .F., .F. )
         :oDbf:IdxFCheck()
      endif

      :End()

   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible al comprobar bancos" )

   end

   ErrorBlock( oBlock )

return nil
