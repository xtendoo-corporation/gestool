#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 228 ".\.\Prg\Client.prg"
memvar dbfCli
memvar cDbfCli
memvar dbfObr
memvar cDbfObr
memvar dbfCon
memvar cDbfCon

static oWndBrw
static dbfConfig

static nView

static filClient
static tmpClient

static dbfPro
static dbfProL
static dbfArtKit
static dbfFPago
static dbfDoc
static cFpago
static dbfFamilia
static oBandera
static dbfAlmT
static dbfRuta
static dbfTmpDoc
static dbfTmpFacturae
static dbfTmpObr
static dbfTmpBnc
static dbfTmpAtp
static dbfTmpInc
static dbfTmpCon
static dbfTmpSubCta
static dbfArtDiv
static dbfOfe
static oTrans
static oPais
static cTmpDoc
static cTmpFacturae
static cTmpObr
static cTmpBnc
static cTmpAtp
static cTmpCta
static cTmpInc
static cTmpCon
static oFacAut
static oGrpCli
static oCtaRem
static cAgente
static oNewImp
static oEnvases

static oGetTarifa

static cPinDiv
static cPouDiv
static cPorDiv

static aRgbColor

static oMenu

static oStock
static oBanco
static aFacAut          := {}

static oFecIniCli
static oFecFinCli
static dFecIniCli
static dFecFinCli

static oEstadoCli
static aEstadoCli       := { "Pendientes", "Pagados", "Todos" }
static cEstadoCli

static oPeriodoCli
static aPeriodoCli      := {}
static cPeriodoCli

static cDescuentosAtipicos
static aDescuentosAtipicos

static oBrwRecCli

static oRTF
static cRTF
static lBold
static lItalic
static lUnderline
static lBullet

static aRentabilidad    := { { "", "", 0, .T., .F. } }
static aStrClients      := { "Clientes", "Potenciales", "Web" }

static lExpandida       := .F.

static lExternal        := .F.
static lOpenFiles       := .F.

static nLabels          := 1

static cIniCli

static oDetCamposExtra
static oEntidades
static aEntidades       := {}

static bEdtRec          := { | aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode | EdtRec( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode ) }
static bEdtBig          := { | aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode | EdtBig( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode ) }
static bEdtAtp          := { | aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode | EdtAtp( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode ) }
static bEdtDoc          := { | aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, cCodCli | EdtDoc( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, cCodCli ) }
static bEdtBnc          := { | aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, cCodCli | EdtBnc( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, cCodCli ) }
static bEdtInc          := { | aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode | EdtInc( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode ) }
static bEdtFacturae     := { | aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, cCodCli | EdtFacturae( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, cCodCli ) }

static oReporting
static oMailing



STATIC FUNCTION OpenFiles( lExt )

   local oBlock
   local oError

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de clientes" )
      Return ( .F. )
   end

   If( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      DisableAcceso()

      nView             := D():CreateView()

      lOpenFiles        := .T.

      D():Clientes( nView )

      D():TiposIva( nView )

      D():Divisas( nView )

      D():Atipicas( nView )

      D():Articulos( nView )

      D():AlbaranesClientes( nView )

      D():FacturasClientes( nView )

      D():FacturasClientesCobros( nView )
      ( D():FacturasClientesCobros( nView ) )->( OrdSetFocus( "cCodCli" ) )

      D():ClientesEntidad( nView )

      D():Empresa( nView )

      D():ClientesDirecciones( nView )

      D():ClientesBancos( nView )

      D():ClientesIncidencias( nView )

      D():ClientesDocumentos( nView )

      D():ClientesContactos( nView )





      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfArtKit ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGENTES.DBF" ), ( cCheckArea( "AGENTES", @cAgente ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGENTES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end





      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALMACEN.DBF" ), ( cCheckArea( "ALMACEN", @dbfAlmT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALMACEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfProL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RDOCUMEN.DBF" ), ( cCheckArea( "RDOCUMEN", @dbfDoc ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RDOCUMEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CTIPO" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "OFERTA.DBF" ), ( cCheckArea( "OFERTA", @dbfOfe ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "OFERTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTDIV.DBF" ), ( cCheckArea( "ARTDIV", @dbfArtDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RUTA.DBF" ), ( cCheckArea( "RUTA", @dbfRuta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RUTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      oBandera             := TBandera():New()

      oStock               := TStock():Create( cPatEmp() )
      if !oStock:lOpenFiles()
         lOpenFiles        := .F.
      end

      oCtaRem              := TCtaRem():Create( cPatEmp() )
      if !oCtaRem:OpenFiles()
         lOpenFiles        := .F.
      end

      oNewImp              := TNewImp():Create( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles        := .F.
      end

      oTrans               := TTrans():Create( cPatEmp() )
      if !oTrans:OpenFiles()
         lOpenFiles        := .F.
      end

      oFacAut              := TFacAutomatica():Create( cPatEmp() )
      if !oFacAut:Openfiles()
         lOpenfiles        := .F.
      end

      oBanco               := TBancos():Create()
      oBanco:OpenFiles()

      oGrpCli              := TGrpCli():Create()
      if !oGrpCli:OpenFiles()
         lOpenFiles        := .F.
      end

      oDetCamposExtra      := TDetCamposExtra():New()
      if !oDetCamposExtra:OpenFiles()
         lOpenFiles        := .F.
      end

      oDetCamposExtra:SetTipoDocumento( "Clientes" )
      oDetCamposExtra:setbId( {|| D():ClientesId( nView ) } )

      oEntidades        := TEntidades():Create()
      if !oEntidades:OpenFiles()
         lOpenFiles     := .F.
      end

      CodigosPostales():GetInstance():OpenFiles()

      oPais                := TPais():Create( cPatDat() )
      if !oPais:OpenFiles()
         lOpenFiles        := .F.
      end

      oEnvases                   := TFrasesPublicitarias():Create( cPatEmp() )
      if !oEnvases:OpenFiles()
         lOpenFiles              := .F.
      end

      cPinDiv                    := cPinDiv( cDivEmp() )
      cPouDiv                    := cPouDiv( cDivEmp() )
      cPorDiv                    := cPorDiv( cDivEmp() )

      LoaIniCli( cPatEmp() )

      oMailing                   := TGenMailingClientes():New( nView )

      EnableAcceso()

   RECOVER USING oError

      lOpenFiles                 := .F.

      EnableAcceso()

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de clientes" )

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

RETURN ( lOpenFiles )



STATIC FUNCTION CloseFiles( lDestroy )

   If( lDestroy == nil, lDestroy := .F., ) ;

   DisableAcceso()

   if oGrpCli <> nil
      oGrpCli:End()
   end

   ( dbfArtKit    )->( dbCloseArea() )
   ( cFPago       )->( dbCloseArea() )
   ( cAgente      )->( dbCloseArea() )
   ( dbfFPago     )->( dbCloseArea() )
   ( dbfAlmT      )->( dbCloseArea() )
   ( dbfFamilia   )->( dbCloseArea() )
   ( dbfPro       )->( dbCloseArea() )
   ( dbfProL      )->( dbCloseArea() )
   ( dbfDoc       )->( dbCloseArea() )
   ( dbfOfe       )->( dbCloseArea() )
   ( dbfArtDiv    )->( dbCloseArea() )
   ( dbfRuta      )->( dbCloseArea() )

   if !Empty( oStock )
      oStock:end()
   end

   if oCtaRem <> nil
      oCtaRem:end()
   end

   if oNewImp <> nil
      oNewImp:end()
   end

   if !Empty( oTrans )
      oTrans:End()
   end

   if !Empty( oFacAut )
      oFacAut:End()
   end

   if !Empty( oEnvases )
      oEnvases:end()
   end

   if !Empty( oBanco )
      oBanco:End()
   end

   if !Empty( oDetCamposExtra )
      oDetCamposExtra:CloseFiles()
   end

   if !empty( oEntidades )
      oEntidades:End()
   end

   if !empty(oMailing)
      oMailing:end()
   end

   if !Empty( oPais )
      oPais:End()
   end

   CodigosPostales():GetInstance():CloseFiles()

   D():DeleteView( nView )

   dbfArtKit         := nil
   cFPago            := nil
   cAgente           := nil
   dbfFPago          := nil
   dbfAlmT           := nil
   dbfFamilia        := nil
   dbfPro            := nil
   dbfProL           := nil
   dbfDoc            := nil
   dbfOfe            := nil
   dbfArtDiv         := nil
   dbfRuta           := nil
   oDetCamposExtra   := nil
   oEnvases          := nil
   oPais             := nil

   if lDestroy
      oWndBrw        := nil
   end

   lOpenFiles        := .F.

   enableAcceso()

Return .T.





FUNCTION Client( oMenuItem, oWnd, cCodCli )

   local oSnd
   local oRpl
   local oDel
   local nLevel
   local oRotor
   local oScript

   If( oMenuItem == nil, oMenuItem := "clientes", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;

   if Empty( oWndBrw )





      nLevel            := Auth():Level( oMenuItem )

      if nAnd( nLevel, 1 ) == 0
         msgStop( "Acceso no permitido." )
         return nil
      end





      if oWnd <> nil
         SysRefresh(); oWnd:CloseAll(); SysRefresh()
      end





      if !OpenFiles( .F. )
         return nil
      end





      DisableAcceso()



















      oWndBrw := TShell():New( 0, 0, 22, 80, "Clientes",, oWnd,,, .F.,,, ( D():Clientes( nView ) ),,,,, {"Código cliente", "Nombre", if( uFieldEmpresa( "nCifRut" ) == 1, "NIF/CIF", "RUT" ), "Teléfono", "Establecimiento", "Población", "Cliente web"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, D():Clientes( nView ) ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, D():Clientes( nView ) ) )}, {||( WinDelRec( oWndBrw:oBrw, D():Clientes( nView ), {|| DelDetalle( ( D():Clientes( nView ) )->Cod ) } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, D():Clientes( nView ) ) )}, nil, nLevel, "gc_user_16", ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ),,, .T. )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Bloqueado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Clientes( nView ) )->lBlqCli }
         :nWidth           := 20
         :SetCheck( { "gc_sign_stop_12", "Nil16" } )
         :AddResource( "gc_sign_stop_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Clientes( nView ) )->lSndInt }
         :nWidth           := 20
         :SetCheck( { "gc_mail2_12", "Nil16" } )
         :AddResource( "gc_mail2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Internet"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Clientes( nView ) )->lPubInt }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "gc_earth_12", "Nil16" } )
         :AddResource( "gc_earth_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Tarifas atipicas"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Atipicas( nView ) )->( dbSeek( ( D():Clientes( nView ) )->Cod ) ) }
         :nWidth           := 20
         :SetCheck( { "gc_symbol_percent_12", "Nil16" } )
         :AddResource( "gc_symbol_percent_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Bancos"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():ClientesBancos( nView ) )->( dbSeek( ( D():Clientes( nView ) )->Cod ) ) }
         :nWidth           := 20
         :SetCheck( { "gc_central_bank_euro_16", "Nil16" } )
         :AddResource( "gc_central_bank_euro_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Potencial"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Clientes( nView ) )->nTipCli == 2 }
         :nWidth           := 20
         :SetCheck( { "gc_id_card_hint_12", "Nil16" } )
         :AddResource( "gc_id_card_hint_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Inactivo"
         :bStrData         := {|| if( ( D():Clientes( nView ) )->lInaCli, "Inactivo", "" ) }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código cliente"
         :cSortOrder       := "Cod"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Cod }
         :nWidth           := 110
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "Titulo"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Titulo }
         :nWidth           := 280
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         if uFieldEmpresa( "nCifRut" ) == 1
         :cHeader          := "NIF/CIF"
         else
         :cHeader          := "RUT"
         :cEditPicture     := "@R 999999999-9"
         end
         :cSortOrder       := "Nif"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Nif }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Teléfono"
         :cSortOrder       := "Telefono"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Telefono }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fax"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Fax }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Domicilio"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Domicilio }
         :nWidth           := 300
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Población"
         :cSortOrder       := "Poblacion"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Poblacion }
         :nWidth           := 200
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código postal"
         :bEditValue       := {|| ( D():Clientes( nView ) )->CodPostal }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Provincia"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Provincia }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Establecimiento"
         :cSortOrder       := "NbrEst"
         :bEditValue       := {|| ( D():Clientes( nView ) )->NbrEst }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Correo electrónico"
         :bEditValue       := {|| ( D():Clientes( nView ) )->cMeiInt }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Riesgo"
         :bEditValue       := {|| Trans( ( D():Clientes( nView ) )->Riesgo, PicOut() ) }
         :nWidth           := 60
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Contacto"
         :bEditValue       := {|| ( D():Clientes( nView ) )->cPerCto }
         :nWidth           := 200
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Comentarios"
         :bEditValue       := {|| ( D():Clientes( nView ) )->mComent }
         :nWidth           := 200
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Observaciones"
         :bEditValue       := {|| cTextRichText( ( D():Clientes( nView ) )->mObserv ) }
         :nWidth           := 200
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Cliente web"
         :cSortOrder       := "cCliWeb"
         :bEditValue       := {|| aStrClients[ Min( Max( ( D():Clientes( nView ) )->nTipCli, 1 ), len( aStrClients ) ) ] }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Ruta"
         :bEditValue       := {|| ( D():Clientes( nView ) )->cCodRut + if( !Empty( ( D():Clientes( nView ) )->cCodRut ), " - ", "" ) + RetFld( ( D():Clientes( nView ) )->cCodRut, dbfRuta ) }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pago"
         :bEditValue       := {|| ( D():Clientes( nView ) )->CodPago + if( !Empty( ( D():Clientes( nView ) )->CodPago ), " - " , "" ) + RetFld( ( D():Clientes( nView ) )->CodPago, dbfFPago ) }
         :nWidth           := 200
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Transportista"
         :bEditValue       := {|| AllTrim( ( D():Clientes( nView ) )->cCodTrn ) + if( !Empty( ( D():Clientes( nView ) )->cCodTrn ), " - " , "" ) + oTrans:cNombre( ( D():Clientes( nView ) )->cCodTrn ) }
         :nWidth           := 200
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Última venta"
         :bEditValue       := {|| dtoc( dUltimaVentaCliente( ( D():Clientes( nView ) )->Cod, D():AlbaranesClientes( nView ), D():FacturasClientes( nView ) ) ) }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Última llamada"
         :bEditValue       := {|| dtoc( ( D():Clientes( nView ) )->dLlaCli ) + space( 1 ) + ( D():Clientes( nView ) )->cTimCli }
         :nWidth           := 100
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Agente"
         :bEditValue       := {|| if( !Empty( ( D():Clientes( nView ) )->cAgente ), ( D():Clientes( nView ) )->cAgente + " - " + RetNbrAge( ( D():Clientes( nView ) )->cAgente, cAgente ), "" ) }
         :nWidth           := 200
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Grupo"
         :bEditValue       := {|| alltrim( ( D():Clientes( nView ) )->cCodGrp ) + " - " + oGrpCli:nombreGrupo( ( D():Clientes( nView ) )->cCodGrp ) }
         :nWidth           := 200
         :lHide            := .T.
      end

      with object ( oWndBrw:AddCol() )
         :cHeader          := "Fecha creación"
         :cEditPicture     := "@D"
         :bEditValue       := {|| ( D():Clientes( nView ) )->dAlta }
         :nWidth           := 80
         :lHide            := .T.
         :nEditType        := 1
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end





      oWndBrw:cHtmlHelp    := "Clientes"

      oDetCamposExtra:addCamposExtra( oWndBrw )

      oWndBrw:CreateXFromCode()





      oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

      oWndBrw:AddSeaBar( "justZero", retNumCodCliEmp() )








      oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )






      oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",,, 2,, .F. )






      oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )





      oWndBrw:NewAt( "ZOOM",,, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, ( D():Clientes( nView ) ) ) )}, "(Z)oom", "Z",,,,, .F. )






      oDel := oWndBrw:NewAt( "DEL",,, {||( oWndBrw:RecDel() )}, "(E)liminar", "E",,, 16,, .F. )







         oWndBrw:NewAt( "DEL",,, {||( TDelTarifasClientes():New() )}, "Eliminar tarifas",,,, 16, oDel, .F. )








      oWndBrw:NewAt( "GC_TELEPHONE_",,, {||( LlamadaAhora(), oWndBrw:Refresh() )}, "(L)lamada ahora", "L",,, 16,, .F. )






      oWndBrw:NewAt( "INFO",,, {||( BrwVtaCli( ( D():Clientes( nView ) )->Cod, ( D():Clientes( nView ) )->Titulo ) )}, "(I)nforme cliente", "I",,, 4,, .F. )





      oWndBrw:NewAt( "IMP",,, {||( TInfCliGrp():New( "Listado de clientes" ):Play() )}, "Lis(t)ado", "T",,,,, .F. )





      oWndBrw:NewAt( "IMP",,, {||( TarCli():New( "Tarifas personalizadas por clientes" ):Play() )}, "Listad(o) de tarifas", "O",,,,, .F. )






      oWndBrw:NewAt( "gc_document_empty_chart_",,, {||( runFastGallery( "Clientes" ) )}, "Rep(o)rting", "O",,, 32,, .F. )







      oWndBrw:NewAt( "gc_portable_barcode_scanner_",,, {||( TClienteLabelGenerator():Create() )}, "Eti(q)uetas", "Q",,,,, .F. )






      oWndBrw:NewAt( "GC_MAIL_EARTH_",,, {||( oMailing:documentsDialog( oWndBrw:oBrw:aSelected ) )}, "Enviar correos", "V",,, 32,, .F. )








      oSnd := oWndBrw:NewAt( "Lbl",, "Seleccionar clientes para ser enviados", {||lSndCli( oWndBrw )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "Lbl",,, {||lSndCli( oWndBrw, .T. )}, "Seleccionar para envio",,,, 4, oSnd, .F. )







         oWndBrw:NewAt( "Lbl",,, {||lSndCli( oWndBrw, .F. )}, "Deseleccionar para envio",,,, 4, oSnd, .F. )






      oWndBrw:NewAt( "BMPCONTA",,, {||( ChkAllSubCta() )}, "Com(p)robar subcuentas", "P",,, 4,, .F. )

      if oUser():lAdministrador()





         oWndBrw:NewAt( "gc_money2_",,, {||( ChgPrc( oWndBrw ) )}, "Cambiar precios",,,, 2,, .F. )

      end

      if RolesModel():getRolCambiarCampos( Auth():rolUuid() )






         oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, ( D():Clientes( nView ) ), aItmCli(), "21" ) )}, "Cambiar campos",,, {|This|This:Toggle()}, 2,, .F. )







            oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():Atipicas( nView ), aItmAtp() ) )}, "Tarifa",,,, 4, oRpl, .F. )

      end






      oWndBrw:NewAt( "CNFCLI",,, {||( CnfCli( D():Clientes( nView ) ) )}, "Confi(g)urar", "G",,, 2,, .F. )





      oScript := oWndBrw:NewAt( "gc_folder_document_",,, {||( oScript:Expand() )}, "Scripts",,,,,, .F. )
      ImportScript( oWndBrw, oScript, "Clientes", nView )





      oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,,, 4,, .F. )














         oWndBrw:NewAt( "GC_NOTEBOOK_USER_",,, {||( PreCli( nil, oWnd, ( D():Clientes( nView ) )->Cod, nil ) )}, "Añadir presupuesto de cliente",,,, 4, oRotor, .T. )






         oWndBrw:NewAt( "GC_CLIPBOARD_EMPTY_USER_",,, {||( PedCli( nil, oWnd, ( D():Clientes( nView ) )->Cod, nil ) )}, "Añadir pedido de cliente",,,, 4, oRotor, .T. )





         oWndBrw:NewAt( "GC_DOCUMENT_EMPTY_",,, {||( appAlbCli( { "Cliente" => ( D():Clientes( nView ) )->Cod } ) )}, "Añadir albarán de cliente",,,, 4, oRotor, .F. )














         oWndBrw:NewAt( "GC_DOCUMENT_TEXT_USER_",,, {||( FactCli( nil, oWnd, { "Cliente" => ( D():Clientes( nView ) )->Cod } ) )}, "Añadir factura de cliente",,,, 4, oRotor, .T. )






         oWndBrw:NewAt( "GC_CASH_REGISTER_USER_",,, {||( FrontTpv( nil, oWnd, ( D():Clientes( nView ) )->Cod, nil ) )}, "Añadir tiket de cliente",,,, 4, oRotor, .T. )





      oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .T. )





      oWndBrw:oActiveFilter:SetFields( aItmCli() )
      oWndBrw:oActiveFilter:SetFilterType( "21" )





      oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles( .T. ) )},, oWndBrw:bLButtonUp, .F. )

      EnableAcceso()

   else

      oWndBrw:SetFocus()

   end

Return ( .T. )







STATIC FUNCTION EdtBig( aTmp, aGet, dbfCli, oBrw, bWhen, bValid, nMode )

   local oDlg
   local oBmpGeneral

   if ( nMode == 1 .OR. nMode == 4 )
      aTmp[ 1     ]  := NextKey( aTmp[ 1 ], ( D():Clientes( nView ) ), "0", RetNumCodCliEmp() )
      aTmp[ 86 ]  := .T.
      aTmp[ 106 ]  := .T.
      aTmp[ 52 ]  := .F.
      aTmp[ 32 ]  := 0
      aTmp[ 42  ]  := 1
      aTmp[ 40 ]  := 1
      aTmp[ 121 ]  := 1
   end



   oDlg = TDialog():New(,,,, ( LblTitle( nMode ) + "cliente" ), ( "BigEdtCliente" ),, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmpGeneral := TBitmap():ReDefine( 500, "gc_user2_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )







      aGet[ 1 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oDlg,, ( Replicate( "X", RetNumCodCliEmp() ) ), {||    ( NotValid( aGet[ 1 ], ( D():Clientes( nView ) ), .T., "0", 1, RetNumCodCliEmp() ) )},,,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .F.,,,,,, nil,,, )





      TButtonBmp():ReDefine( 101, {||( VirtualKey( .F., aGet[ 1 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )








      aGet[ 2 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 2 ], aTmp[ 2 ]:= u ) }, oDlg,, "@!", {||    ( if( nMode == 1, lValidNombre( aGet[2] ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( ActTitle( nKey, nFlags, Self, nMode, oDlg, aTmp[ 1 ] ) ) }, .F., .F.,,,,,, nil,,, )





      TButtonBmp():ReDefine( 111, {||( VirtualKey( .F., aGet[ 2 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )






      aGet[ 4 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 4 ], aTmp[ 4 ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 4 ], Rtrim( aTmp[ 5 ] ) + Space( 1 ) + Rtrim( aTmp[ 6 ] ) )}, nil,,, )





      TButtonBmp():ReDefine( 121, {||( VirtualKey( .F., aGet[ 4 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )





      aGet[ 5 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TButtonBmp():ReDefine( 131, {||( VirtualKey( .F., aGet[ 5 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )





      aGet[ 7 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TButtonBmp():ReDefine( 141, {||( VirtualKey( .F., aGet[ 7 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )





      aGet[ 6 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TButtonBmp():ReDefine( 191, {||( VirtualKey( .F., aGet[ 6 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )






      aGet[ 8 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oDlg,,, {||    ( if( nMode == 1, lValidTlf( aGet[ 8 ] ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TButtonBmp():ReDefine( 151, {||( VirtualKey( .F., aGet[ 8 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )







      aGet[ 3 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 3 ], aTmp[ 3 ]:= u ) }, oDlg,, "@!", {||    ( CheckCif( aGet[ 3 ] ), if( nMode == 1, lValidCif( aGet[ 3 ] ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TButtonBmp():ReDefine( 161, {||( VirtualKey( .F., aGet[ 3 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )




      TCheckBox():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 107 ], aTmp[ 107 ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 50 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ShellExecute( oDlg:hWnd, "open", "mailto:" + Rtrim( aGet[ 50 ]:cText() ) ) )}, nil,,, )





      TButtonBmp():ReDefine( 171, {||( VirtualKey( .F., aGet[ 50 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )






      aGet[ 44 ] := TMultiGet():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButtonBmp():ReDefine( 181, {||( VirtualKey( .F., aGet[ 44 ] ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )









      TButton():ReDefine( 1, {||( MsgRun(  "Guardando cliente", "Espere por favor...", {|| SavClient( aTmp, aGet, oDlg, oBrw, nMode ) } ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| MsgRun(  "Guardando cliente", "Espere por favor...", {|| SavClient( aTmp, aGet, oDlg, oBrw, nMode ) } ) } )
      end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oBmpGeneral:End()

RETURN ( oDlg:nResult == 1 )







STATIC FUNCTION EdtRec( aTmp, aGet, dbf, oBrw, nTab, bValid, nMode )

   local oDlg
   local oFld
   local oGetSubCta
   local oGetSubDto
   local oBrwCta
   local oBrwObr
   local oBrwAtp
   local oBrwDoc
   local oBrwBnc
   local oBrwInc
   local oBrwCon
   local oBrwFacturae
   local oBrwFacAut
   local oBmpDiv
   local oGet
   local cColor
   local nImpRie        := 0
   local cTipCli
   local cTipRetencion
   local nSeaColor
   local oGetSalDto
   local nGetSalDto     := 0
   local oSay           := Array( 9 )
   local cSay           := Array( 9 )
   local oGetCta
   local cGetSubCta     := Space( 30 )
   local cGetSubDto     := Space( 30 )
   local cGetCta        := Space( 30 )
   local nGetDebe       := 0
   local nGetHaber      := 0
   local oGetSaldo
   local nGetSaldo      := 0
   local aStrColor      := { "Ninguno", "Verde", "Naranja", "Rojo" }
   local aResColor      := { "COLOR_00", "COLOR_01", "COLOR_02", "COLOR_03" }
   local aStrRetencion  := { "Ret. S/Base", "Ret. S/Total" }
   local aResClients    := { "Cli", "CliPot", "CliPot" }
   local aMes           := { "Ninguno", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre" }
   local oFiltroAtp
   local cFiltroAtp     := cIniCli
   local aFiltroAtp     := { "Todas", "Activas", "No activas" }
   local oZoom
   local cZoom          := "100%"
   local aZoom          := { "500%", "200%", "150%", "100%", "75%", "50%", "25%", "10%" }
   local oFuente
   local cFuente        := "Arial"
   local aFuente        := aGetFont( oWnd() )
   local oSize
   local cSize          := "10"
   local aSize          := { " 6", " 7", " 8", " 9", "10", "11", "12", "13", "14", "16", "18", "20", "22", "24", "26", "28", "36", "48", "72" }
   local oClp
   local oBtn           := Array( 17 )
   local aRatio         := { { 5, 1 }, { 2, 1 }, { 3, 2 }, { 1, 1 }, { 3, 4 }, { 1, 2 }, { 1, 4 }, { 1, 10 } }
   local oBmpGeneral
   local oBmpComercial
   local oBmpDirecciones
   local oBmpContactos
   local oBmpBancos
   local oBmpContabilidad
   local oBmpComentario
   local oBmpTarifa
   local oBmpDocumentos
   local oBmpIncidencias
   local oBmpObservaciones
   local oBmpAutomaticas
   local oBmpRecibos
   local oBmpFacturae
   local oBmpImpuestos
   local aNombreTarifas := aNombreTarifas()
   local cNombreTarifa  := if( len( aNombreTarifas ) > 0, aNombreTarifas[ 1 ], "" )

   aFacAut              := hb_aTokens( aTmp[ 118 ], "," )

   aRgbColor            := { ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), ( 102 + ( 204 * 256 ) + ( 51 * 65536 ) ), ( 255 + ( 204 * 256 ) + ( 102 * 65536 ) ), ( 255 + ( 51 * 256 ) + ( 0 * 65536 ) ) }

   nSeaColor            := aScan( aRgbColor, aTmp[ 91 ] )
   if nSeaColor <> 0
      cColor            := aStrColor[ nSeaColor ]
   end





   aDescuentosAtipicos  := {  "Base", if( !empty( aTmp[ 22 ] ), aTmp[ 22 ], "General" ), if( !empty( aTmp[ 24    ] ), aTmp[ 24    ], "Pronto pago" ), if( !empty( aTmp[ 28 ] ), aTmp[ 28 ], "Definido 1" ), if( !empty( aTmp[ 29 ] ), aTmp[ 29 ], "Definido 2" ) }

   cDescuentosAtipicos  := aDescuentosAtipicos[ min( max( aTmp[ 98 ], 1 ), len( aDescuentosAtipicos ) ) ]





   if beginTrans( aTmp, nMode )
      Return .F.
   end

   do case
      case nMode == 1

         aTmp[ 86 ]  := .T.
         aTmp[ 106 ]  := .T.
         aTmp[ 52 ]  := .F.
         aTmp[ 32 ]  := 0
         aTmp[ 42  ]  := 1
         aTmp[ 121 ]  := 1
         aTmp[ 122 ]  := ctod( "" )
         aTmp[ 141   ]  := getSysDate()



         runEventScript( "clientes\BeforeAppend", aGet, aTmp, nView )

      case nMode == 4

         aTmp[ 1     ]  := NextKey( aTmp[ 1 ], ( D():Clientes( nView ) ), "0", RetNumCodCliEmp() )
         aTmp[ 122 ]  := ctod( "" )
         aTmp[ 141   ]  := getSysDate()

      otherwise

         nImpRie           := oStock:nRiesgo( aTmp[ 1 ] )

   end

   cPeriodoCli             := "Todos"
   cEstadoCli              := "Pendientes"
   aPeriodoCli             := aCreaArrayPeriodos()

   aTmp[ 89 ]        := aMes[ Min( Max( aTmp[ 89 ], 1 ), len( aMes ) ) ]

   cTipCli                 := aStrClients[ Min( Max( aTmp[ 20 ], 1 ), len( aStrClients ) ) ]

   cTipRetencion           := aStrRetencion[ Min( Max( aTmp[ 102 ], 1 ), len( aStrRetencion ) ) ]

   if Empty( aTmp[ 22 ] )
      aTmp[ 22 ]     := Padr( "General", 50 )
   end

   if Empty( aTmp[ 24 ] )
      aTmp[ 24 ]        := Padr( "Pronto pago", 50 )
   end

   if Empty( aTmp[ 96 ] )
      aTmp[ 96 ]     := Padr( "Atipico", 50 )
   end



   ( D():FacturasClientesCobros( nView ) )->( OrdScope( 0, aTmp[ 1 ] ) )
   ( D():FacturasClientesCobros( nView ) )->( OrdScope( 1, aTmp[ 1 ] ) )





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "Cliente : " + Rtrim( aTmp[ 1 ] ) + "-" + Rtrim( aTmp[ 2 ] ), "CLIENT",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )

































      oFld := TFolder():ReDefine( 500, {"&General", "C&omercial", "I&mpuestos", "Au&tomáticas", "&Direcciones", "&Bancos", "Co&ntabilidad", "Comentario", "&Tarifa", "Doc&umentos", "&Incidencias", "Ob&servaciones", "C&ontactos", "Facturae", "&Recibos"}, { "CLIENT_0","CLIENT_1","CLIENT_19","CLIENT_17","CLIENT_15","CLIENT_2","CLIENT_3","CLIENT_4","CLIENT_5","CLIENT_10","CLIENT_12","CLIENT_14","CLIENT_16","CLIENT_FACTURAE","CLIENT_18" }, oDlg,,,,, .F., )









      oBmpGeneral := TBitmap():ReDefine( 500, "gc_user2_48",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )









      oGet := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oFld:aDialogs[1],, ( Replicate( "X", RetNumCodCliEmp() ) ), {||    ( NotValid( oGet, ( D():Clientes( nView ) ), .T., "0", 1, RetNumCodCliEmp() ) )},,,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .F.,,,,, {|Self|( oGet:cText( NextKey( aTmp[ 1 ], ( D():Clientes( nView ) ), "0", RetNumCodCliEmp() ) ) )}, nil, "BOT",, )






      aGet[ 20 ] := TComboBox():ReDefine( 105, { | u | If( PCount()==0, cTipCli, cTipCli:= u ) }, aStrClients, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )}, aResClients,,,,, "aGet[ 20 ]",,,,,,, )








      aGet[2] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( if( nMode == 1, lValidNombre( aGet[2] ), .T. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( ActTitle( nKey, nFlags, Self, nMode, oDlg, aTmp[ 1 ] ) ) }, .F., .F.,,,,,, nil,,, )

      if uFieldEmpresa( "nCifRut" ) <= 1






      aGet[ 3 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 3 ], aTmp[ 3 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( CheckCif( aGet[ 3 ] ), if( nMode == 1, lValidCif( aGet[ 3 ] ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      else






      aGet[ 3 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 3 ], aTmp[ 3 ]:= u ) }, oFld:aDialogs[1],, "@R 999999999-9", {||    ( CheckRut( aGet[ 3 ] ), if( nMode == 1, lValidCif( aGet[ 3 ] ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      end






      aGet[ 4 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 4 ], aTmp[ 4 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 4 ], Rtrim( aTmp[ 5 ] ) + Space( 1 ) + Rtrim( aTmp[ 6 ] ) )}, nil, "gc_earth_lupa_16",, )




      aGet[ 5 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 7 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],,, {||    ( CodigosPostales():GetInstance():validCodigoPostal() )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 6 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 47 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oPais:GetPais( aTmp[ 47 ], oSay[ 6 ] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oPais:Buscar( aGet[ 47 ] ) )}, nil, "LUPA",, )





      oSay[6] := TGetHlp():ReDefine( 302, { | u | If( PCount()==0, cSay[6], cSay[6]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .T.,,,,,, nil,,, )







      aGet[ 87 ] := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, aTmp[ 87 ], aTmp[ 87 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 91 ] := TComboBox():ReDefine( 95, { | u | If( PCount()==0, cColor, cColor:= u ) }, aStrColor, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )}, aResColor,,,,, "aGet[ 91 ]",,,,,,, )





      aGet[ 8 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( nMode == 1, lValidTlf( aGet[ 8 ] ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[124] := TGetHlp():ReDefine( 185, { | u | If( PCount()==0, aTmp[124], aTmp[124]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[9] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[9], aTmp[9]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[10] := TGetHlp():ReDefine( 195, { | u | If( PCount()==0, aTmp[10], aTmp[10]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[125] := TGetHlp():ReDefine( 196, { | u | If( PCount()==0, aTmp[125], aTmp[125]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )



      oGetTarifa  := comboTarifa():Build( { "idCombo" => 100, "uValue" => aTmp[ 40 ] } )
      oGetTarifa:Resource( oFld:aDialogs[1] )









      aGet[ 121 ] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[ 121 ], aTmp[ 121 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 121 ] >= 1 .AND. aTmp[ 121 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )},, .F., .T.,,, {||      1}, {||      6},, nil,,, )









      aGet[ 116 ] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[ 116 ], aTmp[ 116 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 116 ] >= 0 .AND. aTmp[ 116 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )},, .F., .T.,,, {||      0}, {||      6},, nil,,, )








      aGet[43] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[43], aTmp[43]:= u ) }, oFld:aDialogs[1],,, {||    ( cTarifa( aGet[43], oSay[3] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. oUser():lAdministrador() )},, .F., .F.,,,,, {|Self|( BrwTarifa( aGet[43], oSay[3] ) )}, nil, "LUPA",, )





      oSay[3] := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, cSay[3], cSay[3]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









      aGet[21] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cFPago( aGet[21], dbfFPago, oSay[1] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[21 ], oSay[1] ) )}, nil, "LUPA",, )




      oSay[1] := TGetHlp():ReDefine( 211, { | u | If( PCount()==0, cSay[1], cSay[1]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      aGet[13] := TGetHlp():ReDefine( 232, { | u | If( PCount()==0, aTmp[13], aTmp[13]:= u ) }, oFld:aDialogs[1],, "99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )









      aGet[14] := TGetHlp():ReDefine( 233, { | u | If( PCount()==0, aTmp[14], aTmp[14]:= u ) }, oFld:aDialogs[1],, "99", {||    ( if( ( aTmp[14] <> 0 .AND. aTmp[14] <= aTmp[13] ), ( msgStop( "Segundo día de pago debe ser mayor que el primero" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 50 ] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ShellExecute( oDlg:hWnd, "open", "mailto:" + Rtrim( aGet[ 50 ]:cText() ) ) )}, nil, "MAIL16",, )












      aGet[49] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[49], aTmp[49]:= u ) }, oFld:aDialogs[1],,, {||    ( oCtaRem:lGetCtaRem( aGet[49], oSay[8] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCtaRem:Buscar( aGet[49] ) )}, nil, "LUPA",, )




      oSay[8] := TGetHlp():ReDefine( 321, { | u | If( PCount()==0, cSay[8], cSay[8]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[45] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[45], aTmp[45]:= u ) }, oFld:aDialogs[1],,, {||    ( cRuta( aGet[45], nil, oSay[4] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[45], nil, oSay[4] ) )}, nil, "LUPA",, )





      oSay[4] := TGetHlp():ReDefine( 221, { | u | If( PCount()==0, cSay[4], cSay[4]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[88] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[88], aTmp[88]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[88], dbfAlmT, oSay[9] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[88], oSay[9] ) )}, nil, "LUPA",, )





      oSay[9] := TGetHlp():ReDefine( 251, { | u | If( PCount()==0, cSay[9], cSay[9]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )







      aGet[ 38 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAgentes( aGet[ 38 ], , oSay[2] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 38 ], oSay[2] ) )}, nil, "LUPA",, )




      oSay[2] := TGetHlp():ReDefine( 231, { | u | If( PCount()==0, cSay[2], cSay[2]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )











      aGet[ 126 ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 126 ], aTmp[ 126 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAgentes( aGet[ 126 ], , oSay[ 7 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 126 ], oSay[ 7 ] ) )}, nil, "LUPA",, )




      oSay[ 7 ] := TGetHlp():ReDefine( 311, { | u | If( PCount()==0, cSay[ 7 ], cSay[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ 48 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oGrpCli:Existe( aGet[ 48 ], oSay[ 5 ], "cNomGrp", .T., .T., "0" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oGrpCli:Buscar( aGet[ 48 ] ) )}, nil, "LUPA",, )





      oSay[5] := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cSay[5], cSay[5]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .T.,,,,,, nil,,, )













      aGet[ 33 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( Empty( aTmp[ 33 ] ) .OR. ( aTmp[ 33 ] >= "A" .AND. aTmp[ 33 ] <= "Z" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T., {||    ( UpSerie( aGet[ 33 ] ) )}, {||  ( DwSerie( aGet[ 33 ] ) )},,,, nil,,, )








      TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "9",,,,,,, .F., {||        ( nMode <> 3 )},, .F., .T.,,, {||         0}, {||         9},, nil,,, )




      TCheckBox():ReDefine( 157, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||        ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 156, { | u | If( PCount()==0, aTmp[ 95 ], aTmp[ 95 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||        ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 158, { | u | If( PCount()==0, aTmp[ 106 ], aTmp[ 106 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||        ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 159, { | u | If( PCount()==0, aTmp[ 107 ], aTmp[ 107 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||        ( nMode <> 3 )}, .F. )











      aGet[ 108 ] := TGetHlp():ReDefine( 235, { | u | If( PCount()==0, aTmp[ 108 ], aTmp[ 108 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil, "Lupa",, 236 )

      aGet[ 108 ]:bValid := {|| oTrans:Existe( aGet[ 108 ], aGet[ 108 ]:oHelpText ) }
      aGet[ 108 ]:bHelp  := {|| oTrans:Buscar( aGet[ 108 ] ) }






      aGet[ 141 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 141 ], aTmp[ 141 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||        ( .F. )},, .F., .T.,,,,,, nil,,, )









      oBmpComercial := TBitmap():ReDefine( 500, "gc_address_book_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )








      aGet[11] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[11], aTmp[11]:= u ) }, oFld:aDialogs[2],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[12] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 113 ] := TGetHlp():ReDefine( 146, { | u | If( PCount()==0, aTmp[ 113 ], aTmp[ 113 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 127 ] := TGetHlp():ReDefine( 147, { | u | If( PCount()==0, aTmp[ 127 ], aTmp[ 127 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 132 ] := TGetHlp():ReDefine( 148, { | u | If( PCount()==0, aTmp[ 132 ], aTmp[ 132 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 133 ] := TGetHlp():ReDefine( 149, { | u | If( PCount()==0, aTmp[ 133 ], aTmp[ 133 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 134 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 134 ], aTmp[ 134 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 135 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[ 135 ], aTmp[ 135 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 128 ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 128 ], aTmp[ 128 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 129 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 129 ], aTmp[ 129 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 130 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 130 ], aTmp[ 130 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 131 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 131 ], aTmp[ 131 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 51 ] := TGetHlp():ReDefine( 290, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TCheckBox():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 110 ], aTmp[ 110 ]:= u ) }, oFld:aDialogs[2],, {||( lPubInt( nMode, aTmp ) )},,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 111 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 111 ], aTmp[ 111 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      oBmpImpuestos := TBitmap():ReDefine( 500, "gc_moneybag_euro_48",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )








      aGet[ 34 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[3],, { 240, 241, 242, 243 },,,,, .F., {||     ( nMode <> 3 )}, )




      TCheckBox():ReDefine( 130, { | u | If( PCount()==0, aTmp[35], aTmp[35]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( aTmp[34] == 1 .AND. nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 52 ], aTmp[ 52 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 .AND. !aTmp[ 93 ] )}, .F. )




      TCheckBox():ReDefine( 145, { | u | If( PCount()==0, aTmp[ 53 ], aTmp[ 53 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( oUser():lAdministrador() .AND. aTmp[ 52 ] .AND. nMode <> 3 .AND. !aTmp[ 93 ] )}, .F. )





      TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[2],, cPorDiv,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. aTmp[ 52 ] .AND. nMode <> 3 .AND. !aTmp[ 93 ] )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 251, { | u | If( PCount()==0, nImpRie, nImpRie:= u ) }, oFld:aDialogs[2],, cPorDiv,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )





      aGet[ 136 ] := TGetHlp():ReDefine( 252, { | u | If( PCount()==0, aTmp[ 136 ], aTmp[ 136 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      aGet[ 137 ] := TGetHlp():ReDefine( 253, { | u | If( PCount()==0, aTmp[ 137 ], aTmp[ 137 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )










      aGet[ 22 ] := TGetHlp():ReDefine( 159, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[3],,, {||    ( lRecargaArray( aGet, aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      aGet[ 23 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[3],, "@E 999.99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      aGet[ 24 ] := TGetHlp():ReDefine( 169, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[3],,, {||    ( lRecargaArray( aGet, aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      aGet[25] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[25], aTmp[25]:= u ) }, oFld:aDialogs[3],, "@E 999.99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      aGet[ 28 ] := TGetHlp():ReDefine( 175, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[3],,, {||    ( lRecargaArray( aGet, aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      aGet[ 26 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[3],, "@E 999.99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      aGet[ 29 ] := TGetHlp():ReDefine( 185, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[3],,, {||    ( lRecargaArray( aGet, aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      aGet[ 96 ] := TGetHlp():ReDefine( 205, { | u | If( PCount()==0, aTmp[ 96 ], aTmp[ 96 ]:= u ) }, oFld:aDialogs[3],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 27 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 27 ], aTmp[ 27 ]:= u ) }, oFld:aDialogs[3],, "@E 999.99",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 97 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 97 ], aTmp[ 97 ]:= u ) }, oFld:aDialogs[3],, "@E 999.99",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      aGet[ 98 ] := TComboBox():ReDefine( 300, { | u | If( PCount()==0, cDescuentosAtipicos, cDescuentosAtipicos:= u ) }, aDescuentosAtipicos, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 98 ]",,,,,,, )




      aGet[ 143 ] := TCheckBox():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 143 ], aTmp[ 143 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 144 ] := TCheckBox():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 144 ], aTmp[ 144 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )








      aGet[ 145 ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 145 ], aTmp[ 145 ]:= u ) }, oFld:aDialogs[3],, "999",,,,,,, .F., {||     ( aTmp[ 144 ] .AND. nMode <> 3 )},, .F., .T.,,, {||      0}, {||      999},, nil,,, )







      aGet[ 138 ] := TCheckBox():ReDefine( 255, { | u | If( PCount()==0, aTmp[ 138 ], aTmp[ 138 ]:= u ) }, oFld:aDialogs[2],, {||( if( aTmp[ 138 ], aGet[ 139 ]:cText( GetSysDate() ), ( aGet[ 139 ]:cText( Ctod("") ), aGet[ 140 ]:cText( Space(50) ) ) ) )},,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 )}, .F. )





      aGet[ 139 ] := TGetHlp():ReDefine( 256, { | u | If( PCount()==0, aTmp[ 139 ], aTmp[ 139 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 .AND. aTmp[ 138 ] )},, .F., .T.,,,,,, nil,,, )




      aGet[ 140 ] := TGetHlp():ReDefine( 257, { | u | If( PCount()==0, aTmp[ 140 ], aTmp[ 140 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 .AND. aTmp[ 138 ] )},, .F., .F.,,,,,, nil,,, )








      aGet[ 93 ] := TCheckBox():ReDefine( 155, { | u | If( PCount()==0, aTmp[ 93 ], aTmp[ 93 ]:= u ) }, oFld:aDialogs[2],, {||( if( aTmp[ 93 ], aGet[ 104 ]:cText( GetSysDate() ), ( aGet[ 104 ]:cText( Ctod("") ), aGet[ 105 ]:cText( Space(50) ) ) ) )},,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 )}, .F. )





      aGet[ 104 ] := TGetHlp():ReDefine( 156, { | u | If( PCount()==0, aTmp[ 104 ], aTmp[ 104 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 .AND. aTmp[ 93 ] )},, .F., .T.,,,,,, nil,,, )




      aGet[ 105 ] := TGetHlp():ReDefine( 157, { | u | If( PCount()==0, aTmp[ 105 ], aTmp[ 105 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 .AND. aTmp[ 93 ] )},, .F., .F.,,,,,, nil,,, )




      TCheckBox():ReDefine( 230, { | u | If( PCount()==0, aTmp[65], aTmp[65]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 231, { | u | If( PCount()==0, aTmp[66], aTmp[66]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 232, { | u | If( PCount()==0, aTmp[67], aTmp[67]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 233, { | u | If( PCount()==0, aTmp[68], aTmp[68]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 234, { | u | If( PCount()==0, aTmp[69], aTmp[69]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 235, { | u | If( PCount()==0, aTmp[70], aTmp[70]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 236, { | u | If( PCount()==0, aTmp[71], aTmp[71]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 72 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 72 ], aTmp[ 72 ]:= u ) }, oFld:aDialogs[2],, "999",,,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 65 ] )},, .F., .T.,,, {||      1}, {||      999},, nil,,, )









      aGet[ 73 ] := TGetHlp():ReDefine( 331, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[2],, "999",,,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 66 ] )},, .F., .T.,,, {||      1}, {||      999},, nil,,, )









      aGet[ 74 ] := TGetHlp():ReDefine( 332, { | u | If( PCount()==0, aTmp[ 74 ], aTmp[ 74 ]:= u ) }, oFld:aDialogs[2],, "999",,,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 67 ] )},, .F., .T.,,, {||      1}, {||      999},, nil,,, )









      aGet[ 75 ] := TGetHlp():ReDefine( 333, { | u | If( PCount()==0, aTmp[ 75 ], aTmp[ 75 ]:= u ) }, oFld:aDialogs[2],, "999",,,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 68 ] )},, .F., .T.,,, {||      1}, {||      999},, nil,,, )









      aGet[ 76 ] := TGetHlp():ReDefine( 334, { | u | If( PCount()==0, aTmp[ 76 ], aTmp[ 76 ]:= u ) }, oFld:aDialogs[2],, "999",,,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 69 ] )},, .F., .T.,,, {||      1}, {||      999},, nil,,, )









      aGet[ 77 ] := TGetHlp():ReDefine( 335, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[2],, "999",,,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 70 ] )},, .F., .T.,,, {||      1}, {||      999},, nil,,, )









      aGet[ 78 ] := TGetHlp():ReDefine( 336, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[2],, "999",,,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 71 ] )},, .F., .T.,,, {||      1}, {||      999},, nil,,, )







      aGet[ 79 ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ 79 ], aTmp[ 79 ]:= u ) }, oFld:aDialogs[2],,, {||    ( cAgentes( aGet[ 79 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 65 ] )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 79 ] ) )}, nil, "LUPA",, )







      aGet[ 80 ] := TGetHlp():ReDefine( 431, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[2],,, {||    ( cAgentes( aGet[ 80 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 66 ] )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 80 ] ) )}, nil, "LUPA",, )







      aGet[ 81 ] := TGetHlp():ReDefine( 432, { | u | If( PCount()==0, aTmp[ 81 ], aTmp[ 81 ]:= u ) }, oFld:aDialogs[2],,, {||    ( cAgentes( aGet[ 81 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 67 ] )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 81 ] ) )}, nil, "LUPA",, )







      aGet[ 82 ] := TGetHlp():ReDefine( 433, { | u | If( PCount()==0, aTmp[ 82 ], aTmp[ 82 ]:= u ) }, oFld:aDialogs[2],,, {||    ( cAgentes( aGet[ 82 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 68 ] )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 82 ] ) )}, nil, "LUPA",, )







      aGet[ 83 ] := TGetHlp():ReDefine( 434, { | u | If( PCount()==0, aTmp[ 83 ], aTmp[ 83 ]:= u ) }, oFld:aDialogs[2],,, {||    ( cAgentes( aGet[ 83 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 69 ] )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 83 ] ) )}, nil, "LUPA",, )







      aGet[ 84 ] := TGetHlp():ReDefine( 435, { | u | If( PCount()==0, aTmp[ 84 ], aTmp[ 84 ]:= u ) }, oFld:aDialogs[2],,, {||    ( cAgentes( aGet[ 84 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 70 ] )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 84 ] ) )}, nil, "LUPA",, )







      aGet[ 85 ] := TGetHlp():ReDefine( 436, { | u | If( PCount()==0, aTmp[ 85 ], aTmp[ 85 ]:= u ) }, oFld:aDialogs[2],,, {||    ( cAgentes( aGet[ 85 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 71 ] )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 85 ] ) )}, nil, "LUPA",, )






      aGet[ 89 ] := TComboBox():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 89 ], aTmp[ 89 ]:= u ) }, aMes, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 89 ]",,,,,,, )






      aGet[ 102 ] := TComboBox():ReDefine( 310, { | u | If( PCount()==0, cTipRetencion, cTipRetencion:= u ) }, aStrRetencion, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 102 ]",,,,,,, )







      aGet[ 103 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 103 ], aTmp[ 103 ]:= u ) }, oFld:aDialogs[3],, "@E 999.99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      TCheckBox():ReDefine( 158, { | u | If( PCount()==0, aTmp[ 117 ], aTmp[ 117 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 122 ] := TGetHlp():ReDefine( 600, { | u | If( PCount()==0, aTmp[ 122 ], aTmp[ 122 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 123 ] := TGetHlp():ReDefine( 601, { | u | If( PCount()==0, aTmp[ 123 ], aTmp[ 123 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      TBtnBmp():ReDefine( 602, "gc_recycle_16",,,,,{|| LlamadaAhora( aGet ) }, oFld:aDialogs[2], .F., , .F.,  )









      oBmpAutomaticas := TBitmap():ReDefine( 500, "gc_document_text_gear_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )





      TButton():ReDefine( 501, {||( AddFacAut( oBrwFacAut ) )}, oFld:aDialogs[4],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( oFacAut:ExternalEdit( if( Len( aFacAut ) > 0, aFacAut[ oBrwFacAut:nArrayAt ], "" ) ) )}, oFld:aDialogs[4],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 503, {||( DelFacAut( oBrwFacAut ) )}, oFld:aDialogs[4],,, .F., {||     ( nMode <> 3 )},,, .F. )

      oBrwFacAut                        := IXBrowse():New( oFld:aDialogs[4] )

      oBrwFacAut:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwFacAut:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwFacAut:SetArray( aFacAut, , , .F. )

      oBrwFacAut:nMarqueeStyle          := 5

      oBrwFacAut:CreateFromResource( 400 )

      with object ( oBrwFacAut:AddCol() )
         :cHeader          := "Código"
         :bStrData         := {|| if( Len( aFacAut ) > 0, aFacAut[ oBrwFacAut:nArrayAt ], "" ) }
         :nWidth           := 75
      end

      with object ( oBrwFacAut:AddCol() )
         :cHeader          := "Nombre"
         :bStrData         := {|| if( Len( aFacAut ) > 0, RetFld( aFacAut[ oBrwFacAut:nArrayAt ], oFacAut:oDbf:cAlias, "cNomFac" ), "" ) }
         :nWidth           := 565
      end









      oBmpDirecciones := TBitmap():ReDefine( 600, "gc_signpost3_48",, oFld:aDialogs[5],,, .F., .F.,,, .F.,,, .T. )





      TButton():ReDefine( 500, {||( AppObras( aTmp[ 1 ], dbfTmpObr, oBrwObr ) )}, oFld:aDialogs[5],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( EdtObras( aTmp[ 1 ], nil, dbfTmpObr, oBrwObr, .T. ) )}, oFld:aDialogs[5],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( DelObras( dbfTmpObr, oBrwObr ) )}, oFld:aDialogs[5],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( ZoomObras( dbfTmpObr, oBrwObr ) )}, oFld:aDialogs[5],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( PredObras( dbfTmpObr, oBrwObr ) )}, oFld:aDialogs[5],,, .F.,,,, .F. )

      oBrwObr                 := IXBrowse():New( oFld:aDialogs[5] )

      oBrwObr:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwObr:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwObr:cAlias          := dbfTmpObr
      oBrwObr:nMarqueeStyle   := 5
      oBrwObr:cName           := "Clientes.Obras"

       with object ( oBrwObr:AddCol() )
         :cHeader          := "Defecto"
         :bEditValue       := {|| ( dbfTmpObr )->lDefObr }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwObr:AddCol() )
         :cHeader          := "Código"
         :bEditValue       := {|| ( dbfTmpObr )->cCodObr }
         :nWidth           := 60
      end

      with object ( oBrwObr:AddCol() )
         :cHeader          := "Nombre domicilio"
         :bEditValue       := {|| ( dbfTmpObr )->cNomObr }
         :nWidth           := 120
      end

      with object ( oBrwObr:AddCol() )
         :cHeader          := "Domicilio"
         :bEditValue       := {|| ( dbfTmpObr )->cDirObr }
         :nWidth           := 120
      end

      with object ( oBrwObr:AddCol() )
         :cHeader          := "Población"
         :bEditValue       := {|| ( dbfTmpObr )->cPobObr }
         :nWidth           := 100
      end

      with object ( oBrwObr:AddCol() )
         :cHeader          := "Código postal"
         :bEditValue       := {|| ( dbfTmpObr )->cPosObr }
         :nWidth           := 60
      end

      with object ( oBrwObr:AddCol() )
         :cHeader          := "Provincia"
         :bEditValue       := {|| ( dbfTmpObr )->cPrvObr }
         :nWidth           := 80
      end

      with object ( oBrwObr:AddCol() )
         :cHeader          := "Teléfono"
         :bEditValue       := {|| ( dbfTmpObr )->cTelObr }
         :nWidth           := 80
      end

      with object ( oBrwObr:AddCol() )
         :cHeader          := "Fax"
         :bEditValue       := {|| ( dbfTmpObr )->cFaxObr }
         :nWidth           := 80
      end

      oBrwObr:bRClicked       := {| nRow, nCol, nFlags | oBrwObr:RButtonDown( nRow, nCol, nFlags ) }
      if nMode <> 3
         oBrwObr:bLDblClick   := {|| EdtObras( aTmp[ 1 ], nil, dbfTmpObr, oBrwObr, .T. ) }
      end

      oBrwObr:CreateFromResource( 400 )









      oBmpContactos := TBitmap():ReDefine( 600, "gc_user_telephone_48",, oFld:aDialogs[13],,, .F., .F.,,, .F.,,, .T. )





      TButton():ReDefine( 500, {||( AppContactos( aTmp[ 1 ], dbfTmpCon, oBrwCon ) )}, oFld:aDialogs[13],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( EdtContactos( dbfTmpCon, oBrwCon ) )}, oFld:aDialogs[13],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( DelContactos( dbfTmpCon, oBrwCon ) )}, oFld:aDialogs[13],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( ZoomContactos( dbfTmpCon, oBrwCon ) )}, oFld:aDialogs[13],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( LlamadaContactos( dbfTmpCon, oBrwCon ) )}, oFld:aDialogs[13],,, .F.,,,, .F. )

      oBrwCon                 := IXBrowse():New( oFld:aDialogs[13] )

      oBrwCon:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwCon:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwCon:cAlias          := dbfTmpCon
      oBrwCon:nMarqueeStyle   := 5
      oBrwCon:cName           := "Clientes.Contactos"

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Nombre"
         :cSortOrder          := "cNomCon"
         :bEditValue          := {|| ( dbfTmpCon )->cNomCon }
         :nWidth              := 120
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Domicilio"
         :bEditValue          := {|| ( dbfTmpCon )->cDirCon }
         :nWidth              := 120
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Población"
         :bEditValue          := {|| ( dbfTmpCon )->cPobCon }
         :nWidth              := 100
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Código postal"
         :bEditValue          := {|| ( dbfTmpCon )->cPosCon }
         :nWidth              := 60
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Provincia"
         :bEditValue          := {|| ( dbfTmpCon )->cPrvCon }
         :nWidth              := 100
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Teléfono"
         :bEditValue          := {|| ( dbfTmpCon )->cTelCon }
         :nWidth              := 80
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Movil"
         :bEditValue          := {|| ( dbfTmpCon )->cMovCon }
         :nWidth              := 80
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Fax"
         :lHide               := .T.
         :bEditValue          := {|| ( dbfTmpCon )->cFaxCon }
         :nWidth              := 80
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Email"
         :bEditValue          := {|| ( dbfTmpCon )->cMaiCon }
         :nWidth              := 120
      end

      with object ( oBrwCon:AddCol() )
         :cHeader             := "Última llamada"
         :bEditValue          := {|| dtoc( ( dbfTmpCon )->dLlaCon ) + space( 1 ) + ( dbfTmpCon )->cTimCon }
         :nWidth              := 100
      end

      oBrwCon:bRClicked       := {| nRow, nCol, nFlags | oBrwCon:RButtonDown( nRow, nCol, nFlags ) }

      if nMode <> 3
         oBrwCon:bLDblClick   := {|| EdtContactos( dbfTmpCon, oBrwCon ) }
      end

      oBrwCon:CreateFromResource( 400 )









      oBmpFacturae := TBitmap():ReDefine( 600, "gc_form_earth_48",, oFld:aDialogs[14],,, .F., .F.,,, .F.,,, .T. )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwFacturae, bEdtFacturae, dbfTmpFacturae, , , aTmp[ 1 ] ) )}, oFld:aDialogs[14],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwFacturae, bEdtFacturae, dbfTmpFacturae, , , aTmp[ 1 ] ) )}, oFld:aDialogs[14],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( WinZooRec( oBrwFacturae, bEdtFacturae, dbfTmpFacturae, , , aTmp[ 1 ] ) )}, oFld:aDialogs[14],,, .F.,,,, .F. )





      TButton():ReDefine( 502, {||( WinDelRec( oBrwFacturae, dbfTmpFacturae ) )}, oFld:aDialogs[14],,, .F., {||     ( nMode <> 3 )},,, .F. )

      oBrwFacturae                  := IXBrowse():New( oFld:aDialogs[14] )

      oBrwFacturae:bClrSel          := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwFacturae:bClrSelFocus     := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwFacturae:cAlias           := dbfTmpFacturae
      oBrwFacturae:nMarqueeStyle    := 6
      oBrwFacturae:cName            := "Clientes.Facturae"

      with object ( oBrwFacturae:AddCol() )
         :cHeader                   := "Descripción del organismo"
         :bEditValue                := {|| ( dbfTmpFacturae )->cDesFac }
         :nWidth                    := 500
      end

      oBrwFacturae:bRClicked        := {| nRow, nCol, nFlags | oBrwFacturae:RButtonDown( nRow, nCol, nFlags ) }

      if nMode <> 3
         oBrwFacturae:bLDblClick    := {|| WinEdtRec( oBrwFacturae, bEdtFacturae, dbfTmpFacturae ), aTmp[ 1 ] }
      end

      oBrwFacturae:CreateFromResource( 400 )









      oBmpBancos := TBitmap():ReDefine( 500, "gc_central_bank_euro_48",, oFld:aDialogs[6],,, .F., .F.,,, .F.,,, .T. )





      TButton():ReDefine( 101, {||( WinAppRec( oBrwBnc, bEdtBnc, dbfTmpBnc, aTmp, , aTmp[ 1 ] ) )}, oFld:aDialogs[6],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 102, {||( WinEdtRec( oBrwBnc, bEdtBnc, dbfTmpBnc, aTmp, , aTmp[ 1 ] ) )}, oFld:aDialogs[6],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 103, {||( WinZooRec( oBrwBnc, bEdtBnc, dbfTmpBnc ) )}, oFld:aDialogs[6],,, .F.,,,, .F. )





      TButton():ReDefine( 104, {||( DelBnc( aTmp, oBrwBnc, dbfTmpBnc ) )}, oFld:aDialogs[6],,, .F., {||     ( nMode <> 3 )},,, .F. )

      oBrwBnc                 := IXBrowse():New( oFld:aDialogs[6] )

      oBrwBnc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwBnc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwBnc:cAlias          := dbfTmpBnc
      oBrwBnc:nMarqueeStyle   := 5
      oBrwBnc:cName           := "Clientes.Bancos"

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "D. Banco por defecto"
         :bEditValue       := {|| ( dbfTmpBnc )->lBncDef }
         :nWidth           := 16
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Nombre banco"
         :bEditValue       := {|| ( dbfTmpBnc )->cCodBnc }
         :nWidth           := 180
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Cuenta"
         :bEditValue       := {|| PictureCuentaIBAN( dbfTmpBnc ) }
         :nWidth           := 180
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Domicilio"
         :bEditValue       := {|| ( dbfTmpBnc )->cDirBnc }
         :nWidth           := 120
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Población"
         :bEditValue       := {|| ( dbfTmpBnc )->cPobBnc }
         :nWidth           := 100
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Código postal"
         :bEditValue       := {|| ( dbfTmpBnc )->cCPBnc }
         :nWidth           := 40
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Provincia"
         :bEditValue       := {|| ( dbfTmpBnc )->cProBnc }
         :nWidth           := 80
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Teléfono"
         :bEditValue       := {|| ( dbfTmpBnc )->cTlfBnc }
         :nWidth           := 80
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Fax"
         :bEditValue       := {|| ( dbfTmpBnc )->cFaxBnc }
         :nWidth           := 80
      end

      with object ( oBrwBnc:AddCol() )
         :cHeader          := "Contacto"
         :bEditValue       := {|| ( dbfTmpBnc )->cPContBnc }
         :nWidth           := 140
      end

      oBrwBnc:bRClicked       := {| nRow, nCol, nFlags | oBrwBnc:RButtonDown( nRow, nCol, nFlags ) }
      if nMode <> 3
         oBrwBnc:bLDblClick   := {|| WinEdtRec( oBrwBnc, bEdtBnc, dbfTmpBnc, aTmp, , aTmp[1] ) }
      end

      oBrwBnc:CreateFromResource( 100 )









      oBmpContabilidad := TBitmap():ReDefine( 500, "gc_folders2_48",, oFld:aDialogs[7],,, .F., .F.,,, .F.,,, .T. )
























      aGet[ 36 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[7],, ( Replicate( "X", nLenSubcuentaContaplus() ) ), {||    ( MkSubcuenta(  aGet[ 36 ], {  aTmp[ 36    ], aTmp[ 2    ], aTmp[ 3       ], aTmp[ 4 ], aTmp[ 5 ], aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8  ], aTmp[ 9       ], aTmp[ 50   ] }, oGetSubCta, nil, nil, @nGetDebe, @nGetHaber, oGetSaldo ) )},,,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkSubcuenta( aGet[36], oGetSubCta ) )}, nil, "Lupa",, )




      oGetSubCta := TGetHlp():ReDefine( 351, { | u | If( PCount()==0, cGetSubCta, cGetSubCta:= u ) }, oFld:aDialogs[7],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      oGetSaldo := TGetHlp():ReDefine( 352, { | u | If( PCount()==0, nGetSaldo, nGetSaldo:= u ) }, oFld:aDialogs[7],, cPorDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[37] := TGetHlp():ReDefine( 360, { | u | If( PCount()==0, aTmp[37], aTmp[37]:= u ) }, oFld:aDialogs[7],,, {||    ( ChkCta( aTmp[37], oGetCta ) )},,,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkCta( aGet[37], oGetCta ) )}, nil, "LUPA",, )




      oGetCta := TGetHlp():ReDefine( 361, { | u | If( PCount()==0, cGetCta, cGetCta:= u ) }, oFld:aDialogs[7],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





























      aGet[92] := TGetHlp():ReDefine( 370, { | u | If( PCount()==0, aTmp[92], aTmp[92]:= u ) }, oFld:aDialogs[7],, ( Replicate( "X", nLenSubcuentaContaplus() ) ), {||    ( MkSubcuenta( aGet[ 92 ], {  aTmp[ 92 ], aTmp[ 2    ], aTmp[ 3       ], aTmp[ 4 ], aTmp[ 5 ], aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8  ], aTmp[ 9       ], aTmp[ 50   ] }, oGetSubDto, nil, nil, nil, nil, oGetSalDto ) )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkSubcuenta( aGet[92], oGetSubDto ) )}, nil, "LUPA",, )




      oGetSubDto := TGetHlp():ReDefine( 371, { | u | If( PCount()==0, cGetSubDto, cGetSubDto:= u ) }, oFld:aDialogs[7],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      oGetSalDto := TGetHlp():ReDefine( 372, { | u | If( PCount()==0, nGetSalDto, nGetSalDto:= u ) }, oFld:aDialogs[7],, cPorDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      oBrwCta                 := IXBrowse():New( oFld:aDialogs[7] )

      oBrwCta:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwCta:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwCta:cAlias          := dbfTmpSubCta
      oBrwCta:nMarqueeStyle   := 5
      oBrwCta:cName           := "Clientes.Contabilidad"
      oBrwCta:lFooter         := .T.

      with object ( oBrwCta:AddCol() )
         :cHeader          := "Asiento"
         :bEditValue       := {|| Trans( ( dbfTmpSubCta )->nAsiento, "9999999" ) }
         :nWidth           := 80
      end

      with object ( oBrwCta:AddCol() )
         :cHeader          := "Fecha"
         :bEditValue       := {|| Dtoc( ( dbfTmpSubCta )->dFecha ) }
         :nWidth           := 80
      end

      with object ( oBrwCta:AddCol() )
         :cHeader          := "Concepto"
         :bEditValue       := {|| ( dbfTmpSubCta )->cConcepto }
         :nWidth           := 180
      end

      with object ( oBrwCta:AddCol() )
         :cHeader          := "Debe"
         :bEditValue       := {|| ( dbfTmpSubCta )->nDebe }
         :bFooter          := {|| nGetDebe }
         :cEditPicture     := cPorDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwCta:AddCol() )
         :cHeader          := "Haber"
         :bEditValue       := {|| ( dbfTmpSubCta )->nHaber }
         :bFooter          := {|| nGetHaber }
         :cEditPicture     := cPorDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwCta:AddCol() )
         :cHeader          := "Departamento"
         :bEditValue       := {|| ( dbfTmpSubCta )->cDeparta }
         :nWidth           := 80
      end

      with object ( oBrwCta:AddCol() )
         :cHeader          := "Factura"
         :bEditValue       := {|| Trans( ( dbfTmpSubCta )->nFactura, "99999999" ) }
         :nWidth           := 80
      end

      with object ( oBrwCta:AddCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( dbfTmpSubCta )->nBase }
         :cEditPicture     := cPorDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwCta:AddCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( dbfTmpSubCta )->nIva }
         :cEditPicture     := cPorDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      oBrwCta:bRClicked    := {| nRow, nCol, nFlags | oBrwCta:RButtonDown( nRow, nCol, nFlags ) }

      oBrwCta:CreateFromResource( 400 )









      oBmpComentario := TBitmap():ReDefine( 500, "gc_message_48",, oFld:aDialogs[8],,, .F., .F.,,, .F.,,, .T. )






      aGet[ 44 ] := TMultiGet():ReDefine( 370, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[8],, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 380, { | u | If( PCount()==0, aTmp[ 94 ], aTmp[ 94 ]:= u ) }, oFld:aDialogs[8],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      oBmpTarifa := TBitmap():ReDefine( 600, "gc_symbol_euro_48",, oFld:aDialogs[9],,, .F., .F.,,, .F.,,, .T. )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwAtp, bEdtAtp, dbfTmpAtp, aTmp, aGet ) )}, oFld:aDialogs[9],,, .F., {||     ( ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) .AND. nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwAtp, bEdtAtp, dbfTmpAtp, aTmp, aGet ) )}, oFld:aDialogs[9],,, .F., {||     ( ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) .AND. nMode <> 3 )},,, .F. )





      TButton():ReDefine( 503, {||( WinZooRec( oBrwAtp, bEdtAtp, dbfTmpAtp, aTmp, aGet ) )}, oFld:aDialogs[9],,, .F., {||     ( ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) .AND. nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( WinDelRec( oBrwAtp, dbfTmpAtp ) )}, oFld:aDialogs[9],,, .F., {||     ( ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) .AND. nMode <> 3 )},,, .F. )





      TButton():ReDefine( 504, {||( AddFamilia( oBrwAtp, dbfTmpAtp, aTmp[1] ) )}, oFld:aDialogs[9],,, .F., {||     ( ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) .AND. nMode <> 3 )},,, .F. )




      TButton():ReDefine( 505, {||( Searching( dbfTmpAtp, { "Artículo", "Familia" }, oBrwAtp ) )}, oFld:aDialogs[9],,, .F.,,,, .F. )






      TButton():ReDefine( 506, {||( TInfAtp():New( "Plantilla de condiciones especificas", , , , , , { dbfTmpAtp, aGet, aTmp } ):Play() )}, oFld:aDialogs[9],,, .F.,,,, .F. )







      oFiltroAtp := TComboBox():ReDefine( 507, { | u | If( PCount()==0, cFiltroAtp, cFiltroAtp:= u ) }, aFiltroAtp, oFld:aDialogs[9],,, {|Self|( FiltroAtipica( oFiltroAtp, dbfTmpAtp, oBrwAtp ) )},,,, .F.,,,,,,, "oFiltroAtp",,,,,,, )





      oBrwAtp                 := IXBrowse():New( oFld:aDialogs[9] )

      oBrwAtp:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwAtp:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwAtp:cAlias          := dbfTmpAtp
      oBrwAtp:nMarqueeStyle   := 6
      oBrwAtp:cName           := "Clientes.Atipicas"
      oBrwAtp:lAutoSort       := .T.

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Tipo"
         :bEditValue       := {|| if( ( dbfTmpAtp )->nTipAtp <= 1, "Artículo", "Familia" ) }
         :nWidth           := 60
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Of. Artículo en oferta"
         :bEditValue       := {|| ( dbfTmpAtp )->nTipAtp <= 1 .AND. lArticuloEnOferta( ( dbfTmpAtp )->cCodArt, ( D():Clientes( nView ) )->Cod, ( D():Clientes( nView ) )->cCodGrp ) }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCliArt"
         :bEditValue       := {|| if( ( dbfTmpAtp )->nTipAtp <= 1, ( dbfTmpAtp )->cCodArt, ( dbfTmpAtp )->cCodFam ) }
         :nWidth           := 80
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomArt"
         :bEditValue       := {|| if( ( dbfTmpAtp )->nTipAtp <= 1, ( dbfTmpAtp )->cNomArt, ( dbfTmpAtp )->cNomFam ) }
         :nWidth           := 160
      end







      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Prop.1"
         :bEditValue       := {|| ( dbfTmpAtp )->cValPr1 }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Prop.2"
         :bEditValue       := {|| ( dbfTmpAtp )->cValPr2 }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Costo"
         :bEditValue       := {|| if( ( dbfTmpAtp )->lPrcCom, ( dbfTmpAtp )->nPrcCom, nCosto( ( dbfTmpAtp )->cCodArt, D():Articulos( nView ), dbfArtKit,,,, ( dbfTmpAtp )->cCodCli ) ) }
         :cEditPicture     := cPouDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := uFieldEmpresa( "cTxtTar1", "Precio 1" )
         :bEditValue       := {|| ( dbfTmpAtp )->nPrcArt }
         :cEditPicture     := cPouDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := uFieldEmpresa( "cTxtTar2", "Precio 2" )
         :bEditValue       := {|| ( dbfTmpAtp )->nPrcArt2 }
         :cEditPicture     := cPouDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := uFieldEmpresa( "cTxtTar3", "Precio 3" )
         :bEditValue       := {|| ( dbfTmpAtp )->nPrcArt3 }
         :cEditPicture     := cPouDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := uFieldEmpresa( "cTxtTar4", "Precio 4" )
         :bEditValue       := {|| ( dbfTmpAtp )->nPrcArt4 }
         :cEditPicture     := cPouDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := uFieldEmpresa( "cTxtTar5", "Precio 5" )
         :bEditValue       := {|| ( dbfTmpAtp )->nPrcArt5 }
         :cEditPicture     := cPouDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := uFieldEmpresa( "cTxtTar6", "Precio 6" )
         :bEditValue       := {|| ( dbfTmpAtp )->nPrcArt6 }
         :cEditPicture     := cPouDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "% Descuento"
         :bEditValue       := {|| ( dbfTmpAtp )->nDtoArt }
         :cEditPicture     := "@E 999.99"
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Descuento lineal"
         :bEditValue       := {|| ( dbfTmpAtp )->nDtoDiv }
         :cEditPicture     := cPouDiv
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "% Agente"
         :bEditValue       := {|| ( dbfTmpAtp )->nComAge }
         :cEditPicture     := "@E 999.99"
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Inicio"
         :bEditValue       := {|| ( dbfTmpAtp )->dFecIni }
         :nWidth           := 80
      end

      with object ( oBrwAtp:AddCol() )
         :cHeader          := "Fin"
         :bEditValue       := {|| ( dbfTmpAtp )->dFecFin }
         :nWidth           := 80
      end

      if ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) .AND. nMode <> 3
         oBrwAtp:bLDblClick   := {|| WinEdtRec( oBrwAtp, bEdtAtp, dbfTmpAtp, aTmp, aGet ) }
      end
      oBrwAtp:bRClicked       := {| nRow, nCol, nFlags | oBrwAtp:RButtonDown( nRow, nCol, nFlags ) }

      oBrwAtp:CreateFromResource( 400 )









      oBmpDocumentos := TBitmap():ReDefine( 600, "gc_folders_48",, oFld:aDialogs[10],,, .F., .F.,,, .F.,,, .T. )

      oBrwDoc                 := IXBrowse():New( oFld:aDialogs[10] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc
      oBrwDoc:nMarqueeStyle   := 5
      oBrwDoc:cName           := "Clientes.Documentos"
      oBrwDoc:nRowHeight      := 38
      oBrwDoc:nDataLines      := 2

      with object ( oBrwDoc:AddCol() )
         :cHeader          := "Documento"
         :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + lTrim( ( dbfTmpDoc )->cRuta ) }
         :nWidth           := 480
      end

      if ( nMode <> 3 )
         oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) }
      end
      oBrwDoc:bRClicked       := {| nRow, nCol, nFlags | oBrwDoc:RButtonDown( nRow, nCol, nFlags ) }

      oBrwDoc:CreateFromResource( 400 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[10],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[10],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .T. ) )}, oFld:aDialogs[10],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[10],,, .F.,,,, .F. )





      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[10],,, .F., {||     ( nMode <> 3 )},,, .F. )









      oBmpIncidencias := TBitmap():ReDefine( 600, "gc_sign_warning_48",, oFld:aDialogs[11],,, .F., .F.,,, .F.,,, .T. )

      oBrwInc                 := IXBrowse():New( oFld:aDialogs[11] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc
      oBrwInc:nMarqueeStyle   := 5
      oBrwInc:cName           := "Clientes.Incidencias"

      with object ( oBrwInc:AddCol() )
         :cHeader          := "Rs. Resuelta"
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfTmpInc )->lListo }
         :nWidth           := 18
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwInc:AddCol() )
         :cHeader          := "Fecha/Hora"
         :bEditValue       := {|| dateTimeToString( ( dbfTmpInc )->dFecInc, ( dbfTmpInc )->tTimInc ) }
         :nWidth           := 120
      end

      with object ( oBrwInc:AddCol() )
         :cHeader          := "Descripción"
         :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
         :nWidth           := 350
      end

      with object ( oBrwInc:AddCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodTip"
         :bEditValue       := {|| ( dbfTmpInc )->cCodTip }
         :nWidth           := 40
      end

      if nMode <> 3
         oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
      end
      oBrwInc:bRClicked       := {| nRow, nCol, nFlags | oBrwInc:RButtonDown( nRow, nCol, nFlags ) }

      oBrwInc:CreateFromResource( 400 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[11],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[11],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) )}, oFld:aDialogs[11],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[11],,, .F.,,,, .F. )









      oBmpObservaciones := TBitmap():ReDefine( 600, "gc_eye_48",, oFld:aDialogs[12],,, .F., .F.,,, .F.,,, .T. )

      oClp := TClipBoard():New( Upper("TEXT"), oFld:aDialogs[12] )








      oBtn[ 1 ] := TBtnBmp():ReDefine( 100, "gc_printer2_16",,,,, {|Self|( oRTF:Print(), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( .T. )}, .F., "Imprimir",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 2 ] := TBtnBmp():ReDefine( 110, "PREV116",,,,, {|Self|( oRTF:Preview( "Class TRichEdit" ) )}, oFld:aDialogs[12], .F., {||     ( .T. )}, .F., "Previsualizar",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 3 ] := TBtnBmp():ReDefine( 120, "Bus16",,,,, {|Self|( FindRich( oRTF ) )}, oFld:aDialogs[12], .F., {||     ( .T. )}, .F., "Buscar",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 4 ] := TBtnBmp():ReDefine( 130, "gc_cut_16",,,,, {|Self|( oRTF:Cut(), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! Empty( oRTF:GetSel() ) .AND. ! oRTF:lReadOnly )}, .F., "Cortar",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 5 ] := TBtnBmp():ReDefine( 140, "gc_copy_16",,,,, {|Self|( oRTF:Copy(), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! Empty( oRTF:GetSel() ) )}, .F., "Copiar",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 6 ] := TBtnBmp():ReDefine( 150, "gc_clipboard_paste_16",,,,, {|Self|( oRTF:Paste(), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! Empty( oClp:GetText() ) .AND. ! oRTF:lReadOnly )}, .F., "Pegar",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 7 ] := TBtnBmp():ReDefine( 160, "gc_undo_inv_16",,,,, {|Self|( oRTF:Undo(), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( oRTF:SendMsg( 198 ) <> 0 )}, .F., "Deshacer",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 8 ] := TBtnBmp():ReDefine( 170, "gc_undo_16",,,,, {|Self|( oRTF:Redo(), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( oRTF:SendMsg( ( 1024 + 85 ) ) <> 0 )}, .F., "Rehacer",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )




      oZoom := TComboBox():ReDefine( 180, { | u | If( PCount()==0, cZoom, cZoom:= u ) }, aZoom, oFld:aDialogs[12],,,,,,, .F.,,,,,,, "oZoom",,,,,,, )

      oZoom:bChange     := {|| oRTF:SetZoom( aRatio[ oZoom:nAt, 1 ], aRatio[ oZoom:nAt, 2 ] ), oRTF:SetFocus()  }




      oFuente := TComboBox():ReDefine( 190, { | u | If( PCount()==0, cFuente, cFuente:= u ) }, aFuente, oFld:aDialogs[12],,,,,,, .F.,,,,,,, "oFuente",,,,,,, )

      oFuente:bChange   := {|| oRTF:SetFontName( oFuente:VarGet() ), oRTF:SetFocus() }




      oSize := TComboBox():ReDefine( 200, { | u | If( PCount()==0, cSize, cSize:= u ) }, aSize, oFld:aDialogs[12],,,,,,, .F.,,,,,,, "oSize",,,,,,, )

      oSize:bChange     := {|| oRTF:SetFontSize( Val( oSize:VarGet() ) ), oRTF:SetFocus() }








      oBtn[10] := TBtnBmp():ReDefine( 210, "gc_text_bold_16",,,,, {|Self|( lBold  := !lBold, oRTF:SetBold( lBold ), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! oRTF:lReadOnly )}, .F., "Negrita",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 10 ] := TBtnBmp():ReDefine( 220, "gc_text_italics_16",,,,, {|Self|( lItalic := !lItalic, oRTF:SetItalic( lItalic ), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! oRTF:lReadOnly )}, .F., "Cursiva",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 11 ] := TBtnBmp():ReDefine( 230, "gc_text_underline_16",,,,, {|Self|( lUnderline := !lUnderline, oRTF:SetUnderline( lUnderline ), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! oRTF:lReadOnly )}, .F., "Subrayado",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 12 ] := TBtnBmp():ReDefine( 240, "gc_text_align_left_16",,,,, {|Self|( oRTF:SetAlign( 1 ), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! oRTF:lReadOnly )}, .F., "Izquierda",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 13 ] := TBtnBmp():ReDefine( 250, "gc_text_center_16",,,,, {|Self|( oRTF:SetAlign( 3 ), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! oRTF:lReadOnly )}, .F., "Centro",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 14 ] := TBtnBmp():ReDefine( 260, "gc_text_align_right_16",,,,, {|Self|( oRTF:SetAlign( 2 ), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! oRTF:lReadOnly )}, .F., "Derecha",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 15 ] := TBtnBmp():ReDefine( 270, "gc_text_justified_16",,,,, {|Self|( oRTF:SetAlign( 4 ), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! oRTF:lReadOnly )}, .F., "Justificado",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 16 ] := TBtnBmp():ReDefine( 280, "gc_pin_blue_16",,,,, {|Self|( lBullet := !lBullet, oRTF:SetBullet( lBullet ), oRTF:SetFocus() )}, oFld:aDialogs[12], .F., {||     ( ! oRTF:lReadOnly .AND. !oRTF:GetNumbering() )}, .F., "Viñetas",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oBtn[ 17 ] := TBtnBmp():ReDefine( 290, "gc_calendar_16",,,,, {|Self|( DateTimeRich( oRTF ) )}, oFld:aDialogs[12], .F., {||     ( .T. )}, .F., "Fecha/Hora",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )



      oRTF := TRichEdit():ReDefine( 300, { | u | If( PCount()==0, cRTF, cRTF:= u ) }, oFld:aDialogs[12],,,, .F., .F.,,, .F.,,, )

      oRTF:bChange:= { || RTFRefreshButtons( oRtf, oBtn ) }









      oBmpRecibos := TBitmap():ReDefine( 500, "gc_safe_into_48",, oFld:aDialogs[15],,, .F., .F.,,, .F.,,, .T. )






      oPeriodoCli := TComboBox():ReDefine( 100, { | u | If( PCount()==0, cPeriodoCli, cPeriodoCli:= u ) }, aPeriodoCli, oFld:aDialogs[15],,, {|Self|( lRecargaFecha( oFecIniCli, oFecFinCli, cPeriodoCli ), LoadPageClient( aTmp[ 1 ] ) )},,,, .F.,,,,,,, "oPeriodoCli",,,,,,, )





      oFecIniCli := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, dFecIniCli, dFecIniCli:= u ) }, oFld:aDialogs[15],,, {||       ( LoadPageClient( aTmp[ 1 ] ) )},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





      oFecFinCli := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, dFecFinCli, dFecFinCli:= u ) }, oFld:aDialogs[15],,, {||       ( LoadPageClient( aTmp[ 1 ] ) )},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





      oEstadoCli := TComboBox():ReDefine( 130, { | u | If( PCount()==0, cEstadoCli, cEstadoCli:= u ) }, aEstadoCli, oFld:aDialogs[15],,, {|Self|( LoadPageClient( aTmp[ 1 ] ) )},,,, .F.,,,,,,, "oEstadoCli",,,,,,, )

      oBrwRecCli                 := IXBrowse():New( oFld:aDialogs[15] )

      oBrwRecCli:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwRecCli:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwRecCli:cAlias          := ( D():FacturasClientesCobros( nView ) )

      oBrwRecCli:nMarqueeStyle   := 6
      oBrwRecCli:lRecordSelector := .F.
      oBrwRecCli:cName           := "Recibos de Clientes.Inicio"
      oBrwRecCli:lFooter         := .T.

      oBrwRecCli:bLDblClick      := {|| if ( !Empty( ( D():FacturasClientesCobros( nView ) )->cSerie ), EdtRecCli( D():FacturasClientesCobrosId( nView ), .F., !Empty( ( D():FacturasClientesCobros( nView ) )->cTipRec ) ), ), LoadPageClient( aTmp[ 1 ] ) }

      oBrwRecCli:CreateFromResource( 170 )

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "E. Estado"
         :bStrData               := {|| "" }
         :bEditValue             := {|| ( D():FacturasClientesCobros( nView ) )->lCobrado }
         :nWidth                 := 18
         :SetCheck( { "Sel16", "Cnt16" } )
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "T. Tipo"
         :bEditValue             := {|| if( Empty( ( D():FacturasClientesCobros( nView ) )->cTipRec ), "Factura", "Rectificativa" ) }
         :nWidth                 := 18
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Número"
         :bEditValue             := {|| AllTrim( ( D():FacturasClientesCobros( nView ) )->cSerie ) + "/" + AllTrim( Str( ( D():FacturasClientesCobros( nView ) )->nNumFac ) ) + "/" +  AllTrim( ( D():FacturasClientesCobros( nView ) )->cSufFac ) + "-" + AllTrim( Str( ( D():FacturasClientesCobros( nView ) )->nNumRec ) ) }
         :nWidth                 := 80
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Cliente"
         :bEditValue             := {|| AllTrim( ( D():FacturasClientesCobros( nView ) )->cCodCli ) }
         :nWidth                 := 60
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Nombre"
         :bEditValue             := {|| AllTrim( ( D():FacturasClientesCobros( nView ) )->cNomCli ) }
         :nWidth                 := 200
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Fecha"
         :bEditValue             := {|| Dtoc( ( D():FacturasClientesCobros( nView ) )->dPreCob ) }
         :nWidth                 := 80
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Vencimiento"
         :bEditValue             := {|| Dtoc( ( D():FacturasClientesCobros( nView ) )->dFecVto ) }
         :bClrStd                := {|| { if( ( D():FacturasClientesCobros( nView ) )->dFecVto < GetSysDate(), 255, 0 ), GetSysColor( 5 )} }
         :nWidth                 := 80
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Importe"
         :bEditValue             := {|| ( D():FacturasClientesCobros( nView ) )->nImporte }
         :cEditPicture           := cPorDiv()
         :nFooterType            := 1
         :nWidth                 := 70
         :nDataStrAlign          := 1
         :nHeadStrAlign          := 1
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader             := "Modificar"
         :bStrData            := {|| "" }
         :bOnPostEdit         := {|| .T. }
         :bEditBlock          := {|| if ( !Empty( ( D():FacturasClientesCobros( nView ) )->cSerie ), EdtRecCli( D():FacturasClientesCobrosId( nView ), .F., !Empty( ( D():FacturasClientesCobros( nView ) )->cTipRec ) ), ), LoadPageClient( aTmp[ 1 ] ) }
         :nEditType           := 5
         :nWidth              := 20
         :nHeadBmpNo          := 1
         :nBtnBmp             := 1
         :nHeadBmpAlign       := 1
         :AddResource( "EDIT16" )
     end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Pago"
         :bEditValue             := {|| cNbrFPago( ( D():FacturasClientesCobros( nView ) )->cCodPgo, dbfFPago ) }
         :nWidth                 := 200
         :lHide                  := .T.
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Pagado por"
         :bEditValue             := {|| ( D():FacturasClientesCobros( nView ) )->cPgdoPor }
         :nWidth                 := 100
         :lHide                  := .T.
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Documento"
         :bEditValue             := {|| ( D():FacturasClientesCobros( nView ) )->cDocPgo }
         :nWidth                 := 100
         :lHide                  := .T.
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Obs Cobro"
         :bEditValue             := {|| aTmp[ 55 ] }
         :nWidth                 := 100
         :lHide                  := .T.
         :nEditType              := 1
         :bOnPostEdit            := {|oCol, uNewValue, nKey| ChangeCampoDef( oCol, uNewValue, nKey, aTmp, 55, oBrwRecCli ) }
      end

      with object ( oBrwRecCli:AddCol() )
         :cHeader                := "Contacto/Tlf"
         :bEditValue             := {|| aTmp[ 56 ] }
         :nWidth                 := 100
         :lHide                  := .T.
         :nEditType              := 1
         :bOnPostEdit            := {|oCol, uNewValue, nKey| ChangeCampoDef( oCol, uNewValue, nKey, aTmp, 56, oBrwRecCli ) }
      end








      TButton():ReDefine( 3, {||( if( oFld:nOption > 1, oFld:SetOption( oFld:nOption - 1 ), ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 4, {||( if( oFld:nOption < Len( oFld:aDialogs ), oFld:SetOption( oFld:nOption + 1 ), ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 1, {||( SavClient( aTmp, aGet, oDlg, oBrw, nMode ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3

         oFld:aDialogs[5]:AddFastKey( 113, {|| AppObras( aTmp[ 1 ], dbfTmpObr, oBrwObr ) } )
         oFld:aDialogs[5]:AddFastKey( 114, {|| EdtObras( aTmp[ 1 ], nil, dbfTmpObr, oBrwObr, .T. ) } )
         oFld:aDialogs[5]:AddFastKey( 115, {|| DelObras( dbfTmpObr, oBrwObr ) } )

         oFld:aDialogs[13]:AddFastKey( 113, {|| AppContactos( aTmp[ 1 ], dbfTmpCon, oBrwCon ) } )
         oFld:aDialogs[13]:AddFastKey( 114, {|| EdtContactos( dbfTmpCon, oBrwCon ) } )
         oFld:aDialogs[13]:AddFastKey( 115, {|| DelContactos( dbfTmpCon, oBrwCon ) } )

         oFld:aDialogs[6]:AddFastKey( 113, {|| WinAppRec( oBrwBnc, bEdtBnc, dbfTmpBnc, aTmp, , aTmp[ 1 ] ) } )
         oFld:aDialogs[6]:AddFastKey( 114, {|| WinEdtRec( oBrwBnc, bEdtBnc, dbfTmpBnc, aTmp, , aTmp[ 1 ] ) } )
         oFld:aDialogs[6]:AddFastKey( 115, {|| DelBnc( aTmp, oBrwBnc, dbfTmpBnc ) } )

         oFld:aDialogs[9]:AddFastKey( 113, {|| WinAppRec( oBrwAtp, bEdtAtp, dbfTmpAtp, aTmp, aGet ) } )
         oFld:aDialogs[9]:AddFastKey( 114, {|| WinEdtRec( oBrwAtp, bEdtAtp, dbfTmpAtp, aTmp, aGet ) } )
         oFld:aDialogs[9]:AddFastKey( 115, {|| WinDelRec( oBrwAtp, dbfTmpAtp ) } )

         oFld:aDialogs[10]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
         oFld:aDialogs[10]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
         oFld:aDialogs[10]:AddFastKey( 115, {|| DbDelRec(  oBrwDoc, dbfTmpDoc, nil, nil, .T. ) } )

         oFld:aDialogs[11]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
         oFld:aDialogs[11]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
         oFld:aDialogs[11]:AddFastKey( 115, {|| DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) } )

         oDlg:AddFastKey( 118, {|| if( oFld:nOption > 1, oFld:SetOption( oFld:nOption - 1 ), ) } )
         oDlg:AddFastKey( 119, {|| if( oFld:nOption < Len( oFld:aDialogs ), oFld:SetOption( oFld:nOption + 1 ), ) } )

         oDlg:AddFastKey( 120, {|| oDetCamposExtra:Play( Space(1) ) } )

         oDlg:AddFastKey( 116, {|| SavClient( aTmp, aGet, oDlg, oBrw, nMode ) } )

      end















      oDlg:bStart := {||   ShowComentario( aTmp ), ShowIncidenciaCliente( aTmp[ 1 ], nView ), ShowFld( aTmp, aGet ), FiltroAtipica( oFiltroAtp, dbfTmpAtp, oBrwAtp ), oGet:SetFocus(), oBrwBnc:Load(), oBrwObr:Load(), oBrwCta:Load(), oBrwAtp:Load(), oBrwCon:Load(), oBrwRecCli:Load(), if( !empty( nTab ), oFld:setOption( nTab ), ), lRecargaFecha( oFecIniCli, oFecFinCli, cPeriodoCli ), LoadPageClient( aTmp[ 1 ] ), aGet[ 108 ]:lValid() }

      CodigosPostales():GetInstance():setBinding( { "CodigoPostal" => aGet[ 7 ], "Poblacion" => aGet[ 5 ], "Provincia" => aGet[ 6 ] } )




   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( KillTrans( oBmpDiv, oBrwBnc, oBrwObr, oBrwCta, oBrwAtp, oBrwInc, oBrwCon ) )},, {|Self|( EdtRotorMenu( aTmp, aGet, oDlg, oBrw, nMode ) )}, oDlg:bRClicked,,, )



   EndEdtRotorMenu()

   oBmpGeneral:End()
   oBmpComercial:End()
   oBmpDirecciones:End()
   oBmpContactos:End()
   oBmpBancos:End()
   oBmpContabilidad:End()
   oBmpComentario:End()
   oBmpTarifa:End()
   oBmpDocumentos:End()
   oBmpIncidencias:End()
   oBmpObservaciones:End()
   oBmpAutomaticas:End()
   oBmpRecibos:End()
   oBmpFacturae:End()
   oBmpImpuestos:End()


RETURN ( oDlg:nResult == 1 )



function AddFacAut( oBrwFacAut )

   local cResultado  := ""

   cResultado := oFacAut:Buscar()

   if !Empty( cResultado )

      if aScan( aFacAut, cResultado ) == 0
         aAdd( aFacAut, cResultado )
      else
         MsgStop( "La plantilla automática ya se encuentra introducida." )
      end

   end

   if !Empty( oBrwFacAut )
      oBrwFacAut:Refresh()
   end

Return ( .T. )



function DelFacAut( oBrwFacAut )

   if ApoloMsgNoYes()
      hb_ADel( aFacAut, oBrwFacAut:nArrayAt, .T. )
   end

   if !Empty( oBrwFacAut )
      oBrwFacAut:Refresh()
   end

Return ( .T. )



function ShowIncidenciaCliente( cCodigoCliente, nView )

   D():getStatusClientesIncidencias( nView )

   if D():gotoIdClientesIncidencias( cCodigoCliente, nView )

      while ( D():ClientesIncidenciasId( nView ) == cCodigoCliente .AND. !D():eofClientesIncidecias( nView ) )
         if ( D():ClientesIncidencias( nView ) )->lAviso .AND. !( D():ClientesIncidencias( nView ) )->lListo
            msgInfo( AllTrim( ( D():ClientesIncidencias( nView ) )->mDesInc ), "Incidencia de cliente" )
         end
         ( D():ClientesIncidencias( nView ) )->( dbSkip() )
      end

   end

   D():setStatusClientesIncidencias( nView )

Return ( .T. )



Static Function ShowComentario( aTmp, nMode )

   if nMode <> 1 .AND. aTmp[ 94 ] .AND. !Empty( aTmp[ 44 ] )
      MsgInfo( AllTrim( aTmp[ 44 ] ), "Comentario" )
   end

Return ( .T. )



Static Function lRecargaArray( aGet, aTmp )













Return ( .T. )



Static Function EdtDoc( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de pedidos de clientes", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116,       {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



Static Function EdtFacturae( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode )

   local oDlg
   local oBrwFacturae

   if nMode == 2 .OR. nMode == 3
      aEntidades  := hb_deserialize( aTmp[ ( dbfTmpFacturae )->( FieldPos( "mMemo" ) ) ] )
   endif

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "organismos de emisión", "CLIENTES_FACTURAE_ENTIDAD",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpFacturae )->( FieldPos( "cDesFac" ) ) ], aTmp[ ( dbfTmpFacturae )->( FieldPos( "cDesFac" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TButton():ReDefine( 500, {||( EdtEntidades( 1, oBrwFacturae ) )}, oDlg,,, .F., {||     (  nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||(  EdtEntidades( 2, oBrwFacturae, aEntidades[ oBrwFacturae:nArrayAt ] ) )}, oDlg,,, .F., {||     (  nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( delEntidadesArray( oBrwFacturae:nArrayAt, oBrwFacturae ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )

      oBrwFacturae                        := IXBrowse():New( oDlg )

      oBrwFacturae:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwFacturae:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwFacturae:SetArray( aEntidades, , , .F. )

      oBrwFacturae:nMarqueeStyle          := 5

      oBrwFacturae:CreateFromResource( 250 )

      with object ( oBrwFacturae:AddCol() )
         :cHeader          := "Entidad"
         :bStrData         := {|| if( !empty( aEntidades ) .AND. isHash( aEntidades[ oBrwFacturae:nArrayAt ] ), hget( aEntidades[ oBrwFacturae:nArrayAt ], "CodigoEntidad" ), "" ) }
         :nWidth           := 250
      end

      with object ( oBrwFacturae:AddCol() )
         :cHeader          := "Rol"
         :bStrData         := {|| if( !empty( aEntidades ) .AND. isHash( aEntidades[ oBrwFacturae:nArrayAt ] ), hget( aEntidades[ oBrwFacturae:nArrayAt ], "RolEntidad" ), "" ) }
         :nWidth           := 130
      end





      TButton():ReDefine( 1, {||( if( validEdtFacturae( aTmp, nMode ), ( endEdtfacturae( aTmp, nMode, oBrwFacturae ), oDlg:end( 1 ) ), ) )}, oDlg,,, .F., {||     (  nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )


      if nMode <> 3
         oDlg:AddFastKey( 116, {|| if( validEdtFacturae( aTmp ), ( endEdtfacturae( aTmp, nMode, oBrwFacturae ), oDlg:end( 1 ) ), ) } )
      end

      if nMode <> 3
         oBrwFacturae:bLDblClick    := {|| EdtEntidades( 2, oBrwFacturae, aEntidades[ oBrwFacturae:nArrayAt ] ) }
      end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

    aEntidades    := {}

Return ( oDlg:nResult == 1 )



Static Function endEdtFacturae( aTmp, nMode, oBrwFacturae )

   aTmp[ ( dbfTmpFacturae )->( FieldPos( "mMemo" ) ) ] := hb_serialize( aEntidades )

   WinGather( aTmp, , dbfTmpFacturae, oBrwFacturae, nMode, , .F. )

return( .T. )



Static Function delEntidadesArray( nArray, oBrw )

   local cTxt  := "¿Desea eliminar el registro en curso?"

   if RolesModel():getRolNoConfirmacionEliminacion( Auth():rolUuid() ) .OR. apoloMsgNoYes( cTxt, "Confirme supersión")

      hb_ADel( aEntidades, nArray, .T. )

      oBrw:refresh()

   endif

Return ( .T. )



Static function validEdtFacturae( aTmp, nMode )

   if empty( aTmp[ ( dbfTmpFacturae )->( FieldPos( "cDesFac" ) ) ] )
      msgStop( "Descripción del organismo no puede estar vacio" )
      return .F.
   end


   if nMode == 1 .AND.  dbSeekInOrd( aTmp[ ( dbfTmpFacturae )->( FieldPos( "cDesFac" ) ) ], "cDesFac", D():ClientesEntidad( nView ) )

      msgStop( "Descripción ya existe." )
      return .F.

   endif

   if len( aEntidades ) < 1
      msgStop( "Los campos Entidad y Rol no pueden estar vacios" )
      return .F.
   end

Return .T.



Static Function EdtEntidades( nMode, oBrw, hash )

   local oDlg
   local oCodigo
   local oRol
   local cCodigo
   local cRol

   if nMode == 1
      hash        := { "CodigoEntidad"=>"", "RolEntidad"=>"" }
   endif

   if  nMode == 2

      if len( hash ) == 0
         return .F.
      else
         cCodigo  := hget( hash, "CodigoEntidad" )
         cRol     := hget( hash, "RolEntidad" )
      endif

   endif

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "entidades", "Facturas_Entidades",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






      oCodigo := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodigo, cCodigo:= u ) }, oDlg,, "@!",,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 101 )

      oCodigo:bHelp     := {|| oEntidades:Buscar( oCodigo ) }
      oCodigo:bValid    := {|| iif( !empty( oCodigo:varGet() ), oEntidades:Existe( oCodigo, oCodigo:oHelpText, "cDesEnt" ), .T. ) }




      oRol := TComboBox():ReDefine( 110, { | u | If( PCount()==0, cRol, cRol:= u ) }, aRolesValues(), oDlg,,,,,,, .F.,,,,,,, "oRol",,,,,,, )




      TButton():ReDefine( 1, {||(  if( lValidEntidad( cCodigo, oRol ), ( setcCodigoRol( cCodigo, oRol, hash, nMode ), oBrw:Refresh(), oDlg:end( 1 ) ), ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:AddFastKey( 116, {|| if( lValidEntidad( cCodigo, oRol ), ( setcCodigoRol( cCodigo, oRol, hash, nMode ), oBrw:Refresh(), oDlg:end( 1 ) ), ) } )

   oDlg:bStart    := {|| if( !empty( cCodigo ), oCodigo:lValid(), ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



function setcCodigoRol ( Codigo, Rol, hash, nMode )

   do case
      case nMode == 1

         hset( hash, "CodigoEntidad", Codigo )
         hset( hash, "RolEntidad", Rol:varGet() )

         aAdd( aEntidades, hash )

      case nMode == 2
         hset( hash, "CodigoEntidad", Codigo )
         hset( hash, "RolEntidad", Rol:varGet() )
   end

Return ( .T. )



Function lValidEntidad( Codigo, Rol )

   if empty( Codigo )
      msgInfo( "La entidad no puede estar vacia." )
      Return .F.
   endif

   if empty( Rol:varGet() )
      msgInfo( "El rol no puede estar vacio." )
      return .F.
   endif

Return ( .T. )



Function getOrganismosFacturae( cCodigoCliente, nView )

   local aOrganismos := {}

   if D():gotoIdClientesEntidad( cCodigoCliente, nView )
      while D():ClientesEntidadId( nView ) == cCodigoCliente .AND. !D():eofClientesEntidad( nView )

         aAdd( aOrganismos,   alltrim( ( D():ClientesEntidad( nView ) )->cDesFac ) + "," +  alltrim( ( D():ClientesEntidad( nView ) )->mMemo ) )
         ( D():ClientesEntidad( nView ) )->( dbSkip() )
      end
   end

Return ( aOrganismos )



Static Function ShowFld( aTmp, aGet )

   local n

   lRecargaArray( aGet, aTmp )





   oRTF:LoadAsRTF( aTmp[ 109 ] )





   EvalGet( aGet )

Return nil



STATIC FUNCTION EdtAtp( aTmp, aGet, dbfTmpAtp, oBrw, aTmpCli, aGetCli, nMode )

   local oDlg
   local oFld
   local oGetArticulo
   local cGetArticulo
   local oGetFamilia
   local cGetFamilia
   local oSayPr1
   local oSayPr2
   local oSayVp1
   local oSayVp2
   local cSayPr1
   local cSayPr2
   local cSayVp1
   local cSayVp2
   local oCosto
   local cCosto
   local oSobre
   local cSobre         := "Precio 1"
   local aSobre         := { "Precio 1", "Precio 2", "Precio 3", "Precio 4", "Precio 5", "Precio 6" }
   local cNaturaleza    := "Artículo"
   local aNaturaleza    := { "Artículo", "Familia" }
   local oBrwRen
   local cPouDiv        := cPouDiv( cDivEmp() )
   local cPouChg        := cPouDiv( cDivChg() )
   local oBtnRen
   local oSayLabels     := Array( 16 )
   local oBtnEscandallo
   local oSayTar

   if nMode == 1

      cCosto            := 0
      aTmp[ 10 ] := Ctod( "" )
      aTmp[ 11 ] := Ctod( "" )
      aTmp[ 31 ] := .T.
      aTmp[ 32 ] := .T.
      aTmp[ 33 ] := .T.
      aTmp[ 34 ] := .T.
      aTmp[ 35 ] := .T.
      aTmp[ 38 ] := 2
      aTmp[ 36 ] := 1
      aTmp[ 37 ] := 1



      if !empty(aTmpCli)

         aTmp[ 1 ]       := aTmpCli[ 1 ]

         if !empty( aTmpCli[ 38 ] ) .AND. ( cAgente )->( dbSeek( aTmpCli[ 38 ] ) )
            aTmp[ 29 ]    := ( cAgente )->nCom1
            if ( cAgente )->nCom1 <> 0
               aTmp[ 28 ] := .T.
            end
         end

      end

   else

      cNaturaleza       := Max( Min( aTmp[ 5 ], len( aNaturaleza ) ), 1 )

      cGetArticulo      := RetArticulo( aTmp[ 3 ] )

      if !Empty( aTmp[ 6 ] )
         cSayPr1        := retProp( aTmp[ 6 ], dbfPro )
         cSayVp1        := retValProp( aTmp[ 6 ] + aTmp[ 7 ], dbfProL )
      end

      if !Empty( aTmp[ 8 ] )
         cSayPr2        := retProp( aTmp[ 8 ], dbfPro )
         cSayVp2        := retValProp( aTmp[ 8 ] + aTmp[ 9 ], dbfProL )
      end

      cGetFamilia       := retFld( aTmp[ 4 ], dbfFamilia )

   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "tarifas de clientes", "CLIATP",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )








      oFld := TFolder():ReDefine( 100, {"&General"  , "A&mbito"}, { "CLIATP_0","CLIATP_1" }, oDlg,,,,, .F., )





      aGet[ 5 ] := TComboBox():ReDefine( 90, { | u | If( PCount()==0, cNaturaleza, cNaturaleza:= u ) }, aNaturaleza, oFld:aDialogs[1],,, {|Self|( ChangeNaturaleza( aGet, aTmp, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGetArticulo, oGetFamilia, oCosto, nMode, oSayLabels, , oBtnEscandallo, oSayTar ) )},,,, .F., {||     ( nMode == 1 )},,,,,, "aGet[ 5 ]",,,,,,, )








      aGet[ 3 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 3 ], aTmp[ 3 ]:= u ) }, oFld:aDialogs[1],,, {||    ( IsCliAtp( aGet, aTmp, oGetArticulo, ( D():Atipicas( nView ) ), nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oCosto, aTmpCli ) )},,,,,, .F., {||     ( nMode == 1 )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[ 3 ], oGetArticulo ) )}, nil, "LUPA",, )




      oGetArticulo := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cGetArticulo, cGetArticulo:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )







      aGet[ 4 ] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[ 4 ], aTmp[ 4 ]:= u ) }, oFld:aDialogs[1],,, {||    cFamilia( aGet[ 4 ], dbfFamilia, oGetFamilia )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|BrwFamilia( aGet[ 4 ], oGetFamilia )}, nil, "LUPA",, )




      oGetFamilia := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, cGetFamilia, cGetFamilia:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      oBtnEscandallo    := TBtnBmp():ReDefine( 141, "BMPKIT",,,,,{|| if( aTmp[ 5 ] <= 1, infoEscandallo( aTmp[ 3 ], aTmpCli[ 1 ] ), ) }, oFld:aDialogs[1], .F., , .F.,  )



      oSayPr1 := TSay():ReDefine( 888, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F., )









      aGet[ 7 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 7 ], oSayVp1, aTmp[ 6 ], dbfProL ), IsCliAtp( aGet, aTmp, oGetArticulo, ( D():Atipicas( nView ) ), nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oCosto, aTmpCli ), .F. ) )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 7 ], oSayVp1, aTmp[ 6 ] ) )}, nil, "LUPA",, )




      oSayVp1 := TGetHlp():ReDefine( 251, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      oSayPr2 := TSay():ReDefine( 999, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F., )









      aGet[ 9 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 9 ], oSayVp2, aTmp[ 8 ], dbfProL ), IsCliAtp( aGet, aTmp, oGetArticulo, ( D():Atipicas( nView ) ), nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oCosto, aTmpCli ), .F. ) )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 9 ], oSayVp2, aTmp[ 8 ] ) )}, nil, "LUPA",, )




      oSayVp2 := TGetHlp():ReDefine( 261, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ 13 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],, cPinDiv, {||    ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 12 ] := TCheckBox():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oFld:aDialogs[ 1 ],, {||( lChangeCostoParticular( aGet, aTmp, oCosto, nMode, aTmpCli ) )},,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 )}, .F. )

      aGet[ 52 ]  := comboTarifa():Build( { "idCombo" => 610, "uValue" => aTmp[ 52 ] } )
      aGet[ 52 ]:Resource( oFld:aDialogs[ 1 ] )



      oSayTar := TSay():ReDefine( 611,, oFld:aDialogs[1],,,, .F.,, .F., .F., )






      oCosto := TGetHlp():ReDefine( 123, { | u | If( PCount()==0, cCosto, cCosto:= u ) }, oFld:aDialogs[ 1 ],, cPinDiv,,,,,,, .F., {||     ( .F. )},, .F., .T.,,,,,, nil,,, )








      aGet[ 14 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalIva( aTmp[ 14 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 20 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. !( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 15 ] := TGetHlp():ReDefine( 124, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalIva( aTmp[ 15 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 21 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. !( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 16 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalIva( aTmp[ 16 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 22 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. !( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 17 ] := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalIva( aTmp[ 17 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 23 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. !( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 18 ] := TGetHlp():ReDefine( 127, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalIva( aTmp[ 18 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 24 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. !( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 19 ] := TGetHlp():ReDefine( 128, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalIva( aTmp[ 19 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 25 ] ),lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. !( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )












      aGet[ 20 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalBas( aTmp[ 20 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 14 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. ( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 21 ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 21 ], aTmp[ 21 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalBas( aTmp[ 21 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 15 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. ( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 22 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalBas( aTmp[ 22 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 16 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. ( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 23 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalBas( aTmp[ 23 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 17 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. ( D():Articulos(  nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 24 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalBas( aTmp[ 24 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 18 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. ( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 25 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 25 ], aTmp[ 25 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( CalBas( aTmp[ 25 ], ( D():Articulos( nView ) )->lIvaInc, ( D():Articulos( nView ) )->TipoIva, ( D():Articulos( nView ) )->cCodImp, aGet[ 19 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 .AND. ( D():Articulos( nView ) )->lIvaInc )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 26 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[26] >= 0 .AND. aTmp[26] <= 100 ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ))},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 30 ] := TGetHlp():ReDefine( 135, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[27] := TGetHlp():ReDefine( 601, { | u | If( PCount()==0, aTmp[27], aTmp[27]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[27] >= 0 .AND. aTmp[27] <= 100 ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )





      TCheckBox():ReDefine( 151, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[1],, {||( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,, .F., {||     ( nMode <> 3 )}, .F. )








      aGet[ 29 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[29] >= 0 .AND. aTmp[29] <= 100 ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TGroup():ReDefine( 701,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 3 ] := TGroup():ReDefine( 702,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 4 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 5 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 6 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 7 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 8 ] := TSay():ReDefine( 707,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 9 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 10] := TSay():ReDefine( 709,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 11] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 12] := TSay():ReDefine( 711,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 13] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 14] := TSay():ReDefine( 713,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 15] := TSay():ReDefine( 714,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 16] := TGroup():ReDefine( 715,, oFld:aDialogs[ 1 ],,,, .T. )







      aGet[ 39 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[ 39 ] >= 0 .AND. aTmp[ 39 ] <= 100 ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 40 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[ 40 ] >= 0 .AND. aTmp[ 40 ] <= 100 ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 41 ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[ 41 ] >= 0 .AND. aTmp[ 41 ] <= 100 ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 42 ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[ 42 ] >= 0 .AND. aTmp[ 42 ] <= 100 ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 43 ] := TGetHlp():ReDefine( 440, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[ 43 ] >= 0 .AND. aTmp[ 43 ] <= 100 ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 44 ] := TGetHlp():ReDefine( 450, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( ( aTmp[ 44 ] >= 0 .AND. aTmp[ 44 ] <= 100 ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 46 ] := TGetHlp():ReDefine( 460, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 461 )

         aGet[ 46 ]:bValid := {|| oEnvases:Existe( aGet[ 46 ], aGet[ 46 ]:oHelpText ) }
         aGet[ 46 ]:bHelp  := {|| oEnvases:Buscar( aGet[ 46 ] ) }









      aGet[ 10 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      aGet[ 11 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 47 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 50 ] := TGetHlp():ReDefine( 261, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      aGet[ 51 ] := TGetHlp():ReDefine( 262, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],, "@R 99:99:99",,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TCheckBox():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )









      aGet[ 38 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[2],, { 220, 221 }, {||( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 )}, )








      aGet[ 36 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[2],, "@E 999", {||    ( isBig( aTmp[ 36 ], aTmp[ 37 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 37 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 37 ], aTmp[ 37 ]:= u ) }, oFld:aDialogs[2],, "@E 999", {||    ( isBig( aTmp[ 36 ], aTmp[ 37 ] ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )},,,,,, .F., {||     ( aTmp[ 5 ] <= 1 .AND.  nMode <> 3 )}, {|nKey,nFlags,Self| ( lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) ) }, .F., .T.,,,,,, nil,,, )










      oSobre := TComboBox():ReDefine( 400, { | u | If( PCount()==0, cSobre, cSobre:= u ) }, aSobre, oDlg,,,, "N/W*",,, .F., {||     ( nMode <> 3 )},,,,,, "oSobre",,,,,,, )

      oSobre:bChange := {|| lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) }
























      oBrwRen := TWBrowse():ReDefine( 450, {|| { if( aRentabilidad[ oBrwRen:nAt, 5 ], LoadBitmap( GetResources(), "gc_sign_warning_16" ), "" ) , aRentabilidad[ oBrwRen:nAt, 1 ], aRentabilidad[ oBrwRen:nAt, 2 ], if( !aRentabilidad[ oBrwRen:nAt, 4 ], Trans( aRentabilidad[ oBrwRen:nAt, 3 ], cPouDiv ), Trans( aRentabilidad[ oBrwRen:nAt, 3 ], "999.99" ) + " %" ), if( !aRentabilidad[ oBrwRen:nAt, 4 ], Trans( nCnv2Div( aRentabilidad[ oBrwRen:nAt, 3 ], cDivEmp(), cDivChg() ), cPouChg ), "" ), "" } }, oDlg, {"", "Naturaleza", "Tipo", "Importe " + cDivEmp(), "Importe " + cDivChg(), ""}, {16, 97, 48, 70, 70, 10},,,,,,,,,,,, .F.,,,,, )

         oBrwRen:SetArray( aRentabilidad )
         oBrwRen:nClrText       := { || if( aRentabilidad[ oBrwRen:nAt, 3 ] < 0 , 255, 0 ) }
         oBrwRen:aJustify       := { .F., .F., .T., .T., .T., .F. }









      oBtnRen := TButton():ReDefine( 600, {||( lExpandir( oDlg, oBtnRen ), lArrayRen( oSobre:nAt, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 1, {||( SaveEdtAtp( aGet, aTmp, dbfTmpAtp, oBrw, oDlg, nMode ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| SaveEdtAtp( aGet, aTmp, dbfTmpAtp, oBrw, oDlg, nMode ) } )
      end

      oDlg:bStart := {|| StartEdtAtp( aTmp, aGet, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGetArticulo, oGetFamilia, oSayLabels, oCosto, oBtnRen, aTmpCli, oBtnEscandallo, oSayTar ) }


   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( initEdtAtp( aTmp, aGet, nMode, oBtnRen, oDlg, aTmpCli ) )}, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )



Static Function initEdtAtp( aTmp, aGet, nMode, oBtnRen, oDlg, aTmpCli )

   lExpandir( oDlg, oBtnRen, .F. )

   if nMode <> 1
      aGet[ 3 ]:lValid()
   end

   if !empty( aTmpCli )
      edtDetMenu( aGet[ 3 ], oDlg, lArticuloEnOferta( aTmp[ 3 ], aTmpCli[ 1 ], aTmpCli[ 48 ] ) )
   end

Return nil



Static Function StartEdtAtp( aTmp, aGet, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGetArticulo, oGetFamilia, oSayLabels, oCosto, oBtnRen, aTmpCli, oBtnEscandallo, oSayTar )

   cValoresProp( aTmp, aGet, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2 )

   if ( RolesModel():getRolMostrarRentabilidad( Auth():rolUuid() ) )
      oBtnRen:Show()
   else
      oBtnRen:Hide()
   end

   if aGet[ 5 ]:nAt == 1
      aGet[ 3 ]:SetFocus()
   else
      aGet[ 4 ]:SetFocus()
   end

   ChangeNaturaleza( aGet, aTmp, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGetArticulo, oGetFamilia, oCosto, nMode, oSayLabels, .T., oBtnEscandallo, oSayTar )

   lChangeCostoParticular( aGet, aTmp, oCosto, nMode, aTmpCli )

   if !Empty( aGet[ 46 ] )
      aGet[ 46 ]:lValid()
   end

Return nil



static function infoEscandallo( cCodArt, cCodCli )

   local aEscandallos
   local oDlg
   local oBmp
   local oBrw
   local oSay

   if Empty( cCodArt )
      Return nil
   end

   if !ArticulosModel():getField( "lKitArt", "Codigo", cCodArt )
      Return nil
   end

   aEscandallos                     := LoadInfoEscandallo( cCodArt, cCodCli )

   oDlg = TDialog():New(,,,,, "ART_INFO_KIT",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmp := TBitmap():ReDefine( 600, "gc_pieces_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )



      oSay := TSay():ReDefine( 150, {|| "Informe escandallo: " + AllTrim( cCodArt ) + " - " + AllTrim( ArticulosModel():getField( "Nombre", "Codigo", cCodArt ) )}, oDlg,,,, .F.,, .F., .F., )

      oBrw                          := IXBrowse():New( oDlg )

      oBrw:bClrSel                  := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus             := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      oBrw:bClrStd                  := {|| { if( hGet( aEscandallos[ oBrw:nArrayAt ], "lGray" ), 8421504, 0 ), GetSysColor( 5 ) } }

      oBrw:SetArray( aEscandallos, , , .F. )

      oBrw:nMarqueeStyle            := 6
      oBrw:lRecordSelector          := .F.
      oBrw:lHScroll                 := .F.
      oBrw:lFooter                  := .T.
      oBrw:cName                    := "Informe.Escandallo"

      oBrw:CreateFromResource( 100 )

      with object ( oBrw:AddCol() )
         :cHeader                   := "Código"
         :bStrData                  := {|| if( len( aEscandallos ) <> 0, hGet( aEscandallos[ oBrw:nArrayAt ], "Codigo" ) , "" ) }
         :nWidth                    := 80
      end

      with object ( oBrw:AddCol() )
         :cHeader                   := "Nombre"
         :bStrData                  := {|| if( len( aEscandallos ) <> 0, getValueArticulo( hGet( aEscandallos[ oBrw:nArrayAt ], "Codigo" ), "Nombre" ) , "" ) }
         :nWidth                    := 190
      end

      with object ( oBrw:AddCol() )
         :cHeader                   := "Unidades"
         :bEditValue                := {|| if( len( aEscandallos ) <> 0, hGet( aEscandallos[ oBrw:nArrayAt ], "Unidades" ), "" ) }
         :nWidth                    := 100
         :cEditPicture              := "@E 999,999.999999"
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
         :nFootStrAlign             := 1
      end

      with object ( oBrw:AddCol() )
         :cHeader                   := "Costo"
         :bEditValue                := {|| if( len( aEscandallos ) <> 0, hGet( aEscandallos[ oBrw:nArrayAt ], "Costo" ), "" ) }
         :nWidth                    := 100
         :cEditPicture              := "@E 999,999.999999"
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
         :nFootStrAlign             := 1
      end

      with object ( oBrw:AddCol() )
         :cHeader                   := "Total"
         :bEditValue                := {|| if( len( aEscandallos ) <> 0, ( hGet( aEscandallos[ oBrw:nArrayAt ], "Unidades" ) * hGet( aEscandallos[ oBrw:nArrayAt ], "Costo" ) ), "" ) }
         :nWidth                    := 100
         :cEditPicture              := "@E 999,999.999999"
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
         :nFooterType               := 1
         :nFootStrAlign             := 1
      end





      TButton():ReDefine( 560, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:MakeTotals() )}, oDlg:bRClicked,,, )

   if !Empty( oBmp )
      oBmp:End()
   end

   aEscandallos               := {}

Return nil



Static Function LoadInfoEscandallo( cCodArt, cCodCli )

   local a
   local hKit
   local aEscandallos      := {}
   local lGray             := .F.

   hKit                    := EscandallosArticuloModel():getList( cCodArt )

   for each a in hKit


      lGray                := !( Empty( ArticulosModel():getField( "cExtFld", "Codigo", hGet( a, "CREFKIT" ) ) )  .OR.  ( Empty( AllTrim( getCustomExtraField( ArticulosModel():getField( "cExtFld", "Codigo", hGet( a, "CREFKIT" ) ), "Clientes", cCodCli ) ) ) .OR. AllTrim( getCustomExtraField( ArticulosModel():getField( "cExtFld", "Codigo", hGet( a, "CREFKIT" ) ), "Clientes", cCodCli ) ) == "si" ) )

      aAdd( aEscandallos, { "lGray" => lGray, "Codigo" => hGet( a, "CREFKIT" ), "Unidades" => if( lGray, 0, hGet( a, "NUNDKIT" ) ), "Costo" => if( lGray, 0, nCosto( hGet( a, "CREFKIT" ), D():Articulos( nView ), D():Kit( nView ), .F., , D():Divisas( nView ) ) ) } )

   next

Return aEscandallos



Static Function lExpandir( oDlg, oBtn, lSet )

   local oRect    := oDlg:GetRect()

   if lSet <> nil
      lExpandida  := lSet
   end

   if lExpandida
      SetWindowText( oBtn:hWnd, "Rentabilidad <" )
      oDlg:Move( oRect:nTop, oRect:nLeft, 800, 550, .T. )
   else
      SetWindowText( oBtn:hWnd, "Rentabilidad >" )
      oDlg:Move( oRect:nTop, oRect:nLeft, 463, 550, .T. )
   end

   lExpandida  := !lExpandida

return .T.



Static Function cValoresProp( aTmp, aGet, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2 )

   if nMode == 1

      oSayPr1:Hide()
      oSayPr2:Hide()
      oSayVp1:Hide()
      oSayVp2:Hide()
      aGet[ 7 ]:Hide()
      aGet[ 9 ]:Hide()

   else

      if aTmp[ 5 ] == 2

         oSayPr1:Hide()
         oSayVp1:Hide()
         aGet[ 7 ]:Hide()
         oSayPr2:Hide()
         oSayVp2:Hide()
         aGet[ 9 ]:Hide()

      else

         if Empty( aTmp[ 6 ] )
            oSayPr1:Hide()
            oSayVp1:Hide()
            aGet[ 7 ]:Hide()
         else
            oSayPr1:Show()
            oSayVp1:Show()
            aGet[ 7 ]:Show()
            oSayPr1:Disable()
         end

         if Empty( aTmp[ 8 ] )
            oSayPr2:Hide()
            oSayVp2:Hide()
            aGet[ 9 ]:Hide()
         else
            oSayPr2:Disable()
            oSayPr2:Show()
            oSayVp2:Show()
            aGet[ 9 ]:Show()
         end

      end

   end

Return nil






STATIC FUNCTION ChkAllSubCta()

   local oDlg
   local cArea
   local nRecno
   local cTag
   local oChkCreate
   local lChkCreate
   local oChkCuenta
   local lChkCuenta
   local aMsg
   local oTree
   local cCliOrg
   local cCliDes
   local oCliOrg
   local oCliDes
   local oSayCliOrg
   local oSayCliDes
   local cSayCliOrg
   local cSayCliDes
   local oImageList
   local cRuta
   local cCodEmp



   if lAplicacionContaplus()

      cRuta             := cRutCnt()
      cCodEmp           := cEmpCnt( "A" )

      if Empty( cRuta ) .OR. Empty( cCodEmp )
         msgStop( "No existe enlace a contaplus Â®" )
         return .F.
      end

      if !OpenSubCuenta( cRuta, cCodEmp, @cArea, .F. )
         msgStop( "Imposible acceder a ficheros de contaplus Â®" )
         return .T.
      end

   end





   nRecno            := ( D():Clientes( nView ) )->( RecNo() )
   cTag              := ( D():Clientes( nView ) )->( OrdSetFocus( 1 ) )
   lChkCreate        := .F.
   lChkCuenta        := .F.
   aMsg              := {}

   cCliOrg           := dbFirst( ( D():Clientes( nView ) ), 1 )
   cCliDes           := dbLast(  ( D():Clientes( nView ) ), 1 )
   cSayCliOrg        := dbFirst( ( D():Clientes( nView ) ), 2 )
   cSayCliDes        := dbLast(  ( D():Clientes( nView ) ), 2 )

   oImageList        := TImageList():New( 16, 16 )
   oImageList:AddMasked( TBitmap():Define( "bRed" ),     ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   oImageList:AddMasked( TBitmap():Define( "bGreen" ),   ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )





   oDlg = TDialog():New(,,,,, "ChkAllSubCta",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )










   oCliOrg := TGetHlp():ReDefine( 80, { | u | If( PCount()==0, cCliOrg, cCliOrg:= u ) }, oDlg,,, {||    cClient( oCliOrg, ( D():Clientes( nView ) ), oSayCliOrg )},,,,,, .F.,,, .F., .F.,,,,, {|Self|BrwCli( oCliOrg, oSayCliOrg, ( D():Clientes( nView ) ) )}, nil, "LUPA",, )




   oSayCliOrg := TGetHlp():ReDefine( 81, { | u | If( PCount()==0, cSayCliOrg, cSayCliOrg:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






   oCliDes := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cCliDes, cCliDes:= u ) }, oDlg,,, {||    cClient( oCliDes, ( D():Clientes( nView ) ), oSayCliDes )},,,,,, .F.,,, .F., .F.,,,,, {|Self|BrwCli( oCliDes, oSayCliDes, ( D():Clientes( nView ) ) )}, nil, "LUPA",, )




   oSayCliDes := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayCliDes, cSayCliDes:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



   oChkCuenta := TCheckBox():ReDefine( 110, { | u | If( PCount()==0, lChkCuenta, lChkCuenta:= u ) }, oDlg,,,,,,, .F.,, .F. )




   oChkCreate := TCheckBox():ReDefine( 100, { | u | If( PCount()==0, lChkCreate, lChkCreate:= u ) }, oDlg,,,,,,, .F., {||     lAplicacionContaplus()}, .F. )

   oTree       := TTreeView():Redefine( 170, oDlg )




   TButton():ReDefine( 1, {||( MakAllSubCta( cCliOrg, cCliDes, lChkCuenta, lChkCreate, cArea, aMsg, oTree, oDlg ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oTree:SetImageList( oImageList ) )}, oDlg:bRClicked,,, )

   ( D():Clientes( nView ) )->( dbGoTo( nRecno ) )
   ( D():Clientes( nView ) )->( OrdSetFocus( cTag ) )

   if lAplicacionContaplus()
      ( cArea )->( dbCloseArea() )
   end

   oImageList:End()

   oTree:Destroy()

   oWndBrw:oBrw:SetFocus()
   oWndBrw:oBrw:Refresh()

return .T.



Static Function MakAllSubCta( cCliOrg, cCliDes, lChkCuenta, lChkCreate, cArea, aMsg, oTree, oDlg )

   local nLen
   local oItem

   oDlg:Disable()

   oTree:DeleteAll()

   nLen              := nLenCuentaContaplus()

   if ( D():Clientes( nView ) )->( dbSeek( cCliOrg ) )

      while ( D():Clientes( nView ) )->Cod <= cCliDes .AND. !( D():Clientes( nView ) )->( Eof() )

         if Empty( AllTrim( ( D():Clientes( nView ) )->SubCta ) ) .AND. lChkCuenta
            if dbLock( D():Clientes( nView ) )
               ( D():Clientes( nView ) )->SubCta      := "430" + strzero( val( alltrim( ( D():Clientes( nView ) )->Cod ) ), nLen )
               ( D():Clientes( nView ) )->( dbUnLock() )
            end
         end



         if lAplicacionContaplus()

            if !Empty( AllTrim( ( D():Clientes( nView ) )->SubCta ) )

               if !( cArea )->( dbSeek( ( D():Clientes( nView ) )->SubCta, .T. ) )



                  if lChkCreate .OR. ApoloMsgNoYes(   "Subcuenta : " + Rtrim( ( D():Clientes( nView ) )->SubCta ) + " no existe" + Chr(13)+Chr(10) +  "¿ Desea crearla ?", "Enlace con contaplus®" )

                     ( cArea )->( dbAppend() )
                     ( cArea )->Cod         := ( D():Clientes( nView ) )->Subcta
                     ( cArea )->Titulo      := ( D():Clientes( nView ) )->Titulo
                     ( cArea )->Nif         := ( D():Clientes( nView ) )->Nif
                     ( cArea )->Domicilio   := ( D():Clientes( nView ) )->Domicilio
                     ( cArea )->Poblacion   := ( D():Clientes( nView ) )->Poblacion
                     ( cArea )->Provincia   := ( D():Clientes( nView ) )->Provincia
                     ( cArea )->CodPostal   := ( D():Clientes( nView ) )->CodPostal
                     ( cArea )->( dbCommit() )

                     oItem := oTree:Add( "Cuenta " + Rtrim( ( D():Clientes( nView ) )->Subcta ) + " del cliente " + Rtrim( ( D():Clientes( nView ) )->Cod ) + ", " + Rtrim( ( D():Clientes( nView ) )->Titulo ) + " creada", 1 )

                  else

                     oItem := oTree:Add( "Cuenta " + Rtrim( ( D():Clientes( nView ) )->Subcta ) + " del cliente " + Rtrim( ( D():Clientes( nView ) )->Cod ) + ", " + Rtrim( ( D():Clientes( nView ) )->Titulo ) + " creación cancelada", 1 )

                  end

               else

                  oItem    := oTree:Add( "Cuenta " + Rtrim( ( D():Clientes( nView ) )->Subcta ) + " del cliente " + Rtrim( ( D():Clientes( nView ) )->Cod ) + ", " + Rtrim( ( D():Clientes( nView ) )->Titulo ) + " ya existe", 0 )

               end

            else

               oItem       := oTree:Add( "El Cliente : " + Rtrim( ( D():Clientes( nView ) )->Cod ) + ", " + Rtrim( ( D():Clientes( nView ) )->Titulo ) + " no tiene codificada cuenta en Contaplus", 0 )

            end

            oTree:Select( oItem )

         end

         SysRefresh()

         ( D():Clientes( nView ) )->( dbSkip() )

      end

   end

   MsgInfo( "Proceso finalizado" )

   oDlg:Enable()

Return nil







STATIC FUNCTION CnfCli()

   local oDlg
   local IniCli   := cPatEmp() + "Client.Ini"

   oDlg = TDialog():New(,,,, "Configurar clientes", "CNF_DEF_CLI",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )

      TComboBox():ReDefine( 210, { | u | If( PCount()==0, cIniCli, cIniCli:= u ) }, { "Todas", "Activas" }, oDlg,,,,,,, .T.,,,,,,,,,,,,,, )




      TButton():ReDefine( 1, {||( WrtIniCli( IniCli, ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| WrtIniCli( IniCli, ), oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN NIL



STATIC FUNCTION WrtIniCli( UrlIniCli )

   WritePProString( "filtro", "ft", cIniCli, UrlIniCli )

RETURN NIL



FUNCTION lSndCli( oWndBrw, lVal )

   local nRecAct
   local nRecOld           := ( D():Clientes( nView ) )->( Recno() )

   for each nRecAct in ( oWndBrw:oBrw:aSelected )
      ( D():Clientes( nView ) )->( dbGoTo( nRecAct ) )

      if dbDialogLock( D():Clientes( nView ) )

         if Empty( lVal )
            ( D():Clientes( nView ) )->lSndInt  := !( D():Clientes( nView ) )->lSndInt
         else
            ( D():Clientes( nView ) )->lSndInt  := lVal
         end

         ( D():Clientes( nView ) )->( dbUnlock() )

      end

   next

   ( D():Clientes( nView ) )->( dbGoTo( nRecOld ) )

   oWndBrw:Refresh()

   oWndBrw:oBrw:Select()

Return nil







FUNCTION RetGrpCli( cCodCli, dbfCli )

   local cGrpCli  := ""

   if dbSeekInOrd( cCodCli, "Cod", dbfCli )
      cGrpCli     := ( dbfCli )->cCodGrp
   end

RETURN ( cGrpCli )



function CalRiesgo()

return ( 0 )



function SetRiesgo()

return ( 0 )



static function AddFamilia( oBrwAtp, dbfTmpAtp, cCodCli )

   local oDlg
   local nPre        := aFill( Array( 6 ), 0 )
   local aPre        := aFill( Array( 6 ), .F. )
   local nDto        := aFill( Array( 6 ), 0 )
   local nDtoArt     := 0
   local nDtoDiv     := 0
   local nDprArt     := 0
   local nComAge     := 0
   local dFecIni     := Ctod( "" )
   local dFecFin     := Ctod( "" )
   local lAplPre     := .T.
   local lAplPed     := .T.
   local lAplAlb     := .T.
   local lAplFac     := .T.
   local lAplSat     := .T.
   local oFamIni
   local cFamIni     := dbFirst( dbfFamilia, 1 )
   local oFamIniTxt
   local cFamIniTxt  := ""
   local oFamFin
   local cFamFin     := dbLast( dbfFamilia, 1 )
   local oFamFinTxt
   local cFamFinTxt  := ""
   local oBtnOk

   oDlg = TDialog():New(,,,,, "AddFamilia",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






   oFamIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cFamIni, cFamIni:= u ) }, oDlg,,, {||    cFamilia( oFamIni, dbfFamilia, oFamIniTxt )},,,,,, .F.,,, .F., .F.,,,,, {|Self|BrwFamilia( oFamIni, oFamIniTxt )}, nil, "LUPA",, )




   oFamIniTxt := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cFamIniTxt, cFamIniTxt:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






   oFamFin := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, cFamFin, cFamFin:= u ) }, oDlg,,, {||    cFamilia( oFamFin, dbfFamilia, oFamFinTxt )},,,,,, .F.,,, .F., .F.,,,,, {|Self|BrwFamilia( oFamFin, oFamFinTxt )}, nil, "LUPA",, )




   oFamFinTxt := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cFamFinTxt, cFamFinTxt:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



   TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aPre[ 1 ], aPre[ 1 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 141, { | u | If( PCount()==0, aPre[ 2 ], aPre[ 2 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 142, { | u | If( PCount()==0, aPre[ 3 ], aPre[ 3 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 143, { | u | If( PCount()==0, aPre[ 4 ], aPre[ 4 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 144, { | u | If( PCount()==0, aPre[ 5 ], aPre[ 5 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 145, { | u | If( PCount()==0, aPre[ 6 ], aPre[ 6 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )






   TGetHlp():ReDefine( 250, { | u | If( PCount()==0, nPre[ 1 ], nPre[ 1 ]:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( !aPre[ 1 ] )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 251, { | u | If( PCount()==0, nPre[ 2 ], nPre[ 2 ]:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( !aPre[ 2 ] )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 252, { | u | If( PCount()==0, nPre[ 3 ], nPre[ 3 ]:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( !aPre[ 3 ] )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 253, { | u | If( PCount()==0, nPre[ 4 ], nPre[ 4 ]:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( !aPre[ 4 ] )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 254, { | u | If( PCount()==0, nPre[ 5 ], nPre[ 5 ]:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( !aPre[ 5 ] )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 255, { | u | If( PCount()==0, nPre[ 6 ], nPre[ 6 ]:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( !aPre[ 6 ] )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 400, { | u | If( PCount()==0, nDto[ 1 ], nDto[ 1 ]:= u ) }, oDlg,, "@E 999.99", {||    nDto[ 1 ] >= 0 .AND. nDto[ 1 ] <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 410, { | u | If( PCount()==0, nDto[ 2 ], nDto[ 2 ]:= u ) }, oDlg,, "@E 999.99", {||    nDto[ 2 ] >= 0 .AND. nDto[ 2 ] <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 420, { | u | If( PCount()==0, nDto[ 3 ], nDto[ 3 ]:= u ) }, oDlg,, "@E 999.99", {||    nDto[ 3 ] >= 0 .AND. nDto[ 3 ] <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 430, { | u | If( PCount()==0, nDto[ 4 ], nDto[ 4 ]:= u ) }, oDlg,, "@E 999.99", {||    nDto[ 4 ] >= 0 .AND. nDto[ 4 ] <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 440, { | u | If( PCount()==0, nDto[ 5 ], nDto[ 5 ]:= u ) }, oDlg,, "@E 999.99", {||    nDto[ 5 ] >= 0 .AND. nDto[ 5 ] <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 450, { | u | If( PCount()==0, nDto[ 6 ], nDto[ 6 ]:= u ) }, oDlg,, "@E 999.99", {||    nDto[ 6 ] >= 0 .AND. nDto[ 6 ] <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, nDtoArt, nDtoArt:= u ) }, oDlg,, "@E 999.99", {||    nDtoArt >= 0 .AND. nDtoArt <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 160, { | u | If( PCount()==0, nDtoDiv, nDtoDiv:= u ) }, oDlg,, cPouDiv,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, nDprArt, nDprArt:= u ) }, oDlg,, "@E 999.99", {||    nDprArt >= 0 .AND. nDprArt <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nComAge, nComAge:= u ) }, oDlg,, "@E 999.99", {||    nComAge >= 0 .AND. nComAge <= 100},,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   TGetHlp():ReDefine( 190, { | u | If( PCount()==0, dFecIni, dFecIni:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   TGetHlp():ReDefine( 200, { | u | If( PCount()==0, dFecFin, dFecFin:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )



   TCheckBox():ReDefine( 210, { | u | If( PCount()==0, lAplPre, lAplPre:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 220, { | u | If( PCount()==0, lAplPed, lAplPed:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 230, { | u | If( PCount()==0, lAplAlb, lAplAlb:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 240, { | u | If( PCount()==0, lAplFac, lAplFac:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 260, { | u | If( PCount()==0, lAplSat, lAplSat:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oBtnOk := TButton():ReDefine( 1, {||(  AddArtFam( cCodCli, cFamIni, cFamFin, aPre, nPre, nDto, nDtoArt, nDtoDiv, nDprArt, nComAge, dFecIni, dFecFin, lAplPre, lAplPed, lAplAlb, lAplFac, lAplSat, oDlg ), oBrwAtp:Refresh() )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| oBtnOk:Click() } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oFamIni:lValid(), oFamFin:lValid() )}, oDlg:bRClicked,,, )

return nil



STATIC FUNCTION AddArtFam( cCodCli, cFamIni, cFamFin, aPre, nPre, nDto, nDtoArt, nDtoDiv, nDprArt, nComAge, dFecIni, dFecFin, lAplPre, lAplPed, lAplAlb, lAplFac, lAplSat, oDlg )

   local nIvaPct  := 0
   local nOrdArt  := ( D():Articulos( nView ) )->( OrdSetFocus( "cFamCod" ) )
   local nRecAtp  := ( dbfTmpAtp )->( RecNo() )
   local nOrdAnt  := ( dbfTmpAtp )->( OrdSetFocus( "cCliArt" ) )

   oDlg:Disable()

   if ( dbfFamilia )->( dbSeek( cFamIni ) )

      while ( dbfFamilia )->cCodFam <= cFamFin .AND. !( dbfFamilia )->( eof() )

         if ( D():Articulos( nView ) )->( dbSeek( ( dbfFamilia )->cCodFam ) )

            while ( D():Articulos( nView ) )->Familia == ( dbfFamilia )->cCodFam .AND. !( D():Articulos( nView ) )->( eof() )





               if !( dbfTmpAtp )->( dbSeek( ( D():Articulos( nView ) )->Codigo ) )

                  nIvaPct                    := nIva( D():TiposIva( nView ), ( D():Articulos( nView ) )->TipoIva )

                  ( dbfTmpAtp )->( dbAppend() )

                  ( dbfTmpAtp )->cCodCli     := cCodCli
                  ( dbfTmpAtp )->cCodArt     := ( D():Articulos( nView ) )->Codigo

                  if aPre[ 1 ]
                     ( dbfTmpAtp )->nPrcArt  := ( D():Articulos( nView ) )->pVenta1
                  else
                     ( dbfTmpAtp )->nPrcArt  := nPre[ 1 ]
                  end

                  if aPre[ 2 ]
                     ( dbfTmpAtp )->nPrcArt2 := ( D():Articulos( nView ) )->pVenta2
                  else
                     ( dbfTmpAtp )->nPrcArt2 := nPre[ 2 ]
                  end

                  if aPre[ 3 ]
                     ( dbfTmpAtp )->nPrcArt3 := ( D():Articulos( nView ) )->pVenta3
                  else
                     ( dbfTmpAtp )->nPrcArt3 := nPre[ 3 ]
                  end

                  if aPre[ 4 ]
                     ( dbfTmpAtp )->nPrcArt4 := ( D():Articulos( nView ) )->pVenta4
                  else
                     ( dbfTmpAtp )->nPrcArt4 := nPre[ 4 ]
                  end

                  if aPre[ 5 ]
                     ( dbfTmpAtp )->nPrcArt5 := ( D():Articulos( nView ) )->pVenta5
                  else
                     ( dbfTmpAtp )->nPrcArt5 := nPre[ 5 ]
                  end

                  if aPre[ 6 ]
                     ( dbfTmpAtp )->nPrcArt6 := ( D():Articulos( nView ) )->pVenta6
                  else
                     ( dbfTmpAtp )->nPrcArt6 := nPre[ 6 ]
                  end

                  ( dbfTmpAtp )->nPreIva1    := ( dbfTmpAtp )->nPrcArt  + ( ( dbfTmpAtp )->nPrcArt  * nIvaPct / 100 )
                  ( dbfTmpAtp )->nPreIva2    := ( dbfTmpAtp )->nPrcArt2 + ( ( dbfTmpAtp )->nPrcArt2 * nIvaPct / 100 )
                  ( dbfTmpAtp )->nPreIva3    := ( dbfTmpAtp )->nPrcArt3 + ( ( dbfTmpAtp )->nPrcArt3 * nIvaPct / 100 )
                  ( dbfTmpAtp )->nPreIva4    := ( dbfTmpAtp )->nPrcArt4 + ( ( dbfTmpAtp )->nPrcArt4 * nIvaPct / 100 )
                  ( dbfTmpAtp )->nPreIva5    := ( dbfTmpAtp )->nPrcArt5 + ( ( dbfTmpAtp )->nPrcArt5 * nIvaPct / 100 )
                  ( dbfTmpAtp )->nPreIva6    := ( dbfTmpAtp )->nPrcArt6 + ( ( dbfTmpAtp )->nPrcArt6 * nIvaPct / 100 )

                  ( dbfTmpAtp )->nDtoArt     := nDtoArt
                  ( dbfTmpAtp )->nDtoDiv     := nDtoDiv
                  ( dbfTmpAtp )->nComAge     := nComAge
                  ( dbfTmpAtp )->dFecIni     := dFecIni
                  ( dbfTmpAtp )->dFecFin     := dFecFin
                  ( dbfTmpAtp )->lAplPre     := lAplPre
                  ( dbfTmpAtp )->lAplPed     := lAplPed
                  ( dbfTmpAtp )->lAplAlb     := lAplAlb
                  ( dbfTmpAtp )->lAplFac     := lAplFac
                  ( dbfTmpAtp )->lAplSat     := lAplSat

                  ( dbfTmpAtp )->nDto1       := nDto[ 1 ]
                  ( dbfTmpAtp )->nDto2       := nDto[ 2 ]
                  ( dbfTmpAtp )->nDto3       := nDto[ 3 ]
                  ( dbfTmpAtp )->nDto4       := nDto[ 4 ]
                  ( dbfTmpAtp )->nDto5       := nDto[ 5 ]
                  ( dbfTmpAtp )->nDto6       := nDto[ 6 ]

               end

               ( D():Articulos( nView ) )->( dbSkip() )

            end

         end

         ( dbfFamilia )->( dbSkip() )

      end

   end

   oDlg:Enable()
   oDlg:End()

   ( D():Articulos( nView ) )->( OrdSetFocus( nOrdArt ) )
   ( dbfTmpAtp   )->( OrdSetFocus( nOrdAnt ) )
   ( dbfTmpAtp   )->( dbGoTo( nRecAtp ) )

return nil



STATIC FUNCTION ChgPrc( oWndBrw )

   local oDlg
   local cFam              := Space( 5 )
   local oFam
   local cTxtFam           := "Todas"
   local oTxtFam
   local cTipIva           := Space( 1 )
   local oTipIva
   local cTxtIva           := "Todos"
   local oTxtIva
   local lTarifa1          := .F.
   local lTarifa2          := .F.
   local lTarifa3          := .F.
   local lTarifa4          := .F.
   local lTarifa5          := .F.
   local lTarifa6          := .F.
   local cCliOrg
   local cCliDes
   local oCliOrg
   local oCliDes
   local oSayCliOrg
   local oSayCliDes
   local cSayCliOrg
   local cSayCliDes
   local oRad
   local nRad              := 1
   local nPctInc           := 0
   local nUndInc           := 0
   local aComBox           :=  { "Precio actual", "Precio 1", "Precio 2", "Precio 3", "Precio 4", "Precio 5", "Precio 6" }
   local oComBox
   local cComBox           := "Precio actual"
   local oMtr
   local nMtr              := 0
   local lRnd              := .F.
   local lGenerateTarifa   := .F.
   local lAppTarifaFecha   := .F.
   local nDec              := nRouDiv( cDivEmp() )
   local cArtOrg
   local cArtDes
   local oArtOrg
   local oArtDes
   local oSayArtOrg
   local oSayArtDes
   local cSayArtOrg
   local cSayArtDes
   local dIniPrc           := Date()
   local dFinPrc           := Ctod( "31/12/" + Str( Year( Date() ), 4 ) )
   local aStaCli           := aGetStatus( D():Clientes( nView ), .T. )



   cCliOrg                 := dbFirst( D():Clientes( nView ), 1 )
   cCliDes                 := dbLast ( D():Clientes( nView ), 1 )
   cSayCliOrg              := dbFirst( D():Clientes( nView ), 2 )
   cSayCliDes              := dbLast ( D():Clientes( nView ), 2 )

   cArtOrg                 := dbFirst( D():Articulos( nView ), 1 )
   cArtDes                 := dbLast ( D():Articulos( nView ), 1 )
   cSayArtOrg              := dbFirst( D():Articulos( nView ), 2 )
   cSayArtDes              := dbLast ( D():Articulos( nView ), 2 )



   oDlg = TDialog():New(,,,,, "CHGPRECLI",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )










   oCliOrg := TGetHlp():ReDefine( 80, { | u | If( PCount()==0, cCliOrg, cCliOrg:= u ) }, oDlg,,, {||    cClient( oCliOrg, ( D():Clientes( nView ) ), oSayCliOrg )},,,,,, .F.,,, .F., .F.,,,,, {|Self|BrwCli( oCliOrg, oSayCliOrg, D():Clientes( nView ) )}, nil, "LUPA",, )




   oSayCliOrg := TGetHlp():ReDefine( 81, { | u | If( PCount()==0, cSayCliOrg, cSayCliOrg:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






   oCliDes := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cCliDes, cCliDes:= u ) }, oDlg,,, {||    cClient( oCliDes, D():Clientes( nView ), oSayCliDes )},,,,,, .F.,,, .F., .F.,,,,, {|Self|BrwCli( oCliDes, oSayCliDes, D():Clientes( nView ) )}, nil, "LUPA",, )




   oSayCliDes := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayCliDes, cSayCliDes:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










   oArtOrg := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cArtOrg, cArtOrg:= u ) }, oDlg,,, {||    cArticulo( oArtOrg, D():Articulos( nView ), oSayArtOrg )},,,,,, .F.,,, .F., .F.,,,,, {|Self|BrwArticulo( oArtOrg, oSayArtOrg )}, nil, "LUPA",, )




   oSayArtOrg := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, cSayArtOrg, cSayArtOrg:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






   oArtDes := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, cArtDes, cArtDes:= u ) }, oDlg,,, {||    cArticulo( oArtDes, D():Articulos( nView ), oSayArtDes )},,,,,, .F.,,, .F., .F.,,,,, {|Self|BrwArticulo( oArtDes, oSayArtDes )}, nil, "LUPA",, )




   oSayArtDes := TGetHlp():ReDefine( 211, { | u | If( PCount()==0, cSayArtDes, cSayArtDes:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











   oFam := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cFam, cFam:= u ) }, oDlg,,, {||    ( cFamilia( oFam, , oTxtFam ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwFamilia( oFam, oTxtFam ) )}, nil, "LUPA",, )





   oTxtFam := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cTxtFam, cTxtFam:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )












   oTipIva := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, cTipIva, cTipIva:= u ) }, oDlg,, "@!", {||    ( cTiva( oTipIva, D():TiposIva( nView ), oTxtIva ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwIva( oTipIva, nil, oTxtIva ) )}, nil, "LUPA",, )





   oTxtIva := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cTxtIva, cTxtIva:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







   TCheckBox():ReDefine( 300, { | u | If( PCount()==0, lGenerateTarifa, lGenerateTarifa:= u ) }, oDlg,,,,,,, .F.,, .F. )





   TGetHlp():ReDefine( 230, { | u | If( PCount()==0, dIniPrc, dIniPrc:= u ) }, oDlg,,,,,,,,, .F., {||     lGenerateTarifa},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 240, { | u | If( PCount()==0, dFinPrc, dFinPrc:= u ) }, oDlg,,,,,,,,, .F., {||     lGenerateTarifa},, .F., .T.,,,,,, nil,,, )



   TCheckBox():ReDefine( 310, { | u | If( PCount()==0, lAppTarifaFecha, lAppTarifaFecha:= u ) }, oDlg,,,,,,, .F.,, .F. )







   TCheckBox():ReDefine( 161, { | u | If( PCount()==0, lTarifa1, lTarifa1:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 162, { | u | If( PCount()==0, lTarifa2, lTarifa2:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 163, { | u | If( PCount()==0, lTarifa3, lTarifa3:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 164, { | u | If( PCount()==0, lTarifa4, lTarifa4:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 165, { | u | If( PCount()==0, lTarifa5, lTarifa5:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 166, { | u | If( PCount()==0, lTarifa6, lTarifa6:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oComBox := TComboBox():ReDefine( 218, { | u | If( PCount()==0, cComBox, cComBox:= u ) }, aComBox, oDlg,,,,,,, .F.,,,,,,, "oComBox",,,,,,, )







   oRad := TRadMenu():Redefine( { | u | If( PCount()==0, nRad, nRad:= u ) }, oDlg,, { 170, 172 },,,,, .F.,, )










   TGetHlp():ReDefine( 171, { | u | If( PCount()==0, nPctInc, nPctInc:= u ) }, oDlg,, "@E 999.99",,,,,,, .F., {||     ( nRad == 1 )},, .F., .T.,,,,,, nil,,, )









   TGetHlp():ReDefine( 173, { | u | If( PCount()==0, nUndInc, nUndInc:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )







   TCheckBox():ReDefine( 180, { | u | If( PCount()==0, lRnd, lRnd:= u ) }, oDlg,,,,,,, .F.,, .F. )





   TGetHlp():ReDefine( 190, { | u | If( PCount()==0, nDec, nDec:= u ) }, oDlg,, "@E 9",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






    oMtr := TApoloMeter():ReDefine( 220, { | u | If( PCount()==0, nMtr, nMtr:= u ) }, ( D():Atipicas( nView ) )->( lastrec() ), oDlg, .F.,, "Procesando", .F.,,,, )




   TButton():ReDefine( 1, {||( mkChgPrc( cFam, cTipIva, cCliOrg, cCliDes, lTarifa1, lTarifa2, lTarifa3, lTarifa4, lTarifa5, lTarifa6, nRad, nPctInc, nUndInc, lRnd, nDec, oComBox, oMtr, oDlg, oWndBrw, cArtOrg, cArtDes, lGenerateTarifa, dIniPrc, dFinPrc, lAppTarifaFecha ) )}, oDlg,,, .F.,,,, .F. )




   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| mkChgPrc( cFam, cTipIva, cCliOrg, cCliDes, lTarifa1, lTarifa2, lTarifa3, lTarifa4, lTarifa5, lTarifa6, nRad, nPctInc, nUndInc, lRnd, nDec, oComBox, oMtr, oDlg, oWndBrw, cArtOrg, cArtDes, lGenerateTarifa, dIniPrc, dFinPrc, lAppTarifaFecha ) } )

   oDlg:bStart := {|| oCliOrg:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   SetStatus( ( D():Clientes( nView ) ), aStaCli )

RETURN ( oDlg:nResult == 1 )



STATIC FUNCTION mkChgPrc( cFam, cIva, cCliOrg, cCliDes, lTarifa1, lTarifa2, lTarifa3, lTarifa4, lTarifa5, lTarifa6, nRad, nPctInc, nUndInc, lRnd, nDec, oComBox, oMtr, oDlg, oWndBrw, cArtOrg, cArtDes, lGenerateTarifa, dIniPre, dFinPre, lAppTarifaFecha )

   local nOrdAct
   local nRecAct
   local nPrecio        := oComBox:nAt
   local aTmpAtp        := {}
   local aTmpGenerate   := {}
   local x              := 0

   if ApoloMsgNoYes( "¿Desea actualizar los datos de las tarifas de clientes?", "ATENCION" )

      if !lTarifa1 .AND. !lTarifa2 .AND. !lTarifa3 .AND. !lTarifa4 .AND. !lTarifa5 .AND. !lTarifa6
         msgStop( "No ha elegido ninguna tarifa a cambiar." )
         Return .F.
      end

      if lGenerateTarifa

         if Empty( dIniPre )
            msgStop( "Al generar una nueva tarifa la fecha de inicio debe de estar rellena." )
            Return .F.
         end

         if Empty( dFinPre )
            msgStop( "Al generar una nueva tarifa la fecha de fin debe de estar rellena." )
            Return .F.
         end

         if dIniPre > dFinPre
            msgStop( "Fecha de inicio debe ser anterior a la fecha de finalización." )
            Return .F.
         end

      end

      oDlg:Disable()

      nRecAct           := ( D():Atipicas( nView ) )->( RecNo() )
      nOrdAct           := ( D():Atipicas( nView ) )->( OrdSetFocus( "cCodCli" ) )

      if ( D():Atipicas( nView ) )->( dbSeek( cCliOrg ) )

      while ( D():Atipicas( nView ) )->cCodCli <= cCliDes .AND. !( D():Atipicas( nView ) )->( eof() )




         if ( ( D():Atipicas( nView ) )->cCodArt >= cArtOrg .AND. ( D():Atipicas( nView ) )->cCodArt <= cArtDes )             .AND. ( empty( cFam ) .OR. RetFld( ( D():Atipicas( nView ) )->cCodArt, D():Articulos( nView ), "Familia" ) == cFam )   .AND. ( empty( cIva ) .OR. RetFld( ( D():Atipicas( nView ) )->cCodArt, D():Articulos( nView ), "TipoIva" ) == cIva )   .AND. ( !lAppTarifaFecha  .OR. ( D():Atipicas( nView ) )->dFecFin >= GetSysDate() )

            aTmpAtp  := dbScatter( D():Atipicas( nView ) )





            if lGenerateTarifa

               aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "dFecIni" ) ) ]   := dIniPre
               aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "dFecFin" ) ) ]   := dFinPre

               if Empty( ( D():Atipicas( nView ) )->dFecFin ) .OR. ( D():Atipicas( nView ) )->dFecFin >= dIniPre

                  if( D():Atipicas( nView ) )->( dbRLock() )
                     if Empty( ( D():Atipicas( nView ) )->dFecIni )
                        ( D():Atipicas( nView ) )->dFecIni                       := CtoD( "01/01/" + Str( Year( Date() ) ) )
                     end
                     ( D():Atipicas( nView ) )->dFecFin                          := dIniPre - 1
                     ( D():Atipicas( nView ) )->( dbUnLock() )
                  end

               end

            end





            if lTarifa1

               aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt" ) ) ]     := nVal2Change( nPrecio, ( D():Atipicas( nView ) )->nPrcArt )

               if nRad == 1
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt" ) ) ]  += nVal2Change( nPrecio, aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt" ) ) ] ) * nPctInc / 100
               else
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt" ) ) ]  += nUndInc
               end

               if lRnd
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt" ) ) ]  := Round( aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt" ) ) ], nDec )
               end

            end

            if lTarifa2

               aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt2" ) ) ]     := nVal2Change( nPrecio, ( D():Atipicas( nView ) )->nPrcArt2 )

               if nRad == 1
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt2" ) ) ]  += nVal2Change( nPrecio, aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt2" ) ) ] ) * nPctInc / 100
               else
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt2" ) ) ]  += nUndInc
               end

               if lRnd
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt2" ) ) ]  := Round( aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt2" ) ) ], nDec )
               end

            end

            if lTarifa3

               aTmpAtp[ ( D():Atipicas(  nView ) )->( Fieldpos( "nPrcArt3" ) ) ]     := nVal2Change( nPrecio, ( D():Atipicas(  nView ) )->nPrcArt3 )

               if nRad == 1
                  aTmpAtp[ ( D():Atipicas(  nView ) )->( Fieldpos( "nPrcArt3" ) ) ]  += nVal2Change( nPrecio, aTmpAtp[ ( D():Atipicas(  nView ) )->( Fieldpos( "nPrcArt3" ) ) ] ) * nPctInc / 100
               else
                  aTmpAtp[ ( D():Atipicas(  nView ) )->( Fieldpos( "nPrcArt3" ) ) ]  += nUndInc
               end

               if lRnd
                  aTmpAtp[ ( D():Atipicas(  nView ) )->( Fieldpos( "nPrcArt3" ) ) ]  := Round( aTmpAtp[ ( D():Atipicas(  nView ) )->( Fieldpos( "nPrcArt3" ) ) ], nDec )
               end

            end

            if lTarifa4

               aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt4" ) ) ]     := nVal2Change( nPrecio, ( D():Atipicas( nView ) )->nPrcArt4 )

               if nRad == 1
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt4" ) ) ]  += nVal2Change( nPrecio, aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt4" ) ) ] ) * nPctInc / 100
               else
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt4" ) ) ]  += nUndInc
               end

               if lRnd
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt4" ) ) ]  := Round( aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt4" ) ) ], nDec )
               end

            end

            if lTarifa5

               aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt5" ) ) ]     := nVal2Change( nPrecio, ( D():Atipicas( nView ) )->nPrcArt5 )

               if nRad == 1
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt5" ) ) ]  += nVal2Change( nPrecio, aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt5" ) ) ] ) * nPctInc / 100
               else
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt5" ) ) ]  += nUndInc
               end

               if lRnd
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt5" ) ) ]  := Round( aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt5" ) ) ], nDec )
               end

            end

            if lTarifa6

               aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt6" ) ) ]     := nVal2Change( nPrecio, ( D():Atipicas( nView ) )->nPrcArt6 )

               if nRad == 1
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt6" ) ) ]  += nVal2Change( nPrecio, aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt6" ) ) ] ) * nPctInc / 100
               else
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt6" ) ) ]  += nUndInc
               end

               if lRnd
                  aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt6" ) ) ]  := Round( aTmpAtp[ ( D():Atipicas( nView ) )->( Fieldpos( "nPrcArt6" ) ) ], nDec )
               end

            end

            if lGenerateTarifa
               aAdd( aTmpGenerate, aTmpAtp )
            else
               dbGather( aTmpAtp, D():Atipicas( nView ) )
            end

         end

         ( D():Atipicas( nView ) )->( dbSkip() )

         oMtr:Set( ( D():Atipicas( nView ) )->( OrdKeyNo() ) )

      end

      end

      if lGenerateTarifa

         for x := 1 to Len( aTmpGenerate )
            DBGather( aTmpGenerate[ x ], D():Atipicas( nView ), .T. )
         next

      end

      oMtr:Set( ( D():Atipicas( nView ) )->( LastRec() ) )

      ( D():Atipicas( nView ) )->( OrdSetFocus( nOrdAct ) )
      ( D():Atipicas( nView ) )->( dbGoto( nRecAct ) )

      oDlg:Enable()

   end

   oDlg:End()

   oWndBrw:Refresh()

RETURN NIL



Static Function nVal2Change( nPrecio, nImporte )

   local nVal2Change := 0

   do case
      case nPrecio == 1
         nVal2Change := nImporte
      case nPrecio == 2
         nVal2Change := ( D():Atipicas( nView ) )->nPrcArt
      case nPrecio == 3
         nVal2Change := ( D():Atipicas( nView ) )->nPrcArt2
      case nPrecio == 4
         nVal2Change := ( D():Atipicas( nView ) )->nPrcArt3
      case nPrecio == 5
         nVal2Change := ( D():Atipicas( nView ) )->nPrcArt4
      case nPrecio == 6
         nVal2Change := ( D():Atipicas( nView ) )->nPrcArt5
      case nPrecio == 7
         nVal2Change := ( D():Atipicas( nView ) )->nPrcArt6
   end

RETURN nVal2Change



FUNCTION AppCli( lOpenBrowse )

   local nLevel         := Auth():Level( "clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if Client()
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )

         WinAppRec( nil, bEdtRec, ( D():Clientes( nView ) ) )

         CloseFiles()

      end

   end

RETURN .T.



FUNCTION EdtCli( cCodCli, lOpenBrowse, nTabInicio )

   local nLevel         := Auth():Level( "clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;
   If( nTabInicio == nil, nTabInicio := 1, ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if Client()
         if dbSeekInOrd( cCodCli, "Cod", ( D():Clientes( nView ) ) )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra cliente" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cCodCli, "Cod", ( D():Clientes( nView ) ) )
            WinEdtRec( nil, bEdtRec, ( D():Clientes( nView ) ), nTabInicio )
         end

         CloseFiles()

      end

   end

RETURN .T.



Function InfCliente( cCodCli, oBrw, lSatCli )

   local nLevel      := Auth():Level( "clientes" )
   local cArticulo   := ""

   If( lSatCli == nil, lSatCli := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if !OpenFiles( .T. )
      CloseFiles()
      return nil
   end



   if ( D():Clientes( nView ) )->( dbSeek( cCodCli ) )
      cArticulo   := BrwVtaCli( cCodCli, ( D():Clientes( nView ) )->Titulo, lSatCli )
   else
      MsgStop( "No se encuentra cliente" )
   end



   if oBrw <> nil
      oBrw:Refresh()
   end

   CloseFiles()

RETURN ( iif( lSatCli, cArticulo, .T. ) )



STATIC FUNCTION EdtRotorMenu( aTmp, aGet, oDlg, oBrw, nMode )

   oMenu := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .T.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

      MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )






         MenuAddItem( "&1. Campos extra [F9]", "Mostramos y rellenamos los campos extra para el cliente", .F.,, {|oMenuItem|( oDetCamposExtra:Play( space(1) ) )},, "GC_FORM_PLUS2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




         MenuAddItem( "&11. Campos extra TEST", "Mostramos y rellenamos los campos extra para el cliente", .F.,, {|oMenuItem|( CamposExtraValoresController():New():oDialogView:Activate() )},, "GC_FORM_PLUS2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




         MenuAddItem( "&2. Informe del cliente", "Muestra el informe del Cliente", .F.,, {|oMenuItem|( BrwVtaCli( ( D():Clientes( nView ) )->Cod, ( D():Clientes( nView ) )->Titulo ) )},, "info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




         if !lExternal

            MenuAddItem(,,,,,,,,,,,,,,,,,.T.,,,,,,,,,,,,,,,,,)




            MenuAddItem( "&1. Añadir presupuesto de cliente", "Añade un presupuesto de cliente", .F.,, {|oMenuItem|( SavClient( aTmp, aGet, oDlg, oBrw, nMode ), PreCli( nil, nil, ( D():Clientes( nView ) )->Cod, nil ) )},, "gc_notebook_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&2. Añadir pedido de cliente", "Añade un pedido de cliente", .F.,, {|oMenuItem|( SavClient( aTmp, aGet, oDlg, oBrw, nMode ), PedCli( nil, nil, ( D():Clientes( nView ) )->Cod, nil ) )},, "gc_clipboard_empty_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&3. Añadir albarán de cliente", "Añade un albarán de cliente", .F.,, {|oMenuItem|( SavClient( aTmp, aGet, oDlg, oBrw, nMode ), AlbCli( nil, nil,  { "Cliente" => ( D():Clientes( nView ) )->Cod } ) )},, "gc_document_empty_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&4. Añadir factura de cliente", "Añade una factura de cliente", .F.,, {|oMenuItem|( SavClient( aTmp, aGet, oDlg, oBrw, nMode ), FactCli( nil, nil, { "Cliente" => ( D():Clientes( nView ) )->Cod } ) )},, "gc_document_text_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&5. Añadir tiket de cliente", "Añade un tiket de cliente", .F.,, {|oMenuItem|( SavClient( aTmp, aGet, oDlg, oBrw, nMode ), FrontTpv( nil, nil, ( D():Clientes( nView ) )->Cod, nil ) )},, "gc_cash_register_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         end

      MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

Return ( oMenu )



STATIC FUNCTION EndEdtRotorMenu()

Return ( oMenu:End() )






STATIC FUNCTION lChangeCostoParticular( aGet, aTmp, oCosto, nMode, aTmpCli )

   if aTmp[ 12 ]
      oCosto:Hide()
      aGet[ 13 ]:Show()
   else
      oCosto:Show()
      aGet[ 13 ]:Hide()
      if nMode <> 1
         oCosto:cText( nCosto( nil, D():Articulos( nView ), dbfArtKit,,,, aTmpCli[ 1 ] ) )
      end
   end

Return ( .T. )







Static Function EdtBnc( aTmp, aGet, dbfTmpBnc, oBrw, aTmpCli, bValid, nMode, cCodCli )

   local oDlg
   local oBmpDiv
   local oSayPai
   local cSayPai
   local lDis        := .F.
   local cOldCtaBnc  := aCuentaIBAN( aTmp, dbfTmpBnc )





   if nMode == 1
      ( dbfTmpBnc )->( dbGoTop() )
      if ( dbfTmpBnc )->( Eof() )
         aTmp[ ( dbfTmpBnc )->( FieldPos( "lBncDef" ) ) ]   := .T.
         lDis        := .T.
      end
   end

   if Empty( aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ] )
      aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ]    := "ES"
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "banco de cliente", "Banco",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







      aGet[ ( dbfTmpBnc )->( FieldPos( "cCodBnc" ) ) ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cCodBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCodBnc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( lCargaBanco( aGet, aTmp, nMode ) )}, nil, "LUPA",, )





      aGet[ ( dbfTmpBnc )->( FieldPos( "cDirBnc" ) ) ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cDirBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cDirBnc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpBnc )->( FieldPos( "cPobBnc" ) ) ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cPobBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cPobBnc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpBnc )->( FieldPos( "cCPBnc" ) ) ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cCPBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCPBnc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpBnc )->( FieldPos( "cProBnc" ) ) ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cProBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cProBnc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpBnc )->( FieldPos( "cTlfBnc" ) ) ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cTlfBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cTlfBnc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpBnc )->( FieldPos( "cFaxBnc" ) ) ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cFaxBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cFaxBnc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpBnc )->( FieldPos( "cPContBnc" ) ) ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cPContBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cPContBnc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )












      aGet[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ] := TGetHlp():ReDefine( 370, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ], aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ]:= u ) }, oDlg,, "@!", {||    ( lIbanDigit(  aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ], aGet[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )











      aGet[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ] := TGetHlp():ReDefine( 380, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ], aTmp[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ]:= u ) }, oDlg,,, {||    ( lIbanDigit(  aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ], aGet[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )












      aGet[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ]:= u ) }, oDlg,,, {||    (  lCalcDC( aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ], aGet[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ] ), aGet[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )












      aGet[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ]:= u ) }, oDlg,,, {||    (  lCalcDC( aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ], aGet[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ] ), aGet[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )












      aGet[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) )  ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) )  ]:= u ) }, oDlg,,, {||    (  lCalcDC( aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ], aGet[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ] ), aGet[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )













      aGet[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ]:= u ) }, oDlg,, "9999999999", {||    (  lCalcDC( aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ], aGet[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ], aTmp[ ( dbfTmpBnc )->( Fieldpos( "cPaisIBAN" ) ) ] ), aGet[ ( dbfTmpBnc )->( Fieldpos( "cCtrlIBAN" ) ) ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpBnc )->( FieldPos( "lBncDef" ) ) ] := TCheckBox():ReDefine( 290, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "lBncDef" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "lBncDef" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 .AND. !lDis )}, .F. )






      aGet[ ( dbfTmpBnc )->( FieldPos( "nSalIni" ) ) ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ ( dbfTmpBnc )->( FieldPos( "nSalIni" ) ) ], aTmp[ ( dbfTmpBnc )->( FieldPos( "nSalIni" ) ) ]:= u ) }, oDlg,, cPorDiv( cDivEmp() ),,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      TButton():ReDefine( 500, {||( EndEdtBnc( aTmp, aGet, dbfTmpBnc, oBrw, nMode, oDlg, cCodCli, aTmpCli, cOldCtaBnc ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 550, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )





   if nMode <> 3
      oDlg:AddFastKey( 116, {|| EndEdtBnc( aTmp, aGet, dbfTmpBnc, oBrw, nMode, oDlg, cCodCli, aTmpCli, cOldCtaBnc ) } )
   end

   oDlg:bStart := {|| if( aTmp[ ( dbfTmpBnc )->( FieldPos( "lBncDef" ) ) ], aGet[ ( dbfTmpBnc )->( FieldPos( "lBncDef" ) ) ]:Disable(), aGet[ ( dbfTmpBnc )->( FieldPos( "lBncDef" ) ) ]:Enable() ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if !Empty( oBmpDiv )
      oBmpDiv:end()
   end

Return ( oDlg:nResult == 1 )






Static Function EndEdtBnc( aTmp, aGet, dbfTmpBnc, oBrw, nMode, oDlg, cCodCli, aTmpCli, cOldCtaBnc )

   local nRec

   aTmp[ ( dbfTmpBnc )->( FieldPos( "cCodCli" ) ) ]   := cCodCli

   if cOldCtaBnc <> aCuentaIBAN( aTmp, dbfTmpBnc )

      nRec     := ( dbfTmpBnc )->( Recno() )

      if ( dbfTmpBnc )->( dbSeek( cCodCli + aCuentaIBAN( aTmp, dbfTmpBnc ) ) )

         msgStop( "La cuenta bancaria ya existe" )

         aGet[ ( dbfTmpBnc )->( FieldPos( "cPaisIBAN" ) ) ]:SetFocus()

         ( dbfTmpBnc )->( dbGoTo( nRec ) )

         return .F.

      end

      ( dbfTmpBnc )->( dbGoTo( nRec ) )

   end





   WinGather( aTmp, aGet, dbfTmpBnc, oBrw, nMode, , .F. )





   if aTmp[ ( dbfTmpBnc )->( FieldPos( "lBncDef" ) ) ]
      lSelDefBnc( aTmp, dbfTmpBnc )
   end

Return ( oDlg:end( 1 ) )






Static Function lSelDefBnc( aTmp, dbfTmpBnc, oBrw )

   local nRec  := ( dbfTmpBnc )->( RecNo() )

   ( dbfTmpBnc )->( dbGoTop() )
   while !( dbfTmpBnc )->( Eof() )

      if ( dbfTmpBnc )->cEntBnc + ( dbfTmpBnc )->cSucBnc + ( dbfTmpBnc )->cDigBnc + ( dbfTmpBnc )->cCtaBnc <> aTmp[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ] + aTmp[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ] + aTmp[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ] + aTmp[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ]
         ( dbfTmpBnc )->lBncDef := .F.
      else
         ( dbfTmpBnc )->lBncDef := .T.
      end

      ( dbfTmpBnc )->( dbSkip() )

   end

   ( dbfTmpBnc )->( dbGoto( nRec ) )

   if !Empty( oBrw )
      oBrw:Refresh()
   end

Return .T.






Static Function lCargaBanco( aGet, aTmp, nMode )

   local cBanco   := ""

   oBanco:Buscar( aGet[ ( dbfTmpBnc )->( FieldPos( "cCodBnc" ) ) ], "cCodBnc" )

   cBanco         := aTmp[ ( dbfTmpBnc )->( FieldPos( "cCodBnc" ) ) ]

   aGet[ ( dbfTmpBnc )->( FieldPos( "cCodBnc" ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cNomBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cDirBnc" ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cDirBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cPobBnc" ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cPobBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cProBnc" ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cProBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cCPBnc"  ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cPosBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cTlfBnc" ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cTlfBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cFaxBnc" ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cFaxBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cPContBnc")) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cPcoBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cEntBnc" ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cEntBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cSucBnc" ) ) ]:cText( oRetFld( cBanco, oBanco:oDbf, "cOfiBnc" ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cDigBnc" ) ) ]:cText( Space( 2 ) )
   aGet[ ( dbfTmpBnc )->( FieldPos( "cCtaBnc" ) ) ]:cText( Space( 10 ) )

Return .T.






Static Function DelBnc( aTmp, oBrwBnc, dbfTmpBnc )





   if !( dbfTmpBnc )->lBncDef

      dbDelRec( oBrwBnc, dbfTmpBnc )

   else

      if dbDelRec( oBrwBnc, dbfTmpBnc )





         ( dbfTmpBnc )->( dbGoTop() )

         if !( dbfTmpBnc )->( Eof() )
            ( dbfTmpBnc )->lBncDef  := .T.
         end

      end

   end

   oBrwBnc:Refresh()

Return ( .T. )



Function lBancoDefecto( cCodigoCliente, cDbfBanco )

   if ( cDbfBanco )->( dbSeekInOrd( cCodigoCliente, "cCodDef", cDbfBanco ) )
      Return .T.
   end

   if ( cDbfBanco )->( dbSeekInOrd( cCodigoCliente, "cCodCli", cDbfBanco ) )
      Return .T.
   end

Return ( .F. )



Function SynClient( cPath )

   If( cPath == nil, cPath := cPatEmp(), ) ;





   if OpenFiles( .F. )

      while !( D():ClientesBancos( nView ) )->( eof() )










         if Empty( ( D():ClientesBancos( nView ) )->cPaisIBAN )

            if dbLock( D():ClientesBancos( nView ) )
               ( D():ClientesBancos( nView ) )->cPaisIBAN := "ES"
               ( D():ClientesBancos( nView ) )->cCtrlIBAN := IbanDigit( ( D():ClientesBancos( nView ) )->cPaisIBAN, ( D():ClientesBancos( nView ) )->cEntBnc, ( D():ClientesBancos( nView ) )->cSucBnc, ( D():ClientesBancos( nView ) )->cDigBnc, ( D():ClientesBancos( nView ) )->cCtaBnc )
               ( D():ClientesBancos( nView ) )->( dbUnLock() )
            end

         end

         ( D():ClientesBancos( nView ) )->( dbSkip() )

      end





      ( D():Clientes( nView ) )->( dbGoTop() )
      while !( D():Clientes( nView ) )->( Eof() )

         if Empty( ( D():Clientes( nView ) )->Uuid )
            if D():Lock( "Client", nView )
               ( D():Clientes( nView ) )->Uuid     := win_uuidcreatestring()
               D():UnLock( "Client", nView )
            end
         end

         ( D():Clientes( nView ) )->( dbSkip() )

      end

      CloseFiles()

   end

Return ( nil )



Function BrwCliTactil( oGet, dbfCli, oGet2, lReturnCliente, cText, cBitmap )

   local oDlg
   local oBrw
   local nRec
   local nOrdAnt
   local cCliente          := ""
   local lClose            := .F.
   local oGetUnidades
   local cGetUnidades      := Space( 100 )
   local oBmpGeneral
   local oSayGeneral
   local cResource         := "HelpEntryTactilCli"
   local oFntBrw

   If( lReturnCliente == nil, lReturnCliente := .F., ) ;
   If( cText == nil, cText := "Selecione un cliente", ) ;
   If( cBitmap == nil, cBitmap := "gc_businessman_48", ) ;

   if Empty( dbfCli )

      if !OpenFiles( .T. )
         Return nil
      end

      dbfCli               := ( D():Clientes( nView ) )
      lClose               := .T.

   end

   oFntBrw                 := TFont():New( "Segoe UI",  0, 20, .F., .T. )

   nRec                    := ( dbfCli )->( Recno() )
   nOrdAnt                 := ( dbfCli )->( OrdSetFocus( "Telefono" ) )

   ( dbfCli )->( dbGoTop() )

   oDlg = TDialog():New(,,,, "Seleccionar cliente ordenado por: Teléfono", cResource,, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TButtonBmp():ReDefine( 100, {||( VirtualKey( .F., oGetUnidades ), if( lBigSeek( nil, cGetUnidades, dbfCli ), oBrw:Refresh(), ) )}, oDlg,,, .F.,,,, .F., "gc_keyboard_32",,, .F. )





      oSayGeneral := TSay():ReDefine( 200, {||   cText}, oDlg,,,, .F., oFntBrw, .F., .F., )





      oBmpGeneral := TBitmap():ReDefine( 500, cBitmap,, oDlg,,, .F., .F.,,, .F.,,, .T. )




      oGetUnidades := TGetHlp():ReDefine( 600, { | u | If( PCount()==0, cGetUnidades, cGetUnidades:= u ) }, oDlg,,,,,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfCli ) ) }, .F., .F.,,,,,, nil,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfCli
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Browse cliente tactil"
      oBrw:nHeaderHeight   := 40
      oBrw:nRowHeight      := 60
      oBrw:nDataLines      := 2
      oBrw:lHScroll        := .F.
      oBrw:oFont           := oFntBrw

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Código"
         :cSortOrder       := "Cod"
         :bEditValue       := {|| AllTrim( ( dbfCli )->Cod ) }
         :nWidth           := 110
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre y domicilio"
         :cSortOrder       := "Titulo"
         :bEditValue       := {|| AllTrim( ( dbfCli )->Titulo ) + Chr(13)+Chr(10) + AllTrim( ( dbfCli )->Domicilio ) }
         :nWidth           := 440
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Teléfono"
         :cSortOrder       := "Telefono"
         :bEditValue       := {|| AllTrim( ( dbfCli )->Telefono ) }
         :nWidth           := 140
      end





      TButtonBmp():ReDefine( 160, {||( WinAppRec( oBrw, bEdtBig, dbfCli ) )}, oDlg,,, .F.,,,, .F., "gc_user2_add_32",,, .F. )





      TButtonBmp():ReDefine( 170, {||( WinEdtRec( oBrw, bEdtBig, dbfCli ) )}, oDlg,,, .F.,,,, .F., "gc_user2_edit_32",,, .F. )





      TButtonBmp():ReDefine( 140, {||( oBrw:GoUp() )}, oDlg,,, .F.,,,, .F., "UP32",,, .F. )





      TButtonBmp():ReDefine( 150, {||( oBrw:GoDown() )}, oDlg,,, .F.,,,, .F., "DOWN32",,, .F. )





      TButtonBmp():ReDefine( 1, {||( oDlg:End( 1 ) )}, oDlg,,, .F.,,,, .F., "gc_check_32",,, .F. )





      TButtonBmp():ReDefine( 2, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F., "Delete_32",,, .F. )

      oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

      oDlg:bStart := {|| oBrw:Load() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      cCliente    := ( dbfCli )->Cod

      if !Empty( oGet )
         oGet:cText( cCliente )
      end

      if !Empty( oGet2 )
         oGet2:cText( Rtrim( ( dbfCli )->Titulo ) )
      end

   end

   if lClose

      CloseFiles()

   else

      ( dbfCli )->( OrdSetFocus( nOrdAnt ) )
      ( dbfCli )->( dbGoTo( nRec ) )

   end

   if !Empty( oFntBrw )
      oFntBrw:End()
   end

Return ( if( !lReturnCliente, oDlg:nResult == 1, cCliente ) )



Static Function EdtInc( aTmp, aGet, dbfFacCliI, oBrw, cCodCli, bValid, nMode )

   local oDlg
   local oNomInci
   local cNomInci

   if nMode == 1

      if !empty( cCodCli )
         aTmp[ ( dbfFacCliI )->( FieldPos( "cCodCli" ) ) ]  := cCodCli
      end

      aTmp[ ( dbfFacCliI )->( FieldPos( "dFecInc" ) ) ]     := getSysDate()
      aTmp[ ( dbfFacCliI )->( FieldPos( "tTimInc" ) ) ]     := getSysTime()

   end

   if !Empty( aTmp[ ( dbfFacCliI )->( FieldPos( "cCodTip" ) ) ] )
      cNomInci    := ""
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de clientes", "Incidencia",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfFacCliI )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfFacCliI )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[ ( dbfFacCliI )->( FieldPos( "tTimInc" ) ) ], aTmp[ ( dbfFacCliI )->( FieldPos( "tTimInc" ) ) ]:= u ) }, oDlg,, "@R 99:99:99", {||    ( iif (  !validTime( aTmp[ ( dbfFacCliI )->( FieldPos( "tTimInc" ) ) ] ), msgStop( "El formato de la hora no es correcto" ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfFacCliI )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfFacCliI )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfFacCliI )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfFacCliI )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfFacCliI )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfFacCliI )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfFacCliI, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfFacCliI, oBrw, nMode ), oDlg:end( 1 ) } )
      end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )




_HB_CLASS TClienteLabelGenerator ; function TClienteLabelGenerator ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TClienteLabelGenerator", iif( .F., { }, { @HBObject() } ), @TClienteLabelGenerator() ) ) ;

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )
   _HB_MEMBER { oFld } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFld"}, .F. )

   _HB_MEMBER { oCriterio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCriterio"}, .F. )
   _HB_MEMBER { cCriterio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCriterio"}, .F. )
   _HB_MEMBER { aCriterio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aCriterio"}, .F. )

   _HB_MEMBER { oGrupoInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGrupoInicio"}, .F. )
   _HB_MEMBER { cGrupoInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cGrupoInicio"}, .F. )

   _HB_MEMBER { oGrupoFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGrupoFin"}, .F. )
   _HB_MEMBER { cGrupoFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cGrupoFin"}, .F. )

   _HB_MEMBER { oFechaInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFechaInicio"}, .F. )
   _HB_MEMBER { dFechaInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFechaInicio"}, .F. )

   _HB_MEMBER { oFechaFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFechaFin"}, .F. )
   _HB_MEMBER { dFechaFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFechaFin"}, .F. )

   _HB_MEMBER { oInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oInicio"}, .F. )
   _HB_MEMBER { oFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFin"}, .F. )

   _HB_MEMBER { oFormatoLabel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFormatoLabel"}, .F. )
   _HB_MEMBER { cFormatoLabel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFormatoLabel"}, .F. )

   _HB_MEMBER { nFilaInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nFilaInicio"}, .F. )
   _HB_MEMBER { nColumnaInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nColumnaInicio"}, .F. )

   _HB_MEMBER { cFileTmpLabel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileTmpLabel"}, .F. )
   _HB_MEMBER { cAreaTmpLabel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cAreaTmpLabel"}, .F. )

   _HB_MEMBER { oBrwLabel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwLabel"}, .F. )

   _HB_MEMBER { nCantidadLabels } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCantidadLabels"}, .F. )
   _HB_MEMBER { nUnidadesLabels } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nUnidadesLabels"}, .F. )

   _HB_MEMBER { oMtrLabel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMtrLabel"}, .F. )
   _HB_MEMBER { nMtrLabel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nMtrLabel"}, .F. )

   _HB_MEMBER { hBmp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"hBmp"}, .F. )

   _HB_MEMBER { oBtnListado } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnListado"}, .F. )

   _HB_MEMBER { oBtnSiguiente } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnSiguiente"}, .F. )
   _HB_MEMBER { oBtnAnterior } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnAnterior"}, .F. )
   _HB_MEMBER { oBtnCancel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnCancel"}, .F. )

   _HB_MEMBER { aSearch } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aSearch"}, .F. )

   _HB_MEMBER Create(); oClass:AddMethod( "Create", @TClienteLabelGenerator_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER End(); oClass:AddMethod( "End", @TClienteLabelGenerator_End(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lDefault(); oClass:AddMethod( "lDefault", @TClienteLabelGenerator_lDefault(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER BotonAnterior(); oClass:AddMethod( "BotonAnterior", @TClienteLabelGenerator_BotonAnterior(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER BotonSiguiente(); oClass:AddMethod( "BotonSiguiente", @TClienteLabelGenerator_BotonSiguiente(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER PutLabel(); oClass:AddMethod( "PutLabel", @TClienteLabelGenerator_PutLabel(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SelectAllLabels(); oClass:AddMethod( "SelectAllLabels", @TClienteLabelGenerator_SelectAllLabels(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SelectCriterioLabels(); oClass:AddMethod( "SelectCriterioLabels", @TClienteLabelGenerator_SelectCriterioLabels(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AddLabel(); oClass:AddMethod( "AddLabel", @TClienteLabelGenerator_AddLabel(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DelLabel(); oClass:AddMethod( "DelLabel", @TClienteLabelGenerator_DelLabel(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EditLabel(); oClass:AddMethod( "EditLabel", @TClienteLabelGenerator_EditLabel(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ChangeCriterio(); oClass:AddMethod( "ChangeCriterio", @TClienteLabelGenerator_ChangeCriterio(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lPrintLabels(); oClass:AddMethod( "lPrintLabels", @TClienteLabelGenerator_lPrintLabels(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitLabel( oLabel); oClass:AddMethod( "InitLabel", @TClienteLabelGenerator_InitLabel(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lCreateTemporal(); oClass:AddMethod( "lCreateTemporal", @TClienteLabelGenerator_lCreateTemporal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER PrepareTemporal( oFr); oClass:AddMethod( "PrepareTemporal", @TClienteLabelGenerator_PrepareTemporal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DestroyTemporal(); oClass:AddMethod( "DestroyTemporal", @TClienteLabelGenerator_DestroyTemporal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SelectColumn( oCombo); oClass:AddMethod( "SelectColumn", @TClienteLabelGenerator_SelectColumn(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TClienteLabelGenerator ;



static FUNCTION TClienteLabelGenerator_lDefault( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local oError
   local oBlock
   local lError            := .F.

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::cCriterio          := "Ningún criterio"
      ::aCriterio          := { "Ningún criterio", "Grupo clientes", "Fecha modificación" }

      ::cGrupoInicio       := ( D():Clientes( nView ) )->cCodGrp
      ::cGrupoFin          := ( D():Clientes( nView ) )->cCodGrp

      ::dFechaInicio       := Ctod( "01/" + Str( Month( Date() ), 2 ) + "/" + Str( Year( Date() ), 4 ) )
      ::dFechaFin          := GetSysDate()

      ::cFormatoLabel      := GetPvProfString( "Etiquetas", "Cliente", Space( 3 ), cIniEmpresa() )
      if len( ::cFormatoLabel ) < 3
         ::cFormatoLabel   := Space( 3 )
      end

      ::nMtrLabel          := 0

      ::nFilaInicio        := 1
      ::nColumnaInicio     := 1

      ::nCantidadLabels    := 1
      ::nUnidadesLabels    := 1

      ::aSearch            := { "Código", "Nombre", "NIF/CIF", "Teléfono" }

   RECOVER USING oError

      lError               := .T.

      msgStop( "Error en la creación de generador de etiquetas" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

Return ( !lError )



static FUNCTION TClienteLabelGenerator_Create( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local oBtnPrp
   local oGetOrd
   local oCbxOrd
   local cGetOrd     := Space( 100 )
   local cCbxOrd     := "Código"
   local aCbxOrd     := { "Código", "Nombre" }

   if ::lDefault()

      ::oDlg = TDialog():New(,,,,, "SelectLabels_0",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )





         ::oFld := TPages():Redefine( 10, ::oDlg, {"SelectLabels_4", "SelectLabels_2"},,,, )










         TBitmap():ReDefine( 500, "gc_portable_barcode_scanner_48",, ::oDlg,,, .F., .F.,,, .F.,,, .T. )



         ::oCriterio := TComboBox():ReDefine( 90, { | u | If( PCount()==0, ::cCriterio, ::cCriterio:= u ) }, ::aCriterio, ::oFld:aDialogs[ 1 ],,,,,,, .F.,,,,,,, "::oCriterio",,,,,,, )

         ::oCriterio:bChange        := {|| ::ChangeCriterio() }





         ::oGrupoInicio := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::cGrupoInicio, ::cGrupoInicio:= u ) }, ::oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 101 )

         ::oGrupoInicio:bValid    := {|| oGrpCli:Existe( ::cGrupoInicio, ::oGrupoInicio:oHelpText, "cNomGrp", .T., .T., "0" ) }
         ::oGrupoInicio:bHelp     := {|| oGrpCli:Buscar( ::oGrupoInicio ) }



         ::oInicio := TSay():ReDefine( 102,, ::oFld:aDialogs[1],,,, .F.,, .F., .F., )





         ::oGrupoFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cGrupoFin, ::cGrupoFin:= u ) }, ::oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 111 )

         ::oGrupoFin:bValid       := {|| oGrpCli:Existe( ::cGrupoFin, ::oGrupoFin:oHelpText, "cNomGrp", .T., .T., "0" ) }
         ::oGrupoFin:bHelp        := {|| oGrpCli:Buscar( ::oGrupoFin ) }



         ::oFin := TSay():ReDefine( 112,, ::oFld:aDialogs[1],,,, .F.,, .F., .F., )




         ::oFechaInicio := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::dFechaInicio, ::dFechaInicio:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




         ::oFechaFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::dFechaFin, ::dFechaFin:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





         ::oFormatoLabel := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::cFormatoLabel, ::cFormatoLabel:= u ) }, ::oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 161 )

            ::oFormatoLabel:bValid  := {|| cDocumento( ::oFormatoLabel, ::oFormatoLabel:oHelpText, dbfDoc, "CL" ) }
            ::oFormatoLabel:bHelp   := {|| BrwDocumento( ::oFormatoLabel, ::oFormatoLabel:oHelpText, "CL" ) }

         TBtnBmp():ReDefine( 220, "gc_document_text_pencil_12",,,,,{|| EdtDocumento( ::cFormatoLabel ) }, ::oFld:aDialogs[ 1 ], .F., , .F., "Modificar formato de etiquetas" )





         TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::nFilaInicio, ::nFilaInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





         TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::nColumnaInicio, ::nColumnaInicio:= u ) }, ::oFld:aDialogs[ 1 ],, "999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )







         TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::nUnidadesLabels, ::nUnidadesLabels:= u ) }, ::oFld:aDialogs[ 1 ],, "99999",,,,,,, .F.,,, .F., .T.,,, {||      1}, {||      99999},, nil,,, )









         oGetOrd := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cGetOrd, cGetOrd:= u ) }, ::oFld:aDialogs[ 2 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "FIND",, )

         oGetOrd:bChange   := {| nKey, nFlags, oGet | AutoSeek( nKey, nFlags, oGet, ::oBrwLabel, ( D():Clientes( nView ) ) ) }
         oGetOrd:bValid    := {|| ( D():Clientes( nView ) )->( OrdScope( 0, nil ) ), ( D():Clientes( nView ) )->( OrdScope( 1, nil ) ), ::oBrwLabel:Refresh(), .T. }





         oCbxOrd := TComboBox():ReDefine( 210, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, ::oFld:aDialogs[ 2 ],,,,,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

         oCbxOrd:bChange   := {|| ::SelectColumn( oCbxOrd ) }




         TButton():ReDefine( 100, {||( ::PutLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 110, {||( ::SelectAllLabels( .T. ) )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 120, {||( ::SelectAllLabels( .F. ) )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 130, {||( ::AddLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 140, {||( ::DelLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 150, {||( ::EditLabel() )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 160, {||( WinEdtRec( ::oBrwLabel, bEdtRec, ( D():Clientes( nView ) ) ) )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         TButton():ReDefine( 165, {||( WinZooRec( ::oBrwLabel, bEdtRec, ( D():Clientes( nView ) ) ) )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )




         oBtnPrp := TButton():ReDefine( 220, {||( nil )}, ::oFld:aDialogs[ 2 ],,, .F.,,,, .F. )

         ::oBrwLabel                 := IXBrowse():New( ::oFld:aDialogs[ 2 ] )

         ::oBrwLabel:nMarqueeStyle   := 5
         ::oBrwLabel:nColSel         := 2

         ::oBrwLabel:lHScroll        := .F.
         ::oBrwLabel:cAlias          := ( D():Clientes( nView ) )

         ::oBrwLabel:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
         ::oBrwLabel:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
         ::oBrwLabel:bLDblClick      := {|| ::PutLabel() }

         ::oBrwLabel:CreateFromResource( 180 )

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Sl. Seleccionado"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( D():Clientes( nView ) )->lLabel }
            :nWidth           := 20
            :SetCheck( { "Sel16", "Nil16" } )
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Código"
            :cSortOrder       := "Cod"
            :bEditValue       := {|| ( D():Clientes( nView ) )->Cod }
            :nWidth           := 80
            :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Nombre"
            :cSortOrder       := "Titulo"
            :bEditValue       := {|| ( D():Clientes( nView ) )->Titulo }
            :nWidth           := 280
            :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "N. etiquetas"
            :bEditValue       := {|| ( D():Clientes( nView ) )->nLabel }
            :cEditPicture     := "@E 99,999"
            :nWidth           := 80
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nEditType        := 1
            :bOnPostEdit      := {|o,x| if( dbDialogLock( D():Clientes( nView ) ), ( ( D():Clientes( nView ) )->nLabel := x, ( D():Clientes( nView ) )->( dbUnlock() ) ), ) }
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "NIF/CIF"
            :cSortOrder       := "Nif"
            :bEditValue       := {|| ( D():Clientes( nView ) )->Nif }
            :nWidth           := 80
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Teléfono"
            :cSortOrder       := "Telefono"
            :bEditValue       := {|| ( D():Clientes( nView ) )->Telefono }
            :nWidth           := 80
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Fax"
            :bEditValue       := {|| ( D():Clientes( nView ) )->Fax }
            :nWidth           := 80
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Domicilio"
            :bEditValue       := {|| ( D():Clientes( nView ) )->Domicilio }
            :nWidth           := 300
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Población"
            :bEditValue       := {|| ( D():Clientes( nView ) )->Poblacion }
            :nWidth           := 200
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Código postal"
            :bEditValue       := {|| ( D():Clientes( nView ) )->CodPostal }
            :nWidth           := 60
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Provincia"
            :bEditValue       := {|| ( D():Clientes( nView ) )->Provincia }
            :nWidth           := 100
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Establecimiento"
            :cSortOrder       := "NbrEst"
            :bEditValue       := {|| ( D():Clientes( nView ) )->NbrEst }
            :nWidth           := 100
         end

         with object ( ::oBrwLabel:AddCol() )
            :cHeader          := "Correo electrónico"
            :bEditValue       := {|| ( D():Clientes( nView ) )->cMeiInt }
            :nWidth           := 100
         end






   ::oMtrLabel := TApoloMeter():ReDefine( 190, { | u | If( PCount()==0, ::nMtrLabel, ::nMtrLabel:= u ) }, ( D():Clientes( nView ) )->( lastrec() ), ::oFld:aDialogs[ 2 ], .F.,, "", .F.,,,, )

         ::oMtrLabel:nClrText   := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
         ::oMtrLabel:nClrBar    := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
         ::oMtrLabel:nClrBText  := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )








         ::oBtnListado := TButton():ReDefine( 40, {||( TInfCliGrp():New( "Listado de clientes seleccionados para etiquetas" ):Play( .T. ) )}, ::oDlg,,, .F.,,,, .F. )




         ::oBtnAnterior := TButton():ReDefine( 20, {||( ::BotonAnterior() )}, ::oDlg,,, .F.,,,, .F. )




         ::oBtnSiguiente := TButton():ReDefine( 30, {||( ::BotonSiguiente() )}, ::oDlg,,, .F.,,,, .F. )




         ::oBtnCancel := TButton():ReDefine( 2, {||( ::oDlg:End() )}, ::oDlg,,, .F.,,,, .F. )

      ::oDlg:bStart  := {|| ::oBtnAnterior:Hide(), ::ChangeCriterio(), ::oFormatoLabel:lValid(), oBtnPrp:Hide() }

      ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

      ::End()

   end

Return ( Self )



static FUNCTION TClienteLabelGenerator_BotonAnterior( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   ::oFld:GoPrev()

   ::oBtnAnterior:Hide()

   SetWindowText( ::oBtnSiguiente:hWnd, "Siguien&te >" )

Return ( Self )



static FUNCTION TClienteLabelGenerator_BotonSiguiente( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   do case
      case ::oFld:nOption == 1

         if Empty( ::cFormatoLabel )

            MsgStop( "Debe cumplimentar un formato de etiquetas" )

         else

            ::oFld:GoNext()
            ::oBtnAnterior:Show()

            if ::oCriterio:nAt <> 1
               ::SelectCriterioLabels()
            end

            SetWindowText( ::oBtnSiguiente:hWnd, "&Terminar" )

         end

      case ::oFld:nOption == 2

         if ::lPrintLabels()

            SetWindowText( ::oBtnCancel:hWnd, "&Cerrar" )

         end

         ::oBrwLabel:Refresh()

   end

Return ( Self )



static FUNCTION TClienteLabelGenerator_End( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   WritePProString( "Etiquetas", "Cliente", ::cFormatoLabel, cIniEmpresa() )

Return ( Self )



static FUNCTION TClienteLabelGenerator_PutLabel( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   if dbLock( D():Clientes( nView ) )
      ( D():Clientes( nView ) )->lLabel      := !( D():Clientes( nView ) )->lLabel
      if ( D():Clientes( nView ) )->lLabel .AND. Empty( ( D():Clientes( nView ) )->nLabel )
         ( D():Clientes( nView ) )->nLabel   := 1
      end
      ( D():Clientes( nView ) )->( dbUnLock() )
   end

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



static FUNCTION TClienteLabelGenerator_SelectAllLabels( lSelect ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local n        := 0
   local nRecno   := ( D():Clientes( nView ) )->( Recno() )

   CursorWait()

   ( D():Clientes( nView ) )->( dbGoTop() )
   while !( D():Clientes( nView ) )->( eof() )

      if dbLock( D():Clientes( nView ) )
         ( D():Clientes( nView ) )->lLabel := lSelect
         ( D():Clientes( nView ) )->( dbUnLock() )
      end

      ( D():Clientes( nView ) )->( dbSkip() )

      ::oMtrLabel:Set( ++n )

   end

   ( D():Clientes( nView ) )->( dbGoTo( nRecno ) )

   ::oBrwLabel:Refresh()

   ::oMtrLabel:Set( 0 )
   ::oMtrLabel:Refresh()

   CursorArrow()

Return ( Self )



static FUNCTION TClienteLabelGenerator_SelectCriterioLabels( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local n        := 0
   local nRecno   := ( D():Clientes( nView ) )->( Recno() )

   CursorWait()

   ( D():Clientes( nView ) )->( dbGoTop() )
   while !( D():Clientes( nView ) )->( eof() )

      if dbLock( D():Clientes( nView ) )

         do case
            case ::oCriterio:nAt == 2 .AND. ( D():Clientes( nView ) )->cCodGrp >= ::cGrupoInicio .AND. ( D():Clientes( nView ) )->cCodGrp <= ::cGrupoFin
               ( D():Clientes( nView ) )->lLabel := .T.
               ( D():Clientes( nView ) )->nLabel := ::nUnidadesLabels

            case ::oCriterio:nAt == 3 .AND. ( D():Clientes( nView ) )->dFecChg >= ::dFechaInicio .AND. ( D():Clientes( nView ) )->dFecChg <= ::dFechaFin
               ( D():Clientes( nView ) )->lLabel := .T.
               ( D():Clientes( nView ) )->nLabel := ::nUnidadesLabels

            otherwise
               ( D():Clientes( nView ) )->lLabel := .F.
               ( D():Clientes( nView ) )->nLabel := 1

         end

         ( D():Clientes( nView ) )->( dbUnLock() )

      end

      ( D():Clientes( nView ) )->( dbSkip() )

      ::oMtrLabel:Set( ++n )

   end

   ( D():Clientes( nView ) )->( dbGoTo( nRecno ) )

   ::oBrwLabel:Refresh()

   ::oMtrLabel:Set( 0 )
   ::oMtrLabel:Refresh()

   CursorArrow()

Return ( Self )



static FUNCTION TClienteLabelGenerator_AddLabel( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   if dbLock( D():Clientes( nView ) )
      ( D():Clientes( nView ) )->nLabel++
      ( D():Clientes( nView ) )->( dbUnLock() )
   end

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



static FUNCTION TClienteLabelGenerator_DelLabel( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   if ( D():Clientes( nView ) )->nLabel > 1
      if dbLock( D():Clientes( nView ) )
         ( D():Clientes( nView ) )->nLabel--
         ( D():Clientes( nView ) )->( dbUnLock() )
      end
   end

   ::oBrwLabel:Refresh()
   ::oBrwLabel:SetFocus()

Return ( Self )



static FUNCTION TClienteLabelGenerator_EditLabel( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   ::oBrwLabel:aCols[ 4 ]:Edit()

Return ( Self )



static FUNCTION TClienteLabelGenerator_ChangeCriterio( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   ::oGrupoInicio:Hide()
   ::oGrupoFin:Hide()

   ::oInicio:Hide()
   ::oFin:Hide()

   ::oFechaInicio:Hide()
   ::oFechaFin:Hide()

   do case
      case ::oCriterio:nAt == 2

         ::oGrupoInicio:Show()
         ::oGrupoFin:Show()
         ::oInicio:Show()
         ::oFin:Show()

      case ::oCriterio:nAt == 3

         ::oFechaInicio:Show()
         ::oFechaFin:Show()
         ::oInicio:Show()
         ::oFin:Show()

   end

Return ( Self )



static FUNCTION TClienteLabelGenerator_lPrintLabels( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local oFr

   if !::lCreateTemporal()
      Return .F.
   end

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr, .T. )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      ::PrepareTemporal( oFr )





      oFr:PrepareReport()





      oFr:ShowPreparedReport()

   end





   oFr:DestroyFr()





   ::DestroyTemporal()

Return ( .T. )



static FUNCTION TClienteLabelGenerator_InitLabel( oLabel ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local nStartRow

   if ::nFilaInicio > 1
      nStartRow            := oLabel:nStartRow
      nStartRow            += ( ::nFilaInicio - 1 ) * ( oLabel:nLblHeight + oLabel:nVSeparator )

      if nStartRow < oLabel:nBottomRow
         oLabel:nStartRow  := nStartRow
      end
   end

   if ::nColumnaInicio > 1 .AND. ::nColumnaInicio <= oLabel:nLblOnLine
      oLabel:nLblCurrent   := ::nColumnaInicio
   end

Return ( Self )



static FUNCTION TClienteLabelGenerator_lCreateTemporal( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local n
   local nRec
   local oBlock
   local oError
   local nBlancos
   local lCreateTemporal   := .T.
   local lClose            := .F.

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      tmpClient            := "LblCli"
      filClient            := cGetNewFileName( cPatTmp() + "LblCli" )

      dbCreate( filClient, aSqlStruct( aItmCli() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), filClient, tmpClient, .F. )

      ( tmpClient )->( OrdCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( tmpClient )->( OrdCreate( filClient, "Cod", "Cod", {|| Field->Cod } ) )





      nRec                 := ( D():Clientes( nView ) )->( Recno() )

      ( D():Clientes( nView ) )->( dbGoTop() )
      while !( D():Clientes( nView ) )->( eof() )

         if ( D():Clientes( nView ) )->lLabel
            for n := 1 to ( D():Clientes( nView ) )->nLabel
               dbPass( ( D():Clientes( nView ) ), tmpClient, .T. )
            next
         end

         ( D():Clientes( nView ) )->( dbSkip() )

      end
      ( tmpClient )->( dbGoTop() )

      ( D():Clientes( nView ) )->( dbGoTo( nRec ) )

   RECOVER USING oError

      lCreateTemporal      := .F.

      MsgStop( "Imposible crear tablas temporales" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

Return ( lCreateTemporal )



static FUNCTION TClienteLabelGenerator_PrepareTemporal( oFr ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local n
   local nBlancos       := 0
   local nPaperHeight   := oFr:GetProperty( "MainPage", "PaperHeight" ) * 3.77953
   local nHeight        := oFr:GetProperty( "MasterData", "Height" )
   local nColumns       := oFr:GetProperty( "MainPage", "Columns" )
   local nItemsInColumn := 0

   if !Empty( nPaperHeight ) .AND. !Empty( nHeight ) .AND. !Empty( nColumns )

      nItemsInColumn    := int( nPaperHeight / nHeight )

      nBlancos          := ( ::nColumnaInicio - 1 ) * nItemsInColumn
      nBlancos          += ( ::nFilaInicio - 1 )

      for n := 1 to nBlancos
         dbPass( dbBlankRec( D():Clientes( nView ) ), tmpClient, .T. )
      next

   end

   ( tmpClient )->( dbGoTop() )

Return ( .T. )



static FUNCTION TClienteLabelGenerator_DestroyTemporal( ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   if ( tmpClient )->( Used() )
      ( tmpClient )->( dbCloseArea() )
   end

   dbfErase( filClient )

Return ( .T. )



static FUNCTION TClienteLabelGenerator_SelectColumn( oCombo ) ; local Self AS CLASS TClienteLabelGenerator := QSelf() AS CLASS TClienteLabelGenerator

   local oCol
   local cOrd                    := oCombo:VarGet()

   if ::oBrwLabel <> nil

      with object ::oBrwLabel

         for each oCol in :aCols

            if Equal( cOrd, oCol:cHeader )
               oCol:cOrder       := "A"
               oCol:SetOrder()
            else
               oCol:cOrder       := " "
            end

         next

      end

      ::oBrwLabel:Refresh()

   end

Return ( Self )








Function RtfRefreshButtons( oRtf, oBtn )

   local aChar := REGetCharFormat( oRTF:hWnd )

   lBold       := aChar[ 5 ] == 700
   lItalic     := aChar[ 6 ]
   lUnderline  := aChar[ 7 ]
   lBullet     := REGetBullet( oRTF:hWnd )

   if oBtn[ 4 ]:lWhen()
      oBtn[ 4 ]:Enable()
      oBtn[ 4 ]:Refresh()
   else
      oBtn[ 4 ]:Disable()
      oBtn[ 4 ]:Refresh()
   end

   if oBtn[ 5 ]:lWhen()
      oBtn[ 5 ]:Enable()
      oBtn[ 5 ]:Refresh()
   else
      oBtn[ 5 ]:Disable()
      oBtn[ 5 ]:Refresh()
   end

Return ( nil )







FUNCTION BrwClient( uGet, uGetName, lBigStyle )

   local oDlg
   local oBmp
   local hBmp
   local oBrw
   local uGet1
   local cGet1
   local cTxtOrigen
   local nOrdAnt     := GetBrwOpt( "BrwClient" )
   local oCbxOrd
   local aCbxOrd     := { "Código", "Nombre", "NIF/CIF", "Teléfono", "Establecimiento", "Población" }
   local cCbxOrd
   local nLevel      := Auth():Level( "01032" )
   local oSayText
   local cSayText    := "Listado de clientes"

   if !Empty( uGet )
      cTxtOrigen     := uGet:VarGet()
   end

   nOrdAnt           := Min( Max( nOrdAnt, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrdAnt ]

   If( lBigStyle == nil, lBigStyle := .F., ) ;

   if !OpenFiles( .T. )
      Return nil
   end





   if !Empty( cTxtOrigen ) .AND. !( D():Clientes( nView ) )->( dbSeek( cTxtOrigen ) )
      ( D():Clientes( nView ) )->( OrdSetFocus( nOrdAnt ) )
      ( D():Clientes( nView ) )->( dbGoTop() )
   else
      ( D():Clientes( nView ) )->( OrdSetFocus( nOrdAnt ) )
   end





   do case
   case lBigStyle
      oDlg = TDialog():New(,,,, "Seleccionar clientes", "BIGHELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )
   otherwise
      oDlg = TDialog():New(,,,, "Seleccionar clientes", "HELPENTRYIMAGE",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmp := TBitmap():ReDefine( 600, "gc_businessman_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )

   end






      uGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, ( D():Clientes( nView ) ) ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, ( D():Clientes( nView ) ), .T. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( D():Clientes( nView ) )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), uGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := ( D():Clientes( nView ) )
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Browse.Clientes"

      with object ( oBrw:AddCol() )
         :cHeader          := "Disponible"
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Clientes( nView ) )->lBlqCli .OR. ( D():Clientes( nView ) )->lInaCli }
         :nWidth           := 20
         :SetCheck( { "Cnt16", "Nil16" } )
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Código"
         :cSortOrder       := "Cod"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Cod }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "Titulo"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Titulo }
         :nWidth           := 280
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "NIF/CIF"
         :cSortOrder       := "Nif"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Nif }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Teléfono"
         :cSortOrder       := "Telefono"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Telefono }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fax"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Fax }
         :nWidth           := 80
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Domicilio"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Domicilio }
         :nWidth           := 300
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Población"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Poblacion }
         :nWidth           := 200
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Código postal"
         :bEditValue       := {|| ( D():Clientes( nView ) )->CodPostal }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Provincia"
         :bEditValue       := {|| ( D():Clientes( nView ) )->Provincia }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Establecimiento"
         :cSortOrder       := "NbrEst"
         :bEditValue       := {|| ( D():Clientes( nView ) )->NbrEst }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Correo electrónico"
         :bEditValue       := {|| ( D():Clientes( nView ) )->cMeiInt }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Riesgo"
         :bEditValue       := {|| Trans( ( D():Clientes( nView ) )->nImpRie, PicOut() ) }
         :nWidth           := 60
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Contacto"
         :bEditValue       := {|| ( D():Clientes( nView ) )->cPerCto }
         :nWidth           := 100
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Observaciones"
         :bEditValue       := {|| ( D():Clientes( nView ) )->mComent }
         :nWidth           := 200
      end

      oDetCamposExtra:addCamposExtra( oBrw )

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }
      oBrw:bRClicked       := {| nRow, nCol, nFlags | oBrw:RButtonDown( nRow, nCol, nFlags ) }

      oBrw:CreateFromResource( 105 )

      if lBigStyle
         oBrw:nHeaderHeight   := 36
         oBrw:nFooterHeight   := 36
         oBrw:nLineHeight     := 36
      end




      TButton():ReDefine( 1, {||( oDlg:end(1) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 500, {||( WinAppRec( oBrw, bEdtRec, ( D():Clientes( nView ) ) ) )}, oDlg,,, .F., {||     nAnd( nLevel, 2 ) <> 0},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrw, bEdtRec, ( D():Clientes( nView ) ) ) )}, oDlg,,, .F., {||     nAnd( nLevel, 4 ) <> 0},,, .F. )

      oDlg:AddFastKey( 113,    {|| if( nAnd( nLevel, 2 ) <> 0, WinAppRec( oBrw, bEdtRec, ( D():Clientes( nView ) ) ), ) } )
      oDlg:AddFastKey( 114,    {|| if( nAnd( nLevel, 4 ) <> 0, WinEdtRec( oBrw, bEdtRec, ( D():Clientes( nView ) ) ), ) } )

   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )

   oDlg:bStart                := {|| if ( !IsReport(), oBrw:Load(), ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      if !Empty( uGet )

         if ValType( uGet ) == "O"
            uGet:cText( ( D():Clientes( nView ) )->Cod )
            uGet:lValid()
         else
            uGet  := ( D():Clientes( nView ) )->Cod
         end

      end

      if ValType( uGetName ) == "O"
         uGetName:cText( ( D():Clientes( nView ) )->Titulo )
      end

   end

   DestroyFastFilter( D():Clientes( nView ) )

   SetBrwOpt( "BrwClient", ( D():Clientes( nView ) )->( OrdNumber() ) )

   CloseFiles()

   if Valtype( uGet ) == "O"
      uGet:setFocus()
   end

   DeleteObject( hBmp )

   if !Empty( oBmp )
      oBmp:End()
   end

RETURN oDlg:nResult == 1







FUNCTION BrwEntidad( cCodCli, oDbf )

   local oDlg
   local hBmp
   local oBrw
   local uGet1
   local cGet1
   local nOrdAnt     := GetBrwOpt( "BrwEntidad" )
   local oCbxOrd
   local aCbxOrd     := { "Descripción del organismo" }
   local cCbxOrd
   local nLevel      := Auth():Level( "04012" )
   local oSayText
   local cSayText    := "Listado de entidades"
   local hash        := {}
   local chash

   nOrdAnt           := Min( Max( nOrdAnt, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrdAnt ]

   if !OpenFiles( .T. )
      Return nil
   end





   if ( D():ClientesEntidad( nView ) )->( dbSeek( cCodCli ) )

      ( D():ClientesEntidad( nView ) )->( ordSetFocus( nOrdAnt ) )
      ( D():ClientesEntidad( nView ) )->( OrdScope( 0, cCodCli ) )
      ( D():ClientesEntidad( nView ) )->( OrdScope( 1, cCodCli ) )
      ( D():ClientesEntidad( nView ) )->( dbGoTop() )

   else

      MsgInfo( "El cliente seleccionado no tiene entidades que importar." )
       CloseFiles()
      return .F.

   endif





   oDlg = TDialog():New(,,,, "Seleccionar entidad", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






      uGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,,,,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, ( D():ClientesEntidad( nView ) ), .T. ) ) }, .F., .F.,,,,,, nil, "FIND",, )










      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( D():ClientesEntidad( nView ) )->( OrdSetFocus( oCbxOrd:nAt ) ), ( D():ClientesEntidad( nView ) )->( OrdScope( 0, cCodCli ) ), ( D():ClientesEntidad( nView ) )->( OrdScope( 1, cCodCli ) ), oBrw:Refresh(), uGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := ( D():ClientesEntidad( nView ) )
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Browse.Clientes"

      with object ( oBrw:AddCol() )
         :cHeader          := "Descripción del organismo"
         :cSortOrder       := "cDesFac"
         :bEditValue       := {|| ( D():ClientesEntidad( nView ) )->cDesFac }
         :nWidth           := 200
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }
      oBrw:bRClicked       := {| nRow, nCol, nFlags | oBrw:RButtonDown( nRow, nCol, nFlags ) }

      oBrw:CreateFromResource( 105 )




      TButton():ReDefine( 1, {||( oDlg:end(1) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 500, {||( WinAppRec( oBrw, bEdtRec, ( D():ClientesEntidad( nView ) ) ) )}, oDlg,,, .F., {||     nAnd( nLevel, 2 ) <> 0},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrw, bEdtRec, ( D():ClientesEntidad( nView ) ) ) )}, oDlg,,, .F., {||     nAnd( nLevel, 4 ) <> 0},,, .F. )

      oDlg:AddFastKey( 113,    {|| if( nAnd( nLevel, 2 ) <> 0, WinAppRec( oBrw, bEdtRec, ( D():ClientesEntidad( nView ) ) ), ) } )

   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )

   oDlg:bStart           := {|| oBrw:Load() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

        aplicaEntidadCliente( , nView, oDbf )

   end

   DestroyFastFilter( D():ClientesEntidad( nView ) )

   SetBrwOpt( "BrwEntidad", ( D():ClientesEntidad( nView ) )->( OrdNumber() ) )

   CloseFiles()

   DeleteObject( hBmp )

RETURN oDlg:nResult == 1



FUNCTION LoaIniCli( cPath, IniCli )

   local n
   local oFileIniCli

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cIniCli == nil, cIniCli := cPath + "Client.Ini", ) ;

   oFileIniCli := TIni():New( IniCli )

      cInicli := oFileIniCli:Get( "filtro", "ft", "Activas", cInicli )



   cInicli     := Rtrim( cInicli )

RETURN ( cIniCli )






FUNCTION assertClient( cPath )

   If( cPath == nil, cPath := cPatEmp(), ) ;

   IF !lExistTable( cPath + "Client.Dbf", cLocalDriver() )
      dbCreate( cPath + "Client.Dbf", aSqlStruct( aItmCli() ), cLocalDriver() )
   end

   IF !lExistTable( cPath + "ObrasT.Dbf", cLocalDriver() )
      dbCreate( cPath + "ObrasT.Dbf", aSqlStruct( aItmObr() ), cLocalDriver() )
   end

   IF !lExistTable( cPath + "ClientD.Dbf", cLocalDriver() )
      dbCreate( cPath + "ClientD.Dbf", aSqlStruct( aCliDoc() ), cLocalDriver() )
   end

   IF !lExistTable( cPath + "CliBnc.Dbf", cLocalDriver() )
      dbCreate( cPath + "CliBnc.Dbf", aSqlStruct( aCliBnc() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "CliInc.Dbf", cLocalDriver() )
      dbCreate( cPath + "CliInc.Dbf", aSqlStruct( aCliInc() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "CliCto.Dbf", cLocalDriver() )
      dbCreate( cPath + "CliCto.Dbf", aSqlStruct( aItmContacto() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "CliDad.Dbf", cLocalDriver() )
      dbCreate( cPath + "CliDad.Dbf", aSqlStruct( aCliDad() ), cLocalDriver() )
   end

RETURN ( nil )



FUNCTION mkClient( cPath, lAppend, cPathOld, oMeter )

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( lAppend == nil, lAppend := .F., ) ;

   assertClient( cPath )

   if oMeter <> NIL
      oMeter:cText      := "Generando Bases"
      sysRefresh()
   end

   if lAppend .AND. lIsDir( cPathOld )
      AppDbf( cPathOld, cPath, "Client" )
      AppDbf( cPathOld, cPath, "ObrasT" )
      AppDbf( cPathOld, cPath, "CliBnc" )
      AppDbf( cPathOld, cPath, "CliInc" )
      AppDbf( cPathOld, cPath, "CliCto" )
      AppDbf( cPathOld, cPath, "ClientD" )
      AppDbf( cPathOld, cPath, "CliDad" )
   end

   rxClient( cPath, cLocalDriver() )

RETURN NIL



FUNCTION rxClient( cPath, cDriver )

   local dbfCli
   local oError
   local oBlock

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   assertClient( cPath )




   fEraseIndex( cPath + "CLIENT.CDX" )

   dbUseArea( .T., cDriver, cPath + "CLIENT.DBF", cCheckArea( "CLIENT", @dbfCli ), .F. )
   if !( dbfCli )->( neterr() )
      ( dbfCli )->( __dbPack() )

      ( dbfCli )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CLIENT.CDX", "COD", "Upper( Field->COD )", {|| Upper( Field->COD ) } ) )

      ( dbfCli )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CLIENT.CDX", "TITULO", "UPPER( Field->TITULO )", {|| UPPER( Field->TITULO ) }, ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CLIENT.CDX", "NIF", "Field->NIF", {|| Field->NIF }, ) )

      ( dbfCli )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CLIENT.CDX", "Telefono", "Field->Telefono", {|| Field->Telefono } ) )

      ( dbfCli )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CLIENT.CDX", "NbrEst", "Upper( Field->NbrEst )", {|| Upper( Field->NbrEst ) } ) )

      ( dbfCli )->( ordCondSet("!Deleted()", {||!Deleted() } ) )
      ( dbfCli )->( ordCreate( cPath + "CLIENT.CDX", "Poblacion", "POBLACION", {|| Field->POBLACION } ) )

      ( dbfCli )->( ordCondSet("!Deleted() .and. nTipCli == 3", {||!Deleted() .AND. Field->nTipCli == 3 } ) )
      ( dbfCli )->( ordCreate( cPath + "CLIENT.CDX", "cCliWeb", "COD", {|| Field->COD } ) )

      ( dbfCli )->( dbCloseArea() )

   else

      msgStop( "Imposible abrir en modo exclusivo la tabla de clientes" )

   end

   fEraseIndex( cPath + "ObrasT.CDX" )

   dbUseArea( .T., cDriver, cPath + "OBRAST.DBF", cCheckArea( "OBRAST", @dbfCli ), .F. )
   if !( dbfCli )->( neterr() )
      ( dbfCli )->( __dbPack() )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "ObrasT.CDX", "CCODCLI", "cCodCli + cCodObr", {|| Field->cCodCli + Field->cCodObr } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "ObrasT.Cdx", "CNOMOBR", "cCodCli + cNomObr", {|| Field->cCodCli + Field->cNomObr } ) )

      ( dbfCli )->( ordCondSet( "lDefObr .and. !Deleted()", {|| Field->lDefObr .AND. !Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "OBRAST.CDX", "lDefObr", "cCodCli", {|| Field->cCodCli } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "OBRAST.CDX", "CCODIGO", "cCodObr", {|| Field->cCodObr } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "ObrasT.Cdx", "CNOMBRE", "cNomObr", {|| Field->cNomObr } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "ObrasT.Cdx", "CCODWEB", "Str( cCodWeb, 11 )", {|| Str( Field->cCodWeb, 11 ) } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "ObrasT.Cdx", "CDIROBR", "Upper( cDirObr )", {|| Upper( Field->cDirObr ) } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "OBRAST.CDX", "cCodPos", "cCodPos", {|| Field->cCodPos } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "OBRAST.CDX", "cCodEdi", "Field->cCodEdi + Field->cDeparta", {|| Field->cCodEdi + Field->cDeparta } ) )

      ( dbfCli )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de obras" )
   end

   fEraseIndex( cPath + "CliBnc.Cdx" )

   dbUseArea( .T., cDriver, cPath + "CliBnc.DBF", cCheckArea( "CliBnc", @dbfCli ), .F. )
   if !( dbfCli )->( neterr() )
      ( dbfCli )->( __dbPack() )

      ( dbfCli )->( ordCondSet( "!Deleted()", {|| !Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliBnc.CDX", "cCodCli", "cCodCli", {|| Field->cCodCli } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfCli )->( ordCreate( cPath + "CliBnc.CDX", "cCtaBnc", "cCodCli + cEntBnc + cSucBnc + cDigBnc + cCtaBnc", {|| Field->cCodCli + Field->cEntBnc + Field->cSucBnc + Field->cDigBnc + Field->cCtaBnc } ) )

      ( dbfCli )->( ordCondSet("!Deleted() .and. lBncDef", {|| !Deleted() .AND. Field->lBncDef } ) )
      ( dbfCli )->( ordCreate( cPath + "CliBnc.CDX", "cBncDef", "cCodCli", {|| Field->cCodCli } ) )

      ( dbfCli )->( ordCondSet("!Deleted() .and. lBncDef", {|| !Deleted() .AND. Field->lBncDef } ) )
      ( dbfCli )->( ordCreate( cPath + "CliBnc.CDX", "cCodDef", "cCodCli + cEntBnc + cSucBnc + cDigBnc + cCtaBnc", {|| Field->cCodCli + Field->cEntBnc + Field->cSucBnc + Field->cDigBnc + Field->cCtaBnc } ) )

      ( dbfCli )->( dbCloseArea() )

   else

      msgStop( "Imposible abrir en modo exclusivo la tabla de bancos de clientes" )

   end

   fEraseIndex( cPath + "ClientD.Cdx" )

   dbUseArea( .T., cDriver, cPath + "ClientD.DBF", cCheckArea( "ClientD", @dbfCli ), .F. )
   if !( dbfCli )->( neterr() )
      ( dbfCli )->( __dbPack() )

      ( dbfCli )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "ClientD.CDX", "cCodCli", "cCodCli", {|| Field->cCodCli } ) )

      ( dbfCli )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de documentos" )
   end

   fEraseIndex( cPath + "CliInc.Cdx" )

   dbUseArea( .T., cDriver, cPath + "CliInc.Dbf", cCheckArea( "CliInc", @dbfCli ), .F. )
   if !( dbfCli )->( neterr() )
      ( dbfCli )->( __dbPack() )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliInc.Cdx", "CCODCLI", "CCODCLI + dtos(dFecInc)", {|| Field->CCODCLI+ dtos(Field->dFecInc) } ) )

      ( dbfCli )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de incidencias" )
   end



   fEraseIndex( cPath + "CliCto.Cdx" )

   dbUseArea( .T., cDriver, cPath + "CliCto.Dbf", cCheckArea( "CLICONTA", @dbfCli ), .F. )

   if !( dbfCli )->( neterr() )
      ( dbfCli )->( __dbPack() )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliCto.Cdx", "cCodCli", "cCodCli", {|| Field->cCodCli } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliCto.Cdx", "cNomCon", "cNomCon", {|| Field->cNomCon } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliCto.Cdx", "cPosCon", "cPosCon", {|| Field->cPosCon } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliCto.Cdx", "cTelCon", "cTelCon", {|| Field->cTelCon } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliCto.Cdx", "cMovCon", "cMovCon", {|| Field->cMovCon } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliCto.Cdx", "cMaiCon", "cMaiCon", {|| Field->cMaiCon } ) )

      ( dbfCli )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de contactos de clientes." )
   end



   fEraseIndex( cPath + "CliDad.Cdx" )

   dbUseArea( .T., cDriver, cPath + "CliDad.Dbf", cCheckArea( "CliDad", @dbfCli ), .F. )

   if !( dbfCli )->( neterr() )
      ( dbfCli )->( __dbPack() )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliDad.Cdx", "cCodCli", "cCodCli", {|| Field->cCodCli } ) )

      ( dbfCli )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfCli )->( ordCreate( cPath + "CliDad.Cdx", "cDesFac", "cDesFac", {|| Field->cDesFac } ) )

      ( dbfCli )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturae de clientes." )
   end











RETURN NIL



FUNCTION aCliInc()

   local aBase := {}

   aAdd( aBase, { "cCodCli",     "C", 12, 0, "Código del cliente",               "Código",            "", "( cDbfInc )", nil } )
   aAdd( aBase, { "cCodTip",     "C",  3, 0, "Tipo de incidencia" ,              "Tipo",              "", "( cDbfInc )", nil } )
   aAdd( aBase, { "dFecInc",     "D",  8, 0, "Fecha de la incidencia" ,          "Fecha",             "", "( cDbfInc )", {|| getSysDate() } } )
   aAdd( aBase, { "tTimInc",     "C",  6, 0, "Hora de la incidencia" ,           "Hora",              "", "( cDbfInc )", {|| getSysTime() } } )
   aAdd( aBase, { "mDesInc",     "M", 10, 0, "Descripción de la incidencia" ,    "Nombre",            "", "( cDbfInc )", "" } )
   aAdd( aBase, { "lListo",      "L",  1, 0, "Lógico de listo" ,                 "",                  "", "( cDbfInc )", nil } )
   aAdd( aBase, { "lAviso",      "L",  1, 0, "Lógico de aviso" ,                 "",                  "", "( cDbfInc )", nil } )

RETURN ( aBase )



FUNCTION aCliBnc()

   local aBase := {}

   aAdd( aBase, { "cCodCli",     "C", 12, 0, "Código del cliente",                        "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "lBncDef",     "L",  1, 0, "Lógico banco por defecto",                  "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cCodBnc",     "C", 50, 0, "Nombre del banco",                          "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cDirBnc",     "C", 35, 0, "Domicilio del banco",                       "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cPobBnc",     "C", 25, 0, "Población del banco",                       "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cProBnc",     "C", 20, 0, "Provincia del banco",                       "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cCPBnc",      "C", 15, 0, "Código postal",                             "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cTlfBnc",     "C", 20, 0, "Teléfono",                                  "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cFaxBnc",     "C", 20, 0, "Fax",                                       "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cPContBnc",   "C", 35, 0, "Persona de contacto",                       "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cPaiBnc",     "C",  4, 0, "País",                                      "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cPaisIBAN",   "C",  2, 0, "País IBAN",                                 "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cCtrlIBAN",   "C",  2, 0, "Dígito de control IBAN",                    "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cEntBnc",     "C",  4, 0, "Entidad de la cuenta bancaria",             "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cSucBnc",     "C",  4, 0, "Sucursal de la cuenta bancaria",            "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cDigBnc",     "C",  2, 0, "Dígito de control de la cuenta bancaria",   "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "cCtaBnc",     "C", 20, 0, "Cuenta bancaria",                           "",                   "", "( cDbfBnc )" } )
   aAdd( aBase, { "nSalIni",     "N", 16, 6, "Saldo inicial",                             "",                   "", "( cDbfBnc )" } )

RETURN ( aBase )



function aCliDoc()

   local aCliDoc  := {}

   aAdd( aCliDoc, { "cCodCli", "C",   12,  0, "Código del cliente" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aCliDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,           "",                   "", "( cDbfCol )" } )
   aAdd( aCliDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aCliDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,    "",                   "", "( cDbfCol )" } )

return ( aCliDoc )



function aCliDad()

   local aCliDad  := {}

   aAdd( aCliDad, { "cCodCli", "C",   12,  0, "Código del cliente" ,        "",                   "", "( cDbfCol )" } )
   aAdd( aCliDad, { "cDesFac", "C",   60,  0, "Descripción del organismo" , "",                   "", "( cDbfCol )" } )
   aAdd( aCliDad, { "mMemo",   "M",   10,  0, "Memo relaciones de organismos", "",                "", "( cDbfCol )" } )

return ( aCliDad )



FUNCTION aItmAtp()

   local aBase := {}

   aAdd( aBase,  { "cCodCli",   "C", 12, 0, "Código del cliente" }                     )
   aAdd( aBase,  { "cCodGrp",   "C",  4, 0, "Código de grupo de cliente" }             )
   aAdd( aBase,  { "cCodArt",   "C", 18, 0, "Código de artículo en atipicas" }         )
   aAdd( aBase,  { "cCodFam",   "C", 16, 0, "Código de familias en atipicas" }         )
   aAdd( aBase,  { "nTipAtp",   "N",  1, 0, "Tipo de atípicas" }                       )
   aAdd( aBase,  { "cCodPr1",   "C", 20, 0, "Código propiedad 1" }                     )
   aAdd( aBase,  { "cValPr1",   "C", 20, 0, "Valor propiedad 1" }                      )
   aAdd( aBase,  { "cCodPr2",   "C", 20, 0, "Código propiedad 2" }                     )
   aAdd( aBase,  { "cValPr2",   "C", 20, 0, "Valor propiedad 2" }                      )
   aAdd( aBase,  { "dFecIni",   "D",  8, 0, "Fecha inicio de la situación atipica" }   )
   aAdd( aBase,  { "dFecFin",   "D",  8, 0, "Fecha fin de la situación atipica" }      )
   aAdd( aBase,  { "lPrcCom",   "L",  1, 0, "Lógico para precio de compras personal" } )
   aAdd( aBase,  { "nPrcCom",   "N", 16, 6, "Precio de coste" }                        )
   aAdd( aBase,  { "nPrcArt",   "N", 16, 6, "Precio de venta 1 del artículo" }         )
   aAdd( aBase,  { "nPrcArt2",  "N", 16, 6, "Precio de venta 2 del artículo" }         )
   aAdd( aBase,  { "nPrcArt3",  "N", 16, 6, "Precio de venta 3 del artículo" }         )
   aAdd( aBase,  { "nPrcArt4",  "N", 16, 6, "Precio de venta 4 del artículo" }         )
   aAdd( aBase,  { "nPrcArt5",  "N", 16, 6, "Precio de venta 5 del artículo" }         )
   aAdd( aBase,  { "nPrcArt6",  "N", 16, 6, "Precio de venta 6 del artículo" }         )
   aAdd( aBase,  { "nPreIva1",  "N", 16, 6, "Precio de venta 1 con " + cImp() }        )
   aAdd( aBase,  { "nPreIva2",  "N", 16, 6, "Precio de venta 2 con " + cImp() }        )
   aAdd( aBase,  { "nPreIva3",  "N", 16, 6, "Precio de venta 3 con " + cImp() }        )
   aAdd( aBase,  { "nPreIva4",  "N", 16, 6, "Precio de venta 4 con " + cImp() }        )
   aAdd( aBase,  { "nPreIva5",  "N", 16, 6, "Precio de venta 5 con " + cImp() }        )
   aAdd( aBase,  { "nPreIva6",  "N", 16, 6, "Precio de venta 6 con " + cImp() }        )
   aAdd( aBase,  { "nDtoArt",   "N",  6, 2, "Descuento del articulo" }                 )
   aAdd( aBase,  { "nDprArt",   "N",  6, 2, "Descuento promocional del articulo" }     )
   aAdd( aBase,  { "lComAge",   "L",  1, 0, "Lógico para tener en cuenta el porcentaje o no" } )
   aAdd( aBase,  { "nComAge",   "N",  6, 2, "Comisión del agente" }                    )
   aAdd( aBase,  { "nDtoDiv",   "N", 16, 6, "Descuento lineal" }                       )
   aAdd( aBase,  { "lAplPre",   "L",  1, 0, "Aplicar en presupuestos" }                )
   aAdd( aBase,  { "lAplPed",   "L",  1, 0, "Aplicar en pedidos" }                     )
   aAdd( aBase,  { "lAplAlb",   "L",  1, 0, "Aplicar en albaranes" }                   )
   aAdd( aBase,  { "lAplFac",   "L",  1, 0, "Aplicar en facturas" }                    )
   aAdd( aBase,  { "lAplSat",   "L",  1, 0, "Aplicar en S.A.T." }                      )
   aAdd( aBase,  { "nUnvOfe",   "N",  3, 0, "Unidades a vender en la oferta" }         )
   aAdd( aBase,  { "nUncOfe",   "N",  3, 0, "Unidades a cobrar en la oferta" }         )
   aAdd( aBase,  { "nTipXby",   "N",  1, 0, "Tipo de oferta" }                         )
   aAdd( aBase,  { "nDto1",     "N",  6, 2, "Descuento de tarifa de venta 1" }         )
   aAdd( aBase,  { "nDto2",     "N",  6, 2, "Descuento de tarifa de venta 2" }         )
   aAdd( aBase,  { "nDto3",     "N",  6, 2, "Descuento de tarifa de venta 3" }         )
   aAdd( aBase,  { "nDto4",     "N",  6, 2, "Descuento de tarifa de venta 4" }         )
   aAdd( aBase,  { "nDto5",     "N",  6, 2, "Descuento de tarifa de venta 5" }         )
   aAdd( aBase,  { "nDto6",     "N",  6, 2, "Descuento de tarifa de venta 6" }         )
   aAdd( aBase,  { "cCodAge",   "C",  3, 0, "Código del agente" }                      )
   aAdd( aBase,  { "cCodEnv",   "C",  3, 0, "Código del envase" }                      )
   aAdd( aBase,  { "cDesEsp",   "C",150, 0, "Descripción especial" }                   )
   aAdd( aBase,  { "cNomArt",   "C",100, 0, "Nombre artículo" }                        )
   aAdd( aBase,  { "cNomFam",   "C",100, 0, "Nombre familia" }                         )
   aAdd( aBase,  { "dUltPrc",   "D",  8, 0, "Fecha ultimo cambio precio" }             )
   aAdd( aBase,  { "cTimUPr",   "C",  6, 0, "Hora último cambio precio" }              )
   aAdd( aBase,  { "nTarifa",   "N",  1, 0, "Tarifa a aplicar en atipica por familia" })

RETURN ( aBase )






FUNCTION aItmCli()

   local aBase := {}

   aAdd( aBase, { "Cod",       "C", 12, 0, "Código",                                        "Codigo",                "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Titulo",    "C", 80, 0, "Nombre",                                        "Nombre",                "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Nif",       "C", 30, 0, "NIF",                                           "NIF",                   "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Domicilio", "C",200, 0, "Domicilio",                                     "Domicilio",             "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Poblacion", "C",200, 0, "Población",                                     "Poblacion",             "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Provincia", "C",100, 0, "Provincia",                                     "Provincia",             "", "( cDbfCli )", nil } )
   aAdd( aBase, { "CodPostal", "C", 15, 0, "Código postal",                                 "CodigoPostal",          "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Telefono",  "C", 50, 0, "Teléfono",                                      "Telefono",              "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Fax",       "C", 50, 0, "Fax",                                           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Movil",     "C", 50, 0, "Móvil",                                         "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "NbrEst",    "C",200, 0, "Nombre del establecimiento" ,                   "NombreEstablecimiento", "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Direst",    "C",200, 0, "Domicilio del servicio" ,                       "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "DiaPago",   "N",  2, 0, "Primer día de pago",                            "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "DiaPago2",  "N",  2, 0, "Segundo día de pago",                           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Banco",     "C", 50, 0, "Nombre del banco",                              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "DirBanco",  "C", 35, 0, "Domicilio del banco",                           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "PobBanco",  "C", 25, 0, "Población del banco",                           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cProBanco", "C", 20, 0, "Provincia del banco",                           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Cuenta",    "C", 20, 0, "",                                              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nTipCli",   "N",  1, 0, "Tipo",                                          "TipoCliente",           "", "( cDbfCli )", nil } )
   aAdd( aBase, { "CodPago",   "C",  2, 0, "Código del tipo de pago",                       "Pago",                  "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cDtoEsp",   "C", 50, 0, "Descripción del descuento por factura" ,        "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nDtoEsp",   "N",  6, 2, "Porcentaje de descuento por factura" ,          "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cDpp",      "C", 50, 0, "Descripción del descuento por pronto pago" ,    "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nDpp",      "N",  6, 2, "Porcentaje de descuento por pronto pago" ,      "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nDtoCnt",   "N",  6, 2, "Porcentaje del primer dto personalizado" ,      "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nDtoRap",   "N",  6, 2, "Porcentaje del segundo dto personalizado" ,     "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cDtoUno",   "C", 50, 0, "Descripción del primer dto personalizado" ,     "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cDtoDos",   "C", 50, 0, "Descripción del segundo dto personalizado" ,    "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nDtoPtf",   "N",  6, 2, "Importe de descuento plataforma" ,              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Riesgo",    "N", 16, 6, "Importe maximo autorizado para operaciones",    "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "CopiasF",   "N",  1, 0, "Número de facturas a imprimir",                 "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Serie",     "C",  1, 0, "Código de la serie de facturas",                "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nRegIva",   "N",  1, 0, "Regimen de " + cImp(),                          "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lReq",      "L",  1, 0, "Lógico para recargo de equivalencia (S/N)",     "Recargo",               "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Subcta",    "C", 12, 0, "Subcuenta cliente enlace contaplus",            "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "CtaVenta",  "C",  3, 0, "Cuenta venta cliente contaplus",                "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgente",   "C",  3, 0, "Código agente comercial",                       "CodigoAgente",          "", "( cDbfCli )", {|| accessCode():cAgente } } )
   aAdd( aBase, { "lMayorista","L",  1, 0, "Utilizar precio de mayorista (S/N)" ,           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nTarifa",   "N",  1, 0, "Tarifa a aplicar" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lLabel",    "L",  1, 0, "Lógico para etiquetado (S/N)" ,                 "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nLabel",    "N",  5, 0, "Número de etiquetas a imprimir" ,               "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodTar",   "C",  5, 0, "Código de tarifa" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "mComent",   "M", 10, 0, "Memo para comentarios" ,                        "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodRut",   "C",  4, 0, "Código de ruta" ,                               "CodigoRuta",            "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodRut2",  "C",  4, 0, "Código de ruta alternativa" ,                   "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodPai",   "C",  4, 0, "Código de país" ,                               "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodGrp",   "C",  4, 0, "Código de grupo de cliente" ,                   "CodigoGrupo",           "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodRem",   "C",  3, 0, "Código de remesa" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cMeiInt",   "C",240, 0, "Correo electrónico" ,                           "Email",                 "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cWebInt",   "C", 65, 0, "Página web" ,                                   "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lChgPre",   "L",  1, 0, "Lógico para autorización de venta de crédito" , "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lCreSol",   "L",  1, 0, "Lógico para bloquear con riesgo alcanzado" ,    "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lPntVer",   "L",  1, 0, "Lógico para operar con punto verde" ,           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef01", "C",100, 0, "Campo definido 1" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef02", "C",100, 0, "Campo definido 2" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef03", "C",100, 0, "Campo definido 3" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef04", "C",100, 0, "Campo definido 4" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef05", "C",100, 0, "Campo definido 5" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef06", "C",100, 0, "Campo definido 6" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef07", "C",100, 0, "Campo definido 7" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef08", "C",100, 0, "Campo definido 8" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef09", "C",100, 0, "Campo definido 9" ,                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cUsrDef10", "C",100, 0, "Campo definido 10" ,                            "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lVisLun",   "L",  1, 0, "Lógico visita lunes" ,                          "lVisLun",               "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lVisMar",   "L",  1, 0, "Lógico visita martes" ,                         "lVisMar",               "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lVisMie",   "L",  1, 0, "Lógico visita miércoles" ,                      "lVisMie",               "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lVisJue",   "L",  1, 0, "Lógico visita jueves" ,                         "lVisJue",               "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lVisVie",   "L",  1, 0, "Lógico visita viernes" ,                        "lVisVie",               "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lVisSab",   "L",  1, 0, "Lógico visita sábado" ,                         "lVisSab",               "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lVisDom",   "L",  1, 0, "Lógico visita domingo" ,                        "lVisDom",               "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nVisLun",   "N",  4, 0, "" ,                                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nVisMar",   "N",  4, 0, "" ,                                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nVisMie",   "N",  4, 0, "" ,                                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nVisJue",   "N",  4, 0, "" ,                                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nVisVie",   "N",  4, 0, "" ,                                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nVisSab",   "N",  4, 0, "" ,                                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nVisDom",   "N",  4, 0, "" ,                                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgeLun",   "C",  3, 0, "Código agente para visita lunes",               "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgeMar",   "C",  3, 0, "Código agente para visita martes",              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgeMie",   "C",  3, 0, "Código agente para visita miércoles",           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgeJue",   "C",  3, 0, "Código agente para visita jueves",              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgeVie",   "C",  3, 0, "Código agente para visita viernes",             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgeSab",   "C",  3, 0, "Código agente para visita sábado",              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgeDom",   "C",  3, 0, "Código agente para visita domingo",             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lSndInt",   "L",  1, 0, "Lógico para envio por internet" ,               "EnviarInternet",        "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cPerCto",   "C",200, 0, "Persona de contacto" ,                          "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodAlm",   "C", 16, 0, "Código de almacén",                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nMesVac",   "N",  2, 0, "Mes de vacaciones",                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nImpRie",   "N", 16, 6, "Riesgo alcanzado",                              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nColor",    "N", 10, 0, "",                                              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "SubCtaDto", "C", 12, 0, "Código subcuenta descuento",                    "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lBlqCli",   "L",  1, 0, "Cliente bloqueado" ,                            "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lMosCom",   "L",  1, 0, "Mostrar comentario" ,                           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lTotAlb",   "L",  1, 0, "Totalizar albaranes" ,                          "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cDtoAtp",   "C", 50, 0, "Descripción del descuento atipico" ,            "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nDtoAtp",   "N",  6, 2, "Porcentaje de descuento atípico" ,              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nSbrAtp",   "N",  1, 0, "" ,                                             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodUsr",   "C",  3, 0, "Código de usuario que realiza el cambio" ,      "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "dFecChg",   "D",  8, 0, "Fecha de cambio" ,                              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cTimChg",   "C",  5, 0, "Hora de cambio" ,                               "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nTipRet",   "N",  1, 0, "Tipo de retención ( 1-Base / 2-Base+IVA )",     "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nPctRet",   "N",  6, 2, "Porcentaje de retención",                       "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "dFecBlq",   "D",  8, 0, "Fecha de bloqueo del cliente",                  "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cMotBlq",   "C",250, 0, "Motivo del bloqueo del cliente",                "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lModDat",   "L",  1, 0, "Lógico para no modificar datos en la venta" ,   "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lMail",     "L",  1, 0, "Lógico para enviar mail" ,                      "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodTrn",   "C",  9, 0, "Código del transportista" ,                     "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "mObserv",   "M", 10, 0, "Observaciones",                                 "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lPubInt",   "L",  4, 0, "Lógico para publicar en internet (S/N)",        "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cClave",    "C", 40, 0, "Contraseña cliente para Web",                   "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodWeb",   "N", 11, 0, "Código del cliente en la web",                  "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodEdi",   "C", 17, 0, "Código del cliente en EDI (EAN)",               "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cFacAut",   "C",  3, 0, "Código de factura automática",                  "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lWeb",      "L",  4, 0, "Lógico para creado desde internet (S/N)",       "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nDtoArt",   "N",  1, 0, "Descuento de artículo",                         "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lExcFid",   "L",  1, 0, "Lógico para creado desde internet (S/N)",       "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "mFacAut",   "M", 10, 0, "Plantillas de facturas automáticas",            "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "dFecNaci",  "D",  8, 0, "Fecha de nacimiento",                           "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nSexo",     "N",  1, 0, "Sexo del cliente",                              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "nTarCmb",   "N",  1, 0, "Tarifa a aplicar para combinar en táctil" ,     "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "dLlaCli",   "D",  8, 0, "Última llamada del cliente" ,                   "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cTimCli",   "C",  5, 0, "Hora última llamada del cliente" ,              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Telefono2", "C", 50, 0, "Segundo teléfono",                              "Telefono2",             "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Movil2",    "C", 50, 0, "Segundo móvil",                                 "Movil2",                "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cAgente2",  "C",  3, 0, "Código de segundo agente comercial ",           "CodigoAgente2",         "", "( cDbfCli )", {|| accessCode():cAgente } } )
   aAdd( aBase, { "cDeparta",  "C",  4, 0, "Código de departamento",                        "Departamento",          "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cDomEnt",   "C",200, 0, "Domicilio de entrega",                          "DomicilioEntrega",      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cPobEnt",   "C",200, 0, "Población de entrega",                          "PoblacionEntrega",      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCPEnt",    "C", 15, 0, "Código postal de entrega",                      "CodigoPostalEntrega",   "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cPrvEnt",   "C",200, 0, "Provincia de entrega",                          "ProvinciaEntrega",      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cProvee",   "C", 50, 0, "Código de proveedor",                           "CodigoProveedor",       "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cCodBic",   "C", 50, 0, "Código Bic",                                    "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cHorario",  "C", 50, 0, "Horario",                                       "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cEntidad",  "C", 25, 0, "Entidad",                                       "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "dPetRie",   "D",  8, 0, "Fecha de petición de riesgo",                   "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "dConRie",   "D",  8, 0, "Fecha de concesión de riesgo",                  "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lInaCli",   "L",  1, 0, "Lógico para cliente inactivo",                  "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "dFecIna",   "D",  8, 0, "Fecha de inactividad del cliente",              "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "cMotIna",   "C",250, 0, "Motivo de inactividad del cliente",             "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "dAlta",     "D",  8, 0, "Fecha de alta del cliente",                     "",                      "", "( cDbfCli )", nil } )
   aAdd( aBase, { "Uuid",      "C", 40, 0, "Identificador cliente" ,                        "UuidCliente",           "", "( cDbfCli )", nil } )
   aAdd( aBase, { "lUltVta",   "L",  1, 0, "Lógico guardar último precio venta" ,           "LogicoUltimoPrecio",    "", "( cDbfCli )", .F. } )
   aAdd( aBase, { "lFacPdt",   "L",  1, 0, "Lógico guardar último precio venta" ,           "lAvisarFacturasPendientes","", "( cDbfCli )", .F. } )
   aAdd( aBase, { "nDFacPdt",  "N",  3, 0, "Lógico guardar último precio venta" ,           "nDiasFacturaPendiente", "", "( cDbfCli )", 0 } )
   aAdd( aBase, { "cIdWP",     "C", 40, 0, "Id relación con WordPress" ,                    "",                      "", "( cDbfCli )", nil } )

RETURN ( aBase )






FUNCTION lCliBlq( cCodCli, dbfCli )

   local lRet     := .F.

   if dbSeekInOrd( cCodCli, "Cod", dbfCli )
      lRet        := ( dbfCli )->lBlqCli
   end

RETURN lRet



FUNCTION isAviableClient( nView, nMode )

   if ( nMode <> 1 .AND. nMode <> 4 )
      Return .T.
   end

   if ( D():Clientes( nView ) )->lInaCli


      msgStop( "Cliente inactivo, no se pueden realizar operaciones de venta" + Chr(13)+Chr(10) +  "Motivo: " + alltrim( ( D():Clientes( nView ) )->cMotIna ), "Imposible crear documento" )
      Return .F.
   end

   if ( D():Clientes( nView ) )->lBlqCli


      msgStop( "Cliente bloqueado, no se pueden realizar operaciones de venta" + Chr(13)+Chr(10) +  "Motivo: " + alltrim( ( D():Clientes( nView ) )->cMotBlq ), "Imposible crear documento" )
      Return .F.
   end

RETURN .T.



FUNCTION GetRiesgo( cCodCli, dbfCli, oRieCli )

   local nImpRiesgo := 0
   local aCliStatus

   if Empty( cCodCli )
      oRieCli:SetColor( ( 0 + ( 0 * 256 ) + ( 0 * 65536 ) ), ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ) )
      oRieCli:cText( nImpRiesgo )
      Return ( nImpRiesgo )
   end

   aCliStatus  := aGetStatus( dbfCli, .T. )

   if ( dbfCli )->( dbSeek( cCodCli ) )

      nImpRiesgo     := ( dbfCli )->nImpRie

      if oRieCli <> nil

         if nImpRiesgo <> 0 .AND. nImpRiesgo >= ( dbfCli )->Riesgo
            oRieCli:SetColor( ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ), ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ) )
         else
            oRieCli:SetColor( ( 0 + ( 0 * 256 ) + ( 0 * 65536 ) ), ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ) )
         end

         oRieCli:cText( nImpRiesgo )

      end

   end

   SetStatus( dbfCli, aCliStatus )

return ( nImpRiesgo )







FUNCTION lCliChg( cCodCli, dbfClient )

   local lRet     := .F.

   if dbSeekInOrd( cCodCli, "Cod", dbfClient )
      lRet        := ( dbfClient )->lChgPre
   end

RETURN lRet



FUNCTION AddRiesgo( nImpRie, cCodCli, dbfClient )

   local aCliStatus  := aGetStatus( dbfClient, .T. )

   if ( dbfClient )->( dbSeek( cCodCli ) ) .AND. dbDialogLock( dbfClient )
      ( dbfClient )->nImpRie  += nImpRie
      ( dbfClient )->nTipCli  := 1
      ( dbfClient )->( dbUnlock() )
   end

   SetStatus( dbfClient, aCliStatus )

return ( nil )



FUNCTION DelRiesgo( nImpRie, cCodCli, dbfClient )

   local aCliStatus  := aGetStatus( dbfClient, .T. )

   if ( dbfClient )->( dbSeek( cCodCli ) )
      if dbDialogLock( dbfClient )
         ( dbfClient )->nImpRie  -= nImpRie
         ( dbfClient )->nTipCli  := 1
         ( dbfClient )->( dbCommit() )
         ( dbfClient )->( dbUnlock() )
      end
   end

   SetStatus( dbfClient, aCliStatus )

return ( nil )



FUNCTION RetClient( cCodCli, dbfClient )

   local oBlock
   local oError
   local lClose   := .F.
   local cText    := Space( 30 )

   cCodCli        := RJust( cCodCli, "0", RetNumCodCliEmp() )

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if Empty( dbfClient )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose      := .T.
   end

   if ValType( dbfClient ) == "O"
      if dbfClient:Seek( cCodCli )
         cText    := dbfClient:Titulo
      end
   else
      if ( dbfClient )->( dbSeek( cCodCli ) )
         cText    := ( dbfClient )->Titulo
      end
   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de clientes" )

   end
   ErrorBlock( oBlock )

   if lClose
      ( dbfClient )->( dbCloseArea() )
   end

RETURN cText



FUNCTION cClient( oGet, dbfCli, oGet2 )

   local oBlock
   local oError
   local lClose   := .F.
   local lValid   := .F.
   local xValor   := oGet:varGet()

   if Empty( xValor )
      if IsObject( oGet2 )
         oGet2:cText( "" )
         oGet2:SetColor( 0, 16777215 )
      end
      return .T.
   elseif at( ".", xValor ) <> 0
      xValor      := PntReplace( oGet, "0", RetNumCodCliEmp() )
   else
      xValor      := RJustObj( oGet, "0", RetNumCodCliEmp() )
   end

   if ( Alltrim( xValor ) == Replicate( "Z", len( Alltrim( xValor ) ) ) )
      return .T.
   end

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if Empty( dbfCli )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfCli ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose      := .T.
   end

   if dbSeekInOrd( xValor, "Cod", dbfCli )

      if IsObject( oGet )
         oGet:cText( ( dbfCli )->Cod )
      end

      if IsObject( oGet2 )
         oGet2:cText( ( dbfCli )->Titulo )
         if ( dbfCli )->nColor <> 0
            oGet2:SetColor( , ( dbfCli )->nColor )
         end
      end

      lValid      := .T.

   else

      msgStop( "Cliente no encontrado", "Código buscado : " + xValor )

   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos" )

   end

   ErrorBlock( oBlock )

   if lClose
      ( dbfCli )->( dbCloseArea() )
   end

RETURN lValid



STATIC FUNCTION ActTitle( nKey, nFlags, oGet, nMode, oDlg, cCodCli )

   oDlg:cTitle( LblTitle( nMode ) + " Cliente : " + Rtrim( cCodCli ) + "-" + Rtrim( oGet:varGet() ) )

RETURN NIL



STATIC FUNCTION lValidNombre( oGet )

   local cNombre  := oGet:VarGet()
   local nRec     := ( D():Clientes( nView ) )->( Recno() )
   local nOrd     := ( D():Clientes( nView ) )->( OrdSetFocus( "Titulo" ) )

   if !Empty( cNombre ) .AND. ( D():Clientes( nView ) )->( dbSeek( cNombre ) )
      msgStop( "El nombre introducido ya existe en la base de datos" )
   end

   ( D():Clientes( nView ) )->( dbGoTo( nRec ) )
   ( D():Clientes( nView ) )->( OrdSetFocus( nOrd ) )

RETURN .T.



STATIC FUNCTION lValidCif( oGet )

   local cCif     := oGet:VarGet()
   local nRec     := ( D():Clientes( nView ) )->( Recno() )
   local nOrd     := ( D():Clientes( nView ) )->( OrdSetFocus( "Nif" ) )

   if !Empty( cCif ) .AND. ( D():Clientes( nView ) )->( dbSeek( cCif ) )
      msgStop( "C.I.F / N.I.F. ya existe" )
   end

   ( D():Clientes( nView ) )->( dbGoTo( nRec ) )
   ( D():Clientes( nView ) )->( OrdSetFocus( nOrd ) )

RETURN .T.



STATIC FUNCTION lValidTlf( oGet )

   local cTlf     := oGet:VarGet()
   local nRec     := ( D():Clientes( nView ) )->( Recno() )
   local nOrd     := ( D():Clientes( nView ) )->( OrdSetFocus( "Telefono" ) )

   if !Empty( cTlf ) .AND. ( D():Clientes( nView ) )->( dbSeek( cTlf ) )
      msgStop( "El télefono introducido ya existe en la base de datos" )
   end

   ( D():Clientes( nView ) )->( dbGoTo( nRec ) )
   ( D():Clientes( nView ) )->( OrdSetFocus( nOrd ) )

RETURN .T.



STATIC FUNCTION BeginTrans( aTmp, nMode )

   local oError
   local oBlock
   local lErrors     := .F.
   local cCodCli     := aTmp[ ( D():Clientes( nView ) )->( fieldpos( "Cod" ) ) ]
   local cCodSubCta  := aTmp[ ( D():Clientes( nView ) )->( fieldpos( "SubCta" ) ) ]

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   cTmpObr           := cGetNewFileName( cPatTmp() + "TmpObr" )
   cTmpBnc           := cGetNewFileName( cPatTmp() + "TmpBnc" )
   cTmpDoc           := cGetNewFileName( cPatTmp() + "TmpDoc" )
   cTmpAtp           := cGetNewFileName( cPatTmp() + "TmpAtp" )
   cTmpCta           := cGetNewFileName( cPatTmp() + "TmpCta" )
   cTmpInc           := cGetNewFileName( cPatTmp() + "TmpInc" )
   cTmpCon           := cGetNewFileName( cPatTmp() + "TmpCon" )
   cTmpFacturae      := cGetNewFileName( cPatTmp() + "TmpFacturae" )

   dbCreate( cTmpCta, aSqlStruct( aItmSubcuenta() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpCta, cCheckArea( "TmpCta", @dbfTmpSubCta ), .F. )

   ( dbfTmpSubCta )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpSubCta )->( OrdCreate( cTmpCta, "dFecha", "dFecha", {|| Field->dFecha } ) )

   if nMode <> 1
      LoadSubcuenta( cCodSubCta, cRutCnt(), dbfTmpSubCta )
   end

   dbCreate( cTmpDoc, aSqlStruct( aCliDoc() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( "TmpDoc", @dbfTmpDoc ), .F. )

   ( dbfTmpDoc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpDoc )->( ordCreate( cTmpDoc, "Recno", "Recno()", {|| Recno() } ) )

   dbCreate( cTmpFacturae, aSqlStruct( aCliDad() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpFacturae, cCheckArea( "TmpFacturae", @dbfTmpFacturae ), .F. )

   ( dbfTmpFacturae )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpFacturae )->( ordCreate( cTmpFacturae, "Recno", "Recno()", {|| Recno() } ) )

   dbCreate( cTmpObr, aSqlStruct( aItmObr() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpObr, cCheckArea( "TmpObr", @dbfTmpObr ), .F. )

   ( dbfTmpObr )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpObr )->( ordCreate( cTmpObr, "Recno", "Recno()", {|| Recno() } ) )

   dbCreate( cTmpBnc, aSqlStruct( aCliBnc() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpBnc, cCheckArea( "TmpBnc", @dbfTmpBnc ), .F. )

   ( dbfTmpBnc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpBnc )->( OrdCreate( cTmpBnc, "CCODCLI", "CCODCLI + CENTBNC + CSUCBNC + CDIGBNC + CCTABNC", {|| Field->CCODCLI + Field->CENTBNC + Field->CSUCBNC + Field->CDIGBNC +  Field->CCTABNC } ) )

   dbCreate( cTmpAtp, aSqlStruct( aItmAtp() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpAtp, cCheckArea( "TmpAtp", @dbfTmpAtp ), .F. )

   ( dbfTmpAtp )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
   ( dbfTmpAtp )->( OrdCreate( cTmpAtp, "cCliArt", "CCODART + CCODPR1 + CCODPR2 + CVALPR1 + CVALPR2", {|| Field->CCODART + Field->CCODPR1 + Field->CCODPR2 + Field->CVALPR1 + Field->CVALPR2 } ) )

   ( dbfTmpAtp )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpAtp )->( OrdCreate( cTmpAtp, "cCodFam", "cCodFam", {|| Field->cCodFam } ) )

   ( dbfTmpAtp )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpAtp )->( OrdCreate( cTmpAtp, "cNomArt", "cNomArt", {|| Field->cNomArt } ) )

   ( dbfTmpAtp )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpAtp )->( OrdCreate( cTmpAtp, "cNomFam", "cNomFam", {|| Field->cNomFam } ) )

   ( dbfTmpAtp )->( OrdSetFocus( "cCliArt" ) )

   dbCreate( cTmpInc, aSqlStruct( aCliInc() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( "TmpInc", @dbfTmpInc ), .F. )

   ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() }, , , , , , , , , .T. ) )
   ( dbfTmpInc )->( OrdCreate( cTmpInc, "cCodCli", "cCodTip + Dtos( dFecInc )", {|| Field->cCodTip + Dtos( Field->dFecInc ) } ) )

   ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpInc )->( OrdCreate( cTmpInc, "cCodTip", "cCodTip", {|| Field->cCodTip } ) )

   ( dbfTmpInc )->( OrdSetFocus( "cCodCli" ) )





   dbCreate( cTmpCon, aSqlStruct( aItmContacto() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpCon, cCheckArea( "TmpCon", @dbfTmpCon ), .F. )

   ( dbfTmpCon )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpCon )->( OrdCreate( cTmpCon, "cCodCli", "cCodCli", {|| Field->cCodCli } ) )

   ( dbfTmpCon )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpCon )->( OrdCreate( cTmpCon, "cNomCon", "cNomCon", {|| Field->cNomCon } ) )

   ( dbfTmpCon )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpCon )->( OrdCreate( cTmpCon, "cPosCon", "cPosCon", {|| Field->cPosCon } ) )

   ( dbfTmpCon )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpCon )->( OrdCreate( cTmpCon, "cTelCon", "cTelCon", {|| Field->cTelCon } ) )

   ( dbfTmpCon )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpCon )->( OrdCreate( cTmpCon, "cMovCon", "cMovCon", {|| Field->cMovCon } ) )

   ( dbfTmpCon )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
   ( dbfTmpCon )->( OrdCreate( cTmpCon, "cMaiCon", "cMaiCon", {|| Field->cMaiCon } ) )

   ( dbfTmpCon )->( ordSetFocus( "cCodCli" ) )





   if nMode <> 1

      ( D():Atipicas( nView ) )->( dbGoTop() )

      if ( D():Atipicas( nView ) )->( dbSeek( cCodCli ) )
         while ( ( D():Atipicas( nView ) )->cCodCli == cCodCli ) .AND. ( D():Atipicas( nView ) )->( !eof() )
            dbPass( ( D():Atipicas( nView ) ), dbfTmpAtp, .T. )
            ( D():Atipicas( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpAtp )->( dbGoTop() )

      while !( dbfTmpAtp )->( Eof() )

         if dbLock( dbfTmpAtp )

            if !Empty( ( dbfTmpAtp )->cCodArt )
               ( dbfTmpAtp )->cNomArt     := RetArticulo( ( dbfTmpAtp )->cCodArt )
            end

            if !Empty( ( dbfTmpAtp )->cCodFam )
               ( dbfTmpAtp )->cNomFam     := RetFamilia( ( dbfTmpAtp )->cNomFam )
            end

            ( dbfTmpAtp )->( dbUnlock() )

         end

         ( dbfTmpAtp )->( dbSkip() )

      end

      ( dbfTmpAtp )->( OrdSetFocus( "cCliArt" ) )
      ( dbfTmpAtp )->( dbGoTop() )





      if ( D():ClientesDocumentos( nView ) )->( dbSeek( cCodCli ) )
         while ( ( D():ClientesDocumentos( nView ) )->cCodCli == cCodCli ) .AND. ( D():ClientesDocumentos( nView ) )->( !eof() )
            dbPass( ( D():ClientesDocumentos( nView ) ), dbfTmpDoc, .T. )
            ( D():ClientesDocumentos( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpDoc )->( dbGoTop() )





      if D():gotoIdClientesEntidad( cCodCli, nView )
         while ( D():ClientesEntidadId( nView ) == cCodCli .AND. ( D():ClientesEntidad( nView ) )->( !eof() ) )
            dbPass( ( D():ClientesEntidad( nView ) ), dbfTmpFacturae, .T. )
            ( D():ClientesEntidad( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpFacturae )->( dbGoTop() )





      if D():gotoIdClientesDirecciones( cCodCli, nView )
         while ( D():ClientesDireccionesId( nView ) == cCodCli ) .AND. ( D():ClientesDirecciones( nView ) )->( !eof() )
            dbPass( D():ClientesDirecciones( nView ), dbfTmpObr, .T. )
            ( D():ClientesDirecciones( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpObr )->( dbGoTop() )





      if ( D():ClientesContactos( nView ) )->( dbSeek( cCodCli ) )
         while ( ( D():ClientesContactos( nView ) )->cCodCli == cCodCli ) .AND. ( D():ClientesContactos( nView ) )->( !eof() )
            dbPass( D():ClientesContactos( nView ), dbfTmpCon, .T. )
            ( D():ClientesContactos( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpCon )->( dbGoTop() )





      if ( D():ClientesBancos( nView ) )->( dbSeek( cCodCli ) )
         while ( ( D():ClientesBancos( nView ) )->cCodCli == cCodCli ) .AND. ( D():ClientesBancos( nView ) )->( !eof() )
            dbPass( D():ClientesBancos( nView ), dbfTmpBnc, .T. )
            ( D():ClientesBancos( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpBnc )->( dbGoTop() )





      if ( D():ClientesIncidencias( nView ) )->( dbSeek( cCodCli ) )
         while ( ( D():ClientesIncidencias( nView ) )->cCodCli == cCodCli ) .AND. !( D():Eof( "CliInc", nView ) )
            dbPass( D():ClientesIncidencias( nView ), dbfTmpInc, .T. )
            ( D():ClientesIncidencias( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpInc )->( dbGoTop() )

   end





   oDetCamposExtra:SetTemporal( aTmp[ ( D():Clientes( nView ) )->( fieldpos( "Cod" ) ) ], "", nMode )

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors        := .T.

   end

   ErrorBlock( oBlock )

return ( lErrors )



Static Function KillTrans( oBmpDiv, oBrwBnc, oBrwObr, oBrwCta, oBrwAtp, oBrwInc, oBrwCon )

   if !Empty( oBmpDiv )
      oBmpDiv:end()
   end

   if !Empty( dbfTmpSubCta ) .AND. ( dbfTmpSubCta )->( Used() )
      ( dbfTmpSubCta )->( dbCloseArea() )
   end
   if !Empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end
   if !Empty( dbfTmpFacturae ) .AND. ( dbfTmpFacturae )->( Used() )
      ( dbfTmpFacturae )->( dbCloseArea() )
   end
   if !Empty( dbfTmpObr ) .AND. ( dbfTmpObr )->( Used() )
      ( dbfTmpObr )->( dbCloseArea() )
   end
   if !Empty( dbfTmpBnc ) .AND. ( dbfTmpBnc )->( Used() )
      ( dbfTmpBnc )->( dbCloseArea() )
   end
   if !Empty( dbfTmpCon ) .AND. ( dbfTmpCon )->( Used() )
      ( dbfTmpCon )->( dbCloseArea() )
   end
   if !Empty( dbfTmpAtp ) .AND. ( dbfTmpAtp )->( Used() )
      ( dbfTmpAtp )->( dbCloseArea() )
   end
   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   dbfTmpSubCta   := nil
   dbfTmpDoc      := nil
   dbfTmpFacturae := nil
   dbfTmpObr      := nil
   dbfTmpBnc      := nil
   dbfTmpAtp      := nil
   dbfTmpInc      := nil
   dbfTmpCon      := nil

   dbfErase( cTmpCta )
   dbfErase( cTmpDoc )
   dbfErase( cTmpObr )
   dbfErase( cTmpBnc )
   dbfErase( cTmpAtp )
   dbfErase( cTmpInc )
   dbfErase( cTmpCon )
   dbfErase( cTmpFacturae )

   if oBrwBnc <> nil
      oBrwBnc:CloseData()
   end

   if oBrwObr <> nil
      oBrwObr:CloseData()
   end

   if oBrwCta <> nil
      oBrwCta:CloseData()
   end

   if oBrwAtp <> nil
      oBrwAtp:CloseData()
   end

   if oBrwInc <> nil
      oBrwInc:CloseData()
   end

   if oBrwCon <> nil
      oBrwCon:CloseData()
   end

   ( D():FacturasClientesCobros( nView ) )->( OrdScope( 0, nil ) )
   ( D():FacturasClientesCobros( nView ) )->( OrdScope( 1, nil ) )

Return .T.



STATIC FUNCTION aItmSubcuenta()

   local aBase := {}

   aAdd( aBase, { "nAsiento",  "N",  6, 0, "Asiento"    } )
   aAdd( aBase, { "dFecha",    "D",  8, 0, "Fecha"      } )
   aAdd( aBase, { "cConcepto", "C", 25, 0, "Concepto"   } )
   aAdd( aBase, { "nDebe",     "N", 16, 2, "Debe"       } )
   aAdd( aBase, { "nHaber",    "N", 16, 2, "Haber"      } )
   aAdd( aBase, { "cDeparta",  "C",  6, 0, "Departa"    } )
   aAdd( aBase, { "nFactura",  "N",  8, 0, "Factura"    } )
   aAdd( aBase, { "nBase",     "N", 16, 2, "Base"       } )
   aAdd( aBase, { "nIva",      "N",  5, 2, "I.V.A"      } )

Return ( aBase )



STATIC FUNCTION SavClient( aTmp, aGet, oDlg, oBrw, nMode )

   local cText       := ""
   local cFacAut
   local nVisLun     := ( D():Clientes( nView ) )->nVisLun
   local nVisMar     := ( D():Clientes( nView ) )->nVisMar
   local nVisMie     := ( D():Clientes( nView ) )->nVisMie
   local nVisJue     := ( D():Clientes( nView ) )->nVisJue
   local nVisVie     := ( D():Clientes( nView ) )->nVisVie
   local nVisSab     := ( D():Clientes( nView ) )->nVisSab
   local nVisDom     := ( D():Clientes( nView ) )->nVisDom

   if ( nMode == 1 .OR. nMode == 4 )

      if Empty( aTmp[ 1 ] )
         MsgStop( "Código no puede estar vacío" )
         return nil
      end

      if Existe( aTmp[ 1 ], D():Clientes( nView ), "Cod" )
         MsgStop( "Código ya existe " + Rtrim( aTmp[ 1 ] ) )
         return nil
      end

   end

   if aTmp[ 110 ]

      if Empty( aTmp[ 50 ] )
         MsgStop( "Email no pueden estar vacios" )
         aGet[ 50 ]:SetFocus()
         return nil
      end

      if Empty( aTmp[ 111 ] ) .OR. Len( AllTrim( aTmp[ 111 ] ) ) < 5
         MsgStop( "La contraseña debe tener al menos 5 caracteres" )
         aGet[ 111 ]:SetFocus()
         return nil
      end

   end

   if !Empty( aTmp[ 49 ] ) .AND. ( dbfTmpBnc )->( LastRec() ) == 0
      MsgStop( "Necesita una cuenta bancaria para su cuenta de remesa" )
      return nil
   end





   if aTmp[ 121 ] < 1
      aTmp[ 121 ]  := 1
   end

   if aTmp[ 121 ] < 1 .OR. aTmp[ 121 ] > 6

      msgstop( "La tarifa para combinar debe de estar entre 1 y 6" )

      if !Empty( aGet[ 121 ] )
         aGet[ 121 ]:SetFocus()
      end

      return nil

   end





   if aTmp[ 116 ] < 0 .OR. aTmp[ 116 ] > 6

      MsgStop( "El descuento de artículo a seleccionar debe de estar entre 0 y 6" )

      if !Empty( aGet[ 116 ] )
         aGet[ 116 ]:SetFocus()
      end

      return nil

   end

   if Empty( aTmp[ 2 ] )
      cText    := Space( 6 ) + "* Nombre" + Chr(13)+Chr(10)
   end



   if ( "RISI" $ appParamsMain() )

      if Empty( aTmp[ 48 ] )
         cText := Space( 6 ) + "* Código de grupo" + Chr(13)+Chr(10)
      end

      if Empty( aTmp[ 45 ] )
         cText := Space( 6 ) + "* Código de ruta" + Chr(13)+Chr(10)
      end

   end



   if !Empty( cText )
      msginfo( "Los siguientes campo(s) son obligatorios: " + Chr(13)+Chr(10) + cText )
      return nil
   end

   if Empty( aTmp[ 4 ] )
      cText += Space( 6 ) + "* Domicilio" + Chr(13)+Chr(10)
   end

   if Empty( aTmp[ 5 ] )
      cText += Space( 6 ) + "* Población" + Chr(13)+Chr(10)
   end

   if Empty( aTmp[ 7 ] )
      cText += Space( 6 ) + "* Codigo Postal" + Chr(13)+Chr(10)
   end

   if Empty( aTmp[ 50 ] )
      cText += Space( 6 ) + "* Email" + Chr(13)+Chr(10)
   end

   if Empty( aTmp[ 3 ] )
      cText += Space( 6 ) + "* N.I.F" + Chr(13)+Chr(10)
   end

   if Empty( aTmp[ 8 ] )
      cText += Space( 6 ) + "* Teléfono" + Chr(13)+Chr(10)
   end

   if !Empty( cText )
      if !ApoloMsgNoYes( "Son recomendables introducir los siguientes campo(s): " + Chr(13)+Chr(10) + cText + Chr(13)+Chr(10) + " ¿Desea continuar sin introducirlos?", "Seleccione una opción" )
         return nil
      end
   end





   CursorWait()

   oDlg:Disable()

   oMsgText( "Archivando" )

   oMsgProgress()





   aTmp[ 118 ]     := ""

   for each cFacAut in aFacAut
      aTmp[ 118 ]  += AllTrim( cFacAut ) + ","
   next





   aTmp[ 86 ]     := .T.

   if !Empty( cUsrTik() )
      aTmp[ 99 ]  := cUsrTik()
   else
      aTmp[ 99 ]  := Auth():Codigo()
   end

   aTmp[ 100 ]     := GetSysDate()
   aTmp[ 101 ]     := Time()

   if !Empty( aGet[ 91 ] )
      aTmp[ 91  ]  := aRgbColor[ Min( Max( aGet[ 91 ]:nAt, 1 ), len( aRgbColor ) ) ]
   end

   if !Empty( aGet[ 98 ] )
      aTmp[ 98 ]  := aDescuentosAtipicos[ Min( Max( aGet[ 98 ]:nAt, 1 ), len( aDescuentosAtipicos ) ) ]
   end

   if !Empty( aGet[ 89 ] )
      aTmp[ 89 ]  := aGet[ 89 ]:nAt
   end

   if !Empty( aGet[ 20 ] )
      aTmp[ 20 ]  := aGet[ 20 ]:nAt
   end

   if !Empty( aGet[ 98 ] )
      aTmp[ 98 ]  := aGet[ 98 ]:nAt
   end

   if !Empty( aGet[ 102 ] )
      aTmp[ 102 ]  := aGet[ 102 ]:nAt
   end

   if !Empty( oRTF )
      aTmp[ 109 ]  := oRTF:SaveAsRTF()
   end

   if !Empty( oGetTarifa )
      aTmp[ 40 ]  := oGetTarifa:getTarifa()
   end



   if !Empty( dbfTmpAtp )
      ( dbfTmpAtp )->( dbClearFilter() )
   end





   if !Empty( dbfTmpAtp )

      oMsgText( "Eliminando tarifas anteriores cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpAtp )->( LastRec() ) )

      while ( D():Atipicas( nView ) )->( dbSeek( aTmp[ 1 ] ) ) .AND. !( D():Atipicas( nView ) )->( eof() )
         dbDel( D():Atipicas( nView ) )
      end

      oMsgText( "Archivando tarifas cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpAtp )->( LastRec() ) )

      ( dbfTmpAtp )->( dbGoTop() )
      while ( dbfTmpAtp )->( !eof() )
         dbPass( dbfTmpAtp, ( D():Atipicas( nView ) ), .T., aTmp[ 1 ] )
         ( dbfTmpAtp )->( dbSkip() )
         oMsgProgress():DeltaPos( 1 )
      end

   end





   if !Empty( dbfTmpDoc )

      oMsgText( "Eliminando documentos anteriores cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpDoc )->( LastRec() ) )

      while ( D():ClientesDocumentos( nView ) )->( dbSeek( aTmp[ 1 ] ) )
         dbDel( D():ClientesDocumentos( nView ) )
         oMsgProgress():DeltaPos( 1 )
      end

      oMsgText( "Archivando documentos cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpDoc )->( LastRec() ) )

      ( dbfTmpDoc )->( dbGoTop() )
      while ( dbfTmpDoc )->( !eof() )
         dbPass( dbfTmpDoc, ( D():ClientesDocumentos( nView ) ), .T., aTmp[ 1 ] )
         ( dbfTmpDoc )->( dbSkip() )
         oMsgProgress():DeltaPos( 1 )
      end

   end





   if !Empty( dbfTmpFacturae )

      oMsgText( "Eliminando documentos anteriores cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpFacturae )->( LastRec() ) )

      while ( D():gotoIdClientesEntidad( aTmp[ 1 ], nView ) )
         dbDel( D():ClientesEntidad( nView ) )
         oMsgProgress():DeltaPos( 1 )
      end

      oMsgText( "Archivando documentos cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpFacturae )->( LastRec() ) )

      ( dbfTmpFacturae )->( dbGoTop() )
      while ( dbfTmpFacturae )->( !eof() )
         dbPass( dbfTmpFacturae, ( D():ClientesEntidad( nView ) ), .T., aTmp[ 1 ] )
         ( dbfTmpFacturae )->( dbSkip() )
         oMsgProgress():DeltaPos( 1 )
      end

   end





   if !Empty( dbfTmpObr )

      oMsgText( "Eliminando direcciones anteriores cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpObr )->( LastRec() ) )

      while ( D():ClientesDirecciones( nView ) )->( dbSeek( aTmp[ 1 ] ) )
         dbDel( D():ClientesDirecciones( nView ) )
         oMsgProgress():DeltaPos( 1 )
      end

      oMsgText( "Archivando direcciones cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpObr )->( LastRec() ) )

      ( dbfTmpObr )->( dbGoTop() )
      while ( dbfTmpObr )->( !eof() )
         dbPass( dbfTmpObr, D():ClientesDirecciones( nView ), .T., aTmp[ 1 ] )
         ( dbfTmpObr )->( dbSkip() )
         oMsgProgress():DeltaPos( 1 )
      end

   end





   if !Empty( dbfTmpCon )

      oMsgText( "Eliminando contactos anteriores cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpCon )->( LastRec() ) )

      while ( D():ClientesContactos( nView ) )->( dbSeek( aTmp[ 1 ] ) )
         dbDel( D():ClientesContactos( nView ) )
         oMsgProgress():DeltaPos( 1 )
      end

      oMsgText( "Archivando contactos cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpCon )->( LastRec() ) )

      ( dbfTmpCon )->( dbGoTop() )
      while ( dbfTmpCon )->( !eof() )
         dbPass( dbfTmpCon, D():ClientesContactos( nView ), .T., aTmp[ 1 ] )
         ( dbfTmpCon )->( dbSkip() )
         oMsgProgress():DeltaPos( 1 )
      end

   end





   if !Empty( dbfTmpBnc )

      oMsgText( "Eliminanado bancos anteriores cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpBnc )->( LastRec() ) )

      while ( D():ClientesBancos( nView ) )->( dbSeek( aTmp[ 1 ] ) ) .AND. !( D():ClientesBancos( nView ) )->( eof() )
         dbDel( D():ClientesBancos( nView ) )
         oMsgProgress():DeltaPos( 1 )
      end

      oMsgText( "Archivando bancos cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpBnc )->( LastRec() ) )

      ( dbfTmpBnc )->( dbGoTop() )
      while !( dbfTmpBnc )->( eof() )
         dbPass( dbfTmpBnc, D():ClientesBancos( nView ), .T., aTmp[ 1 ] )
         ( dbfTmpBnc )->( dbSkip() )
         oMsgProgress():DeltaPos( 1 )
      end

   end



   if !Empty( dbfTmpInc )

      oMsgText( "Eliminando incidencias cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpInc )->( LastRec() ) )

      while ( D():ClientesIncidencias( nView ) )->( dbSeek( aTmp[ 1 ] ) )
         dbDel( D():ClientesIncidencias( nView ) )
         oMsgProgress():DeltaPos( 1 )
      end

      ( dbfTmpInc )->( OrdScope( 0, nil ) )
      ( dbfTmpInc )->( OrdScope( 1, nil ) )

      oMsgText( "Archivando incidencias cliente" )
      oMsgProgress():SetRange( 0, ( dbfTmpInc )->( LastRec() ) )

      ( dbfTmpInc )->( dbGoTop() )
      while !( dbfTmpInc )->( eof() )
         dbPass( dbfTmpInc, D():ClientesIncidencias( nView ), .T., aTmp[ 1 ] )
         ( dbfTmpInc )->( dbSkip() )
         oMsgProgress():DeltaPos( 1 )
      end

   end





   oDetCamposExtra:saveExtraField( aTmp[ 1 ], "" )



   WinGather( aTmp, aGet, D():Clientes( nView ), oBrw, nMode )

   if oWndBrw <> nil
      oWndBrw:KillProcess()
   end

   oMsgText()

   if !Empty( oMsgProgress() )
      EndProgress()
   end



   oDlg:Enable()
   oDlg:End( 1 )

   CursorWE()

Return ( .T. )



Static Function FiltroAtipica( oFiltroAtp, dbfTmpAtp, oBrwAtp )

   if Select( dbfTmpAtp ) <> 0

      do case
         case oFiltroAtp:nAt <= 1
            ( dbfTmpAtp )->( dbClearFilter() )

         case oFiltroAtp:nAt == 2
            ( dbfTmpAtp )->( dbSetFilter( {|| ( Empty( Field->dFecIni ) .AND. Empty( Field->dFecFin ) ) .OR. ( Field->dFecIni <= GetSysDate() .AND. Field->dFecFin >= GetSysDate() ) }, "( Empty( dFecIni ) .and. Empty( dFecFin ) ) .or. ( dFecIni <= GetSysDate() .and. dFecFin >= GetSysDate() )" ) )

         case oFiltroAtp:nAt == 3
            ( dbfTmpAtp )->( dbSetFilter( {|| !( ( Empty( Field->dFecIni ) .AND. Empty( Field->dFecFin ) ) .OR. ( Field->dFecIni <= GetSysDate() .AND. Field->dFecFin >= GetSysDate() ) ) }, "!( ( Empty( dFecIni ) .and. Empty( dFecFin ) ) .or. ( dFecIni <= GetSysDate() .and. dFecFin >= GetSysDate() ) )" ) )

      end

      ( dbfTmpAtp )->( dbGoTop() )

      oBrwAtp:Refresh()

   end

Return ( .T. )



Static Function IsCliAtp( aGet, aTmp, oGet, dbfCliAtp, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oCosto, aTmpCli )

    local lReturn    := .T.
   local cCodArt  := Padr( aGet[ 3 ]:VarGet(), 18 )
   local nPreCom  := 0
   local nPreVta  := 0

   if Empty( cCodArt )
      oGet:cText( "" )
      Return ( .T. )
   end

   if nMode == 1

      if dbSeekInOrd( cCodArt, "Codigo", D():Articulos( nView ) )

         if !Empty( oGet )
            oGet:cText( ( D():Articulos( nView ) )->Nombre )
         end

         aTmp[ 6 ] := ( D():Articulos( nView ) )->cCodPrp1
         aTmp[ 8 ] := ( D():Articulos( nView ) )->cCodPrp2

         if !Empty( aTmp[ 6 ] )
            if !Empty( oSayPr1 )
               oSayPr1:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp1, dbfPro ) )
            end
            if !Empty( oSayPr1 )
               oSayPr1:Show()
            end
            if !Empty( aGet[ 7 ] )
               aGet[ 7 ]:Show()
            end
            if !Empty( oSayVp1 )
               oSayVp1:Show()
            end
         else
            if !Empty( oSayPr1 )
               oSayPr1:Hide()
            end
            if !Empty( aGet[ 7 ] )
               aGet[ 7 ]:Hide()
            end
            if !Empty( oSayVp1 )
               oSayVp1:Hide()
            end
         end

         if !Empty( aTmp[ 8 ] )
            if !Empty( oSayPr2 )
               oSayPr2:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp2, dbfPro ) )
            end
            if !Empty( oSayPr2 )
               oSayPr2:Show()
            end
            if !Empty( aGet[ 9 ] )
               aGet[ 9 ]:show()
            end
            if !Empty( oSayVp2 )
               oSayVp2:show()
            end
         else
            if !Empty( oSayPr2 )
               oSayPr2:hide()
            end
            if !Empty( aGet[ 9 ] )
               aGet[ 9 ]:hide()
            end
            if !Empty( oSayVp2 )
               oSayVp2:hide()
            end
         end





         nPreCom           := nComPro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], dbfArtDiv )

         if nPreCom == 0
            nPreCom        := nCosto( nil, D():Articulos( nView ), dbfArtKit, , , , aTmpCli[ 1 ] )
         end

         if !Empty( oCosto )
            oCosto:cText( nPreCom )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 1, .F., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVenta1
         end

         if !Empty( aGet[14 ] )
            aGet[14 ]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 2, .F., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVenta2
         end

         if !Empty( aGet[15] )
            aGet[15]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 3, .F., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVenta3
         end

         if !Empty( aGet[16] )
            aGet[16]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 4, .F., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVenta4
         end

         if !Empty( aGet[17] )
            aGet[17]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 5, .F., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVenta5
         end

         if !Empty( aGet[18] )
            aGet[18]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 6, .F., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVenta6
         end

         if !Empty( aGet[19] )
            aGet[19]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 1, .T., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVtaIva1
         end

         if !Empty( aGet[20] )
            aGet[20]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 2, .T., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVtaIva2
         end

         if !Empty( aGet[21] )
            aGet[21]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 3, .T., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVtaIva3
         end

         if !Empty( aGet[22] )
            aGet[22]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 4, .T., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVtaIva4
         end

         if !Empty( aGet[23] )
            aGet[23]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 5, .T., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVtaIva5
         end

         if !Empty( aGet[24] )
            aGet[24]:cText( nPreVta )
         end





         nPreVta           := nPrePro( cCodArt, aTmp[ 6 ], aTmp[ 7 ], aTmp[ 8 ], aTmp[ 9 ], 6, .T., dbfArtDiv )

         if nPreVta == 0
            nPreVta        := ( D():Articulos( nView ) )->pVtaIva6
         end

         if !Empty( aGet[25] )
            aGet[25]:cText( nPreVta )
         end

      else
         MsgStop( "Código de artículo no encontrado" )
         return .F.
      end

   else

      if ( D():Articulos( nView ) )->( dbSeek( cCodArt ) )

         if !Empty( aTmp[ 6 ] )
            aTmp[ 6 ] := ( D():Articulos( nView ) )->cCodPrp1
         end
         if !Empty( aTmp[ 8 ] )
            aTmp[ 8 ] := ( D():Articulos( nView ) )->cCodPrp2
         end

         if !empty( aTmp[ 6 ] )
            if !Empty( oSayPr1 )
               oSayPr1:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp1, dbfPro ) )
            end
            if !Empty( oSayPr1 )
               oSayPr1:show()
            end
            if !Empty( aGet[ 7 ] )
               aGet[ 7 ]:show()
            end
            if !Empty( oSayVp1 )
               oSayVp1:show()
            end
         else
            if !Empty( oSayPr1 )
               oSayPr1:hide()
            end
            if !Empty( aGet[ 7 ] )
               aGet[ 7 ]:hide()
            end
            if !Empty( oSayVp1 )
               oSayVp1:hide()
            end
         end

         if !empty( aTmp[ 8 ] )
            if !Empty( oSayPr2 )
               oSayPr2:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp2, dbfPro ) )
            end
            if !Empty( oSayPr2 )
               oSayPr2:show()
            end
            if !Empty( aGet[ 9 ] )
               aGet[ 9 ]:show()
            end
            if !Empty( oSayVp2 )
               oSayVp2:show()
            end
         else
            if !Empty( oSayPr2 )
               oSayPr2:hide()
            end
            if !Empty( aGet[ 9 ] )
               aGet[ 9 ]:hide()
            end
            if !Empty( oSayVp2 )
               oSayVp2:hide()
            end
         end

      end

   end

RETURN lReturn



Static Function lArrayRen( nTipPre, oBrwRen, aTmp, aTmpCli, aGetCli, cCosto )

   local nNetoBase
   local nResultado
   local nCosto
   local nDtoAtpico
   local nSbrAtipico

   if empty( aGetCli )
      Return .T.
   end

   nSbrAtipico       := aGetCli[ 98 ]:nAt
   aRentabilidad     := {}



   do case
      case nTipPre == 1
         nNetoBase   := aTmp[ 14 ]
      case nTipPre == 2
         nNetoBase   := aTmp[ 15 ]
      case nTipPre == 3
         nNetoBase   := aTmp[ 16 ]
      case nTipPre == 4
         nNetoBase   := aTmp[ 17 ]
      case nTipPre == 5
         nNetoBase   := aTmp[ 18 ]
      case nTipPre == 6
         nNetoBase   := aTmp[ 19 ]
   end



   if aTmp[ 12 ]
      nCosto         := aTmp[ 13 ]
   else
      nCosto         := cCosto
   end



   aAdd( aRentabilidad, { "Costo", "", nCosto, .F., .F. } )



   aAdd( aRentabilidad, { "Neto base", "", nNetoBase, .F., .F. } )



   if aTmp[ 37 ] <> 0 .AND. aTmp[ 36 ] <> 0

      if ( aTmp[ 37 ] <> 1 .OR. aTmp[ 36 ] <> 1 )

         nResultado := nNetoBase - ( Div( ( nNetoBase * aTmp[ 37 ] ), aTmp[ 36 ] ) )

         aAdd( aRentabilidad, { Space(3) + "Dto. X*Y", AllTrim( Str( aTmp[ 36 ] ) ) + " * " + AllTrim( Str( aTmp[ 37 ] ) ), - ( nResultado ), .F., .F. } )

         nNetoBase -= nResultado

      end

   end



   if aTmp[ 26 ] <> 0

      nResultado := ( ( nNetoBase * aTmp[ 26 ] ) / 100 )

      aAdd( aRentabilidad, { Space(3) + "Dto. art.", AllTrim( Str( aTmp[ 26 ] ) ) + " %", - ( nResultado ), .F., .F. } )

      nNetoBase -= nResultado

   end



   if aTmp[ 30 ] <> 0

      aAdd( aRentabilidad, { Space(3) + "Dto. lineal", Trans( aTmp[ 30 ], cPouDiv( cDivEmp() ) ), - ( aTmp[ 30 ] ), .F., .F. } )

      nNetoBase -= aTmp[ 30 ]

   end



   if aTmp[ 27 ] <> 0

      nResultado := ( ( nNetoBase * aTmp[ 27 ] ) / 100 )

      aAdd( aRentabilidad, { Space(3) + "Dto. promo.", AllTrim( Str( aTmp[ 27 ] ) ) + " %", - ( nResultado ), .F., .F. } )

      nNetoBase -= nResultado

   end



   if aTmp[ 29 ] <> 0

      nResultado := ( ( nNetoBase * aTmp[ 29 ] ) / 100 )

      if aTmp[ 28 ]
         aAdd( aRentabilidad, { Space(3) + "Com. agente", AllTrim( Str( aTmp[ 29 ] ) ) + " %", - ( nResultado ), .F., .F. } )
         nNetoBase -= nResultado
      else
         aAdd( aRentabilidad, { Space(3) + "Com. agente", AllTrim( Str( aTmp[ 29 ] ) ) + " %", nResultado, .F., .F. } )
      end

   end



   if nSbrAtipico == 1 .AND. aTmpCli[ 97 ] <> 0

      nDtoAtpico := ( ( nNetoBase * aTmpCli[ 97 ] ) / 100 )

   end



   if aTmpCli[ 23 ] <> 0

      nResultado := ( ( nNetoBase * aTmpCli[ 23 ] ) / 100 )

      aAdd( aRentabilidad, { Space(3) + AllTrim( aTmpCli[ 22 ] ), AllTrim( Str( aTmpCli[ 23 ] ) ) + " %", - ( nResultado ), .F., .F. } )

      nNetoBase -= nResultado

   end



   if nSbrAtipico == 2 .AND. aTmpCli[ 97 ] <> 0

      nDtoAtpico := ( ( nNetoBase * aTmpCli[ 97 ] ) / 100 )

   end



   if aTmpCli[ 25 ] <> 0

      nResultado := ( ( nNetoBase * aTmpCli[ 25 ] ) / 100 )

      aAdd( aRentabilidad, { Space(3) + AllTRim( aTmpCli[ 24 ] ), AllTrim( Str( aTmpCli[ 25 ] ) ) + " %", - ( nResultado ), .F., .F. } )

      nNetoBase -= nResultado

   end



   if nSbrAtipico == 3 .AND. aTmpCli[ 97 ] <> 0

      nDtoAtpico := ( ( nNetoBase * aTmpCli[ 97 ] ) / 100 )

   end



   if !Empty( aTmpCli[ 28 ] ) .OR. aTmpCli[ 26 ] <> 0

      nResultado := ( ( nNetoBase * aTmpCli[ 26 ] ) / 100 )

      aAdd( aRentabilidad, { Space(3) + aTmpCli[ 28 ], AllTrim( Str( aTmpCli[ 26 ] ) ) + " %", - ( nResultado ), .F., .F. } )

      nNetoBase -= nResultado

   end



   if nSbrAtipico == 4 .AND. aTmpCli[ 97 ] <> 0

      nDtoAtpico := ( ( nNetoBase * aTmpCli[ 97 ] ) / 100 )

   end



   if !Empty( aTmpCli[ 29 ] ) .OR. aTmpCli[ 27 ] <> 0

      nResultado := ( ( nNetoBase * aTmpCli[ 27 ] ) / 100 )

      aAdd( aRentabilidad, { Space(3) + aTmpCli[ 29 ], AllTrim( Str( aTmpCli[ 27 ] ) ) + " %", - ( nResultado ), .F., .F. } )

      nNetoBase -= nResultado

   end



   if nSbrAtipico == 5 .AND. aTmpCli[ 97 ] <> 0

      nDtoAtpico := ( ( nNetoBase * aTmpCli[ 97 ] ) / 100 )

   end

   if aTmpCli[ 97 ] <> 0



      aAdd( aRentabilidad, { "Neto sin " + aTmpCli[ 96 ] , "", nNetoBase, .F., .F. } )



      aAdd( aRentabilidad, { Space(3) + aTmpCli[ 96 ], AllTrim( Str( aTmpCli[ 97 ] ) ) + " %", - ( nDtoAtpico ), .F., .F. } )

      nNetoBase   -= nDtoAtpico

   end



   aAdd( aRentabilidad, { "Tarifa neta", "", nNetoBase, .F., .F. } )



   nResultado := nNetoBase - nCosto

   aAdd( aRentabilidad, { "Margen unidades", "", nResultado, .F., .F. } )



   nResultado := ( nNetoBase - nCosto ) * ( D():Articulos( nView ) )->nUniCaja

   aAdd( aRentabilidad, { "Margen cajas", Trans( ( D():Articulos( nView ) )->nUniCaja, MasUnd() ), nResultado, .F., .F. } )



   nResultado :=  ( Div( nNetoBase, nCosto ) - 1 ) * 100

   aAdd( aRentabilidad, { "Rent. costo", "", nResultado, .T., .F. } )



   aAdd( aRentabilidad, { "Rent. mínima", "", ( D():Articulos( nView ) )->nRenMin, .T., if( ( D():Articulos( nView ) )->nRenMin > nResultado, .T., .F. ) } )



   aAdd( aRentabilidad, { "Ratio maniobra", "", nResultado - ( D():Articulos( nView ) )->nRenMin, .T., .F. } )



   nResultado :=  Div( ( nNetoBase - nCosto ), nNetoBase ) * 100

   aAdd( aRentabilidad, { "% Margen venta", "", nResultado, .T., .F. } )





   oBrwRen:nAt       := 1
   oBrwRen:SetArray( aRentabilidad )
   oBrwRen:Refresh()

Return .T.



Static Function ChangeNaturaleza( aGet, aTmp, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oGetArticulo, oGetFamilia, oCosto, nMode, oSayLabels, lInit, oBtnEscandallo, oSayTar )

   If( lInit == nil, lInit := .F., ) ;

   if nMode == 1

      if !Empty( oGetArticulo )
         oGetArticulo:cText( "" )
      end
      if !Empty( oGetFamilia )
         oGetFamilia:cText( "" )
      end

      if !Empty( oCosto )
         oCosto:cText( 0 )
      end

      if !Empty( aGet[ 3  ] )
         aGet[ 3  ]:cText( Space( 18 ) )
      end
      if !Empty( aGet[ 4  ] )
         aGet[ 4  ]:cText( Space( 5 ) )
      end
      if !Empty( aGet[ 13  ] )
         aGet[ 13  ]:cText( 0 )
      end
      if !Empty( aGet[ 14  ] )
            aGet[ 14  ]:cText( 0 )
      end
      if !Empty( aGet[ 15 ] )
            aGet[ 15 ]:cText( 0 )
      end
      if !Empty( aGet[ 16 ] )
            aGet[ 16 ]:cText( 0 )
      end
      if !Empty( aGet[ 17 ] )
            aGet[ 17 ]:cText( 0 )
      end
      if !Empty( aGet[ 18 ] )
            aGet[ 18 ]:cText( 0 )
      end
      if !Empty( aGet[ 19 ] )
            aGet[ 19 ]:cText( 0 )
      end
      if !Empty( aGet[ 20 ] )
            aGet[ 20 ]:cText( 0 )
      end
      if !Empty( aGet[ 21 ] )
            aGet[ 21 ]:cText( 0 )
      end
      if !Empty( aGet[ 22 ] )
            aGet[ 22 ]:cText( 0 )
      end
      if !Empty( aGet[ 23 ] )
            aGet[ 23 ]:cText( 0 )
      end
      if !Empty( aGet[ 24 ] )
            aGet[ 24 ]:cText( 0 )
      end
      if !Empty( aGet[ 25 ] )
            aGet[ 25 ]:cText( 0 )
      end

      if !Empty( aTmp[ 52 ] )
         aTmp[ 52 ] := 0
      end

   end

   if aGet[ 5 ]:nAt == 1

      if !Empty( aGet[ 3 ] )
         aGet[ 3 ]:Show()
      end
      if !Empty( oGetArticulo )
         oGetArticulo:Show()
      end

      if !Empty( oBtnEscandallo )
         oBtnEscandallo:Show()
      end

      if !Empty( aGet[ 4 ] )
         aGet[ 4 ]:Hide()
      end
      if !Empty( oGetFamilia )
         oGetFamilia:Hide()
      end

      if !Empty( aGet[ 52 ] )
         aGet[ 52 ]:oControl:Hide()
      end

      if !Empty( oSayTar )
         oSayTar:Hide()
      end

      if !lInit

         if !Empty( oSayPr1 )
            oSayPr1:Hide()
         end

         if !Empty( oSayPr2 )
            oSayPr2:Hide()
         end

         if !Empty( oSayVp1 )
            oSayVp1:SetText( Space(10) )
         end

         if !Empty( oSayVp2 )
            oSayVp2:SetText( Space(10) )
         end

         if !Empty( oSayVp1 )
            oSayVp1:Hide()
         end

         if !Empty( oSayVp2 )
            oSayVp2:Hide()
         end

         if !Empty( aGet[ 7 ] )
            aGet[ 7 ]:cText( Space(10) )
         end

         if !Empty( aGet[ 9 ] )
            aGet[ 9 ]:cText( Space(10) )
         end

         if !Empty( aGet[ 7 ] )
            aGet[ 7 ]:Hide()
         end

         if !Empty( aGet[ 9 ] )
            aGet[ 9 ]:Hide()
         end

      end

      if !Empty( oCosto )
         oCosto:Show()
      end

      if !Empty( aGet[ 12  ] )
         aGet[ 12  ]:Show()
      end

      if !Empty( aGet[ 13  ] )
         aGet[ 13  ]:Show()
      end

      if !Empty( aGet[ 14  ] )
          aGet[ 14  ]:Show()
      end

      if !Empty( aGet[ 15 ] )
         aGet[ 15 ]:Show()
      end

      if !Empty( aGet[ 16 ] )
         aGet[ 16 ]:Show()
      end

      if !Empty( aGet[ 17 ] )
         aGet[ 17 ]:Show()
      end

      if !Empty( aGet[ 18 ] )
         aGet[ 18 ]:Show()
      end

      if !Empty( aGet[ 19 ] )
         aGet[ 19 ]:Show()
      end

      if !Empty( aGet[ 20 ] )
         aGet[ 20 ]:Show()
      end

      if !Empty( aGet[ 21 ] )
         aGet[ 21 ]:Show()
      end

      if !Empty( aGet[ 22 ] )
         aGet[ 22 ]:Show()
      end

      if !Empty( aGet[ 23 ] )
         aGet[ 23 ]:Show()
      end

      if !Empty( aGet[ 24 ] )
         aGet[ 24 ]:Show()
      end

      if !Empty( aGet[ 25 ] )
         aGet[ 25 ]:Show()
      end

      if !Empty( aGet[ 39    ] )
         aGet[ 39    ]:Show()
      end

      if !Empty( aGet[ 40    ] )
         aGet[ 40    ]:Show()
      end

      if !Empty( aGet[ 41    ] )
         aGet[ 41    ]:Show()
      end

      if !Empty( aGet[ 42    ] )
         aGet[ 42    ]:Show()
      end

      if !Empty( aGet[ 43    ] )
         aGet[ 43    ]:Show()
      end

      if !Empty( aGet[ 44    ] )
         aGet[ 44    ]:Show()
      end

      if !Empty( oSayLabels )
         aEval( oSayLabels, {|o| o:Show() } )
      end

   else

      if !Empty( aGet[ 3 ] )
         aGet[ 3 ]:Hide()
      end
      if !Empty( oGetArticulo )
         oGetArticulo:Hide()
      end

      if !Empty( oBtnEscandallo )
         oBtnEscandallo:Hide()
      end

      if !Empty( aGet[ 4 ] )
         aGet[ 4 ]:Show()
      end
      if !Empty( oGetFamilia )
         oGetFamilia:Show()
      end

      if !Empty( aGet[ 52 ] )
         aGet[ 52 ]:oControl:Show()
      end

      if !Empty( oSayTar )
         oSayTar:Show()
      end

      if !Empty( oSayPr1 )
         oSayPr1:Hide()
      end
      if !Empty( oSayPr2 )
         oSayPr2:Hide()
      end

      if !Empty( oSayVp1 )
         oSayVp1:SetText( Space(10) )
      end
      if !Empty( oSayVp2 )
         oSayVp2:SetText( Space(10) )
      end

      if !Empty( oSayVp1 )
         oSayVp1:Hide()
      end
      if !Empty( oSayVp2 )
         oSayVp2:Hide()
      end

      if !Empty( aGet[ 7 ] )
         aGet[ 7 ]:cText( Space(10) )
      end
      if !Empty( aGet[ 9 ] )
         aGet[ 9 ]:cText( Space(10) )
      end

      if !Empty( aGet[ 7 ] )
         aGet[ 7 ]:Hide()
      end
      if !Empty( aGet[ 9 ] )
         aGet[ 9 ]:Hide()
      end

      if !Empty( oCosto )
         oCosto:Hide()
      end

      if !Empty( aGet[ 12  ] )
         aGet[ 12  ]:Hide()
      end

      if !Empty( aGet[ 13  ] )
         aGet[ 13  ]:Hide()
      end
      if !Empty( aGet[ 14  ] )
         aGet[ 14  ]:Hide()
      end
      if !Empty( aGet[ 15 ] )
         aGet[ 15 ]:Hide()
      end
      if !Empty( aGet[ 16 ] )
         aGet[ 16 ]:Hide()
      end
      if !Empty( aGet[ 17 ] )
         aGet[ 17 ]:Hide()
      end
      if !Empty( aGet[ 18 ] )
         aGet[ 18 ]:Hide()
      end
      if !Empty( aGet[ 19 ] )
         aGet[ 19 ]:Hide()
      end

      if !Empty( aGet[ 20 ] )
         aGet[ 20 ]:Hide()
      end
      if !Empty( aGet[ 21 ] )
         aGet[ 21 ]:Hide()
      end
      if !Empty( aGet[ 22 ] )
         aGet[ 22 ]:Hide()
      end
      if !Empty( aGet[ 23 ] )
         aGet[ 23 ]:Hide()
      end
      if !Empty( aGet[ 24 ] )
         aGet[ 24 ]:Hide()
      end
      if !Empty( aGet[ 25 ] )
         aGet[ 25 ]:Hide()
      end

      if !Empty( aGet[ 39    ] )
         aGet[ 39    ]:Hide()
      end
      if !Empty( aGet[ 40    ] )
         aGet[ 40    ]:Hide()
      end
      if !Empty( aGet[ 41    ] )
         aGet[ 41    ]:Hide()
      end
      if !Empty( aGet[ 42    ] )
         aGet[ 42    ]:Hide()
      end
      if !Empty( aGet[ 43    ] )
         aGet[ 43    ]:Hide()
      end
      if !Empty( aGet[ 44    ] )
         aGet[ 44    ]:Hide()
      end

      if !Empty( oSayLabels )
         aEval( oSayLabels, {|o| o:Hide() } )
      end

   end

Return nil



static function SaveEdtAtp( aGet, aTmp, dbfTmpAtp, oBrw, oDlg, nMode )

   if aTmp[ 10 ] > aTmp[ 11 ]
      MsgStop( "Fechas no validas" )
      return .F.
   end

   if nMode == 1

      if Empty( aTmp[ 3 ] ) .AND. aGet[ 5 ]:nAt <= 1
         MsgStop( "Código de artículo no puede estar vacío" )
         aGet[ 3 ]:SetFocus()
         return .F.
      end

      if dbSeekAtp( aTmp, dbfTmpAtp, .F. ) .AND. aGet[ 5 ]:nAt <= 1
         msgStop( "Código de artículo ya en tarifa para el rango de fechas" )
         return nil
      end

      if Empty( aTmp[ 4 ] ) .AND. aGet[ 5 ]:nAt == 2
         MsgStop( "Código de família no puede estar vacío" )
         aGet[ 4 ]:SetFocus()
         return .F.
      end

      if dbSeekAtp( aTmp, dbfTmpAtp, .T. ) .AND. aGet[ 5 ]:nAt == 2
         msgStop( "Código de familia ya en tarifa para el rango de fechas" )
         return .F.
      end

   end





   CursorWait()

   oDlg:Disable()

   aTmp[ 5 ]    := aGet[ 5 ]:nAt

   if !Empty( aGet[ 52 ] )
      aTmp[ 52 ]  := aGet[ 52 ]:getTarifa()
   end

   aTmp[ 48 ]    := RetArticulo( aTmp[ 3 ] )
   aTmp[ 49 ]    := RetFamilia( aTmp[ 4 ] )

   WinGather( aTmp, aGet, dbfTmpAtp, oBrw, nMode )

   oDlg:Enable()

   CursorWE()

RETURN ( oDlg:end( 1 ) )



Static Function dbSeekAtp( aTmp, dbfTmpAtp, lFam )

   local lSeek := .F.
   local nOrdAnt

   if lFam
      nOrdAnt  := ( dbfTmpAtp )->( OrdSetFocus( "cCodFam" ) )
      if ( dbfTmpAtp )->( dbSeek( aTmp[ 4 ] ) )
         if ( dbfTmpAtp )->dFecFin >= aTmp[ 10 ] .AND. !Empty( aTmp[ 10 ] )
            lSeek := .T.
         end
      end
      ( dbfTmpAtp )->( OrdSetFocus( nOrdAnt ) )
   else
      nOrdAnt  := ( dbfTmpAtp )->( OrdSetFocus( "cCliArt" ) )
      if ( dbfTmpAtp )->( dbSeek( aTmp[ 3 ] + aTmp[ 6 ] + aTmp[ 8 ] + aTmp[ 7 ] + aTmp[ 9 ] ) )
         if ( dbfTmpAtp )->dFecFin >= aTmp[ 10 ] .AND. !Empty( aTmp[ 10 ] )
            lSeek := .T.
         end
      end
      ( dbfTmpAtp )->( OrdSetFocus( nOrdAnt ) )
   end

Return ( lSeek )



Static Function CalIva( nPrecio, lIvaInc, cTipIva, cCodImp, oGetIva )

   local nIvaPct  := nIva( D():TiposIva( nView ), cTipIva )





   if !Empty( cCodImp ) .AND. !Empty( oNewImp )
      nPrecio     += oNewImp:nValImp( cCodImp, .T., nIvaPct )
   end





   nPrecio        += ( nPrecio * nIvaPct / 100 )

   if oGetIva <> NIL
      oGetIva:cText( nPrecio )
   end

Return .T.



Static Function CalBas( nPrecio, lIvaInc, cTipIva, cCodImp, oGetBas )

   local nNewPre
   local nIvaPct  := nIva( D():TiposIva( nView ), cTipIva )





   nNewPre        := Div( nPrecio, ( 1 + nIvaPct / 100 ) )





   if !Empty( cCodImp ) .AND. !Empty( oNewImp )
      nNewPre     -= oNewImp:nValImp( cCodImp, lIvaInc , nIvaPct )
   end





   oGetBas:cText( nNewPre )

Return .T.



Function nCalIva( nPrecio, lIvaInc, cTipIva, cCodImp )

   local nIvaPct  := nIva( D():TiposIva( nView ), cTipIva )





   if !Empty( cCodImp ) .AND. !Empty( oNewImp )
      nPrecio     += oNewImp:nValImp( cCodImp, .T., nIvaPct )
   end





   nPrecio        += ( nPrecio * nIvaPct / 100 )

Return nPrecio



Function nCalBas( nPrecio, lIvaInc, cTipIva, cCodImp )

   local nNewPre
   local nIvaPct  := nIva( D():TiposIva( nView ), cTipIva )





   nNewPre        := Div( nPrecio, ( 1 + nIvaPct / 100 ) )





   if !Empty( cCodImp ) .AND. !Empty( oNewImp )
      nNewPre     -= oNewImp:nValImp( cCodImp, lIvaInc , nIvaPct )
   end

Return nNewPre



Static Function DataReport( oFr, lTemporal )





   oFr:ClearDataSets()

   if lTemporal
      oFr:SetWorkArea(  "Clientes",          ( tmpClient )->( Select() ), .F., { 0, 0, 0 } )
   else
      oFr:SetWorkArea(  "Clientes",          ( D():Clientes( nView ) )->( Select() ), .F., { 0, 0, 0 } )
   end
   oFr:SetFieldAliases( "Clientes",          cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Documetos",         ( D():ClientesDocumentos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Documetos",         cItemsToReport( aCliDoc() ) )

   oFr:SetWorkArea(     "Tarifas clientes",  ( D():Atipicas( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Tarifas clientes",  cItemsToReport( aItmAtp() ) )

   oFr:SetWorkArea(     "Direcciones",       ( D():ClientesDirecciones( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Direcciones",       cItemsToReport( aItmObr() ) )

   oFr:SetWorkArea(     "Contactos",         ( D():ClientesContactos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Contactos",         cItemsToReport( aItmContacto() ) )

   oFr:SetWorkArea(     "Bancos",            ( D():ClientesBancos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Bancos",            cItemsToReport( aCliBnc() ) )

   oFr:SetWorkArea(     "Incidencias",       ( D():ClientesIncidencias( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias",       cItemsToReport( aCliInc() ) )

   oFr:SetWorkArea(     "Rutas",             ( dbfRuta )->( Select() ) )
   oFr:SetFieldAliases( "Rutas",             cItemsToReport( aItmRut() ) )

   oFr:SetWorkArea(     "Agentes",           ( cAgente )->( Select() ) )
   oFr:SetFieldAliases( "Agentes",           cItemsToReport( aItmAge() ) )

   oFr:SetWorkArea(     "Formas de pago",    ( dbfFPago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago",    cItemsToReport( aItmFPago() ) )

   if lTemporal
      oFr:SetMasterDetail( "Clientes",       "Documentos",        {|| ( tmpClient )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Tarifas clientes",  {|| ( tmpClient )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Direcciones",       {|| ( tmpClient )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Contactos",         {|| ( tmpClient )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Bancos",            {|| ( tmpClient )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Incidencias",       {|| ( tmpClient )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Rutas",             {|| ( tmpClient )->cCodRut } )
      oFr:SetMasterDetail( "Clientes",       "Agentes",           {|| ( tmpClient )->cAgente } )
      oFr:SetMasterDetail( "Clientes",       "Formas de pago",    {|| ( tmpClient )->CodPago } )
   else
      oFr:SetMasterDetail( "Clientes",       "Documentos",        {|| ( D():Clientes( nView ) )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Tarifas clientes",  {|| ( D():Clientes( nView ) )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Direcciones",       {|| ( D():Clientes( nView ) )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Contactos",         {|| ( D():Clientes( nView ) )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Bancos",            {|| ( D():Clientes( nView ) )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Incidencias",       {|| ( D():Clientes( nView ) )->Cod } )
      oFr:SetMasterDetail( "Clientes",       "Rutas",             {|| ( D():Clientes( nView ) )->cCodRut } )
      oFr:SetMasterDetail( "Clientes",       "Agentes",           {|| ( D():Clientes( nView ) )->cAgente } )
      oFr:SetMasterDetail( "Clientes",       "Formas de pago",    {|| ( D():Clientes( nView ) )->CodPago } )
   end

   oFr:SetResyncPair(      "Clientes",       "Documentos" )
   oFr:SetResyncPair(      "Clientes",       "Tarifas clientes" )
   oFr:SetResyncPair(      "Clientes",       "Direcciones" )
   oFr:SetResyncPair(      "Clientes",       "Contactos" )
   oFr:SetResyncPair(      "Clientes",       "Bancos" )
   oFr:SetResyncPair(      "Clientes",       "Incidencias" )

   oFr:SetResyncPair(      "Clientes",       "Rutas" )
   oFr:SetResyncPair(      "Clientes",       "Agentes" )
   oFr:SetResyncPair(      "Clientes",       "Formas de pago" )

Return nil



Function DesignReportClient( oFr, dbfDoc )

   local oLabel
   local nRec
   local nOrd
   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
      nRec        := ( D():Clientes( nView ) )->( Recno() )
      nOrd        := ( D():Clientes( nView ) )->( OrdSetFocus( "Cod" ) )
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag

      oLabel      := TClienteLabelGenerator()

      if oLabel:lCreateTemporal()





         DataReport( oFr, .T. )





         if !Empty( ( dbfDoc )->mReport )

            oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

         else

            oFr:AddPage(         "MainPage" )

            oFr:AddBand(         "MasterData",  "MainPage",       6 )
            oFr:SetProperty(     "MasterData",  "Top",            200 )
            oFr:SetProperty(     "MasterData",  "Height",         100 )
            oFr:SetObjProperty(  "MasterData",  "DataSet",        "Clientes" )

         end





         oFr:DesignReport()





         oFr:DestroyFr()





         oLabel:DestroyTemporal()

      else

         Return .F.

      end

   end

   if !Empty( nRec )
      ( D():Clientes( nView ) )->( dbGoTo( nRec ) )
   end

   if !Empty( nOrd )
      ( D():Clientes( nView ) )->( OrdSetFocus( nOrd ) )
   end

   if lOpen
      CloseFiles()
   end

Return .T.



Function PrintReportCliente( nDevice, nCopies, cPrinter, dbfDoc )

   local oFr

   If( nDevice == nil, nDevice := 2, ) ;
   If( nCopies == nil, nCopies := 1, ) ;

   If( cPrinter == nil, cPrinter := ImpresoraDefectoUsuario(), ) ;

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr, .T. )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      oFr:PrepareReport()





      do case
         case nDevice == 2

            oFr:ShowPreparedReport()

         case nDevice == 1

            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3

            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:DoExport(     "PDFExport" )

      end

   end





   oFr:DestroyFr()

Return .T.



Static Function lPubInt( nMode, aTmp )

   if nMode <> 1
      aTmp[ 112 ]  := 0
   end

Return ( nil )



Static Function lArticuloEnOferta( cCodigoArticulo, cCodigoCliente, cCodigoGrupo )

   local lOferta     := .F.

   if ( dbfOfe )->( dbSeek( cCodigoArticulo ) )

      while ( dbfOfe )->cArtOfe == cCodigoArticulo .AND. !( dbfOfe )->( eof() )







         if ( GetSysDate() >= ( dbfOfe )->dIniOfe .OR. Empty( ( dbfOfe )->dIniOfe ) ) .AND.  ( GetSysDate() <= ( dbfOfe )->dFinOfe .OR. Empty( ( dbfOfe )->dFinOfe ) ) .AND.  ( ( dbfOfe )->nCliOfe == 1 .OR. ( ( dbfOfe )->nCliOfe == 2 .AND. cCodigoCliente == ( dbfOfe )->cCliOfe ) .OR. ( ( dbfOfe )->nCliOfe == 3 .AND. cCodigoGrupo == ( dbfOfe )->cGrpOfe ) )

            lOferta  := .T.

            exit

         end

         ( dbfOfe )->( dbSkip() )

      end

   end

Return ( lOferta )



FUNCTION BrwCli( oGet, oGet2, dbfCli )

   local oDlg
   local oBrw
   local hBmp
   local oGet1
   local cGet1
   local nOrd     := GetBrwOpt( "BrwCli" )
   local oCbxOrd
   local aCbxOrd  := { "Código", "Nombre", "NIF/CIF", "Teléfono", "Establecimiento", "Población" }
   local cCbxOrd
   local cReturn  := Space( 12 )

   nOrd           := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd        := aCbxOrd[ nOrd ]

   nOrd           := ( dbfCli )->( OrdSetFocus( nOrd ) )

   ( dbfCli )->( dbGoTop() )



   oDlg = TDialog():New(,,,, "Seleccionar clientes", "HelpEntry",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,,,,,,,, .F.,, {|nKey,nFlags,Self| AutoSeek( nKey, nFlags, Self, oBrw, dbfCli ) }, .F., .F.,,,,,, nil, "FIND",, )






      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfCli )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:Refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfCli
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Browse.Clientes.Report"

      with object ( oBrw:AddCol() )
         :cHeader          := "Bl. Bloqueado"
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfCli )->lBlqCli }
         :nWidth           := 20
         :SetCheck( { "Cnt16", "Nil16" } )
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Código"
         :cSortOrder       := "Cod"
         :bEditValue       := {|| ( dbfCli )->Cod }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "Titulo"
         :bEditValue       := {|| ( dbfCli )->Titulo }
         :nWidth           := 280
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "NIF/CIF"
         :cSortOrder       := "Nif"
         :bEditValue       := {|| ( dbfCli )->Nif }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Teléfono"
         :cSortOrder       := "Telefono"
         :bEditValue       := {|| ( dbfCli )->Telefono }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fax"
         :bEditValue       := {|| ( dbfCli )->Fax }
         :nWidth           := 80
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Domicilio"
         :bEditValue       := {|| ( dbfCli )->Domicilio }
         :nWidth           := 300
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Población"
         :bEditValue       := {|| ( dbfCli )->Poblacion }
         :nWidth           := 200
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Codigo postal"
         :bEditValue       := {|| ( dbfCli )->CodPostal }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Provincia"
         :bEditValue       := {|| ( dbfCli )->Provincia }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Establecimiento"
         :cSortOrder       := "NbrEst"
         :bEditValue       := {|| ( dbfCli )->NbrEst }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Correo electrónico"
         :bEditValue       := {|| ( dbfCli )->cMeiInt }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Riesgo"
         :bEditValue       := {|| Trans( ( dbfCli )->Riesgo, PicOut() ) }
         :nWidth           := 60
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Contacto"
         :bEditValue       := {|| ( dbfCli )->cPerCto }
         :nWidth           := 100
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Observaciones"
         :bEditValue       := {|| ( dbfCli )->mComent }
         :nWidth           := 200
      end

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }
      oBrw:bRClicked       := {| nRow, nCol, nFlags | oBrw:RButtonDown( nRow, nCol, nFlags ) }

      oBrw:CreateFromResource( 105 )




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||              .F.},,, .F. )





      TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||              .F.},,, .F. )

   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )

   oDlg:bStart             :=    {|| if( !IsReport(), oBrw:Load(), ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   CursorWait()

   if oDlg:nResult == 1

      cReturn  := ( dbfCli )->Cod

      if !Empty( oGet )
         oGet:cText( ( dbfCli )->Cod )
         oGet:lValid()
      end

      if ValType( oGet2 ) == "O"
         oGet2:cText( ( dbfCli)->Titulo )
         if ( dbfCli )->nColor <> 0
            oGet2:SetColor( , ( dbfCli )->nColor )
         end
      end

   end

   SetBrwOpt( "BrwCli", ( dbfCli )->( OrdNumber() ) )

   ( dbfCli )->( OrdSetFocus( nOrd ) )

   if !Empty( oBrw )
      oBrw:end()
   end

   CursorWE()

   if !Empty( oGet )
      oGet:SetFocus()
   end

RETURN cReturn






FUNCTION cCtaBanCli( cCodCli, cDbfBanco )

   local nRec
   local oBlock
   local oError
   local nOrdAnt
   local cText    := ""
   local lClose   := .F.

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if Empty( cDbfBanco )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliBnc.Dbf" ), ( cCheckArea( "CLIBNC", @cDbfBanco ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CliBnc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CCODDEF" )
      lClose      := .T.
   else
      nRec        := ( cDbfBanco )->( Recno() )
      nOrdAnt     := ( cDbfBanco )->( OrdSetFocus( "cCodDef" ) )
   end

   if ( cDbfBanco )->( dbSeek( cCodCli ) )
      cText       := ( cDbfBanco )->cCtaBnc
   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de bancos" )

   end
   ErrorBlock( oBlock )

   if lClose
      ( cDbfBanco )->( dbCloseArea() )
   else
      ( cDbfBanco )->( OrdSetFocus( nOrdAnt ) )
      ( cDbfBanco )->( dbGoTo( nRec ) )
   end

Return ( cText )






FUNCTION cCliCta( cCodCli, dbfCli )

   local oBlock
   local oError
   local cText    := ""
   local lClose   := .F.

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if Empty( dbfCli )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfCli ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose      := .T.
   end

   if dbSeekInOrd( cCodCli, "Cod", dbfCli )
      cText       := Rtrim( ( dbfCli )->SubCta )
   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de clientes" )

   end
   ErrorBlock( oBlock )

   IF lClose
      ( dbfCli )->( dbCloseArea() )
   end

RETURN cText







FUNCTION cCliCtaVta( cCodCli, dbfCli )

   local oBlock
   local oError
   local lClose      := .F.
   local cCliCtaVta  := ""

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if Empty( dbfCli )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfCli ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose         := .T.
   end

   if dbSeekInOrd( cCodCli, "Cod", dbfCli )
      cCliCtaVta     := ( dbfCli )->CtaVenta
   end

   if Empty( cCliCtaVta )
      cCliCtaVta     := cCtaCli()
   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de clientes" )

   end
   ErrorBlock( oBlock )

   if lClose
      ( dbfCli )->( dbCloseArea() )
   end

RETURN ( cCliCtaVta )



FUNCTION cBanco( cCodCli, dbfCli )

   local oBlock
   local oError
   local cText    := ""
   local lClose   := .F.

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if Empty( dbfCli )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfCli ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose      := .T.
   end

   IF ( dbfCli )->( dbSeek( Rjust( cCodCli, "0" ) ) )
      cText       := ( dbfCli )->Banco
   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de clientes" )

   end
   ErrorBlock( oBlock )

   IF lClose
      ( dbfCli )->( dbCloseArea() )
   end

RETURN cText



FUNCTION lClienteBloquearRiesgo( cCodCli, dbfCli )

   local lRet        := .F.

   if dbSeekInOrd( cCodCli, "Cod", dbfCli )
      lRet           := ( dbfCli )->lCreSol
   end

RETURN lRet



Function lClienteRiesgoAlcanzado( cCodCli, oStock, dbfClient, nImporte, nMode )

   local nRiesgoAlcanzado  := 0

   If( nImporte == nil, nImporte := 0, ) ;
   If( nMode == nil, nMode := 1, ) ;

   if !lClienteBloquearRiesgo( cCodCli, dbfClient )
      Return .F.
   end

   nRiesgoAlcanzado          := oStock:nRiesgo( cCodCli )

   if ( nMode == 1 .OR. nMode == 4 )
      nRiesgoAlcanzado       += nImporte
   end

   if nRiesgoAlcanzado >= ( dbfClient )->Riesgo
      Return .T.
   end

Return .F.



FUNCTION BrwBncCli( oGet, oPaisIBAN, oControlIBAN, oEntBnc, oSucBnc, oDigBnc, oCtaBnc, cCodCli, cDbfBancos )

   local oDlg
   local oBrw
   local oFont
   local oBtn
   local oGet1
   local cGet1
   local nOrd        := GetBrwOpt( "BrwBancos" )
   local oCbxOrd
   local aCbxOrd     := { "Nombre", "Cuenta" }
   local cCbxOrd     := "Nombre"
   local nLevel      := Auth():Level( "01032" )
   local lClose      := .F.

   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   if Empty( cCodCli )
      MsgStop( "Es necesario codificar un cliente" )
      return .T.
   end

   if !lExistTable( cPatEmp() + "CliBnc.Dbf" )
      MsgStop( "No existe el fichero de bancos" )
      Return .F.
   end

   if Empty( cDbfBancos )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliBnc.Dbf" ), ( cCheckArea( "CLIBNC", @cDbfBancos ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CliBnc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose         := .T.
   end

   ( cDbfBancos )->( ordSetFocus( nOrd ) )

   ( cDbfBancos )->( OrdScope( 0, cCodCli ) )
   ( cDbfBancos )->( OrdScope( 1, cCodCli ) )
   ( cDbfBancos )->( dbGoTop() )



   oDlg = TDialog():New(,,,, "Seleccionar banco", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,,,,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, cDbfBancos, nil, cCodCli ) ) }, .F., .F.,,,,,, nil, "Find",, )










      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|(  ( cDbfBancos )->( OrdSetFocus( oCbxOrd:nAt ) ), ( cDbfBancos )->( OrdScope( 0, cCodCli ) ), ( cDbfBancos )->( OrdScope( 1, cCodCli ) ), oBrw:Refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := cDbfBancos
      oBrw:nMarqueeStyle   := 5

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| ( cDbfBancos )->cCodBnc }
         :nWidth           := 200
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cuenta"
         :cSortOrder       := "cCtaBnc"
         :bEditValue       := {|| PictureCuentaIBAN( cDbfBancos ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Domicilio"
         :bEditValue       := {|| ( cDbfBancos )->cDirBnc }
         :nWidth           := 120
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Población"
         :bEditValue       := {|| ( cDbfBancos )->cPobBnc }
         :nWidth           := 100
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Código postal"
         :bEditValue       := {|| ( cDbfBancos )->cCPBnc }
         :nWidth           := 40
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Provincia"
         :bEditValue       := {|| ( cDbfBancos )->cProBnc }
         :nWidth           := 80
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Teléfono"
         :bEditValue       := {|| ( cDbfBancos )->cTlfBnc }
         :nWidth           := 80
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fax"
         :bEditValue       := {|| ( cDbfBancos )->cFaxBnc }
         :nWidth           := 80
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Contacto"
         :bEditValue       := {|| ( cDbfBancos )->cPContBnc }
         :nWidth           := 140
      end

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )





      TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





      TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )

   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGet:cText( ( cDbfBancos )->cCodBnc )
      oPaisIBAN:cText( ( cDbfBancos )->cPaisIBAN )
      oControlIBAN:cText( ( cDbfBancos )->cCtrlIBAN )
      oEntBnc:cText( ( cDbfBancos )->cEntBnc )
      oSucBnc:cText( ( cDbfBancos )->cSucBnc )
      oDigBnc:cText( ( cDbfBancos )->cDigBnc )
      oCtaBnc:cText( ( cDbfBancos )->cCtaBnc )
   end

   DestroyFastFilter( cDbfBancos )

   SetBrwOpt( "BrwBancos", ( cDbfBancos )->( OrdNumber() ) )

   if lClose
      ( cDbfBancos )->( dbCloseArea() )
   else
      ( cDbfBancos )->( OrdSetFocus( nOrd ) )
      ( cDbfBancos )->( OrdScope( 0, nil ) )
      ( cDbfBancos )->( OrdScope( 1, nil ) )
   end

   oGet:setFocus()

RETURN ( oDlg:nResult == 1 )



Function cClientCuenta( cCliente, dbfBncCli, lIBAN )

   local lCloseBnc   := .F.
   local cCuenta     := ""

   If( lIBAN == nil, lIBAN := .T., ) ;

   if Empty( dbfBncCli )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliBnc.Dbf" ), ( cCheckArea( "CLIBNC", @dbfBncCli ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CliBnc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end
      lCloseBnc      := .T.
   end

   if dbSeekInOrd( cCliente, "cBncDef", dbfBncCli )
      if lIBAN
         cCuenta     := ( dbfBncCli )->cPaisIBAN + ( dbfBncCli )->cCtrlIBAN
      end
      cCuenta        +=  ( dbfBncCli )->cEntBnc + ( dbfBncCli )->cSucBnc + ( dbfBncCli )->cDigBnc + ( dbfBncCli )->cCtaBnc
   end

   if Empty( cCuenta )
      if dbSeekInOrd( cCliente, "cCodCli", dbfBncCli )
         if lIBAN
            cCuenta  := ( dbfBncCli )->cPaisIBAN + ( dbfBncCli )->cCtrlIBAN
         end
         cCuenta     +=  ( dbfBncCli )->cEntBnc + ( dbfBncCli )->cSucBnc + ( dbfBncCli )->cDigBnc + ( dbfBncCli )->cCtaBnc
      end
   end

   cCuenta           := Alltrim( cCuenta )

   if lCloseBnc
      ( dbfBncCli )->( dbCloseArea() )
   end

Return cCuenta



Function cClientEntidad( cCliente, dbfBncCli )

   local cCuenta     := ""

   if dbSeekInOrd( cCliente, "cBncDef", dbfBncCli )
      cCuenta        := ( dbfBncCli )->cEntBnc
   end

   if Empty( cCuenta )
      if dbSeekInOrd( cCliente, "cCodCli", dbfBncCli )
         cCuenta     := ( dbfBncCli )->cEntBnc
      end
   end

   cCuenta           := Alltrim( cCuenta )

Return cCuenta


Function lConditionAtipica( dFecha, dbfClientAtp )




   if !Empty( ( dbfClientAtp )->cCodArt )    .AND. ( dbfClientAtp )->nTipAtp <= 1         .AND. ( empty( dFecha ) .OR. empty( ( dbfClientAtp )->dFecIni ) .OR. ( dbfClientAtp )->dFecIni <= dFecha  ) .AND.  ( empty( dFecha ) .OR. empty( ( dbfClientAtp )->dFecFin ) .OR. ( dbfClientAtp )->dFecFin >= dFecha  )

      Return .T.

   end

Return .F.



Static Function nUnidadesGratis( hAtipica )

   if empty( hAtipica )
      Return ( 0 )
   end

Return ( hAtipica["nUnidadesVender"] - hAtipica["nUnidadesCobrar"] )



Static Function nImporteUnitario( hAtipica )

   if empty( hAtipica )
      Return ( 0 )
   end

Return ( hAtipica["nImporteUnitario"] )



Static Function isBetterAtipica( hValue, hNewAtipica, hOldAtipica )

   if empty( hOldAtipica )
      return .T.
   end

Return ( nImporteUnitario( hOldAtipica ) >= nImporteUnitario( hNewAtipica ) )



Static function getSelectedAtipica( hValue, hSelectedAtipica )

   local hCurrentAtipica   := hValoresAtipica( hValue )


















Return ( hCurrentAtipica )



Static Function isValidAtipicaXY( hValue, hAtipica )

   if hAtipica[ "isTypeXY" ]

      do case
         case hhaskey( hAtipica, "nCajasGratis" ) .AND. hAtipica[ "nCajasGratis" ] <> 0

            if hAtipica[ "nUnidadesVender" ] <= hValue[ "nCajas" ]
               Return ( .T. )
            end

         case hhaskey( hAtipica, "nUnidadesGratis" ) .AND. hAtipica[ "nUnidadesGratis" ] <> 0

            if hAtipica[ "nUnidadesVender" ] <= hValue[ "nUnidades" ]
               Return ( .T. )
            end

      end



   end

Return ( .T. )



Function hAtipica( hValue )

   local nRec
   local hSelectedAtipica                 := {=>}
   local hCurrentAtipica                  := {=>}
   local nModOferta
   local nOrdAnt














   if !hhaskey( hValue, "cCodigoArticulo" )     .OR. !hhaskey( hValue, "cCodigoPropiedad1" )   .OR. !hhaskey( hValue, "cCodigoPropiedad2" )   .OR. !hhaskey( hValue, "cValorPropiedad1" )    .OR. !hhaskey( hValue, "cValorPropiedad2" )    .OR. !hhaskey( hValue, "cCodigoFamilia" )      .OR. !hhaskey( hValue, "cCodigoCliente" )      .OR. !hhaskey( hValue, "cCodigoGrupo" )        .OR. !hhaskey( hValue, "nTarifaPrecio" )       .OR. !hhaskey( hValue, "lIvaIncluido" )        .OR. !hhaskey( hValue, "dFecha" )              .OR. !hhaskey( hValue, "nCajas" )              .OR. !hhaskey( hValue, "nUnidades" )           .OR. !hhaskey( hValue, "nView" )

      msgStop( "Faltan parametros función hAtipica" )

      return ( hSelectedAtipica )

   endif



   nRec                             := ( D():Atipicas( hValue[ "nView" ] ) )->( Recno() )

   nOrdAnt  := ( D():Atipicas( hValue[ "nView" ] ) )->( OrdSetFocus( "cCliArt" ) )

   if !Empty( hValue[ "cCodigoCliente" ] )

      if ( D():Atipicas( hValue[ "nView" ] ) )->( dbSeek( hValue[ "cCodigoCliente" ] + hValue[ "cCodigoArticulo" ] + hValue[ "cCodigoPropiedad1" ] + hValue[ "cCodigoPropiedad2" ] + hValue[ "cValorPropiedad1" ] + hValue[ "cValorPropiedad2" ] ) )


         while hValue[ "cCodigoCliente" ] + hValue[ "cCodigoArticulo" ] + hValue[ "cCodigoPropiedad1" ] + hValue[ "cCodigoPropiedad2" ] + hValue[ "cValorPropiedad1" ] + hValue[ "cValorPropiedad2" ] == ( D():Atipicas( hValue[ "nView" ] ) )->cCodCli + ( D():Atipicas( hValue[ "nView" ] ) )->cCodArt + ( D():Atipicas( hValue[ "nView" ] ) )->cCodPr1 + ( D():Atipicas( hValue[ "nView" ] ) )->cCodPr2 + ( D():Atipicas( hValue[ "nView" ] ) )->cValPr1 + ( D():Atipicas( hValue[ "nView" ] ) )->cValPr2 .AND. !( D():Atipicas( hValue[ "nView" ] ) )->( Eof() )

            if isValidAtipica( hValue )
               hSelectedAtipica     := getSelectedAtipica( hValue, hSelectedAtipica )
            end

            ( D():Atipicas( hValue[ "nView" ] ) )->( dbSkip() )

         end

      end

   end

   ( D():Atipicas( hValue[ "nView" ] ) )->( OrdSetFocus( nOrdAnt ) )



   nOrdAnt  := ( D():Atipicas( hValue[ "nView" ] ) )->( OrdSetFocus( "cGrpArt" ) )

   if Empty( hSelectedAtipica ) .OR. ( !Empty( hSelectedAtipica ) .AND. hhaskey( hSelectedAtipica, "nImporte" ) .AND. empty( hSelectedAtipica[ "nImporte" ] ) )

      if !Empty( hValue[ "cCodigoGrupo" ] )

         if ( D():Atipicas( hValue[ "nView" ] ) )->( dbSeek( hValue[ "cCodigoGrupo" ] + hValue[ "cCodigoArticulo" ] + hValue[ "cCodigoPropiedad1" ] + hValue[ "cCodigoPropiedad2" ] + hValue[ "cValorPropiedad1" ] + hValue[ "cValorPropiedad2" ] ) )


            while hValue[ "cCodigoGrupo" ] + hValue[ "cCodigoArticulo" ] + hValue[ "cCodigoPropiedad1" ] + hValue[ "cCodigoPropiedad2" ] + hValue[ "cValorPropiedad1" ] + hValue[ "cValorPropiedad2" ] == ( D():Atipicas( hValue[ "nView" ] ) )->cCodGrp + ( D():Atipicas( hValue[ "nView" ] ) )->cCodArt + ( D():Atipicas( hValue[ "nView" ] ) )->cCodPr1 + ( D():Atipicas( hValue[ "nView" ] ) )->cCodPr2 + ( D():Atipicas( hValue[ "nView" ] ) )->cValPr1 + ( D():Atipicas( hValue[ "nView" ] ) )->cValPr2 .AND. !( D():Atipicas( hValue[ "nView" ] ) )->( Eof() )

               if isValidAtipica( hValue )
                  hSelectedAtipica     := getSelectedAtipica( hValue, hSelectedAtipica )
               end

               ( D():Atipicas( hValue[ "nView" ] ) )->( dbSkip() )

            end

         end

      end

   end

   ( D():Atipicas( hValue[ "nView" ] ) )->( OrdSetFocus( nOrdAnt ) )



   if Empty( hSelectedAtipica )

      nOrdAnt  := ( D():Atipicas( hValue[ "nView" ] ) )->( OrdSetFocus( "cCodFam" ) )

      if !Empty( hValue[ "cCodigoCliente" ] )

         if !Empty( hValue[ "cCodigoFamilia" ] )

            if ( D():Atipicas( hValue[ "nView" ] ) )->( dbSeek( hValue[ "cCodigoCliente" ] + hValue[ "cCodigoFamilia" ] ) )


               while hValue[ "cCodigoCliente" ] + hValue[ "cCodigoFamilia" ] == ( D():Atipicas( hValue[ "nView" ] ) )->cCodCli + ( D():Atipicas( hValue[ "nView" ] ) )->cCodFam .AND. !( D():Atipicas( hValue[ "nView" ] ) )->( Eof() )

                  if isValidAtipica( hValue )
                     hSelectedAtipica     := getSelectedAtipica( hValue, hSelectedAtipica )
                  end

                  ( D():Atipicas( hValue[ "nView" ] ) )->( dbSkip() )

               end

            end

         end

      end

      nOrdAnt  := ( D():Atipicas( hValue[ "nView" ] ) )->( OrdSetFocus( nOrdAnt ) )

   end



   if Empty( hSelectedAtipica )

      nOrdAnt  := ( D():Atipicas( hValue[ "nView" ] ) )->( OrdSetFocus( "cGrpFam" ) )

      if !empty( hValue[ "cCodigoGrupo" ] )

         if !empty( hValue[ "cCodigoFamilia" ] )

            if ( D():Atipicas( hValue[ "nView" ] ) )->( dbSeek( hValue[ "cCodigoGrupo" ] + hValue[ "cCodigoFamilia" ] ) )


               while hValue[ "cCodigoGrupo" ] + hValue[ "cCodigoFamilia" ] == ( D():Atipicas( hValue[ "nView" ] ) )->cCodGrp + ( D():Atipicas( hValue[ "nView" ] ) )->cCodFam .AND. !( D():Atipicas( hValue[ "nView" ] ) )->( Eof() )

                  if isValidAtipica( hValue )
                     hSelectedAtipica     := getSelectedAtipica( hValue, hSelectedAtipica )
                  end

                  ( D():Atipicas( hValue[ "nView" ] ) )->( dbSkip() )

               end

            end

         end

      end

      nOrdAnt  := ( D():Atipicas( hValue[ "nView" ] ) )->( OrdSetFocus( nOrdAnt ) )

   end



   if !Empty( hSelectedAtipica )



      if hhaskey( hSelectedAtipica, "nTipoXY" )           .AND. hhaskey( hSelectedAtipica, "nUnidadesVender" )   .AND. hhaskey( hSelectedAtipica, "nUnidadesCobrar" )

         do case
            case hSelectedAtipica[ "nTipoXY" ] == 1

               nModOferta                                := Int( Div( hValue[ "nCajas" ], hSelectedAtipica[ "nUnidadesVender" ] ) )
               hSelectedAtipica[ "nCajasGratis" ]        := ( hSelectedAtipica[ "nUnidadesVender" ] - hSelectedAtipica[ "nUnidadesCobrar" ] ) * nModOferta

            case hSelectedAtipica[ "nTipoXY" ] == 2

               nModOferta                             := Int( Div( hValue[ "nUnidades" ], hSelectedAtipica[ "nUnidadesVender" ] ) )
               hSelectedAtipica[ "nUnidadesGratis" ]  := ( hSelectedAtipica[ "nUnidadesVender" ] - hSelectedAtipica[ "nUnidadesCobrar" ] ) * nModOferta

         end

      end

   end



   ( D():Atipicas( hValue[ "nView" ] ) )->( dbGoTo( nRec ) )

Return ( hSelectedAtipica )



Function hValoresAtipica( hValue, hAtipica )

   local nTarifa
   local nDescuentoTarifa              := 1

   If( hAtipica == nil, hAtipica := {=>}, ) ;

   if hhaskey( hValue, "nTarifaPrecio" )
      nTarifa                          := hValue[ "nTarifaPrecio" ]
   end

   if hhaskey( hValue, "nDescuentoTarifa" )
      nDescuentoTarifa                 := hValue[ "nDescuentoTarifa" ]
   end



   if hhaskey( hAtipica, "nDescuentoLineal" )
      if hAtipica[ "nDescuentoLineal" ] == 0
         hAtipica[ "nDescuentoLineal" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDtoDiv
      end
   else
      hAtipica[ "nDescuentoLineal" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDtoDiv
   end

   if hhaskey( hAtipica, "nDescuentoPromocional" )
      if hAtipica[ "nDescuentoPromocional" ] == 0
         hAtipica[ "nDescuentoPromocional" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDprArt
      end
   else
      hAtipica[ "nDescuentoPromocional" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDprArt
   end

   if ( D():Atipicas( hValue[ "nView" ] ) )->lComAge
      hAtipica[ "nComisionAgente" ]       := ( D():Atipicas( hValue[ "nView" ] ) )->nComAge
   end

   hAtipica[ "nTipoXY" ]                  := ( D():Atipicas( hValue[ "nView" ] ) )->nTipXby
   hAtipica[ "nUnidadesVender" ]          := ( D():Atipicas( hValue[ "nView" ] ) )->nUnvOfe
   hAtipica[ "nUnidadesCobrar" ]          := ( D():Atipicas( hValue[ "nView" ] ) )->nUncOfe

   if ( D():Atipicas( hValue[ "nView" ] ) )->lPrcCom
      hAtipica[ "nCostoParticular" ]      := ( D():Atipicas( hValue[ "nView" ] ) )->nPrcCom
   end



   if ( D():Atipicas( hValue[ "nView" ] ) )->nTipAtp == 2
      hAtipica[ "nTarifaFamilia" ]           := ( D():Atipicas( hValue[ "nView" ] ) )->nTarifa
   else
      hAtipica[ "nTarifaFamilia" ]           := 0
   end

   if empty( nTarifa )
      nTarifa        := 1
   end



   while .T.

      do case
         case nTarifa <= 1

            if hhaskey( hAtipica, "nImporte" )
               if hAtipica[ "nImporte" ] == 0.00000
                  hAtipica[ "nImporte" ]              := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva1, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt )
               end
            else
               hAtipica[ "nImporte" ]                 := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva1, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt )
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
               if hAtipica[ "nDescuentoPorcentual" ] == 0
                  hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto1
               end
            else
               hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto1
            end

         case nTarifa == 2

            if hhaskey( hAtipica, "nImporte" )
               if hAtipica[ "nImporte" ] == 0
                  hAtipica[ "nImporte" ]              := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva2, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt2 )
               end
            else
               hAtipica[ "nImporte" ]                 := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva2, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt2 )
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
               if hAtipica[ "nDescuentoPorcentual" ] == 0
                  hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto2
               end
            else
               hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto2
            end

         case nTarifa == 3

            if hhaskey( hAtipica, "nImporte" )
               if hAtipica[ "nImporte" ] == 0
                  hAtipica[ "nImporte" ]              := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva3, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt3 )
               end
            else
               hAtipica[ "nImporte" ]                 := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva3, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt3 )
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
               if hAtipica[ "nDescuentoPorcentual" ] == 0
                  hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto3
               end
            else
               hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto3
            end

         case nTarifa == 4

            if hhaskey( hAtipica, "nImporte" )
               if hAtipica[ "nImporte" ] == 0
                  hAtipica[ "nImporte" ]              := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva4, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt4 )
               end
            else
               hAtipica[ "nImporte" ]                 := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva4, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt4 )
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
               if hAtipica[ "nDescuentoPorcentual" ] == 0
                  hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto4
               end
            else
               hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto4
            end

         case nTarifa == 5

            if hhaskey( hAtipica, "nImporte" )
               if hAtipica[ "nImporte" ] == 0
                  hAtipica[ "nImporte" ]              := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva5, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt5 )
               end
            else
               hAtipica[ "nImporte" ]                 := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva5, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt5 )
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
               if hAtipica[ "nDescuentoPorcentual" ] == 0
                  hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto5
               end
            else
               hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto5
            end

         case nTarifa == 6

            if hhaskey( hAtipica, "nImporte" )
               if hAtipica[ "nImporte" ] == 0
                  hAtipica[ "nImporte" ]              := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva6, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt6 )
               end
            else
               hAtipica[ "nImporte" ]                 := if( hValue[ "lIvaIncluido" ], ( D():Atipicas( hValue[ "nView" ] ) )->nPreIva6, ( D():Atipicas( hValue[ "nView" ] ) )->nPrcArt6 )
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
               if hAtipica[ "nDescuentoPorcentual" ] == 0
                  hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto6
               end
            else
               hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto6
            end

      end

      if hhaskey( hAtipica, "nImporte" ) .AND. hAtipica[ "nImporte" ] == 0 .AND. nTarifa > 1 .AND. lBuscaImportes()
         nTarifa--
         loop
      else
         exit
      end

   end

   hAtipica[ "nTarifaPrecio" ]  :=  nTarifa



   do case
      case nDescuentoTarifa == 1

         if hhaskey( hAtipica, "nDescuentoPorcentual" )
            if hAtipica[ "nDescuentoPorcentual" ] == 0
               hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto1
            end
         else
            hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto1
         end

      case nDescuentoTarifa == 2

         if hhaskey( hAtipica, "nDescuentoPorcentual" )
            if hAtipica[ "nDescuentoPorcentual" ] == 0
               hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto2
            end
         else
            hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto2
         end

      case nDescuentoTarifa == 3

         if hhaskey( hAtipica, "nDescuentoPorcentual" )
            if hAtipica[ "nDescuentoPorcentual" ] == 0
               hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto3
            end
         else
            hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto3
         end

      case nDescuentoTarifa == 4

         if hhaskey( hAtipica, "nDescuentoPorcentual" )
            if hAtipica[ "nDescuentoPorcentual" ] == 0
               hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto4
            end
         else
            hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto4
         end

      case nDescuentoTarifa == 5

         if hhaskey( hAtipica, "nDescuentoPorcentual" )
            if hAtipica[ "nDescuentoPorcentual" ] == 0
               hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto5
            end
         else
            hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto5
         end

      case nDescuentoTarifa == 6
          if hhaskey( hAtipica, "nDescuentoPorcentual" )
            if hAtipica[ "nDescuentoPorcentual" ] == 0
               hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDto6
            end
         else
            hAtipica[ "nDescuentoPorcentual" ]     := ( D():Atipicas( hValue[ "nView" ] ) )->nDto6
         end

   end



   if hhaskey( hAtipica, "nDescuentoPorcentual" )
      if hAtipica[ "nDescuentoPorcentual" ] == 0
         hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDtoArt
      end
   else
      hAtipica[ "nDescuentoPorcentual" ]  := ( D():Atipicas( hValue[ "nView" ] ) )->nDtoArt
   end



   hAtipica[ "isTypeXY" ]                 := .F.

   do case
      case hAtipica[ "nTipoXY" ] == 1
         hAtipica[ "nCajasGratis" ]       := ( hAtipica[ "nUnidadesVender" ] - hAtipica[ "nUnidadesCobrar" ] )
         hAtipica[ "isTypeXY" ]           := ( hAtipica[ "nCajasGratis" ] <> 0 )

      case hAtipica[ "nTipoXY" ] == 2
         hAtipica[ "nUnidadesGratis" ]    := ( hAtipica[ "nUnidadesVender" ] - hAtipica[ "nUnidadesCobrar" ] )
         hAtipica[ "isTypeXY" ]           := ( hAtipica[ "nUnidadesGratis" ] <> 0 )
   end



   if hAtipica[ "isTypeXY" ]
      hAtipica[ "nImporteUnitario" ]      := nImporteUnitarioXY( hValue, hAtipica )
   else
      hAtipica[ "nImporteUnitario" ]      := nImporteUnitarioDescuentos( hAtipica )
   end

Return ( hAtipica )



Static Function nImporteUnitarioXY( hValue, hAtipica )

   local nCajasCobrar
   local nUnidadesCobrar
   local nUnidadesVender
   local nImporteUnitario  := 0

   if hAtipica[ "nTipoXY" ] == 1

      nCajasCobrar                     := hValue[ "nCajas" ] - hAtipica[ "nCajasGratis" ]
      nUnidadesCobrar                  := nCajasCobrar * hValue[ "nUnidades" ]
      nUnidadesVender                  := hValue[ "nCajas"] * hValue[ "nUnidades" ]
      nImporteUnitario                 := nUnidadesCobrar * hAtipica[ "nImporte" ] / nUnidadesVender

   else

      nUnidadesCobrar                  := hValue[ "nUnidades" ] - hAtipica[ "nUnidadesGratis" ]
      nUnidadesVender                  := hValue[ "nUnidades" ]
      nImporteUnitario                 := nUnidadesCobrar * hAtipica[ "nImporte" ] / nUnidadesVender

   end

Return ( nImporteUnitario )




Static Function nImporteUnitarioDescuentos( hAtipica )

   local nImporteUnitario  := 0

   nImporteUnitario        := hAtipica[ "nImporte" ]
   nImporteUnitario        -= hAtipica[ "nDescuentoLineal" ]

   if hAtipica[ "nDescuentoPorcentual" ] <> 0
      nImporteUnitario     -= nImporteUnitario * hAtipica[ "nDescuentoPorcentual" ] / 100
   end

   if hAtipica[ "nDescuentoPromocional" ] <> 0
      nImporteUnitario     -= nImporteUnitario * hAtipica[ "nDescuentoPromocional" ] / 100
   end

Return ( nImporteUnitario )



Static function isValidAtipica( hValue )

Return ( lFechasAtipicas( hValue ) .AND. lAplicaDocumento( hValue ) )



Static Function lFechasAtipicas( hValue )


Return ( ( empty( ( D():Atipicas( hValue[ "nView" ] ) )->dFecIni ) .OR. ( D():Atipicas( hValue[ "nView" ] ) )->dFecIni <= hValue[ "dFecha" ] ) .AND.  ( empty( ( D():Atipicas( hValue[ "nView" ] ) )->dFecFin ) .OR. ( D():Atipicas( hValue[ "nView" ] ) )->dFecFin >= hValue[ "dFecha" ] ) )



Static Function lAplicaDocumento( hValue )

   local lReturn  := .F.

   if !hhaskey( hValue, "nTipoDocumento" ) .OR. empty( hValue[ "nTipoDocumento" ] )
      Return ( .T. )
   end

   do case
      case hValue[ "nTipoDocumento" ] == "08"
         lReturn  := ( D():Atipicas( hValue[ "nView" ] ) )->lAplPre

      case hValue[ "nTipoDocumento" ] == "09"
         lReturn  := ( D():Atipicas( hValue[ "nView" ] ) )->lAplPed

      case hValue[ "nTipoDocumento" ] == "10"
         lReturn  := ( D():Atipicas( hValue[ "nView" ] ) )->lAplAlb

      case hValue[ "nTipoDocumento" ] == "11" .OR. hValue[ "nTipoDocumento" ] == "14" .OR. hValue[ "nTipoDocumento" ] == "12"
         lReturn  := ( D():Atipicas( hValue[ "nView" ] ) )->lAplFac

      case hValue[ "nTipoDocumento" ] == "32"
         lReturn  := ( D():Atipicas( hValue[ "nView" ] ) )->lAplSat

   end

Return lReturn



FUNCTION RefBrwCta( oBrwCta, cSubCta, dbfDiario )

   if dbfDiario <> nil

      if !Empty( cSubCta )
         ( dbfDiario )->( OrdScope( 0, cSubCta ) )
         ( dbfDiario )->( OrdScope( 1, cSubCta ) )
      else
         ( dbfDiario )->( OrdScope( 0, Replicate( "9", 12 ) ) )
         ( dbfDiario )->( OrdScope( 1, Replicate( "9", 12 ) ) )
      end

      ( dbfDiario )->( dbGoTop() )

      if oBrwCta <> nil
         oBrwCta:Refresh()
      end

   end

return .T.



Static Function LlamadaAhora( aGet )

   if empty( aGet )
      if D():Lock( "Client", nView )
         ( D():Clientes( nView ) )->dLlaCli := date()
         ( D():Clientes( nView ) )->cTimCli := left( time(), 5 )
         D():UnLock( "Client", nView )
      end
   else
      aGet[ 122 ]:cText( date() )
      aGet[ 123 ]:cText( left( time(), 5 ) )
   end

Return ( .T. )



FUNCTION AddIncidenciaCliente( nView, oBrw )

   WinAppRec( oBrw, bEdtInc, ( D():ClientesIncidencias( nView ) ), ( D():Clientes( nView ) )->Cod )

RETURN .T.



FUNCTION EdtIncidenciaCliente( nView, oBrw )

   WinEdtRec( oBrw, bEdtInc, D():ClientesIncidencias( nView ) )

RETURN .T.



FUNCTION ZooIncidenciaCliente( nView, oBrw )

   WinZooRec( oBrw, bEdtInc, D():ClientesIncidencias( nView ) )

RETURN .T.



FUNCTION DelIncidenciaCliente( nView, oBrw )

   WinDelRec( oBrw, D():ClientesIncidencias( nView ) )

RETURN .T.



static function aCreaArrayPeriodos()

   local aPeriodo := {}

   aAdd( aPeriodo, "Hoy" )

   aAdd( aPeriodo, "Ayer" )

   aAdd( aPeriodo, "Mes en curso" )

   aAdd( aPeriodo, "Mes anterior" )

   do case
      case Month( GetSysDate() ) <= 3
         aAdd( aPeriodo, "Primer trimestre" )

      case Month( GetSysDate() ) > 3 .AND. Month( GetSysDate() ) <= 6
         aAdd( aPeriodo, "Primer trimestre" )
         aAdd( aPeriodo, "Segundo trimestre" )

      case Month( GetSysDate() ) > 6 .AND. Month( GetSysDate() ) <= 9
         aAdd( aPeriodo, "Primer trimestre" )
         aAdd( aPeriodo, "Segundo trimestre" )
         aAdd( aPeriodo, "Tercer trimestre" )

      case Month( GetSysDate() ) > 9 .AND. Month( GetSysDate() ) <= 12
         aAdd( aPeriodo, "Primer trimestre" )
         aAdd( aPeriodo, "Segundo trimestre" )
         aAdd( aPeriodo, "Tercer trimestre" )
         aAdd( aPeriodo, "Cuatro trimestre" )

   end

   aAdd( aPeriodo, "Doce últimos meses" )

   aAdd( aPeriodo, "Año en curso" )

   aAdd( aPeriodo, "Año anterior" )

   aAdd( aPeriodo, "Todos" )

Return ( aPeriodo )



Static Function lRecargaFecha( oFechaInicio, oFechaFin, cPeriodo )

   do case
      case cPeriodo == "Hoy"

         oFechaInicio:cText( GetSysDate() )
         oFechaFin:cText( GetSysDate() )

      case cPeriodo == "Ayer"

         oFechaInicio:cText( GetSysDate() -1 )
         oFechaFin:cText( GetSysDate() -1 )

      case cPeriodo == "Mes en curso"

         oFechaInicio:cText( CtoD( "01/" + Str( Month( GetSysDate() ) ) + "/" + Str( Year( GetSysDate() ) ) ) )
         oFechaFin:cText( GetSysDate() )

      case cPeriodo == "Mes anterior"

         oFechaInicio:cText( BoM( AddMonth( GetSysDate(), -1 ) ) )
         oFechaFin:cText( EoM( AddMonth( GetSysDate(), -1 ) ) )

      case cPeriodo == "Primer trimestre"

         oFechaInicio:cText( CtoD( "01/01/" + Str( Year( GetSysDate() ) ) ) )
         oFechaFin:cText( CtoD( "31/03/" + Str( Year( GetSysDate() ) ) ) )

      case cPeriodo == "Segundo trimestre"

         oFechaInicio:cText( CtoD( "01/04/" + Str( Year( GetSysDate() ) ) ) )
         oFechaFin:cText( CtoD( "30/06/" + Str( Year( GetSysDate() ) ) ) )

      case cPeriodo == "Tercer trimestre"

         oFechaInicio:cText( CtoD( "01/07/" + Str( Year( GetSysDate() ) ) ) )
         oFechaFin:cText( CtoD( "30/09/" + Str( Year( GetSysDate() ) ) ) )

      case cPeriodo == "Cuatro trimestre"

         oFechaInicio:cText( CtoD( "01/10/" + Str( Year( GetSysDate() ) ) ) )
         oFechaFin:cText( CtoD( "31/12/" + Str( Year( GetSysDate() ) ) ) )

      case cPeriodo == "Doce últimos meses"

         oFechaInicio:cText( CtoD( Str( Day( GetSysDate() ) ) + "/" + Str( Month( GetSysDate() ) ) + "/" + Str( Year( GetSysDate() ) -1 ) ) )
         oFechaFin:cText( GetSysDate() )

      case cPeriodo == "Año en curso"

         oFechaInicio:cText( CtoD( "01/01/" + Str( Year( GetSysDate() ) ) ) )
         oFechaFin:cText( CtoD( "31/12/" + Str( Year( GetSysDate() ) ) ) )

      case cPeriodo == "Año anterior"

         oFechaInicio:cText( CtoD( "01/01/" + Str( Year( GetSysDate() ) - 1 ) ) )
         oFechaFin:cText( CtoD( "31/12/" + Str( Year( GetSysDate() ) - 1 ) ) )

      case cPeriodo == "Todos"

         oFechaInicio:cText( CtoD( "01/01/2000" ) )
         oFechaFin:cText( CtoD( "31/12/3000" ) )

   end

   oFechaInicio:Refresh()
   oFechaFin:Refresh()

RETURN ( .T. )



Static Function LoadPageClient( cCodigoCliente )

   local cExpHead    := ""

   do case
      case oEstadoCli:nAt == 1


         ( D():FacturasClientesCobros( nView ) )->( dbSetFilter( {|| !Field->lCobrado .AND. Field->dFecVto >= dFecIniCli .AND. Field->dFecVto <= dFecFinCli }, '!lCobrado .and. dFecVto >= Ctod( "' + Dtoc( dFecIniCli ) + '" ) .and. dFecVto <= Ctod( "' + Dtoc( dFecFinCli ) + '" )' ) )

      case oEstadoCli:nAt == 2


         ( D():FacturasClientesCobros(  nView ) )->( dbSetFilter( {|| Field->lCobrado .AND. Field->dFecVto >= dFecIniCli .AND. Field->dFecVto <= dFecFinCli }, 'lCobrado .and. dFecVto >= Ctod( "' + Dtoc( dFecIniCli ) + '" ) .and. dFecVto <= Ctod( "' + Dtoc( dFecFinCli ) + '" )' ) )

      case oEstadoCli:nAt == 3

         ( D():FacturasClientesCobros( nView ) )->( dbSetFilter( {|| Field->dFecVto >= dFecIniCli .AND. Field->dFecVto <= dFecFinCli }, 'dFecVto >= Ctod( "' + Dtoc( dFecIniCli ) + '" ) .and. dFecVto <= Ctod( "' + Dtoc( dFecFinCli ) + '" )' ) )
   end

   ( D():FacturasClientesCobros( nView ) )->( dbGoTop() )



   if !Empty( oBrwRecCli )
      oBrwRecCli:Refresh()
   end

return .T.







Static Function ChangeCampoDef( oCol, uNewValue, nKey, aTmp, nValue, oBrw )

   if IsNum( nKey ) .AND. ( nKey <> 27 ) .AND. !IsNil( uNewValue )
      aTmp[ nValue ]    := uNewValue
   end

   if !Empty( oBrw )
      oBrw:Refresh()
   end

Return .T.



function numeroEntidadCliente( cCodCli, nView )

   local nEntidades  := 0
   local hStatus     := hGetStatus( D():ClientesEntidad( nView ), "cCodCli" )

   if ( D():ClientesEntidad( nView ) )->( dbSeek( cCodCli ) )

      while  alltrim( ( D():ClientesEntidad( nView ) )->cCodCli )  == alltrim( cCodCli ) .AND. ! D():eofClientesEntidad( nView )

         nEntidades++

         ( D():ClientesEntidad( nView ) )->( dbSkip() )

      end

   endif

   hSetStatus( hStatus )

Return ( nEntidades )



function cargaEntidadCliente( cCodCli, nView, dbfTmpEntidades )

   if ( numeroEntidadCliente( cCodCli, nView ) ) <> 1
      Return ( .F. )
   endif

   aplicaEntidadCliente( cCodCli, nView, dbfTmpEntidades )

Return ( .T. )



function aplicaEntidadCliente( cCodCli, nView, dbfTmpEntidades )

   local hEntidad
   local aEntidades     := {}

   if Empty( ( D():ClientesEntidad( nView ) )->mMemo )
      Return ( .T. )
   end

   aEntidades                             := hb_deserialize( ( D():ClientesEntidad( nView ) )->mMemo )

   for each hEntidad in aEntidades

      if !dbSeekInOrd( ( padr( hget( hEntidad, "CodigoEntidad"), 60 ) + padr( hget( hEntidad, "RolEntidad"), 60 ) ), "cRolEnt", dbfTmpEntidades )

         ( dbfTmpEntidades )->( dbappend() )

         ( dbfTmpEntidades )->cCodEnt     := hget( hEntidad, "CodigoEntidad")
         ( dbfTmpEntidades )->cRol        := hget( hEntidad, "RolEntidad")

         ( dbfTmpEntidades )->( dbunlock() )

      endif

   next

Return( .T. )



Function getExtraFieldCliente( cFieldName )

Return ( getExtraField( cFieldName, oDetCamposExtra, D():ClientesId( nView ) ) )



function externalAppendAtipica( oBrwAgentesTarifas, tmpAgentesTarifas, nExternalView )

   nView    := nExternalView

Return ( WinAppRec( oBrwAgentesTarifas, bEdtAtp, tmpAgentesTarifas ) )



function externalEditAtipica( oBrwAgentesTarifas, tmpAgentesTarifas, nExternalView )

   nView    := nExternalView

Return ( WinEdtRec( oBrwAgentesTarifas, bEdtAtp, tmpAgentesTarifas ) )



static function DelDetalle( cCodigo )

   local nOrdAnt

   InitWait()





   ( D():ClientesDirecciones( nView ) )->( OrdSetFocus( "cCodCli" ) )

   if ( D():ClientesDirecciones( nView ) )->( dbSeek( cCodigo ) )

      while ( ( D():ClientesDirecciones( nView ) )->cCodCli == cCodigo )

            if dbLock( D():ClientesDirecciones( nView ) )
               ( D():ClientesDirecciones( nView ) )->( dbDelete() )
               ( D():ClientesDirecciones( nView ) )->( dbUnLock() )
            end

            ( D():ClientesDirecciones( nView ) )->( dbSkip( 1 ) )

      end

   end

   ( D():ClientesDirecciones( nView ) )->( OrdSetFocus( nOrdAnt ) )





   ( D():ClientesDocumentos( nView ) )->( OrdSetFocus( "cCodCli" ) )

   if ( D():ClientesDocumentos( nView ) )->( dbSeek( cCodigo ) )

      while ( ( D():ClientesDocumentos( nView ) )->cCodCli == cCodigo )

            if dbLock( D():ClientesDocumentos( nView ) )
               ( D():ClientesDocumentos( nView ) )->( dbDelete() )
               ( D():ClientesDocumentos( nView ) )->( dbUnLock() )
            end

            ( D():ClientesDocumentos( nView ) )->( dbSkip( 1 ) )

      end

   end

   ( D():ClientesDocumentos( nView ) )->( OrdSetFocus( nOrdAnt ) )





   ( D():ClientesIncidencias( nView ) )->( OrdSetFocus( "cCodCli" ) )

   if ( D():ClientesIncidencias( nView ) )->( dbSeek( cCodigo ) )

      while ( ( D():ClientesIncidencias( nView ) )->cCodCli == cCodigo )

            if dbLock( D():ClientesIncidencias( nView ) )
               ( D():ClientesIncidencias( nView ) )->( dbDelete() )
               ( D():ClientesIncidencias( nView ) )->( dbUnLock() )
            end

            ( D():ClientesIncidencias( nView ) )->( dbSkip( 1 ) )

      end

   end

   ( D():ClientesIncidencias( nView ) )->( OrdSetFocus( nOrdAnt ) )





   ( D():ClientesEntidad( nView ) )->( OrdSetFocus( "cCodCli" ) )

   if ( D():ClientesEntidad( nView ) )->( dbSeek( cCodigo ) )

      while ( ( D():ClientesEntidad( nView ) )->cCodCli == cCodigo )

            if dbLock( D():ClientesEntidad( nView ) )
               ( D():ClientesEntidad( nView ) )->( dbDelete() )
               ( D():ClientesEntidad( nView ) )->( dbUnLock() )
            end

            ( D():ClientesEntidad( nView ) )->( dbSkip( 1 ) )

      end

   end

   ( D():ClientesEntidad( nView ) )->( OrdSetFocus( nOrdAnt ) )





   ( D():ClientesBancos( nView ) )->( OrdSetFocus( "cCodCli" ) )

   if ( D():ClientesBancos( nView ) )->( dbSeek( cCodigo ) )

      while ( ( D():ClientesBancos( nView ) )->cCodCli == cCodigo )

            if dbLock( D():ClientesBancos( nView ) )
               ( D():ClientesBancos( nView ) )->( dbDelete() )
               ( D():ClientesBancos( nView ) )->( dbUnLock() )
            end

            ( D():ClientesBancos( nView ) )->( dbSkip( 1 ) )

      end

   end

   ( D():ClientesBancos( nView ) )->( OrdSetFocus( nOrdAnt ) )





   ( D():Atipicas( nView ) )->( OrdSetFocus( "cCodCli" ) )

   if ( D():Atipicas( nView ) )->( dbSeek( cCodigo ) )

      while ( ( D():Atipicas( nView ) )->cCodCli == cCodigo )

            if dbLock( D():Atipicas( nView ) )
               ( D():Atipicas( nView ) )->( dbDelete() )
               ( D():Atipicas( nView ) )->( dbUnLock() )
            end

            ( D():Atipicas( nView ) )->( dbSkip( 1 ) )

      end

   end

   ( D():Atipicas( nView ) )->( OrdSetFocus( nOrdAnt ) )






   ( D():ClientesContactos( nView ) )->( OrdSetFocus( "cCodCli" ) )

   if ( D():ClientesContactos( nView ) )->( dbSeek( cCodigo ) )

      while ( ( D():ClientesContactos( nView ) )->cCodCli == cCodigo )

            if dbLock( D():ClientesContactos( nView ) )
               ( D():ClientesContactos( nView ) )->( dbDelete() )
               ( D():ClientesContactos( nView ) )->( dbUnLock() )
            end

            ( D():ClientesContactos( nView ) )->( dbSkip( 1 ) )

      end

   end

   ( D():ClientesContactos( nView ) )->( OrdSetFocus( nOrdAnt ) )

   EndWait()

Return .T.



Function showClienteRiesgo( idCliente, nRiesgoCliente, getRiesgo, lAviso )

   local nRiesgo  := ClientesModel():Riesgo( idCliente )

   If( lAviso == nil, lAviso := uFieldEmpresa( "lSalPdt" , .F. ), ) ;

   if !( hb_isobject( getRiesgo ) )
      Return ( nRiesgo )
   end

   getRiesgo:cText( nRiesgo )

   if !( hb_isnumeric( nRiesgoCliente ) )
      Return ( nRiesgo )
   end

   if ( nRiesgo > nRiesgoCliente )
      getRiesgo:setColor( ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ) )
   else
      getRiesgo:setColor( ( 0 + ( 0 * 256 ) + ( 0 * 65536 ) ), ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ) )
   end

   getRiesgo:Refresh()

   if lAviso

      msgStop( "El riesgo alacanzado es de " + alltrim( Trans( nRiesgo, cPorDiv() ) ) + "; sobre el establecido en su ficha " + alltrim( Trans( nRiesgoCliente, cPorDiv() ) ) + ".", "El riesgo del cliente supera el límite establecido" )
   end

Return ( nRiesgo )



Function lShowClienteRiesgoAlcanzado( idCliente )

   local nRiesgo              := ClientesModel():Riesgo( idCliente )
   local nRiesgoCliente       := ClientesModel():getField( "Riesgo", "Cod", idCliente )

   if ( nRiesgo > nRiesgoCliente )

         msgStop( "El riesgo alacanzado es de " + alltrim( Trans( nRiesgo, cPorDiv() ) ) + "; sobre el establecido en su ficha " + alltrim( Trans( nRiesgoCliente, cPorDiv() ) ) + ".", "El riesgo del cliente supera el límite establecido" )
      Return .T.
   end

Return .F.



Function lClienteAlcanzadoRiesgoPermitido( lCreditoSolicitado, nRiesgoPermitido, nRiesgoAlcanzado )

   if lCreditoSolicitado .AND. nRiesgoAlcanzado >= nRiesgoPermitido
      msgStop( "Este cliente supera el limite de riesgo permitido.", "Imposible archivar documento" )
      Return .T.
   end

Return .F.
