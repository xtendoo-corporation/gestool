#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 13 ".\.\Prg\Contactos.prg"
   static bEdit      := {| aBlank, aoGet, dbfObrasT, oBrw, bWhen, bValid, nMode, cCodCli | EdtRec( aBlank, aoGet, dbfObrasT, oBrw, bWhen, bValid, nMode, cCodCli ) }


static oWndBrw

static dbfContactos





STATIC FUNCTION EdtRec( aBlank, aoGet, dbfContactos, oBrw, bWhen, bValid, nMode, cCodCli )

    local oDlg

   if nMode == 1
      if !Empty( cCodCli )
         aBlank[ ( dbfContactos )->( FieldPos( "cCodCli" ) ) ] := cCodCli
      end
      aBlank[ ( dbfContactos )->( FieldPos( "dLlaCon" ) ) ]    := ctod( "" )
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "contactos de clientes", "Contactos",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






      aoGet[ ( dbfContactos )->( FieldPos( "cNomCon" ) ) ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cNomCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cNomCon" ) ) ]:= u ) }, oDlg,, "@!",,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cNifCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cNifCon" ) ) ]:= u ) }, oDlg,, "@!",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cDirCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cDirCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cPobCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cPobCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cPosCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cPosCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cPrvCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cPrvCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cTelCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cTelCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cMovCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cMovCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cFaxCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cFaxCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cMaiCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cMaiCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aoGet[ ( dbfContactos )->( FieldPos( "cObsCon" ) ) ] := TMultiGet():ReDefine( 200, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cObsCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cObsCon" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      aoGet[ ( dbfContactos )->( FieldPos( "dLlaCon" ) ) ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "dLlaCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "dLlaCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aoGet[ ( dbfContactos )->( FieldPos( "cTimCon" ) ) ] := TGetHlp():ReDefine( 191, { | u | If( PCount()==0, aBlank[ ( dbfContactos )->( FieldPos( "cTimCon" ) ) ], aBlank[ ( dbfContactos )->( FieldPos( "cTimCon" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      TBtnBmp():ReDefine( 192, "gc_recycle_16",,,,,{|| LlamadaAhora( aoGet, dbfContactos ) }, oDlg, .F., , .F.,  )





      TButton():ReDefine( 1, {||( EndTrans( aBlank, aoGet, dbfContactos, oBrw, nMode, oDlg ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| EndTrans( aBlank, aoGet, dbfContactos, oBrw, nMode, oDlg ) } )
      end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )



Static Function EndTrans( aBlank, aoGet, dbfContactos, oBrw, nMode, oDlg )

   if Empty( aBlank[ ( dbfContactos )->( FieldPos( "cNomCon" ) ) ] )

      MsgStop( "Nombre no puede estar vacío" )

      aoGet[ ( dbfContactos )->( FieldPos( "cNomCon" ) ) ]:SetFocus()

      return nil

   end

   WinGather( aBlank, aoGet, dbfContactos, oBrw, nMode )

   oBrw:Refresh()

Return ( oDlg:end( 1 ) )



Static Function LlamadaAhora( aoGet, dbfContactos )

   aoGet[ ( dbfContactos )->( FieldPos( "dLlaCon" ) ) ]:cText( date() )
   aoGet[ ( dbfContactos )->( FieldPos( "cTimCon" ) ) ]:cText( left( time(), 5 ) )

Return ( .T. )



STATIC FUNCTION OpenFiles()

   local lOpen    := .T.
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliCto.Dbf" ), ( cCheckArea( "CliConta", @dbfContactos ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CliCto.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos de contactos de clientes." )

      CloseFiles()

      lOpen       := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



STATIC FUNCTION CloseFiles()

   if oWndBrw <> nil
      oWndBrw  := nil
   end

   if !Empty( dbfContactos )
      ( dbfContactos )->( dbCloseArea() )
   end

   dbfContactos   := nil

RETURN ( .T. )



FUNCTION AppContactos( cCodCli, dbfContactos, oBrw )

   WinAppRec( oBrw, bEdit, dbfContactos, nil, nil, cCodCli )

RETURN NIL



FUNCTION EdtContactos( dbfContactos, oBrw )

   local nLevel      := Auth():Level( "01032" )

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   WinEdtRec( oBrw, bEdit, dbfContactos )

RETURN NIL



FUNCTION ZoomContactos( dbfContactos, oBrw )

   WinZooRec( oBrw, bEdit, dbfContactos )

RETURN NIL



FUNCTION DelContactos( dbfContactos, oBrw )

   if dbDelRec( oBrw, dbfContactos )
      oBrw:Refresh()
   end

RETURN NIL



Function LlamadaContactos( dbfContactos, oBrw )

   ( dbfContactos )->dLlaCon  := date()
   ( dbfContactos )->cTimCon  := left( time(), 5)

   oBrw:Refresh()

Return ( .T. )








FUNCTION aItmContacto()

   local aItmCon  := {}

   aAdd( aItmCon, { "cCodCli",   "C",   12,    0, "Código del cliente" ,               "",                  "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cNomCon",   "C",  140,    0, "Nombre del contacto" ,              "'@!'",              "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cNifCon",   "C",   30,    0, "NIF del contacto" ,                 "'@!'",              "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cDirCon",   "C",  100,    0, "Domicilio del contacto" ,           "'@!'",              "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cPobCon",   "C",  100,    0, "Población del contacto" ,           "'@!'",              "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cPrvCon",   "C",   20,    0, "Provincia del contacto" ,           "'@!'",              "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cPosCon",   "C",   10,    0, "Código postal del contacto" ,       "'@!'",              "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cTelCon",   "C",   17,    0, "Teléfono del contacto" ,            "",                  "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cMovCon",   "C",   17,    0, "Teléfono movil del contacto" ,      "",                  "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cFaxCon",   "C",   17,    0, "Fax del contacto" ,                 "",                  "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cMaiCon",   "C",  140,    0, "Email del contacto" ,               "",                  "", "( cDbfCon )" } )
   aAdd( aItmCon, { "dLlaCon",   "D",    8,    0, "Última llamada del contacto" ,      "",                  "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cTimCon",   "C",    5,    0, "Hora última llamada del contacto" , "",                  "", "( cDbfCon )" } )
   aAdd( aItmCon, { "cObsCon",   "M",   10,    0, "Observaciones del contacto" ,       "",                  "", "( cDbfCon )" } )

RETURN ( aItmCon )





FUNCTION BrwContactos( oGet, oGet2, cCodCli, dbfContactos )

    local oDlg
    local oBrw
   local oFont
   local oBtn
    local oGet1
    local cGet1
   local nOrd        := GetBrwOpt( "BrwContactos" )
    local oCbxOrd
   local aCbxOrd     := { "Nombre", "Código postal", "Teléfono", "Movil", "Correo electrónico" }
   local cCbxOrd     := "Nombre"
   local nLevel      := Auth():Level( "01032" )
   local lClose      := .F.
   local oSayText
   local cSayText    := "Listado de obras"

   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   if Empty( cCodCli )
        MsgStop( "Es necesario codificar un cliente" )
      return .T.
   end

   if !lExistTable( cPatEmp() + "CliCto.dbf" )
      MsgStop( "No existe el fichero de obras" )
      Return .F.
   end

   if Empty( dbfContactos )
      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliCto.dbf" ), ( cCheckArea( "CliConta", @dbfContactos ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CliCto.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose      := .T.
   end

   ( dbfContactos )->( ordSetFocus( nOrd ) )
   ( dbfContactos )->( dbSetFilter( {|| Field->cCodCli == cCodCli }, "Field->cCodCli == cCodCli" ) )
   ( dbfContactos )->( dbGoTop() )



   oDlg = TDialog():New(,,,, "Seleccionar contactos de clientes", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,,,,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfContactos, nil, cCodCli ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( dbfContactos )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:Refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := dbfContactos
      oBrw:nMarqueeStyle   := 5

      with object ( oBrw:AddCol() )
         :cHeader          := "Código"
         :cSortOrder       := "Codigo"
         :bEditValue       := {|| ( dbfContactos )->cCodObr }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "Nombre"
         :bEditValue       := {|| ( dbfContactos )->cNomObr }
         :nWidth           := 360
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )





        TButton():ReDefine( 500, {||( WinAppRec( oBrw, bEdit, dbfContactos, nil, nil, cCodCli ) )}, oDlg,,, .F., {||     ( nAnd( nLevel, 2 ) <> 0 .AND. !IsReport() )},,, .F. )





        TButton():ReDefine( 501, {||( WinEdtRec( oBrw, bEdit, dbfContactos, nil, nil, cCodCli ) )}, oDlg,,, .F., {||     ( nAnd( nLevel, 4 ) <> 0 .AND. !IsReport() )},,, .F. )

      if !IsReport()
         oDlg:AddFastKey( 113,    {|| if( nAnd( nLevel, 2 ) <> 0, WinAppRec( oBrw, bEdit, dbfContactos, nil, nil, cCodCli ), ) } )
         oDlg:AddFastKey( 114,    {|| if( nAnd( nLevel, 4 ) <> 0, WinEdtRec( oBrw, bEdit, dbfContactos, nil, nil, cCodCli ), ) } )
      end

   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGet:cText( ( dbfContactos )->CCODOBR )

      if oGet2 <> NIL
         oGet2:cText( ( dbfContactos )->CNOMOBR )
      end
   end

   DestroyFastFilter( dbfContactos )

   SetBrwOpt( "BrwContactos", ( dbfContactos )->( OrdNumber() ) )

   if lClose
      ( dbfContactos )->( dbCloseArea() )
   else
      ( dbfContactos )->( OrdSetFocus( nOrd ) )
      ( dbfContactos )->( dbClearFilter() )
   end

    oGet:setFocus()

RETURN ( oDlg:nResult == 1 )
