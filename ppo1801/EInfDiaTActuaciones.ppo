#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 8 ".\.\Prg\EInfDiaTActuaciones.prg"
_HB_CLASS EInfDiaActuaciones ; function EInfDiaActuaciones ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "EInfDiaActuaciones", iif( .T., { @TInfGen() }, { @HBObject() } ), @EInfDiaActuaciones() ) ) ;

   _HB_MEMBER { AS OBJECT oExpediente } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oExpediente"}, .F. )
   _HB_MEMBER { AS OBJECT oActuacion } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oActuacion"}, .F. )
   _HB_MEMBER { AS OBJECT oTipoActuacion } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTipoActuacion"}, .F. )
   _HB_MEMBER { AS LOGIC lPendientes } ; oClass:AddMultiData( "LOGIC", .T., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lPendientes"}, .F. )
   _HB_MEMBER { AS LOGIC lAllAct } ; oClass:AddMultiData( "LOGIC", .T., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lAllAct"}, .F. )
   _HB_MEMBER { AS OBJECT oIniAct } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oIniAct"}, .F. )
   _HB_MEMBER { AS OBJECT oFinAct } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFinAct"}, .F. )
   _HB_MEMBER { dIniAct } ; oClass:AddMultiData(, CtoD( "01/01/" + Str( Year( Date() ) ) ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dIniAct"}, .F. )
   _HB_MEMBER { dFinAct } ; oClass:AddMultiData(, Date(), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFinAct"}, .F. )

   _HB_MEMBER Create(); oClass:AddMethod( "Create", @EInfDiaActuaciones_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @EInfDiaActuaciones_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @EInfDiaActuaciones_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lResource( cFld); oClass:AddMethod( "lResource", @EInfDiaActuaciones_lResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lGenerate(); oClass:AddMethod( "lGenerate", @EInfDiaActuaciones_lGenerate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS EInfDiaActuaciones ;



static FUNCTION EInfDiaActuaciones_Create( ) ; local Self AS CLASS EInfDiaActuaciones := QSelf() AS CLASS EInfDiaActuaciones

   ::AddField( "cTipAct",  "C",  3, 0,  {|| "" }         ,  "Tip. Act."          , .F., "Tipo actuación"             , 10, .F. )
   ::AddField( "cNomAct",  "C", 35, 0,  {|| "" }         ,  "Actuación"          , .F., "Nombre actuación"           , 10, .F. )
   ::AddField( "cNumDoc",  "C", 14, 0,  {|| "" }         ,  "Documento"          , .T., "Número documento"           , 14, .F. )
   ::AddField( "dFecIni",  "D",  8, 0,  {|| "" }         ,  "Inicio"             , .T., "Fecha inicio"               , 10, .F. )
   ::AddField( "cHorIni",  "C",  5, 0,  {|| "" }         ,  "Hora inicio"        , .F., "Hora inicio"                , 10, .F. )
   ::AddField( "dFecFin",  "D",  8, 0,  {|| "" }         ,  "Límite"             , .T., "Fecha límite"               , 10, .F. )
   ::AddField( "cHorFin",  "C",  5, 0,  {|| "" }         ,  "Hora fin"           , .F., "Hora fin"                   , 10, .F. )
   ::AddField( "mMemAct",  "M", 10, 0,  {|| "" }         ,  "Descripción"        , .F., "Descripción"                , 50, .F. )
   ::AddField( "cCodCli",  "C", 12, 0,  {|| "" }         ,  "Cliente"            , .T., "Cliente"                    , 14, .F. )
   ::AddField( "cNomCli",  "C", 80, 0,  {|| "" }         ,  "Nombre cliente"     , .T., "Nombre cliente"             , 50, .F. )
   ::AddField( "cPerCto",  "C", 30, 0,  {|| "" }         ,  "Contacto"           , .T., "Persona de contacto"        , 30, .F. )
   ::AddField( "cTlfCto",  "C", 20, 0,  {|| "" }         ,  "Teléfono"           , .T., "Teléfono"                   , 25, .F. )
   ::AddField( "cMvlCto",  "C", 20, 0,  {|| "" }         ,  "Movil"              , .F., "Movil"                      , 25, .F. )
   ::AddField( "cFaxCto",  "C", 20, 0,  {|| "" }         ,  "Fax"                , .F., "Fax"                        , 25, .F. )

   ::AddTmpIndex( "cNumDoc", "cTipAct + cNumDoc" )

   ::AddGroup( {|| ::oDbf:cTipAct }, {|| "Tipo actuación  : " + Rtrim( ::oDbf:cTipAct ) + "-" + Rtrim( ::oDbf:cNomAct ) }, {||"Total tipo actuación..."} )

   ::lDefDivInf      := .F.
   ::lDefFecInf      := .F.

RETURN ( Self )



static FUNCTION EInfDiaActuaciones_OpenFiles( ) ; local Self AS CLASS EInfDiaActuaciones := QSelf() AS CLASS EInfDiaActuaciones

   local lOpen       := .T.
   local oError
   local oBlock      := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      ::oExpediente := DbfServer( "EXPCAB.DBF", ):NewOpen( "EXPCAB.DBF", "ExpCab", ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oExpediente:AddBag( "EXPCAB.CDX" ) ; ::oExpediente:AddBag( ) ; ::oExpediente:AutoIndex()

      ::oActuacion := DbfServer( "EXPDET.DBF", ):NewOpen( "EXPDET.DBF", "ExpDet", ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oActuacion:AddBag( "EXPDET.CDX" ) ; ::oActuacion:AddBag( ) ; ::oActuacion:AutoIndex()

      ::oTipoActuacion := DbfServer( "ACTUACIONES.DBF", ):NewOpen( "ACTUACIONES.DBF", "Actuac", ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oTipoActuacion:AddBag( "ACTUACIONES.CDX" ) ; ::oTipoActuacion:AddBag( ) ; ::oTipoActuacion:AutoIndex()

   RECOVER USING oError


      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos" )
      ::CloseFiles()
      lOpen          := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION EInfDiaActuaciones_CloseFiles( ) ; local Self AS CLASS EInfDiaActuaciones := QSelf() AS CLASS EInfDiaActuaciones

   if !Empty( ::oExpediente ) .AND. ::oExpediente:Used()
      ::oExpediente:end()
   end

   if !Empty( ::oActuacion ) .AND. ::oActuacion:Used()
      ::oActuacion:end()
   end

   if !Empty( ::oTipoActuacion ) .AND. ::oTipoActuacion:Used()
      ::oTipoActuacion:End()
   end

   ::oExpediente     := nil
   ::oActuacion      := nil
   ::oTipoActuacion  := nil

RETURN ( Self )



static FUNCTION EInfDiaActuaciones_lResource( cFld ) ; local Self AS CLASS EInfDiaActuaciones := QSelf() AS CLASS EInfDiaActuaciones

   if !::StdResource( "INFTACTUACIONES" )
      return .F.
   end

   if !::oDefCliInf( 110, 111, 120, 121, , 130 )
      return .F.
   end

   if !::oDefTipActInf( 150, 151, 160, 161, 140 )
      return .F.
   end



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, ::lAllAct, ::lAllAct:= u ) }, ::oFld:aDialogs[1],,,,,,, .F.,, .F. )






   ::oIniAct := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::dIniAct, ::dIniAct:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||        !::lAllAct},, .F., .T.,,,,,, nil,,, )






   ::oFinAct := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::dFinAct, ::dFinAct:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||        !::lAllAct},, .F., .T.,,,,,, nil,,, )



   TCheckBox():ReDefine( 200, { | u | If( PCount()==0, ::lPendientes, ::lPendientes:= u ) }, ::oFld:aDialogs[1],,,,,,, .F.,, .F. )

   ::CreateFilter( aItmActua(), ::oActuacion:cAlias )

   ::oMtrInf:SetTotal( ::oActuacion:Lastrec() )

RETURN .T.



static FUNCTION EInfDiaActuaciones_lGenerate( ) ; local Self AS CLASS EInfDiaActuaciones := QSelf() AS CLASS EInfDiaActuaciones

   local cExpHead    := ".t."

   ::oDlg:Disable()
   ::oBtnCancel:Enable()

   ::oDbf:Zap()




   ::aHeader         := {  {|| "Fecha     : " + Dtoc( Date() ) }, {|| "Periodo   : " + Dtoc( ::dIniInf ) + " > " + Dtoc( ::dFinInf ) }, {|| "Clientes  : " + if( ::lAllCli, "Todos", AllTrim( ::cCliOrg ) + " > " + AllTrim( ::cCliDes ) ) }, {|| "Actuación : " + if( ::lAllTipAct, "Todos", AllTrim( ::cTipActOrg ) + " > " + AllTrim( ::cTipActDes ) ) } }

   if ::lPendientes
      cExpHead       += " .and. !lActEnd"
   end

   if !::lAllAct
      cExpHead       += ' .and. dFecFin >= Ctod( "' + Dtoc( ::dIniAct ) + '" ) .and. dFecFin <= Ctod( "' + Dtoc( ::dFinAct ) + '" )'
   end

   if !::lAllTipAct
      cExpHead       += ' .and. cCodAct >= "' + Rtrim( ::cTipActOrg ) + '" .and. cCodAct <= "' + Rtrim( ::cTipActDes ) + '"'
   end

   if !Empty( ::oFilter:cExpresionFilter )
      cExpHead       += " .and. " + ::oFilter:cExpresionFilter
   end

   ::oActuacion:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oActuacion:cFile ), ::oActuacion:OrdKey(), ( cExpHead ), , , , , , , , .T. )

   ::oMtrInf:SetTotal( ::oActuacion:OrdKeyCount() )





   ::oActuacion:GoTop()

   while !::lBreak .AND. !::oActuacion:Eof()

      if lChkSer( ::oActuacion:cSerExp, ::aSer )


         if ::oExpediente:Seek( ::oActuacion:cSerExp + Str( ::oActuacion:nNumExp ) + ::oActuacion:cSufExp )  .AND. ( ::lAllCli .OR. ( ::oExpediente:cCodCli >= Rtrim( ::cCliOrg ) .AND. ::oExpediente:cCodCli <= Rtrim( ::cCliDes ) ) )

            ::oDbf:Append()

            ::oDbf:cTipAct    := ::oActuacion:cCodAct
            ::oDbf:cNomAct    := oRetFld( ::oActuacion:cCodAct, ::oTipoActuacion, "cDesAct" )
            ::oDbf:cNumDoc    := ::oActuacion:cSerExp + "/" + AllTrim( Str( ::oActuacion:nNumExp ) ) + "/" + ::oActuacion:cSufExp
            ::oDbf:cCodCli    := ::oExpediente:cCodCli
            ::oDbf:cNomCli    := oRetFld( ::oExpediente:cCodCli, ::oDbfCli, "Titulo" )
            ::oDbf:cPerCto    := oRetFld( ::oExpediente:cCodCli, ::oDbfCli, "cPerCto" )
            ::oDbf:cTlfCto    := oRetFld( ::oExpediente:cCodCli, ::oDbfCli, "Telefono" )
            ::oDbf:cMvlCto    := oRetFld( ::oExpediente:cCodCli, ::oDbfCli, "Movil" )
            ::oDbf:cFaxCto    := oRetFld( ::oExpediente:cCodCli, ::oDbfCli, "Fax" )
            ::oDbf:dFecIni    := ::oActuacion:dFecIni
            ::oDbf:cHorIni    := ::oActuacion:cHorIni
            ::oDbf:dFecFin    := ::oActuacion:dFecFin
            ::oDbf:cHorFin    := ::oActuacion:cHorFin
            ::oDbf:mMemAct    := ::oActuacion:mMemAct

            ::oDbf:Save()

         end

      end

      ::oActuacion:Skip()

      ::oMtrInf:AutoInc()

   end

   ::oActuacion:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oActuacion:cFile ) )

   ::oMtrInf:AutoInc( ::oActuacion:Lastrec() )

   ::oDlg:Enable()

RETURN ( ::oDbf:LastRec() > 0 )
