#line 91 "\fwh1801\include\FiveWin.ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 7 ".\.\Prg\ExportaCompras.prg"
memvar oFacPrvT
memvar oFacPrvL
memvar oDbfArt
memvar oDbfPrv
memvar cPirDiv



_HB_CLASS TExportaCompras ; function TExportaCompras ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TExportaCompras", iif( .T., { @TNewInfGen() }, { @HBObject() } ), @TExportaCompras() ) ) ;

   _HB_MEMBER { nLevel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nLevel"}, .F. )

   _HB_MEMBER { cFileTmp } ; oClass:AddMultiData(, Space( 1 ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileTmp"}, .F. )

   _HB_MEMBER { oBrwLin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwLin"}, .F. )
   _HB_MEMBER { oBtnAdd } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnAdd"}, .F. )
   _HB_MEMBER { oBtnEdit } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnEdit"}, .F. )
   _HB_MEMBER { oBtnDel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnDel"}, .F. )
   _HB_MEMBER { oBtnUp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnUp"}, .F. )
   _HB_MEMBER { oBtnDown } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnDown"}, .F. )
   _HB_MEMBER { oBtnSave } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnSave"}, .F. )
   _HB_MEMBER { oBtnLoad } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnLoad"}, .F. )

   _HB_MEMBER { lSuprEspacios } ; oClass:AddMultiData(, .T., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lSuprEspacios"}, .F. )

   _HB_MEMBER { oGetAncho } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetAncho"}, .F. )
   _HB_MEMBER { oGetExpresion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetExpresion"}, .F. )
   _HB_MEMBER { oSayExpresion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayExpresion"}, .F. )

   _HB_MEMBER { oTreeCampos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTreeCampos"}, .F. )

   _HB_MEMBER { aTipoExpresion } ; oClass:AddMultiData(, { "Campo", "Expresión", "Constante" }, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aTipoExpresion"}, .F. )
   _HB_MEMBER { oTipoExpresion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTipoExpresion"}, .F. )

   _HB_MEMBER { aAlign } ; oClass:AddMultiData(, { "Izquierda", "Derecha" }, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aAlign"}, .F. )
   _HB_MEMBER { oAlign } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlign"}, .F. )

   _HB_MEMBER { aFieldFacT } ; oClass:AddMultiData(, aItmFacPrv(), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aFieldFacT"}, .F. )
   _HB_MEMBER { aFieldFacL } ; oClass:AddMultiData(, aColFacPrv(), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aFieldFacL"}, .F. )
   _HB_MEMBER { aFieldArt } ; oClass:AddMultiData(, aItmArt(), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aFieldArt"}, .F. )
   _HB_MEMBER { aFieldPrv } ; oClass:AddMultiData(, aItmPrv(), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aFieldPrv"}, .F. )

   _HB_MEMBER { lChangeDbf } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lChangeDbf"}, .F. )

   _HB_MEMBER { oFacPrvL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacPrvL"}, .F. )

   _HB_MEMBER { cTextoFinal } ; oClass:AddMultiData(, "", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTextoFinal"}, .F. )

   _HB_MEMBER New( oMenuItem, oWnd); oClass:AddMethod( "New", @TExportaCompras_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CreateTemporal(); oClass:AddMethod( "CreateTemporal", @TExportaCompras_CreateTemporal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Play(); oClass:AddMethod( "Play", @TExportaCompras_Play(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TExportaCompras_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TExportaCompras_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lResource( cFld); oClass:AddMethod( "lResource", @TExportaCompras_lResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @TExportaCompras_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitDialog(); oClass:AddMethod( "InitDialog", @TExportaCompras_InitDialog(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Detalle( nMode); oClass:AddMethod( "Detalle", @TExportaCompras_Detalle(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EndDetalle( nMode); oClass:AddMethod( "EndDetalle", @TExportaCompras_EndDetalle(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DelRegTemporal(); oClass:AddMethod( "DelRegTemporal", @TExportaCompras_DelRegTemporal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SetDlgMode( lStart); oClass:AddMethod( "SetDlgMode", @TExportaCompras_SetDlgMode(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lCargaTreeCampos(); oClass:AddMethod( "lCargaTreeCampos", @TExportaCompras_lCargaTreeCampos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Cancelar(); oClass:AddMethod( "Cancelar", @TExportaCompras_Cancelar(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SaveConf(); oClass:AddMethod( "SaveConf", @TExportaCompras_SaveConf(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadConf(); oClass:AddMethod( "LoadConf", @TExportaCompras_LoadConf(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Exportacion(); oClass:AddMethod( "Exportacion", @TExportaCompras_Exportacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DblClickTree(); oClass:AddMethod( "DblClickTree", @TExportaCompras_DblClickTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TExportaCompras ;



static FUNCTION TExportaCompras_New( oMenuItem, oWndParent ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   If( oMenuItem == nil, oMenuItem := "01112", ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;

   ::nLevel          := Auth():Level( oMenuItem )

   if oWndParent <> nil
      oWndParent:CloseAll()
   end

   ::oDbf               := nil

RETURN Self



static FUNCTION TExportaCompras_Play( uParam ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return ( Self )
   end

   if ::OpenFiles()

      if ::lResource()
         ::Activate()
      end

   end

   ::CloseFiles()

RETURN ( Self )



static FUNCTION TExportaCompras_CreateTemporal( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   ::cFileTmp       := cGetNewFileName( cPatTmp() + "TExp" )

   ::oDbf := DbfServer( ( ::cFileTmp ), "TExp" ):New( ( ::cFileTmp ), "TExp", ( cLocalDriver() ), "Exportación", ( cPatTmp() ) )

      ::oDbf:AddField( "NTIPO", "N", 1, 0,,,,, "Tipo", .F.,, .F., {} )
      ::oDbf:AddField( "CCAMPO", "C", 25, 0,,,,, "Campo", .F.,, .F., {} )
      ::oDbf:AddField( "CDESCRIP", "C", 100, 0,,,,, "Nombre", .F.,, .F., {} )
      ::oDbf:AddField( "CTABLA", "C", 25, 0,,,,, "Alias", .F.,, .F., {} )
      ::oDbf:AddField( "MEXPRE", "M", 10, 0,,,,, "Expresion", .F.,, .F., {} )
      ::oDbf:AddField( "NANCHO", "N", 5, 0,,,,, "Ancho", .F.,, .F., {} )
      ::oDbf:AddField( "NALIGN", "N", 1, 0,,,,, "Alineación", .F.,, .F., {} )

      ::oDbf:AddIndex( ( Str( ::oDbf:Recno() ) ), ( ::cFileTmp ), ( Str( ::oDbf:Recno() ) ),,, .F., .F., "Orden",,, .T., .F. )



RETURN ::oDbf



static FUNCTION TExportaCompras_OpenFiles( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras





   ::CreateTemporal()

   ::oDbf:Activate( .F., .F. )

   ::oFacPrvL := DbfServer( "FACPRVL.DBF", ):NewOpen( "FACPRVL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacPrvL:AddBag( "FACPRVL.CDX" ) ; ::oFacPrvL:AddBag( ) ; ::oFacPrvL:AutoIndex()

   ::oDbfDiv := DbfServer( "DIVISAS.DBF", ):NewOpen( "DIVISAS.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfDiv:AddBag( "DIVISAS.CDX" ) ; ::oDbfDiv:AddBag( ) ; ::oDbfDiv:AutoIndex()

RETURN ( .T. )



static FUNCTION TExportaCompras_CloseFiles( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   if ::oDbfRut <> nil .AND. ::oDbfRut:Used()
      ::oDbfRut:End()
   end

   if ::oDbfPrv <> nil .AND. ::oDbfPrv:Used()
      ::oDbfPrv:End()
   end

   if ::oDbfArt <> nil .AND. ::oDbfArt:Used()
      ::oDbfArt:End()
   end

   if ::oFacPrvT <> nil .AND. ::oFacPrvT:Used()
      ::oFacPrvT:End()
   end

   if ::oFacPrvL <> nil .AND. ::oFacPrvL:Used()
      ::oFacPrvL:End()
   end

   if ::oDbfDiv <> nil .AND. ::oDbfDiv:Used()
      ::oDbfDiv:End()
   end

   if ::oGrpPrv <> nil
      ::oGrpPrv:End()
   end

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   ::oGrpPrv      := nil
   ::oDbfRut      := nil
   ::oDbfPrv      := nil
   ::oDbfArt      := nil
   ::oFacPrvT     := nil
   ::oFacPrvL     := nil
   ::oDbf         := nil
   ::oDbfDiv      := nil





   dbfErase( ::cFileTmp )

RETURN ( .T. )



static FUNCTION TExportaCompras_lResource( cFld ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   ::lNewInforme  := .T.





   ::lCreaArrayPeriodos()

   ::oDlg = TDialog():New(,,,, "Exportación de compras", "EXPCOMPRAS",, .F.,,,,, oWnd(), .F.,,,,,, .F.,, "::oDlg", nil, )





   ::oDefIniInf( 1110, ::oDlg )

   ::oDefFinInf( 1120, ::oDlg )

   ::lPeriodoInforme( 220, ::oDlg )





   ::oImageList                     := TImageList():New( 16, 16 )
   ::oTreeRango                     := TTreeView():Redefine( 100, ::oDlg )
   ::oTreeRango:bChanged            := {|| ::ChangeRango() }
   ::oTreeRango:bLostFocus          := {|| ::ChangeValor() }

   ::oDefTodos( 140, ::oDlg )
   ::oDefDesde( 110, 111, ::oDlg )
   ::oDefHasta( 120, 121, ::oDlg )





   ::lGrupoGProveedor()

   ::lGrupoProveedor()

   ::lGrupoArticulo()

   ::lGrupoFacturasCompras()







   TCheckBox():ReDefine( 150, { | u | If( PCount()==0, ::lSuprEspacios, ::lSuprEspacios:= u ) }, ::oDlg,,,,,,, .F.,, .F. )





   ::oDefSerInf( ::oDlg )





   ::oBrwLin                  := IXBrowse():New( ::oDlg )

   ::oBrwLin:bClrSel          := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
   ::oBrwLin:bClrSelFocus     := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

   ::oDbf:SetBrowse( ::oBrwLin )

   ::oBrwLin:nMarqueeStyle    := 5
   ::oBrwLin:lHScroll         := .F.

   ::oBrwLin:bLDblClick       := {|| ::Detalle( 2 ) }

   ::oBrwLin:CreateFromResource( 400 )

   with object ( ::oBrwLin:AddCol() )
      :cHeader                := "Tipo"
      :bEditValue             := {|| ::aTipoExpresion[ Max( ::oDbf:FieldGetByName( "nTipo" ), 1 ) ] }
      :nWidth                 := 90
   end

   with object ( ::oBrwLin:AddCol() )
      :cHeader                := "Expresión"
      :bEditValue             := {|| if( ::oDbf:FieldGetByName( "nTipo" ) > 1, ::oDbf:FieldGetByName( "mExpre" ), ::oDbf:FieldGetByName( "cDescrip" ) ) }
      :nWidth                 := 230
   end

   with object ( ::oBrwLin:AddCol() )
      :cHeader                := "Alineación"
      :bEditValue             := {|| ::aAlign[ Max( ::oDbf:FieldGetByName( "nAlign" ), 1 ) ] }
      :nWidth                 := 80
   end

   with object ( ::oBrwLin:AddCol() )
      :cHeader                := "Ancho"
      :bEditValue             := {|| ::oDbf:FieldGetByName( "nAncho" ) }
      :nWidth                 := 60
      :nDataStrAlign          := 1
      :nHeadStrAlign          := 1
   end








   ::oBtnAdd := TButton():ReDefine( 410, {||( ::Detalle( 1 ) )}, ::oDlg,,, .F.,,,, .F. )




   ::oBtnEdit := TButton():ReDefine( 420, {||( ::Detalle( 2 ) )}, ::oDlg,,, .F.,,,, .F. )




   ::oBtnDel := TButton():ReDefine( 430, {||( ::DelRegTemporal() )}, ::oDlg,,, .F.,,,, .F. )




   ::oBtnUp := TButton():ReDefine( 440, {||( DbSwapUp( ::oDbf:cAlias, ::oBrwLin ) )}, ::oDlg,,, .F.,,,, .F. )




   ::oBtnDown := TButton():ReDefine( 450, {||( DbSwapDown( ::oDbf:cAlias, ::oBrwLin ) )}, ::oDlg,,, .F.,,,, .F. )




   ::oBtnSave := TButton():ReDefine( 460, {||( ::SaveConf() )}, ::oDlg,,, .F.,,,, .F. )




   ::oBtnLoad := TButton():ReDefine( 470, {||( ::LoadConf() )}, ::oDlg,,, .F.,,,, .F. )





   ::oDefMetInf( 1160, ::oDlg )

   ::oMtrInf:nClrText   := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
   ::oMtrInf:nClrBar    := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
   ::oMtrInf:nClrBText  := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )








   ::oBtnAction := TButton():ReDefine( 500, {||( ::Exportacion() )}, ::oDlg,,, .F.,,,, .F. )





   ::oBtnCancel := TButton():ReDefine( 550, {||( ::Cancelar() )}, ::oDlg,,, .F.,,,, .T. )

RETURN ( .T. )



static FUNCTION TExportaCompras_Activate( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local lActivate

   if !Empty( ::oDlg )

      ::oDlg:AddFastKey( 113, {|| ::Detalle( 1 ) } )
      ::oDlg:AddFastKey( 114, {|| ::Detalle( 2 ) } )
      ::oDlg:AddFastKey( 115, {|| ::DelRegTemporal() } )
      ::oDlg:AddFastKey( 116, {|| ::Exportacion() } )

      if ::lNewInforme
         ::oDlg:bStart  := {|| ::InitDialog(), ::lRecargaFecha() }
      end

      ::oDlg:Activate( , , , .T. )

      lActivate         := ( ::oDlg:nResult == 1 )

   end

RETURN ( lActivate )



static FUNCTION TExportaCompras_InitDialog( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local n

   if !Empty( ::aSelectionRango )

      for n := 1 to len( ::aSelectionRango )
         with object ( ::oTreeRango:Add( ::aSelectionRango[ n ]:Cargo:Nombre, n - 1 ) )
            :Cargo := ::aSelectionRango[ n ]
         end
      next





      if len( ::oTreeRango:aItems ) > 0
         ::oTreeRango:Select( ::oTreeRango:aItems[ 1 ] )
         ::ChangeRango()
      end

   end

   ::oTreeRango:SetImagelist( ::oImageList )

RETURN ( Self )



static FUNCTION TExportaCompras_Detalle( nMode ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local oDlg

   do case
      case nMode == 1

         ::oDbf:Blank()

         ::oDbf:nTipo   := 1
         ::oDbf:nAncho  := 1
         ::oDbf:nAlign  := 1

      case nMode == 2

         if ::oDbf:RecCount() == 0
            Return .F.
         end

         ::oDbf:Load()

   end

   ::lChangeDbf         := .T.

   oDlg = TDialog():New(,,,, "Exportación de tarifas", "LEXPTARIFA",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




   ::oTipoExpresion := TComboBox():ReDefine( 100, { | u | If( PCount()==0, ::oDbf:nTipo, ::oDbf:nTipo:= u ) }, ::aTipoExpresion, oDlg,,,,,,, .F.,,,,,,, "::oTipoExpresion",,,,,,, )

      ::oTipoExpresion:bChange   := { || ::SetDlgMode( .F. ) }





   ::oGetAncho := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:nAncho, ::oDbf:nAncho:= u ) }, oDlg,, "99999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )

   ::oTreeCampos                 := TTreeView():Redefine( 120, oDlg )
   ::oTreeCampos:bLDblClick      := {|| ::DblClickTree( nMode, oDlg ) }



   ::oGetExpresion := TMultiGet():ReDefine( 130, { | u | If( PCount()==0, ::oDbf:mExpre, ::oDbf:mExpre:= u ) }, oDlg,,,,,,, .F.,, .F.,, )



   ::oSayExpresion := TSay():ReDefine( 131,, oDlg,,,, .F.,, .F., .F., )




   ::oAlign := TComboBox():ReDefine( 140, { | u | If( PCount()==0, ::oDbf:nAlign, ::oDbf:nAlign:= u ) }, ::aAlign, oDlg,,,,,,, .F.,,,,,,, "::oAlign",,,,,,, )




   TButton():ReDefine( 500, {||( ::EndDetalle( nMode, oDlg ) )}, oDlg,,, .F.,,,, .F. )





   ::oBtnCancel := TButton():ReDefine( 550, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart := {|| ::SetDlgMode( .T.) }

   oDlg:AddFastKey( 116, {|| ::EndDetalle( nMode, oDlg ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )





   if oDlg:nResult == 1

      do case
         case nMode == 1
            ::oDbf:Insert()

         case nMode == 2
            ::oDbf:Save()
      end

   else
      ::oDbf:Cancel()
   end

   ::oBrwLin:Refresh()

Return ( Self )



static FUNCTION TExportaCompras_DblClickTree( nMode, oDlg ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local oSelect   := ::oTreeCampos:GetSelected()

   if Len( oSelect:aItems ) <> 0
      oSelect:Expand()
   else
      ::EndDetalle( nMode, oDlg )
   end

Return ( Self )



static FUNCTION TExportaCompras_EndDetalle( nMode, oDlg ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local cFieldSelect   := ""
   local nPos

   if ::oDbf:nAncho < 1
      msgStop( "El ancho del campo tiene que ser mayor que 1." )
      ::oGetAncho:SetFocus()
      Return .F.
   end

   if ::oDbf:nTipo <> 1

      if Empty( ::oDbf:mExpre )
         msgStop( "La expresión no puede estar vacía." )
         ::oGetExpresion:SetFocus()
         Return .F.
      end

   else

      cFieldSelect   := ::oTreeCampos:GetSelText()





      if Empty( cFieldSelect )                                 .OR. AllTrim( cFieldSelect ) == "Facturas"                 .OR. AllTrim( cFieldSelect ) == "Lineas de facturas"       .OR. AllTrim( cFieldSelect ) == "Artículos"                .OR. AllTrim( cFieldSelect ) == "Proveedores"
         msgStop( "Tiene que seleccionar un campo." )
         ::oTreeCampos:SetFocus()
         Return .F.
      end





      do case
         case ( nPos := aScan( ::aFieldFacT, {|a| a[5] == cFieldSelect } ) ) <> 0

            ::oDbf:cCampo   := ::aFieldFacT[ nPos, 1 ]
            ::oDbf:cDescrip := cFieldSelect
            ::oDbf:cTabla   := "Cabecera"

         case ( nPos := aScan( ::aFieldFacL, {|a| a[5] == cFieldSelect } ) ) <> 0

            ::oDbf:cCampo   := ::aFieldFacL[ nPos, 1 ]
            ::oDbf:cDescrip := cFieldSelect
            ::oDbf:cTabla   := "Lineas"

         case ( nPos := aScan( ::aFieldArt, {|a| a[5] == cFieldSelect } ) ) <> 0

            ::oDbf:cCampo   := ::aFieldArt[ nPos, 1 ]
            ::oDbf:cDescrip := cFieldSelect
            ::oDbf:cTabla   := "Artículos"

         case ( nPos := aScan( ::aFieldPrv, {|a| a[5] == cFieldSelect } ) ) <> 0

            ::oDbf:cCampo   := ::aFieldPrv[ nPos, 1 ]
            ::oDbf:cDescrip := cFieldSelect
            ::oDbf:cTabla   := "Proveedores"

      end

   end

   if ::oDbf:nAlign < 1
      ::oDbf:Align          := 1
   end

   oDlg:End( 1 )

Return ( .T. )



static FUNCTION TExportaCompras_SetDlgMode( lStart ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   If( lStart == nil, lStart := .F., ) ;

   do case
      case ::oDbf:nTipo <= 1
         ::oGetExpresion:Hide()
         ::oTreeCampos:Show()
         ::oSayExpresion:SetText( "Campo" )
         ::lCargaTreeCampos()

      case ::oDbf:nTipo == 2
         ::oGetExpresion:Show()
         ::oTreeCampos:Hide()
         ::oSayExpresion:SetText( "Expresión" )

      case ::oDbf:nTipo == 3
         ::oGetExpresion:Show()
         ::oTreeCampos:Hide()
         ::oSayExpresion:SetText( "Constante" )

   end





   if !lStart
      ::oGetExpresion:cText( "" )
   end


Return ( .T. )



static FUNCTION TExportaCompras_DelRegTemporal( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   ::lChangeDbf   := .T.

   WinDelRec( , ::oDbf:cAlias )

   ::oBrwLin:Refresh()

Return ( .T. )



static FUNCTION TExportaCompras_lCargaTreeCampos( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local oTree
   local aField

   if ::oTreeCampos <> nil

      ::oTreeCampos:DeleteAll()





      oTree    := ::oTreeCampos:Add( "Proveedores" , 0 )

      for each aField in ::aFieldPrv
         if !Empty( aField[ 5 ] )
            oTree:Add( aField[ 5 ], 1 )
         end
      next





      oTree    := ::oTreeCampos:Add( "Artículos" , 0 )

      for each aField in ::aFieldArt
         if !Empty( aField[ 5 ] )
            oTree:Add( aField[ 5 ], 1 )
         end
      next





      oTree    := ::oTreeCampos:Add( "Facturas" , 0 )

      for each aField in ::aFieldFacT
         if !Empty( aField[ 5 ] )
            oTree:Add( aField[ 5 ], 1 )
         end
      next





      oTree    := ::oTreeCampos:Add( "Lineas de facturas" , 0 )

      for each aField in ::aFieldFacL
         if !Empty( aField[ 5 ] )
            oTree:Add( aField[ 5 ], 1 )
         end
      next

      ::oTreeCampos:Refresh()

   end

Return ( .T. )



static FUNCTION TExportaCompras_SaveConf( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local cGetFile
   local nHandle
   local aDir          := {}

   if ::oDbf:RecCount() == 0
      Return .F.
   end

   cGetFile      := cGetFile( "*.zip", "Seleccione el nombre del fichero a guardar" )

   if Empty( cGetFile )
      Return .F.
   end

   nHandle := fCreate( cGetFile )
   if nHandle <> -1

      if fClose( nHandle ) .AND. ( fErase( cGetFile ) == 0 )

         aDir     := Directory( ::cFileTmp + ".*" )

         ::oDbf:Close()

         hb_SetDiskZip( {|| nil } )
         aEval( aDir, { | cName, nIndex | hb_ZipFile( cGetFile, cPatTmp() + cName[ 1 ], 9 ) } )
         hb_gcAll()

         ::oDbf:ReActivate()

         msgInfo( "Documento exportado satisfactoriamente" )

      else

         MsgStop( "Error en la unidad" )

      end

   else

      MsgStop( "Ruta no válida" )

   end

   ::oBrwLin:Refresh()

Return ( .T. )



static FUNCTION TExportaCompras_LoadConf( cGetFile ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local aFiles      := {}
   local cNameFile

   if Empty( cGetFile )

      cGetFile    := cGetFile( "*.zip", "Selección de fichero" )

      if Empty( cGetFile )
         Return .F.
      end

   end





   if !file( cGetFile )
      MsgStop( "El fichero " + cGetFile + " no existe." )
      Return .F.
   end





   aFiles            := Hb_GetFilesInZip( cGetFile )

   if !Hb_UnZipFile( cGetFile, , , , cEmpTmp(), aFiles )
      MsgStop( "No se ha descomprimido el fichero " + cGetFile, "Error" )
      Return .F.
   end

   hb_gcAll()





   cNameFile         := Left( aFiles[ 1 ], At( ".", aFiles[ 1 ] ) - 1 )





   ::oDbf:Zap()
   ::oDbf:AppendFrom( cEmpTmp() + cNameFile + ".Dbf" )
   ::oDbf:ReindexAll()
   ::oDbf:GoTop()

   ::oBrwLin:Refresh()





   EraseFilesInDirectory(cEmpTmp(), cNameFile + ".*" )

   ::lChangeDbf      := .F.

Return ( .T. )



static FUNCTION TExportaCompras_Cancelar( ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras



   if ::lChangeDbf            .AND. ::oDbf:RecCount() <> 0  .AND. ApoloMsgNoYes(  "¿ Desea guardar los cambios en la configuración de la exportación ?", "Elija una opción" )

      ::SaveConf()

   end

   ::oDlg:End()

Return ( .T. )



static FUNCTION TExportaCompras_Exportacion( cGetFile, lOpenResult ) ; local Self AS CLASS TExportaCompras := QSelf() AS CLASS TExportaCompras

   local nHand
   local cExpHead       := ""
   local cExpLine       := ""
   local uField
   local lFirstLine     := .T.
   local lErrorBlock    := .F.

   If( lOpenResult == nil, lOpenResult := .T., ) ;

   public oFacPrvT      := ::oFacPrvT
   public oFacPrvL      := ::oFacPrvL
   public oDbfArt       := ::oDbfArt
   public oDbfPrv       := ::oDbfPrv
   public cPirDiv       := cPirDiv( cDivEmp(), ::oDbfDiv )

   if ::oDbf:RecCount() == 0
      MsgStop( "Tiene que cargar una configuración" )
      return .F.
   end

   if Empty( cGetFile )

      cGetFile          := cGetFile( "*.txt", "Selección de fichero" )

   end





   ::cTextoFinal     := ""





   ::oFacPrvT:OrdSetFocus( "dFecFac" )
   ::oFacPrvL:OrdSetFocus( "nNumFac" )
   ::oDbfArt:OrdSetFocus( "Codigo" )

   cExpHead          := 'lSndDoc .and. dFecFac >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. dFecFac <= Ctod( "' + Dtoc( ::dFinInf ) + '" )'

   if !::oGrupoFacturasCompras:Cargo:Todos
      cExpHead       += ' .and. cSerFac + Str( nNumFac ) + cSufFac >= "' + ::oGrupoFacturasCompras:Cargo:Desde + '" .and. cSerFac + Str( nNumFac ) + cSufFac <= "' + ::oGrupoFacturasCompras:Cargo:Hasta + '"'
   end

   if !::oGrupoProveedor:Cargo:Todos
      cExpHead       += ' .and. cCodPrv >= "' + Rtrim( ::oGrupoProveedor:Cargo:Desde ) + '" .and. cCodPrv <= "' + Rtrim( ::oGrupoProveedor:Cargo:Hasta ) + '"'
   end

   ::oFacPrvT:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oFacPrvT:cFile ), ::oFacPrvT:OrdKey(), ( cExpHead ), , , , , , , , .T. )

   ::oMtrInf:SetTotal( ::oFacPrvT:OrdKeyCount() )

   cExpLine          := "!lControl"

   if !::oGrupoArticulo:Cargo:Todos
      cExpLine       += ' .and. cRef >= "' + ::oGrupoArticulo:Cargo:Desde + '" .and. cRef <= "' + ::oGrupoArticulo:Cargo:Hasta + '"'
   end

   ::oFacPrvL:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oFacPrvL:cFile ), ::oFacPrvL:OrdKey(), cAllTrimer( cExpLine ), , , , , , , , .T. )

   ::oFacPrvT:GoTop()

    while !::oFacPrvT:Eof()




      if lChkSer( ::oFacPrvT:cSerFac, ::aSer )                                                     .AND. ( ::oGrupoGProveedor:Cargo:Todos                                                          .OR. ( oRetFld( ::oFacPrvT:cCodPrv, ::oDbfPrv, "CCODGRP" ) >= ::oGrupoGProveedor:Cargo:Desde   .AND. oRetFld( ::oFacPrvT:cCodPrv, ::oDbfPrv, "CCODGRP" ) <= ::oGrupoGProveedor:Cargo:Hasta ) )

         if ::oFacPrvL:Seek( ::oFacPrvT:cSerFac + Str( ::oFacPrvT:nNumFac ) + ::oFacPrvT:cSufFac )

            while ::oFacPrvT:cSerFac + Str( ::oFacPrvT:nNumFac ) + ::oFacPrvT:cSufFac == ::oFacPrvL:cSerFac + Str( ::oFacPrvL:nNumFac ) + ::oFacPrvL:cSufFac .AND. !::oFacPrvL:eof()

               if ::oDbfArt:Seek( ::oFacPrvL:cRef )

                  ::oDbf:GoTop()

                  while !::oDbf:Eof()





                     do case





                        case ::oDbf:nTipo <= 1

                           do case
                              case AllTrim( ::oDbf:cTabla )  == "Cabecera"

                                 if ::oDbf:nAlign <= 1

                                    if ::lSuprEspacios
                                       ::cTextoFinal     += AllTrim( cValToText( ::oFacPrvT:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) )
                                    else
                                       ::cTextoFinal     += Padr( AllTrim( cValToText( ::oFacPrvT:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) ), ::oDbf:nAncho )
                                    end

                                 elseif ::oDbf:nAlign == 2

                                    if ::lSuprEspacios
                                       ::cTextoFinal     += AllTrim( cValToText( ::oFacPrvT:FieldGetByName( AllTrim( ::oDbf:cCampo ), .T. ) ) )
                                    else
                                       ::cTextoFinal     += Padl( AllTrim( cValToText( ::oFacPrvT:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) ), ::oDbf:nAncho )
                                    end

                                 end

                              case AllTrim( ::oDbf:cTabla ) == "Lineas"

                                 if ::oDbf:nAlign <= 1

                                    if ::lSuprEspacios
                                       ::cTextoFinal     += AllTrim( cValToText( ::oFacPrvL:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) )
                                    else
                                       ::cTextoFinal     += Padr( AllTrim( cValToText( ::oFacPrvL:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) ), ::oDbf:nAncho )
                                    end

                                 elseif ::oDbf:nAlign == 2

                                    if ::lSuprEspacios
                                       ::cTextoFinal     += AllTrim( cValToText( ::oFacPrvL:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) )
                                    else
                                       ::cTextoFinal     += Padl( AllTrim( cValToText( ::oFacPrvL:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) ), ::oDbf:nAncho )
                                    end

                                 end

                              case AllTrim( ::oDbf:cTabla ) == "Artículos"

                                 if ::oDbf:nAlign <= 1

                                    if ::lSuprEspacios
                                       ::cTextoFinal     += AllTrim( cValToText( ::oDbfArt:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) )
                                    else
                                       ::cTextoFinal     += Padr( AllTrim( cValToText( ::oDbfArt:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) ), ::oDbf:nAncho )
                                    end

                                 elseif ::oDbf:nAlign == 2

                                    if ::lSuprEspacios
                                       ::cTextoFinal     += AllTrim( cValToText( ::oDbfArt:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) )
                                    else
                                       ::cTextoFinal     += Padl( AllTrim( cValToText( ::oDbfArt:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) ), ::oDbf:nAncho )
                                    end

                                 end

                              case AllTrim( ::oDbf:cTabla ) == "Proveedores"

                                 if ::oDbf:nAlign <= 1

                                    if ::lSuprEspacios
                                       ::cTextoFinal     += AllTrim( cValToText( ::oDbfPrv:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) )
                                    else
                                       ::cTextoFinal     += Padr( AllTrim( cValToText( ::oDbfPrv:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) ), ::oDbf:nAncho )
                                    end

                                 elseif ::oDbf:nAlign == 2

                                    if ::lSuprEspacios
                                       ::cTextoFinal     += AllTrim( cValToText( ::oDbfPrv:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) )
                                    else
                                       ::cTextoFinal     += Padl( AllTrim( cValToText( ::oDbfPrv:FieldGetByName( AllTrim( ::oDbf:cCampo ) ), .T. ) ), ::oDbf:nAncho )
                                    end

                                 end

                           end





                        case ::oDbf:nTipo == 2

                           uField               := bCheck2Block( AllTrim( ::oDbf:mExpre ), lFirstLine )

                           if uField <> nil
                              uField            := Eval( uField )
                           else
                              lErrorBlock       := .T.
                           end

                           if ::oDbf:nAlign <= 1

                              if ::lSuprEspacios
                                 ::cTextoFinal        += AllTrim( cValToText( uField, .T. ) )
                              else
                                 ::cTextoFinal        += Padr( AllTrim( cValToText( uField, .T. ) ), ::oDbf:nAncho )
                              end

                           elseif ::oDbf:nAlign == 2

                              if ::lSuprEspacios
                                 ::cTextoFinal        += AllTrim( cValToText( uField, .T. ) )
                              else
                                 ::cTextoFinal        += Padl( AllTrim( cValToText( uField, .T. ) ), ::oDbf:nAncho )
                              end

                           end





                        case ::oDbf:nTipo >= 3

                           if ::oDbf:nAlign <= 1

                              if ::lSuprEspacios
                                 ::cTextoFinal        += AllTrim( ::oDbf:mExpre )
                              else
                                 ::cTextoFinal        += Padr( AllTrim( ::oDbf:mExpre ), ::oDbf:nAncho )
                              end

                           elseif ::oDbf:nAlign == 2

                              if ::lSuprEspacios
                                 ::cTextoFinal        += AllTrim( ::oDbf:mExpre )
                              else
                                 ::cTextoFinal        += Padl( AllTrim( ::oDbf:mExpre ), ::oDbf:nAncho )
                              end

                           end

                     end

                     ::oDbf:Skip()

                  end

                  ::cTextoFinal                 += Chr(13)+Chr(10)

                  lFirstLine                    := .F.

               end

               ::oFacPrvL:Skip()

            end

         end





         ::oFacPrvT:FieldPutByName( "lSndDoc", .F. )

      end

      ::oFacPrvT:Skip()

      ::oMtrInf:AutoInc()

   end

   ::oMtrInf:AutoInc( ::oFacPrvT:Lastrec() )





   ::oFacPrvT:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oFacPrvT:cFile ) )

   ::oFacPrvL:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oFacPrvL:cFile ) )

   if !lErrorBlock





      fErase( cGetFile )
      nHand       := fCreate( cGetFile )
      fWrite( nHand, ::cTextoFinal )
      fClose( nHand )





      if lOpenResult


         if ApoloMsgNoYes( "Proceso de exportación realizado con éxito" + Chr(13)+Chr(10) +  "¿ Desea abrir el fichero resultante ?", "Elija una opción." )
            ShellExecute( 0, "open", cGetFile, , , 1 )
         end

      end

   else

      MsgStop( "Error en el proceso de exportación" )

   end





   ::oDbf:GoTop()
   ::oBrwLin:Refresh()

RETURN ( .T. )
