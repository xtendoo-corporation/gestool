#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 46 ".\.\Prg\FacAuto.prg"
Function StartTFacAutomatica()

   local oTFacAutomatica

   oTFacAutomatica   := TFacAutomatica():New( cPatEmp(), oWnd(), "plantillas_automaticas" )

   if !Empty( oTFacAutomatica )
      oTFacAutomatica:Activate()
   end

Return nil



_HB_CLASS TFacAutomatica ; function TFacAutomatica ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFacAutomatica", iif( .T., { @TMasDet() }, { @HBObject() } ), @TFacAutomatica() ) ) ;

   _HB_MEMBER { oDetFacAutomatica } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDetFacAutomatica"}, .F. )
   _HB_MEMBER { oHisFacAutomatica } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oHisFacAutomatica"}, .F. )

   _HB_MEMBER { cBitmap } ; oClass:AddMultiData(, ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cBitmap"}, .F. )

   _HB_MEMBER { oDbfIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfIva"}, .F. )
   _HB_MEMBER { oDbfFPago } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfFPago"}, .F. )
   _HB_MEMBER { oDbfAge } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfAge"}, .F. )

   _HB_MEMBER { oGrpFacturasAutomaticas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGrpFacturasAutomaticas"}, .F. )

   _HB_MEMBER { aTotIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aTotIva"}, .F. )

   _HB_MEMBER { oGetBrt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetBrt"}, .F. )
   _HB_MEMBER { oGetNet } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetNet"}, .F. )
   _HB_MEMBER { oGetIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetIva"}, .F. )
   _HB_MEMBER { oGetTotal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetTotal"}, .F. )

   _HB_MEMBER { nTotBrt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nTotBrt"}, .F. )
   _HB_MEMBER { nTotNet } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nTotNet"}, .F. )
   _HB_MEMBER { nTotIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nTotIva"}, .F. )
   _HB_MEMBER { nTotFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nTotFac"}, .F. )

   _HB_MEMBER { oBrwIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwIva"}, .F. )
   _HB_MEMBER { oBrwLineas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwLineas"}, .F. )
   _HB_MEMBER { oBrwHistorial } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwHistorial"}, .F. )

   _HB_MEMBER { oFont } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFont"}, .F. )

   _HB_MEMBER { oBtnKit } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnKit"}, .F. )

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )
   _HB_MEMBER { aGet } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aGet"}, .F. )

   _HB_MEMBER New( cPath, oWndParent, oMenuItem); oClass:AddMethod( "New", @TFacAutomatica_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER Create( cPath, oWndParent); oClass:AddMethod( "Create", @TFacAutomatica_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @TFacAutomatica_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles( lExclusive); oClass:AddMethod( "OpenFiles", @TFacAutomatica_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER OpenService( lExclusive); oClass:AddMethod( "OpenService", @TFacAutomatica_OpenService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TFacAutomatica_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseService(); oClass:AddMethod( "CloseService", @TFacAutomatica_CloseService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TFacAutomatica_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode); oClass:AddMethod( "Resource", @TFacAutomatica_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER NextResource( nMode); oClass:AddMethod( "NextResource", @TFacAutomatica_NextResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER PriorResource( nMode); oClass:AddMethod( "PriorResource", @TFacAutomatica_PriorResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER StartResource(); oClass:AddMethod( "StartResource", @TFacAutomatica_StartResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER SaveResource(); oClass:AddMethod( "SaveResource", @TFacAutomatica_SaveResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nCalculoTotal(); oClass:AddMethod( "nCalculoTotal", @TFacAutomatica_nCalculoTotal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ShowKit( lSet); oClass:AddMethod( "ShowKit", @TFacAutomatica_ShowKit(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ExternalEdit( cCodFac); oClass:AddMethod( "ExternalEdit", @TFacAutomatica_ExternalEdit(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RunPlantillaAutomatica( cCodigoPlantilla); oClass:AddMethod( "RunPlantillaAutomatica", @TFacAutomatica_RunPlantillaAutomatica(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFacAutomatica ;



static FUNCTION TFacAutomatica_New( cPath, oWndParent, oMenuItem ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;

   if oMenuItem <> nil .AND. ::nLevel == nil
      ::nLevel                := Auth():Level( oMenuItem )
   else
      ::nLevel                := 0
   end

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return nil
   end

   ::cBitmap                  := ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) )

   ::cPath                    := cPath
   ::oWndParent               := oWndParent

   ::bFirstKey                := {|| ::oDbf:cCodFac }

   ::oDetFacAutomatica        := TDetFacAutomatica():New( cPath, cDriver(), Self )
   ::AddDetail( ::oDetFacAutomatica )

   ::oHisFacAutomatica        := THisFacAutomatica():New( cPath, cDriver(), Self )
   ::AddDetail( ::oHisFacAutomatica )

   ::oGrpFacturasAutomaticas  := TGrpFacturasAutomaticas():Create( cPatEmp() )

   ::aTotIva                  := { { 0,0,nil,0 }, { 0,0,nil,0 }, { 0,0,nil,0 } }

   ::nTotBrt                  := 0
   ::nTotNet                  := 0
   ::nTotIva                  := 0
   ::nTotFac                  := 0

RETURN ( Self )



static FUNCTION TFacAutomatica_Create( cPath, oWndParent ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;

   ::cPath                    := cPath
   ::oWndParent               := oWndParent

   ::oDetFacAutomatica        := TDetFacAutomatica():New( cPath, cDriver(), Self )
   ::AddDetail( ::oDetFacAutomatica )

   ::oHisFacAutomatica        := THisFacAutomatica():New( cPath, cDriver(), Self )
   ::AddDetail( ::oHisFacAutomatica )

   ::oGrpFacturasAutomaticas  := TGrpFacturasAutomaticas():Create( cPatEmp() )

   ::bFirstKey                := {|| ::oDbf:cCodFac }

   ::aTotIva                  := { { 0,0,nil,0 }, { 0,0,nil,0 }, { 0,0,nil,0 } }

   ::nTotBrt                  := 0
   ::nTotNet                  := 0
   ::nTotIva                  := 0
   ::nTotFac                  := 0

RETURN ( Self )



static FUNCTION TFacAutomatica_Activate( ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   local oGen

   if ::oWndParent <> nil
      ::oWndParent:CloseAll()
   end

   if !::OpenFiles()
      return nil
   end















   ::oWndBrw := TShell():New( 2, 10, 18, 70, "Plantillas de ventas automáticas",, ::oWndParent,,, .F.,,, ( ::oDbf ),,,,, {"Código", "Nombre", "Grupo"}, {||::Append()}, {||::Edit()}, {||::Del()}, {||::Dup()}, nil, ::nLevel, "gc_document_text_gear_16", ( 104 + ( 0 * 256 ) + ( 63 * 65536 ) ),,, .T. )



      with object ( ::oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodFac"
         :bEditValue       := {|| ::oDbf:FieldGetByName( "cCodFac" ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | ::oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( ::oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomFac"
         :bEditValue       := {|| ::oDbf:FieldGetByName( "cNomFac" ) }
         :nWidth           := 500
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | ::oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( ::oWndBrw:AddXCol() )
         :cHeader          := "Grupo"
         :bEditValue       := {|| ::oDbf:FieldGetByName( "cCodGrp" ) }
         :nWidth           := 80
         :cSortOrder       := "cCodGrp"
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | ::oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( ::oWndBrw:AddXCol() )
         :cHeader          := "Inicio"
         :bEditValue       := {|| Dtoc( ::oDbf:FieldGetByName( "dFecIni" ) ) }
         :nWidth           := 80
      end

      with object ( ::oWndBrw:AddXCol() )
         :cHeader          := "Fin"
         :bEditValue       := {|| Dtoc( ::oDbf:FieldGetByName( "dFecFin" ) ) }
         :nWidth           := 80
      end

      with object ( ::oWndBrw:AddXCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| Trans( ::nCalculoTotal( .T. ), ::cPorDiv ) }
         :nWidth           := 85
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      ::oWndBrw:CreateXFromCode()






   ::oWndBrw:NewAt( "BUS",,, {||( ::oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )
      ::oWndBrw:AddSeaBar()








   ::oWndBrw:NewAt( "NEW",,, {||( ::oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )






   ::oWndBrw:NewAt( "DUP",,, {||( ::oWndBrw:RecDup() )}, "(D)uplicar", "D",,, 2,, .F. )






   ::oWndBrw:NewAt( "EDIT",,, {||( ::oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )






   ::oWndBrw:NewAt( "ZOOM",,, {||( ::Zoom() )}, "(Z)oom", "Z",,, 8,, .F. )






   ::oWndBrw:NewAt( "DEL",,, {||( ::oWndBrw:RecDel() )}, "(E)liminar", "E",,, 16,, .F. )





   oGen := ::oWndBrw:NewAt( "GC_FLASH_",,, {||( ::RunPlantillaAutomatica( ::oDbf:cCodFac ) )}, "(G)enerar ahora", "G",,,,, .F. )




      ::oWndBrw:NewAt( "GC_FLASH_",,, {||( ::RunPlantillaAutomatica() )}, "Generar todas ahora",,,,, oGen, .F. )





   ::oWndBrw:NewAt( "END",,, {||( ::oWndBrw:end() )}, "(S)alir", "S",,,,, .F. )

   if ::cHtmlHelp <> nil
      ::oWndBrw:cHtmlHelp  := ::cHtmlHelp
   end

   ::oWndBrw:Activate(, ::oWndBrw:bLClicked, ::oWndBrw:bRClicked, ::oWndBrw:bMoved, ::oWndBrw:bResized, ::oWndBrw:bPainted, ::oWndBrw:bKeyDown, ::oWndBrw:bInit,,,,,,,,, {|| ( ::CloseFiles() )},, ::oWndBrw:bLButtonUp, .F. )

RETURN ( Self )



static FUNCTION TFacAutomatica_OpenFiles( lExclusive ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   local lOpen          := .T.
   local oError
   local oBlock

   If( lExclusive == nil, lExclusive := .F., ) ;

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::oDbfFPago := DbfServer( "FPAGO.DBF", ):NewOpen( "FPAGO.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfFPago:AddBag( "FPAGO.CDX" ) ; ::oDbfFPago:AddBag( ) ; ::oDbfFPago:AutoIndex()

      ::oDbfAge := DbfServer( "AGENTES.DBF", ):NewOpen( "AGENTES.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfAge:AddBag( "AGENTES.CDX" ) ; ::oDbfAge:AddBag( ) ; ::oDbfAge:AutoIndex()

      ::oDbfIva := DbfServer( "TIVA.DBF", ):NewOpen( "TIVA.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfIva:AddBag( "TIVA.CDX" ) ; ::oDbfIva:AddBag( ) ; ::oDbfIva:AutoIndex()

      ::lLoadDivisa()

      if Empty( ::oDbf )
         ::DefineFiles()
      end

      ::oDbf:Activate( .F., !lExclusive )

      if !Empty( ::oGrpFacturasAutomaticas )
         ::oGrpFacturasAutomaticas:OpenFiles()
      end

      ::OpenDetails()

      ::oFont                    := TFont():New( "Arial", 8, 26, .F., .T. )

   RECOVER USING oError

      lOpen                      := .F.

      msgStop( "Imposible abrir las bases de datos de facturas automáticas." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !lOpen
      ::CloseFiles()
   end

RETURN ( lOpen )



static FUNCTION TFacAutomatica_OpenService( lExclusive, cPath ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   local lOpen          := .T.
   local oError
   local oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   If( lExclusive == nil, lExclusive := .F., ) ;

   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::DefineFiles( cPath )
      end

      ::oDbf:Activate( .F., !lExclusive )

   RECOVER USING oError

      lOpen             := .F.

      ::CloseService()

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TFacAutomatica_CloseService( ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   ::oDbf   := nil

RETURN ( .T. )



static FUNCTION TFacAutomatica_CloseFiles( ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   if ::oDbfFPago <> nil .AND. ::oDbfFPago:Used()
      ::oDbfFPago:End()
   end

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   if ::oDbfIva <> nil .AND. ::oDbfIva:Used()
      ::oDbfIva:End()
   end

   if ::oDbfAge <> nil .AND. ::oDbfAge:Used()
      ::oDbfAge:End()
   end

   if ::oGrpFacturasAutomaticas <> nil
      ::oGrpFacturasAutomaticas:End()
   end

   if ::oFont <> nil
      ::oFont:End()
   end

   ::CloseDetails()

   ::oDbf                     := nil
   ::oDbfIva                  := nil
   ::oDbfFPago                := nil

   ::oGrpFacturasAutomaticas  := nil

   ::oFont                    := nil

RETURN ( .T. )



static FUNCTION TFacAutomatica_DefineFiles( cPath, cDriver ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   If( cPath == nil, cPath := ::cPath, ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   ::oDbf := DbfServer( "FacAutT.DBF", "FacAutT" ):New( "FacAutT.DBF", "FacAutT", ( cDriver ), "Plantilla venta automática", ( cPath ) )

      ::oDbf:AddField( "cCodFac", "C", 03, 0,,,,, "Código", .F., 80, .F., {} )
      ::oDbf:AddField( "cNomFac", "C", 50, 0,,,,, "Nombre", .F., 200, .F., {} )
      ::oDbf:AddField( "dFecIni", "D", 08, 0,,,,, "Fecha inicio", .F.,, .T., {} )
      ::oDbf:AddField( "dFecFin", "D", 08, 0,,,,, "Fecha fin", .F.,, .T., {} )
      ::oDbf:AddField( "cDiaSel", "C", 30, 0,,,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "cMesSel", "C", 50, 0,,,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "lDiaSel", "L", 01, 0,,,,, "Lógico para plantilla de diario", .F.,, .T., {} )
      ::oDbf:AddField( "lUseCli", "L", 01, 0,,,,, "Lógico para usar descuentos del cliente", .F.,, .T., {} )
      ::oDbf:AddField( "cDtoEsp", "C", 50, 0,,,,, "Descripción de porcentaje de descuento especial", .F.,, .T., {} )
      ::oDbf:AddField( "nDtoEsp", "N", 06, 2,,,,, "Porcentaje de descuento especial", .F.,, .T., {} )
      ::oDbf:AddField( "cDpp", "C", 50, 0,,,,, "Descripción de porcentaje de descuento por pronto pago", .F.,, .T., {} )
      ::oDbf:AddField( "nDpp", "N", 06, 2,,,,, "Porcentaje de descuento por pronto pago", .F.,, .T., {} )
      ::oDbf:AddField( "cDtoUno", "C", 50, 0,,,,, "Descripción de porcentaje de descuento personalizado", .F.,, .T., {} )
      ::oDbf:AddField( "nDtoUno", "N", 06, 2,,,,, "Porcentaje de descuento por descuento personalizado", .F.,, .T., {} )
      ::oDbf:AddField( "cDtoDos", "C", 50, 0,,,,, "Descripción de porcentaje de descuento personalizado", .F.,, .T., {} )
      ::oDbf:AddField( "nDtoDos", "N", 06, 2,,,,, "Porcentaje de descuento por descuento personalizado", .F.,, .T., {} )
      ::oDbf:AddField( "nIvaMan", "N", 06, 2,,,,, "Porcentaje " + cImp() + " mano de obra", .F.,, .T., {} )
      ::oDbf:AddField( "nManObr", "N", 16, 6,,,,, "Mano de obra", .F.,, .T., {} )
      ::oDbf:AddField( "cManObr", "C", 250, 0,,,,, "Descripción mano de obra", .F.,, .T., {} )
      ::oDbf:AddField( "nDiaFact", "N", 02, 0,,,,, "Día de facturación", .F.,, .T., {} )
      ::oDbf:AddField( "nTipDoc", "N", 01, 0,,,,, "Tipo de documento", .F.,, .T., {} )
      ::oDbf:AddField( "cSerFact", "C", 01, 0,,,,, "Serie de facturación", .F.,, .T., {} )
      ::oDbf:AddField( "cCodPago", "C", 02, 0,,,,, "Foma de pago", .F.,, .T., {} )
      ::oDbf:AddField( "cCodGrp", "C", 04, 0,,,,, "Código de grupo", .F.,, .T., {} )
      ::oDbf:AddField( "nPerSel", "N", 3, 0,,,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "cPerSel", "C", 20, 0,,,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "dNexFac", "D", 08, 0,,,,, "Fecha de próxima factura", .F.,, .T., {} )
      ::oDbf:AddField( "mGrpSel", "M", 10, 0,,,,, "", .F.,, .T., {} )

      ::oDbf:AddIndex( "cCodFac", "FacAutT.Cdx", "Field->cCodFac",,, .F., .F., "Código",,, .T., .F. )
      ::oDbf:AddIndex( "cNomFac", "FacAutT.Cdx", "Field->cNomFac",,, .F., .F., "Nombre",,, .T., .F. )
      ::oDbf:AddIndex( "cCodGrp", "FacAutT.Cdx", "Field->cCodGrp",,, .F., .F., "Grupo",,, .T., .F. )



RETURN ( ::oDbf )



static FUNCTION TFacAutomatica_Resource( nMode ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   local oFld
   local aMes           := Array( 12 )
   local oSayTot
   local oBmpGeneral
   local oBmpFolder

   ::aGet               := Array( ::oDbf:FieldCount )

   if nMode == 1
      ::oDbf:cDtoEsp    := "General"
      ::oDbf:nDtoEsp    := 0
      ::oDbf:cDpp       := "Pronto pago"
      ::oDbf:nDpp       := 0
      ::oDbf:cDtoUno    := Space( 50 )
      ::oDbf:nDtoUno    := 0
      ::oDbf:cDtoDos    := Space( 50 )
      ::oDbf:nDtoDos    := 0
      ::oDbf:nIvaMan    := 0
      ::oDbf:nManObr    := 0
      ::oDbf:cManObr    := getConfigTraslation( "Gastos" )
      ::oDbf:nDiaFact   := 1
      ::oDbf:nTipDoc    := 2
      ::oDbf:dFecIni    := GetSysDate()
      ::oDbf:dNexFac    := GetSysDate()
   end

   ::oDlg = TDialog():New(,,,, LblTitle( nMode ) + "plantilla venta automática", "FacAutomatica",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )












      oFld := TFolder():ReDefine( 400, {"&Documento", "&Historico"}, { "FACAUT_1","FACAUT_2" }, ::oDlg,,,,, .F., )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_document_text_gear_48",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )











      ::aGet[ 1 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:cCodFac, ::oDbf:cCodFac:= u ) }, oFld:aDialogs[1],,, {||    NotValid( ::aGet[ 1 ], ::oDbf:cAlias, .T., "0" )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,,, nil,,, )




      ::aGet[ 2 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbf:cNomFac, ::oDbf:cNomFac:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )










      ::aGet[ 3 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbf:dFecIni, ::oDbf:dFecIni:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      ::aGet[ 4 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::oDbf:dFecFin, ::oDbf:dFecFin:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      ::aGet[ ::oDbf:FieldPos( "nPerSel" ) ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::oDbf:nPerSel, ::oDbf:nPerSel:= u ) }, oFld:aDialogs[1],, "999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      ::aGet[ ::oDbf:FieldPos( "cPerSel") ] := TComboBox():ReDefine( 161, { | u | If( PCount()==0, ::oDbf:cPerSel, ::oDbf:cPerSel:= u ) }, ( { "Día", "Semana", "Mes", "Año" } ), oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, '::aGet[ ::oDbf:FieldPos( "cPerSel") ]',,,,,,, )






      ::aGet[ ::oDbf:FieldPos( "dNexFac" ) ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, ::oDbf:dNexFac, ::oDbf:dNexFac:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      ::aGet[ 22 ] := TGetHlp():ReDefine( 440, { | u | If( PCount()==0, ::oDbf:cSerFact, ::oDbf:cSerFact:= u ) }, oFld:aDialogs[ 1 ],, "@!", {||    ( Empty( ::oDbf:cSerFact ) .OR. ( ::oDbf:cSerFact >= "A" .AND. ::oDbf:cSerFact <= "Z" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T., {||    ( UpSerie( ::aGet[ 22 ] ) )}, {||  ( DwSerie( ::aGet[ 22 ] ) )},,,, nil,,, )






      ::aGet[ ::oDbf:FieldPos( "cCodGrp" ) ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::oDbf:cCodGrp, ::oDbf:cCodGrp:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 151 )

         ::aGet[ ::oDbf:FieldPos( "cCodGrp" ) ]:bValid   := {|| ::oGrpFacturasAutomaticas:Existe( ::aGet[ ::oDbf:FieldPos( "cCodGrp" ) ], ::aGet[ ::oDbf:FieldPos( "cCodGrp" ) ]:oHelpText, "cNomGrp", .T., .T., "0" ) }
         ::aGet[ ::oDbf:FieldPos( "cCodGrp" ) ]:bHelp    := {|| ::oGrpFacturasAutomaticas:Buscar( ::aGet[ ::oDbf:FieldPos( "cCodGrp" ) ] ) }






      ::aGet[ 23 ] := TGetHlp():ReDefine( 450, { | u | If( PCount()==0, ::oDbf:cCodPago, ::oDbf:cCodPago:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 451 )

         ::aGet[ 23 ]:bValid   := {|| cFPago( ::aGet[ 23 ], ::oDbfFPago:cAlias, ::aGet[ 23 ]:oHelpText ) }
         ::aGet[ 23 ]:bHelp    := {|| BrwFPago( ::aGet[ 23 ], ::aGet[ 23 ]:oHelpText ) }




      ::aGet[ 8 ] := TCheckBox():ReDefine( 170, { | u | If( PCount()==0, ::oDbf:lUseCli, ::oDbf:lUseCli:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      ::aGet[ 21 ] := TRadMenu():Redefine( { | u | If( PCount()==0, ::oDbf:nTipDoc, ::oDbf:nTipDoc:= u ) }, oFld:aDialogs[1],, { 420, 430 },,,,, .F., {||     ( nMode <> 3 )}, )





      ::oGrpFacturasAutomaticas:RedefineBrowse( 500, oFld:aDialogs[ 1 ] )










      TButton():ReDefine( 510, {||( ::oDetFacAutomatica:AppendDet( ::oBrwLineas ), ::nCalculoTotal() )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 520, {||( ::oDetFacAutomatica:Edit( ::oBrwLineas ), ::nCalculoTotal() )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 530, {||( ::oDetFacAutomatica:Del( ::oBrwLineas ), ::nCalculoTotal()  )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 540, {||( ::oDetFacAutomatica:Zoom( ::oBrwLineas ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





      TButton():ReDefine( 550, {||( DbSwapUp( ::oDetFacAutomatica:oDbfVir:cAlias, ::oBrwLineas ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 560, {||( DbSwapDown( ::oDetFacAutomatica:oDbfVir:cAlias, ::oBrwLineas ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





      ::oBtnKit := TButton():ReDefine( 570, {||( ::ShowKit( .T. ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )

      ::oBrwLineas                 := IXBrowse():New( oFld:aDialogs[1] )

      ::oBrwLineas:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwLineas:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      ::oBrwLineas:nRowHeight      := 18
      ::oBrwLineas:nMarqueeStyle   := 6
      ::oBrwLineas:cName           := "Lineas de plantilla venta automáticas"

      ::oDetFacAutomatica:oDbfVir:SetBrowse( ::oBrwLineas )

      ::oBrwLineas:CreateFromResource( 200 )

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Número"
         :bEditValue          := {|| ::oDetFacAutomatica:oDbfVir:FieldGetByName( "nNumLin" ) }
         :cEditPicture        := "9999"
         :nWidth              := 65
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Código"
         :bStrData            := {|| ::oDetFacAutomatica:oDbfVir:FieldGetByName( "cCodArt" ) }
         :nWidth              := 80
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| ::oDetFacAutomatica:Descrip() }
         :nWidth              := 470
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ::oDetFacAutomatica:oDbfVir:FieldGetByName( "cValPr1" ) }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ::oDetFacAutomatica:oDbfVir:FieldGetByName( "cValPr2" ) }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := cNombreCajas()
         :bEditValue          := {|| ::oDetFacAutomatica:oDbfVir:FieldGetByName( "nCajas" ) }
         :cEditPicture        := MasUnd()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| ::oDetFacAutomatica:oDbfVir:FieldGetByName( "nUnidades" ) }
         :cEditPicture        := MasUnd()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Sumar unidades"
         :bStrData            := {|| "" }
         :bOnPostEdit         := {|| .T. }
         :bEditBlock          := {|| ::oDetFacAutomatica:oDbfVir:FieldPutByName( "nUnidades", ::oDetFacAutomatica:oDbfVir:FieldGetByName( "nUnidades" ) + 1 ), ::nCalculoTotal() }
         :nEditType           := 5
         :nWidth              := 20
         :nHeadBmpNo          := 1
         :nBtnBmp             := 1
         :nHeadBmpAlign       := 1
         :AddResource( "gc_navigate_plus_16" )
         :lHide               := .T.
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Restar unidades"
         :bStrData            := {|| "" }
         :bOnPostEdit         := {|| .T. }
         :bEditBlock          := {|| ::oDetFacAutomatica:oDbfVir:FieldPutByName( "nUnidades", ::oDetFacAutomatica:oDbfVir:FieldGetByName( "nUnidades" ) - 1 ), ::nCalculoTotal() }
         :nEditType           := 5
         :nWidth              := 20
         :nHeadBmpNo          := 1
         :nBtnBmp             := 1
         :nHeadBmpAlign       := 1
         :AddResource( "gc_navigate_minus_16" )
         :lHide               := .T.
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Total unidades"
         :bEditValue          := {|| ::oDetFacAutomatica:nTotNFacAut( ::oDetFacAutomatica:oDbfVir ) }
         :cEditPicture        := MasUnd()
         :nWidth              := 85
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| ::oDetFacAutomatica:oDbfVir:FieldGetByName( "nPreUnit" ) }
         :cEditPicture        := ::cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| ::oDetFacAutomatica:nTotLFacAut( ::oDetFacAutomatica:oDbfVir ) }
         :cEditPicture        := ::cPorDiv
         :nWidth              := 90
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( ::oBrwLineas:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ::oDetFacAutomatica:oDbfVir:FieldGetByName( "nIva" ) }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      if nMode <> 3
         ::oBrwLineas:bLDblClick   := {|| ::oDetFacAutomatica:Edit( ::oBrwLineas ), ::nCalculoTotal() }
      end









      ::aGet[ 9 ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::oDbf:cDtoEsp, ::oDbf:cDtoEsp:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      ::aGet[ 10 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::oDbf:nDtoEsp, ::oDbf:nDtoEsp:= u ) }, oFld:aDialogs[1],, "@ER 999.99%",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

         ::aGet[ 10 ]:bChange   := {|| ::nCalculoTotal() }




      ::aGet[ 11 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, ::oDbf:cDpp, ::oDbf:cDpp:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      ::aGet[ 12 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, ::oDbf:nDpp, ::oDbf:nDpp:= u ) }, oFld:aDialogs[1],, "@ER 999.99%",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

         ::aGet[ 12 ]:bChange   := {|| ::nCalculoTotal() }




      ::aGet[ 13 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, ::oDbf:cDtoUno, ::oDbf:cDtoUno:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      ::aGet[ 14 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, ::oDbf:nDtoUno, ::oDbf:nDtoUno:= u ) }, oFld:aDialogs[1],, "@ER 999.99%",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

         ::aGet[ 14 ]:bChange   := {|| ::nCalculoTotal() }




      ::aGet[ 15 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, ::oDbf:cDtoDos, ::oDbf:cDtoDos:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      ::aGet[ 16 ] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, ::oDbf:nDtoDos, ::oDbf:nDtoDos:= u ) }, oFld:aDialogs[1],, "@ER 999.99%",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

         ::aGet[ 16 ]:bChange   := {|| ::nCalculoTotal() }






      ::oBrwIva                        := IXBrowse():New( oFld:aDialogs[1] )

      ::oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oBrwIva:SetArray( ::aTotIva, , , .F. )

      ::oBrwIva:nMarqueeStyle          := 6
      ::oBrwIva:lRecordSelector        := .F.
      ::oBrwIva:lHScroll               := .F.

      ::oBrwIva:CreateFromResource( 290 )

      with object ( ::oBrwIva:AddCol() )
         :cHeader          := "Base"
         :bStrData         := {|| if( ::aTotIva[ ::oBrwIva:nArrayAt, 3 ] <> nil, Trans( ::aTotIva[ ::oBrwIva:nArrayAt, 2 ], ::cPorDiv ), "" ) }
         :nWidth           := 200
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwIva:AddCol() )
         :cHeader          := "%" + cImp()
         :bStrData         := {|| if( !IsNil( ::aTotIva[ ::oBrwIva:nArrayAt, 3 ] ), ::aTotIva[ ::oBrwIva:nArrayAt, 3 ], "" ) }
         :bEditValue       := {|| ::aTotIva[ ::oBrwIva:nArrayAt, 3 ] }
         :nWidth           := 85
         :cEditPicture     := "@E 99.99"
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFootStrAlign    := 1
         :nEditType        := 1
         :bEditWhen        := {|| !IsNil( ::aTotIva[ ::oBrwIva:nArrayAt, 3 ] ) }
         :bOnPostEdit      := {|o,x| EdtIva( o, x, ::aTotIva[ ::oBrwIva:nArrayAt, 3 ], ::oDetFacAutomatica:oDbfVir:cAlias, ::oDetFacAutomatica:oDbfIva:cAlias, ::oBrwLineas ), ::nCalculoTotal() }
      end

      with object ( ::oBrwIva:AddCol() )
         :cHeader          := cImp()
         :bStrData         := {|| if( ::aTotIva[ ::oBrwIva:nArrayAt, 3 ] <> nil, Trans( ::aTotIva[ ::oBrwIva:nArrayAt, 4 ], ::cPorDiv ), "" ) }
         :nWidth           := 85
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end









      ::aGet[ 19 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, ::oDbf:cManObr, ::oDbf:cManObr:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      ::aGet[ 17 ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, ::oDbf:nIvaMan, ::oDbf:nIvaMan:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         ::aGet[ 17 ]:bValid    := {|| lTiva( ::oDbfIva:cAlias, ::oDbf:nIvaMan ), ::nCalculoTotal(), .T. }
         ::aGet[ 17 ]:bHelp     := {|| BrwIva( ::aGet[ 17 ], ::oDbfIva:cAlias, , .T. ) }
         ::aGet[ 17 ]:bChange   := {|| ::nCalculoTotal() }





      ::aGet[ 18 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, ::oDbf:nManObr, ::oDbf:nManObr:= u ) }, oFld:aDialogs[1],, ::cPorDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

         ::aGet[ 18 ]:bChange  := {|| ::nCalculoTotal() }









      ::oGetBrt := TSay():ReDefine( 330, {|| ::nTotBrt}, oFld:aDialogs[1], ::cPorDiv,,, .F.,, .F., .F., )




      ::oGetNet := TSay():ReDefine( 340, {|| ::nTotNet}, oFld:aDialogs[1], ::cPorDiv,,, .F.,, .F., .F., )




      ::oGetIva := TSay():ReDefine( 350, {|| ::nTotIva}, oFld:aDialogs[1], ::cPorDiv,,, .F.,, .F., .F., )




      oSayTot := TSay():ReDefine( 380, {|| "Total"}, oFld:aDialogs[1],,,, .F., ::oFont, .F., .F., )





      ::oGetTotal := TSay():ReDefine( 390, {|| ::nTotFac}, oFld:aDialogs[1], ::cPorDiv,,, .F., ::oFont, .F., .F., )









      oBmpFolder := TBitmap():ReDefine( 990, "gc_folders2_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )

      ::oBrwHistorial                  := IXBrowse():New( oFld:aDialogs[ 2 ] )

      ::oBrwHistorial:bClrSel          := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwHistorial:bClrSelFocus     := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      ::oBrwHistorial:nMarqueeStyle    := 5
      ::oBrwHistorial:cName            := "Historico de plantilla venta automáticas"
      ::oBrwHistorial:lHScroll         := .F.

      ::oHisFacAutomatica:oDbfVir:SetBrowse( ::oBrwHistorial )

      ::oBrwHistorial:CreateFromResource( 200 )



      ::oBrwHistorial:bLDblClick       := {|| if ( File( AllTrim( ::oHisFacAutomatica:oDbfVir:FieldGetByName( "cFichero" ) ) ), WinExec( "notepad.exe " + AllTrim( ::oHisFacAutomatica:oDbfVir:FieldGetByName( "cFichero" ) ) ), msgStop( "El fichero " + AllTrim( ::oHisFacAutomatica:oDbfVir:FieldGetByName( "cFichero" ) ) + " no existe" ) ) }

      with object ( ::oBrwHistorial:AddCol() )
         :cHeader             := "Fecha"
         :bEditValue          := {|| dToc( ::oHisFacAutomatica:oDbfVir:FieldGetByName( "dFecha" ) ) }
         :nWidth              := 115
      end

      with object ( ::oBrwHistorial:AddCol() )
         :cHeader             := "Hora"
         :bEditValue          := {|| ::oHisFacAutomatica:oDbfVir:FieldGetByName( "cHora" ) }
         :nWidth              := 55
      end

      with object ( ::oBrwHistorial:AddCol() )
         :cHeader             := "Resultado"
         :bEditValue          := {|| ::oHisFacAutomatica:oDbfVir:FieldGetByName( "cFichero" ) }
         :nWidth              := 710
      end










      TButton():ReDefine( 900, {||( ::PriorResource( nMode ) )}, ::oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 901, {||( ::NextResource( nMode ) )}, ::oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 1, {||( if( ::SaveResource( nMode, ::aGet ), ::oDlg:End( 1 ), ) )}, ::oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 2, {||( ::oDlg:End() )}, ::oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         ::oDlg:AddFastKey( 113,       {|| ::oDetFacAutomatica:AppendDet( ::oBrwLineas ), ::nCalculoTotal() } )
         ::oDlg:AddFastKey( 114,       {|| ::oDetFacAutomatica:Edit( ::oBrwLineas ), ::nCalculoTotal() } )
         ::oDlg:AddFastKey( 115,       {|| ::oDetFacAutomatica:Del( ::oBrwLineas ), ::nCalculoTotal() } )
         ::oDlg:AddFastKey( 116,       {|| if( ::SaveResource( nMode, ::aGet ), ::oDlg:End( 1 ), ) } )
         ::oDlg:AddFastKey( 46,   {|| ::oHisFacAutomatica:oDbfVir:Delete(), ::oBrwHistorial:Refresh() } )
      end

   ::oDlg:bStart    := {|| ::StartResource( nMode, ::oBrwIva ) }

   ::oDlg:Activate( , , , .T., , , {|| ::oBrwLineas:Load(), ::oBrwHistorial:Load() } )

   oBmpGeneral:End()
   oBmpFolder:End()

   if !Empty( ::oBrwLineas )
      ::oBrwLineas:CloseData()
      ::oBrwLineas:end()
   end

   if !Empty( ::oBrwHistorial )
      ::oBrwHistorial:CloseData()
      ::oBrwHistorial:end()
   end

RETURN ( ::oDlg:nResult == 1 )



static FUNCTION TFacAutomatica_NextResource( nMode ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   if !::SaveResource( nMode )
      Return ( .F. )
   end

   CursorWait()

   if ::Next()

      aEval( ::aGet, {|o| if( IsObject( o ), o:Refresh(), ) } )

      ::oBrwLineas:Refresh( .T. )
      ::oBrwLineas:GoTop()

      ::oBrwHistorial:Refresh( .T. )
      ::oBrwHistorial:GoTop()

   else

      ::oDlg:End( 1 )

   end

   CursorWE()

RETURN ( .T. )



static FUNCTION TFacAutomatica_PriorResource( nMode ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   if !::SaveResource( nMode )
      Return ( .F. )
   end

   CursorWait()

   if ::Prior()

      aEval( ::aGet, {|o| if( IsObject( o ), o:Refresh(), ) } )

      ::oBrwLineas:Refresh( .T. )
      ::oBrwLineas:GoTop()

      ::oBrwHistorial:Refresh( .T. )
      ::oBrwHistorial:GoTop()

   else

      ::oDlg:End( 1 )

   end

   CursorWE()

RETURN ( .T. )



static FUNCTION TFacAutomatica_StartResource( nMode ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   ::oGrpFacturasAutomaticas:LoadBrowse( ::oDbf:mGrpSel )

   ::nCalculoTotal()

   ::ShowKit( .F. )

   ::aGet[ ::oDbf:FieldPos( "cCodPago" ) ]:lValid()

RETURN ( Self )



static FUNCTION TFacAutomatica_SaveResource( nMode ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   local oItem
   local lSemana  := .F.
   local cSemana  := ""
   local cMes     := ""

   if ( nMode == 1 .OR. nMode == 4 )
      if !::aGet[ 1 ]:lValid()
         return .F.
      end
   end

   if Empty( ::oDbf:cNomFac )
      msgStop( "El campo nombre no puede estar vacío." )
      ::aGet[ 2 ]:SetFocus()
      return .F.
   end

   if !Empty( ::oDbf:dFecFin ) .AND. ( ::oDbf:dFecFin < ::oDbf:dFecIni )
      msgStop( "La fecha de fin no puede ser menor que la fecha de inicio." )
      ::aGet[ 3 ]:SetFocus()
      return .F.
   end

   if ::oDetFacAutomatica:oDbfVir:LastRec() == 0
      msgStop( "No puede almacenar un documento sin líneas." )
      return .F.
   end

   ::oDbf:cDiaSel := cSemana
   ::oDbf:lDiaSel := lSemana

   ::oDbf:mGrpSel := ::oGrpFacturasAutomaticas:BrowseToChar()

   ::oDetFacAutomatica:oDbfVir:KillFilter()

RETURN ( .T. )



static FUNCTION TFacAutomatica_nCalculoTotal( lExt ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   local nRec
   local oDbfDet
   local bCondicion
   local lSeek

   If( lExt == nil, lExt := .F., ) ;

   oDbfDet           := if( lExt, ::oDetFacAutomatica:oDbf, ::oDetFacAutomatica:oDbfVir )

   nRec              := oDbfDet:Recno()

   if lExt
      bCondicion     := {|| ::oDbf:cCodFac == oDbfDet:cCodFac .AND. !oDbfDet:Eof() }
      lSeek          := oDbfDet:Seek( ::oDbf:cCodFac )
   else
      bCondicion     := {|| !oDbfDet:Eof() }
      lSeek          := oDbfDet:GoTop()
   end

   ::aTotIva         := { { 0,0,nil,0 }, { 0,0,nil,0 }, { 0,0,nil,0 } }

   while Eval( bCondicion )



      if ( !oDbfDet:lKitArt .AND. !oDbfDet:lKitChl )  .OR.  ( oDbfDet:lKitArt .AND. oDbfDet:lKitPrc )    .OR.  ( oDbfDet:lKitChl .AND. oDbfDet:lKitPrc )

         do case
            case ::aTotIva[ 1, 3 ] == nil .OR. ::aTotIva[ 1, 3 ] == oDbfDet:nIva

               ::aTotIva[ 1, 3 ]   := oDbfDet:nIva
               ::aTotIva[ 1, 1 ]   += ::oDetFacAutomatica:nTotLFacAut( oDbfDet )

            case ::aTotIva[ 2, 3 ] == nil .OR. ::aTotIva[ 2, 3 ] == oDbfDet:nIva

               ::aTotIva[ 2, 3 ]   := oDbfDet:nIva
               ::aTotIva[ 2, 1 ]   += ::oDetFacAutomatica:nTotLFacAut( oDbfDet )

            case ::aTotIva[ 3, 3 ] == nil .OR. ::aTotIva[ 3, 3 ] == oDbfDet:nIva

               ::aTotIva[ 3, 3 ]   := oDbfDet:nIva
               ::aTotIva[ 3, 1 ]   += ::oDetFacAutomatica:nTotLFacAut( oDbfDet )

         end

      end

      oDbfDet:Skip()

   end

   oDbfDet:GoTo( nRec )





   ::aTotIva         := aSort( ::aTotIva,,, {|x,y| if( x[3] <> nil, x[3], -1 ) > if( y[3] <> nil, y[3], -1 )  } )

   ::aTotIva[ 1, 2 ]         := Round( ::aTotIva[ 1, 1 ], ::nRouDiv )
   ::aTotIva[ 2, 2 ]         := Round( ::aTotIva[ 2, 1 ], ::nRouDiv )
   ::aTotIva[ 3, 2 ]         := Round( ::aTotIva[ 3, 1 ], ::nRouDiv )





   if ::oDbf:nDtoEsp  <> 0

      ::aTotIva[ 1, 2 ]      -= Round( ::aTotIva[ 1, 2 ] * ::oDbf:nDtoEsp / 100, ::nRouDiv )
      ::aTotIva[ 2, 2 ]      -= Round( ::aTotIva[ 2, 2 ] * ::oDbf:nDtoEsp / 100, ::nRouDiv )
      ::aTotIva[ 3, 2 ]      -= Round( ::aTotIva[ 3, 2 ] * ::oDbf:nDtoEsp / 100, ::nRouDiv )

   end





   if ::oDbf:nDpp  <> 0

      ::aTotIva[ 1, 2 ]      -= Round( ::aTotIva[ 1, 2 ] * ::oDbf:nDpp / 100, ::nRouDiv )
      ::aTotIva[ 2, 2 ]      -= Round( ::aTotIva[ 2, 2 ] * ::oDbf:nDpp / 100, ::nRouDiv )
      ::aTotIva[ 3, 2 ]      -= Round( ::aTotIva[ 3, 2 ] * ::oDbf:nDpp / 100, ::nRouDiv )

   end





   if ::oDbf:nDtoUno  <> 0

      ::aTotIva[ 1, 2 ]      -= Round( ::aTotIva[ 1, 2 ] * ::oDbf:nDtoUno / 100, ::nRouDiv )
      ::aTotIva[ 2, 2 ]      -= Round( ::aTotIva[ 2, 2 ] * ::oDbf:nDtoUno / 100, ::nRouDiv )
      ::aTotIva[ 3, 2 ]      -= Round( ::aTotIva[ 3, 2 ] * ::oDbf:nDtoUno / 100, ::nRouDiv )

   end





   if ::oDbf:nDtoDos  <> 0

      ::aTotIva[ 1, 2 ]      -= Round( ::aTotIva[ 1, 2 ] * ::oDbf:nDtoDos / 100, ::nRouDiv )
      ::aTotIva[ 2, 2 ]      -= Round( ::aTotIva[ 2, 2 ] * ::oDbf:nDtoDos / 100, ::nRouDiv )
      ::aTotIva[ 3, 2 ]      -= Round( ::aTotIva[ 3, 2 ] * ::oDbf:nDtoDos / 100, ::nRouDiv )

   end





   if ::oDbf:nManObr <> 0

      do case
         case ::aTotIva[ 1, 3 ] == nil .OR. ::aTotIva[ 1, 3 ] == ::oDbf:nIvaMan

         ::aTotIva[ 1, 3 ]   := ::oDbf:nIvaMan
         ::aTotIva[ 1, 2 ]   += ::oDbf:nManObr

      case ::aTotIva[ 2, 3 ] == nil .OR. ::aTotIva[ 2, 3 ] == ::oDbf:nIvaMan

         ::aTotIva[ 2, 3 ]   := ::oDbf:nIvaMan
         ::aTotIva[ 2, 2 ]   += ::oDbf:nManObr

      case ::aTotIva[ 3, 3 ] == nil .OR. ::aTotIva[ 3, 3 ] == ::oDbf:nIvaMan

         ::aTotIva[ 3, 3 ]   := ::oDbf:nIvaMan
         ::aTotIva[ 3, 2 ]   += ::oDbf:nManObr

      end

   end





   ::aTotIva[ 1, 4 ]      := if( ::aTotIva[ 1, 3 ] <> NIL, Round( ::aTotIva[ 1, 2 ] * ::aTotIva[ 1, 3 ] / 100, ::nRouDiv ), 0 )
   ::aTotIva[ 2, 4 ]      := if( ::aTotIva[ 2, 3 ] <> NIL, Round( ::aTotIva[ 2, 2 ] * ::aTotIva[ 2, 3 ] / 100, ::nRouDiv ), 0 )
   ::aTotIva[ 3, 4 ]      := if( ::aTotIva[ 3, 3 ] <> NIL, Round( ::aTotIva[ 3, 2 ] * ::aTotIva[ 3, 3 ] / 100, ::nRouDiv ), 0 )





   ::nTotBrt      := ::aTotIva[ 1, 1 ] + ::aTotIva[ 2, 1 ] + ::aTotIva[ 3, 1 ]

   if !Empty( ::oGetBrt )
      ::oGetBrt:SetText( ::nTotBrt )
   end





   ::nTotNet      := Round( ::aTotIva[ 1, 2 ] + ::aTotIva[ 2, 2 ] + ::aTotIva[ 3, 2 ], ::nRouDiv )

   if !Empty( ::oGetNet )
      ::oGetNet:SetText( ::nTotNet )
   end





   ::nTotIva      := Round( ::aTotIva[ 1, 4 ] + ::aTotIva[ 2, 4 ] + ::aTotIva[ 3, 4 ], ::nRouDiv )

   if !Empty( ::oGetIva )
      ::oGetIva:SetText( ::nTotIva )
   end





   ::nTotFac      := Round( ::nTotNet + ::nTotIva, ::nRouDiv )

   if !Empty( ::oGetTotal )
      ::oGetTotal:SetText( ::nTotFac )
   end





   if !Empty( ::oBrwIva )
      ::oBrwIva:Refresh()
   end

RETURN ( ::nTotFac )



static FUNCTION TFacAutomatica_ShowKit( lSet ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   local lShwKit     := lShwKit()

   if lSet
      lShwKit        := !lShwKit
   end

   if lShwKit
      SetWindowText( ::oBtnKit:hWnd, "Mostrar Esc&ll." )
      ::oDetFacAutomatica:oDbfVir:SetFilter( "!lKitChl" )
   else
      SetWindowText( ::oBtnKit:hWnd, "Ocultar Esc&ll." )
      ::oDetFacAutomatica:oDbfVir:KillFilter()
   end

   if lSet
      lShwKit( lShwKit )
   end

   ::oBrwLineas:Refresh()

RETURN ( Self )



static FUNCTION TFacAutomatica_ExternalEdit( cCodFac ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   if ::oDbf:Seek( cCodFac )
      ::Edit()
   else
      MsgStop( "Código " + cCodFac + " de factura automática no encontrado" )
   end

RETURN ( Self )



static FUNCTION TFacAutomatica_RunPlantillaAutomatica( cCodigoPlantilla ) ; local Self AS CLASS TFacAutomatica := QSelf() AS CLASS TFacAutomatica

   with object ( TCreaFacAutomaticas():New() )

      :cCodigoPlantilla    := cCodigoPlantilla

      if :OpenFiles()

         if :lSelectCodigoPlantilla()
            :Run()
         end

         :CloseFiles()

      end

   end

Return ( Self )



Function lFacturasAutomaticas()

   if !( oUser():lDocAuto() )
      Return .F.
   end

   with object ( TCreaFacAutomaticas():New() )
      if :OpenFiles()
         if :lLanzaAsistente()
            :Run()
         end
         :CloseFiles()
      end
   end

RETURN ( nil )



_HB_CLASS TCreaFacAutomaticas ; function TCreaFacAutomaticas ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TCreaFacAutomaticas", iif( .F., { }, { @HBObject() } ), @TCreaFacAutomaticas() ) ) ;

   _HB_MEMBER { nView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nView"}, .F. )

   _HB_MEMBER { oDbfArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfArt"}, .F. )
   _HB_MEMBER { oDbfCli } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfCli"}, .F. )
   _HB_MEMBER { oDbfDiv } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfDiv"}, .F. )
   _HB_MEMBER { oDbfCount } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfCount"}, .F. )
   _HB_MEMBER { oDbfFam } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfFam"}, .F. )
   _HB_MEMBER { oDbfKit } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfKit"}, .F. )
   _HB_MEMBER { oDbfIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfIva"}, .F. )
   _HB_MEMBER { oDbfFPago } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfFPago"}, .F. )
   _HB_MEMBER { oDbfAge } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfAge"}, .F. )

   _HB_MEMBER { oAlbCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliT"}, .F. )
   _HB_MEMBER { oAlbCliL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliL"}, .F. )

   _HB_MEMBER { oFacCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliT"}, .F. )
   _HB_MEMBER { oFacCliL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliL"}, .F. )
   _HB_MEMBER { oFacCliP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliP"}, .F. )
   _HB_MEMBER { oAntCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAntCliT"}, .F. )

   _HB_MEMBER { oFacAutT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacAutT"}, .F. )
   _HB_MEMBER { oFacAutL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacAutL"}, .F. )
   _HB_MEMBER { oFacAutI } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacAutI"}, .F. )

   _HB_MEMBER { oGrpFacturasAutomaticas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGrpFacturasAutomaticas"}, .F. )

   _HB_MEMBER { oTree } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTree"}, .F. )
   _HB_MEMBER { oBrwPlantilla } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwPlantilla"}, .F. )
   _HB_MEMBER { oMetMsg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMetMsg"}, .F. )
   _HB_MEMBER { oBtnInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnInicio"}, .F. )
   _HB_MEMBER { oBtnInforme } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnInforme"}, .F. )

   _HB_MEMBER { oChkIgnoraProcesado } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oChkIgnoraProcesado"}, .F. )
   _HB_MEMBER { lChkIgnoraProcesado } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lChkIgnoraProcesado"}, .F. )

   _HB_MEMBER { cPorDiv } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPorDiv"}, .F. )

   _HB_MEMBER { cFilTxt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFilTxt"}, .F. )
   _HB_MEMBER { hFilTxt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"hFilTxt"}, .F. )

   _HB_MEMBER { oFecDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFecDocumento"}, .F. )
   _HB_MEMBER { dFecDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFecDocumento"}, .F. )

   _HB_MEMBER { aPlantilla } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aPlantilla"}, .F. )

   _HB_MEMBER { cErrorMessage } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cErrorMessage"}, .F. )

   _HB_MEMBER { lAsistente } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lAsistente"}, .F. )
   _HB_MEMBER { lMensaje } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lMensaje"}, .F. )

   _HB_MEMBER { oTreeSelector } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTreeSelector"}, .F. )

   _HB_MEMBER { oCodigoGrupo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodigoGrupo"}, .F. )
   _HB_MEMBER { cCodigoGrupo } ; oClass:AddMultiData(, Space( 4 ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodigoGrupo"}, .F. )
   _HB_MEMBER { aCodigoGrupo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aCodigoGrupo"}, .F. )

   _HB_MEMBER { oCodigoPlantilla } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodigoPlantilla"}, .F. )
   _HB_MEMBER { cCodigoPlantilla } ; oClass:AddMultiData(, Space( 3 ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodigoPlantilla"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @TCreaFacAutomaticas_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER Run(); oClass:AddMethod( "Run", @TCreaFacAutomaticas_Run(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TCreaFacAutomaticas_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TCreaFacAutomaticas_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lLanzaAsistente(); oClass:AddMethod( "lLanzaAsistente", @TCreaFacAutomaticas_lLanzaAsistente(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER IniciarAsistente(); oClass:AddMethod( "IniciarAsistente", @TCreaFacAutomaticas_IniciarAsistente(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER StartAsistente(); oClass:AddMethod( "StartAsistente", @TCreaFacAutomaticas_StartAsistente(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CreaAlbaran(); oClass:AddMethod( "CreaAlbaran", @TCreaFacAutomaticas_CreaAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CreaFactura(); oClass:AddMethod( "CreaFactura", @TCreaFacAutomaticas_CreaFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lCompruebaFecha(); oClass:AddMethod( "lCompruebaFecha", @TCreaFacAutomaticas_lCompruebaFecha(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ActionTree(); oClass:AddMethod( "ActionTree", @TCreaFacAutomaticas_ActionTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lSeekClient( cCodFac); oClass:AddMethod( "lSeekClient", @TCreaFacAutomaticas_lSeekClient(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OnClickRefreshAsistente(); oClass:AddInline( "OnClickRefreshAsistente", {|Self | ( ( Self ) ), ( ::lLanzaAsistente() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER OnClickIgnoraProcesado(); oClass:AddInline( "OnClickIgnoraProcesado", {|Self | ( ( Self ) ), ( ::oBtnIgnoraProcesado:Toggle() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SetNextFechaFactura(); oClass:AddMethod( "SetNextFechaFactura", @TCreaFacAutomaticas_SetNextFechaFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lSelectCodigoPlantilla( cCodigoPlantilla); oClass:AddMethod( "lSelectCodigoPlantilla", @TCreaFacAutomaticas_lSelectCodigoPlantilla(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TCreaFacAutomaticas ;



static FUNCTION TCreaFacAutomaticas_New( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   ::lMensaje           := .F.
   ::lAsistente         := .T.
   ::dFecDocumento      := GetSysDate()
   ::cCodigoPlantilla   := Space( 3 )
   ::cCodigoGrupo       := Space( 4 )

RETURN ( Self )



static FUNCTION TCreaFacAutomaticas_Run( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local oDlg
   local oFld
   local oBmp
   local nMetMsg
   local cCodigoGrupo
   local cCodigoPlantilla

   cCodigoGrupo      := ::cCodigoGrupo
   cCodigoPlantilla  := ::cCodigoPlantilla












      oDlg = TDialog():New(,,,,, "AssDocAuto",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmp := TBitmap():ReDefine( 900, "gc_document_text_gear_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )







      oFld := TFolder():ReDefine( 400, {"Plantillas", "Proceso"}, { "AssDocAuto_2","AssDocAuto_1" }, oDlg,,,,, .F., )




      ::oFecDocumento := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::dFecDocumento, ::dFecDocumento:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





      ::oCodigoGrupo := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::cCodigoGrupo, ::cCodigoGrupo:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 121 )

         ::oCodigoGrupo:bValid      := {|| if( ::oGrpFacturasAutomaticas:Existe( ::oCodigoGrupo, ::oCodigoGrupo:oHelpText, "cNomGrp", .T., .T., "0" ), ( if( cCodigoGrupo <> ::cCodigoGrupo, ::lSelectCodigoPlantilla(), ), cCodigoGrupo := ::cCodigoGrupo, .T. ), .F. ) }
         ::oCodigoGrupo:bHelp       := {|| ::oGrpFacturasAutomaticas:Buscar( ::oCodigoGrupo ) }





      ::oCodigoPlantilla := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cCodigoPlantilla, ::cCodigoPlantilla:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 131 )

         ::oCodigoPlantilla:bValid  := {|| if( ::oFacAutT:Existe( ::oCodigoPlantilla, ::oCodigoPlantilla:oHelpText, "cNomFac", .T., .T., "0" ), ( if( cCodigoPlantilla <> ::cCodigoPlantilla, ::lSelectCodigoPlantilla(), ), cCodigoPlantilla := ::cCodigoPlantilla, .T. ), .F. ) }
         ::oCodigoPlantilla:bHelp   := {|| ::oFacAutT:Buscar( ::oCodigoPlantilla ) }














      ::oBrwPlantilla                  := IXBrowse():New( oFld:aDialogs[ 1 ] )

      ::oBrwPlantilla:bClrSel          := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwPlantilla:bClrSelFocus     := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oBrwPlantilla:SetArray( ::aPlantilla, , , .F. )

      ::oBrwPlantilla:nMarqueeStyle    := 6
      ::oBrwPlantilla:lRecordSelector  := .F.
      ::oBrwPlantilla:lHScroll         := .F.

      ::oBrwPlantilla:bLDblClick       := {|| ::aPlantilla[ ::oBrwPlantilla:nArrayAt, 1 ] := !::aPlantilla[ ::oBrwPlantilla:nArrayAt, 1 ], ::oBrwPlantilla:Refresh() }

      with object ( ::oBrwPlantilla:AddCol() )
         :cHeader          := "Seleccionada"
         :nHeadBmpNo       := 1
         :bStrData         := {|| "" }
         :bEditValue       := {|| ::aPlantilla[ ::oBrwPlantilla:nArrayAt, 1 ] }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( ::oBrwPlantilla:AddCol() )
         :cHeader          := "Código"
         :bEditValue       := {|| ::aPlantilla[ ::oBrwPlantilla:nArrayAt, 2 ] }
         :nWidth           := 60
      end

      with object ( ::oBrwPlantilla:AddCol() )
         :cHeader          := "Nombre plantilla"
         :bEditValue       := {|| ::aPlantilla[ ::oBrwPlantilla:nArrayAt, 3 ] }
         :nWidth           := 200
      end

      with object ( ::oBrwPlantilla:AddCol() )
         :cHeader          := "Comentario"
         :bEditValue       := {|| ::aPlantilla[ ::oBrwPlantilla:nArrayAt, 4 ] }
         :nWidth           := 400
      end

      ::oBrwPlantilla:CreateFromResource( 100 )









      ::oTree              := TTreeView():Redefine( 100, oFld:aDialogs[ 2 ] )
      ::oTree:bLDblClick   := {|| ::ActionTree() }







      ::oMetMsg := TApoloMeter():ReDefine( 120, { | u | If( PCount()==0, nMetMsg, nMetMsg:= u ) },, oDlg, .F.,,, .F.,,,, )




      ::oBtnInicio := TButton():ReDefine( 500, {||( ::IniciarAsistente( oFld, oDlg ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 550, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F. )




      ::oBtnInforme := TButton():ReDefine( 600, {||( if( File( AllTrim( ::cFilTxt ) ), WinExec( "notepad.exe " + AllTrim( ::cFilTxt ) ), ) )}, oDlg,,, .F.,,,, .F. )

      oDlg:bStart := {|| ::StartAsistente() }

      oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )













   if !Empty( oBmp )
      oBmp:End()
   end

RETURN ( .T. )



static FUNCTION TCreaFacAutomaticas_StartAsistente( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   ::oBtnInforme:Disable()

   ::oCodigoGrupo:lValid()
   ::oCodigoPlantilla:lValid()

RETURN ( Self )



static FUNCTION TCreaFacAutomaticas_OpenFiles( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local oBlock
   local oError
   local lOpen          := .T.

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   ::nView              := D():CreateView()

   ::oDbfArt := DbfServer( "ARTICULO.DBF", ):NewOpen( "ARTICULO.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfArt:AddBag( "ARTICULO.CDX" ) ; ::oDbfArt:AddBag( ) ; ::oDbfArt:AutoIndex()

   ::oDbfCli := DbfServer( "CLIENT.DBF", ):NewOpen( "CLIENT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfCli:AddBag( "CLIENT.CDX" ) ; ::oDbfCli:AddBag( ) ; ::oDbfCli:AutoIndex()

   ::oAlbCliT := TDataCenter():oAlbCliT()

   ::oAlbCliL := DbfServer( "ALBCLIL.DBF", ):NewOpen( "ALBCLIL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbCliL:AddBag( "ALBCLIL.CDX" ) ; ::oAlbCliL:AddBag( ) ; ::oAlbCliL:AutoIndex()

   ::oFacCliT := TDataCenter():oFacCliT()

   ::oFacCliL := DbfServer( "FACCLIL.DBF", ):NewOpen( "FACCLIL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFacCliL:AddBag( "FACCLIL.CDX" ) ; ::oFacCliL:AddBag( ) ; ::oFacCliL:AutoIndex()

   ::oFacCliP := TDataCenter():oFacCliP()

   ::oAntCliT := DbfServer( "ANTCLIT.DBF", ):NewOpen( "ANTCLIT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAntCliT:AddBag( "ANTCLIT.CDX" ) ; ::oAntCliT:AddBag( ) ; ::oAntCliT:AutoIndex()

   ::oDbfDiv := DbfServer( "DIVISAS.DBF", ):NewOpen( "DIVISAS.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfDiv:AddBag( "DIVISAS.CDX" ) ; ::oDbfDiv:AddBag( ) ; ::oDbfDiv:AutoIndex()

   ::oDbfCount := DbfServer( "NCOUNT.DBF", ):NewOpen( "NCOUNT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfCount:AddBag( "NCOUNT.CDX" ) ; ::oDbfCount:AddBag( ) ; ::oDbfCount:AutoIndex()

   ::oDbfFam := DbfServer( "FAMILIAS.DBF", ):NewOpen( "FAMILIAS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfFam:AddBag( "FAMILIAS.CDX" ) ; ::oDbfFam:AddBag( ) ; ::oDbfFam:AutoIndex()

   ::oDbfKit := DbfServer( "ARTKIT.DBF", ):NewOpen( "ARTKIT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfKit:AddBag( "ARTKIT.CDX" ) ; ::oDbfKit:AddBag( ) ; ::oDbfKit:AutoIndex()

   ::oDbfIva := DbfServer( "TIVA.DBF", ):NewOpen( "TIVA.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfIva:AddBag( "TIVA.CDX" ) ; ::oDbfIva:AddBag( ) ; ::oDbfIva:AutoIndex()

   ::oDbfFPago := DbfServer( "FPAGO.DBF", ):NewOpen( "FPAGO.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfFPago:AddBag( "FPAGO.CDX" ) ; ::oDbfFPago:AddBag( ) ; ::oDbfFPago:AutoIndex()

   ::oDbfAge := DbfServer( "AGENTES.DBF", ):NewOpen( "AGENTES.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfAge:AddBag( "AGENTES.CDX" ) ; ::oDbfAge:AddBag( ) ; ::oDbfAge:AutoIndex()

   D():Atipicas( ::nView )

   ::oGrpFacturasAutomaticas  := TGrpFacturasAutomaticas():Create( cPatEmp() )
   ::oGrpFacturasAutomaticas:OpenService( .F. )

   ::oFacAutT           := TFacAutomatica():Create( cPatEmp() )
   ::oFacAutT:Openfiles( .F. )

   ::oFacAutL           := TDetFacAutomatica():Create( cPatEmp(), cDriver(), Self )
   ::oFacAutL:Openfiles( .F. )

   ::oFacAutI           := THisFacAutomatica():Create( cPatEmp(), cDriver(), Self )
   ::oFacAutI:Openfiles( .F. )

   if ::oDbfDiv:Seek( cDivEmp() )
      ::cPorDiv         := RetPic( ::oDbfDiv:nNouDiv, ::oDbfDiv:nRouDiv )
   end

   RECOVER USING oError

      msgStop( "Imposible abrir bases de datos de facturas automáticas." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      ::CloseFiles()

      lOpen             := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TCreaFacAutomaticas_CloseFiles( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   D():DeleteView( ::nView )

   if ::oDbfCli <> nil .AND. ::oDbfCli:Used()
      ::oDbfCli:End()
   end

   if ::oDbfArt <> nil .AND. ::oDbfArt:Used()
      ::oDbfArt:End()
   end

   if ::oAlbCliT <> nil .AND. ::oAlbCliT:Used()
      ::oAlbCliT:End()
   end

   if ::oAlbCliL <> nil .AND. ::oAlbCliL:Used()
      ::oAlbCliL:End()
   end

   if ::oFacCliT <> nil .AND. ::oFacCliT:Used()
      ::oFacCliT:End()
   end

   if ::oFacCliL <> nil .AND. ::oFacCliL:Used()
      ::oFacCliL:End()
   end

   if ::oDbfDiv <> nil .AND. ::oDbfDiv:Used()
      ::oDbfDiv:End()
   end

   if ::oDbfCount <> nil .AND. ::oDbfCount:Used()
      ::oDbfCount:End()
   end

   if ::oDbfKit <> nil .AND. ::oDbfKit:Used()
      ::oDbfKit:End()
   end

   if ::oDbfFam <> nil .AND. ::oDbfFam:Used()
      ::oDbfFam:End()
   end

   if ::oDbfIva <> nil .AND. ::oDbfIva:Used()
      ::oDbfIva:End()
   end

   if ::oFacCliP <> nil .AND. ::oFacCliP:Used()
      ::oFacCliP:End()
   end

   if ::oAntCliT <> nil .AND. ::oAntCliT:Used()
      ::oAntCliT:End()
   end

   if ::oDbfFPago <> nil .AND. ::oDbfFPago:Used()
      ::oDbfFPago:End()
   end

   if ::oDbfAge <> nil .AND. ::oDbfAge:Used()
      ::oDbfAge:End()
   end

   if ::oGrpFacturasAutomaticas <> nil
      ::oGrpFacturasAutomaticas:End()
   end

   if ::oFacAutT <> nil
      ::oFacAutT:End()
   end

   if ::oFacAutL <> nil
      ::oFacAutL:End()
   end

   if ::oFacAutI <> nil
      ::oFacAutI:End()
   end

   if !Empty( ::oTree )
      ::oTree:End()
   end

   ::oDbfCli      := nil
   ::oDbfArt      := nil
   ::oAlbCliT     := nil
   ::oAlbCliL     := nil
   ::oFacCliT     := nil
   ::oFacCliL     := nil
   ::oFacCliP     := nil
   ::oFacAutT     := nil
   ::oFacAutL     := nil
   ::oFacAutI     := nil
   ::oDbfDiv      := nil
   ::oDbfCount    := nil
   ::oTree        := nil
   ::oDbfFam      := nil
   ::oDbfKit      := nil
   ::oDbfIva      := nil
   ::oAntCliT     := nil
   ::oDbfFPago    := nil
   ::oDbfAge      := nil

RETURN ( .T. )



static FUNCTION TCreaFacAutomaticas_lSelectCodigoPlantilla( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local oError
   local oBlock
   local lSelect                          := .F.
   local aCodigoGrupo                     := {}

   oBlock                                 := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      CursorWait()

      aCodigoGrupo                     := ::oGrpFacturasAutomaticas:aChild( ::cCodigoGrupo, { ::cCodigoGrupo } )

      ::aPlantilla                     := {}

      ::oFacAutT:oDbf:GoTop()
      while !::oFacAutT:oDbf:Eof()


         if ( Empty( aCodigoGrupo )       .OR. ( lScanCodeInMemo( aCodigoGrupo, ::oFacAutT:oDbf:mGrpSel ) ) )  .AND.  ( Empty( ::cCodigoPlantilla ) .OR. ( ::oFacAutT:oDbf:cCodFac == ::cCodigoPlantilla ) )

            aAdd( ::aPlantilla, { .T., ::oFacAutT:oDbf:cCodFac, ::oFacAutT:oDbf:cNomFac, "Lista para generar documentos." } )

            lSelect                    := .T.

         end

         ::oFacAutT:oDbf:Skip()

      end

      aSort( ::aPlantilla, , , {|x,y| x[1] > y[1]} )

      if !Empty( ::oBrwPlantilla )
         ::oBrwPlantilla:SetArray( ::aPlantilla, , , .F. )
         ::oBrwPlantilla:GoTop()
      end

      CursorWE()

   RECOVER USING oError

      msgStop( "Imposible seleccionar plantillas de facturas automáticas." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

RETURN ( lSelect )






static FUNCTION TCreaFacAutomaticas_lLanzaAsistente( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local lLanza
   local oError
   local oBlock

   lLanza                           := .F.

   ::aPlantilla                     := {}
   ::cErrorMessage                  := ""

   CursorWait()

   if empty( ::oFacAutT:oDbf ) .OR. !( ::oFacAutT:oDbf:used() )
      Return ( lLanza )
   end

   if !( oUser():lDocAuto() )
      Return ( lLanza )
   end

   oBlock                           := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::oFacAutT:oDbf:GoTop()

         while !::oFacAutT:oDbf:Eof()


            if (  ( Empty( ::oFacAutT:oDbf:dFecIni ) .OR. ::oFacAutT:oDbf:dFecIni <= GetSysDate() )   .AND. ( Empty( ::oFacAutT:oDbf:dFecFin ) .OR. ::oFacAutT:oDbf:dFecFin >= GetSysDate() ) )

               if ::lCompruebaFecha()

                  if ::lSeekClient( ::oFacAutT:oDbf:cCodFac )

                     aAdd( ::aPlantilla, { .T., ::oFacAutT:oDbf:cCodFac, ::oFacAutT:oDbf:cNomFac, "Lista para generar documentos." } )

                     lLanza         := .T.

                  else

                     aAdd( ::aPlantilla, { .F., ::oFacAutT:oDbf:cCodFac, ::oFacAutT:oDbf:cNomFac, "No está asignada a ningún cliente." } )

                     ::cErrorMessage+= "La plantilla " + Rtrim( ::oFacAutT:oDbf:cNomFac ) + " no está asignada a ningún cliente." + Chr(13)+Chr(10)

                  end

               else

                  aAdd( ::aPlantilla, { .F., ::oFacAutT:oDbf:cCodFac, ::oFacAutT:oDbf:cNomFac, "Ya ha generado sus documentos." } )

                  ::cErrorMessage   += "La plantilla " + Rtrim( ::oFacAutT:oDbf:cNomFac ) + " ya ha generado sus documentos." + Chr(13)+Chr(10)

               end

            else

               aAdd( ::aPlantilla, { .F., ::oFacAutT:oDbf:cCodFac, ::oFacAutT:oDbf:cNomFac, "No esta en el periodo de fechas." } )

               ::cErrorMessage      += "La plantilla " + Rtrim( ::oFacAutT:oDbf:cNomFac ) + " no esta en el periodo de fechas." + Chr(13)+Chr(10)

            end

            ::oFacAutT:oDbf:Skip()

         end

      if !Empty( ::oBrwPlantilla )

         aSort( ::aPlantilla, , , {|x,y| x[1] > y[1]} )

         ::oBrwPlantilla:SetArray( ::aPlantilla, , , .F. )
         ::oBrwPlantilla:GoTop()

      end

   RECOVER USING oError

      msgStop( "Imposible iniciar el asisitente de facturas automáticas." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   CursorWE()

RETURN ( lLanza )



static FUNCTION TCreaFacAutomaticas_lSeekClient( cCodFac ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local lSeek    := .F.

   ::oDbfCli:GoTop()

   while !::oDbfCli:Eof()

      if At( AllTrim( cCodFac ), ::oDbfCli:mFacAut ) <> 0
         lSeek    := .T.
      end

      if lSeek
         exit
      end

      ::oDbfCli:Skip()

   end

Return lSeek



static FUNCTION TCreaFacAutomaticas_IniciarAsistente( oFld, oDlg ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local oItem
   local aPlantilla

   ::oBtnInicio:Disable()
   ::oFecDocumento:Disable()

   oFld:SetOption( 2 )

   CursorWait()

   ::cFilTxt            := cGetNewFileName( cPatLog() + "DocAut" + Dtos( Date() ) + StrTran( Time(), ":", "" ) ) + ".txt"
   ::hFilTxt            := fCreate( ::cFilTxt )

   if Empty( ::hFilTxt )
      ::hFilTxt         := fOpen( ::cFilTxt, 1 )
   endif

   fWrite( ::hFilTxt, "Proceso iniciado: " + AllTrim( Dtoc( GetSysDate() ) ) + Chr(13)+Chr(10) )

   ::oTree:DeleteAll()

   ::oTree:Select( ::oTree:Add( "Proceso iniciado " + AllTrim( Dtoc( GetSysDate() ) ) ) )





   ::oMetMsg:SetTotal( len( ::aPlantilla ) )

   for each aPlantilla in ::aPlantilla

      if aPlantilla[ 1 ] .AND. ::oFacAutT:oDbf:Seek( aPlantilla[ 2 ] )

         fWrite( ::hFilTxt, "Procesando plantilla " + AllTrim( ::oFacAutT:oDbf:cCodFac ) + " - " + AllTrim( ::oFacAutT:oDbf:cNomFac ) + Chr(13)+Chr(10) )

         ::oTree:Select( ::oTree:Add( "Procesando pantilla " + AllTrim( ::oFacAutT:oDbf:cCodFac ) + " - " + AllTrim( ::oFacAutT:oDbf:cNomFac ) ) )

         ::oDbfCli:GoTop()
         while !::oDbfCli:Eof()

            if At( AllTrim( ::oFacAutT:oDbf:cCodFac ), ::oDbfCli:mFacAut ) <> 0

               if ::oFacAutT:oDbf:nTipDoc <> 2
                  ::CreaAlbaran()
               else
                  ::CreaFactura()
               end

            end

            ::oDbfCli:Skip()

         end





         ::oFacAutI:oDbf:Append()

         ::oFacAutI:oDbf:cCodFac    := ::oFacAutT:oDbf:cCodFac
         ::oFacAutI:oDbf:dFecha     := GetSysDate()
         ::oFacAutI:oDbf:cHora      := Time()
         ::oFacAutI:oDbf:cFichero   := ::cFilTxt

         ::oFacAutI:oDbf:Save()

      end





      ::oMetMsg:AutoInc()

   next

   ::oMetMsg:AutoInc( ::oFacAutT:oDbf:Lastrec() )

   fWrite( ::hFilTxt, "Proceso finalizado correctamente" )

   ::oTree:Select( ::oTree:Add( "Proceso finalizado correctamente" ) )

   fClose( ::hFilTxt )

   CursorWE()





   ::oBtnInforme:Enable()

RETURN ( .T. )



static FUNCTION TCreaFacAutomaticas_CreaAlbaran( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local cText
   local oNode
   local cSerAlb
   local nNumAlb
   local cSufAlb
   local aTotAlb
   local nImpAtp
   local nDtoArt
   local cCodPgo
   local hAtipica    := {=>}
   local hValue      := {=>}

   BeginTransaction()





   ::oAlbCliT:Append()

   if ( ::oFacAutT:oDbf:lUseCli .AND. !Empty( ::oDbfCli:cCodAlm ) )
      ::oAlbCliT:cCodAlm   := ::oDbfCli:cCodAlm
   else
      ::oAlbCliT:cCodAlm   := cDefAlm()
   end





   if !Empty( ::oFacAutT:oDbf:cCodPago )
      cCodPgo              := ::oFacAutT:oDbf:cCodPago
   end

   if Empty( cCodPgo ) .AND. ::oFacAutT:oDbf:lUseCli .AND. !Empty( ::oDbfCli:CodPago )
      cCodPgo              := ::oDbfCli:CodPago
   end

   if Empty( cCodPgo )
      cCodPgo              := cDefFpg()
   end





   ::oAlbCliT:cCodPago     := cCodPgo

   if !Empty( ::oFacAutT:oDbf:cSerFact )
      cSerAlb              := ::oFacAutT:oDbf:cSerFact
   end

   if Empty( cSerAlb ) .AND. ::oFacAutT:oDbf:lUseCli
      cSerAlb              := oRetFld( ::oDbfCli:Cod, ::oDbfCli, "Serie" )
   end

   if Empty( cSerAlb )
      cSerAlb              := cNewSer( "nAlbCli", ::oDbfCount:cAlias )
   end

   nNumAlb                 := nNewDoc( cSerAlb, ::oAlbCliT:cAlias, "nAlbCli", , ::oDbfCount:cAlias )
   cSufAlb                 := RetSufEmp()

   ::oAlbCliT:cTurAlb      := cCurSesion()
   ::oAlbCliT:dFecAlb      := ::dFecDocumento
   ::oAlbCliT:cCodCli      := ::oDbfCli:Cod
   ::oAlbCliT:cCodCaj      := Application():CodigoCaja()
   ::oAlbCliT:cNomCli      := ::oDbfCli:Titulo
   ::oAlbCliT:cDirCli      := ::oDbfCli:Domicilio
   ::oAlbCliT:cPobCli      := ::oDbfCli:Poblacion
   ::oAlbCliT:cPrvCli      := ::oDbfCli:Provincia
   ::oAlbCliT:cPosCli      := ::oDbfCli:CodPostal
   ::oAlbCliT:cDniCli      := ::oDbfCli:Nif
   ::oAlbCliT:lModCli      := ::oDbfCli:lModDat
   ::oAlbCliT:lSndDoc      := .T.
   ::oAlbCliT:cDivAlb      := cDivEmp()
   ::oAlbCliT:nVdvAlb      := nChgDiv( cDivEmp(), ::oDbfDiv:cAlias )
   ::oAlbCliT:lIvaInc      := uFieldEmpresa( "lIvaInc" )
   ::oAlbCliT:cCodUsr      := Auth():Codigo()
   ::oAlbCliT:dFecCre      := GetSysDate()
   ::oAlbCliT:cTimCre      := Time()
   ::oAlbCliT:cCodDlg      := Application():CodigoDelegacion()
   ::oAlbCliT:nTarifa      := Max( uFieldEmpresa( "nPreVta" ), ::oDbfCli:nTarifa )
   ::oAlbCliT:cDtoEsp      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:cDtoEsp, ::oFacAutT:oDbf:cDtoEsp )
   ::oAlbCliT:nDtoEsp      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:nDtoEsp, ::oFacAutT:oDbf:nDtoEsp )
   ::oAlbCliT:cDpp         := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:cDpp, ::oFacAutT:oDbf:cDpp )
   ::oAlbCliT:nDpp         := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:nDpp, ::oFacAutT:oDbf:nDpp )
   ::oAlbCliT:cDtoUno      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:cDtoUno, ::oFacAutT:oDbf:cDtoUno )
   ::oAlbCliT:nDtoUno      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:nDtoCnt, ::oFacAutT:oDbf:nDtoUno )
   ::oAlbCliT:cDtoDos      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:cDtoDos, ::oFacAutT:oDbf:cDtoDos )
   ::oAlbCliT:nDtoDos      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:nDtoRap, ::oFacAutT:oDbf:nDtoDos )
   ::oAlbCliT:cCodAge      := ::oDbfCli:cAgente
   ::oAlbCliT:nPctComAge   := RetFld( ::oDbfCli:cAgente, ::oDbfAge:cAlias, "nCom1" )
   ::oAlbCliT:cCodRut      := ::oDbfCli:cCodRut
   ::oAlbCliT:cCodGrp      := ::oDbfCli:cCodGrp
   ::oAlbCliT:cCodTrn      := ::oDbfCli:cCodTrn
   ::oAlbCliT:nDtoAtp      := ::oDbfCli:nDtoAtp
   ::oAlbCliT:nSbrAtp      := ::oDbfCli:nSbrAtp
   ::oAlbCliT:nIvaMan      := ::oFacAutT:oDbf:nIvaMan
   ::oAlbCliT:nManObr      := ::oFacAutT:oDbf:nManObr
   ::oAlbCliT:cManObr      := ::oFacAutT:oDbf:cManObr
   ::oAlbCliT:lRecargo     := ::oDbfCli:lReq
   ::oAlbCliT:nFacturado   := 1

   hValue[ "cCodigoCliente"    ] := ::oDbfCli:Cod
   hValue[ "dFecha"            ] := ::dFecDocumento
   hValue[ "cCodigoGrupo"      ] := ::oDbfCli:cCodGrp
   hValue[ "lIvaIncluido"      ] := uFieldEmpresa( "lIvaInc" )
   hValue[ "nDescuentoTarifa"  ] := ::oDbfCli:nDtoArt
   hValue[ "nTarifaPrecio"     ] := Max( uFieldEmpresa( "nPreVta" ), ::oDbfCli:nTarifa )

   nDtoArt                 := oRetFld( ::oDbfCli:Cod, ::oDbfCli, "nDtoArt" )

   ::oAlbCliT:cSerAlb      := cSerAlb
   ::oAlbCliT:nNumAlb      := nNumAlb
   ::oAlbCliT:cSufAlb      := cSufAlb

   ::oAlbCliT:Save()





   if ::oFacAutL:oDbf:Seek( ::oFacAutT:oDbf:cCodFac )

      while ::oFacAutL:oDbf:cCodFac == ::oFacAutT:oDbf:cCodFac .AND. !::oFacAutL:oDbf:Eof()

         ::oAlbCliL:Append()
         ::oAlbCliL:cSerAlb         := cSerAlb
         ::oAlbCliL:nNumAlb         := nNumAlb
         ::oAlbCliL:cSufAlb         := cSufAlb
         ::oAlbCliL:cRef            := ::oFacAutL:oDbf:cCodArt
         ::oAlbCliL:cDetalle        := ::oFacAutL:oDbf:cDetalle
         ::oAlbCliL:mLngDes         := ::oFacAutL:oDbf:mLngDes
         ::oAlbCliL:cCodPr1         := ::oFacAutL:oDbf:cCodPr1
         ::oAlbCliL:cCodPr2         := ::oFacAutL:oDbf:cCodPr2
         ::oAlbCliL:cValPr1         := ::oFacAutL:oDbf:cValPr1
         ::oAlbCliL:cValPr2         := ::oFacAutL:oDbf:cValPr2

         ::oAlbCliL:cAlmLin         := ::oAlbCliT:cCodAlm

         hValue[ "cCodigoArticulo"   ] := ::oFacAutL:oDbf:cCodArt
         hValue[ "cCodigoPropiedad1" ] := ::oFacAutL:oDbf:cCodPr1
         hValue[ "cCodigoPropiedad2" ] := ::oFacAutL:oDbf:cCodPr2
         hValue[ "cValorPropiedad1"  ] := ::oFacAutL:oDbf:cValPr1
         hValue[ "cValorPropiedad2"  ] := ::oFacAutL:oDbf:cValPr2

         if ::oDbfArt:Seek( ::oFacAutL:oDbf:cCodArt )

            ::oAlbCliL:nPesoKg      := ::oDbfArt:nPesoKg
            ::oAlbCliL:cPesoKg      := ::oDbfArt:cUnidad
            ::oAlbCliL:nVolumen     := ::oDbfArt:nVolumen
            ::oAlbCliL:cVolumen     := ::oDbfArt:cVolumen
            ::oAlbCliL:cUnidad      := ::oDbfArt:cUnidad
            ::oAlbCliL:lMsgVta      := ::oDbfArt:lMsgVta
            ::oAlbCliL:lNotVta      := ::oDbfArt:lNotVta
            ::oAlbCliL:nFacCnv      := ::oDbfArt:nFacCnv
            ::oAlbCliL:cCodTip      := ::oDbfArt:cCodTip
            ::oAlbCliL:cCodFam      := ::oDbfArt:Familia
            ::oAlbCliL:cGrpFam      := RetFld( ::oDbfArt:Familia, ::oDbfFam:cAlias, "cCodGrp" )
            ::oAlbCliL:nCtlStk      := ::oDbfArt:nCtlStock
            ::oAlbCliL:nCosDiv      := nCosto( nil, ::oDbfArt:cAlias, ::oDbfKit:cAlias )

            hValue[ "cCodigoFamilia"    ] := ::oDbfArt:Familia

            if ( ::oFacAutT:oDbf:lUseCli )

               do case
               case nDtoArt == 1
                  ::oAlbCliL:nDto   := ::oDbfArt:nDtoArt1

               case nDtoArt == 2
                  ::oAlbCliL:nDto   := ::oDbfArt:nDtoArt2

               case nDtoArt == 3
                  ::oAlbCliL:nDto   := ::oDbfArt:nDtoArt3

               case nDtoArt == 4
                  ::oAlbCliL:nDto   := ::oDbfArt:nDtoArt4

               case nDtoArt == 5
                  ::oAlbCliL:nDto   := ::oDbfArt:nDtoArt5

               case nDtoArt == 6
                  ::oAlbCliL:nDto   := ::oDbfArt:nDtoArt6

               end

            end

         end

         ::oAlbCliL:nCanEnt         := ::oFacAutL:oDbf:nCajas
         ::oAlbCliL:nUniCaja        := ::oFacAutL:oDbf:nUnidades
         ::oAlbCliL:lKitArt         := ::oFacAutL:oDbf:lKitArt
         ::oAlbCliL:lKitChl         := ::oFacAutL:oDbf:lKitChl
         ::oAlbCliL:lKitPrc         := ::oFacAutL:oDbf:lKitPrc
         ::oAlbCliL:nIva            := ::oFacAutL:oDbf:nIva
         ::oAlbCliL:nReq            := nPorcentajeRE( ::oDbfIva:cAlias, ::oFacAutL:oDbf:nIva )
         ::oAlbCliL:nNumLin         := ::oFacAutL:oDbf:nNumLin
         ::oAlbCliL:dFecha          := ::dFecDocumento
         ::oAlbCliL:cTipMov         := cDefVta()
         ::oAlbCliL:lIvaLin         := uFieldEmpresa( "lIvaInc" )
         ::oAlbCliL:nTarLin         := Max( uFieldEmpresa( "nPreVta" ), ::oDbfCli:nTarifa )
         ::oAlbCliL:nComAge         := RetFld( ::oDbfCli:cAgente, ::oDbfAge:cAlias, "nCom1" )
         ::oAlbCliL:nPreUnit        := ::oFacAutL:oDbf:nPreUnit
         ::oAlbCliL:nDto            := 0
         ::oAlbCliL:nDtoPrm         := 0
         ::oAlbCliL:nDtoDiv         := 0

         hValue[ "nCajas"            ] := ::oFacAutL:oDbf:nCajas
         hValue[ "nUnidades"         ] := ::oFacAutL:oDbf:nUnidades
         hValue[ "nTipoDocumento"    ] := "10"
         hValue[ "nView"             ] := ::nView

         if ::oFacAutL:oDbf:lPrcAtp





            hAtipica := hAtipica( hValue )

            if !Empty( hAtipica )

               if hhaskey( hAtipica, "nImporte" )
                  if hAtipica[ "nImporte" ] <> 0
                     ::oAlbCliL:nPreUnit := hAtipica[ "nImporte" ]
                  end
               end

               if hhaskey( hAtipica, "nDescuentoPorcentual" )
                  if hAtipica[ "nDescuentoPorcentual" ] <> 0
                     ::oAlbCliL:nDto     := hAtipica[ "nDescuentoPorcentual" ]
                  end
               end

               if hhaskey( hAtipica, "nDescuentoPromocional" )
                  if hAtipica[ "nDescuentoPromocional" ] <> 0
                     ::oAlbCliL:nDtoPrm  := hAtipica[ "nDescuentoPromocional" ]
                  end
               end

               if hhaskey( hAtipica, "nDescuentoLineal" )
                  if hAtipica[ "nDescuentoLineal" ] <> 0
                     ::oAlbCliL:nDtoDiv  := hAtipica[ "nDescuentoLineal" ]
                  end
               end

               if hhaskey( hAtipica, "nComisionAgente" )
                  if hAtipica[ "nComisionAgente" ] <> 0
                     ::oAlbCliL:nComAge  := hAtipica[ "nComisionAgente" ]
                  end
               end

            end

            hAtipica := {=>}

         end

         ::oAlbCliL:Save()

         ::oFacAutL:oDbf:Skip()

      end

      hValue         := {=>}

   end





   aTotAlb                          := aTotAlbCli( cSerAlb + Str( nNumAlb ) + cSufAlb, ::oAlbCliT:cAlias, ::oAlbCliL:cAlias, ::oDbfIva:cAlias, ::oDbfDiv:cAlias, cDivEmp() )

   if ::oAlbCliT:Seek( cSerAlb + Str( nNumAlb ) + cSufAlb )
      ::oAlbCliT:Load()
      ::oAlbCliT:nTotNet            := aTotAlb[ 1 ]
      ::oAlbCliT:nTotIva            := aTotAlb[ 2 ]
      ::oAlbCliT:nTotReq            := aTotAlb[ 3 ]
      ::oAlbCliT:nTotAlb            := aTotAlb[ 4 ]
      ::oAlbCliT:Save()
   end







   cText          := "Albarán: " + cSerAlb + "/" + AllTrim( Str( nNumAlb ) ) + "/" + AllTrim( cSufAlb ) + Space( 1 ) +  "Importe: " + AllTrim( Trans( nTotAlbCli( cSerAlb + Str( nNumAlb ) + cSufAlb, ::oAlbCliT:cAlias, ::oAlbCliL:cAlias, ::oDbfIva:cAlias, ::oDbfDiv:cAlias ), ::cPorDiv ) ) + Space(1) + cSimDiv( cDivEmp(), ::oDbfDiv ) + Space( 1 ) +  "Cliente: " + AllTrim( ::oDbfCli:Cod ) + " - " + AllTrim( ::oDbfCli:Titulo )

   fWrite( ::hFilTxt, cText + Chr(13)+Chr(10) )

   oNode          := ::oTree:Add( cText )
   oNode:bAction  := {|| EdtAlbCli( cSerAlb + Str( nNumAlb ) + cSufAlb ) }

   ::oTree:Select( oNode )





   ::SetNextFechaFactura()





   dbCommitAll()

   CommitTransaction()

RETURN ( Self )



static FUNCTION TCreaFacAutomaticas_CreaFactura( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local cText
   local oNode
   local cSerFac
   local nNumFac
   local cSufFac
   local aTotFac
   local nImpAtp
   local nDtoArt
   local cCodPgo
   local hAtipica
   local hValue            := {=>}

   BeginTransaction()





   ::oFacCliT:Append()

   if ::oFacAutT:oDbf:lUseCli .AND. !Empty( ::oDbfCli:cCodAlm )
      ::oFacCliT:cCodAlm   := ::oDbfCli:cCodAlm
   else
      ::oFacCliT:cCodAlm   := cDefAlm()
   end





   if !Empty( ::oFacAutT:oDbf:cCodPago )
      cCodPgo              := ::oFacAutT:oDbf:cCodPago
   end

   if Empty( cCodPgo ) .AND. ::oFacAutT:oDbf:lUseCli .AND. !Empty( ::oDbfCli:CodPago )
      cCodPgo              := ::oDbfCli:CodPago
   end

   if Empty( cCodPgo )
      cCodPgo              := cDefFpg()
   end

   ::oFacCliT:cCodPago     := cCodPgo





   if !Empty( ::oFacAutT:oDbf:cSerFact )
      cSerFac              := ::oFacAutT:oDbf:cSerFact
   end

   if ::oFacAutT:oDbf:lUseCli
      cSerFac              := oRetFld( ::oDbfCli:Cod, ::oDbfCli, "Serie" )
   end

   if Empty( cSerFac )
      cSerFac              := cNewSer( "nFacCli", ::oDbfCount:cAlias )
   end

   nNumFac                 := nNewDoc( cSerFac, ::oFacCliT:cAlias, "nFacCli", , ::oDbfCount:cAlias )
   cSufFac                 := RetSufEmp()

   ::oFacCliT:cTurFac      := cCurSesion()
   ::oFacCliT:dFecFac      := ::dFecDocumento
   ::oFacCliT:cCodCli      := ::oDbfCli:Cod
   ::oFacCliT:cCodCaj      := Application():CodigoCaja()
   ::oFacCliT:cNomCli      := ::oDbfCli:Titulo
   ::oFacCliT:cDirCli      := ::oDbfCli:Domicilio
   ::oFacCliT:cPobCli      := ::oDbfCli:Poblacion
   ::oFacCliT:cPrvCli      := ::oDbfCli:Provincia
   ::oFacCliT:cPosCli      := ::oDbfCli:CodPostal
   ::oFacCliT:cDniCli      := ::oDbfCli:Nif
   ::oFacCliT:lModCli      := ::oDbfCli:lModDat
   ::oFacCliT:lSndDoc      := .T.
   ::oFacCliT:cDivFac      := cDivEmp()
   ::oFacCliT:nVdvFac      := nChgDiv( cDivEmp(), ::oDbfDiv:cAlias )
   ::oFacCliT:lIvaInc      := uFieldEmpresa( "lIvaInc" )
   ::oFacCliT:cCodUsr      := Auth():Codigo()
   ::oFacCliT:dFecCre      := GetSysDate()
   ::oFacCliT:cTimCre      := Time()
   ::oFacCliT:nTarifa      := Max( uFieldEmpresa( "nPreVta" ), ::oDbfCli:nTarifa )
   ::oFacCliT:cCodDlg      := Application():CodigoDelegacion()
   ::oFacCliT:cDtoEsp      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:cDtoEsp, ::oFacAutT:oDbf:cDtoEsp )
   ::oFacCliT:nDtoEsp      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:nDtoEsp, ::oFacAutT:oDbf:nDtoEsp )
   ::oFacCliT:cDpp         := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:cDpp,    ::oFacAutT:oDbf:cDpp )
   ::oFacCliT:nDpp         := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:nDpp,    ::oFacAutT:oDbf:nDpp )
   ::oFacCliT:cDtoUno      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:cDtoUno, ::oFacAutT:oDbf:cDtoUno )
   ::oFacCliT:nDtoUno      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:nDtoCnt, ::oFacAutT:oDbf:nDtoUno )
   ::oFacCliT:cDtoDos      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:cDtoDos, ::oFacAutT:oDbf:cDtoDos )
   ::oFacCliT:nDtoDos      := if( ::oFacAutT:oDbf:lUseCli, ::oDbfCli:nDtoRap, ::oFacAutT:oDbf:nDtoDos )
   ::oFacCliT:nTipRet      := ::oDbfCli:nTipRet
   ::oFacCliT:nPctRet      := ::oDbfCli:nPctRet

   ::oFacCliT:cCodAge      := ::oDbfCli:cAgente
   ::oFacCliT:nPctComAge   := RetFld( ::oDbfCli:cAgente, ::oDbfAge:cAlias, "nCom1" )
   ::oFacCliT:cCodRut      := ::oDbfCli:cCodRut
   ::oFacCliT:cCodGrp      := ::oDbfCli:cCodGrp
   ::oFacCliT:cCodTrn      := ::oDbfCli:cCodTrn
   ::oFacCliT:nDtoAtp      := ::oDbfCli:nDtoAtp
   ::oFacCliT:nSbrAtp      := ::oDbfCli:nSbrAtp
   ::oFacCliT:lRecargo     := ::oDbfCli:lReq
   ::oFacCliT:nRegIva      := ::oDbfCli:nRegIva

   ::oFacCliT:cManObr      := ::oFacAutT:oDbf:cManObr
   ::oFacCliT:nIvaMan      := ::oFacAutT:oDbf:nIvaMan
   ::oFacCliT:nManObr      := ::oFacAutT:oDbf:nManObr

   hValue[ "cCodigoCliente"    ] := ::oDbfCli:Cod
   hValue[ "dFecha"            ] := ::dFecDocumento
   hValue[ "cCodigoGrupo"      ] := ::oDbfCli:cCodGrp
   hValue[ "lIvaIncluido"      ] := uFieldEmpresa( "lIvaInc" )
   hValue[ "nDescuentoTarifa"  ] := ::oDbfCli:nDtoArt
   hValue[ "nTarifaPrecio"     ] := Max( uFieldEmpresa( "nPreVta" ), ::oDbfCli:nTarifa )

   nDtoArt                 := oRetFld( ::oDbfCli:Cod, ::oDbfCli, "nDtoArt" )

   ::oFacCliT:cSerie       := cSerFac
   ::oFacCliT:nNumFac      := nNumFac
   ::oFacCliT:cSufFac      := cSufFac

   ::oFacCliT:Save()





   if ::oFacAutL:oDbf:Seek( ::oFacAutT:oDbf:cCodFac )

      while ::oFacAutL:oDbf:cCodFac == ::oFacAutT:oDbf:cCodFac .AND. !::oFacAutL:oDbf:Eof()

         ::oFacCliL:Append()

         ::oFacCliL:cSerie       := cSerFac
         ::oFacCliL:nNumFac      := nNumFac
         ::oFacCliL:cSufFac      := cSufFac
         ::oFacCliL:cRef         := ::oFacAutL:oDbf:cCodArt
         ::oFacCliL:cDetalle     := ::oFacAutL:oDbf:cDetalle
         ::oFacCliL:mLngDes      := ::oFacAutL:oDbf:mLngDes
         ::oFacCliL:cCodPr1      := ::oFacAutL:oDbf:cCodPr1
         ::oFacCliL:cCodPr2      := ::oFacAutL:oDbf:cCodPr2
         ::oFacCliL:cValPr1      := ::oFacAutL:oDbf:cValPr1
         ::oFacCliL:cValPr2      := ::oFacAutL:oDbf:cValPr2

         ::oFacCliL:cAlmLin      := ::oFacCliT:cCodAlm

         hValue[ "cCodigoArticulo"   ] := ::oFacAutL:oDbf:cCodArt
         hValue[ "cCodigoPropiedad1" ] := ::oFacAutL:oDbf:cCodPr1
         hValue[ "cCodigoPropiedad2" ] := ::oFacAutL:oDbf:cCodPr2
         hValue[ "cValorPropiedad1"  ] := ::oFacAutL:oDbf:cValPr1
         hValue[ "cValorPropiedad2"  ] := ::oFacAutL:oDbf:cValPr2

         if ::oDbfArt:Seek( ::oFacAutL:oDbf:cCodArt )

            ::oFacCliL:nPesoKg   := ::oDbfArt:nPesoKg
            ::oFacCliL:cPesoKg   := ::oDbfArt:cUnidad
            ::oFacCliL:nVolumen  := ::oDbfArt:nVolumen
            ::oFacCliL:cVolumen  := ::oDbfArt:cVolumen
            ::oFacCliL:cUnidad   := ::oDbfArt:cUnidad
            ::oFacCliL:lMsgVta   := ::oDbfArt:lMsgVta
            ::oFacCliL:lNotVta   := ::oDbfArt:lNotVta
            ::oFacCliL:nFacCnv   := ::oDbfArt:nFacCnv
            ::oFacCliL:cCodTip   := ::oDbfArt:cCodTip
            ::oFacCliL:cCodFam   := ::oDbfArt:Familia
            ::oFacCliL:cGrpFam   := RetFld( ::oDbfArt:Familia, ::oDbfFam:cAlias, "cCodGrp" )
            ::oFacCliL:nCtlStk   := ::oDbfArt:nCtlStock
            ::oFacCliL:nCosDiv   := nCosto( nil, ::oDbfArt:cAlias, ::oDbfKit:cAlias )

            hValue[ "cCodigoFamilia"    ] := ::oDbfArt:Familia

            ::oFacCliL:nPreUnit        := ::oFacAutL:oDbf:nPreUnit
            ::oFacCliL:nDto            := 0
            ::oFacCliL:nDtoPrm         := 0
            ::oFacCliL:nDtoDiv         := 0

            if ( ::oFacAutT:oDbf:lUseCli )

               do case
               case nDtoArt == 1
                  ::oFacCliL:nDto   := ::oDbfArt:nDtoArt1

               case nDtoArt == 2
                  ::oFacCliL:nDto   := ::oDbfArt:nDtoArt2

               case nDtoArt == 3
                  ::oFacCliL:nDto   := ::oDbfArt:nDtoArt3

               case nDtoArt == 4
                  ::oFacCliL:nDto   := ::oDbfArt:nDtoArt4

               case nDtoArt == 5
                  ::oFacCliL:nDto   := ::oDbfArt:nDtoArt5

               case nDtoArt == 6
                  ::oFacCliL:nDto   := ::oDbfArt:nDtoArt6

               end

            end

         end

         ::oFacCliL:nCanEnt      := ::oFacAutL:oDbf:nCajas
         ::oFacCliL:nUniCaja     := ::oFacAutL:oDbf:nUnidades
         ::oFacCliL:lKitArt      := ::oFacAutL:oDbf:lKitArt
         ::oFacCliL:lKitChl      := ::oFacAutL:oDbf:lKitChl
         ::oFacCliL:lKitPrc      := ::oFacAutL:oDbf:lKitPrc
         ::oFacCliL:nIva         := ::oFacAutL:oDbf:nIva
         ::oFacCliL:nReq         := nPorcentajeRE( ::oDbfIva:cAlias, ::oFacAutL:oDbf:nIva )
         ::oFacCliL:nNumLin      := ::oFacAutL:oDbf:nNumLin

         ::oFacCliL:dFecha       := ::dFecDocumento
         ::oFacCliL:cTipMov      := cDefVta()
         ::oFacCliL:lIvaLin      := uFieldEmpresa( "lIvaInc" )
         ::oFacCliL:nTarLin      := Max( uFieldEmpresa( "nPreVta" ), ::oDbfCli:nTarifa )
         ::oFacCliL:cCodAge      := ::oDbfCli:cAgente
         ::oFacCliL:nComAge      := RetFld( ::oDbfCli:cAgente, ::oDbfAge:cAlias, "nCom1" )

         hValue[ "nCajas"            ] := ::oFacAutL:oDbf:nCajas
         hValue[ "nUnidades"         ] := ::oFacAutL:oDbf:nUnidades
         hValue[ "nTipoDocumento"    ] := "11"
         hValue[ "nView"             ] := ::nView

         if ::oFacAutL:oDbf:lPrcAtp





            hAtipica := hAtipica( hValue )

            if !Empty( hAtipica )

               if hhaskey( hAtipica, "nImporte" )
                  if hAtipica[ "nImporte" ] <> 0
                     ::oFacCliL:nPreUnit := hAtipica[ "nImporte" ]
                  end
               end

               if hhaskey( hAtipica, "nDescuentoPorcentual" )
                  if hAtipica[ "nDescuentoPorcentual" ] <> 0
                     ::oFacCliL:nDto     := hAtipica[ "nDescuentoPorcentual" ]
                  end
               end

               if hhaskey( hAtipica, "nDescuentoPromocional" )
                  if hAtipica[ "nDescuentoPromocional" ] <> 0
                     ::oFacCliL:nDtoPrm  := hAtipica[ "nDescuentoPromocional" ]
                  end
               end

               if hhaskey( hAtipica, "nDescuentoLineal" )
                  if hAtipica[ "nDescuentoLineal" ] <> 0
                     ::oFacCliL:nDtoDiv  := hAtipica[ "nDescuentoLineal" ]
                  end
               end

               if hhaskey( hAtipica, "nComisionAgente" )
                  if hAtipica[ "nComisionAgente" ] <> 0
                     ::oFacCliL:nComAge  := hAtipica[ "nComisionAgente" ]
                  end
               end

               hAtipica := {=>}

            end

         end

         ::oFacCliL:Save()

         ::oFacAutL:oDbf:Skip()

      end

      hValue         := {=>}

   end





   aTotFac                          := aTotFacCli( cSerFac + Str( nNumFac ) + cSufFac, ::oFacCliT:cAlias, ::oFacCliL:cAlias, ::oDbfIva:cAlias, ::oDbfDiv:cAlias, ::oFacCliP:cAlias, ::oAntCliT:cAlias, cDivEmp() )

   if ::oFacCliT:Seek( cSerFac + Str( nNumFac ) + cSufFac )
      ::oFacCliT:Load()
      ::oFacCliT:nTotNet            := aTotFac[ 1 ]
      ::oFacCliT:nTotIva            := aTotFac[ 2 ]
      ::oFacCliT:nTotReq            := aTotFac[ 3 ]
      ::oFacCliT:nTotFac            := aTotFac[ 4 ]
      ::oFacCliT:Save()
   end







   cText          := "Factura: " + cSerFac + "/" + AllTrim( Str( nNumFac ) ) + "/" + AllTrim( cSufFac ) + Space( 1 ) +  "Importe: " + AllTrim( Trans( aTotFac[ 4 ], ::cPorDiv ) ) + Space(1) + cSimDiv( cDivEmp(), ::oDbfDiv ) + Space( 1 ) +  "Cliente: " + AllTrim( ::oDbfCli:Cod ) + " - " + AllTrim( ::oDbfCli:Titulo )

   fWrite( ::hFilTxt, cText + Chr(13)+Chr(10) )

   oNode          := ::oTree:Add( cText )
   oNode:bAction  := {|| EdtFacCli( cSerFac + Str( nNumFac ) + cSufFac ) }

   ::oTree:Select( oNode )





   GenPgoFacCli( cSerFac + Str( nNumFac ) + cSufFac, ::oFacCliT:cAlias, ::oFacCliL:cAlias, ::oFacCliP:cAlias, ::oAntCliT:cAlias, ::oDbfCli:cAlias, ::oDbfFPago:cAlias, ::oDbfDiv:cAlias, ::oDbfIva:cAlias )





   if ::oFacCliT:SeekInOrd( cSerFac + Str( nNumFac ) + cSufFac, "nNumFac" )
      ChkLqdFacCli( nil, ::oFacCliT:cAlias, ::oFacCliL:cAlias, ::oFacCliP:cAlias, ::oAntCliT:cAlias, ::oDbfIva:cAlias, ::oDbfDiv:cAlias )
   end





   ::SetNextFechaFactura()





   dbCommitAll()

   CommitTransaction()

RETURN ( Self )



static FUNCTION TCreaFacAutomaticas_lCompruebaFecha( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local lReturn        := .F.

   if ::lChkIgnoraProcesado
      RETURN .T.
   end

   if !Empty( ::oFacAutT:oDbf:dNexFac ) .AND. ( ::oFacAutT:oDbf:dNexFac <= GetSysDate() )
      Return .T.
   end

















































RETURN ( lReturn )



static FUNCTION TCreaFacAutomaticas_ActionTree( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   local oTreeInforme   := ::oTree:GetItem()

   if !Empty( oTreeInforme ) .AND. !Empty( oTreeInforme:bAction )
      Eval( oTreeInforme:bAction )
   end

RETURN ( Self )



static FUNCTION TCreaFacAutomaticas_SetNextFechaFactura( ) ; local Self AS CLASS TCreaFacAutomaticas := QSelf() AS CLASS TCreaFacAutomaticas

   if ( ::oFacAutT:oDbf:nPerSel > 0 ) .AND. !Empty( ::oFacAutT:oDbf:cPerSel )

      do case
         case Alltrim( ::oFacAutT:oDbf:cPerSel ) == "Día"
            ::oFacAutT:oDbf:FieldPutByName( "dNexFac", ( GetSysDate() + ::oFacAutT:oDbf:nPerSel ) )

         case Alltrim( ::oFacAutT:oDbf:cPerSel ) == "Semana"
            ::oFacAutT:oDbf:FieldPutByName( "dNexFac", ( GetSysDate() + ( ::oFacAutT:oDbf:nPerSel * 7 ) ) )

         case Alltrim( ::oFacAutT:oDbf:cPerSel ) == "Mes"
            ::oFacAutT:oDbf:FieldPutByName( "dNexFac", ( AddMonth( GetSysDate(), ::oFacAutT:oDbf:nPerSel ) ) )

         case Alltrim( ::oFacAutT:oDbf:cPerSel ) == "Año"
            ::oFacAutT:oDbf:FieldPutByName( "dNexFac", ( AddMonth( GetSysDate(), ( ::oFacAutT:oDbf:nPerSel * 12 ) ) ) )

      end

   end

RETURN ( Self )



Static Function lScanCodeInMemo( aCodigoGrupo, cMemoGrupo )

   local lScanCodeInMemo   := .F.

   aEval( aCodigoGrupo, {|c| if( !lScanCodeInMemo, lScanCodeInMemo := c $ cMemoGrupo, .T. ) } )

Return ( lScanCodeInMemo )
