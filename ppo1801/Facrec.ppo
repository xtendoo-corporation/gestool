#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 212 ".\.\Prg\Facrec.prg"
memvar cDbf
memvar cDbfCol
memvar cDbfCob
memvar cCliente
memvar cDbfCli
memvar cDivisa
memvar cDbfDiv
memvar cFPago
memvar cDbfPgo
memvar cIva
memvar cDbfIva
memvar cAgente
memvar cDbfAge
memvar cTvta
memvar cDbfTvt
memvar cObras
memvar cDbfObr
memvar cDbfPedT
memvar cDbfPedL
memvar cDbfAlbT
memvar cDbfAlbL
memvar cDbfAntT
memvar cDbfAlbP
memvar cDbfTrn
memvar aImpVto
memvar aDatVto
memvar aTotIva
memvar nTotIvm
memvar aTotIvm
memvar nTotAge
memvar nTotTrn
memvar nTotAnt
memvar nTotCos
memvar nTotRnt
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aIvmUno
memvar aIvmDos
memvar aIvmTre
memvar nPctRnt
memvar nTotDif
memvar aTotTip
memvar cCtaCli
memvar nTotBrt
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotNet
memvar nTotIva
memvar nTotReq
memvar nTotFac
memvar nTotImp
memvar nTotPnt
memvar nTotRet
memvar nTotCob
memvar nTotPes
memvar nTotArt
memvar nTotPage
memvar nVdv
memvar nVdvDivFac
memvar cPicUndFac
memvar cPouDivFac
memvar cPorDivFac
memvar cPpvDivFac
memvar nDouDivFac
memvar nRouDivFac
memvar nDpvDivFac
memvar cCodPgo
memvar nTotCaj
memvar lFacRec
memvar lAntCli
memvar nNumArt
memvar nNumCaj
memvar nTotalDto

memvar lEnd
memvar nRow
memvar nPagina
memvar oReport





static oWndBrw

static nView

static oBrwIva
static dbfRuta
static dbfTikCliT
static dbfFacRecT
static dbfFacRecI
static dbfFacRecD
static dbfFacRecS
static dbfFacRecE
static dbfFacCliT
static dbfFacCliL
static dbfFacCliS
static dbfAlbCliL
static dbfAlbCliS
static dbfAlbCliT
static dbfAlbCliP
static dbfPedCliT
static dbfPedCliL
static dbfPreCliT
static dbfPreCliL
static dbfPedPrvL
static dbfFacCliP
static dbfAntCliT
static dbfTmpLin
static dbfTmpInc
static dbfTmpDoc
static dbfTmpAnt
static dbfTmpPgo
static dbfTmpSer
static dbfTmpEst
static dbfIva
static dbfCount
static dbfClient
static dbfArtPrv
static dbfFPago
static dbfAgent
static dbfPromoT
static dbfPromoL
static dbfPromoC
static dbfAlm
static dbfPro

static dbfCodebar
static dbfTarPreL
static dbfTarPreS
static dbfOferta
static dbfDiv
static dbfObrasT
static dbfFamilia
static dbfKit
static dbfArtDiv
static dbfCliBnc
static dbfCajT
static dbfDelega
static dbfAgeCom
static dbfEmp
static dbfAlbPrvL
static dbfAlbPrvS
static dbfFacPrvL
static dbfFacPrvS
static dbfRctPrvL
static dbfRctPrvS
static dbfTikCliL
static dbfTikCliS
static dbfProLin
static dbfProMat
static dbfProSer
static dbfMatSer
static oStock
static TComercio
static oCtaRem
static oBandera
static oUndMedicion
static cTmpLin
static cTmpInc
static cTmpDoc
static cTmpAnt
static cTmpPgo
static cTmpSer
static cTmpEst
static oGetTotal
static oGetNet
static oGetTotPnt
static oGetTotIvm
static oGetIva
static oGetReq
static oGetAge
static oGetTotPg
static oGetPag
static oGetPdt
static oGetPes
static oGetDif
static oGetTarifa
static cPouDiv
static cPinDiv
static cPorDiv
static cPpvDiv
static cPicUnd
static nVdvDiv
static nDouDiv
static nRouDiv
static nDpvDiv
static oNewImp
static oTipArt
static oGrpFam
static oGetRnt
static oGetTrn
static nTotOld
static cCodDiv
static oBanco

static lImpuestos
static oImpuestos

static oBtnPrecio

static oTotalLinea
static nTotalLinea         := 0
static oRentabilidadLinea
static cRentabilidadLinea  := ""
static oComisionLinea
static nComisionLinea      := 0

static oFont
static oMenu

static oDetCamposExtra
static oCentroCoste

static aTip                := {}
static aNumAlb             := {}
static cOldCodCli          := ""
static cOldCodArt          := ""
static cOldPrpArt          := ""
static cOldUndMed          := ""
static lOpenFiles          := .F.
static lExternal           := .F.
static cFiltroUsuario      := ""
static oMailing

static Counter

static oTipoCtrCoste
static cTipoCtrCoste
static aTipoCtrCoste       := { "Centro de coste", "Proveedor", "Agente", "Cliente" }

static oTrans

static bEdtRec             := { |aTmp, aGet, cFacRecT, oBrw, bWhen, bValid, nMode, aNumDoc| EdtRec( aTmp, aGet, cFacRecT, oBrw, bWhen, bValid, nMode, aNumDoc ) }
static bEdtDet             := { |aTmp, aGet, cFacRecT, oBrw, bWhen, bValid, nMode, aTmpFac| EdtDet( aTmp, aGet, cFacRecT, oBrw, bWhen, bValid, nMode, aTmpFac ) }
static bEdtInc             := { |aTmp, aGet, dbfFacRecI, oBrw, bWhen, bValid, nMode, aTmpLin| EdtInc( aTmp, aGet, dbfFacRecI, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtDoc             := { |aTmp, aGet, dbfFacRecD, oBrw, bWhen, bValid, nMode, aTmpLin| EdtDoc( aTmp, aGet, dbfFacRecD, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtEst                := { |aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpFac | EdtEst( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpFac ) }

static oBrwProperties

static oGetCelda
static cGetCelda





STATIC FUNCTION GenFacRec( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oInf
   local oDevice
   local cNumFac

   if ( D():FacturasRectificativas( nView ) )->( Lastrec() ) == 0
      return nil
   end

   cNumFac              := ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac

   If( nDevice == nil, nDevice := 1, ) ;
   If( cCaption == nil, cCaption := "Imprimiendo facturas rectificativas a clientes", ) ;
   If( cCodDoc == nil, cCodDoc := cFormatoDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ), ) ;
   If( nCopies == nil, nCopies := if( nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) == 0, Max( Retfld( ( D():FacturasRectificativas( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) ), ) ;

   if empty( cCodDoc )
      cCodDoc           := cFirstDoc( "FR", D():Documentos( nView ) )
   end

   if !lExisteDocumento( cCodDoc, D():Documentos( nView ) )
      return nil
   end





   if !empty( oAuditor() )
      if nDevice == 1
         oAuditor():AddEvent( "Impresa factura rectificativa",    cNumFac, "14" )
      else
         oAuditor():AddEvent( "Previsualizada factura rectificativa",  cNumFac, "14" )
      end
   end





   if lVisualDocumento( cCodDoc, D():Documentos( nView ) )
      PrintReportFacRec( nDevice, nCopies, cPrinter )
   else
      msgStop( "El formato ya no es soportado" )
   end

   lChgImpDoc( D():FacturasRectificativas( nView ) )

Return nil



Static Function FacRecReportSkipper( cNumFac, dbfFacRecL )

   if ( dbfFacRecL )->cSerie + Str( ( dbfFacRecL )->nNumFac ) + ( dbfFacRecL )->cSufFac = cNumFac .AND. !( dbfFacRecL )->( eof() )

      ( dbfFacRecL )->( dbSkip() )

      nTotPage              += nTotLFacRec( dbfFacRecL )

   end

Return nil



Static Function EPage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
   private lEnd         := oInf:lFinish
   private nRow         := oInf:nRow





   PrintItems( cCodDoc, oInf )

RETURN NIL



STATIC FUNCTION OpenFiles( lExt )

   local oError
   local oBlock

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de facturas rectificativas a clientes" )
      Return ( .F. )
   end

   If( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      lOpenFiles        := .T.

      nView             := D():CreateView()





      D():Atipicas( nView )

      D():FacturasRectificativas( nView )

      D():FacturasRectificativasSituaciones( nView )

      D():Clientes( nView )

      D():objectGruposClientes( nView )

      D():Get( "CliInc", nView )

      D():ArticuloStockAlmacenes( nView )

      D():Articulos( nView )

      D():ArticuloLenguaje( nView )

      D():GetObject( "UnidadMedicion", nView )

      D():ImpuestosEspeciales( nView )

      D():Documentos( nView )

      D():PropiedadesLineas( nView )

      D():FacturasRectificativasLineas( nView )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecI.DBF" ), ( cCheckArea( "FacRecI", @dbfFacRecI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecD.DBF" ), ( cCheckArea( "FacRecD", @dbfFacRecD ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecD.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecS.DBF" ), ( cCheckArea( "FacRecS", @dbfFacRecS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliL.DBF" ), ( cCheckArea( "FacCliL", @dbfFacCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliS.DBF" ), ( cCheckArea( "FacCliS", @dbfFacCliS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIS.DBF" ), ( cCheckArea( "ALBCLIS", @dbfAlbCliS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIP.DBF" ), ( cCheckArea( "ALBCLIP", @dbfAlbCliP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIL.DBF" ), ( cCheckArea( "PEDCLIT", @dbfPedCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

       dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIL.DBF" ), ( cCheckArea( "PRECLIT", @dbfPreCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @dbfTikCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROVART.DBF" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGENTES.DBF" ), ( cCheckArea( "AGENTES", @dbfAgent ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGENTES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TARPREL.DBF" ), ( cCheckArea( "TARPREL", @dbfTarPreL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TARPREL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TARPRES.DBF" ), ( cCheckArea( "TARPRES", @dbfTarPreS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TARPRES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOT.DBF" ), ( cCheckArea( "PROMOL", @dbfPromoT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOL.DBF" ), ( cCheckArea( "PROMOL", @dbfPromoL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOC.DBF" ), ( cCheckArea( "PROMOC", @dbfPromoC ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOC.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAST", @dbfObrasT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "OFERTA.DBF" ), ( cCheckArea( "OFERTA", @dbfOferta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "OFERTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RUTA.DBF" ), ( cCheckArea( "RUTA", @dbfRuta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RUTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTDIV.DBF" ), ( cCheckArea( "ARTDIV", @dbfArtDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "Almacen.DBF" ), ( cCheckArea( "Almacen", @dbfAlm ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "Almacen.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "NCOUNT.DBF" ), ( cCheckArea( "NCOUNT", @dbfCount ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "NCOUNT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DELEGA.DBF" ), ( cCheckArea( "DELEGA", @dbfDelega ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DELEGA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGECOM.DBF" ), ( cCheckArea( "AGECOM", @dbfAgeCom ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGECOM.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "EMPRESA.DBF" ), ( cCheckArea( "EMPRESA", @dbfEmp ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "EMPRESA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CSTKFAST" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKES.DBF" ), ( cCheckArea( "TIKES", @dbfTikCliS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVL.DBF" ), ( cCheckArea( "ALBPROVL", @dbfAlbPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPRVS.DBF" ), ( cCheckArea( "ALBPRVS", @dbfAlbPrvS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVS.DBF" ), ( cCheckArea( "FACPRVS", @dbfFacPrvS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvS.DBF" ), ( cCheckArea( "RctPrvS", @dbfRctPrvS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROLIN.DBF" ), ( cCheckArea( "PROLIN", @dbfProLin ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROLIN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMAT.DBF" ), ( cCheckArea( "PROMAT", @dbfProMat ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ProSer.DBF" ), ( cCheckArea( "ProSer", @dbfProSer ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ProSer.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "MatSer.DBF" ), ( cCheckArea( "MatSer", @dbfMatSer ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "MatSer.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDPROVL.DBF" ), ( cCheckArea( "PedPrvL", @dbfPedPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.Dbf" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliBnc.Dbf" ), ( cCheckArea( "CLIBNC", @dbfCliBnc ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CliBnc.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

        if !TDataCenter():OpenPreCliT( @dbfPreCliT )
            lOpenFiles     := .F.
        end

        if !TDataCenter():OpenPedCliT( @dbfPedCliT )
            lOpenFiles     := .F.
          end

        if !TDataCenter():OpenAlbCliT( @dbfAlbCliT )
           lOpenFiles     := .F.
        end

        if !TDataCenter():OpenFacCliT( @dbfFacCliT )
         lOpenFiles     := .F.
      end

          if !TDataCenter():OpenFacCliP( @dbfFacCliP )
           lOpenFiles     := .F.
       else
            ( dbfFacCliP )->( OrdSetFocus( "rNumFac" ) )
        end

      oBandera          := TBandera():New()

      oStock            := TStock():Create( cPatEmp() )
      if !oStock:lOpenFiles()
         lOpenFiles     := .F.
      end

      oCtaRem           := TCtaRem():Create( cPatEmp() )
      if !oCtaRem:OpenFiles()
         lOpenFiles     := .F.
      end

      oNewImp           := TNewImp():Create( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

      oTrans            := TTrans():Create( cPatEmp() )
      if !oTrans:OpenFiles()
         lOpenFiles     := .F.
      end

      oTipArt           := TTipArt():Create( cPatEmp() )
      if !oTipArt:OpenFiles()
         lOpenFiles     := .F.
      end

      oGrpFam           := TGrpFam():Create( cPatEmp() )
      if !oGrpFam:OpenFiles()
         lOpenFiles     := .F.
      end

      oUndMedicion      := UniMedicion():Create( cPatEmp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles     := .F.
      end

      oBanco               := TBancos():Create()
      if !oBanco:OpenFiles()
         lOpenFiles     := .F.
      end

      oCentroCoste        := TCentroCoste():Create( cPatDat() )
      if !oCentroCoste:OpenFiles()
         lOpenFiles     := .F.
      end

      oMailing          := TGenmailingDatabaseFacturaRectificativaCliente():New( nView )

      TComercio         := TComercio():New( nView, oStock)

      Counter           := TCounter():New( nView, "nFacRec" )





      public nTotFac    := 0
      public nTotBrt    := 0
      public nTotDto    := 0
      public nTotDPP    := 0
      public nTotNet    := 0
      public nTotIva    := 0
      public nTotIvm    := 0
      public nTotAge    := 0
      public nTotReq    := 0
      public nTotPnt    := 0
      public nTotUno    := 0
      public nTotDos    := 0
      public nTotRet    := 0
      public nTotTrn    := 0
      public nTotAnt    := 0
      public nTotCos    := 0
      public nTotPes    := 0
      public nTotRnt    := 0
      public nPctRnt    := 0
      public nTotDif    := 0










      public aTotIva    := { {     "porcentajeiva" => 0,    "logrecargo"    => .F.,    "porcentajere"    => 0,    "bruto"            => 0,    "neto"            => 0,    "impiva"        => 0,    "impre"            => 0,    "nivmh"            => 0,    "ntransporte"    => 0,    "npntver"        => 0 } }

      public aTotIvm    := { { 0,0,0 }, { 0,0,0 }, { 0,0,0 }, }
      public aIvmUno    := aTotIvm[ 1 ]
      public aIvmDos    := aTotIvm[ 2 ]
      public aIvmTre    := aTotIvm[ 3 ]

      public aImpVto    := {}
      public aDatVto    := {}

      public nNumArt    := 0
      public nNumCaj    := 0
      public cCtaCli    := ""





      if lAIS() .AND. !oUser():lAdministrador()

         cFiltroUsuario    := "Field->cSufFac == '" + Application():CodigoDelegacion() + "' .and. Field->cCodCaj == '" + Application():CodigoCaja() + "'"
         if RolesModel():getRolFiltrarVentas( Auth():rolUuid() )
            cFiltroUsuario += " .and. Field->cCodUsr == '" + Auth():Codigo()  + "'"
         end

         ( D():FacturasRectificativas( nView ) )->( AdsSetAOF( cFiltroUsuario ) )

      end





      oDetCamposExtra      := TDetCamposExtra():New()
      oDetCamposExtra:OpenFiles()
      oDetCamposExtra:SetTipoDocumento( "Facturas rectificativa a clientes" )
      oDetCamposExtra:setbId( {|| D():FacturasRectificativasId( nView ) } )


   RECOVER USING oError

      lOpenFiles        := .F.

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos" )

   end
   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

RETURN ( lOpenFiles )



STATIC FUNCTION CloseFiles()

   DestroyFastFilter( D():FacturasRectificativas( nView ), .T., .T. )

   if !empty( oFont )
      oFont:end()
   end

   if !empty( dbfIva )
      ( dbfIva     )->( dbCloseArea() )
   end

   if !empty( dbfFPago )
      ( dbfFPago   )->( dbCloseArea() )
   end

   if !empty( dbfAgent )
      ( dbfAgent   )->( dbCloseArea() )
   end

   if !empty( dbfFacRecS )
      ( dbfFacRecS )->( dbCloseArea() )
   end

   if !empty( dbfFacRecI )
      ( dbfFacRecI )->( dbCloseArea() )
   end

   if !empty( dbfFacRecD )
      ( dbfFacRecD )->( dbCloseArea() )
   end

   if !empty( dbfFacCliT )
      ( dbfFacCliT )->( dbCloseArea() )
   end

   if !empty( dbfFacCliL )
      ( dbfFacCliL )->( dbCloseArea() )
   end

   if !empty( dbfFacCliS )
      ( dbfFacCliS )->( dbCloseArea() )
   end

   if !empty( dbfFacCliP )
      ( dbfFacCliP )->( dbCloseArea() )
   end

   if !empty( dbfAlbCliT )
      ( dbfAlbCliT )->( dbCloseArea() )
   end

   if !empty( dbfAlbCliL )
      ( dbfAlbCliL )->( dbCloseArea() )
   end

   if !empty( dbfAlbCliS )
      ( dbfAlbCliS )->( dbCloseArea() )
   end

   if !empty( dbfAlbCliP )
      ( dbfAlbCliP )->( dbCloseArea() )
   end

   if !empty( dbfPedCliT )
      ( dbfPedCliT )->( dbCloseArea() )
   end

   if !empty( dbfPedCliL )
      ( dbfPedCliL )->( dbCloseArea() )
   end

   if !empty( dbfPreCliT )
      ( dbfPreCliT )->( dbCloseArea() )
   end

   if !empty( dbfPreCliL )
      ( dbfPreCliL )->( dbCloseArea() )
   end

   if !empty( dbfTikCliT )
      ( dbfTikCliT )->( dbCloseArea() )
   end

   if dbfCodebar <> nil
      ( dbfCodebar )->( dbCloseArea() )
   end

   if !empty( dbfFamilia )
      ( dbfFamilia )->( dbCloseArea() )
   end

   if !empty( dbfKit )
      ( dbfKit     )->( dbCloseArea() )
   end

   if !empty( dbfTarPreL )
      ( dbfTarPreL )->( dbCloseArea() )
   end

   if !empty( dbfTarPreS )
      ( dbfTarPreS )->( dbCloseArea() )
   end

   if !empty( dbfPromoT )
      ( dbfPromoT  )->( dbCloseArea() )
   end

   if !empty( dbfPromoL )
      ( dbfPromoL  )->( dbCloseArea() )
   end

   if !empty( dbfPromoC )
      ( dbfPromoC  )->( dbCloseArea() )
   end

   if !empty( dbfAlm )
   ( dbfAlm    )->( dbCloseArea() )
   end

   if !empty( dbfDiv )
   ( dbfDiv     )->( dbCloseArea() )
   end

   if !empty( dbfObrasT )
   ( dbfObrasT  )->( dbCloseArea() )
   end

   if !empty( dbfOferta )
      ( dbfOferta  )->( dbCloseArea() )
   end

   if !empty( dbfPro )
      ( dbfPro     )->( dbCloseArea() )
   end

   if !empty( dbfRuta )
      ( dbfRuta    )->( dbCloseArea() )
   end

   if !empty( dbfArtDiv )
      ( dbfArtDiv  )->( dbCloseArea() )
   end

   if !empty( dbfCajT )
      ( dbfCajT    )->( dbCloseArea() )
   end

   if !empty( dbfCount )
      ( dbfCount   )->( dbCloseArea() )
   end

   if dbfArtPrv <> nil
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if !empty( dbfDelega )
      ( dbfDelega )->( dbCloseArea() )
   end

   if !empty( dbfAgeCom )
      ( dbfAgeCom )->( dbCloseArea() )
   end

   if !empty( dbfEmp )
      ( dbfEmp )->( dbCloseArea() )
   end

   if !empty( dbfAlbPrvL )
      ( dbfAlbPrvL )->( dbCloseArea() )
   end

   if !empty( dbfAlbPrvS )
      ( dbfAlbPrvS )->( dbCloseArea() )
   end

   if !empty( dbfFacPrvL )
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if !empty( dbfFacPrvS )
      ( dbfFacPrvS )->( dbCloseArea() )
   end

   if !empty( dbfRctPrvL )
      ( dbfRctPrvL )->( dbCloseArea() )
   end

   if !empty( dbfRctPrvS )
      ( dbfRctPrvS )->( dbCloseArea() )
   end

   if !empty( dbfTikCliL )
      ( dbfTikCliL )->( dbCloseArea() )
   end

   if !empty( dbfTikCliS )
      ( dbfTikCliS )->( dbCloseArea() )
   end

   if !empty( dbfProLin )
      ( dbfProLin )->( dbCloseArea() )
   end

   if !empty( dbfProMat )
      ( dbfProMat )->( dbCloseArea() )
   end

   if !empty( dbfProSer )
      ( dbfProSer )->( dbCloseArea() )
   end

   if !empty( dbfMatSer )
      ( dbfMatSer )->( dbCloseArea() )
   end

   if dbfPedPrvL <> nil
      ( dbfPedPrvL )->( dbCloseArea() )
   end

   if !empty( dbfAntCliT )
      ( dbfAntCliT )->( dbCloseArea() )
   end

   if !empty( dbfCliBnc )
      ( dbfCliBnc )->( dbClosearea() )
   end

   if !empty( oStock )
      oStock:end()
   end

   if !empty( oCtaRem )
      oCtaRem:end()
   end

   if !empty( oNewImp )
      oNewImp:end()
   end

   if !empty( oTipArt )
      oTipArt:end()
   end

   if !empty( oGrpFam )
      oGrpFam:end()
   end

   if !empty( oTrans )
      oTrans:End()
   end

   if !empty( oUndMedicion )
      oUndMedicion:end()
   end

   if !empty( oBanco )
      oBanco:End()
   end

   if !empty( oDetCamposExtra )
      oDetCamposExtra:CloseFiles()
   end

   if !empty( oCentroCoste )
      oCentroCoste:End()
   end

   if !empty(oMailing)
      oMailing:end()
   end

   TComercio:end()

   D():DeleteView( nView )

   dbfIva      := nil
   dbfFPago    := nil
   dbfAgent    := nil
   dbfFacRecD  := nil
   dbfFacRecS  := nil
   dbfFacCliT  := nil
   dbfFacCliL  := nil
   dbfFacCliP  := nil
   dbfAlbCliT  := nil
   dbfAlbCliL  := nil
   dbfAlbCliS  := nil
   dbfPedCliT  := nil
   dbfPedCliL  := nil
   dbfPreCliT  := nil
   dbfPreCliL  := nil
   dbfTikCliT  := nil
   dbfCodebar  := nil
   dbfFamilia  := nil
   dbfKit      := nil
   dbfTarPreL  := nil
   dbfTarPreS  := nil
   dbfPromoT   := nil
   dbfPromoL   := nil
   dbfPromoC   := nil
   dbfAlm      := nil
   dbfDiv      := nil
   oBandera    := nil
   dbfObrasT   := nil
   dbfOferta   := nil
   dbfPro      := nil
   dbfRuta     := nil
   dbfArtDiv   := nil
   dbfCajT     := nil
   dbfArtPrv   := nil
   dbfDelega   := nil
   dbfAgeCom   := nil
   dbfEmp      := nil
   dbfAlbPrvL  := nil
   dbfAlbPrvS  := nil
   dbfFacPrvL  := nil
   dbfFacPrvS  := nil
   dbfRctPrvL  := nil
   dbfRctPrvS  := nil

   dbfTikCliL  := nil
   dbfTikCliS  := nil
   dbfProLin   := nil
   dbfProMat   := nil
   dbfPedPrvL  := nil
   dbfCliBnc   := nil

   oStock      := nil
   oNewImp     := nil
   oTipArt     := nil
   oGrpFam     := nil
   oUndMedicion:= nil
   oBanco      := nil
   oTrans        := nil

   oWndBrw     := nil

   lOpenFiles  := .F.

RETURN .T.



FUNCTION FacRec( oMenuItem, oWnd, cCodCli, cCodArt, cCodPed, aNumDoc )

   local oRpl
   local oSnd
   local oImp
   local oPrv
   local oDel
   local oPdf
   local oMail
   local oDup
   local oBtnEur
   local lEuro          := .F.
   local nLevel
   local oRotor
   local oLiq
   local oScript

   If( oMenuItem == nil, oMenuItem := "rectificativas_de_clientes", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;
   If( aNumDoc == nil, aNumDoc := Array(3), ) ;
   If( cCodCli == nil, cCodCli := "", ) ;
   If( cCodArt == nil, cCodArt := "", ) ;
   If( cCodPed == nil, cCodPed := "", ) ;

   nLevel            := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return Nil
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      Return .F.
   end
























   oWndBrw := TShell():New( 0, 0, 22, 80, "Facturas rectificativas",, oWnd,,, .F.,,, ( D():FacturasRectificativas( nView ) ),,,,, {"Número", "Fecha", "Código", "Nombre", "Código postal", "Población", "Provincia", "Dirección", "Sesión", "Agente", "Pago", "Total"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, D():FacturasRectificativas( nView ), cCodCli, cCodArt, aNumDoc ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, D():FacturasRectificativas( nView ), cCodCli, cCodArt, aNumDoc ) )}, {||( WinDelRec( oWndBrw:oBrw, D():FacturasRectificativas( nView ), {|| QuiFacRec() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, D():FacturasRectificativas( nView ), cCodCli, cCodArt, aNumDoc ) )}, nil, nLevel, "gc_document_text_delete_16", ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ),,, .T. )

      oWndBrw:lFechado     := .T.

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->lCloFac }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "gc_lock2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Cobrado"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nChkPagFacRec( ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, D():FacturasRectificativas( nView ), dbfFacCliP ) }
         :nWidth           := 20
         :AddResource( "gc_check_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_money2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Contabilizado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->lConTab }
         :nWidth           := 20
         :SetCheck( { "gc_folder2_12", "Nil16" } )
         :AddResource( "gc_folder2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "gc_mail2_12", "Nil16" } )
         :AddResource( "gc_mail2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Entregado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| !empty( ( D():FacturasRectificativas( nView ) )->dFecEnt ) }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "gc_document_text_check_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_check_12" )
         :AddResource( "gc_document_information_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Impreso"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "gc_printer2_12", "Nil16" } )
         :AddResource( "gc_printer2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cSerie + "/" + alltrim( Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) )  }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cSufFac }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :cSortOrder       := "cTurFac"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cTurFac }
         :nWidth           := 40
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dDesFec"
         :bEditValue       := {|| Dtoc( ( D():FacturasRectificativas( nView ) )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Hora"
         :bEditValue       := {|| trans( ( D():FacturasRectificativas( nView ) )->tFecFac, "@R 99:99:99") }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| alltrim( ( D():FacturasRectificativas( nView ) )->cCodCli ) }
         :nWidth           := 70
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| alltrim( ( D():FacturasRectificativas( nView ) )->cNomCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código postal"
         :cSortOrder       := "CodPostal"
         :bEditValue       := {|| alltrim( ( D():FacturasRectificativas( nView ) )->cPosCli ) }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Población"
         :cSortOrder       := "cPobCli"
         :bEditValue       := {|| alltrim( ( D():FacturasRectificativas( nView ) )->cPobCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Provincia"
         :cSortOrder       := "Provincia"
         :bEditValue       := {|| alltrim( ( D():FacturasRectificativas( nView ) )->cPrvCli ) }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Agente"
         :cSortOrder       := "cCodAge"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cCodAge }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pago"
         :cSortOrder       := "cCodPago"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cCodPago }
         :nWidth           := 40
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :bLDClickData     := {|| oWndBrw:RecEdit() }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Ruta"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cCodRut }
         :nWidth           := 40
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Almacén"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cCodAlm }
         :nWidth           := 60
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Dirección"
         :cSortOrder       := "cCodObr"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cCodObr }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Des. dirección"
         :bEditValue       := {|| ClientesDireccionesModel():getName( ( D():FacturasRectificativas( nView ) )->cCodCli, ( D():FacturasRectificativas( nView ) )->cCodObr ) }
         :nWidth           := 150
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->nTotNet }
         :cEditPicture     := cPorDiv( ( D():FacturasRectificativas( nView ) )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->nTotIva }
         :cEditPicture     := cPorDiv( ( D():FacturasRectificativas( nView ) )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->nTotReq }
         :cEditPicture     := cPorDiv( ( D():FacturasRectificativas( nView ) )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->nTotFac }
         :cEditPicture     := cPorDiv( ( D():FacturasRectificativas( nView ) )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :cSortOrder       := "nTotFac"
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( D():FacturasRectificativas( nView ) )->cDivFac ), dbfDiv ) }
         :nWidth           := 30
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Centro de coste"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cCtrCoste }
         :nWidth           := 30
         :lHide            := .T.
      end

   oDetCamposExtra:addCamposExtra( oWndBrw )

   oWndBrw:cHtmlHelp    := "Rectificativas de clientes"

   oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()








   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )







   oWndBrw:NewAt( "ZOOM",,, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, D():FacturasRectificativas( nView ) ) )}, "(Z)oom", "Z",,, 8,, .F. )







   oDel := oWndBrw:NewAt( "DEL",,, {||( WinDelRec( oWndBrw:oBrw, D():FacturasRectificativas( nView ), {|| QuiFacRec() } ) )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )







   oWndBrw:NewAt( "DEL",,, {||( DelSerie( oWndBrw ) )}, "Series",,,, 16, oDel, .F. )







   oImp := oWndBrw:NewAt( "IMP",,, {||( GenFacRec( 1 ), oWndBrw:Refresh() )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenFacRec( oWndBrw:oBrw, oImp, 1 )





   oWndBrw:NewAt( "GC_PRINTER2_",,, {||( ImprimirSeriesFacturasRectificativas() )}, "Imp(r)imir series", "R",,, 32,, .F. )







   oPrv := oWndBrw:NewAt( "PREV1",,, {||( GenFacRec( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenFacRec( oWndBrw:oBrw, oPrv, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( GenFacRec( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenFacRec( oWndBrw:oBrw, oPdf, 3 )





   oMail := oWndBrw:NewAt( "GC_MAIL_EARTH_",,, {||( oMailing:documentsDialog( oWndBrw:oBrw:aSelected ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )






   oWndBrw:NewAt( "gc_portable_barcode_scanner_",,, {||( TLabelGeneratorFacturasRectificativaClientes():New( nView ):Dialog() )}, "Eti(q)uetas", "Q",,, 32,, .F. )





   oLiq := oWndBrw:NewAt( "gc_money2_",,, {||( lLiquida( oWndBrw:oBrw ) )}, "Cobrar",,,, 4,, .F. )







   oWndBrw:NewAt( "gc_money2_",,, {||( aGetSelRec( oWndBrw, {|| lLiquida( oWndBrw:oBrw, ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac ) }, "Liquidar series de facturas", .T., nil, .T., nil ) )}, "Cobrar series",,,, 4, oLiq, .F. )






   oWndBrw:NewAt( "BMPCONTA",,, {||( aGetSelRec( oWndBrw, {|lChk1, lChk2, oTree| CntFacRec( lChk1, lChk2, nil, .T., oTree, nil, nil, D():FacturasRectificativas( nView ), D():FacturasRectificativasLineas( nView ), dbfFacCliP, D():Clientes( nView ), dbfDiv, D():Articulos( nView ), dbfFPago, dbfIva, oNewImp ) }, "Contabilizar facturas rectificativas", .F., "Simular resultados", .F., "Contabilizar recibos", {|| oDiario() }, {|| cDiario() } ) )}, "(C)ontabilizar", "C",,, 4,, .F. )

   if RolesModel():getRolCambiarEstado( Auth():rolUuid() )






   oWndBrw:NewAt( "CHGSTATE",,, {||( aGetSelRec( oWndBrw, {| lChk1 | if( ( D():FacturasRectificativas( nView ) )->( dbRLock() ), ( ( D():FacturasRectificativas( nView ) )->lContab := lChk1, ( D():FacturasRectificativas( nView ) )->( dbUnlock() ) ), ) }, "Cambiar estado", .F., "Contabilizado", .T. ) )}, "Cambiar es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "LBL",, "Seleccionar albaranes para ser enviados", {||lSnd( oWndBrw, D():FacturasRectificativas( nView ) )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )







   oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():FacturasRectificativas( nView ), "lSndDoc", .T., .T., .T. ) )}, "Todos",,,, 4, oSnd, .F. )







   oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():FacturasRectificativas( nView ), "lSndDoc", .F., .T., .T. ) )}, "Ninguno",,,, 4, oSnd, .F. )







   oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():FacturasRectificativas( nView ), "lSndDoc", .T., .F., .T. ) )}, "Abajo",,,, 4, oSnd, .F. )






   oBtnEur := oWndBrw:NewAt( "gc_currency_euro_",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,, 8,, .F. )




   oWndBrw:NewAt( "gc_document_text_pencil_",,, {||( Counter:OpenDialog() )}, "Establecer contadores",,,,,, .F. )

   if RolesModel():getRolCambiarCampos( Auth():rolUuid() )






   oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():FacturasRectificativas( nView ), aItmFacRec() ) )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







   oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():FacturasRectificativasLineas( nView ), aColFacRec() ) )}, "Lineas",,,, 4, oRpl, .F. )

   end






   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,, {|This|This:Toggle()},,, .F. )






   oWndBrw:NewAt( "GC_USER_",,, {||( EdtCli( ( D():FacturasRectificativas( nView ) )->cCodCli ) )}, "Modificar cliente",,,,, oRotor, .F. )






   oWndBrw:NewAt( "INFO",,, {||( InfCliente( ( D():FacturasRectificativas( nView ) )->cCodCli ) )}, "Informe de cliente",,,,, oRotor, .F. )




    oScript := oWndBrw:NewAt( "gc_folder_document_",,, {||( oScript:Expand() )}, "Scripts",,,,,, .F. )
      ImportScript( oWndBrw, oScript, "FacturasRectificativasClientes" )







   oWndBrw:NewAt( "GC_CLIPBOARD_EMPTY_USER_",,, {||( EdtObras( ( D():FacturasRectificativas( nView ) )->cCodCli, ( D():FacturasRectificativas( nView ) )->cCodObr, dbfObrasT ) )}, "Modificar dirección",,,,, oRotor, .F. )




   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .F. )





    oWndBrw:oActiveFilter:SetFields( aItmFacRec() )
    oWndBrw:oActiveFilter:SetFilterType( "14" )

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp, .F. )

   if !empty( oWndBrw )

      if uFieldempresa( "lFltYea" )
         oWndBrw:setYearCombobox()
      end

      if !empty( cCodCli ) .OR. !empty( cCodArt ) .OR. !empty( aNumDoc[ 1 ] ) .OR. !empty( aNumDoc[ 2 ] ) .OR. !empty( aNumDoc[ 3 ] )
         oWndBrw:RecAdd()
         cCodCli        := nil
         cCodArt        := nil
         aNumDoc        := Array( 3 )
      end

   end

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbf, oBrw, cCodCli, cCodArt, nMode, aNumDoc )

   local oDlg
    local oFld
   local oBrwLin
   local oBrwInc
   local oBrwDoc
   local oBrwPgo
   local oBrwEst
   local oSay              := Array( 12 )
   local cSay              := Array( 12 )
   local oSayLabels        := Array( 9 )
   local oBmpDiv
   local oBmpEmp
   local nOrd
   local oBtnKit
   local oTlfCli
   local cTlfCli
   local oRieCli
   local nRieCli
   local oGetMasDiv
   local cGetMasDiv        := ""
   local cSerie
   local oSayGetRnt
   local oBmpGeneral

   If( cSerie == nil, cSerie := cNewSer( "nFacRec", dbfCount ), ) ;
   If( aNumDoc == nil, aNumDoc := Array( 3 ), ) ;

   setOldPorcentajeAgente( aTmp[ 24 ] )

   do case
   case nMode == 1

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 5    ]  := cCurSesion()
      aTmp[ 28    ]  := cToD("")
      aTmp[ 8    ]  := Application():codigoAlmacen()
      aTmp[ 9    ]  := Application():CodigoCaja()
      aTmp[ 34   ]  := cDefFpg()
      aTmp[ 60    ]  := cDivEmp()
      aTmp[ 61    ]  := nChgDiv( aTmp[ 60 ], dbfDiv )
      aTmp[ 3    ]  := RetSufEmp()
      aTmp[ 59    ]  := .T.
      aTmp[ 66    ]  := cProCnt()
      aTmp[ 78    ]  := Auth():Codigo()
      aTmp[ 21    ]  := cDefVta()
      aTmp[ 85    ]  := Application():CodigoDelegacion()
      aTmp[ 58    ]  := uFieldEmpresa( "lIvaInc" )
      aTmp[ 86    ]  := padr( getConfigTraslation( "Gastos" ), 250 )
      aTmp[ 103    ]  := getSysTime()

      if !empty( cCodCli )
         aTmp[ 7 ]  := cCodCli
      end

      aTmp[ 37    ]  := nIva( dbfIva, cDefIva() )

   case nMode == 4

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 6  ]    := GetSysDate()
      aTmp[ 39  ]    := ""
      aTmp[ 30  ]    := .F.
      aTmp[ 74  ]    := .F.
      aTmp[ 26  ]    := .F.
      aTmp[ 59  ]    := .T.
      aTmp[ 78    ]  := Auth():Codigo()

   case nMode == 2

      if aTmp[ 74 ] .AND. !oUser():lAdministrador()
         msgStop( "Solo puede modificar las facturas cerradas los administradores." )
         return .F.
      end


      if aTmp[ 26 ] .AND. !ApoloMsgNoYes(  "La modificación de esta factura puede provocar descuadres contables." + Chr(13)+Chr(10) + "¿ Desea continuar ?", "Factura ya contabilizada" )
         return .F.
      end

      lChangeRegIva( aTmp )

   end





   cOldCodCli              := aTmp[7]





   nOrd                    := ( D():FacturasRectificativas( nView ) )->( ordSetFocus( 1 ) )





   if empty( Rtrim( aTmp[ 1 ] ) )
      aTmp[ 1 ]      := cSerie
   end

   if empty( aTmp[19] )
      aTmp[ 19 ]     := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end

   if empty( aTmp[ 60 ] )
      aTmp[ 60 ]     := cDivEmp()
   end

   if empty( aTmp[ 41 ] )
      aTmp[ 41 ]     := Padr( "General", 50 )
   end

   if empty( aTmp[ 43 ] )
      aTmp[ 43 ]        := Padr( "Pronto pago", 50 )
   end





   nRieCli                 := oStock:nRiesgo( aTmp[ 7 ] )

   if empty( aTmp[ 89 ] )
      aTmp[ 89 ]     := RetFld( aTmp[ 7 ], D():Clientes( nView ), "Telefono" )
   end

   if BeginTrans( aTmp, nMode )
      Return .F.
   end

   cPicUnd                 := MasUnd()
   cPouDiv                 := cPouDiv( aTmp[ 60 ], dbfDiv )
   cPorDiv                 := cPorDiv( aTmp[ 60 ], dbfDiv )
   cPinDiv                 := cPinDiv( aTmp[ 60 ], dbfDiv )
   nDouDiv                 := nDouDiv( aTmp[ 60 ], dbfDiv )
   nRouDiv                 := nRouDiv( aTmp[ 60 ], dbfDiv )
   cPpvDiv                 := cPpvDiv( aTmp[ 60 ], dbfDiv )
   nDpvDiv                 := nDpvDiv( aTmp[ 60 ], dbfDiv )

   oFont                   := TFont():New( "Arial", 8, 26, .F., .T. )





   cSay[ 2 ]               := RetFld( aTmp[ 8 ], dbfAlm )
   cSay[ 4 ]               := RetFld( aTmp[ 34], dbfFPago )
   cSay[ 8 ]               := RetFld( aTmp[ 21 ], dbfRuta )
   cSay[ 3 ]               := RetFld( aTmp[ 20 ], dbfAgent )
   cSay[ 5 ]               := RetFld( aTmp[ 22 ], dbfTarPreS )
   cSay[ 7 ]               := RetFld( aTmp[ 7 ] + aTmp[ 23 ], dbfObrasT, "cNomObr" )
   cSay[ 9 ]               := oTrans:cNombre( aTmp[ 72 ] )
   cSay[ 10]               := RetFld( aTmp[ 9 ], dbfCajT )
   cSay[ 11]               := UsuariosModel():getNombreWhereCodigo( aTmp[ 78 ] )
   cSay[ 12]               := RetFld( cCodEmp() + aTmp[ 85 ], dbfDelega, "cNomDlg" )





   InitTarifaCabecera( aTmp[ 19 ] )





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "facturas rectificativas", "FacCli",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )


















      oFld := TFolder():ReDefine( 400, {"&Factura", "Da&tos", "&Incidencias", "D&ocumentos", "&Situaciones"}, { "FACREC_01","FACREC_02","PEDCLI_3","PEDCLI_4","PEDCLI_5" }, oDlg,,,,, .F., )









      oBmpGeneral := TBitmap():ReDefine( 990, "gc_document_text_delete_48",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_folders2_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_information_48",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_address_book_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_document_attachment_48",, oFld:aDialogs[5],,, .F., .F.,,, .F.,,, .T. )







        aGet[ 7] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],,, {||    ( loaCli( aGet, aTmp, nMode, oRieCli ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[ 7 ], aGet[ 10 ] ), ::lValid() )}, nil, "LUPA",, )




      aGet[ 10 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 17 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )

      if uFieldEmpresa( "nCifRut" ) == 1





      aGet[ 16 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],,, {||    ( CheckCif( aGet[ 16 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 17 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )

      else






      aGet[ 16 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],, "@R 999999999-9", {||    ( CheckRut( aGet[ 16 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 17 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )

      end






      aGet[ 11 ] := TGetHlp():ReDefine( 183, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 17 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 11 ], Rtrim( aTmp[ 12 ] ) + Space( 1 ) + Rtrim( aTmp[ 13 ] ) )}, nil, "gc_earth_lupa_16",, )




      aGet[ 15] := TGetHlp():ReDefine( 184, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 17 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 12] := TGetHlp():ReDefine( 185, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 17 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 13] := TGetHlp():ReDefine( 186, { | u | If( PCount()==0, aTmp[13], aTmp[13]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 17 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




       aGet[ 89] := TGetHlp():ReDefine( 187, { | u | If( PCount()==0, aTmp[89], aTmp[89]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 17 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





       oRieCli := TGetHlp():ReDefine( 182, { | u | If( PCount()==0, nRieCli, nRieCli:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      oGetTarifa         := comboTarifa():Build( { "idCombo" => 171, "uValue" => aTmp[ 19 ] } )
      oGetTarifa:Resource( oFld:aDialogs[1] )
      oGetTarifa:setWhen( {|| nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) } )







      oBtnPrecio := TBtnBmp():ReDefine( 174, "gc_arrow_down_16",,,,, {|Self|( ChangeTarifaCabecera( oGetTarifa:getTarifa(), dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1], .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )}, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )











      aGet[ 94 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 94 ], aTmp[ 94 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwBncCli( aGet[ 94 ], aGet[ 95 ], aGet[ 96 ], aGet[ 97 ], aGet[ 98 ], aGet[ 99 ], aGet[ 100 ], aTmp[ 7 ] ) )}, nil, "LUPA",, )







       aGet[ 95 ] := TGetHlp():ReDefine( 305, { | u | If( PCount()==0, aTmp[ 95 ], aTmp[ 95 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( lIbanDigit( aTmp[ 95 ], aTmp[ 97 ], aTmp[ 98 ], aTmp[ 99 ], aTmp[ 100 ], aGet[ 96 ] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






       aGet[ 96 ] := TGetHlp():ReDefine( 306, { | u | If( PCount()==0, aTmp[ 96 ], aTmp[ 96 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lIbanDigit( aTmp[ 95 ], aTmp[ 97 ], aTmp[ 98 ], aTmp[ 99 ], aTmp[ 100 ], aGet[ 96 ] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







       aGet[ 97 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, aTmp[ 97 ], aTmp[ 97 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 97 ], aTmp[ 98 ], aTmp[ 99 ], aTmp[ 100 ], aGet[ 99 ], aTmp[ 95 ] ), aGet[ 95 ]:lValid() )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







       aGet[ 98 ] := TGetHlp():ReDefine( 302, { | u | If( PCount()==0, aTmp[ 98 ], aTmp[ 98 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 97 ], aTmp[ 98 ], aTmp[ 99 ], aTmp[ 100 ], aGet[ 99 ], aTmp[ 95 ] ), aGet[ 95 ]:lValid() )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







       aGet[ 99 ] := TGetHlp():ReDefine( 303, { | u | If( PCount()==0, aTmp[ 99 ], aTmp[ 99 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 97 ], aTmp[ 98 ], aTmp[ 99 ], aTmp[ 100 ], aGet[ 99 ], aTmp[ 95 ] ), aGet[ 95 ]:lValid() )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








       aGet[ 100 ] := TGetHlp():ReDefine( 304, { | u | If( PCount()==0, aTmp[ 100 ], aTmp[ 100 ]:= u ) }, oFld:aDialogs[1],, "9999999999", {||    (  lCalcDC( aTmp[ 97 ], aTmp[ 98 ], aTmp[ 99 ], aTmp[ 100 ], aGet[ 99 ], aTmp[ 95 ] ), aGet[ 95 ]:lValid() )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )












       aGet[ 60 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 60 ], aTmp[ 60 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivOut( aGet[ 60 ], oBmpDiv, aTmp[ 61 ], @cPouDiv, @nDouDiv, @cPorDiv, @nRouDiv, @cPpvDiv, @nDpvDiv, oGetMasDiv, dbfDiv, oBandera ) )},,,,,, .F., {||     ( nMode == 1 .AND. ( dbfTmpLin )->( LastRec() ) == 0 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 60 ], oBmpDiv, aTmp[ 61 ], dbfDiv, oBandera )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 191, "BAN_EURO",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )





      aGet[ 61 ] := TGetHlp():ReDefine( 192, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.9999",,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





       aGet[ 78 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSay[ 11 ]:cText( UsuariosModel():getNombreWhereCodigo( aTmp[ 78 ] ) ), .T.  )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




       oSay[ 11 ] := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, cSay[ 11 ], cSay[ 11 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








       aGet[ 58] := TCheckBox():ReDefine( 200, { | u | If( PCount()==0, aTmp[58], aTmp[58]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( ( dbfTmpLin )->( LastRec() ) == 0 )}, .F. )











       aGet[ 22] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[22], aTmp[22]:= u ) }, oFld:aDialogs[1],,, {||    ( cTarifa( aGet[ 22], oSay[ 5 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. oUser():lAdministrador() )},, .F., .F.,,,,, {|Self|( BrwTarifa( aGet[ 22], oSay[ 5 ] ) )}, nil, "LUPA",, )




       oSay[ 5 ] := TGetHlp():ReDefine( 211, { | u | If( PCount()==0, cSay[ 5 ], cSay[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )











        aGet[ 23] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[23], aTmp[23]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[ 23], oSay[ 7 ], aTmp[7] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwObras( aGet[ 23], oSay[ 7 ], aTmp[7], dbfObrasT ) )}, nil, "LUPA",, )




       oSay[ 7 ] := TGetHlp():ReDefine( 221, { | u | If( PCount()==0, cSay[ 7 ], cSay[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )











        aGet[ 8 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[ 8 ], , oSay[ 2 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 8 ], oSay[ 2 ] ) )}, nil, "LUPA",, )






       oSay[ 2 ] := TGetHlp():ReDefine( 231, { | u | If( PCount()==0, cSay[ 2 ], cSay[ 2 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ExpAlmacen( aTmp[ 8 ], dbfTmpLin, oBrwLin ) )}, nil, "Bot",, )












       aGet[ 34 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cFPago( aGet[ 34 ], dbfFPago, oSay[ 4 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ 34 ], oSay[ 4 ] ) )}, nil, "LUPA",, )





       oSay[ 4 ] := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cSay[ 4 ], cSay[ 4 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )











       aGet[ 20 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],,, {||    ( LoadAgente( aGet[ 20], dbfAgent, oSay[ 3 ], aGet[ 24], dbfAgeCom, dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 20], oSay[ 3 ] ) )}, nil, "LUPA",, )






      oSay[ 3 ] := TGetHlp():ReDefine( 251, { | u | If( PCount()==0, cSay[ 3 ], cSay[ 3 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( !empty( aTmp[ 20 ] ) .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( changeAgentPercentageInAllLines( aTmp[ 24 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, nil, "Bot",, )







      aGet[ 24 ] := TGetHlp():ReDefine( 252, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( validateAgentPercentage( aGet[ 24 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( !empty( aTmp[ 20 ] ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      oGetAge := TGetHlp():ReDefine( 253, { | u | If( PCount()==0, nTotAge, nTotAge:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )












        aGet[ 21] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[1],,, {||    ( cRuta( aGet[ 21], dbfRuta, oSay[ 8 ] ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[ 21 ], dbfRuta, oSay[ 8 ] ) )}, nil, "LUPA",, )




       oSay[ 8 ] := TGetHlp():ReDefine( 261, { | u | If( PCount()==0, cSay[ 8 ], cSay[ 8 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )









        TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )






        TButton():ReDefine( 502, {||( WinDelRec( oBrwLin, dbfTmpLin, {|| DelDeta() }, {|| RecalculaTotal( aTmp ) } ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )



        TButton():ReDefine( 503, {||( WinZooRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nMode, aTmp ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





          TButton():ReDefine( 515, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .T. ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





          TButton():ReDefine( 524, {||( LineUp( dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 525, {||( LineDown( dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )




      oBtnKit := TButton():ReDefine( 526, {||( ShowKit( D():FacturasRectificativas( nView ), dbfTmpLin, oBrwLin, .T. ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )




        TButton():ReDefine( 527, {||( importarArticulosScaner() )}, oFld:aDialogs[1],,, .F.,,,, .F. )





      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      oBrwLin:bClrStd         := {|| { if( ( dbfTmpLin )->lKitChl, 8421504, 0 ), GetSysColor( 5 ) } }

      oBrwLin:cAlias          := dbfTmpLin

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:lFooter           := .T.
      oBrwLin:cName           := "Rectificativa.Detalle"

      oBrwLin:CreateFromResource( 1 )

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Oferta"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpLin )->lLinOfe }
         :nWidth              := 20
         :lHide               := .T.
         :SetCheck( { "gc_star2_16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Número"
         :bEditValue          := {|| ( dbfTmpLin )->nNumLin }
         :cEditPicture        := "9999"
         :nWidth              := 52
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide                     := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Posición"
         :cSortOrder          := "nPosPrint"
         :bEditValue          := {|| ( dbfTmpLin )->nPosPrint }
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | if( !empty( oCol ), oCol:SetOrder(), ) }
         :cEditPicture        := "9999"
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código"
         :bEditValue          := {|| ( dbfTmpLin )->cRef }
         :nWidth              := 50
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "C. Barras"
         :bEditValue          := {|| cCodigoBarrasDefecto( ( dbfTmpLin )->cRef, dbfCodeBar ) }
         :nWidth              := 100
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| Descrip( dbfTmpLin ) }
         :nWidth              := 254
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr1 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Valor prop. 1"
         :bEditValue          := {|| nombrePropiedad( ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cValPr1, nView ) }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr2 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Valor prop. 2"
         :bEditValue          := {|| nombrePropiedad( ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr2, nView ) }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Lote"
         :bEditValue          := {|| ( dbfTmpLin )->cLote }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Caducidad"
         :bEditValue          := {|| Dtoc( ( dbfTmpLin )->dFecCad ) }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Bultos"
         :bEditValue          := {|| ( dbfTmpLin )->nBultos }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreCajas()
         :bEditValue          := {|| ( dbfTmpLin )->nCanEnt }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| nTotNFacRec( dbfTmpLin ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Unidad de medición"
         :bEditValue          := {|| ( dbfTmpLin )->cUnidad }
         :nWidth              := 100
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Peso"
         :bEditValue          := {|| ( dbfTmpLin )->nPesokg }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "T. Peso"
         :bEditValue          := {|| ( nTotNFacRec( dbfTmpLin ) * ( dbfTmpLin )->nPesokg ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Alm."
         :bEditValue          := {|| ( dbfTmpLin )->cAlmLin }
         :nWidth              := 40
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| nTotUFacRec( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Dto."
         :bEditValue          := {|| ( dbfTmpLin )->nDto }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Dto. Lin."
         :bEditValue          := {|| nDtoUFacRec( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Prm."
         :bEditValue          := {|| ( dbfTmpLin )->nDtoPrm }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Age"
         :bEditValue          := {|| ( dbfTmpLin )->nComAge }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ( dbfTmpLin )->nIva }
         :cEditPicture        := "@E 999.9"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Portes"
         :bEditValue          := {|| nTrnUFacRec( dbfTmpLin, nDpvDiv ) }
         :cEditPicture        := cPpvDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "P. verde"
         :bEditValue          := {|| nPntUFacRec( dbfTmpLin, nDpvDiv ) }
         :cEditPicture        := cPpvDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nTotLFacRec( dbfTmpLin, nDouDiv, nRouDiv, nil, .T., aTmp[ 101 ], .T. ) }
         :cEditPicture        := cPorDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Fecha"
         :bEditValue          := {|| Dtoc( ( dbfTmpLin )->dFecha ) }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader          := "No imp."
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( dbfTmpLin )->lImpLin }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader          := "Centro de coste"
         :bEditValue       := {|| ( dbfTmpLin )->cCtrCoste }
         :nWidth           := 20
         :lHide            := .T.
      end

      if nMode <> 3
         oBrwLin:bLDblClick  := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
      end









     aGet[ 41 ] := TGetHlp():ReDefine( 299, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








     aGet[ 42 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




     aGet[ 43 ] := TGetHlp():ReDefine( 309, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








        aGet[ 44 ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )










        aGet[ 45 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








        aGet[ 46 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






        aGet[ 47 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








        aGet[ 48 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 86 ] := TGetHlp():ReDefine( 411, { | u | If( PCount()==0, aTmp[ 86 ], aTmp[ 86 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 37 ] := TGetHlp():ReDefine( 412, { | u | If( PCount()==0, aTmp[ 37 ], aTmp[ 37 ]:= u ) }, oFld:aDialogs[1],, "@E 99.9", {||    ( lTiva( dbfIva, aTmp[ 37 ] ) .AND. RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 37 ], dbfIva, , .T. ) )}, nil, "LUPA",, )







      aGet[ 38 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[1],, cPorDiv, {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )





      oBrwIva                        := IXBrowse():New( oFld:aDialogs[1] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva, , , .F. )

      oBrwIva:nMarqueeStyle          := 6
      oBrwIva:lRecordSelector        := .F.
      oBrwIva:lHScroll               := .F.

      oBrwIva:CreateFromResource( 370 )

      with object ( oBrwIva:AddCol() )
         :cHeader          := "Base"
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "neto" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "neto" ) <> 0 ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "neto" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "%" + cImp()
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) <> nil ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ), "@E 999.99" ), "" ), "" ) }
         :bEditValue       := {|| hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) }
         :nWidth           := 44
         :cEditPicture     := "@E 999.99"
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFootStrAlign    := 1
         :nEditType        := 1
         :bEditWhen        := {|| !IsNil( hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) ) }
         :bOnPostEdit      := {|o,x| EdtIva( o, x, hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ), dbfTmpLin, dbfIva, oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := cImp()
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "impiva" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "impiva" ) <> nil ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "impiva" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "% R.E."
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ) <> nil .AND. aTmp[ 56 ] ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ), cPicReq() ), "" ), "" ) }
         :nWidth           := 44
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "R.E."
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "impre" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "impre" ) <> nil .AND. aTmp[ 56 ] ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "impre" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end








      oGetNet := TSay():ReDefine( 401, {|| nTotNet}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetTrn := TSay():ReDefine( 402, {|| nTotTrn}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetIva := TSay():ReDefine( 405, {|| nTotIva}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      aGet[ 56 ] := TCheckBox():ReDefine( 406, { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||     ( nMode <> 3 )}, .F. )



      oGetReq := TSay():ReDefine( 407, {|| nTotReq}, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      oImpuestos := TCheckBox():ReDefine( 709, { | u | If( PCount()==0, lImpuestos, lImpuestos:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( .T. )}, .F. )




      oGetTotal := TSay():ReDefine( 485, {|| nTotFac}, oFld:aDialogs[1],,,, .F., oFont, .F., .F., )





      aGet[ 101 ] := TCheckBox():ReDefine( 409, { | u | If( PCount()==0, aTmp[ 101 ], aTmp[ 101 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ), oBrwLin:Refresh() )},,,,, .F., {||     ( nMode <> 3 )}, .F. )



      oGetTotPnt := TSay():ReDefine( 404, {|| nTotPnt}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetTotIvm := TSay():ReDefine( 403, {|| nTotIvm}, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      oGetMasDiv := TSay():ReDefine( 488, {|| cGetMasDiv}, oFld:aDialogs[1],,,, .F., oFont, .F., .F., )










      aGet[ 1 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[1] >= "A" .AND. aTmp[1] <= "Z" )}, "N/W*",,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[ 1 ] ) )}, {||  ( DwSerie( aGet[ 1 ] ) )},,,, nil,,, )

         aGet[ 1 ]:bLostFocus := {|| aGet[ 66 ]:cText( cProCnt( aTmp[ 1 ] ) ) }





        aGet[ 2] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





        aGet[ 3] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],, "@!",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      aGet[ 6 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ 6 ]:cText( Calendario( aTmp[ 6 ] ) )}, nil,,, )








          aGet[ 103 ] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[ 103 ], aTmp[ 103 ]:= u ) }, oFld:aDialogs[1],, "@R 99:99:99", {||    ( iif(   !validTime( aTmp[ 103 ] ), ( msgStop( "El formato de la hora no es correcto" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







       aGet[ 39 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[ 1 ],,, {||    ( cFacCli( aGet, aTmp, oBrwLin, oBrwIva, nMode ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .F.,,,,, {|Self|( browseFacturasClientes( aGet[ 39 ], aGet[ 58 ], nView ) )}, nil, "LUPA",, )









      aGet[ 87 ] := TComboBox():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 87 ], aTmp[ 87 ]:= u ) }, {       "01. Número factura", "02. Serie factura", "03. Fecha expedición", "04. Nombre y apellidos / Razón social del emisor", "05. Nombre y apellidos / Razón social del receptor", "06. Identificación fiscal del emisor obligatoria", "07. Identificación fiscal del receptor", "08. Domicilio emisor obligatorio", "09. Domicilio receptor", "10. Detalle operación", "11. Porcentaje impositivo a aplicar", "12. Cuota tributaria a aplicar", "13. Fecha / Periodo a aplicar", "14. Clase de factura", "15. Literales legales", "16. Base imponible", "80. Cálculo de cuotas repercutidas", "81. Cálculo de cuotas retenidas", "82. Base imponible modificada por devolución de envases / embalajes", "83. Base imponible modificada por descuentos y bonificaciones", "84. Base imponible modificada por resolución firme, judicial o administrativa", "85. Base imponible modificada cuotas repercutidas no satisfechas. Auto de declaración de concurso" }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 87 ]",,,,,,, )





      aGet[ 88 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 88 ], aTmp[ 88 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




          aGet[ 85 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 85 ], aTmp[ 85 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




          oSay[ 12 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSay[ 12 ], cSay[ 12 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )












        aGet[ 72 ] := TGetHlp():ReDefine( 235, { | u | If( PCount()==0, aTmp[ 72 ], aTmp[ 72 ]:= u ) }, oFld:aDialogs[2],,, {||    ( LoadTrans( aTmp, aGet[ 72 ], aGet[ 73 ], oSay[ 9 ] ) )}, "N/W*",,,,, .F., {||      ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oTrans:Buscar( aGet[ 72 ] ), .T. )}, nil, "LUPA",, )





          oSay[ 9 ] := TGetHlp():ReDefine( 236, { | u | If( PCount()==0, cSay[ 9 ], cSay[ 9 ]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )





          aGet[ 73 ] := TGetHlp():ReDefine( 237, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )











          aGet[ 9 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[2],,, {||    cCajas( aGet[ 9 ], dbfCajT, oSay[ 10 ] )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 9 ], oSay[ 10 ] ) )}, nil, "LUPA",, )




          oSay[ 10 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cSay[ 10 ], cSay[ 10 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









          aGet[ 66] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[66], aTmp[66]:= u ) }, oFld:aDialogs[2],, "@R ###.######", {||    ( ChkProyecto( aTmp[66], oSay[ 6 ] ), .T. )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProyecto( aGet[ 66], oSay[ 6 ] ) )}, nil, "LUPA",, )




        oSay[ 6 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, cSay[ 6 ], cSay[ 6 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








        aGet[ 104 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 104 ], aTmp[ 104 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oCentroCoste:Existe( aGet[ 104 ], aGet[ 104 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 104 ] ) )}, nil, "LUPA",, 191 )






          aGet[ 35 ] := TGetHlp():ReDefine( 128, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[2],, "99999",,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






          aGet[ 29 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[2],, "@!",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )











      aGet[ 28 ] := TGetHlp():ReDefine( 162, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ 28]:cText( Calendario( aTmp[28] ) )}, nil,,, )





      aGet[ 62] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[62], aTmp[62]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 63] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, aTmp[63], aTmp[63]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 31] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[31], aTmp[31]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 82 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 82 ], aTmp[ 82 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 83 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 83 ], aTmp[ 83 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 84 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 84 ], aTmp[ 84 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 32] := TMultiGet():ReDefine( 240, { | u | If( PCount()==0, aTmp[32], aTmp[32]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, .F.,, )













      aGet[ 65 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[2],, { 410, 411, 412, 413 }, {||( lChangeRegIva( aTmp ) )},,,, .F., {||     ( nMode <> 3 )}, )






      oBrwPgo                 := IXBrowse():New( oFld:aDialogs[2] )

      oBrwPgo:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwPgo:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwPgo:cAlias          := dbfTmpPgo
      oBrwPgo:cName           := "Factura rectificativa.Pagos"

      oBrwPgo:nMarqueeStyle   := 6

      oBrwPgo:CreateFromResource( 260 )

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Cr. Sesión cerrada"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpPgo )->lCloPgo }
         :nWidth              := 20
         :lHide               := .T.
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Co. Cobrado"
         :bStrData            := {|| "" }
         :bBmpData            := {|| nEstadoRecibo( dbfTmpPgo ) }
         :nWidth              := 20
         :AddResource( "Cnt16" )
         :AddResource( "Sel16" )
         :AddResource( "gc_undo_16" )
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Contabilizado"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpPgo )->lConPgo }
         :nWidth              := 70
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Sesión"
         :bEditValue          := {|| Rtrim( ( dbfTmpPgo )->cTurRec ) }
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Expedido"
         :bEditValue          := {|| DtoC( ( dbfTmpPgo )->dPreCob ) }
         :nWidth              := 76
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Cobro"
         :bEditValue          := {|| DtoC( ( dbfTmpPgo )->dEntrada ) }
         :nWidth              := 76
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| ( dbfTmpPgo )->cDescrip }
         :nWidth              := 190
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Div."
         :bEditValue          := {|| cSimDiv( ( dbfTmpPgo )->cDivPgo, dbfDiv ) }
         :nWidth              := 30
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwPgo:AddCol() )
         :cHeader             := "Importe"
         :bEditValue          := {|| ( dbfTmpPgo )->nImporte }
         :cEditPicture        := cPorDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      if nMode == 2
         oBrwPgo:bLDblClick   := {|| ExtEdtRecCli( dbfTmpPgo, nView, .T., oCtaRem, oCentroCoste ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) }
      end





      TButton():ReDefine( 501, {||( ExtEdtRecCli( dbfTmpPgo, nView, .T., oCtaRem, oCentroCoste ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 502, {||( ExtDelRecCli( dbfTmpPgo ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 506, {||( VisRecCli( ( dbfTmpPgo )->cSerie + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ) + ( dbfTmpPgo )->cTipRec, .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 505, {||( PrnRecCli( ( dbfTmpPgo )->cSerie + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ) + ( dbfTmpPgo )->cTipRec, .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )



      oSayGetRnt := TSay():ReDefine( 800,, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetRnt := TGetHlp():ReDefine( 408, { | u | If( PCount()==0, nTotRnt, nTotRnt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )








      oGetTotPg := TSay():ReDefine( 455, {|| nTotFac}, oFld:aDialogs[2],,,, .F.,, .F., .F., )



      oGetPag := TSay():ReDefine( 460, {|| 0}, oFld:aDialogs[2],,,, .F.,, .F., .F., )



      oGetPdt := TSay():ReDefine( 480, {|| 0}, oFld:aDialogs[2],,,, .F.,, .F., .F., )





      oGetPes := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, nTotPes, nTotPes:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oGetDif := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, nTotDif, nTotDif:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 6
      oBrwInc:cName           := "Factura rectificativa.Incidencia"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 64
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 450
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         else
            oBrwInc:bLDblClick   := {|| WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )




      oBrwDoc                 := IXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 6
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

      with object ( oBrwDoc:AddCol() )
         :cHeader          := "Documento"
         :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
         :nWidth           := 900
      end

      if nMode <> 3
         oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
      end

      oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )






      oBrwEst                 := IXBrowse():New( oFld:aDialogs[ 5 ] )

      oBrwEst:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwEst:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwEst:cAlias          := dbfTmpEst

      oBrwEst:nMarqueeStyle   := 6
      oBrwEst:cName           := "Factura rectificativa de cliente.Situaciones"

         with object ( oBrwEst:AddCol() )
            :cHeader          := "Nombre"
            :bEditValue       := {|| ( dbfTmpEst )->cSitua }
            :nWidth           := 140
         end

         with object ( oBrwEst:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpEst )->dFecSit ) }
            :nWidth           := 90
             :nDataStrAlign    := 1
             :nHeadStrAlign    := 1
         end

         with object ( oBrwEst:AddCol() )
            :cHeader          := "Hora"
            :bEditValue       := {|| trans( ( dbfTmpEst )->tFecSit, "@R 99:99:99" ) }
            :nWidth           := 90
         end

         if nMode <> 3
            oBrwEst:bLDblClick   := {|| WinEdtRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) }
         end

         oBrwEst:CreateFromResource( 210 )





    TButton():ReDefine( 500, {||( WinAppRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) )}, oFld:aDialogs[ 5 ],,, .F., {||     ( nMode <> 3 )},,, .F. )






    TButton():ReDefine( 501, {||( WinEdtRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) )}, oFld:aDialogs[ 5 ],,, .F., {||     ( nMode <> 3 )},,, .F. )






    TButton():ReDefine( 502, {||( WinDelRec( oBrwEst, dbfTmpEst ) )}, oFld:aDialogs[ 5 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





    TButton():ReDefine( 503, {||( WinZooRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) )}, oFld:aDialogs[ 5 ],,, .F.,,,, .F. )












      TButton():ReDefine( 3, {||( RecFacRec( aTmp ), oBrwLin:Refresh(), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 4, {||( if( EndTrans( aTmp, aGet, oBrw, oBrwLin, oBrwPgo, aNumAlb, nMode, oDlg, oFld ), GenFacRec( 1 ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, oBrw, oBrwLin, oBrwPgo, aNumAlb, nMode, oDlg, oFld ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( If( ExitNoSave( nMode, dbfTmpLin ), oDlg:end(), ) )}, oDlg,,, .F.,,,, .T. )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 3 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 4 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 5 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 6 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 8 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 9 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )









      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgFacRec.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )





   if nMode <> 3

      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp, .F., nMode ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| WinDelRec( oBrwLin, dbfTmpLin, {|| DelDeta() }, {|| RecalculaTotal( aTmp ) } ) } )

      oFld:aDialogs[2]:AddFastKey( 114, {|| ExtEdtRecCli( dbfTmpPgo, nView, .T., oCtaRem, oCentroCoste ), RecalculaTotal( aTmp ) } )
      oFld:aDialogs[2]:AddFastKey( 115, {|| ExtDelRecCli( dbfTmpPgo ), RecalculaTotal( aTmp ) } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| WinDelRec( oBrwInc, dbfTmpInc ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| WinDelRec( oBrwDoc, dbfTmpDoc ) } )

      oDlg:AddFastKey( 65,                {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )
      oDlg:AddFastKey( 116,             {|| EndTrans( aTmp, aGet, oBrw, oBrwLin, oBrwPgo, aNumAlb, nMode, oDlg, oFld ) } )
      oDlg:AddFastKey( 117,             {|| if( EndTrans( aTmp, aGet, oBrw, oBrwLin, oBrwPgo, aNumAlb, nMode, oDlg, oFld ), GenFacRec( 1 ), ) } )
      oDlg:AddFastKey( 120,             {|| oDetCamposExtra:Play( space(1) ) } )

   end

   oDlg:AddFastKey( 112, {|| ChmHelp( "Facturas_rectificativa" ) } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 78 ] ), , oDlg:End() ), aGet[ 72 ]:lValid() }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 78 ] ), AppDeta( oBrwLin, bEdtDet, aTmp, .F., cCodArt ), oDlg:End() ), aGet[ 72 ]:lValid() }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, .F., cCodArt ), aGet[ 72 ]:lValid() }

      otherwise

         oDlg:bStart := {|| StartEdtRec( aGet, nMode ),    ShowKit( D():FacturasRectificativas( nView ), dbfTmpLin, oBrwLin, .F., dbfTmpInc, aTmp[ 7 ], D():Clientes( nView ), nil, aGet, oSayGetRnt ), aGet[ 72 ]:lValid() }
   end




   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|(  RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(   initEdtRec( cCodCli, aGet, aTmp, oDlg, oBrwLin, oBrwPgo, oBrwInc, oSayGetRnt, oGetRnt ) )}, oDlg:bRClicked,,, )

   EndEdtRecMenu()

   oFont:end()

   oBmpEmp:end()

   oBmpDiv:end()

   oBmpGeneral:End()





   ( D():FacturasRectificativas( nView ) )->( ordSetFocus( nOrd ) )

   oBrwLin:CloseData()





   KillTrans( oBrwLin, oBrwInc, oBrwPgo )

RETURN ( oDlg:nResult == 1 )



Static Function StartEdtRec( aGet, nMode )

   if nMode <> 1

        if !empty( aGet[ 104 ] )
            aGet[ 104 ]:lValid()
        endif

   end

Return ( nil )



Static Function initEdtRec( cCodCli, aGet, aTmp, oDlg, oBrwLin, oBrwPgo, oBrwInc, oSayGetRnt, oGetRnt )

   if !empty( cCodCli )
      aGet[ 7 ]:lValid()
   endif

   EdtRecMenu( aTmp, oDlg )
   SetDialog( oSayGetRnt, oGetRnt )

   oBrwLin:MakeTotals()

   oBrwLin:Load()
   oBrwPgo:Load()
   oBrwInc:Load()

return( .T. )



STATIC FUNCTION SetDialog( oSayGetRnt, oGetRnt )

   if RolesModel():getRolNoMostrarRentabilidad( Auth():rolUuid() )

      if !empty( oSayGetRnt )
         oSayGetRnt:Hide()
      end

      if !empty( oGetRnt )
         oGetRnt:Hide()
      end

   end

Return .T.







STATIC FUNCTION EdtDet( aTmp, aGet, dbfFacRecL, oBrw, lTotLin, cCodArtEnt, nMode, aTmpFac )

    local oDlg
   local oFld
   local oBtn
   local oSayPr1
   local oSayPr2
   local cSayPr1  := ""
   local cSayPr2  := ""
   local oSayVp1
   local oSayVp2
   local cSayVp1  := ""
   local cSayVp2  := ""
   local oSayAlm
   local cSayAlm  := ""
   local bmpImage
   local oStkAct
   local nStkAct  := 0
   local oBtnSer
   local oSayGrp
   local cSayGrp  := ""
   local oSayFam
   local cSayFam  := ""
   local cCodArt  := Padr( aTmp[ 4 ], 32 )

   cGetCelda      := Space(20)

   cTipoCtrCoste  := alltrim( aTmp[ 86 ] )

   do case
   case nMode == 1
      aTmp[ 12  ] := 1
      aTmp[ 20   ] := GetSysDate()
      aTmp[ 1  ] := aTmpFac[ 1  ]
      aTmp[ 2 ] := aTmpFac[ 2 ]
      aTmp[ 25  ] := lTotLin
      aTmp[ 38  ] := aTmpFac[ 8 ]
      aTmp[ 39  ] := aTmpFac[ 58 ]
      aTmp[ 71  ] := oGetTarifa:getTarifa()
      aTmp[ 75 ] := aTmpFac[ 6 ]
      aTmp[ 78 ] := aTmpFac[ 103 ]
      if !empty( cCodArtEnt )
         cCodArt        := Padr( cCodArtEnt, 32 )
      end

      aTmp[ 82 ]  := aTmpFac[ 23 ]

      cTipoCtrCoste     := "Centro de coste"

   case nMode == 2
      aTmp[ 6 ] := Round( aTmp[ 6 ], nDouDiv )
      aTmp[ 7  ] := Round( aTmp[ 7  ], nDpvDiv )
      aTmp[ 32  ] := Round( aTmp[ 32  ], nDouDiv )
      lTotLin           := aTmp[ 25 ]

   case nMode == 5
      aTmp[ 32  ] := Round( aTmp[ 32  ], nDouDiv )
      lTotLin           := aTmp[ 25 ]

   end





   cOldCodArt           := aTmp[ 4 ]
   cOldPrpArt           := aTmp[ 27 ] + aTmp[ 28 ] + aTmp[ 29 ] + aTmp[ 30 ]
   cOldUndMed           := aTmp[ 16 ]



   if nMode <> 1
      cSayGrp           := RetFld( aTmp[ 54  ], oGrpFam:GetAlias() )
      cSayFam           := RetFld( aTmp[ 53 ], dbfFamilia )
   end





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "lineas de facturas rectificativas de clientes", "LFacCli",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



      oFld := TFolder():ReDefine( 400, {"&General",    "Da&tos",    "&Observaciones", "&Centro coste"}, { "LFacCli_1","LFacCli_7","LFacCli_3","LCTRCOSTE" }, oDlg,,,,, .F., )







      aGet[ 4] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oFld:aDialogs[1],,, {||    ( loaArt( cCodArt, aGet, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[ 4 ], aGet[ 5 ] , , , , aGet[ 44 ], aTmp[ 27 ], aTmp[ 28 ], aGet[ 29 ], aGet[ 30 ], aGet[ 45 ], if( uFieldEmpresa( "lStockAlm" ), aTmp[ 38 ], nil ) ) )}, nil, "LUPA",, )





        aGet[ 5 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( ( lModDes() .OR. empty( aTmp[ 5 ] ) ) .AND. nMode <> 3 .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 22] := TMultiGet():ReDefine( 111, { | u | If( PCount()==0, aTmp[22], aTmp[22]:= u ) }, oFld:aDialogs[1],, "N/W*",,,,, .F., {||     ( ( lModDes() .OR. empty( aTmp[ 22 ] ) ) .AND. nMode <> 3 .AND. nMode <> 5 )}, .F.,, )











      aGet[ 44 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 113, )

          aGet[ 44 ]:bValid   := {|| lValidLote( aTmp, aGet, oStkAct ) }






      aGet[ 45 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 341, )



      oBrwProperties                       := IXBrowse():New( oFld:aDialogs[1] )

      oBrwProperties:nDataType             := 2

      oBrwProperties:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwProperties:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwProperties:lHScroll              := .T.
      oBrwProperties:lVScroll              := .T.

      oBrwProperties:nMarqueeStyle         := 3
      oBrwProperties:lRecordSelector       := .F.
      oBrwProperties:lFastEdit             := .T.
      oBrwProperties:nFreeze               := 1
      oBrwProperties:lFooter               := .T.

      oBrwProperties:SetArray( {}, .F., 0, .F. )

      oBrwProperties:MakeTotals()

      oBrwProperties:CreateFromResource( 500 )





      oGetCelda := TGetHlp():ReDefine( 183, { | u | If( PCount()==0, cGetCelda, cGetCelda:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,, 184, )

      oGetCelda:bValid              := {|| SearchProperty( oGetCelda, oBrwProperties ), .T. }










      aGet[ 29 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[ 29 ], oSayVp1, aTmp[ 27 ], D():PropiedadesLineas( nView ) ), loaArt( cCodArt, aGet, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 29 ], oSayVp1, aTmp[ 27 ] ) )}, nil, "LUPA",, )

         aGet[ 29 ]:bChange            := {|| aGet[ 29 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ], oStkAct ), .T. ) }



      oSayPr1 := TSay():ReDefine( 271, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      oSayVp1 := TGetHlp():ReDefine( 272, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 30 ] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[ 30 ], oSayVp2, aTmp[ 28 ], D():PropiedadesLineas( nView ) ), loaArt( cCodArt, aGet, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 30 ], oSayVp2, aTmp[ 28 ] ) )}, nil, "LUPA",, )

         aGet[ 30 ]:bChange   := {|| aGet[ 30 ]:Assign(), if( !uFieldEmpresa( "lNStkAct" ), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ], oStkAct ), .T. ) }



      oSayPr2 := TSay():ReDefine( 281, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      oSayVp2 := TGetHlp():ReDefine( 282, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 8 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 351, )










      aGet[ 11 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 11 ], @aTmp[ 55 ] ) )},,,,,, .F., {||     ( lModIva() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 11 ], dbfIva, , .T. ) )}, nil, "LUPA",, )









      aGet[ 41 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( uFieldEmpresa( "lModImp" ) .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,, {|Self|( oNewImp:nBrwImp( aGet[ 41 ] ) )}, nil,, 126, )













      aGet[ 76 ] := TGetHlp():ReDefine( 450, { | u | If( PCount()==0, aTmp[ 76 ], aTmp[ 76 ]:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     ( uFieldEmpresa( "lUseBultos" ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,, 451, )









        aGet[ 12] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac ), loaArt( cCodArt, aGet, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. lUseCaj() .AND. !lTotLin .AND. nMode <> 5 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ), loaArt( cCodArt, aGet, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 131, )









        aGet[ 18] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[18], aTmp[18]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac ), loaArt( cCodArt, aGet, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ), loaArt( cCodArt, aGet, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 141, )








      aGet[ 16 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oUndMedicion:Existe( aGet[ 16 ], aGet[ 16 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oUndMedicion:Buscar( aGet[ 16 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 171 )











      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 520, { | u | If( PCount()==0, aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 521, )

         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 531, )

         aGet[ ( dbfFacRecL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfFacRecL )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ ( dbfFacRecL )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( dbfFacRecL )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 541, )

         aGet[ ( dbfFacRecL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )








      aGet[ 6 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )












      aGet[ 71 ] := TGetHlp():ReDefine( 156, { | u | If( PCount()==0, aTmp[ 71 ], aTmp[ 71 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 71 ] >= 1 .AND. aTmp[ 71 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )}, {|nKey,nFlags,Self| (  changeTarifa( aTmp, aGet, aTmpFac ), loadComisionAgente( aTmp, aGet, aTmpFac ), lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,, {||      1}, {||      6},, nil,,, )

      aGet[ 6 ]:bHelp := {|| DesgPnt( cCodArt, aTmp, aTmp[ 71 ], aGet[ 6 ], aGet[ 36 ], nMode ), lCalcDeta( aTmp, aTmpFac ) }










      aGet[ 7] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],, cPpvDiv, {||    ( lCalcDeta( aTmp, aTmpFac ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,, 152, )





      aGet[ 31 ] := TGetHlp():ReDefine( 295, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 14 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 65 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 66 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 77 ] := TGetHlp():ReDefine( 460, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 74 ] := TCheckBox():ReDefine( 411, { | u | If( PCount()==0, aTmp[ 74 ], aTmp[ 74 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 15 ] := TGetHlp():ReDefine( 175, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. nMode <> 5 )},, .F., .F.,,,,,, nil,,, )











      aGet[ 32 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( aTmp[32] >= 0 )}, ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ),,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,, {||      0},,, nil,, 261, )









        aGet[ 9] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[9], aTmp[9]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )









        aGet[ 10] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[10], aTmp[10]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )








        aGet[ 17] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[17], aTmp[17]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac ) ) }, .F., .T.,,,,,, nil,,, )





      oComisionLinea := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, nComisionLinea, nComisionLinea:= u ) }, oFld:aDialogs[ 1 ],, cPorDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oTotalLinea := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nTotalLinea, nTotalLinea:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 51 ] := TGetHlp():ReDefine( 205, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oTipArt:existe( aGet[ 51 ], aGet[ 51 ]:oHelpText ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( oTipArt:Buscar( aGet[ 51 ] ) )}, nil, "LUPA",, 206 )












      aGet[ 38 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[ 38 ], , oSayAlm ), if( !uFieldEmpresa( "lNStkAct" ), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ], oStkAct ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 38], oSayAlm ) )}, nil, "LUPA",, )




      oSayAlm := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSayAlm, cSayAlm:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ 82 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 82 ], aTmp[ 82 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[ 82 ], aGet[ 82 ]:oHelpText, aTmpFac[ 7 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwObras( aGet[ 82 ], aGet[ 82 ]:oHelpText, aTmpFac[ 7 ], dbfObrasT ) )}, nil, "LUPA",, 331 )






      oStkAct := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, nStkAct, nStkAct:= u ) }, oFld:aDialogs[1],, cPicUnd,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ 36] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[36], aTmp[36]:= u ) }, oFld:aDialogs[1],, cPouDiv,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,, 321, )










      aGet[ 85] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[85], aTmp[85]:= u ) }, oFld:aDialogs[2],, "9999",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 26] := TCheckBox():ReDefine( 110, { | u | If( PCount()==0, aTmp[26], aTmp[26]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 20] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[20], aTmp[20]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .T.,,,,, {|Self|aGet[ 20]:cText( Calendario( aTmp[20] ) )}, nil,,, )




      aGet[ 13] := TCheckBox():ReDefine( 130, { | u | If( PCount()==0, aTmp[13], aTmp[13]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )






      aGet[ 37] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[37], aTmp[37]:= u ) }, oFld:aDialogs[2],, cPouDiv,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )







      aGet[ 59 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 59 ], aTmp[ 59 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( ChgBmp( aGet[ 59 ], bmpImage ) ) }, .F., .F.,,,,, {|Self|( GetBmp( aGet[ 59 ], bmpImage ) )}, nil, "LUPA",, )









      aGet[ 54 ] := TGetHlp():ReDefine( ( 150 ), { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( oSayGrp:cText( RetFld( aTmp[ 54  ], oGrpFam:GetAlias() ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oGrpFam:Buscar( aGet[ 54 ] ) )}, nil, "LUPA",, )




      oSayGrp := TGetHlp():ReDefine( ( 151 ), { | u | If( PCount()==0, cSayGrp, cSayGrp:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ 53 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 53 ], aTmp[ 53 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSayFam:cText( RetFld( aTmp[ 53  ], dbfFamilia ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFamilia( aGet[ 53 ], oSayFam ) )}, nil, "LUPA",, )




      oSayFam := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSayFam, cSayFam:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )








    aGet[ 57 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( cProvee( aGet[ 57 ], D():Proveedores( nView ), aGet[ 57 ]:oHelpText ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProvee( aGet[ 57 ], aGet[ 57 ]:oHelpText ) )}, nil, "LUPA",, 201 )




      aGet[ 47 ] := TCheckBox():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 48 ] := TCheckBox():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 35 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )






      aGet[ 75 ] := TGetHlp():ReDefine( 360, { | u | If( PCount()==0, aTmp[ 75 ], aTmp[ 75 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||      (nMode <> 3 .AND. !lTotLin )},, .F., .T.,,,,, {|Self|aGet [ 75 ]:cText( Calendario( aTmp[ 75 ] ) )}, nil,,, )








      aGet[ 78 ] := TGetHlp():ReDefine( 361, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[2],, "@R 99:99:99", {||     ( iif(    !validTime( aTmp[ 78 ] ),    ( msgStop( "El mensaje de la hora no es correcto" ), .F. ),    .T. ) )},,,,,, .F., {||      ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )





      aGet[ 56 ] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      aGet[ 72 ] := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 72 ], aTmp[ 72 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )












      aGet[ 79 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 79 ], aTmp[ 79 ]:= u ) }, oFld:aDialogs[ 4 ],,, {||    ( oCentroCoste:Existe( aGet[ 79 ], aGet[ 79 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 79 ] ) )}, nil, "LUPA",, 411 )






      oTipoCtrCoste := TComboBox():ReDefine( 140, { | u | If( PCount()==0, cTipoCtrCoste, cTipoCtrCoste:= u ) }, aTipoCtrCoste, oFld:aDialogs[4],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oTipoCtrCoste",,,,,,, )

         oTipoCtrCoste:bChange   := {|| clearGet( aGet[ 87 ] ), loadGet( aGet[ 87 ], cTipoCtrCoste ) }







      aGet[ 87 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 87 ], aTmp[ 87 ]:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 160 )





      bmpImage := TBitmap():ReDefine( 220,, ( cFileBitmap( cPatImg(), aTmp[ 59 ] ) ), oDlg,, { |nRow,nCol,nKeyFlags| ( bmpImage:lStretch := !bmpImage:lStretch, bmpImage:Refresh() ) }, .F., .F.,,, .F.,,, .F. )

         bmpImage:SetColor( , GetSysColor( 15 ) )





      oBtn := TButton():ReDefine( 1, {||SaveDeta( aTmp, aTmpFac, aGet, oFld, oBrw, oDlg, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, oTotalLinea, oStkAct, nStkAct, cCodArt, oBtn, oBtnSer )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( ChmHelp( "Añadir_v" ) )}, oDlg,,, .F.,,,, .F. )




      oBtnSer := TButton():ReDefine( 552, {||( EditarNumeroSerie( aTmp, oStock, nMode ) )}, oDlg,,, .F.,,,, .F. )



   if nMode <> 3
      if uFieldEmpresa( "lGetLot")
         oDlg:AddFastKey( 13,   {|| if( !Empty( aGet[ 4 ] ), aGet[ 4 ]:lValid(), ), oBtn:SetFocus(), oBtn:Click() } )
      end
         oDlg:AddFastKey( 116,             {|| oBtn:SetFocus(), oBtn:Click() } )
   end

   oDlg:AddFastKey( 117, {|| oBtnSer:Click() } )



   oDlg:bStart    := {|| SetDlgMode( aTmp, aGet, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, nMode, oTotalLinea, aTmpFac ), loadGet( aGet[ 87 ], cTipoCtrCoste ), aGet[ 87 ]:lValid(), aGet[ 57 ]:lValid(), aGet[ 82 ]:lValid() }




   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|( lCalcDeta( aTmp, aTmpFac ) )}, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

   if !empty( bmpImage )
      bmpImage:End()
   end

RETURN ( oDlg:nResult == 1 )






STATIC FUNCTION SetDlgMode( aTmp, aGet, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, nMode, oTotal, aTmpFac )

   local cCodArt        := Left( aGet[ 4 ]:VarGet(), 18 )

   if !uFieldEmpresa( "lUseBultos" )
      aGet[ 76 ]:Hide()
   else
      if !empty( aGet[ 76 ] )
         aGet[ 76 ]:SetText( uFieldempresa( "cNbrBultos" ) )
      end
   end

   if !lUseCaj()
      aGet[ 12 ]:Hide()
   else
      aGet[ 12 ]:SetText( cNombreCajas() )
   end

   aGet[ 18 ]:SetText( cNombreUnidades() )

   if aGet[ 41 ] <> nil
      if !uFieldEmpresa( "lUseImp" )
         aGet[ 41 ]:Hide()
         aGet[ 74 ]:Hide()
      else
         if !uFieldEmpresa( "lModImp" )
            aGet[ 41 ]:Disable()
         end
         if !uFieldEmpresa( "lIvaImpEsp" )
            aGet[ 74 ]:Disable()
         end
      end
   end

   if !uFieldEmpresa( "lUsePor" )
      aGet[ 8 ]:Hide()
   end

   if !uFieldEmpresa( "lUsePnt" ) .OR. !aTmpFac[ 101 ]
      aGet[ 7 ]:Hide()
   end

   if aGet[ 32 ] <> nil
      if !uFieldEmpresa( "lDtoLin" )
         aGet[ 32 ]:Hide()
      end
   end

   do case
   case nMode == 1

      aGet[ 4    ]:cText( Space( 200 ) )

      aTmp[ 39 ]  := aTmpFac[ 58 ]

      aGet[ 12 ]:cText( 1 )
      aGet[ 18]:cText( 1 )
      aTmp[ 34 ]  := nLastNum( dbfTmpLin )
      aGet[ 85]:cText( nLastNum( dbfTmpLin, "nPosPrint" ) )
      aGet[ 38 ]:cText( aTmpFac[ 8 ])

      aGet[ 5]:Show()
      aGet[ 22 ]:Hide()
      aGet[ 44   ]:Hide()
      aGet[ 45 ]:Hide()

      if aTmpFac[ 65 ] <= 2
      aGet[ 11    ]:cText( nIva( dbfIva, cDefIva() ) )
      end

      if !empty( oStkAct )

         if !uFieldEmpresa( "lNStkAct" )
            oStkAct:Show()
            oStkAct:cText( 0 )
         else
            oStkAct:Hide()
         end

      end

      aGet[ 79 ]:cText( aTmpFac[ 104 ] )

        if !empty( aGet[ 79 ] )
            aGet[ 79 ]:lValid()
        endif

      cTipoCtrCoste        := "Centro de coste"
      oTipoCtrCoste:Refresh()
      clearGet( aGet[ 87 ] )

   case ( nMode == 2 .OR. nMode == 3 )

      if aTmp[ 42   ]
         aGet[ 44   ]:Show()
         aGet[ 45 ]:Show()
      else
         aGet[ 44   ]:Hide()
         aGet[ 45 ]:Hide()
      end

      if !empty( cCodArt )

         aGet[ 5 ]:show()
         aGet[ 22  ]:hide()

      else

         if !aTmp[ 13 ]
            aGet[ 5 ]:hide()
            aGet[ 22  ]:show()
         else
            aGet[ 5 ]:show()
            aGet[ 22  ]:hide()
         end

      end

      if oStkAct <> nil

         StocksModel():lPutStockActual( cCodArt, aTmp[ 38 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ], oStkAct )

         if uFieldEmpresa( "lNStkAct" )
            oStkAct:Hide()
         end

      end

       if !empty( aGet[ 79 ] )
           aGet[ 79 ]:lValid()
        endif

   end

   if !empty( aTmp[ 27 ] )
      aGet[ 29 ]:Show()
      oSayPr1:Show()
      oSayVp1:Show()
      oSayPr1:SetText( retProp( aTmp[ 27 ], dbfPro ) )
      aGet[ 29 ]:lValid()
   else
      aGet[ 29 ]:hide()
      oSayPr1:hide()
      oSayVp1:hide()
   end

   if !empty( aTmp[ 28 ] )
      aGet[ 30 ]:Show()
      oSayPr2:Show()
      oSayVp2:Show()
      oSayPr2:SetText( retProp(  aTmp[ 28 ], dbfPro ) )
      aGet[ 30 ]:lValid()
   else
      aGet[ 30 ]:hide()
      oSayPr2:hide()
      oSayVp2:hide()
   end

   oTotal:cText( 0 )





   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
   end

   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
   end

   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
   end

   if oUndMedicion:oDbf:Seek( aTmp[ 16 ] )

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 1 .AND. !empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 2 .AND. !empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 3 .AND. !empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end



   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
   end

   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
   end

   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
   end

   if oUndMedicion:oDbf:Seek(  aTmp[ 16 ] )

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 1 .AND. !empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 2 .AND. !empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 3 .AND. !empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end





   if empty( aTmp[ 71 ] )
      if !empty( aGet[ 71 ] )
         aGet[ 71 ]:cText( oGetTarifa:getTarifa() )
      else
         aTmp[ 71 ]     := oGetTarifa:getTarifa()
      end
   end

   if !uFieldEmpresa( "lPreLin" )
      aGet[ 71 ]:Hide()
   else
      aGet[ 71 ]:Show()
   end





   aGet[ 51 ]:lValid()
   aGet[ 38 ]:lValid()
   aGet[ 4    ]:SetFocus()

   if !lAccArticulo() .OR. RolesModel():getRolNoVerPreciosCosto( Auth():rolUuid() )

      if !empty( aGet[ 36 ] )
         aGet[ 36 ]:Hide()
      end

   end





   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
   end

   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
   end

   if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
      aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
   end

   if oUndMedicion:oDbf:Seek(  aTmp[ 16 ] )

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 1 .AND. !empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 2 .AND. !empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 3 .AND. !empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end



   if ( empty( aTmp[ 6 ] ) .OR. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) ) .AND. nMode <> 3
      aGet[ 6 ]:HardEnable()
      aGet[ 8  ]:HardEnable()
      aGet[ 7  ]:HardEnable()
      aGet[ 9     ]:HardEnable()
      aGet[ 10  ]:HardEnable()
      aGet[ 32  ]:HardEnable()
   else
      aGet[ 6 ]:HardDisable()
      aGet[ 8  ]:HardDisable()
      aGet[ 7  ]:HardDisable()
      aGet[ 9     ]:HardDisable()
      aGet[ 10  ]:HardDisable()
      aGet[ 32  ]:HardDisable()
   end



   if !empty( oFld )
      oFld:SetOption( 1 )
   end



   if !empty( oBrwProperties )
      oBrwProperties:Hide()
      oBrwProperties:Cargo    := nil
   end

   if !Empty( oGetCelda )
      oGetCelda:hide()
   end



   aGet[ 4 ]:SetFocus()

RETURN NIL






STATIC FUNCTION SaveDeta( aTmp, aTmpFac, aGet, oFld, oBrw, oDlg, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, oTotal, oStkAct, nStkAct, cCodArt, oBtn, oBtnSer )

   local n
   local i

   local nRec
   local aClo
   local aXbyStr              := { 0, 0 }
   local nTotUnd              := 0
   local hAtipica
   local nPrecioPropiedades   := 0

   oBtn:SetFocus()

   if !aGet[ 4 ]:lValid()
      return nil
   end

   if empty( aTmp[ 38 ] ) .AND. !empty( aTmp[ 4 ] )
      msgStop( "Código de almacén no puede estar vacío", "Atención" )
      Return nil
   end

   if !cAlmacen( aGet[ 38 ], dbfAlm )
      Return nil
   end





   if ( nMode == 1 ) .AND. RetFld( aTmp[ 4 ], D():Articulos( nView ), "lNumSer" ) .AND. !( dbfTmpSer )->( dbSeek( Str( aTmp[ 34 ], 4 ) + aTmp[ 4 ] ) )
      MsgStop( "Tiene que introducir números de serie para este artículo." )
      oBtnSer:Click()
      Return nil
   end





   if nMode == 5

      ( dbfTmpLin )->( dbGoTop() )
      while !( dbfTmpLin )->( eof() )

         if ( dbfTmpLin )->lSel
            aEval( aTmp, {| cFld, n | if( !empty( aTmp[ n ] ), ( dbfTmpLin )->( FieldPut( n, aTmp[ n ] ) ), ) } )
         end

         ( dbfTmpLin )->( dbSkip() )

      end

      ( dbfTmpLin )->( dbGoTo( nRec ) )

      oBrw:Refresh()

      oDlg:end( 1 )

      Return nil

   end





   aTmp[ 86 ]   := cTipoCtrCoste
   nRec                 := ( dbfTmpLin )->( RecNo() )
   aClo                 := aClone( aTmp )

   if !empty( aTmp[ 4 ] ) .AND. aTmp[ 50 ]

      nTotUnd     := nTotNFacRec( aTmp ) - nTotNFacRec( dbfTmpLin )

      if ( nTotUnd <> 0 .AND. ( nStkAct - nTotUnd ) < 0 )
         MsgStop( "No hay stock suficiente." )
         return nil
      end

   end

   aTmp[ 55 ]  := nPReq( dbfIva, aTmp[ 11 ] )

   if nMode == 1

      if aTmp[ 42 ]
         saveLoteActual( aTmp[ 4 ], aTmp[ 44 ], nView )
      end



      if !empty( oBrwProperties:Cargo )

         for n := 1 to len( oBrwProperties:Cargo )

            for i := 1 to len( oBrwProperties:Cargo[ n ] )

               if !Empty( oBrwProperties:Cargo[ n, i ] )

                   if isNum( oBrwProperties:Cargo[ n, i ]:Value ) .AND. oBrwProperties:Cargo[ n, i ]:Value <> 0

                      aTmp[ 34 ]     := nLastNum( dbfTmpLin )
                      aTmp[ 85 ]   := nLastNum( dbfTmpLin, "nPosPrint" )
                      aTmp[ 18]     := oBrwProperties:Cargo[ n, i ]:Value
                      aTmp[ 27 ]     := oBrwProperties:Cargo[ n, i ]:cCodigoPropiedad1
                      aTmp[ 29 ]     := oBrwProperties:Cargo[ n, i ]:cValorPropiedad1
                      aTmp[ 28 ]     := oBrwProperties:Cargo[ n, i ]:cCodigoPropiedad2
                      aTmp[ 30 ]     := oBrwProperties:Cargo[ n, i ]:cValorPropiedad2



                      nPrecioPropiedades   := nPrePro( aTmp[ 4 ], aTmp[ 27 ], aTmp[ 29 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 71 ], aTmpFac[ 58 ], dbfArtDiv, dbfTarPreL, aTmpFac[ 22 ] )
                      if !empty(nPrecioPropiedades)
                         aTmp[ 6 ] := nPrecioPropiedades
                      end



                      saveDetail( aTmp, aClo, aGet, aTmpFac, dbfTmpLin, oBrw, nMode )

                   end

                end

            next

         next

         aCopy( dbBlankRec( dbfTmpLin ), aTmp )

         aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      else

         saveDetail( aTmp, aClo, aGet, aTmpFac, dbfTmpLin, oBrw, nMode )



      end

   else





      WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

   end





   bmpImage:Hide()

   if !empty( bmpImage:hBitmap )
      PalBmpFree( bmpImage:hBitmap, bmpImage:hPalette )
   endif

   cOldCodArt     := ""
   cOldUndMed     := ""

   if !empty( aGet[ 16 ] )
      aGet[ 16 ]:lValid()
   end

   if nMode == 1 .AND. lEntCon()

      recalculaTotal( aTmpFac )

      aCopy( dbBlankRec( dbfTmpLin ), aTmp )
      aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      SetDlgMode( aTmp, aGet, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oStkAct, nMode, oTotal, aTmpFac )

      SysRefresh()

   else

      oDlg:end( 1 )

   end

RETURN NIL



STATIC FUNCTION AppendKit( uTmpLin, aTmpAlb )

   local cCodArt
   local cSerAlb
   local nNumAlb
   local cSufAlb
   local nCanEnt
   local dFecAlb
   local cTipMov
   local cAlmLin
   local nIvaLin
   local lIvaLin
   local nComAge
   local nUniCaj
   local nDtoGrl
   local nDtoPrm
   local nDtoDiv
   local cNumPed
   local nTarLin
   local nNumLin                       := ( dbfTmpLin )->nNumLin
   local nPosPrint
   local nRecAct                       := ( dbfKit    )->( RecNo() )
   local nRecLin                       := ( dbfTmpLin )->( RecNo() )
   local nUnidades                     := 0
   local nStkActual                    := 0
   local nStockMinimo                  := 0

   if ValType( uTmpLin ) == "A"
      cCodArt                          := uTmpLin[ 4    ]
      cSerAlb                          := uTmpLin[ 1  ]
      nNumAlb                          := uTmpLin[ 2 ]
      cSufAlb                          := uTmpLin[ 3 ]
      nCanEnt                          := uTmpLin[ 12 ]
      dFecAlb                          := uTmpLin[ 20  ]
      cTipMov                          := uTmpLin[ 21 ]
      cAlmLin                          := uTmpLin[ 38 ]
      nIvaLin                          := uTmpLin[ 11    ]
      lIvaLin                          := uTmpLin[ 39 ]
      nComAge                          := uTmpLin[ 17 ]
      nUniCaj                          := uTmpLin[ 18]
      nDtoGrl                          := uTmpLin[ 9    ]
      nDtoPrm                          := uTmpLin[ 10 ]
      nDtoDiv                          := uTmpLin[ 32 ]
      nNumLin                          := uTmpLin[ 34 ]
      nPosPrint                        := uTmpLin[ 85 ]
      nTarLin                          := uTmpLin[ 71 ]
   else
      cCodArt                          := ( uTmpLin )->cRef
      cSerAlb                          := ( uTmpLin )->cSerie
      nNumAlb                          := ( uTmpLin )->nNumFac
      cSufAlb                          := ( uTmpLin )->cSufFac
      nCanEnt                          := ( uTmpLin )->nCanEnt
      dFecAlb                          := ( uTmpLin )->dFecha
      cTipMov                          := ( uTmpLin )->id_tipo_v
      cAlmLin                          := ( uTmpLin )->cAlmLin
      nIvaLin                          := ( uTmpLin )->nIva
      lIvaLin                          := ( uTmpLin )->lIvaLin
      nComAge                          := ( uTmpLin )->nComAge
      nUniCaj                          := ( uTmpLin )->nUniCaja
      nDtoGrl                          := ( uTmpLin )->nDto
      nDtoPrm                          := ( uTmpLin )->nDtoPrm
      nDtoDiv                          := ( uTmpLin )->nDtoDiv
      nNumLin                          := ( uTmpLin )->nNumLin
      nPosPrint                        := ( uTmpLin )->nPosPrint
      nTarLin                          := ( uTmpLin )->nTarLin
   end





   if ( dbfKit )->( dbSeek( cCodArt ) )

      while ( dbfKit )->cCodKit == cCodArt .AND. !( dbfKit )->( eof() )

         if ( D():Articulos( nView ) )->( dbSeek( ( dbfKit )->cRefKit ) )

            ( dbfTmpLin )->( dbAppend() )

            ( dbfTmpLin )->nNumLin      := nNumLin
            ( dbfTmpLin )->nPosPrint   := nPosPrint
            ( dbfTmpLin )->lKitChl      := .T.

            ( dbfTmpLin )->cRef        := ( dbfKit )->cRefKit
            ( dbfTmpLin )->cDetalle    := ( D():Articulos( nView ) )->Nombre
            ( dbfTmpLin )->nPntVer     := ( D():Articulos( nView ) )->nPntVer1
            ( dbfTmpLin )->nPesokg     := ( D():Articulos( nView ) )->nPesoKg
            ( dbfTmpLin )->cPesokg     := ( D():Articulos( nView ) )->cUndDim
            ( dbfTmpLin )->cUnidad     := ( D():Articulos( nView ) )->cUnidad
            ( dbfTmpLin )->nVolumen    := ( D():Articulos( nView ) )->nVolumen
            ( dbfTmpLin )->cVolumen    := ( D():Articulos( nView ) )->cVolumen
            ( dbfTmpLin )->nCtlStk     := ( D():Articulos( nView ) )->nCtlStock
            ( dbfTmpLin )->nPvpRec     := ( D():Articulos( nView ) )->PvpRec
            ( dbfTmpLin )->cCodImp     := ( D():Articulos( nView ) )->cCodImp
            ( dbfTmpLin )->lLote       := ( D():Articulos( nView ) )->lLote
            ( dbfTmpLin )->cLote       := ( D():Articulos( nView ) )->cLote

            ( dbfTmpLin )->nCosDiv     := nCosto( nil, D():Articulos( nView ), dbfKit, , , , , aTmpAlb[ 7 ] )
            ( dbfTmpLin )->nValImp     := oNewImp:nValImp( ( D():Articulos( nView ) )->cCodImp )

            if ( D():Articulos( nView ) )->lFacCnv
               ( dbfTmpLin )->nFacCnv  := ( D():Articulos( nView ) )->nFacCnv
            end





            ( dbfTmpLin )->cCodFam     := ( D():Articulos( nView ) )->Familia
            ( dbfTmpLin )->cGrpFam     := cGruFam( ( dbfTmpLin )->cCodFam, dbfFamilia )





            ( dbfTmpLin )->cSerie      := cSerAlb
            ( dbfTmpLin )->nNumFac     := nNumAlb
            ( dbfTmpLin )->cSufFac     := cSufAlb
            ( dbfTmpLin )->nCanEnt     := nCanEnt
            ( dbfTmpLin )->dFecha      := dFecAlb
            ( dbfTmpLin )->id_tipo_v   := val( cTipMov )
            ( dbfTmpLin )->cAlmLin     := cAlmLin
            ( dbfTmpLin )->lIvaLin     := lIvaLin





            ( dbfTmpLin )->lImpLin     := lImprimirComponente( cCodArt, D():Articulos( nView ) )
            ( dbfTmpLin )->lKitPrc     := lPreciosComponentes( cCodArt, D():Articulos( nView ) )

            ( dbfTmpLin )->nComAge     := nComAge
            ( dbfTmpLin )->nUniCaja    := nUniCaj * ( dbfKit )->nUndKit





            if !empty( nIvaLin )
               ( dbfTmpLin )->nIva     := nIva( D():Get( "TIva", nView ), ( D():Articulos( nView ) )->TipoIva )
               ( dbfTmpLin )->nReq     := nReq( D():Get( "TIva", nView ), ( D():Articulos( nView ) )->TipoIva )
            else
               ( dbfTmpLin )->nIva     := 0
               ( dbfTmpLin )->nReq     := 0
            end





            if ( dbfTmpLin )->lKitPrc
               ( dbfTmpLin )->nPreUnit := nRetPreArt( nTarLin, aTmpAlb[ 60 ], aTmpAlb[ 58 ], D():Articulos( nView ), D():Get( "Divisas", nView ), dbfKit, D():Get( "TIva", nView ), , , oNewImp )
            end





            if lStockComponentes( cCodArt, D():Articulos( nView ) )
               ( dbfTmpLin )->nCtlStk  := ( D():Articulos( nView ) )->nCtlStock
            else
               ( dbfTmpLin )->nCtlstk  := 3
            end





            if ( dbfKit )->lAplDto
               ( dbfTmpLin )->nDto     := nDtoGrl
               ( dbfTmpLin )->nDtoPrm  := nDtoPrm
               ( dbfTmpLin )->nDtoDiv  := nDtoDiv
            end

            if ( D():Articulos( nView ) )->lKitArt
               AppendKit( dbfTmpLin, aTmpAlb )
            end





            nStockMinimo      := nStockMinimo( cCodArt, cAlmLin, nView )

            if ( D():Articulos( nView ) )->lMsgVta .AND. !uFieldEmpresa( "lNStkAct" ) .AND. nStockMinimo <> 0

               nStkActual     := StocksModel():nStockArticulo( ( dbfKit )->cRefKit, cAlmLin )
               nUnidades      := nUniCaj * ( dbfKit )->nUndKit

               do case
                  case oUser():lNotAllowSales( nStkActual - nUnidades < 0 )



                     MsgStop( "No hay stock suficiente para realizar la venta" + Chr(13)+Chr(10) +  "del componente " + alltrim( ( dbfKit )->cRefKit ) + " - " + alltrim( ( D():Articulos( nView ) )->Nombre ), "¡Atención!" )

                  case oUser():lNotAllowSales( nStkActual - nUnidades < nStockMinimo )






                     MsgStop( "El stock del componente " + alltrim( ( dbfKit )->cRefKit ) + " - " + alltrim( ( D():Articulos( nView ) )->Nombre )  + Chr(13)+Chr(10) +  "está bajo minimo."                                                                                                  + Chr(13)+Chr(10) +  "Unidades a vender : " + alltrim( Trans( nUnidades, MasUnd() ) )                                                     + Chr(13)+Chr(10) +  "Stock minimo : " + alltrim( Trans( nStockMinimo, MasUnd() ) )                                                       + Chr(13)+Chr(10) +  "Stock actual : " + alltrim( Trans( nStkActual, MasUnd() ) ), "¡Atención!" )

               end

            end

         end

         ( dbfKit )->( dbSkip() )

      end

   end

   ( dbfKit    )->( dbGoTo( nRecAct ) )
   ( dbfTmpLin )->( dbGoTo( nRecLin ) )

RETURN NIL



Static Function saveDetail( aTmp, aClo, aGet, aTmpFac, dbfTmpLin, oBrw, nMode )

   local hAtipica
   local sOfertaArticulo
   local nCajasGratis         := 0
   local nUnidadesGratis      := 0



   hAtipica                   := hAtipica( hValue( aTmp, aTmpFac ) )
   if !empty( hAtipica )
      if hhaskey( hAtipica, "nCajasGratis" ) .AND. hget( hAtipica, "nCajasGratis" ) <> 0
         nCajasGratis         := hget( hAtipica, "nCajasGratis" )
      end
      if hhaskey( hAtipica, "nUnidadesGratis" ) .AND. hget( hAtipica, "nUnidadesGratis" ) <> 0
         nUnidadesGratis      := hget( hAtipica, "nUnidadesGratis" )
      end
   end



   if empty( nCajasGratis ) .AND. empty( nUnidadesGratis )
      sOfertaArticulo         := structOfertaArticulo( D():getHashArray( aTmpFac, "FacRecT", nView ), D():getHashArray( aTmp, "FacRecL", nView ), nTotLFacRec( aTmp ), nView )
      if !empty( sOfertaArticulo )
         nCajasGratis         := sOfertaArticulo:nCajasGratis
         nUnidadesGratis      := sOfertaArticulo:nUnidadesGratis
      end
   end



   if nCajasGratis <> 0
      aTmp[ 73 ]        := .T.
      aTmp[ 12 ]        -= nCajasGratis
      commitDetail( aTmp, aClo, nil, aTmpFac, dbfTmpLin, oBrw, nMode )

      aTmp[ 73 ]        := .T.
      aTmp[ 12 ]        := nCajasGratis
      aTmp[ 6]        := 0
      aTmp[ 9    ]        := 0
      aTmp[ 32 ]        := 0
      aTmp[ 10 ]        := 0
      aTmp[ 17 ]        := 0
   end



   if nUnidadesGratis <> 0
      aTmp[ 73 ]        := .T.
      aTmp[ 18]        -= nUnidadesGratis

      commitDetail( aTmp, aClo, nil, aTmpFac, dbfTmpLin, oBrw, nMode )

      aTmp[ 73 ]        := .T.
      aTmp[ 18]        := nUnidadesGratis
      aTmp[ 6]        := 0
      aTmp[ 9    ]        := 0
      aTmp[ 32 ]        := 0
      aTmp[ 10 ]        := 0
      aTmp[ 17 ]        := 0
   end

   commitDetail( aTmp, aClo, aGet, aTmpFac, dbfTmpLin, oBrw, nMode )

Return nil



Static Function commitDetail( aTmp, aClo, aGet, aTmpFac, dbfTmpLin, oBrw, nMode )

   winGather( aTmp, aGet, dbfTmpLin, oBrw, nMode, nil, .F. )

   if ( nMode == 1 ) .AND. ( aClo[ 46 ] )
      appendKit( aClo, aTmpFac )
   end

Return nil



Static Function EdtInc( aTmp, aGet, dbfFacRecI, oBrw, bWhen, bValid, nMode, aTmpFac )

   local oDlg

   if nMode == 1
      aTmp[ 1   ] := aTmpFac[ 1  ]
      aTmp[ 2  ] := aTmpFac[ 2 ]
      aTmp[ 3  ] := aTmpFac[ 3 ]
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de facturas rectificativas", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
      end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



Static Function EdtEst( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpFac )

       local oDlg

       if nMode == 1

          aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("tFecSit")) ]    := GetSysTime()

    end

       oDlg = TDialog():New(,,,, LblTitle( nMode ) + "Situación del documento del cliente", "SITUACION_ESTADO",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






           aGet[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("cSitua")) ] := TComboBox():ReDefine( 200, { | u | If( PCount()==0, aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("cSitua")) ], aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("cSitua")) ]:= u ) }, ( SituacionesModel():getArrayNombres() ), oDlg,,,,,,, .F., {||     ( nMode <> 3 )},,,,,, 'aGet[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("cSitua")) ]',,,,,,, )







        aGet[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("dFecSit")) ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("dFecSit")) ], aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("dFecSit")) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("dFecSit")) ]:cText( Calendario( aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("dFecSit")) ] ) )}, nil,,, )









          aGet[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("tFecSit")) ] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("tFecSit")) ], aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("tFecSit")) ]:= u ) }, oDlg,, "@R 99:99:99", {||    ( iif( !validTime( aTmp[ (D():FacturasRectificativasSituaciones( nView ))->(fieldpos("tFecSit")) ] ), ( msgStop( "El formato de la hora no es correcto" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





          TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpEst, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





          TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

       if nMode <> 3
        oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpEst, oBrw, nMode ), oDlg:end( 1 ) } )
       end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( .T. )



Static Function EdtDoc( aTmp, aGet, dbfFacRecD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de pedidos a proveedor", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



STATIC FUNCTION AppKit( aClo, aTmpFac, dbfTmpLin, dbfKit )

   local nRec           := ( dbfTmpLin )->( RecNo() )
   local nNumLin        := ( dbfTmpLin )->nNumLin
   local nUnidades      := 0
   local nStkActual     := 0
   local nStockMinimo   := 0

   if aClo[ 46 ] .AND. ( dbfKit )->( dbSeek( aClo[ 4 ] ) )

      while ( dbfKit )->cCodKit == aClo[ 4 ] .AND. !( dbfKit )->( eof() )

         if ( D():Articulos( nView ) )->( dbSeek( ( dbfKit )->cRefKit ) )

            ( dbfTmpLin )->( dbAppend() )

            ( dbfTmpLin )->nNumLin  := nNumLin
            ( dbfTmpLin )->lKitChl  := .T.

            ( dbfTmpLin )->cRef        := ( dbfKit      )->cRefKit
            ( dbfTmpLin )->nPreUnit    := ( dbfKit      )->nPreKit
            ( dbfTmpLin )->cDetalle    := ( D():Articulos( nView ) )->Nombre
            ( dbfTmpLin )->nPntVer     := ( D():Articulos( nView ) )->nPntVer1
            ( dbfTmpLin )->nPesokg     := ( D():Articulos( nView ) )->nPesoKg
            ( dbfTmpLin )->cPesokg     := ( D():Articulos( nView ) )->cUndDim
            ( dbfTmpLin )->cUnidad     := ( D():Articulos( nView ) )->cUnidad
            ( dbfTmpLin )->nCtlStk     := ( D():Articulos( nView ) )->nCtlStock
            ( dbfTmpLin )->cCodImp     := ( D():Articulos( nView ) )->cCodImp
            ( dbfTmpLin )->lLote       := ( D():Articulos( nView ) )->lLote
            ( dbfTmpLin )->nLote       := ( D():Articulos( nView ) )->nLote
            ( dbfTmpLin )->cLote       := ( D():Articulos( nView ) )->cLote
            ( dbfTmpLin )->nPvpRec     := ( D():Articulos( nView ) )->PvpRec

            ( dbfTmpLin )->nCosDiv     := nCosto( nil, D():Articulos( nView ), dbfKit, , , , aTmpFac[ 7 ] )
            ( dbfTmpLin )->nValImp     := oNewImp:nValImp( ( D():Articulos( nView ) )->cCodImp )

            if ( D():Articulos( nView ) )->lFacCnv
               ( dbfTmpLin )->nFacCnv  := ( D():Articulos( nView ) )->nFacCnv
            end





            ( dbfTmpLin )->cCodFam     := ( D():Articulos( nView ) )->Familia
            ( dbfTmpLin )->cGrpFam     := cGruFam( ( dbfTmpLin )->cCodFam, dbfFamilia )





            ( dbfTmpLin )->cSerie      := aClo[ 1  ]
            ( dbfTmpLin )->nNumFac     := aClo[ 2 ]
            ( dbfTmpLin )->cSufFac     := aClo[ 3 ]
            ( dbfTmpLin )->nCanEnt     := aClo[ 12 ]
            ( dbfTmpLin )->dFecha      := aClo[ 20  ]
            ( dbfTmpLin )->id_tipo_v   := aClo[ 21 ]
            ( dbfTmpLin )->nNumLin     := aClo[ 34 ]
            ( dbfTmpLin )->cAlmLin     := aClo[ 38 ]
            ( dbfTmpLin )->lIvaLin     := aClo[ 39 ]
            ( dbfTmpLin )->nComAge     := aClo[ 17 ]
            ( dbfTmpLin )->nUniCaja    := aClo[ 18] * ( dbfKit )->nUndKit





            if !empty( aClo[ 11 ] )
               ( dbfTmpLin )->nIva     := nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva )
               ( dbfTmpLin )->nReq     := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )
            else
               ( dbfTmpLin )->nIva     := 0
               ( dbfTmpLin )->nReq     := 0
            end





            ( dbfTmpLin )->lImpLin     := lImprimirComponente( aClo[ 4 ], D():Articulos( nView ) )
            ( dbfTmpLin )->lKitPrc     := lPreciosComponentes( aClo[ 4 ], D():Articulos( nView ) )

            if ( dbfTmpLin )->lKitPrc
               ( dbfTmpLin )->nPreUnit := nRetPreArt( aClo[ 71 ], aTmpFac[ 60 ], aTmpFac[ 58 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
            end

            if lStockComponentes( aClo[ 4 ], D():Articulos( nView ) )
               ( dbfTmpLin )->nCtlStk  := ( D():Articulos( nView ) )->nCtlStock
            else
               ( dbfTmpLin )->nCtlstk  := 3
            end





            if ( dbfKit )->lAplDto
               ( dbfTmpLin )->nDto     := aClo[ 9    ]
               ( dbfTmpLin )->nDtoPrm  := aClo[ 10 ]
               ( dbfTmpLin )->nDtoDiv  := aClo[ 32 ]
            end





            nStockMinimo      := nStockMinimo( aClo[ 4 ], aClo[ 38 ], nView )

            if ( D():Articulos( nView ))->lMsgVta .AND. !uFieldEmpresa( "lNStkAct" ) .AND. nStockMinimo > 0

               nStkActual     := StocksModel():nStockArticulo( ( dbfKit )->cRefKit, ( dbfTmpLin )->cAlmLin )
               nUnidades      := aClo[ 18 ] * ( dbfKit )->nUndKit

               do case
                  case nStkActual - nUnidades < 0



                        MsgStop( "No hay stock suficiente para realizar la venta" + Chr(13)+Chr(10) +  "del componente " + alltrim( ( dbfKit )->cRefKit ) + " - " + alltrim( ( D():Articulos( nView ) )->Nombre ), "¡Atención!" )

                  case nStkActual - nUnidades < nStockMinimo






                        MsgStop( "El stock del componente " + alltrim( ( dbfKit )->cRefKit ) + " - " + alltrim( ( D():Articulos( nView ) )->Nombre ) + Chr(13)+Chr(10) +  "está bajo minimo." + Chr(13)+Chr(10) +  "Unidades a vender : " + alltrim( Trans( nUnidades, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock minimo : " + alltrim( Trans( nStockMinimo, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock actual : " + alltrim( Trans( nStkActual, MasUnd() ) ), "¡Atención!" )
               end

            end

         end

         ( dbfKit )->( dbSkip() )

      end

      ( dbfTmpLin )->( dbGoTo( nRec ) )

   end

RETURN NIL







STATIC FUNCTION AppDeta( oBrwDet, bEdtDet, aTmp, lTot, cCodArt )

   If( lTot == nil, lTot := .F., ) ;

   if ( empty( aNumAlb ) ) .OR. lTot

      WinAppRec( oBrwDet, bEdtDet, dbfTmpLin, lTot, cCodArt, aTmp )

   else


      MsgStop( "No se pueden añadir registros a una factura que" + Chr(13)+Chr(10) +  "proviene de albaranes." )

   end

RETURN RecalculaTotal( aTmp )






STATIC FUNCTION EdtDeta( oBrwDet, bEdtDet, aTmp, lTot, nFacMod )






   if ( dbfTmpLin )->lSel
      WinMulRec( oBrwDet, bEdtDet, dbfTmpLin, lTot, nFacMod, aTmp )
   else
      WinEdtRec( oBrwDet, bEdtDet, dbfTmpLin, lTot, nFacMod, aTmp )
   end










RETURN RecalculaTotal( aTmp )






STATIC FUNCTION DelDeta()

   CursorWait()

   while ( dbfTmpSer )->( dbSeek( Str( ( dbfTmpLin )->nNumLin, 4 ) ) )
      ( dbfTmpSer )->( dbDelete() )
   end

   if ( dbfTmpLin )->lKitArt
      dbDelKit( , dbfTmpLin, ( dbfTmpLin )->nNumLin )
   end

   CursorWE()

RETURN ( .T. )



STATIC FUNCTION PrnSerie()

    local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local cSerIni     := ( D():FacturasRectificativas( nView ) )->cSerie
   local cSerFin     := ( D():FacturasRectificativas( nView ) )->cSerie
   local nDocIni     := ( D():FacturasRectificativas( nView ) )->nNumFac
   local nDocFin     := ( D():FacturasRectificativas( nView ) )->nNumFac
   local cSufIni     := ( D():FacturasRectificativas( nView ) )->cSufFac
   local cSufFin     := ( D():FacturasRectificativas( nView ) )->cSufFac
   local oPrinter
   local cPrinter    := ImpresoraDefectoUsuario()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local oRango
   local nRango      := 1
   local dFecDesde   := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dFecHasta   := Date()
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) == 0, Max( Retfld( ( D():FacturasRectificativas( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) )

   if empty( cFmtDoc )
      cFmtDoc           := cSelPrimerDoc( "FR" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de facturas rectificativas", "IMPSERIES",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



   oRango := TRadMenu():Redefine( { | u | If( PCount()==0, nRango, nRango:= u ) }, oDlg,, { 201, 202 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 210, { | u | If( PCount()==0, dFecDesde, dFecDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 220, { | u | If( PCount()==0, dFecHasta, dFecHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, D():Documentos( nView ) ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "FR" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "gc_document_text_pencil_12",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "gc_printer2_check_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart := { || oSerIni:SetFocus() }

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oWndBrw:oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta )

   local nCopyClient
   local nRecno
   local nOrdAnt

   oDlg:Disable()

       if nRango == 1

           nRecno      := ( D():FacturasRectificativas( nView ) )->( Recno() )
           nOrdAnt     := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( "NNUMFAC" ) )

           if !lInvOrden

              ( D():FacturasRectificativas( nView ) )->( dbSeek( cDocIni, .T. ) )


              while ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + (D():FacturasRectificativas( nView ))->cSufFac >= cDocIni .AND.     ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + (D():FacturasRectificativas( nView ))->cSufFac <= cDocFin

                lChgImpDoc( D():FacturasRectificativas( nView ) )

                 if lCopiasPre

                    nCopyClient := if( nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) == 0, Max( Retfld( ( D():FacturasRectificativas( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) )

                    GenFacRec( 1, "Imprimiendo documento : " + ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, cFmtDoc, cPrinter, nCopyClient )

                 else

                    GenFacRec( 1, "Imprimiendo documento : " + ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, cFmtDoc, cPrinter, nNumCop )

                 end

              ( D():FacturasRectificativas( nView ) )->( dbSkip() )

              end

           else

              ( D():FacturasRectificativas( nView ) )->( dbSeek( cDocFin ) )



              while ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac >= cDocIni .AND.    ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac <= cDocFin .AND.    !( D():FacturasRectificativas( nView ) )->( Bof() )

                    lChgImpDoc( D():FacturasRectificativas( nView ) )

                 if lCopiasPre

                    nCopyClient := if( nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) == 0, Max( Retfld( ( D():FacturasRectificativas( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) )

                    GenFacRec( 1, "Imprimiendo documento : " + ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, cFmtDoc, cPrinter, nCopyClient )

                 else

                    GenFacRec( 1, "Imprimiendo documento : " + ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, cFmtDoc, cPrinter, nNumCop )

                 end

              ( D():FacturasRectificativas( nView ) )->( dbSkip( -1 ) )

              end

        end

    else

        nRecno      := ( D():FacturasRectificativas( nView ) )->( Recno() )
           nOrdAnt     := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( "DFECFAC" ) )

           if !lInvOrden

              ( D():FacturasRectificativas( nView ) )->( dbGoTop() )

              while !( D():FacturasRectificativas( nView ) )->( Eof() )

                if ( D():FacturasRectificativas( nView ) )->dFecFac >= dFecDesde .AND. ( D():FacturasRectificativas( nView ) )->dFecFac <= dFecHasta

                    lChgImpDoc( D():FacturasRectificativas( nView ) )

                     if lCopiasPre

                        nCopyClient := if( nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) == 0, Max( Retfld( ( D():FacturasRectificativas( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) )

                        GenFacRec( 1, "Imprimiendo documento : " + ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, cFmtDoc, cPrinter, nCopyClient )

                     else

                        GenFacRec( 1, "Imprimiendo documento : " + ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, cFmtDoc, cPrinter, nNumCop )

                     end

                 end

              ( D():FacturasRectificativas( nView ) )->( dbSkip() )

              end

           else

              ( D():FacturasRectificativas( nView ) )->( dbGobottom() )

              while !( D():FacturasRectificativas( nView ) )->( Bof() )

                if ( D():FacturasRectificativas( nView ) )->dFecFac >= dFecDesde .AND. ( D():FacturasRectificativas( nView ) )->dFecFac <= dFecHasta

                    lChgImpDoc( D():FacturasRectificativas( nView ) )

                    if lCopiasPre

                        nCopyClient := if( nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) == 0, Max( Retfld( ( D():FacturasRectificativas( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", dbfCount ) )

                        GenFacRec( 1, "Imprimiendo documento : " + ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, cFmtDoc, cPrinter, nCopyClient )

                     else

                           GenFacRec( 1, "Imprimiendo documento : " + ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, cFmtDoc, cPrinter, nNumCop )

                    end

                end

              ( D():FacturasRectificativas( nView ) )->( dbSkip( -1 ) )

              end

        end

    end

       (D():FacturasRectificativas( nView ))->( dbGoTo( nRecNo ) )
       (D():FacturasRectificativas( nView ))->( ordSetFocus( nOrdAnt ) )

       oDlg:enable()

RETURN NIL







STATIC FUNCTION lCalcDeta( aTmp, aTmpFac, lTotal )

   local nBase
   local nCosto
   local nMargen
   local nCalculo
   local nUnidades
   local nRentabilidad

   If( lTotal == nil, lTotal := .F., ) ;

   nCalculo       := aTmp[ 6 ]
   nCalculo       -= aTmp[ 32  ]

   nUnidades      := nTotNFacRec( aTmp )





   if !aTmp[ 39 ]
      if aTmp[ 74 ]
         nCalculo += aTmp[ 41 ] * NotCero( aTmp[ 65 ] )
      else
         nCalculo += aTmp[ 41 ]
      end
   end

   nCalculo       *= nUnidades





   if aTmp[ 8 ] <> 0
      nCalculo    += nUnidades * aTmp[ 8 ]
   end





   if aTmp[ 9    ] <> 0
      nCalculo    -= nCalculo * aTmp[ 9    ] / 100
   end

   if aTmp[ 10 ] <> 0
      nCalculo    -= nCalculo * aTmp[ 10 ] / 100
   end





   nCosto            := nUnidades * aTmp[ 36 ]

   if aTmp[ 39 ] .AND. aTmp[ 11 ] <> 0
      nBase          := nCalculo - Round( nCalculo / ( 100 / aTmp[ 11 ] + 1 ), nRouDiv )
   else
      nBase          := nCalculo
   end

   nMargen           := nBase - nCosto

   if nCalculo == 0
      nRentabilidad  := 0
   else
      nRentabilidad  := nRentabilidad( nCalculo, 0, nCosto )
   end





   if aTmpFac[ 101 ]
      nCalculo       += nUnidades * aTmp[ 7 ]
   end





   if !empty( oTotalLinea )
      oTotalLinea:cText( nCalculo )
   end

   if !empty( oRentabilidadLinea )
      oRentabilidadLinea:cText( alltrim( Trans( nMargen, cPorDiv ) + alltrim( cSimDiv( cCodDiv, dbfDiv ) ) + " : " + alltrim( Trans( nRentabilidad, "999.99" ) ) + "%" ) )
   end

   if !empty( oComisionLinea )
      oComisionLinea:cText( Round( ( nBase * aTmp[ 17 ] / 100 ), nRouDiv ) )
   end

RETURN ( if( !lTotal, .T., nCalculo ) )






STATIC FUNCTION LoaArt( cCodArt, aGet, aTmp, aTmpFac, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, lFocused )

   local hHas128
   local cLote
   local dFechaCaducidad
   local nDtoAge
   local nImpAtp
   local nImpOfe
   local nCosPro
   local cCodFam
   local cPrpArt
   local nPrePro                 := 0
   local nNumDto                 := 0
   local cProveedor
   local nTarOld                 := aTmp[ 71 ]
   local lChgCodArt
   local hAtipica
   local nUnidades            := 0

   If( lFocused == nil, lFocused := .T., ) ;

   lChgCodArt                   := ( empty( cOldCodArt ) .OR. Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) )

   if empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir líneas sin codificar" )
         return .F.
      end

      if empty( aTmp[ 11 ] )
         aGet[ 11 ]:bWhen  := {|| .T. }
      end

        aGet[ 5 ]:cText( Space( 50 ) )
      aGet[ 5 ]:bWhen := {|| .T. }
      aGet[ 5 ]:Hide()

      if !empty( aGet[ 22 ] )
         aGet[ 22 ]:Show()
          if lFocused
            aGet[ 22 ]:SetFocus()
          end
      end

      aGet[ 29 ]:Hide()
      oSayPr1:Hide()
      oSayVp1:Hide()

      aGet[ 30 ]:Hide()
      oSayPr2:Hide()
      oSayVp2:Hide()

      Return .T.

   end

   IF lModIva()
      aGet[ 11 ]:bWhen  := {|| .T. }
   ELSE
      aGet[ 11 ]:bWhen     := {|| .F. }
   end





   if Len( alltrim( cCodArt ) ) > 18

      hHas128              := GetHashGs128( cCodArt )

      if !empty( hHas128 )

         cCodArt           := uGetCodigo( hHas128, "00" )

         if Empty( cCodArt )
            cCodArt        := uGetCodigo( hHas128, "01" )
         end

         cLote             := uGetCodigo( hHas128, "10" )

         dFechaCaducidad   := uGetCodigo( hHas128, "15" )

         if Empty( dFechaCaducidad )
            dFechaCaducidad   := uGetCodigo( hHas128, "17" )
         end

         nUnidades         := uGetCodigo( hHas128, "3103" )

      end

   end

   cCodArt                 := cSeekCodebar( cCodArt, dbfCodebar, D():Articulos( nView ) )





   if ( D():Articulos( nView ) )->( dbSeek( cCodArt ) ) .OR. ( D():Articulos( nView ) )->( dbSeek( Upper( cCodArt ) ) )

      if ( lChgCodArt )

         if ( D():Articulos( nView ) )->lObs
            MsgStop( "Artículo catalogado como obsoleto" )
            return .F.
         end

         CursorWait()

         cCodArt              := ( D():Articulos( nView ) )->Codigo

         aGet[ 4 ]:cText( Padr( cCodArt, 200 ) )
         aTmp[ 4 ]        := cCodArt



         aTmp[ 83 ]     := ( D():Articulos( nView ) )->cRefAux
         aTmp[ 84 ]    := ( D():Articulos( nView ) )->cRefAux2

         if ( D():Articulos( nView ) )->lMosCom .AND. !empty( ( D():Articulos( nView ) )->mComent )
            MsgStop( Trim( ( D():Articulos( nView ) )->mComent ) )
         end





         if !empty( aGet[ 57 ] )
            aGet[ 57 ]:cText( ( D():Articulos( nView ) )->cPrvHab )
            aGet[ 57 ]:lValid()
         else
            aTmp[ 57 ]  := ( D():Articulos( nView ) )->cPrvHab
         end

         aTmp[ 64 ]  := Padr( cRefPrvArt( cCodArt, (D():Articulos( nView ))->cPrvHab, dbfArtPrv ), 18 )

         aGet[ 5 ]:show()
         aGet[ 22  ]:hide()

         aGet[ 5 ]:cText( ( D():Articulos( nView ) )->Nombre )
         aGet[ 22  ]:cText( ( D():Articulos( nView ) )->Nombre )





         if !empty( ( D():Articulos( nView ) )->Descrip )
            if !empty( aGet[ 72 ] )
               aGet[ 72 ]:cText( ( D():Articulos( nView ) )->Descrip )
            else
               aTmp[ 72 ]     := ( D():Articulos( nView ) )->Descrip
            end
         end






         if !empty( aGet[ 14 ] )
            aGet[ 14  ]:cText( ( D():Articulos( nView ) )->nPesoKg )
         else
            aGet[ 14  ] := ( D():Articulos( nView ) )->nPesoKg
         end

         if !empty( aGet[ 15 ] )
             aGet[ 15 ]:cText( ( D():Articulos( nView ) )->cUndDim )
         else
             aGet[ 15 ] := ( D():Articulos( nView ) )->cUndDim
         end

         if !empty( aGet[ 16 ] )
             aGet[ 16 ]:cText( ( D():Articulos( nView ) )->cUnidad )
             aGet[ 16 ]:lValid()
         else
             aTmp[ 16 ] := ( D():Articulos( nView ) )->cUnidad
         end

         if !empty( aGet[ 51 ] )
            aGet[ 51 ]:cText( ( D():Articulos( nView ) )->cCodTip )
         else
            aTmp[ 51 ]  := ( D():Articulos( nView ) )->cCodTip
         end






         if ( D():Articulos( nView ) )->lFacCnv
            aTmp[ 31 ]  := ( D():Articulos( nView ) )->nFacCnv
         end






         if ( D():Articulos( nView ) )->lLote

             if empty( cLote )
                 cLote             := ( D():Articulos( nView ) )->cLote
             end

            if !empty( aGet[ 44 ] )

                   aGet[ 44 ]:Show()

                   if uFieldempresa( "lLoaUltLot" )
                       aGet[ 44 ]:cText( cLote )
                   end

                   aGet[ 44 ]:lValid()

            else

                if uFieldempresa( "lLoaUltLot" )
                       aTmp[ 44 ] := cLote
                   else
                       aTmp[ 44 ] := Space( 64 )
                   end

            end

            aTmp[ 42 ]    := .T.





            if empty( dFechaCaducidad )
               dFechaCaducidad     := StocksModel():getFechaCaducidad( aTmp[ 4 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ] )
            end

            if !empty( aGet[ 45 ] )

               aGet[ 45 ]:Show()

               if empty( aTmp[ 45 ] ) .AND. uFieldempresa( "lLoaUltLot" )
                  aGet[ 45 ]:cText( dFechaCaducidad )
               end

            end

         else

            if !empty( aGet[ 44 ] )
                aTmp[ 44 ]    := Space( 14 )
                aGet[ 44 ]:cText( Space( 14 ) )
                   aGet[ 44 ]:Hide()
            end

            if !empty( aGet[ 45 ] )
                aTmp[ 45 ]  := cTod( "" )
                aGet[ 45 ]:cText( cTod( "" ) )
                   aGet[ 45 ]:Hide()
            end

         end





         cCodFam              := ( D():Articulos( nView ) )->Familia
         if !empty( cCodFam )
            aTmp[53]    := cCodFam
            aTmp[54]    := cGruFam( cCodFam, dbfFamilia )
            aGet[ 53]:cText( cCodFam )
            aGet[ 54]:cText( cGruFam( cCodFam, dbfFamilia ) )
            aGet[ 53]:lValid()
            aGet[ 54]:lValid()
         else
            aGet[ 53]:cText( Space( 8 ) )
            aGet[ 54]:cText( Space( 3 ) )
            aGet[ 53]:lValid()
            aGet[ 54]:lValid()
         end





         if ( D():Articulos( nView ) )->lKitArt

            aTmp[ 46 ]     := ( D():Articulos( nView ) )->lKitArt
            aTmp[ 26 ]     := lImprimirCompuesto( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
            aTmp[ 48 ]     := lPreciosCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )

            if lStockCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )

               if aGet[ 35 ] <> nil
                  aGet[ 35 ]:SetOption( ( D():Articulos( nView ) )->nCtlStock )
               else
                  aTmp[ 35 ]  := ( D():Articulos( nView ) )->nCtlStock
               end

            else

               if aGet[ 35 ] <> nil
                  aGet[ 35 ]:SetOption( 3 )
               else
                  aTmp[ 35 ]  := 3
               end

            end

         else

            aTmp[ 26 ]     := .F.

            if aGet[ 35 ] <> nil
               aGet[ 35 ]:SetOption( ( D():Articulos( nView ) )->nCtlStock )
            else
               aTmp[ 35 ]  := ( D():Articulos( nView ) )->nCtlStock
            end

         end





         if aTmpFac[65] <= 2
            aGet[ 11 ]:cText( nIva( dbfIva, ( D():Articulos( nView ) )->TIPOIVA ) )
            aTmp[ 55 ]        := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )
         end





         aTmp[ 40 ]     := ( D():Articulos( nView ) )->cCodImp
         oNewImp:setCodeAndValue( aTmp[ 40 ], aGet[ 41 ] )

         if !empty( ( D():Articulos( nView ) )->cCodImp )
            aTmp[ 74 ]     := RetFld( ( D():Articulos( nView ) )->cCodImp, oNewImp:oDbf:cAlias, "lIvaVol" )
         end

         if ( D():Articulos( nView ) )->nBulEnt <> 0
           if !empty( aGet )
              aGet[ 76 ]:cText( ( D():Articulos( nView ) )->nBulEnt )
           else
              aTmp[ 76 ]  := ( D():Articulos( nView ) )->nBulEnt
           end
         end

         if (D():Articulos( nView ))->nCajEnt <> 0
            aGet[ 12 ]:cText( (D():Articulos( nView ))->nCajEnt )
         end

         if !Empty( nUnidades )
               aGet[ 18 ]:cText( nUnidades )
            end

            if Empty( nUnidades ) .AND. ( D():Articulos( nView ) )->nUniCaja <> 0
               aGet[ 18 ]:cText( ( D():Articulos( nView ) )->nUniCaja  )
            end





         loadComisionAgente( aTmp, aGet, aTmpFac )

         aTmp[ 50 ]     := ( D():Articulos( nView ) )->lNotVta





         do case
               case uFieldEmpresa( "nCosVta" ) < 2

              nCosPro           := oStock:nCostoMedio( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ] )

              if nCosPro == 0
                 nCosPro        := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ), aTmpFac[ 7 ] )
              end

               case uFieldEmpresa( "nCosVta" ) == 2

              nCosPro           := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ), aTmpFac[ 7 ] )

               case uFieldEmpresa( "nCosVta" ) == 3

              nCosPro           := MaterialesProducidosLineasModel():getCosto(  aTmp[ 4 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ] )

              if nCosPro == 0
                 nCosPro        := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ), aTmpFac[ 7 ] )
              end

         end










         if aGet[ 36 ] <> nil
            aGet[ 36 ]:cText( nCosPro )
         else
            aTmp[ 36 ]  := nCosPro
         end





        if uFieldempresa( "lDtoCliLin" )

            if !empty( aGet ) .AND. !empty( aGet[ 9 ] )
                 aGet[ 9 ]:cText( retFld( aTmpFac[ 7 ], D():Clientes( nView ), "nDtoEsp" ) )
                 aTmp[ 9 ]     := retFld( aTmpFac[ 7 ], D():Clientes( nView ), "nDtoEsp" )
              else
                 aTmp[ 9 ]     := retFld( aTmpFac[ 7 ], D():Clientes( nView ), "nDtoEsp" )
              end

        end





         nNumDto              := RetFld( aTmpFac[ 7 ], D():Clientes( nView ), "nDtoArt" )

         if nNumDto <> 0

            do case
               case nNumDto == 1

                  if !empty( aGet[ 9 ] )
                     aGet[ 9 ]:cText( ( D():Articulos( nView ) )->nDtoArt1 )
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt1
                  else
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt1
                  end

               case nNumDto == 2

                  if !empty( aGet[ 9 ] )
                     aGet[ 9 ]:cText( ( D():Articulos( nView ) )->nDtoArt2 )
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt2
                  else
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt2
                  end

               case nNumDto == 3

                  if !empty( aGet[ 9 ] )
                     aGet[ 9]:cText( ( D():Articulos( nView ) )->nDtoArt3 )
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt3
                  else
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt3
                  end

               case nNumDto == 4

                  if !empty( aGet[ 9 ] )
                     aGet[ 9 ]:cText( ( D():Articulos( nView ) )->nDtoArt4 )
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt4
                  else
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt4
                  end

               case nNumDto == 5

                  if !empty( aGet[ 9 ] )
                     aGet[ 9 ]:cText( ( D():Articulos( nView ) )->nDtoArt5 )
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt5
                  else
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt5
                  end

               case nNumDto == 6

                  if !empty( aGet[ 9 ] )
                     aGet[ 9]:cText( ( D():Articulos( nView ) )->nDtoArt6 )
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt6
                  else
                     aTmp[ 9 ]     := ( D():Articulos( nView ) )->nDtoArt6
                  end

            end

         end





         if aTmp[ 9 ] == 0

            if !empty( aGet[ 9 ] )
               aGet[ 9 ]:cText( nDescuentoFamilia( cCodFam, dbfFamilia ) )
            else
               aTmp[ 9 ]     := nDescuentoFamilia( cCodFam, dbfFamilia )
            end

         end





         if !empty( aGet[ 59 ] )
            aGet[ 59 ]:cText( ( D():Articulos( nView ) )->cImagen )
         else
            aTmp[ 59 ]     := ( D():Articulos( nView ) )->cImagen
         end

         if !empty( bmpImage )
            if !empty( aTmp[ 59 ] )
               bmpImage:Show()
               bmpImage:LoadBmp( cFileBitmap( cPatImg(), aTmp[ 59 ] ) )
            else
               bmpImage:Hide()
            end
         end





         aTmp[ 27 ]  := ( D():Articulos( nView ) )->cCodPrp1
         aTmp[ 28 ]  := ( D():Articulos( nView ) )->cCodPrp2

         if ( !empty( aTmp[ 27 ] ) .OR. !empty( aTmp[ 28 ] ) ) .AND. ( uFieldEmpresa( "lUseTbl" ) .AND. ( nMode == 1 ) )

            aGet[ 12  ]:cText( 0 )
            aGet[ 18 ]:cText( 0 )

            setPropertiesTable( cCodArt, aTmp[ 27 ], aTmp[ 28 ], 0, aGet[ 18 ], oBrwProperties, nView )

            if !Empty( oGetCelda )
                  oGetCelda:Show()
               end

         else

            hidePropertiesTable( oBrwProperties )

            if !Empty( oGetCelda )
                  oGetCelda:hide()
               end

            if !empty( aTmp[ 27 ] )
               aGet[ 29 ]:Show()
               if lFocused
                  aGet[ 29 ]:SetFocus()
               end
               oSayPr1:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp1, dbfPro ) )
               oSayPr1:Show()
               oSayVp1:Show()
            else
               aGet[ 29 ]:hide()
               aGet[ 29 ]:cText( Space( 20 ) )
               oSayPr1:SetText( "" )
               oSayPr1:hide()
               oSayVp1:hide()
            end

            if !empty( aTmp[ 28 ] )
               aGet[ 30 ]:Show()
               oSayPr2:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp2, dbfPro ) )
               oSayPr2:Show()
               oSayVp2:Show()
            else
               aGet[ 30 ]:hide()
               aGet[ 30 ]:cText( Space( 20 ) )
               oSayPr2:SetText( "" )
               oSayPr2:Hide()
               oSayVp2:Hide()
            end

         end

      end





      cPrpArt              := aTmp[ 27 ] + aTmp[ 28 ] + aTmp[ 29 ] + aTmp[ 30 ]

      if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt )





         if oStkAct <> nil .AND. !uFieldEmpresa( "lNStkAct" ) .AND. aTmp[ 35 ] <= 1
            StocksModel():lPutStockActual( cCodArt, aTmp[ 38 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ], oStkAct )
         end



         if nMode == 1
            cCodFam        := RetFamArt( cCodArt, D():Articulos( nView ) )
         else
            cCodFam        := aTmp[53]
         end



         if !empty( aGet[ 9 ] )
               aGet[ 9 ]:cText( 0 )
            else
               aTmp[ 9 ] := 0
            end

            if !empty( aGet[ 32 ] )
               aGet[ 32 ]:cText( 0 )
            else
               aTmp[ 32 ] := 0
            end

            if !empty( aGet[ 10 ] )
               aGet[ 10 ]:cText( 0 )
            else
               aTmp[ 10 ]:= 0
            end

            aTmp[ 73  ] := .F.





         aGet[ 7 ]:cText( ( D():Articulos( nView ) )->nPntVer1 )
         aTmp[ 37 ]   := ( D():Articulos( nView ) )->PvpRec





         if !empty( aGet[ 16 ] )
            aGet[ 16 ]:cText( ( D():Articulos( nView ) )->cUnidad )
         else
            aTmp[ 16 ]  := ( D():Articulos( nView ) )->cUnidad
         end



         nPrePro           := nPrePro( aTmp[ 4 ], aTmp[ 27 ], aTmp[ 29 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 71 ], aTmpFac[ 58 ], dbfArtDiv, dbfTarPreL, aTmpFac[22] )

         if nPrePro == 0
            aGet[ 6]:cText( nRetPreArt( aTmp[ 71 ], aTmpFac[ 60 ], aTmpFac[ 58 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp ) )
         else
            aGet[ 6]:cText( nPrePro )
         end



         if !empty( aTmpFac[ 22 ] )


            nImpOfe  := RetPrcTar( cCodArt, aTmpFac[ 22 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], dbfTarPreL, aTmp[ 71 ] )
            if nImpOfe <> 0
               aGet[ 6]:cText( nImpOfe )
            end


            nImpOfe  := RetPctTar( cCodArt, cCodFam, aTmpFac[ 22 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], dbfTarPreL )
            if nImpOfe <> 0
               aGet[ 9   ]:cText( nImpOfe )
            end


            nImpOfe  := RetLinTar( cCodArt, cCodFam, aTmpFac[22], aTmp[27], aTmp[28], aTmp[29], aTmp[30], dbfTarPreL )
            if nImpOfe <> 0
               aGet[ 32]:cText( nImpOfe )
            end


            nImpOfe  := RetComTar( cCodArt, cCodFam, aTmpFac[22], aTmp[27], aTmp[28], aTmp[29], aTmp[30], aTmpFac[20], dbfTarPreL, dbfTarPreS )
            if nImpOfe <> 0
               aGet[ 17]:cText( nImpOfe )
            end



            nImpOfe  := RetDtoPrm( cCodArt, cCodFam, aTmpFac[22], aTmp[27], aTmp[28], aTmp[29], aTmp[30], aTmpFac[6], dbfTarPreL )
            if nImpOfe  <> 0
               aGet[ 10]:cText( nImpOfe )
            end



            nDtoAge     := RetDtoAge( cCodArt, cCodFam, aTmpFac[22], aTmp[27], aTmp[28], aTmp[29], aTmp[30], aTmpFac[6], aTmpFac[20], dbfTarPreL, dbfTarPreS )
            if nDtoAge  <> 0
               aGet[ 17 ]:cText( nDtoAge )
            end

         end





        hAtipica := hAtipica( hValue( aTmp, aTmpFac ) )

        if !empty( hAtipica )

            if hhaskey( hAtipica, "nTarifaFamilia" ) .AND. hAtipica[ "nTarifaFamilia" ] > 0
                aGet[ 6 ]:cText( nRetPreArt( hAtipica[ "nTarifaFamilia" ], aTmpFac[ 60 ], aTmpFac[ 58 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp ) )
            end

            if hhaskey( hAtipica, "nImporte" )
                if hAtipica[ "nImporte" ] <> 0
                    aGet[ 6 ]:cText( hAtipica[ "nImporte" ] )
                end
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
                if hAtipica[ "nDescuentoPorcentual"] <> 0
                    aGet[ 9 ]:cText( hAtipica[ "nDescuentoPorcentual"] )
                end
            end

            if hhaskey( hAtipica, "nDescuentoPromocional" )
                if hAtipica[ "nDescuentoPromocional" ] <> 0
                    aGet[ 10 ]:cText( hAtipica[ "nDescuentoPromocional" ] )
                end
            end

            if hhaskey( hAtipica, "nComisionAgente" )
                if hAtipica[ "nComisionAgente" ] <> 0
                    aGet[ 17 ]:cText( hAtipica[ "nComisionAgente" ] )
                end
            end

            if hhaskey( hAtipica, "nDescuentoLineal" )
                if hAtipica[ "nDescuentoLineal" ] <> 0
                    aGet[ 32 ]:cText( hAtipica[ "nDescuentoLineal" ] )
                end
            end

        end



         nImpOfe     := nImpOferta( cCodArt, aTmpFac[ 7 ], aTmpFac[81], aTmp[ 18 ], aTmpFac[ 6 ], dbfOferta, aTmp[ 71 ], , aTmp[27], aTmp[28], aTmp[29], aTmp[30] )
         if nImpOfe  <> 0
            aGet[ 6 ]:cText( nCnv2Div( nImpOfe, cDivEmp(), aTmpFac[ 60 ] ) )
         end



         nImpOfe     := nDtoOferta( cCodArt, aTmpFac[ 7 ], aTmpFac[81], aTmp[ 18 ], aTmpFac[ 6 ], dbfOferta, aTmp[27], aTmp[28], aTmp[29], aTmp[30] )
         if nImpOfe  <> 0
            aGet[ 9]:cText( nImpOfe )
         end



         nImpOfe     := nDtoLineal( cCodArt, aTmpFac[ 7 ], aTmpFac[81], aTmp[ 18 ], aTmpFac[ 6 ], dbfOferta, aTmp[27], aTmp[28], aTmp[29], aTmp[30] )
         if nImpOfe  <> 0
            aGet[ 32 ]:cText( nImpOfe )
         end

         ValidaMedicion( aTmp, aGet )

      end





      lBuscaOferta( cCodArt, aGet, aTmp, aTmpFac, dbfOferta, dbfDiv, dbfKit, dbfIva  )





      cOldPrpArt  := cPrpArt
      cOldCodArt  := cCodArt





      if empty( aTmp[ 6 ] ) .OR. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) )
         aGet[ 6 ]:HardEnable()
         aGet[ 8  ]:HardEnable()
         aGet[ 7  ]:HardEnable()
         aGet[ 9     ]:HardEnable()
         aGet[ 10  ]:HardEnable()
         aGet[ 32  ]:HardEnable()
      else
         aGet[ 6 ]:HardDisable()
         aGet[ 8  ]:HardDisable()
         aGet[ 7  ]:HardDisable()
         aGet[ 9     ]:HardDisable()
         aGet[ 10  ]:HardDisable()
         aGet[ 32  ]:HardDisable()
      end

      CursorWE()

   else

      MsgStop( "Artículo no encontrado" )
      Return .F.

   end

RETURN .T.







STATIC FUNCTION loaCli( aGet, aTmp, nMode, oRieCli, oTlfCli )

   local lValid      := .T.
   local cNewCodCli  := aGet[ 7 ]:varGet()
   local lChgCodCli  := ( empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if empty( cNewCodCli )
      Return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[ 7 ], "0", RetNumCodCliEmp() )
   else
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodCliEmp() )
   end

   if ( D():Clientes( nView ) )->( dbSeek( cNewCodCli ) )





      aGet[ 7 ]:cText( ( D():Clientes( nView ) )->Cod )

      if oTlfCli <> nil
         oTlfCli:SetText( ( D():Clientes( nView ) )->Telefono )
      end

      if ( D():Clientes( nView ) )->nColor <> 0
         aGet[ 10]:SetColor( , ( D():Clientes( nView ) )->nColor )
      end

      if empty( aGet[ 10]:varGet() ) .OR. lChgCodCli
         aGet[ 10]:cText( ( D():Clientes( nView ) )->Titulo )
      end

      if empty( aGet[ 11]:varGet() ) .OR. lChgCodCli
         aGet[ 11]:cText( ( D():Clientes( nView ) )->Domicilio )
      end

      if empty( aGet[ 89 ]:varGet() ) .OR. lChgCodCli
         aGet[ 89 ]:cText( ( D():Clientes( nView ) )->Telefono )
      end

      if empty( aGet[ 12]:varGet() ) .OR. lChgCodCli
         aGet[ 12]:cText( ( D():Clientes( nView ) )->Poblacion )
      end

      if empty( aGet[ 13]:varGet() ) .OR. lChgCodCli
         aGet[ 13]:cText( ( D():Clientes( nView ) )->Provincia )
      end

      if empty( aGet[ 15]:varGet() ) .OR. lChgCodCli
         aGet[ 15]:cText( ( D():Clientes( nView ) )->CodPostal )
      end

      if empty( aGet[ 16 ]:varGet() ) .OR. lChgCodCli
         aGet[ 16 ]:cText( ( D():Clientes( nView ) )->Nif )
      end





      if ( lChgCodCli ) .AND. !empty( aGet[ 23 ] )

         if dbSeekInOrd( cNewCodCli, "lDefObr", dbfObrasT )
            aGet[ 23 ]:cText( ( dbfObrasT )->cCodObr )
         else
            aGet[ 23 ]:cText( Space( 10 ) )
         end

         aGet[ 23 ]:lValid()

      end

      if empty( aTmp[ 81 ] ) .OR. lChgCodCli
         aTmp[ 81 ]  := ( D():Clientes( nView ) )->cCodGrp
      end

      if lChgCodCli
         aTmp[ 17 ]  := ( D():Clientes( nView ) )->lModDat
      end

      if ( lChgCodCli )
         aTmp[ 101 ]  := ( D():Clientes( nView ) )->lPntVer
      end

      if nMode == 1

         aTmp[65 ]   := ( D():Clientes( nView ) )->nRegIva





         lChangeRegIva( aTmp )





         if empty( aTmp[ 1 ] )

            if !empty( ( D():Clientes( nView ) )->Serie )
               aGet[ 1 ]:cText( ( D():Clientes( nView ) )->Serie )
            end

         else



            if !empty( ( D():Clientes( nView ) )->Serie )               .AND. aTmp[ 1 ] <> ( D():Clientes( nView ) )->Serie      .AND. ApoloMsgNoYes( "La serie del cliente seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( D():Clientes( nView ) )->Serie )
            end

         end

         if ( empty( aGet[ 8]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( D():Clientes( nView ) )->cCodAlm )
            aGet[ 8]:cText( ( D():Clientes( nView ) )->cCodAlm )
            aGet[ 8]:lValid()
         end

         if ( empty( aGet[ 22]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( D():Clientes( nView ) )->cCodTar )
            aGet[ 22]:cText( ( D():Clientes( nView ) )->CCODTAR )
            aGet[ 22]:lValid()
         end

         if ( empty( aGet[ 34]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( D():Clientes( nView ) )->CodPago )

            aGet[ 34]:cText( (D():Clientes( nView ))->CODPAGO )
            aGet[ 34]:lValid()





               if lBancoDefecto( ( D():Clientes( nView ) )->Cod, dbfCliBnc )

                  if !empty( aGet[ 94 ] ) .OR. lChgCodCli
                     aGet[ 94 ]:cText( ( dbfCliBnc )->cCodBnc )
                     aGet[ 94 ]:lValid()
                  else
                     aTmp[ 94 ]   := ( dbfCliBnc )->cCodBnc
                  end

                  if !empty( aGet[ 95 ] ) .OR. lChgCodCli
                     aGet[ 95 ]:cText( ( dbfCliBnc )->cPaisIBAN )
                     aGet[ 95 ]:lValid()
                  else
                     aTmp[ 95 ]   := ( dbfCliBnc )->cPaisIBAN
                  end

                  if !empty( aGet[ 96 ] ) .OR. lChgCodCli
                     aGet[ 96 ]:cText( ( dbfCliBnc )->cCtrlIBAN )
                     aGet[ 96 ]:lValid()
                  else
                     aTmp[ 96 ]   := ( dbfCliBnc )->cCtrlIBAN
                  end

                  if !empty( aGet[ 97 ] ) .OR. lChgCodCli
                     aGet[ 97 ]:cText( ( dbfCliBnc )->cEntBnc )
                     aGet[ 97 ]:lValid()
                  else
                     aTmp[ 97 ]  := ( dbfCliBnc )->cEntBnc
                  end

                  if !empty( aGet[ 98 ] ) .OR. lChgCodCli
                     aGet[ 98 ]:cText( ( dbfCliBnc )->cSucBnc )
                     aGet[ 98 ]:lValid()
                  else
                     aTmp[ 98 ]  := ( dbfCliBnc )->cSucBnc
                  end

                  if !empty( aGet[ 99 ] ) .OR. lChgCodCli
                     aGet[ 99 ]:cText( ( dbfCliBnc )->cDigBnc )
                     aGet[ 99 ]:lValid()
                  else
                     aTmp[ 99 ]  := ( dbfCliBnc )->cDigBnc
                  end

                  if !empty( aGet[ 100 ] ) .OR. lChgCodCli
                     aGet[ 100 ]:cText( ( dbfCliBnc )->cCtaBnc )
                     aGet[ 100 ]:lValid()
                  else
                     aTmp[ 100 ]  := ( dbfCliBnc )->cCtaBnc
                  end

               end

         end

         if ( empty( aGet[ 20]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( D():Clientes( nView ) )->cAgente )
            aGet[ 20]:cText( (D():Clientes( nView ))->CAGENTE )
            aGet[ 20]:lValid()
         end

         if ( empty( aGet[ 21]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( D():Clientes( nView ) )->cCodRut )
            aGet[ 21]:cText( ( D():Clientes( nView ))->CCODRUT )
            aGet[ 21]:lValid()
         end

         if !empty( oGetTarifa )
             if ( empty( oGetTarifa:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( D():Clientes( nView ) )->nTarifa )
                oGetTarifa:getTarifa( ( D():Clientes( nView ) )->nTarifa )
             end
         endif

         if ( empty( aTmp[ 102 ] ) .OR. lChgCodCli )
             aTmp[ 102 ]    := ( D():Clientes( nView ) )->nDtoArt
         end

         if !empty( aGet[ 72 ] ) .AND. ( empty( aGet[ 72 ]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( D():Clientes( nView ) )->cCodTrn )
            aGet[ 72 ]:cText( ( D():Clientes( nView ) )->cCodTrn )
            aGet[ 72 ]:lValid()
         end

         if lChgCodCli

            aGet[ 56 ]:Click( ( D():Clientes( nView ) )->lReq )

            aGet[ 101  ]:Click( ( D():Clientes( nView ) )->lPntVer )











            if !empty( aGet[ 77 ] )
               aGet[ 77  ]:cText( ( D():Clientes( nView ) )->nPctRet )
            else
               aTmp[ 77  ] := ( D():Clientes( nView ) )->nPctRet
            end





            if !uFieldempresa( "lDtoCliLin" )
                aGet[ 41 ]:cText( ( D():Clientes( nView ) )->cDtoEsp )
                aGet[ 42 ]:cText( ( D():Clientes( nView ) )->nDtoEsp )
            end

            aGet[ 43    ]:cText( ( D():Clientes( nView ) )->cDpp    )

            aGet[ 44    ]:cText( ( D():Clientes( nView ) )->nDpp    )

            aGet[ 45 ]:cText( ( D():Clientes( nView ) )->cDtoUno )

            aGet[ 47 ]:cText( ( D():Clientes( nView ) )->cDtoDos )

            aGet[ 46 ]:cText( ( D():Clientes( nView ) )->nDtoCnt )

            aGet[ 48 ]:cText( ( D():Clientes( nView ) )->nDtoRap )

         end

      end

      if ( D():Clientes( nView ) )->lMosCom .AND. !empty( ( D():Clientes( nView ) )->mComent ) .AND. lChgCodCli
         MsgStop( Trim( ( D():Clientes( nView ) )->mComent ) )
      end

      if !empty( oRieCli ) .AND. lChgCodCli
         oStock:SetRiesgo( cNewCodCli, oRieCli, ( D():Clientes( nView ) )->Riesgo )
      end

      ShowIncidenciaCliente( ( D():Clientes( nView ) )->Cod, nView )

      cOldCodCli  := ( D():Clientes( nView ) )->Cod

      lValid      := .T.

   else

        msgStop( "Cliente no encontrado" )

      lValid      := .F.

   end

RETURN lValid







STATIC FUNCTION BeginTrans( aTmp, nMode )

   local oError
   local oBlock
   local lErrors  := .F.
   local cDbfLin  := "FCliL"
   local cDbfInc  := "FCliI"
   local cDbfDoc  := "FCliD"
   local cDbfAnt  := "FCliA"
   local cDbfPgo  := "FCliP"
   local cDbfSer  := "FCliS"
   local cDbfEst  := "FCliE"
   local nOrd
   local cFac     := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]

   CursorWait()

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   cTmpLin        := cGetNewFileName( cPatTmp() + cDbfLin )
   cTmpInc        := cGetNewFileName( cPatTmp() + cDbfInc )
   cTmpDoc        := cGetNewFileName( cPatTmp() + cDbfDoc )
   cTmpAnt        := cGetNewFileName( cPatTmp() + cDbfAnt )
   cTmpPgo        := cGetNewFileName( cPatTmp() + cDbfPgo )
   cTmpSer        := cGetNewFileName( cPatTmp() + cDbfSer )
   cTmpEst        := cGetNewFileName( cPatTmp() + cDbfEst )





   aNumAlb        := {}





   do case
   case nMode == 1 .OR. nMode == 4

      nTotOld     := 0

   case nMode == 2

      nTotOld     := nTotFac

   end





   dbCreate( cTmpLin, aSqlStruct( aColFacRec() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpLin, cCheckArea( cDbfLin, @dbfTmpLin ), .F. )
   if !NetErr()

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "nPosPrint", "Str( nPosPrint, 4 )", {|| Str( Field->nPosPrint ) } ) )

      if ( D():FacturasRectificativasLineas( nView ) )->( dbSeek( cFac ) )
         while ( ( D():FacturasRectificativasLineas( nView ) )->CSERIE + Str( ( D():FacturasRectificativasLineas( nView ) )->NNUMFAC ) + ( D():FacturasRectificativasLineas( nView ) )->CSUFFAC ) == cFac .AND. !( D():FacturasRectificativasLineas( nView ) )->( eof() )
            dbPass( D():FacturasRectificativasLineas( nView ), dbfTmpLin, .T. )
            ( D():FacturasRectificativasLineas( nView ) )->( DbSkip() )
         end
      endif

      ( dbfTmpLin )->( dbGoTop() )

   else

      lErrors     := .T.

   end





   dbCreate( cTmpInc, aSqlStruct( aIncFacRec() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )
   if !NetErr()
      ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpInc )->( ordCreate( cTmpInc, "Recno", "Recno()", {|| Recno() } ) )

      if ( dbfFacRecI )->( dbSeek( cFac ) )
         while ( ( dbfFacRecI )->cSerie + Str( ( dbfFacRecI )->nNumFac ) + ( dbfFacRecI )->cSufFac == cFac ) .AND. ( dbfFacRecI )->( !eof() )
            dbPass( dbfFacRecI, dbfTmpInc, .T. )
            ( dbfFacRecI )->( dbSkip() )
         end
      end

      ( dbfTmpInc )->( dbGoTop() )

   else

      lErrors     := .T.

   end





   dbCreate( cTmpDoc, aSqlStruct( aFacRecDoc() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )
   if !NetErr()
      ( dbfTmpDoc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpDoc )->( ordCreate( cTmpDoc, "Recno", "Recno()", {|| Recno() } ) )

      if ( dbfFacRecD )->( dbSeek( cFac ) )
         while ( ( dbfFacRecD )->cSerFac + Str( ( dbfFacRecD )->nNumFac ) + ( dbfFacRecD )->cSufFac == cFac ) .AND. ( dbfFacRecD )->( !eof() )
            dbPass( dbfFacRecD, dbfTmpDoc, .T. )
            ( dbfFacRecD )->( dbSkip() )
         end
      end

      ( dbfTmpDoc )->( dbGoTop() )

   else

      lErrors     := .T.

   end





   dbCreate( cTmpSer, aSqlStruct( aSerFacRec() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpSer, cCheckArea( cDbfSer, @dbfTmpSer ), .F. )

   if !( dbfTmpSer )->( NetErr() )

      ( dbfTmpSer )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpSer )->( OrdCreate( cTmpSer, "nNumLin", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin, 4 ) + Field->cRef } ) )

      if ( dbfFacRecS )->( dbSeek( cFac ) )
         while ( ( dbfFacRecS )->cSerFac + Str( ( dbfFacRecS )->nNumFac ) + ( dbfFacRecS )->cSufFac == cFac ) .AND. !( dbfFacRecS )->( eof() )
            dbPass( dbfFacRecS, dbfTmpSer, .T. )
            ( dbfFacRecS )->( dbSkip() )
         end
      end

      ( dbfTmpSer )->( dbGoTop() )

      oStock:SetTmpFacRecS( dbfTmpSer )

   end





   dbCreate( cTmpPgo, aSqlStruct( aItmRecCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpPgo, cCheckArea( cDbfPgo, @dbfTmpPgo ), .F. )

   if !NetErr()

      ( dbfTmpPgo )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfTmpPgo )->( ordCreate( cTmpPgo , "cRecDev", "cRecDev", {|| Field->cRecDev } ) )

      ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpPgo )->( ordCreate( cTmpPgo, "nNumFac", "cSerie + Str( nNumFac ) + cSufFac + Str( nNumRec ) + cTipRec", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumRec ) + Field->cTipRec } ) )

      ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfTmpPgo )->( ordCreate( cTmpPgo, "cNumMtr", "Field->cNumMtr", {|| Field->cNumMtr } ) )

      ( dbfTmpPgo )->( ordCondSet("!Deleted() .and. Field->cTipRec == 'R'", {|| !Deleted() .AND. Field->cTipRec == "R" } ) )
      ( dbfTmpPgo )->( ordCreate( cTmpPgo, "rNumFac", "cSerie + str( nNumFac ) + cSufFac + str( nNumRec )", {|| Field->CSERIE + str( Field->NNUMFAC ) + Field->CSUFFAC + str( Field->NNUMREC ) } ) )

      nOrd        := ( dbfFacCliP )->( OrdSetFocus( "rNumFac" ) )

      if ( dbfFacCliP )->( dbSeek( cFac ) ) .AND. nMode <> 4
         while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFac .AND. ( dbfFacCliP )->( !eof() )
            dbPass( dbfFacCliP, dbfTmpPgo, .T. )
            ( dbfFacCliP )->( dbSkip() )
         end
      end

      ( dbfTmpPgo  )->( dbGoTop() )

      ( dbfFacCliP )->( OrdSetFocus( nOrd ) )

   else

      lErrors     := .T.

   end





    dbCreate( cTmpEst, aSqlStruct( aFacRecEst() ), cLocalDriver() )
       dbUseArea( .T., cLocalDriver(), cTmpEst, cCheckArea( cDbfEst, @dbfTmpEst ), .F. )

      if !NetErr()

          ( dbfTmpEst )->( ordCreate( cTmpEst, "nNumFac", "cSerFac + str( nNumFac ) + cSufFac + dtos( dFecSit )  + tFecSit", {|| Field->cSerFac + str( Field->nNumFac ) + Field->cSufFac + dtos( Field->dFecSit )  + Field->tFecSit } ) )
       ( dbfTmpEst )->( ordListAdd( cTmpEst ) )

        if ( D():FacturasRectificativasSituaciones( nView ) )->( dbSeek( cFac ) )

            while ( ( D():FacturasRectificativasSituaciones( nView ) )->cSerFac + Str( ( D():FacturasRectificativasSituaciones( nView ) )->nNumFac ) + ( D():FacturasRectificativasSituaciones( nView ) )->cSufFac == cFac ) .AND. ( D():FacturasRectificativasSituaciones( nView ) )->( !eof() )

            dbPass( D():FacturasRectificativasSituaciones( nView ), dbfTmpEst, .T. )

            ( D():FacturasRectificativasSituaciones( nView ) )->( dbSkip() )

         end

         end

         ( dbfTmpEst )->( dbGoTop() )

      else

      lErrors     := .T.

      end

   oDetCamposExtra:SetTemporal( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "", nMode )

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

   CursorWE()

Return ( lErrors )






STATIC FUNCTION EndTrans( aTmp, aGet, oBrw, oBrwDet, oBrwPgo, aNumAlb, nMode, oDlg, oFld )

   local n
   local cSerFac
   local nNumFac
   local cSufFac
   local dFecFac
   local oError
   local oBlock
   local cCodCli

   if empty( aTmp[ 1 ] )
      aTmp[ 1 ]   := "A"
   end

   cSerFac              := aTmp[ 1  ]
   nNumFac              := aTmp[ 2 ]
   cSufFac              := aTmp[ 3 ]
   dFecFac              := aTmp[ 6 ]
   cCodCli              := aTmp[ 7 ]

   if !lValidaOperacion( aTmp[ 6 ] )
      Return .F.
   end

   if !lValidaSerie( aTmp[ 1 ] )
      Return .F.
   end

   if ( nMode == 1 .OR. nMode == 4 ) .AND. empty( aTmp[ 39 ] )
      MsgStop( "Debe de indicar la factura que quiere rectificar." )
      aGet[ 39 ]:SetFocus()
      return .F.
   end

   if !( isAviableClient( nView ) )
      return .F.
   end

   if empty( aTmp[ 10 ] )
      msgStop( "Nombre de cliente no puede estar vacio." )
      aGet[ 10 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 11 ] )
      msgStop( "Domicilio de cliente no puede estar vacio." )
      aGet[ 11 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 16 ] )
      msgStop( "D.N.I. / C.I.F. de cliente no puede estar vacio." )
      aGet[ 16 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 8 ] )
      msgStop( "Almacén no puede estar vacio." )
      aGet[ 8 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 34 ] )
      msgStop( "Forma de pago no puede estar vacia." )
      aGet[ 34 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 60 ] )
      MsgStop( "No puede almacenar documento sin código de divisa." )
      aGet[ 60 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 20 ] ) .AND. lRecogerAgentes()
      msgStop( "Agente no puede estar vacio." )
      aGet[ 20 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 23 ] ) .AND. lObras() .AND. ( ClientesDireccionesModel():nCount( aTmp[ 7 ] ) > 0 )
      MsgStop( "Debe de introducir una obra." )
      aGet[ 23 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 87 ] )
      MsgStop( "Debe indicar un motivo para la factura rectificativa." )
      oFld:SetOption( 2 )
      aGet[ 87 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 88 ] )
      MsgStop( "Debe indicar una causa por la que se emite la factura rectificativa." )
      oFld:SetOption( 2 )
      aGet[ 88 ]:SetFocus()
      return .F.
   end

   if ( dbfTmpLin )->( eof() )
      MsgStop( "No puede almacenar un documento sin lineas." )
      return .F.
   end

   if lPasNil() .AND. ( nMode == 1 .OR. nMode == 4 )

      ( dbfTmpLin )->( dbGoTop() )
      while !( dbfTmpLin )->( eof() )

         if !( dbfTmpLin )->lControl .AND. ( dbfTmpLin )->nPreUnit == 0 .AND. !( dbfTmpLin )->lKitPrc
            if !ApoloMsgNoYes( "El artículo " + Rtrim( ( dbfTmpLin )->cRef ) + " - " + Rtrim( Descrip( dbfTmpLin ) ) + " no esta valorado.", "¿Desea continuar archivando la factura?" )
               return .F.
            end
         end

         ( dbfTmpLin )->( dbSkip() )

      end

   end





   CursorWait()

   oDlg:Disable()

   oMsgText( "Archivando" )

   BeginTransaction()

   aTmp[ 79 ]     := GetSysDate()
   aTmp[ 80 ]     := Time()
   aTmp[ 19 ]        := oGetTarifa:getTarifa()

   TComercio:resetProductsToUpdateStocks()

   ( dbfTmpLin )->( dbClearFilter() )





   do case
   case isAppendOrDuplicateMode( nMode )





      nNumFac           := nNewDoc( cSerFac, D():FacturasRectificativas( nView ), "nFacRec", , dbfCount )
      aTmp[ 2 ]  := nNumFac
      cSufFac           := retSufEmp()
      aTmp[ 3 ]  := cSufFac
      aTmp[ 30 ]  := !empty( aNumAlb )

   case isEditMode( nMode )

      while ( D():FacturasRectificativasLineas( nView ) )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( D():FacturasRectificativasLineas( nView ) )->( eof() )

         TComercio:appendProductsToUpadateStocks( ( D():FacturasRectificativasLineas( nView ) )->cRef, nView )

         if dbLock( D():FacturasRectificativasLineas( nView ) )
            ( D():FacturasRectificativasLineas( nView ) )->( dbDelete() )
            ( D():FacturasRectificativasLineas( nView ) )->( dbUnLock() )
         end

      end





      while ( dbfFacRecI )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( dbfFacRecI )->( eof() )
         if dbLock( dbfFacRecI )
            ( dbfFacRecI )->( dbDelete() )
            ( dbfFacRecI )->( dbUnLock() )
         end
      end





      while ( dbfFacRecD )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( dbfFacRecD )->( eof() )
         if dbLock( dbfFacRecD )
            ( dbfFacRecD )->( dbDelete() )
            ( dbfFacRecD )->( dbUnLock() )
         end
      end





      while ( dbfFacRecS )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( dbfFacRecS )->( eof() )
         if dbLock( dbfFacRecS )
            ( dbfFacRecS )->( dbDelete() )
            ( dbfFacRecS )->( dbUnLock() )
         end
      end





      while ( dbfFacCliP )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) .AND. !( dbfFacCliP )->( eof() ) )
         if dbLock( dbfFacCliP )
            ( dbfFacCliP )->( dbDelete() )
            ( dbfFacCliP )->( dbUnLock() )
         end
      end





      while ( D():FacturasRectificativasSituaciones( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) )
         if dbLock( D():FacturasRectificativasSituaciones( nView ) )
           ( D():FacturasRectificativasSituaciones( nView ) )->( dbDelete() )
           ( D():FacturasRectificativasSituaciones( nView ) )->( dbUnLock() )
         end
      end

   end





   oMsgProgress()
   oMsgProgress():SetRange( 0, ( dbfTmpLin )->( LastRec() ) )





   ( dbfTmpLin )->( dbGoTop() )
   while ( dbfTmpLin )->( !eof() )

      ( dbfTmpLin )->nRegIva    := aTmp[ 65 ]

      if ( dbfTmpLin )->dFecFac <> aTmp[ 6 ]
         ( dbfTmpLin )->dFecFac := aTmp[ 6 ]
      end

      TComercio:appendProductsToUpadateStocks( ( dbfTmpLin )->cRef, nView )

      dbPass( dbfTmpLin, D():FacturasRectificativasLineas( nView ), .T., cSerFac, nNumFac, cSufFac )

      ( dbfTmpLin )->( dbSkip() )

      oMsgProgress():Deltapos(1)

   end





   ( dbfTmpInc )->( dbGoTop() )
   while ( dbfTmpInc )->( !eof() )
      dbPass( dbfTmpInc, dbfFacRecI, .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpInc )->( dbSkip() )
   end





   ( dbfTmpDoc )->( dbGoTop() )
   while ( dbfTmpDoc )->( !eof() )
      dbPass( dbfTmpDoc, dbfFacRecD, .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpDoc )->( dbSkip() )
   end





   ( dbfTmpSer )->( dbGoTop() )
   while ( dbfTmpSer )->( !eof() )
      dbPass( dbfTmpSer, dbfFacRecS, .T., cSerFac, nNumFac, cSufFac, dFecFac )
      ( dbfTmpSer )->( dbSkip() )
   end





   ( dbfTmpPgo )->( dbGoTop() )
   while ( dbfTmpPgo )->( !eof() )

      if ( dbfTmpPgo )->cCodCli <> aTmp[ 7 ]
         ( dbfTmpPgo )->cCodCli := aTmp[ 7 ]
      end

      if ( dbfTmpPgo )->cNomCli <> aTmp[ 10 ]
         ( dbfTmpPgo )->cNomCli := aTmp[ 10 ]
      end


      if !empty( aTmp[ 104 ] )
         ( dbfTmpPgo )->cCtrCoste := aTmp[ 104 ]
      endif

      dbPass( dbfTmpPgo, dbfFacCliP, .T., cSerFac, nNumFac, cSufFac )

      ( dbfTmpPgo )->( dbSkip() )

   end





   ( dbfTmpEst )->( dbgotop() )
    while ( dbfTmpEst )->( !eof() )
      dbPass( dbfTmpEst, D():FacturasRectificativasSituaciones( nView ), .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpEst )->( dbSkip() )
   end





   aTmp[ 90 ]  := nTotNet
   aTmp[ 91 ]  := nTotIva
   aTmp[ 92 ]  := nTotReq
   aTmp[ 93 ]  := nTotFac

   oDetCamposExtra:saveExtraField( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "" )





   WinGather( aTmp, , D():FacturasRectificativas( nView ), , nMode )





   if len( aNumAlb ) > 0
      for n := 1 to len( aNumAlb )
         if ( dbfAlbCliT )->( dbSeek( aNumAlb[n] ) )
            if dbLock( dbfAlbCliT )
               delRiesgo( nTotAlbCli( aNumAlb[ n ], dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv ), ( dbfAlbCliT )->cCodCli, D():Clientes( nView ) )
               ( dbfAlbCliT )->lFacturado := .T.
               ( dbfAlbCliT )->cNumFac    := cSerFac + Str( nNumFac ) + cSufFac
               ( dbfAlbCliT )->( dbUnlock() )
            end
         end
      next
   end

   CommitTransaction()





   GenPgoFacRec( cSerFac + Str( nNumFac ) + cSufFac, D():FacturasRectificativas( nView ), D():FacturasRectificativasLineas( nView ), dbfFacCliP, D():Clientes( nView ), dbfFPago, dbfDiv, dbfIva, nMode )





   ChkLqdFacRec( nil, D():FacturasRectificativas( nView ), D():FacturasRectificativasLineas( nView ), dbfFacCliP, dbfIva, dbfDiv )





   oMsgText()

   EndProgress()



   TComercio:updateWebProductStocks()

   oDlg:Enable()
   oDlg:end( 1 )

   CursorWE()

Return .T.



Static Function KillTrans( oBrwDet, oBrwInc, oBrwPgo )





   if !empty( dbfTmpLin ) .AND. ( dbfTmpLin )->( Used() )
      ( dbfTmpLin )->( dbCloseArea() )
   end

   if !empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !empty( dbfTmpAnt ) .AND. ( dbfTmpAnt )->( Used() )
      ( dbfTmpAnt )->( dbCloseArea() )
   end

   if !empty( dbfTmpPgo ) .AND. ( dbfTmpPgo )->( Used() )
      ( dbfTmpPgo )->( dbCloseArea() )
   end

   if !empty( dbfTmpSer ) .AND. ( dbfTmpSer )->( Used() )
      ( dbfTmpSer )->( dbCloseArea() )
   end

   if !empty( dbfTmpEst ) .AND. ( dbfTmpEst )->( Used() )
      ( dbfTmpEst )->( dbCloseArea() )
   end

   dbfTmpLin      := nil
   dbfTmpInc      := nil
   dbfTmpDoc      := nil
   dbfTmpAnt      := nil
   dbfTmpPgo      := nil
   dbfTmpSer      := nil
   dbfTmpEst      := nil

   dbfErase( cTmpLin )
   dbfErase( cTmpInc )
   dbfErase( cTmpDoc )
   dbfErase( cTmpAnt )
   dbfErase( cTmpPgo )
   dbfErase( cTmpSer )
   dbfErase( cTmpEst )

RETURN NIL






STATIC FUNCTION CreateFiles( cPath, lReindex )

   If( lReindex == nil, lReindex := .T., ) ;

   if !lExistTable( cPath + "FacRecT.DBF", cLocalDriver() )
      dbCreate( cPath + "FacRecT.DBF", aSqlStruct( aItmFacRec() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "FacRecL.DBF", cLocalDriver() )
      dbCreate( cPath + "FacRecL.DBF", aSqlStruct( aColFacRec() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "FacRecI.DBF", cLocalDriver() )
      dbCreate( cPath + "FacRecI.DBF", aSqlStruct( aIncFacRec() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "FacRecD.DBF", cLocalDriver() )
      dbCreate( cPath + "FacRecD.DBF", aSqlStruct( aFacRecDoc() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "FacRecS.Dbf", cLocalDriver() )
      dbCreate( cPath + "FacRecS.Dbf", aSqlStruct( aSerFacRec() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "FacRecE.Dbf", cLocalDriver() )
      dbCreate( cPath + "FacRecE.Dbf", aSqlStruct( aFacRecEst() ), cLocalDriver() )
   end

   if lReindex
      rxFacRec( cPath, , cLocalDriver() )
   end

RETURN NIL



static function lGenFacRec( oBrw, oBtn, nDevice )

   local bAction

   If( nDevice == nil, nDevice := 1, ) ;

   if empty( oBtn )
      return nil
   end

   if !( D():Documentos( nView ) )->( dbSeek( "FR" ) )








         oWndBrw:NewAt( "GC_DOCUMENT_WHITE_",,, {||( msgStop( "No hay facturas rectificativas de clientes predefinidas" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   ELSE

      WHILE ( D():Documentos( nView ) )->CTIPO == "FR" .AND. !( D():Documentos( nView ) )->( eof() )

         bAction  := bGenFacRec( nDevice, "Imprimiendo facturas rectificativas de clientes", ( D():Documentos( nView ) )->CODIGO )

         oWndBrw:NewAt( "gc_document_white_", , , bAction, Rtrim( ( D():Documentos( nView ) )->cDescrip ) , , , , , oBtn )

         ( D():Documentos( nView ) )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenFacRec( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle  )
   local cCod  := by( cCodDoc )

   if nDev == 1
      bGen     := {|| GenFacRec( nDev, cTit, cCod ) }
   else
      bGen     := {|| GenFacRec( nDev, cTit, cCod ) }
   end

return ( bGen )



static function QuiFacRec()

   local nOrdAnt
   local cSerDoc
   local nNumDoc
   local cSufDoc

   if ( D():FacturasRectificativas( nView ) )->lCloFac .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar facturas cerradas los administradores." )
      return .F.
   end

   cSerDoc     := ( D():FacturasRectificativas( nView ) )->cSerie
   nNumDoc     := ( D():FacturasRectificativas( nView ) )->nNumFac
   cSufDoc     := ( D():FacturasRectificativas( nView ) )->cSufFac



   TComercio:resetProductsToUpdateStocks()

   nOrdAnt     := ( D():FacturasRectificativasLineas( nView ) )->( ordsetfocus( "nNumFac" ) )
   while ( D():FacturasRectificativasLineas( nView ) )->( dbseek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( D():FacturasRectificativasLineas( nView ) )->( eof() )

      TComercio:appendProductsToUpadateStocks( ( D():FacturasRectificativasLineas( nView ) )->cRef, nView )

      if dbDialogLock( D():FacturasRectificativasLineas( nView ) )
         ( D():FacturasRectificativasLineas( nView ) )->( dbdelete() )
         ( D():FacturasRectificativasLineas( nView ) )->( dbunlock() )
      end

      sysrefresh()

      ( D():FacturasRectificativasLineas( nView ) )->( dbskip() )

   end
   ( D():FacturasRectificativasLineas( nView ) )->( ordsetfocus( nOrdAnt ) )

   TComercio:updateWebProductStocks()



   nOrdAnt     := ( dbfFacCliP )->( ordsetfocus( "rNumFac" ) )
   while ( dbfFacCliP )->( dbSeek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacCliP )->( eof() )

      if dbDialogLock( dbfFacCliP )
         ( dbfFacCliP )->( dbdelete() )
         ( dbfFacCliP )->( dbunlock() )
      end

      sysrefresh()

      ( dbfFacCliP )->( dbSkip() )

   end

   ( dbfFacCliP )->( ordsetfocus( nOrdAnt ) )





   nOrdAnt     := ( dbfFacRecI )->( ordsetfocus( "nNumFac" ) )
   while ( dbfFacRecI )->( dbseek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacRecI )->( eof() )

      if dbDialogLock( dbfFacRecI )
         ( dbfFacRecI )->( dbdelete() )
         ( dbfFacRecI )->( dbunlock() )
      end

      sysrefresh()

      ( dbfFacRecI )->( dbskip() )

   end

   ( dbfFacRecI )->( ordsetfocus( nOrdAnt ) )





   nOrdAnt     := ( dbfFacRecD )->( ordsetfocus( "nNumFac" ) )
   while ( dbfFacRecD )->( dbseek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacRecD )->( eof() )

      if dbDialogLock( dbfFacRecD )
         ( dbfFacRecD )->( dbdelete() )
         ( dbfFacRecD )->( dbunlock() )
      end

      sysrefresh()

      ( dbfFacRecD )->( dbskip() )

   end

   ( dbfFacRecD )->( ordsetfocus( nOrdAnt ) )





   nOrdAnt     := ( dbfFacRecS )->( OrdSetFocus( "nNumFac" ) )
   while ( dbfFacRecS )->( dbSeek( cSerDoc + Str( nNumDoc ) + cSufDoc ) ) .AND. !( dbfFacRecS )->( eof() )

      if dbDialogLock( dbfFacRecS )
         ( dbfFacRecS )->( dbDelete() )
         ( dbfFacRecS )->( dbUnLock() )
      end

      sysrefresh()

      ( dbfFacRecS )->( dbSkip() )

   end

   ( dbfFacRecS )->( OrdSetFocus( nOrdAnt ) )





   if uFieldEmpresa( "LRECNUMFAC" )
        nPutDoc( cSerDoc, nNumDoc, cSufDoc, D():FacturasRectificativas( nView ), "nFacRec", , dbfCount )
   end





   if oWndBrw <> nil
      oWndBrw:Refresh()
   end

return .T.



STATIC FUNCTION aGetSelRec( oBrw, bAction, cTitle, lHide1, cTitle1, lHide2, cTitle2, bPreAction, bPostAction )

   local oDlg
   local oRad
   local nRad        := 1
   local aRet        := {}
   local oTree
   local oChk1
   local oChk2
   local lChk1       := .T.
   local lChk2       := .T.
   local nRecno      := ( D():FacturasRectificativas( nView ) )->( Recno() )
   local nOrdAnt     := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( 1 ) )
   local oSerIni
   local oSerFin
   local cSerIni     := ( D():FacturasRectificativas( nView ) )->cSerie
   local cSerFin     := ( D():FacturasRectificativas( nView ) )->cSerie
   local oDocIni
   local oDocFin
   local nDocIni     := ( D():FacturasRectificativas( nView ) )->nNumFac
   local nDocFin     := ( D():FacturasRectificativas( nView ) )->nNumFac
   local oSufIni
   local oSufFin
   local cSufIni     := ( D():FacturasRectificativas( nView ) )->cSufFac
   local cSufFin     := ( D():FacturasRectificativas( nView ) )->cSufFac
   local oMtrInf
   local nMtrInf
   local lFechas     := .T.
   local dDesde      := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dHasta      := Date()
   local oImageList
   local oBtnCancel

   If( cTitle == nil, cTitle := "", ) ;
   If( lHide1 == nil, lHide1 := .F., ) ;
   If( cTitle1 == nil, cTitle1 := "", ) ;
   If( lHide2 == nil, lHide2 := .F., ) ;
   If( cTitle2 == nil, cTitle2 := "", ) ;

   oImageList        := TImageList():New( 16, 16 )
   oImageList:AddMasked( TBitmap():Define( "gc_delete_12" ),    ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   oImageList:AddMasked( TBitmap():Define( "gc_check_12" ),  ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )

   oDlg = TDialog():New(,,,, cTitle, "SelectRango",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



   oRad := TRadMenu():Redefine( { | u | If( PCount()==0, nRad, nRad:= u ) }, oDlg,, { 80, 81 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 101, "Up16",,,,, {|Self|( dbFirst( D():FacturasRectificativas( nView ), "nNumFac", oDocIni, cSerIni, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 111, "Down16",,,,, {|Self|( dbLast( D():FacturasRectificativas( nView ), "nNumFac", oDocFin, cSerFin, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )






   oDocIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )






   oDocFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )





   oSufIni := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )





   oSufFin := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )



   oChk1 := TCheckBox():ReDefine( 160, { | u | If( PCount()==0, lChk1, lChk1:= u ) }, oDlg,,,,,,, .F.,, .F. )



   oChk2 := TCheckBox():ReDefine( 180, { | u | If( PCount()==0, lChk2, lChk2:= u ) }, oDlg,,,,,,, .F.,, .F. )







   TCheckBox():ReDefine( 300, { | u | If( PCount()==0, lFechas, lFechas:= u ) }, oDlg,,,,,,, .F.,, .F. )





   TGetHlp():ReDefine( 310, { | u | If( PCount()==0, dDesde, dDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





    TGetHlp():ReDefine( 320, { | u | If( PCount()==0, dHasta, dHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





   oTree             := TTreeView():Redefine( 170, oDlg )
   oTree:bLDblClick  := {|| TreeChanged( oTree ) }





   oMtrInf := TApoloMeter():ReDefine( 200, { | u | If( PCount()==0, nMtrInf, nMtrInf:= u ) },, oDlg, .F.,, "Proceso", .F.,,,, )

   oMtrInf:SetTotal( ( D():FacturasRectificativas( nView ) )->( OrdKeyCount() ) )




   TButton():ReDefine( 1, {||( MakSelRec( bAction, bPreAction, bPostAction, cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oTree, oBrw, oMtrInf, oBtnCancel ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart := {|| StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 ) }

   oDlg:AddFastKey( 116, {|| MakSelRec( bAction, bPreAction, bPostAction, cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oTree, oBrw, oMtrInf, oBtnCancel ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oTree:SetImageList( oImageList ) )}, oDlg:bRClicked,,, )

   ( D():FacturasRectificativas( nView ) )->( ordSetFocus( nOrdAnt ) )
   ( D():FacturasRectificativas( nView ) )->( dbGoTo( nRecNo ) )

   oImageList:End()

   oTree:Destroy()

   oBrw:SetFocus()
   oBrw:Refresh()

RETURN ( aRet )



Static Function StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 )

   if !empty( oBrw ) .AND. ( len( oBrw:oBrw:aSelected ) > 1 )

      oRad:SetOption( 1 )

   else

      oRad:SetOption( 2 )

      oSerIni:Enable()
      oSerFin:Enable()
      oDocIni:Enable()
      oDocFin:Enable()
      oSufIni:Enable()
      oSufFin:Enable()

   end

   if lHide1
      oChk1:Hide()
   else
      SetWindowText( oChk1:hWnd, cTitle1 )
      oChk1:Refresh()
   end

   if lHide2
      oChk2:Hide()
   else
      SetWindowText( oChk2:hWnd, cTitle2 )
      oChk2:Refresh()
   end

Return ( nil )



Static Function TreeChanged( oTree )

   local oItemTree   := oTree:GetItem()

   if !empty( oItemTree ) .AND. !empty( oItemTree:bAction )
      Eval( oItemTree:bAction )
   end

RETURN NIL



Static Function MakSelRec( bAction, bPreAction, bPostAction, cDocIni, cDocFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oTree, oBrw, oMtrInf, oBtnCancel )

   local n        := 0
   local nPos     := 0
   local nRec     := ( D():FacturasRectificativas( nView ) )->( Recno() )
   local aPos
   local lRet
   local lPre
   local lWhile   := .T.





   if lChk1
      aPos        := { 0, 0 }
      ClientToScreen( oDlg:hWnd, aPos )
      oDlg:Move( aPos[ 1 ] - 26, aPos[ 2 ] - 510 )
   end





   oDlg:Disable()

   oTree:Enable()
   oTree:DeleteAll()

   oBtnCancel:bAction   := {|| lWhile := .F. }
   oBtnCancel:Enable()

   if !empty( bPreAction )
      lPre              := Eval( bPreAction )
   end

   if !IsLogic( lPre ) .OR. lPre

      if nRad == 1

         for each nPos in ( oBrw:oBrw:aSelected )

            ( D():FacturasRectificativas( nView ) )->( dbGoTo( nPos ) )

            if lFechas .OR.( ( D():FacturasRectificativas( nView ) )->dFecFac >= dDesde .AND. ( D():FacturasRectificativas( nView ) )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, D():FacturasRectificativas( nView ), D():FacturasRectificativasLineas( nView ) )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ++n )

            SysRefresh()

            if !lWhile
               exit
            end

         next

      else

         ( D():FacturasRectificativas( nView ) )->( dbSeek( cDocIni, .T. ) )




         while ( lWhile )                                                                                      .AND.  ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac, 9 ) + ( D():FacturasRectificativas( nView ) )->cSufFac >= cDocIni .AND.  ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac, 9 ) + ( D():FacturasRectificativas( nView ) )->cSufFac <= cDocFin .AND.  !( D():FacturasRectificativas( nView ) )->( eof() )

            if lFechas .OR.( ( D():FacturasRectificativas( nView ) )->dFecFac >= dDesde .AND. ( D():FacturasRectificativas( nView ) )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, D():FacturasRectificativas( nView ), D():FacturasRectificativasLineas( nView ) )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ++n )

            ( D():FacturasRectificativas( nView ) )->( dbSkip() )

            SysRefresh()

         end

      end

      if !empty( bPostAction )
         Eval( bPostAction )
      end

   end

   oMtrInf:Set( ( D():FacturasRectificativas( nView ) )->( OrdKeyCount() ) )

   ( D():FacturasRectificativas( nView ) )->( dbGoTo( nRec ) )

   if lChk1
      WndCenter( oDlg:hWnd )
   end

   oBtnCancel:bAction   := {|| oDlg:End() }

   oDlg:Enable()

   if oBrw <> nil
      oBrw:Refresh()
   end

RETURN ( lRet )



STATIC FUNCTION DelSerie( oWndBrw )

    local oDlg
   local oSerIni
   local oSerFin
   local oTxtDel
   local nTxtDel     := 0
   local nRecno      := ( D():FacturasRectificativas( nView ) )->( Recno() )
   local nOrdAnt     := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( D():FacturasRectificativas( nView ) )->cSerie, ( D():FacturasRectificativas( nView ) )->nNumFac, ( D():FacturasRectificativas( nView ) )->cSufFac, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel




   oDlg = TDialog():New(,,,, "Eliminar series de facturas rectificativas", "DELSERDOC",, .F.,,,,, oWndBrw, .F.,,,,,, .F.,, "oDlg", nil, )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DelStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDel, @lCancel ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )





   oTxtDel := TApoloMeter():ReDefine( 160, { | u | If( PCount()==0, nTxtDel, nTxtDel:= u ) }, ( D():FacturasRectificativas( nView ) )->( OrdKeyCount() ), oDlg, .F.,,, .T.,,,, )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( D():FacturasRectificativas( nView ) )->( dbGoTo( nRecNo ) )
   ( D():FacturasRectificativas( nView ) )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



STATIC FUNCTION DelStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDel, lCancel )

   local nOrd
   local nDeleted       := 0
   local nProcesed      := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction   := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd              := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( "nNumFac" ) )

      ( D():FacturasRectificativas( nView ) )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )
      while !lCancel .AND. ( D():FacturasRectificativas( nView ) )->( !eof() )






         if ( D():FacturasRectificativas( nView ) )->cSerie  >= oDesde:cSerieInicio  .AND. ( D():FacturasRectificativas( nView ) )->cSerie  <= oDesde:cSerieFin     .AND. ( D():FacturasRectificativas( nView ) )->nNumFac >= oDesde:nNumeroInicio .AND. ( D():FacturasRectificativas( nView ) )->nNumFac <= oDesde:nNumeroFin    .AND. ( D():FacturasRectificativas( nView ) )->cSufFac >= oDesde:cSufijoInicio .AND. ( D():FacturasRectificativas( nView ) )->cSufFac <= oDesde:cSufijoFin

            ++nDeleted

            oTxtDel:cText  := "Eliminando : " + ( D():FacturasRectificativas( nView ) )->cSerie + "/" + alltrim( Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) ) + "/" + ( D():FacturasRectificativas( nView ) )->cSufFac

            WinDelRec( nil, D():FacturasRectificativas( nView ), {|| QuiFacRec() } )

         else

            ( D():FacturasRectificativas( nView ) )->( dbSkip() )

         end

         ++nProcesed

         oTxtDel:Set( nProcesed )

      end

      ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( nOrd ) )

   else

      nOrd              := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( "dFecFac" ) )

      ( D():FacturasRectificativas( nView ) )->( dbSeek( oDesde:dFechaInicio, .T. ) )
      while !lCancel .AND. ( D():FacturasRectificativas( nView ) )->( !eof() )


         if ( D():FacturasRectificativas( nView ) )->dFecFac >= oDesde:dFechaInicio  .AND. ( D():FacturasRectificativas( nView ) )->dFecFac <= oDesde:dFechaFin

            ++nDeleted

            oTxtDel:cText  := "Eliminando : " + ( D():FacturasRectificativas( nView ) )->cSerie + "/" + alltrim( Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) ) + "/" + ( D():FacturasRectificativas( nView ) )->cSufFac

            WinDelRec( nil, D():FacturasRectificativas( nView ), {|| QuiFacRec() } )

         else

            ( D():FacturasRectificativas( nView ) )->( dbSkip() )

         end

         ++nProcesed

         oTxtDel:Set( nProcesed )

      end

      ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( nOrd ) )

   end

   lCancel              := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros borrados : " + Str( nDeleted ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros borrados : " + Str( nDeleted ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



static function RecFacRec( aTmpFac )

   local nDtoAge  := 0
   local nImpAtp  := 0
   local nImpOfe  := 0
   local cCodFam
   local nRecno
   local hAtipica




   if !ApoloMsgNoYes(  "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿Desea proceder?" )
      return nil
   end

   nRecno         := ( dbfTmpLin )->( RecNo() )

   ( dbfTmpLin )->( dbGotop() )
   ( D():Articulos( nView ) )->( ordSetFocus( "CODIGO" ) )

   while !( dbfTmpLin )->( eof() )





      if ( D():Articulos( nView ) )->( dbSeek( ( dbfTmpLin )->cRef ) )

         do case
             case aTmpFac[ 65 ] <= 2
                ( dbfTmpLin )->nIva     := nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva )
                ( dbfTmpLin )->nReq     := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )
             case aTmpFac[ 65 ] == 3
                ( dbfTmpLin )->nIva     := 0
                ( dbfTmpLin )->nReq     := 0
         end





         if !empty( ( D():Articulos( nView ) )->cCodImp )
            ( dbfTmpLin )->cCodImp  := ( D():Articulos( nView ) )->cCodImp
            ( dbfTmpLin )->nValImp  := oNewImp:nValImp( ( D():Articulos( nView ) )->cCodImp, aTmpFac[ 58 ], ( dbfTmpLin )->nIva )
         end





         ( dbfTmpLin )->nPreUnit    := nRetPreArt( ( dbfTmpLin )->nTarLin, aTmpFac[ 60 ], aTmpFac[ 58 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )





         ( dbfTmpLin )->nPntVer  := ( D():Articulos( nView ) )->nPntVer1





         ( dbfTmpLin )->nCtlStk     := ( D():Articulos( nView ) )->nCtlStock
         ( dbfTmpLin )->nCosDiv     := nCosto( nil, D():Articulos( nView ), dbfKit, , , , aTmpFac[ 7 ] )
         ( dbfTmpLin )->nPvpRec     := ( D():Articulos( nView ) )->PvpRec



         cCodFam                    := ( D():Articulos( nView ) )->Familia



         do case
         case !empty( aTmpFac[ 22 ] )

            nImpOfe     := RetPrcTar( ( dbfTmpLin )->cRef, aTmpFac[ 22 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL, ( dbfTmpLin )->nTarLin )
            if nImpOfe <> 0
               ( dbfTmpLin )->nPreUnit := nImpOfe
            end

            nImpOfe     := RetPctTar( ( dbfTmpLin )->cRef, cCodFam, aTmpFac[ 22 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL )
            if nImpOfe <> 0
               ( dbfTmpLin )->nDto     := nImpOfe
            end

            nImpOfe     := RetComTar( ( dbfTmpLin )->cRef, cCodFam, aTmpFac[ 22 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpFac[ 20 ], dbfTarPreL, dbfTarPreS )
            if nImpOfe  <> 0
               ( dbfTmpLin )->nComAge  := nImpOfe
            end






            nImpOfe     := RetDtoPrm( ( dbfTmpLin )->cRef, cCodFam, aTmpFac[ 22 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpFac[ 6 ], dbfTarPreL )
            if nImpOfe  <> 0
               ( dbfTmpLin )->nDtoPrm  := nImpOfe
            end





            nDtoAge     := RetDtoAge( ( dbfTmpLin )->cRef, cCodFam, aTmpFac[ 22 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpFac[ 6 ], aTmpFac[ 20 ], dbfTarPreL, dbfTarPreS )
            if nDtoAge  <> 0
               ( dbfTmpLin )->nComAge  := nDtoAge
            end

         end





         hAtipica := hAtipica( hValue( dbfTmpLin, aTmpFac ) )

         if !empty( hAtipica )

            if hhaskey( hAtipica, "nTarifaFamilia" ) .AND. hAtipica[ "nTarifaFamilia" ] > 0
               ( dbfTmpLin )->nPreUnit    := nRetPreArt( hAtipica[ "nTarifaFamilia" ], aTmpFac[ 60 ], aTmpFac[ 58 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
            end

            if hhaskey( hAtipica, "nImporte" )
                if hAtipica[ "nImporte" ] <> 0
                       ( dbfTmpLin )->nPreUnit := hAtipica[ "nImporte" ]
                   end
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
                if hAtipica[ "nDescuentoPorcentual" ] <> 0
                       ( dbfTmpLin )->nDto     := hAtipica[ "nDescuentoPorcentual" ]
                   end
            end

            if hhaskey( hAtipica, "nDescuentoPromocional" )
                if hAtipica[ "nDescuentoPromocional" ] <> 0
                       ( dbfTmpLin )->nDtoPrm  := hAtipica[ "nDescuentoPromocional" ]
                   end
            end

            if hhaskey( hAtipica, "nDescuentoLineal" )
                if hAtipica[ "nDescuentoLineal" ] <> 0
                       ( dbfTmpLin )->nDtoDiv  := hAtipica[ "nDescuentoLineal" ]
                   end
            end

            if hhaskey( hAtipica, "nComisionAgente" )
                if hAtipica[ "nComisionAgente" ] <> 0
                       ( dbfTmpLin )->nComAge  := hAtipica[ "nComisionAgente" ]
                   end
            end

         end





         nImpOfe     := nImpOferta( ( dbfTmpLin )->cRef, aTmpFac[ 7 ], aTmpFac[ 81 ], ( dbfTmpLin )->nUniCaja, aTmpFac[ 6 ], dbfOferta, ( dbfTmpLin )->nTarLin, nil, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nPreUnit := nCnv2Div( nImpOfe, cDivEmp(), aTmpFac[ 60 ] )
         end





         nImpOfe     := nDtoOferta( ( dbfTmpLin )->cRef, aTmpFac[ 7 ], aTmpFac[ 81 ], ( dbfTmpLin )->nUniCaja, aTmpFac[ 6 ], dbfOferta, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nDtoPrm  := nImpOfe
         end

      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRecno ) )

return nil



Static Function EdtRecMenu( aTmp, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .T.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )




             MenuAddItem( "&1. Campos extra [F9]", "Mostramos y rellenamos los campos extra para la familia", .F.,, {|oMenuItem|( oDetCamposExtra:Play( space(1) ) )},, "gc_form_plus2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&2. Modificar cliente", "Modifica la ficha del cliente", .F.,, {|oMenuItem|( if( !empty( aTmp[ 7 ] ), EdtCli( aTmp[ 7 ] ), MsgStop( "Código de cliente vacío" ) ) )},, "gc_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&3. Modificar cliente contactos", "Modifica la ficha del cliente en contactos", .F.,, {|oMenuItem|( if( !empty( aTmp[ 7 ] ), EdtCli( aTmp[ 7 ], , 5 ), MsgStop( "Código de cliente vacío" ) ) )},, "gc_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&4. Informe de cliente", "Informe de cliente", .F.,, {|oMenuItem|( if( !empty( aTmp[ 7 ] ), InfCliente( aTmp[ 7 ] ), MsgStop( "Código de cliente vacío" ) ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&5. Modificar dirección", "Modifica ficha de la dirección", .F.,, {|oMenuItem|( if( !empty( aTmp[ 23 ] ), EdtObras( aTmp[ 7 ], aTmp[ 23 ], dbfObrasT ), MsgStop( "Código de obra vacío" ) ) )},, "gc_worker2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

RETURN ( oMenu )



Static Function EndEdtRecMenu()

Return( oMenu:End() )



Static Function nEstadoIncidencia( cNumFac )

   local nEstado  := 0

   if ( dbfFacRecI )->( dbSeek( cNumFac ) )

      while ( dbfFacRecI )->cSerie + Str( ( dbfFacRecI )->nNumFac ) + ( dbfFacRecI )->cSufFac == cNumFac .AND. !( dbfFacRecI )->( Eof() )

         if ( dbfFacRecI )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( dbfFacRecI )->( dbSkip() )

      end

   end

Return ( nEstado )



STATIC FUNCTION cFacCli( aGet, aTmp, oBrw, oBrwiva, nMode )

   local nOption     := 0
   local aFacCliT
   local aFacCliL
   local cFactura    := aGet[ 39 ]:varGet()

   if nMode <> 1 .OR. empty( cFactura )
      RETURN .T.
   end

   aFacCliT          := aGetStatus( dbfFacCliT, .T. )
   aFacCliL          := aGetStatus( dbfFacCliL, .T. )

   if ( dbfFacCliT )->( dbSeek( cFactura ) )

      aGet[ 7 ]:cText( (dbfFacCliT)->cCodCli )
      aGet[ 7 ]:bWhen    := {|| .F. }
      aGet[ 7 ]:lValid()

      aGet[ 10 ]:cText( ( dbfFacCliT )->cNomCli )
      aGet[ 11 ]:cText( ( dbfFacCliT )->cDirCli )
      aGet[ 12 ]:cText( ( dbfFacCliT )->cPobCli )
      aGet[ 13 ]:cText( ( dbfFacCliT )->cPrvCli )
      aGet[ 15 ]:cText( ( dbfFacCliT )->cPosCli )
      aGet[ 16 ]:cText( ( dbfFacCliT )->cDniCli )

      aGet[ 8 ]:cText( ( dbfFacCliT )->cCodAlm )
      aGet[ 8 ]:lValid()

      aGet[ 9 ]:cText( ( dbfFacCliT )->cCodCaj )
      aGet[ 9 ]:lValid()

      aGet[ 34]:cText( ( dbfFacCliT )->cCodPago )
      aGet[ 34]:lValid()

      aGet[ 20 ]:cText( ( dbfFacCliT )->cCodAge )
      aGet[ 20 ]:lValid()

      aGet[ 22 ]:cText( ( dbfFacCliT )->cCodTar )
      aGet[ 22 ]:lValid()

      aGet[ 21 ]:cText( ( dbfFacCliT )->cCodRut )
      aGet[ 21 ]:lValid()

      aGet[ 23 ]:cText( ( dbfFacCliT )->cCodObr )
      aGet[ 23 ]:lValid()

      aGet[ 72 ]:cText( ( dbfFacCliT )->cCodTrn )
      aGet[ 72 ]:lValid()

      aGet[ 56 ]:Click( ( dbfFacCliT )->lRecargo )
      aGet[ 101  ]:Click( ( dbfFacCliT )->lOperPv )

      aGet[ 58 ]:Click( ( dbfFacCliT )->lIvaInc )

      aGet[ 94  ]:cText( ( dbfFacCliT )->cBanco )
      aGet[ 94  ]:lValid()

      aGet[ 95 ]:cText( ( dbfFacCliT )->cPaisIBAN )
      aGet[ 95 ]:lValid()

      aGet[ 96 ]:cText( ( dbfFacCliT )->cCtrlIBAN )
      aGet[ 96 ]:lValid()

      aGet[ 97 ]:cText( ( dbfFacCliT )->cEntBnc )
      aGet[ 97 ]:lValid()

      aGet[ 98 ]:cText( ( dbfFacCliT )->cSucBnc )
      aGet[ 98 ]:lValid()

      aGet[ 99 ]:cText( ( dbfFacCliT )->cDigBnc )
      aGet[ 99 ]:lValid()

      aGet[ 100 ]:cText( ( dbfFacCliT )->cCtaBnc )
      aGet[ 100 ]:lValid()

      if !empty( ( dbfFacCliT )->cCtrCoste )
          aGet[ 104 ]:cText( ( dbfFacCliT )->cCtrCoste )
          aGet[ 104 ]:lValid()
      endif

      oGetTarifa:setTarifa( ( dbfFacCliT )->nTarifa )



      aGet[ 32 ]:cText( ( dbfFacCliT )->mComEnt )
      aTmp[ 33 ]  := ( dbfFacCliT )->mObsErv



      if empty( ( dbfFacCliT )->cDtoEsp )
         aGet[ 41 ]:cText( "General" )
      else
         aGet[ 41 ]:cText( ( dbfFacCliT )->cDtoEsp )
      end

      if empty( ( dbfFacCliT )->cDpp )
         aGet[ 43    ]:cText( "Pronto pago" )
      else
         aGet[ 43    ]:cText( ( dbfFacCliT )->cDpp )
      end

      aGet[ 42 ]:cText( ( dbfFacCliT )->nDtoEsp )
      aGet[ 44    ]:cText( ( dbfFacCliT )->nDpp    )
      aGet[ 45 ]:cText( ( dbfFacCliT )->cDtoUno )
      aGet[ 46 ]:cText( ( dbfFacCliT )->nDtoUno )
      aGet[ 47 ]:cText( ( dbfFacCliT )->cDtoDos )
      aGet[ 48 ]:cText( ( dbfFacCliT )->nDtoDos )
      aGet[ 86 ]:cText( ( dbfFacCliT )->cManObr )
      aGet[ 37 ]:cText( ( dbfFacCliT )->nIvaMan )
      aGet[ 38 ]:cText( ( dbfFacCliT )->nManObr )

      aTmp[ 81 ] := ( dbfFacCliT )->cCodGrp
      aTmp[ 17 ] := ( dbfFacCliT )->lModCli

      aTmp[ 101 ] := ( dbfFacCliT )->lOperPv



      nOption           := nImportaLineas()

      if nOption >= 1

         CursorWait()

         if ( dbfFacCliL )->( dbSeek( cFactura ) )

            while ( ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac == cFactura )

               if !( dbfFacCliL )->lTotLin  .AND. !( dbfFacCliL )->lControl

                  ( dbfTmpLin )->( dbAppend() )
                  ( dbfTmpLin )->cSerie     := " "
                  ( dbfTmpLin )->nNumFac    := 0
                  ( dbfTmpLin )->nNumLin    := ( dbfFacCliL )->nNumLin
                  ( dbfTmpLin )->nPosPrint  := ( dbfFacCliL )->nPosPrint
                  ( dbfTmpLin )->cRef       := ( dbfFacCliL )->cRef
                  ( dbfTmpLin )->cDetalle   := ( dbfFacCliL )->cDetalle
                  ( dbfTmpLin )->mLngDes    := ( dbfFacCliL )->mLngDes
                  ( dbfTmpLin )->mNumSer    := ( dbfFacCliL )->mNumSer
                  ( dbfTmpLin )->nPreUnit   := ( dbfFacCliL )->nPreUnit
                  ( dbfTmpLin )->nPntVer    := ( dbfFacCliL )->nPntVer
                  ( dbfTmpLin )->nImpTrn    := ( dbfFacCliL )->nImpTrn
                  ( dbfTmpLin )->nCanEnt    := if( nOption == 2, ( ( dbfFacCliL )->nCanEnt * -1 ), ( dbfFacCliL )->nCanEnt )
                  ( dbfTmpLin )->cUnidad    := ( dbfFacCliL )->cUnidad
                  ( dbfTmpLin )->nUniCaja   := if( !lCalCaj() .AND. nOption == 2, ( ( dbfFacCliL )->nUniCaja * -1 ), ( dbfFacCliL )->nUniCaja )
                  ( dbfTmpLin )->nDto       := ( dbfFacCliL )->nDto
                  ( dbfTmpLin )->nDtoPrm    := ( dbfFacCliL )->nDtoPrm
                  ( dbfTmpLin )->nIva       := ( dbfFacCliL )->nIva
                  ( dbfTmpLin )->nReq       := ( dbfFacCliL )->nReq
                  ( dbfTmpLin )->nPesoKg    := ( dbfFacCliL )->nPesoKg
                  ( dbfTmpLin )->cPesoKg    := ( dbfFacCliL )->cPesoKg
                  ( dbfTmpLin )->nComAge    := ( dbfFacCliL )->nComAge
                  ( dbfTmpLin )->dFecha     := ( dbfFacCliL )->dFecha
                  ( dbfTmpLin )->id_tipo_v  := ( dbfFacCliL )->id_tipo_v
                  ( dbfTmpLin )->cCodAlb    := ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac
                  ( dbfTmpLin )->lTotLin    := ( dbfFacCliL )->lTotLin
                  ( dbfTmpLin )->nDtoDiv    := ( dbfFacCliL )->nDtoDiv
                  ( dbfTmpLin )->nCtlStk    := ( dbfFacCliL )->nCtlStk
                  ( dbfTmpLin )->cAlmLin    := ( dbfFacCliL )->cAlmLin
                  ( dbfTmpLin )->lIvaLin    := ( dbfFacCliL )->lIvaLin
                  ( dbfTmpLin )->lImpLin    := ( dbfFacCliL )->lImpLin
                  ( dbfTmpLin )->nValImp    := ( dbfFacCliL )->nValImp
                  ( dbfTmpLin )->cCodImp    := ( dbfFacCliL )->cCodImp
                  ( dbfTmpLin )->cCodPr1    := ( dbfFacCliL )->cCodPr1
                  ( dbfTmpLin )->cCodPr2    := ( dbfFacCliL )->cCodPr2
                  ( dbfTmpLin )->cValPr1    := ( dbfFacCliL )->cValPr1
                  ( dbfTmpLin )->cValPr2    := ( dbfFacCliL )->cValPr2
                  ( dbfTmpLin )->nCosDiv    := ( dbfFacCliL )->nCosDiv
                  ( dbfTmpLin )->lKitArt    := ( dbfFacCliL )->lKitArt
                  ( dbfTmpLin )->lKitChl    := ( dbfFacCliL )->lKitChl
                  ( dbfTmpLin )->lKitPrc    := ( dbfFacCliL )->lKitPrc
                  ( dbfTmpLin )->lLote      := ( dbfFacCliL )->lLote
                  ( dbfTmpLin )->nLote      := ( dbfFacCliL )->nLote
                  ( dbfTmpLin )->cLote      := ( dbfFacCliL )->cLote
                  ( dbfTmpLin )->lControl   := ( dbfFacCliL )->lControl
                  ( dbfTmpLin )->lNotVta    := ( dbfFacCliL )->lNotVta
                  ( dbfTmpLin )->cCodTip    := ( dbfFacCliL )->cCodTip
                  ( dbfTmpLin )->mObsLin    := ( dbfFacCliL )->mObsLin
                  ( dbfTmpLin )->Descrip    := ( dbfFacCliL )->Descrip
                  ( dbfTmpLin )->cCodPrv    := ( dbfFacCliL )->cCodPrv
                  ( dbfTmpLin )->cImagen    := ( dbfFacCliL )->cImagen
                  ( dbfTmpLin )->cCodFam    := ( dbfFacCliL )->cCodFam
                  ( dbfTmpLin )->cGrpFam    := ( dbfFacCliL )->cGrpFam
                  ( dbfTmpLin )->nNumMed    := ( dbfFacCliL )->nNumMed
                  ( dbfTmpLin )->nMedUno    := ( dbfFacCliL )->nMedUno
                  ( dbfTmpLin )->nMedDos    := ( dbfFacCliL )->nMedDos
                  ( dbfTmpLin )->nMedTre    := ( dbfFacCliL )->nMedTre
                  ( dbfTmpLin )->lVolImp    := ( dbfFacCliL )->lVolImp
                  ( dbfTmpLin )->nVolumen   := ( dbfFacCliL )->nVolumen
                  ( dbfTmpLin )->lLinOfe    := ( dbfFacCliL )->lLinOfe
                  ( dbfTmpLin )->dFecCad    := ( dbfFacCliL )->dFecCad
                  ( dbfTmpLin )->nBultos    := if( nOption == 2, ( ( dbfFacCliL )->nBultos * -1 ), ( dbfFacCliL )->nBultos )
                  ( dbfTmpLin )->cFormato   := ( dbfFacCliL )->cFormato
                  ( dbfTmpLin )->dFecFac    := ( dbfFacCliL )->dFecFac
                  ( dbfTmpLin )->tFecfac    := ( dbfFacCliL )->tFecfac
                  ( dbfTmpLin )->cCtrCoste  := ( dbfFacCliL )->cCtrCoste
                  ( dbfTmpLin )->nTarLin       := ( dbfFacCliL )->nTarLin
                  ( dbfTmpLin )->cObrLin    := ( dbfFacCliL )->cCodObr
                  ( dbfTmpLin )->cCtrCoste  := ( dbfFacCliL )->cCtrCoste
                  ( dbfTmpLin )->cTipCtr    := ( dbfFacCliL )->cTipCtr
                  ( dbfTmpLin )->cTerCtr    := ( dbfFacCliL )->cTerCtr

               end

               ( dbfFacCliL )->( dbSkip() )

            end

         else

            MsgStop( "La factura no contiene líneas de detalle." )

         end

         ( dbfTmpLin )->( dbGoTop() )



         if ( dbfFacCliS )->( dbSeek( cFactura ) )

            while ( dbfFacCliS )->cSerFac + Str( ( dbfFacCliS )->nNumFac ) + ( dbfFacCliS )->cSufFac == cFactura .AND. !( dbfFacCliS )->( Eof() )

               ( dbfTmpSer )->( dbAppend() )
               ( dbfTmpSer )->nNumLin  := ( dbfFacCliS )->nNumLin
               ( dbfTmpSer )->cRef     := ( dbfFacCliS )->cRef
               ( dbfTmpSer )->cAlmLin  := ( dbfFacCliS )->cAlmLin
               ( dbfTmpSer )->cNumSer  := ( dbfFacCliS )->cNumSer

               ( dbfFacCliS )->( dbSkip() )

            end

         end

         CursorWE()

      end

      oBrw:SetFocus()
      oBrw:Refresh()

      oBrwIva:SetFocus()

   end

   SetStatus( dbfFacCliT, aFacCliT )
   SetStatus( dbfFacCliL, aFacCliL )

RETURN .T.



Static Function DesgPnt( cCodArt, aTmp, nTarifa, oPreDiv, oCosDiv, nMode )

   local oDlg
   local oPuntos
   local oValorPunto
   local oDtoPnt
   local oIncPnt
   local oImporte
   local nPuntos     := 0
   local nValorPunto := 0
   local nDtoPnt     := 0
   local nIncPnt     := 0



   if empty( cCodArt )
      MsgInfo( "Debe seleccinar un artículo", "Código vacío" )
      return .F.
   end



   nPuntos           := aTmp[ 60 ]
   nValorPunto       := aTmp[ 61 ]
   nDtoPnt           := aTmp[ 62 ]
   nIncPnt           := aTmp[ 63 ]

   oDlg = TDialog():New(,,,, "Desglose de puntos", "DESGPUNTOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







   oPuntos := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, nPuntos, nPuntos:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )







   oValorPunto := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nValorPunto, nValorPunto:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )









   oDtoPnt := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nDtoPnt, nDtoPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )









   oIncPnt := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, nIncPnt, nIncPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )





   oImporte := TSay():ReDefine( 240, {|| nCalculoPuntos( nPuntos, nValorPunto, nDtoPnt, nIncPnt )}, oDlg, cPouDiv, "N/W*",, .F.,, .F., .F., )





   TButton():ReDefine( 500, {||( EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, D():Articulos( nView ), nDouDiv ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




   TButton():ReDefine( 550, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, D():Articulos( nView ), nDouDiv ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      aTmp[ 60 ]     := nPuntos
      aTmp[ 61 ]     := nValorPunto
      aTmp[ 62 ]     := nDtoPnt
      aTmp[ 63 ]     := nIncPnt
      oCosDiv:cText( oImporte:VarGet() )
      oCosDiv:Refresh()

   end

Return ( .T. )



Static Function EdtPgo( aTmp, aGet, dbfTmpPgo, oBrw, dbfDiv, oCtaRem, nMode, oBandera )

    local oDlg
   local oBmpDiv
   local oGetCli
   local oGetAge
   local oGetCaj
   local oGetSubCta
   local cGetSubCta
   local oGetCtaRem
   local cGetCtaRem
   local oGetSubGas
   local cGetSubGas
   local lPgdOld
   local nImpOld
   local cGetCli     := RetClient( ( dbfTmpPgo )->cCodCli, D():Clientes( nView ) )
   local cGetAge     := cNbrAgent( ( dbfTmpPgo )->cCodAge, dbfAgent )
   local cGetCaj     := RetFld( ( dbfTmpPgo )->cCodCaj, dbfCajT, "cNomCaj" )
   local cPorDiv     := cPorDiv( aTmp[ ( dbfTmpPgo )->( FieldPos( "cDivPgo" ) ) ], dbfDiv )



   if nMode == 2   .AND. aTmp[ ( dbfTmpPgo )->( FieldPos( "LCONPGO" ) ) ]     .AND. !ApoloMsgNoYes( "La modificación de este recibo puede provocar descuadres contables." + Chr(13)+Chr(10) + "¿ Desea continuar ?", "Recibo ya contabilizado" )
      return .F.
   end

   if nMode == 2
      if aTmp[ ( dbfTmpPgo )->( FieldPos( "lCloPgo" ) ) ] .AND. !oUser():lAdministrador()
         msgStop( "Solo pueden modificar los recibos cerrados los administradores." )
         return .F.
      end
   end

   if empty( aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ] )
      aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ]   := Application():CodigoCaja()
   end

   lPgdOld              := ( dbfTmpPgo )->lCobrado .OR. ( dbfTmpPgo )->lRecDto
   nImpOld              := ( dbfTmpPgo )->nImporte

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "recibos de clientes", "PAGOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )









      aGet[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ]:cText( Calendario( aTmp[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ] ) )}, nil, "LUPA",, )









      aGet[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ]:cText( Calendario( aTmp[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ] ) )}, nil, "LUPA",, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "CCODCLI" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCLI" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCLI" ) ) ]:= u ) }, oDlg,,, {||    ( cClient( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODCLI" ) ) ], D():Clientes( nView ), oGetCli ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODCLI" ) ) ], oGetCli ) )}, nil, "LUPA",, )




      oGetCli := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, cGetCli, cGetCli:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "CCODAGE" ) ) ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODAGE" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODAGE" ) ) ]:= u ) }, oDlg,,, {||    ( cAgentes( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODAGE" ) ) ], dbfAgent, oGetAge ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODAGE" ) ) ], oGetAge ) )}, nil, "LUPA",, )




      oGetAge := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, cGetAge, cGetAge:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CDESCRIP" ) ) ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CDESCRIP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDESCRIP" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CPGDOPOR" ) ) ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CPGDOPOR" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CPGDOPOR" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CDOCPGO" ) ) ] := TGetHlp():ReDefine( 155, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CDOCPGO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDOCPGO" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "LRECIMP" ) ) ] := TCheckBox():ReDefine( 160, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "LRECIMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "LRECIMP" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )










      aGet[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ]:= u ) }, oDlg,, "@!", {||    ( cDivOut( aGet[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ], oBmpDiv, aGet[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ], nil, nil, @cPorDiv, nil, nil, nil, nil, dbfDiv, oBandera ) )}, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ], oBmpDiv, aGet[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ], dbfDiv, oBandera )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 171, "BAN_EURO",, oDlg,,, .F., .F.,,, .F.,,, .F. )








      aGet[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ] := TGetHlp():ReDefine( 172, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ]:= u ) }, oDlg,, "@E 999,999.9999", {||    ( aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ] > 0 )}, "N/W*",,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ]:= u ) }, oDlg,, ( cPorDiv ), {||    ( aGet[ ( dbfTmpPgo )->( FieldPos( "NIMPCOB" ) ) ]:cText( aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ] ), .T. )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "NIMPCOB" ) ) ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPCOB" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPCOB" ) ) ]:= u ) }, oDlg,, ( cPorDiv ), {||    ( ValCobro( aGet, aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ ( dbfTmpPgo )->( FieldPos( "NIMPGAS" ) ) ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPGAS" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPGAS" ) ) ]:= u ) }, oDlg,, ( cPorDiv ),, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "lNotArqueo" ) ) ] := TCheckBox():ReDefine( 200, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "lNotArqueo" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "lNotArqueo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )






      aGet[ ( dbfTmpPgo )->( FieldPos( "LCOBRADO" ) ) ] := TCheckBox():ReDefine( 220, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "LCOBRADO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "LCOBRADO" ) ) ]:= u ) }, oDlg,, {||( ValCheck( aGet, aTmp ) )},,,,, .F., {||         ( nMode <> 3 )}, .F. )









      aGet[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ]:cText( Calendario( aTmp[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ] ) )}, nil, "LUPA",, )










      aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ]:= u ) }, oDlg,, ( Replicate( "X", nLenSubcuentaContaplus() ) ), {||    ( MkSubcuenta( aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ], nil, oGetSubCta ) )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkSubcuenta( aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ], oGetSubCta ) )}, nil, "LUPA",, )





        oGetSubCta := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cGetSubCta, cGetSubCta:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAGAS" ) ) ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAGAS" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAGAS" ) ) ]:= u ) }, oDlg,, ( Replicate( "X", nLenSubcuentaContaplus() ) ), {||    ( MkSubcuenta( aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAGAS" ) ) ], nil, oGetSubGas ) )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkSubcuenta( aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAGAS" ) ) ], oGetSubGas ) )}, nil, "LUPA",, )





      oGetSubGas := TGetHlp():ReDefine( 271, { | u | If( PCount()==0, cGetSubGas, cGetSubGas:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREM" ) ) ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAREM" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAREM" ) ) ]:= u ) }, oDlg,,, {||    ( oGetCtaRem:cText( retFld( aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAREM" ) ) ], oCtaRem:GetAlias() ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCtaRem:Buscar( aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREM" ) ) ] ) )}, nil, "LUPA",, )





      oGetCtaRem := TGetHlp():ReDefine( 251, { | u | If( PCount()==0, cGetCtaRem, cGetCtaRem:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ]:= u ) }, oDlg,,, {||    cCajas( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ], dbfCajT, oGetCaj )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ], oGetCaj ) )}, nil, "LUPA",, )




      oGetCaj := TGetHlp():ReDefine( 281, { | u | If( PCount()==0, cGetCaj, cGetCaj:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )













      aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ]:= u ) }, oDlg,,, {||    ( oBanco:Existe( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ]:oHelpText, "cNomBnc", .T., .T., "0" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oBanco:Buscar( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ] ) )}, nil, "LUPA",, 311 )









      TButton():ReDefine( 1, {||( EndPgo( aTmp, aGet, lPgdOld, nImpOld, dbfTmpPgo, oBrw, oDlg, nMode ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| EndPgo( aTmp, aGet, lPgdOld, nImpOld, dbfTmpPgo, oBrw, oDlg, nMode ) } )
   end






   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|(  aGet[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ]:lValid(), aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ]:lValid(), aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAGAS" ) ) ]:lValid(), aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREM" ) ) ]:lValid(), aGet[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ]:SetFocus() )}, oDlg:bRClicked,,, )

   oBmpDiv:End()

RETURN ( oDlg:nResult == 1 )



Static Function EndPgo( aTmp, aGet, lPgdOld, nImpOld, dbfTmpPgo, oBrw, oDlg, nMode )

   local nImp
   local nCon
   local nRec        := ( dbfTmpPgo )->( Recno() )
   local lImpNeg     := ( dbfTmpPgo )->nImporte < 0
   local nImpTmp     := abs( aTmp[ ( dbfTmpPgo )->( FieldPos( "nImporte" ) ) ] )
   local nImpFld     := abs( ( dbfTmpPgo )->nImporte )

   if !aGet[ ( dbfTmpPgo )->( FieldPos( "nImpCob" ) ) ]:lValid()
      return .F.
   end










   oDlg:Disable()





   if nImpFld <> nImpTmp





      nImp                       := ( nImpFld - nImpTmp ) * if( lImpNeg, - 1 , 1 )





      ( dbfTmpPgo )->( dbAppend() )
      nCon                       := ( dbfTmpPgo )->( Recno() )
      ( dbfTmpPgo )->cSerie      := aTmp[ ( dbfTmpPgo )->( FieldPos( "CSERIE"  ) ) ]
      ( dbfTmpPgo )->nNumFac     := aTmp[ ( dbfTmpPgo )->( FieldPos( "NNUMFAC" ) ) ]
      ( dbfTmpPgo )->cSufFac     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUFFAC" ) ) ]
      ( dbfTmpPgo )->nNumRec     := nCon
      ( dbfTmpPgo )->cTipRec     := "R"
      ( dbfTmpPgo )->cCodCaj     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ]
      ( dbfTmpPgo )->cCodCli     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCLI" ) ) ]
      ( dbfTmpPgo )->dEntrada    := Ctod( "" )
      ( dbfTmpPgo )->nImporte    := nImp
      ( dbfTmpPgo )->nImpGas     := 0
      ( dbfTmpPgo )->cDescrip    := "Recibo nº" + alltrim( Str( nCon ) ) + " de factura " + aTmp[ ( dbfTmpPgo )->( FieldPos( "CSERIE" ) ) ] + "/" + alltrim( Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "NNUMFAC" ) ) ] ) ) + "/" + aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUFFAC" ) ) ]
      ( dbfTmpPgo )->dPreCob     := dFecFacRec( aTmp[ ( dbfTmpPgo )->( FieldPos( "CSERIE" ) ) ] + Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "NNUMFAC" ) ) ] ) + aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUFFAC" ) ) ], D():FacturasRectificativas( nView ) )
      ( dbfTmpPgo )->dFecVto     := dFecFacRec( aTmp[ ( dbfTmpPgo )->( FieldPos( "CSERIE" ) ) ] + Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "NNUMFAC" ) ) ] ) + aTmp[ ( dbfTmpPgo )->( FieldPos( "CSUFFAC" ) ) ], D():FacturasRectificativas( nView ) )
      ( dbfTmpPgo )->cPgdoPor    := ""
      ( dbfTmpPgo )->lCobrado    := .F.
      ( dbfTmpPgo )->cTurRec     := cCurSesion()
      ( dbfTmpPgo )->cDivPgo     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ]
      ( dbfTmpPgo )->nVdvPgo     := aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ]
      ( dbfTmpPgo )->lConPgo     := .F.
      ( dbfTmpPgo )->( dbUnLock() )

   end

   ( dbfTmpPgo )->( dbGoTo( nRec ) )





   WinGather( aTmp, aGet, dbfTmpPgo, oBrw, nMode )





   dbCommitAll()

   oDlg:Enable()

   oDlg:End( 1 )

return .T.



STATIC FUNCTION DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, lCancel, cFecDoc )

   local nOrd
   local nDuplicados    := 0
   local nProcesed      := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction   := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd              := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( "nNumFac" ) )

      ( D():FacturasRectificativas( nView ) )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )

      while !lCancel .AND. ( D():FacturasRectificativas( nView ) )->( !eof() )






         if ( D():FacturasRectificativas( nView ) )->cSerie  >= oDesde:cSerieInicio  .AND. ( D():FacturasRectificativas( nView ) )->cSerie  <= oDesde:cSerieFin     .AND. ( D():FacturasRectificativas( nView ) )->nNumFac >= oDesde:nNumeroInicio .AND. ( D():FacturasRectificativas( nView ) )->nNumFac <= oDesde:nNumeroFin    .AND. ( D():FacturasRectificativas( nView ) )->cSufFac >= oDesde:cSufijoInicio .AND. ( D():FacturasRectificativas( nView ) )->cSufFac <= oDesde:cSufijoFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( D():FacturasRectificativas( nView ) )->cSerie + "/" + alltrim( Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) ) + "/" + ( D():FacturasRectificativas( nView ) )->cSufFac

            DupFactura( cFecDoc )

         end

         ( D():FacturasRectificativas( nView ) )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( nOrd ) )

   else

      nOrd              := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( "dFecFac" ) )

      ( D():FacturasRectificativas( nView ) )->( dbSeek( oDesde:dFechaInicio, .T. ) )

      while !lCancel .AND. ( D():FacturasRectificativas( nView ) )->( !eof() )


         if ( D():FacturasRectificativas( nView ) )->dFecFac >= oDesde:dFechaInicio  .AND. ( D():FacturasRectificativas( nView ) )->dFecFac <= oDesde:dFechaFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( D():FacturasRectificativas( nView ) )->cSerie + "/" + alltrim( Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) ) + "/" + ( D():FacturasRectificativas( nView ) )->cSufFac

            DupFactura( cFecDoc )

         end

         ( D():FacturasRectificativas( nView ) )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( nOrd ) )

   end

   lCancel              := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



STATIC FUNCTION FacRecDup( cDbf, xField1, xField2, xField3, lCab, cFecDoc, lPag )

   local nRec                 := ( cDbf )->( Recno() )
   local aTabla               := {}
   local nOrdAnt

   If( lCab == nil, lCab := .F., ) ;
   If( lPag == nil, lPag := .F., ) ;

   aTabla                     := DBScatter( cDbf )
   aTabla[ 1  ]         := xField1
   aTabla[ 2 ]         := xField2
   aTabla[ 3 ]         := xField3

   if lCab

      aTabla[ 5     ]  := cCurSesion()
      if !empty( cFecDoc )
         aTabla[ 6  ]  := cFecDoc
      end
      aTabla[ 9     ]  := Application():CodigoCaja()
      aTabla[ 26     ]  := .F.
      aTabla[ 28     ]  := Ctod("")
      aTabla[ 30     ]  := .F.
      aTabla[ 39     ]  := Space( 12 )
      aTabla[ 59     ]  := .T.
      aTabla[ 74     ]  := .F.
      aTabla[ 75     ]  := Space( 12 )
      aTabla[ 76     ]  := Space( 12 )
      aTabla[ 78     ]  := Auth():Codigo()
      aTabla[ 79     ]  := GetSysDate()
      aTabla[ 80     ]  := Time()
      aTabla[ 82  ]  := .F.
      aTabla[ 83     ]  := Ctod("")
      aTabla[ 84     ]  := Space( 5 )
      aTabla[ 85     ]  := Application():CodigoDelegacion()

      nOrdAnt                 := ( cDbf )->( OrdSetFocus( "NNUMFAC" ) )

   end

   if lPag

      aTabla[ ( dbfFacCliP )->( FieldPos( "lConPgo" ) ) ]      := .F.
      aTabla[ ( dbfFacCliP )->( FieldPos( "lRecImp" ) ) ]      := .F.
      aTabla[ ( dbfFacCliP )->( FieldPos( "lRecDto" ) ) ]      := .F.
      aTabla[ ( dbfFacCliP )->( FieldPos( "lCloPgo" ) ) ]      := .F.
      aTabla[ ( dbfFacCliP )->( FieldPos( "dPreCob" ) ) ]      := cFecDoc
      aTabla[ ( dbfFacCliP )->( FieldPos( "dFecDto" ) ) ]      := Ctod("")
      aTabla[ ( dbfFacCliP )->( FieldPos( "dFecImp" ) ) ]      := Ctod("")
      aTabla[ ( dbfFacCliP )->( FieldPos( "cHorImp" ) ) ]      := Space( 5 )
      aTabla[ ( dbfFacCliP )->( FieldPos( "dFecVto" ) ) ]      := cFecDoc
      aTabla[ ( dbfFacCliP )->( FieldPos( "cTurRec" ) ) ]      := cCurSesion()
      aTabla[ ( dbfFacCliP )->( FieldPos( "cCodCaj" ) ) ]      := Application():CodigoCaja()

      if aTabla[ ( dbfFacCliP )->( FieldPos( "lCobrado" ) ) ]
         aTabla[ ( dbfFacCliP )->( FieldPos( "dEntrada" ) ) ]  := cFecDoc
      else
         aTabla[ ( dbfFacCliP )->( FieldPos( "dEntrada" ) ) ]  := Ctod("")
      end

   end

   if dbDialogLock( cDbf, .T. )
      aEval( aTabla, { | uTmp, n | ( cDbf )->( fieldPut( n, uTmp ) ) } )
      ( cDbf )->( dbUnLock() )
   end

   if lCab
      ( cDbf )->( OrdSetFocus( nOrdAnt ) )
   end

   ( cDbf )->( dbGoTo( nRec ) )

RETURN ( .T. )



STATIC FUNCTION DupFactura( cFecDoc )

   local nNewNumFac  := 0



   nNewNumFac  := nNewDoc( ( D():FacturasRectificativas( nView ) )->cSerie, D():FacturasRectificativas( nView ), "NFACREC", , dbfCount )



   FacRecDup( D():FacturasRectificativas( nView ), ( D():FacturasRectificativas( nView ) )->cSerie, nNewNumFac, ( D():FacturasRectificativas( nView ) )->cSufFac, .T., cFecDoc )



   if ( D():FacturasRectificativasLineas( nView ) )->( dbSeek( ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac ) )


      while ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac == ( D():FacturasRectificativasLineas( nView ) )->cSerie + Str( ( D():FacturasRectificativasLineas( nView ) )->nNumFac ) + ( D():FacturasRectificativasLineas( nView ) )->cSufFac .AND.  !( D():FacturasRectificativasLineas( nView ) )->( Eof() )

            FacRecDup( D():FacturasRectificativasLineas( nView ), ( D():FacturasRectificativas( nView ) )->cSerie, nNewNumFac, ( D():FacturasRectificativas( nView ) )->cSufFac, .F. )

         ( D():FacturasRectificativasLineas( nView ) )->( dbSkip() )

      end

   end



   if ( dbfFacCliP )->( dbSeek( ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac ) )



      while ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac == ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac .AND.  !empty( ( dbfFacCliP )->cTipRec ) .AND. !( dbfFacCliP )->( Eof() )

            FacRecDup( dbfFacCliP, ( D():FacturasRectificativas( nView ) )->cSerie, nNewNumFac, ( dbfFacCliT )->cSufFac, .F., cFecDoc, .T. )

         ( dbfFacCliP )->( dbSkip() )

      end

   end



   if ( dbfFacRecD )->( dbSeek( ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac ) )


      while ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac == ( dbfFacRecD )->cSerie + Str( ( dbfFacRecD )->nNumFac ) + ( dbfFacRecD )->cSufFac .AND.  !( dbfFacRecD )->( Eof() )

            FacRecDup( dbfFacRecD, ( D():FacturasRectificativas( nView ) )->cSerie, nNewNumFac, ( D():FacturasRectificativas( nView ) )->cSufFac, .F. )

         ( dbfFacRecD )->( dbSkip() )

      end

   end

RETURN ( .T. )



STATIC FUNCTION ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 16 ]:VarGet





   if ( empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if oUndMedicion:oDbf:Seek( aTmp[ 16 ] )

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !empty( oUndMedicion:oDbf:cTextoDim1 )
            if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( ( D():Articulos( nView ) )->nLngArt )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := ( D():Articulos( nView ) )->nLngArt
            end
         else
            if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 2 .AND. !empty( oUndMedicion:oDbf:cTextoDim2 )
            if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( ( D():Articulos( nView ) )->nAltArt )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := ( D():Articulos( nView ) )->nAltArt
            end

         else
            if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
                 aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 3 .AND. !empty( oUndMedicion:oDbf:cTextoDim3 )

            if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( ( D():Articulos( nView ) ) ->nAncArt )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := ( D():Articulos( nView ) )->nAncArt
            end

         else

            if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := 0
            end

         end

      else

         if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !empty( aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

RETURN .T.



Static Function ChangeTarifa( aTmp, aGet, aTmpFac )

   local nPrePro

   nPrePro        := nPrePro( aTmp[ 4 ], aTmp[ 27 ], aTmp[ 29 ], aTmp[ 28 ], aTmp[ 30 ], aTmp[ 71 ], aTmpFac[ 58 ], dbfArtDiv, aTmpFac[ 22 ] )

   if nPrePro == 0
      nPrePro     := nRetPreArt( aTmp[ 71 ], aTmpFac[ 60 ], aTmpFac[ 58 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
   end

   if !empty( aTmpFac[ 22 ] )
      nPrePro     := RetPrcTar( aTmp[ 4 ], aTmpFac[ 22 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], dbfTarPreL, aTmp[ 71 ] )
   end

   if nPrePro <> 0
      aGet[ 6 ]:cText( nPrePro )
   end

return .T.



Static Function loadComisionAgente( aTmp, aGet, aTmpFac )

   local nComisionAgenteTarifa

   nComisionAgenteTarifa      := nComisionAgenteTarifa( aTmpFac[ 20 ], aTmp[ 71 ], nView )
   if nComisionAgenteTarifa == 0
      nComisionAgenteTarifa   := aTmpFac[ 24 ]
   end

   if !empty( aGet[ 17 ] )
      aGet[ 17 ]:cText( nComisionAgenteTarifa )
   else
      aTmp[ 17 ]        := nComisionAgenteTarifa
   end

return .T.
#line 10058 ".\.\Prg\Facrec.prg"
Static Function DataReport( oFr )

   local np





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Facturas rectificativas", ( D():FacturasRectificativas( nView ) )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Facturas rectificativas", cItemsToReport( aItmFacRec() ) )

   oFr:SetWorkArea(     "Lineas de facturas rectificativas", ( D():FacturasRectificativasLineas( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de facturas rectificativas", cItemsToReport( aColFacRec() ) )

   oFr:SetWorkArea(     "Series de lineas de facturas rectificativas", ( dbfFacRecS )->( Select() ) )
   oFr:SetFieldAliases( "Series de lineas de facturas rectificativas", cItemsToReport( aSerFacRec() ) )

   oFr:SetWorkArea(     "Incidencias de facturas rectificativas", ( dbfFacRecI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de facturas rectificativas", cItemsToReport( aIncFacRec() ) )

   oFr:SetWorkArea(     "Documentos de facturas rectificativas", ( dbfFacRecD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de facturas rectificativas", cItemsToReport( aFacRecDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Clientes", ( D():Clientes( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Clientes", cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Obras", ( dbfObrasT )->( Select() ) )
   oFr:SetFieldAliases( "Obras",  cItemsToReport( aItmObr() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Rutas", ( dbfRuta )->( Select() ) )
   oFr:SetFieldAliases( "Rutas", cItemsToReport( aItmRut() ) )

   oFr:SetWorkArea(     "Agentes", ( dbfAgent )->( Select() ) )
   oFr:SetFieldAliases( "Agentes", cItemsToReport( aItmAge() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( D():Articulos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Tipo de artículo",  oTipArt:Select() )
   oFr:SetFieldAliases( "Tipo de artículo",  cObjectsToReport( oTipArt:oDbf ) )

   oFr:SetWorkArea(     "Ofertas", ( dbfOferta )->( Select() ) )
   oFr:SetFieldAliases( "Ofertas", cItemsToReport( aItmOfe() ) )

   oFr:SetWorkArea(     "Bancos", ( dbfCliBnc )->( Select() ) )
   oFr:SetFieldAliases( "Bancos", cItemsToReport( aCliBnc() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetWorkArea(     "Impuestos especiales",  oNewImp:Select() )
   oFr:SetFieldAliases( "Impuestos especiales",  cObjectsToReport( oNewImp:oDbf ) )

   oFr:SetWorkArea(     "Transportistas", oTrans:Select() )
   oFr:SetFieldAliases( "Transportistas", cObjectsToReport( oTrans:oDbf ) )







   oFr:setUserDataSet( "Impuestos factura", "porcentajeiva;logrecargo;porcentajere;bruto;neto;impiva;impre;nivmh;ntransporte;npntver", {||np := 1},    {||np := np + 1},    {||np := np - 1},    {||np > Len( aTotIva )}, {|key| hGet( aTotIva[np], key ) } )

   oFr:SetMasterDetail( "Facturas rectificativas", "Lineas de facturas rectificativas",            {|| ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Incidencias de facturas rectificativas",       {|| ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Documentos de facturas rectificativas",        {|| ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Empresa",                                      {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Clientes",                                     {|| ( D():FacturasRectificativas( nView ) )->cCodCli } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Obras",                                        {|| ( D():FacturasRectificativas( nView ) )->cCodCli + ( D():FacturasRectificativas( nView ) )->cCodObr } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Almacen",                                      {|| ( D():FacturasRectificativas( nView ) )->cCodAlm } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Rutas",                                        {|| ( D():FacturasRectificativas( nView ) )->cCodRut } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Agentes",                                      {|| ( D():FacturasRectificativas( nView ) )->cCodAge } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Formas de pago",                               {|| ( D():FacturasRectificativas( nView ) )->cCodPago } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Bancos",                                       {|| ( D():FacturasRectificativas( nView ) )->cCodCli } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Transportistas",                                   {|| ( D():FacturasRectificativas( nView ) )->cCodTrn } )

   oFr:SetMasterDetail( "Lineas de facturas rectificativas", "Artículos",                          {|| SynchronizeDetails() } )
   oFr:SetMasterDetail( "Lineas de facturas rectificativas", "Tipo de artículo",                   {|| ( D():FacturasRectificativasLineas( nView ) )->cCodTip } )
   oFr:SetMasterDetail( "Lineas de facturas rectificativas", "Ofertas",                            {|| ( D():FacturasRectificativasLineas( nView ) )->cRef } )
   oFr:SetMasterDetail( "Lineas de facturas rectificativas", "Unidades de medición",               {|| ( D():FacturasRectificativasLineas( nView ) )->cUnidad } )
   oFr:SetMasterDetail( "Lineas de facturas rectificativas", "Impuestos especiales",               {|| ( D():FacturasRectificativasLineas( nView ) )->cCodImp } )
   oFr:SetMasterDetail( "Lineas de facturas rectificativas", "Series de lineas de facturas rectificativas",      {|| ( D():FacturasRectificativasLineas( nView ) )->cSerie + Str( ( D():FacturasRectificativasLineas( nView ) )->nNumFac ) + ( D():FacturasRectificativasLineas( nView ) )->cSufFac + Str( ( D():FacturasRectificativasLineas( nView ) )->nNumLin ) } )

   oFr:SetResyncPair(   "Facturas rectificativas", "Lineas de facturas rectificativas" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Incidencias de facturas rectificativas" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Documentos de facturas rectificativas" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Empresa" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Clientes" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Obras" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Almacenes" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Rutas" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Agentes" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Formas de pago" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Bancos" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Transportistas" )

   oFr:SetResyncPair(   "Lineas de facturas rectificativas", "Artículos" )
   oFr:SetResyncPair(   "Lineas de facturas rectificativas", "Tipo de artículo" )
   oFr:SetResyncPair(   "Lineas de facturas rectificativas", "Ofertas" )
   oFr:SetResyncPair(   "Lineas de facturas rectificativas", "Unidades de medición" )
   oFr:SetResyncPair(   "Lineas de facturas rectificativas", "Impuestos especiales" )
   oFr:SetResyncPair(   "Lineas de facturas rectificativas", "Series de lineas de facturas rectificativas" )

Return nil



Static Function SynchronizeDetails()

Return ( ( D():FacturasRectificativasLineas( nView ) )->cRef )



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Facturas rectificativas" )
   oFr:DeleteCategory(  "Lineas de facturas rectificativas" )





   oFr:AddVariable(     "Facturas rectificativas",             "Total factura",                       "GetHbVar('nTotFac')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total descuentos",                    "GetHbVar('nTotalDto')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total primer descuento definible",    "GetHbVar('nTotUno')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total segundo descuento definible",   "GetHbVar('nTotDos')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total " + cImp(),                     "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total página",                        "GetHbVar('nTotPag')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total retención",                     "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total peso",                          "GetHbVar('nTotPes')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total costo",                         "GetHbVar('nTotCos')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total anticipado",                    "GetHbVar('nTotAnt')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total cobrado",                       "GetHbVar('nTotCob')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total artículos",                     "GetHbVar('nTotArt')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total cajas",                         "GetHbVar('nTotCaj')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Cuenta por defecto del cliente",      "GetHbVar('cCtaCli')" )

   oFr:AddVariable(     "Facturas rectificativas",             "Total unidades primer tipo de impuestos especiales",            "GetHbArrayVar('aIvmUno',1 )" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total unidades segundo tipo de impuestos especiales",           "GetHbArrayVar('aIvmDos',1 )" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total unidades tercer tipo de impuestos especiales",            "GetHbArrayVar('aIvmTre',1 )" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe del primer tipo de impuestos especiales",               "GetHbArrayVar('aIvmUno',2 )" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe del segundo tipo de impuestos especiales",              "GetHbArrayVar('aIvmDos',2 )" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe del tercer tipo de impuestos especiales",               "GetHbArrayVar('aIvmTre',2 )" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total importe primer tipo de impuestos especiales",             "GetHbArrayVar('aIvmUno',3 )" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total importe segundo tipo de impuestos especiales",            "GetHbArrayVar('aIvmDos',3 )" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total importe tercer tipo de impuestos especiales",             "GetHbArrayVar('aIvmTre',3 )" )

   oFr:AddVariable(     "Facturas rectificativas",             "Cuenta bancaria cliente",             "CallHbFunc('cCtaFacRec')" )

   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Detalle del artículo",                "CallHbFunc('cDesFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Detalle del artículo otro lenguaje",  "CallHbFunc('cDesFacRecLeng')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Total unidades artículo",             "CallHbFunc('nTotNFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Precio unitario del artículo",        "CallHbFunc('nTotUFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Precio unitario con descuentos",      "CallHbFunc('nTotPFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Punto verde del artículo",            "CallHbFunc('nPntUFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Total línea de factura",              "CallHbFunc('nTotLFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Total peso por línea",                "CallHbFunc('nPesLFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Total final línea del factura",       "CallHbFunc('nTotFFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Importe descuento línea del factura", "CallHbFunc('nDtoLFacRec')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Total descuento línea del factura",   "CallHbFunc('nTotDtoLFacRec')" )

Return nil



Static Function YearComboBoxChange()

   if ( oWndBrw:oWndBar:cYearComboBox() <> "[Todos]" )
      oWndBrw:oWndBar:setYearComboBoxExpression( "Year( Field->dFecFac ) == " + oWndBrw:oWndBar:cYearComboBox() )
   else
      oWndBrw:oWndBar:setYearComboBoxExpression( "" )
   end

   oWndBrw:chgFilter()

Return nil



STATIC FUNCTION lLiquida( oBrw, cFactura )

   If( cFactura == nil, cFactura := ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, ) ;

   if ( D():FacturasRectificativas( nView ) )->lLiquidada
      msgStop( "Factura ya cobrada", "Imposible añadir cobros" )
      return .F.
   end





   ( dbfFacCliP )->( dbGoTop() )

   if ( dbfFacCliP )->( dbSeek( cFactura ) )

      while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFactura .AND. !( dbfFacCliP )->( eof() )

         if !empty( ( dbfFacCliP )->cTipRec ) .AND. !( dbfFacCliP )->lCobrado

            EdtRecCli( ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac + Str( ( dbfFacCliP )->nNumRec ) + ( dbfFacCliP )->cTipRec, .F. )

            exit

         end

         ( dbfFacCliP )->( dbSkip() )

      end

   end





   ChkLqdFacRec( nil, D():FacturasRectificativas( nView ), D():FacturasRectificativasLineas( nView ), dbfFacCliP, dbfIva, dbfDiv )

   oBrw:Refresh()
   oBrw:SetFocus()

Return .T.



static function lBuscaOferta( cCodArt, aGet, aTmp, aTmpFac, dbfOferta, dbfDiv, dbfKit, dbfIva  )

   local sOfeArt
   local nTotalLinea    := 0


   if ( D():Articulos( nView ) )->Codigo == cCodArt .OR. ( D():Articulos( nView ) )->( dbSeek( cCodArt ) )





      nTotalLinea       := lCalcDeta( aTmp, aTmpFac, .T. )

      sOfeArt           := sOfertaArticulo( cCodArt, aTmpFac[ 7 ], aTmpFac[ 81 ], aTmp[ 18 ], aTmpFac[ 6 ], dbfOferta, aTmp[ 71 ], aTmpFac[ 58 ], aTmp[27], aTmp[28], aTmp[29], aTmp[30], aTmp[ 60 ], aTmp[ 12 ], nTotalLinea )

      if !empty( sOfeArt )
         if ( sOfeArt:nPrecio <> 0 )
            aGet[ 6 ]:cText( sOfeArt:nPrecio )
         end
         if ( sOfeArt:nDtoPorcentual <> 0 )
            aGet[ 9     ]:cText( sOfeArt:nDtoPorcentual )
         end
         if ( sOfeArt:nDtoLineal <> 0)
            aGet[ 32  ]:cText( sOfeArt:nDtoLineal )
         end
         aTmp[ 73  ] := .T.
      end

      if !aTmp[ 73 ]





         sOfeArt     := sOfertaFamilia( ( D():Articulos( nView ) )->Familia, aTmpFac[ 7 ], aTmpFac[ 81 ], aTmpFac[ 6 ], dbfOferta, aTmp[ 71 ], D():Articulos( nView ), aTmp[ 18 ], aTmp[ 12 ], nTotalLinea )

         if !empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 32 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 73 ]  := .T.
         end

      end

      if !aTmp[ 73 ]





         sOfeArt     := sOfertaTipoArticulo( ( D():Articulos( nView ) )->cCodTip, aTmpFac[ 7 ], aTmpFac[ 81 ], aTmpFac[ 6 ], dbfOferta, aTmp[ 71 ], D():Articulos( nView ), aTmp[ 18 ], aTmp[ 12 ], nTotalLinea )

         if !empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 32 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 73 ]  := .T.
         end

      end

      if !aTmp[ 73 ]





         sOfeArt     := sOfertaCategoria( ( D():Articulos( nView ) )->cCodCate, aTmpFac[ 7 ], aTmpFac[ 81 ], aTmpFac[ 6 ], dbfOferta, aTmp[ 71 ], D():Articulos( nView ), aTmp[ 18 ], aTmp[ 12 ], nTotalLinea )

         if !empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 32 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 73 ]  := .T.
         end

      end

      if !aTmp[ 73 ]





         sOfeArt     := sOfertaTemporada( ( D():Articulos( nView ) )->cCodTemp, aTmpFac[ 7 ], aTmpFac[ 81 ], aTmpFac[ 6 ], dbfOferta, aTmp[ 71 ], D():Articulos( nView ), aTmp[ 18 ], aTmp[ 12 ], nTotalLinea )

         if !empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 32 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 73 ]  := .T.
         end

      end

      if !aTmp[ 73 ]





         sOfeArt     := sOfertaFabricante( ( D():Articulos( nView ) )->cCodFab, aTmpFac[ 7 ], aTmpFac[ 81 ], aTmpFac[ 6 ], dbfOferta, aTmp[ 71 ], D():Articulos( nView ), aTmp[ 18 ], aTmp[ 12 ], nTotalLinea )

         if !empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 9    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 32 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 73 ]  := .T.
         end

      end

   end

return .T.



Static Function lValidLote( aTmp, aGet, oStkAct )

   if !uFieldEmpresa( "lNStkAct" )
      StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 38 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ], oStkAct )
   end

   if !empty( aGet[ 45 ] )
      aGet[ 45 ]:cText( StocksModel():getFechaCaducidad( aTmp[ 4 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 29 ], aTmp[ 30 ], aTmp[ 44 ] ) )
   end

Return ( .T. )



Static Function EditarNumeroSerie( aTmp, oStock, nMode )

   with object ( TNumerosSerie() )

      :nMode            := nMode

      :cCodArt          := aTmp[ 4    ]
      :cCodAlm          := aTmp[ 38 ]
      :nNumLin          := aTmp[ 34 ]

      :nTotalUnidades   := nTotNFacRec( aTmp )

      :oStock           := oStock

      :uTmpSer          := dbfTmpSer

      :Resource()

   end

Return ( nil )



Static Function OldEditarNumeroSerie( aTmp, oStock, nMode )

   local n
   local oDlg
   local nTotUnd
   local cCodArt
   local cCodAlm
   local oBrwSer
   local aNumSer
   local aValSer
   local cPreFix  := Space( 18 )
   local oSerIni
   local nSerIni  := 0
   local oSerFin
   local nSerFin  := 0
   local oNumGen
   local nNumGen  := 0
   local oSaySer
   local cSaySer  := ""
   local oProSer
   local nProSer

   If( nMode == nil, nMode := 1, ) ;

   nTotUnd        := Abs( nTotNFacRec( aTmp ) )

   if nTotUnd == 0
      MsgStop( "No hay unidades para asignar números de serie." )
      Return ( nil )
   end

   n              := 1

   cCodArt        := aTmp[ 4    ]
   cCodAlm        := aTmp[ 38 ]

   aNumSer        := Afill( Array( nTotUnd ), Space( 30 ) )
   aValSer        := Afill( Array( nTotUnd ), .F. )

   if ( dbfTmpSer )->( dbSeek( Str( aTmp[ 34 ], 4 ) + aTmp[ 4 ] ) )
      while ( Str( ( dbfTmpSer )->nNumLin, 4 ) + ( dbfTmpSer )->cRef == Str( aTmp[ 34 ], 4 ) + aTmp[ 4 ] ) .AND. !( dbfTmpSer )->( Eof() )
         if ( n <= nTotUnd )
            aNumSer[ n ]   := ( dbfTmpSer )->cNumSer
         end
         ( dbfTmpSer )->( dbSkip() )
         n++
      end
   end

   oDlg = TDialog():New(,,,,, "VTANUMSER",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, nTotUnd, nTotUnd:= u ) }, oDlg,, MasUnd(),,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cPreFix, cPreFix:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      oSerIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nSerIni, nSerIni:= u ) }, oDlg,, "99999999999999999999", {||    ( oSerFin:cText( nSerIni + nTotUnd ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      oSerFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nSerFin, nSerFin:= u ) }, oDlg,, "99999999999999999999",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      oNumGen := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, nNumGen, nNumGen:= u ) }, oDlg,, "99999999999999999999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TButton():ReDefine( 500, {||( oDlg:Disable(), GenNumSer( cPreFix, aNumSer, nSerIni, nNumGen, oBrwSer, oProSer ), lValSer( cCodArt, cCodAlm, aNumSer, aValSer, nTotUnd, oStock, oBrwSer, oProSer, oSaySer ), oDlg:Enable() )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )

      oBrwSer                 := IXBrowse():New( oDlg )

      oBrwSer:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwSer:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwSer:lHScroll        := .F.
      oBrwSer:lRecordSelector := .T.
      oBrwSer:lFastEdit       := .T.

      oBrwSer:nMarqueeStyle   := 3

      oBrwSer:SetArray( aNumSer, , , .F. )

      oBrwSer:nColSel         := 2

      with object ( oBrwSer:addCol() )
         :cHeader             := "N."
         :bStrData            := {|| Trans( oBrwSer:nArrayAt, "999999" ) }
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwSer:addCol() )
         :cHeader             := "Serie"
         :bEditValue          := {|| aNumSer[ oBrwSer:nArrayAt ] }
         :nWidth              := 220
         if nMode <> 3
            :nEditType        := 1
         end
         :bOnPostEdit         := {|o,x| aNumSer[ oBrwSer:nArrayAt ] := x, aValSer[ oBrwSer:nArrayAt ] := oStock:lValidNumeroSerie( cCodArt, cCodAlm, x ) }
      end

      with object ( oBrwSer:addCol() )
         :cHeader             := "Es."
         :nHeadBmpNo          := 4
         :bStrData            := {|| "" }
         :bBmpData            := {|| if( aValSer[ oBrwSer:nArrayAt ], 3, 1 ) }
         :nWidth              := 20
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_check_12" )
         :AddResource( "gc_document_information_16" )
      end

      oBrwSer:CreateFromResource( 150 )



      oSaySer := TSay():ReDefine( 230, {|| cSaySer}, oDlg,,,, .F.,, .F., .F., )

      oProSer     := TApoloMeter():ReDefine( 240, { | u | if( pCount() == 0, nProSer, nProSer := u ) }, 10, oDlg, .F., , , .T., ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), , ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) ) )





      TButton():ReDefine( 510, {||( if( lChkSer( aValSer, nTotUnd, oProSer, oBrwSer ), SalvarNumeroSerie( aNumSer, aTmp, oProSer, oDlg ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 520, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F. )

      oDlg:bStart := {|| oDlg:Disable(), lValSer( cCodArt, cCodAlm, aNumSer, aValSer, nTotUnd, oStock, oBrwSer, oProSer, oSaySer ), oDlg:Enable() }

      oDlg:AddFastKey( 116, {|| if( lChkSer( aValSer, nTotUnd, oProSer, oBrwSer ), SalvarNumeroSerie( aNumSer, aTmp, oProSer, oDlg ),  ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( nil )



Static Function lValSer( cCodArt, cCodAlm, aNumSer, aValSer, nTotUnd, oStock, oBrwSer, oProSer, oSaySer )

   local n
   local lValid         := .T.

   CursorWait()

   if !empty( oProSer )
      oProSer:Show()
      oProSer:SetTotal( nTotUnd )
   end

   if !empty( oSaySer )
      oSaySer:SetText( "Calculando disponibilidad del stock..." )
   end

   for n := 1 to nTotUnd

      if !empty( aNumSer[ n ] )

         aValSer[ n ]   := oStock:lValidNumeroSerie( cCodArt, cCodAlm, aNumSer[ n ] )

         if !aValSer[ n ]
            lValid      := .F.
         end

      else

         lValid         := .F.

      end

      if !empty( oProSer ) .AND. ( Mod( n, int( nTotUnd / 100 ) ) == 0 )
         oProSer:Set( n )
      end

   next

   if !empty( oBrwSer )
      oBrwSer:Refresh()
   end

   if !empty( oProSer )
      oProSer:Set( 0 )
      oProSer:Hide()
   end

   if !empty( oSaySer )
      oSaySer:SetText( "" )
   end

   CursorWE()

Return ( lValid )



Static Function lChkSer( aValSer, nTotUnd, oProSer, oBrwSer )

   local l
   local n
   local lValid            := .T.

   CursorWait()

   if !empty( oProSer )
      oProSer:Show()
      oProSer:SetTotal( nTotUnd )
   end

   for each l in aValSer

      if IsFalse( l )

         lValid            := .F.
         n                 := hb_EnumIndex()
         exit

      else

         if !empty( oProSer )
            oProSer:Set( hb_EnumIndex() )
         end

      end

   next

   if !lValid

      if uFieldEmpresa( "lSerNoCom" )
         msgStop( "Hay números de serie sin stock para su venta." )
      else
         lValid            := ApoloMsgNoYes( "Hay números de serie sin stock para su venta.", "¿Desea continuar con la venta?" )
      end

      if !empty( oBrwSer ) .AND. IsNum( n )
         oBrwSer:nArrayAt  := n
         oBrwSer:Refresh()
      end

   end

   if !empty( oProSer )
      oProSer:Hide()
   end

   CursorWE()

Return ( lValid )



Static Function SalvarNumeroSerie( aNumSer, aTmp, oProSer, oDlg )

   local cNumSer
   local nTotUnd              := len( aNumSer )

   oDlg:Disable()

   EliminarNumeroSerie( aTmp )

   if !empty( oProSer )
      oProSer:SetTotal( nTotUnd )
   end

   for each cNumSer in aNumSer

      ( dbfTmpSer )->( dbAppend() )
      ( dbfTmpSer )->cRef        := aTmp[ 4        ]
      ( dbfTmpSer )->cAlmLin     := aTmp[ 38     ]
      ( dbfTmpSer )->nNumLin     := aTmp[ 34     ]
      ( dbfTmpSer )->cNumSer     := cNumSer

      if !empty( oProSer ) .AND. ( Mod( hb_enumindex(), int( nTotUnd / 100 ) ) == 0 )
         oProSer:Set( hb_enumindex() )
      end

   next

   oDlg:Enable()
   oDlg:End()

Return ( nil )



Static Function EliminarNumeroSerie( aTmp )

   while ( ( dbfTmpSer )->( dbSeek( Str( aTmp[ 34 ], 4 ) + aTmp[ 4 ] ) ) ) .AND. !( dbfTmpSer )->( Eof() )
      ( dbfTmpSer )->( dbDelete() )
   end

Return ( nil )



Static Function hValue( aTmp, aTmpFac )

   local hValue                  := {=>}

   do case
      case ValType( aTmp ) == "A"

         hValue[ "cCodigoArticulo"   ] := aTmp[ 4 ]
         hValue[ "cCodigoPropiedad1" ] := aTmp[ 27 ]
         hValue[ "cCodigoPropiedad2" ] := aTmp[ 28 ]
         hValue[ "cValorPropiedad1"  ] := aTmp[ 29 ]
         hValue[ "cValorPropiedad2"  ] := aTmp[ 30 ]
         hValue[ "cCodigoFamilia"    ] := aTmp[ 53 ]
         hValue[ "nTarifaPrecio"     ] := aTmp[ 71 ]
         hValue[ "nCajas"            ] := aTmp[ 12 ]
         hValue[ "nUnidades"         ] := aTmp[ 18 ]

      case ValType( aTmp ) == "C"

         hValue[ "cCodigoArticulo"   ] := ( aTmp )->cRef
         hValue[ "cCodigoPropiedad1" ] := ( aTmp )->cCodPr1
         hValue[ "cCodigoPropiedad2" ] := ( aTmp )->cCodPr2
         hValue[ "cValorPropiedad1"  ] := ( aTmp )->cValPr1
         hValue[ "cValorPropiedad2"  ] := ( aTmp )->cValPr2
         hValue[ "cCodigoFamilia"    ] := ( aTmp )->cCodFam
         hValue[ "nTarifaPrecio"     ] := ( aTmp )->nTarLin
         hValue[ "nCajas"            ] := ( aTmp )->nCanEnt
         hValue[ "nUnidades"         ] := ( aTmp )->nUniCaja

   end

   do case
      case ValType( aTmpFac ) == "A"

         hValue[ "cCodigoCliente"    ] := aTmpFac[ 7 ]
         hValue[ "cCodigoGrupo"      ] := aTmpFac[ 81 ]
         hValue[ "lIvaIncluido"      ] := aTmpFac[ 58 ]
         hValue[ "dFecha"            ] := aTmpFac[ 6 ]
         hValue[ "nDescuentoTarifa"  ] := aTmpFac[ 102 ]

      case ValType( aTmpFac ) == "C"

         hValue[ "cCodigoCliente"    ] := ( aTmpFac )->cCodCli
         hValue[ "cCodigoGrupo"      ] := ( aTmpFac )->cCodGrp
         hValue[ "lIvaIncluido"      ] := ( aTmpFac )->lIvaInc
         hValue[ "dFecha"            ] := ( aTmpFac )->dFecFac
         hValue[ "nDescuentoTarifa"  ] := ( aTmpFac )->nDtoTarifa

   end

   hValue[ "nTipoDocumento"         ] := "14"
   hValue[ "nView"                  ] := nView

Return ( hValue )



Static Function ImprimirSeriesFacturasRectificativas( nDevice, lExt )

   local aStatus
   local oPrinter
   local cFormato

   If( nDevice == nil, nDevice := 1, ) ;
   If( lExt == nil, lExt := .F., ) ;



   oPrinter          := PrintSeries():New( nView ):SetVentas()



   oPrinter:Serie(      ( D():FacturasRectificativas( nView ) )->cSerie )
   oPrinter:Documento(  ( D():FacturasRectificativas( nView ) )->nNumFac )
   oPrinter:Sufijo(     ( D():FacturasRectificativas( nView ) )->cSufFac )

   if lExt

      oPrinter:oFechaInicio:cText( ( D():FacturasRectificativas( nView ) )->dFecFac )
      oPrinter:oFechaFin:cText( ( D():FacturasRectificativas( nView ) )->dFecFac )

   end

   oPrinter:oFormatoDocumento:TypeDocumento( "FR" )



   cFormato          := cFormatoDocumento( ( D():FacturasRectificativas( nView ) )->cSerie, "nFacRec", D():Contadores( nView ) )
   if empty( cFormato )
      cFormato       := cFirstDoc( "FR", D():Documentos( nView ) )
   end
   oPrinter:oFormatoDocumento:cText( cFormato )



   aStatus           := D():GetInitStatus( "FacRecT", nView )

   oPrinter:bInit    := {||   ( D():FacturasRectificativas( nView ) )->( dbSeek( oPrinter:DocumentoInicio(), .T. ) ) }


   oPrinter:bWhile   := {||   oPrinter:InRangeDocumento( D():FacturasRectificativasId( nView ) )                  .AND.  ( D():FacturasRectificativas( nView ) )->( !eof() ) }



   oPrinter:bFor     := {||   oPrinter:InRangeFecha( ( D():FacturasRectificativas( nView ) )->dFecFac )           .AND.  oPrinter:InRangeCliente( ( D():FacturasRectificativas( nView ) )->cCodCli )         .AND.  oPrinter:InRangeGrupoCliente( retGrpCli( ( D():FacturasRectificativas( nView ) )->cCodCli, D():Clientes( nView ) ) ) }

   oPrinter:bSkip    := {||   ( D():FacturasRectificativas( nView ) )->( dbSkip() ) }





   oPrinter:bAction  := {||   GenFacRec(  nDevice, "Imprimiendo documento : " + D():FacturasRectificativasId( nView ), oPrinter:oFormatoDocumento:uGetValue, oPrinter:oImpresora:uGetValue, if( !oPrinter:oCopias:lCopiasPredeterminadas, oPrinter:oCopias:uGetValue, ) ) }

   oPrinter:bStart   := {||   if( lExt, oPrinter:DisableRange(), ) }



   oPrinter:Resource():End()



   D():SetStatus( "FacRecT", nView, aStatus )

   if !empty( oWndBrw )
      oWndBrw:Refresh()
   end

Return .T.









FUNCTION nBrtLFacRec( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( nDec == nil, nDec := 2, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nTotUFacRec( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo          *= nTotNFacRec( uTmpLin )

   nCalculo          := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )







FUNCTION nIvaUFacRec( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacRec( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    := nCalculo * ( dbfTmpLin )->nIva / 100
   else
      nCalculo    -= nCalculo / ( 1 + ( dbfTmpLin )->nIva / 100 )
   end

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






FUNCTION nIncUFacRec( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacRec( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmpLin )->nIva / 100
   end

    IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
    end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nDtoUFacRec( dbfTmpLin, nDec, nVdv )

   local nCalculo := ( dbfTmpLin )->nDtoDiv

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

    IF nVdv <> 0
      nCalculo    := ( dbfTmpLin )->nDtoDiv / nVdv
    end

RETURN ( round( nCalculo, nDec ) )



FUNCTION nIvaLFacRec( cFacRecL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo    := 0

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .T., ) ;
   If( lImpTrn == nil, lImpTrn := .T., ) ;

   if ( cFacRecL )->nRegIva <= 1

      nCalculo          := nTotLFacRec( cFacRecL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

      if !( cFacRecL )->lIvaLin
         nCalculo       := nCalculo * ( cFacRecL )->nIva / 100
      else
         nCalculo       -= nCalculo / ( 1 + ( cFacRecL )->nIva / 100 )
      end

   end

   nCalculo          := Round( nCalculo, nRou )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )






FUNCTION nIncLFacRec( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo := nTotLFacRec( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn )

   if !( dbfLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )







FUNCTION nPntUFacRec( cFacRecL, nDec, nVdv )

   local nCalculo

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := ( cFacRecL )->nPntVer

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






FUNCTION nPntLFacRec( cFacRecL, nDec, nVdv )

   local nPntVer

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;





   nPntVer           := nPntUFacRec( cFacRecL, nDec, nVdv ) * nTotNFacRec( cFacRecL )

RETURN ( Round( nPntVer, nDec ) )



FUNCTION nTrnUFacRec( dbfTmpLin, nDec, nVdv )

    local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nImpTrn

    IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
    end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nTrnLFacRec( dbfLin, nDec, nRou, nVdv )

   local nImpTrn

   If( dbfLin == nil, dbfLin := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := 2, ) ;
   If( nRou == nil, nRou := 2, ) ;
   If( nVdv == nil, nVdv := 1, ) ;





   nImpTrn           := nTrnUFacRec( dbfLin, nDec ) * nTotNFacRec( dbfLin )

   IF nVdv <> 0
      nImpTrn        := nImpTrn / nVdv
    end

RETURN ( Round( nImpTrn, nRou ) )



FUNCTION nComLFacRec( cFacRecT, dbfFacRecL, nDecOut, nDerOut )

   local nImpLFacRec  := nImpLFacRec( cFacRecT, dbfFacRecL, nDecOut, nDerOut, , .F., .T., .F., .F. )

RETURN ( nImpLFacRec * ( dbfFacRecL )->nComAge / 100 )



FUNCTION aTotFacRec( cFactura, cFacRecT, dbfFacRecL, dbfIva, dbfDiv, cDivRet )

   nTotFacRec( cFactura, cFacRecT, dbfFacRecL, dbfIva, dbfDiv, nil, cDivRet )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotFac, nTotPnt, nTotTrn, nTotAge, aTotIva, nTotCos, nTotIvm, nTotRnt, nTotRet } )







FUNCTION nNetFacRec( cFactura, dbfFact, dbfLine, dbfIva, dbfDiv )

   nTotFacRec( cFactura, dbfFact, dbfLine, dbfIva, dbfDiv )

RETURN nTotNet



FUNCTION nCosLFacRec( dbfLine, nDec, nRec, nVdv, cPouDiv )

   local nCalculo       := 0

   If( nDec == nil, nDec := 0, ) ;
   If( nRec == nil, nRec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLine )->lKitChl
      nCalculo          := nTotNFacRec( dbfLine )
      nCalculo          *= ( dbfLine )->nCosDiv
   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   nCalculo             := Round( nCalculo, nRec )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )







FUNCTION nTotFacRec( cFactura, cFacRecT, cFacRecL, cIva, cDiv, aTmp, cDivRet, lPic, lExcCnt )

   local nRec
   local bCondition
   local lRecargo
   local nDtoUno
   local nDtoDos
   local nDtoEsp
   local nPctRet
   local nDtoPP
   local nPorte
   local nIvaMan
   local nManObr
   local lIvaInc
   local nKgsTrn
   local nTotArt           := 0
   local nTotLin           := 0
   local nTotUnd           := 0
   local aTotalDto         := { 0, 0, 0 }
   local aTotalDPP         := { 0, 0, 0 }
   local aTotalUno         := { 0, 0, 0 }
   local aTotalDos         := { 0, 0, 0 }
   local aTotalBase           := { 0, 0, 0 }
   local nDescuentosLineas := 0
   local lPntVer           := .F.
   local nRegIva
   local nBaseGasto
   local nIvaGasto

   local oTotalDoc            := nTotalDocumento():new( nView )

   if !empty( nView )
      If( cFacRecT == nil, cFacRecT := D():FacturasRectificativas( nView ), ) ;
      If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   end

   If( cIva == nil, cIva := cIva, ) ;
   If( cDiv == nil, cDiv := cDiv, ) ;
   If( cFactura == nil, cFactura := ( cFacRecT )->cSerie + Str( ( cFacRecT )->nNumFac ) + ( cFacRecT )->cSufFac, ) ;
   If( lPic == nil, lPic := .F., ) ;

   public nTotFac          := 0
   public nTotBrt          := 0
   public nTotDto          := 0
   public nTotDPP          := 0
   public nTotNet          := 0
   public nTotIva          := 0
   public nTotIvm          := 0
   public nTotAge          := 0
   public nTotReq          := 0
   public nTotPnt          := 0
   public nTotUno          := 0
   public nTotDos          := 0
   public nTotRet          := 0
   public nTotTrn          := 0
   public nTotAnt          := 0
   public nTotCos          := 0
   public nTotPes          := 0
   public nTotRnt          := 0
   public nPctRnt          := 0
   public nTotDif          := 0
   public cCtaCli          := cClientCuenta( ( cFacRecT )->cCodCli )










   public aTotIva            := {{     "porcentajeiva" => nil,    "logrecargo"    => .F.,    "porcentajere"    => nil,    "bruto"            => nil,    "neto"            => nil,    "impiva"        => nil,    "impre"            => nil,    "nivmh"            => nil,    "ntransporte"    => nil,    "npntver"        => nil }}

   public aIvaUno          := {}
   public aIvaDos          := {}
   public aIvaTre          := {}

   public aTotIvm          := { { 0,0,0 }, { 0,0,0 }, { 0,0,0 }, }
   public aIvmUno          := aTotIvm[ 1 ]
   public aIvmDos          := aTotIvm[ 2 ]
   public aIvmTre          := aTotIvm[ 3 ]

   public aImpVto          := {}
   public aDatVto          := {}

   public nNumArt          := 0
   public nNumCaj          := 0

   public nTotalDto        := 0

   nRec                    := ( cFacRecL )->( Recno() )

   if aTmp <> nil
      nDtoUno              := aTmp[ 46 ]
      nDtoDos              := aTmp[ 48 ]
      lRecargo             := aTmp[ 56]
      nDtoEsp              := aTmp[ 42 ]
      nDtoPP               := aTmp[ 44    ]
      nPorte               := aTmp[ 36 ]
      nIvaMan              := aTmp[ 37 ]
      nManObr              := aTmp[ 38 ]
      lIvaInc              := aTmp[ 58 ]
      cCodDiv              := aTmp[ 60 ]
      nPctRet              := aTmp[ 77 ]
      nKgsTrn              := aTmp[ 73 ]
      lPntVer              := aTmp[ 101 ]
      nRegIva              := aTmp[ 65 ]
      bCondition           := {|| ( cFacRecL )->( !eof() ) }
      ( cFacRecL )->( dbGoTop() )
   else
      nDtoUno              := ( cFacRecT )->nDtoUno
      nDtoDos              := ( cFacRecT )->nDtoDos
      nDtoEsp              := ( cFacRecT )->nDtoEsp
      nDtoPP               := ( cFacRecT )->nDpp
      lRecargo             := ( cFacRecT )->lRecargo
      nPorte               := ( cFacRecT )->nPorTes
      nIvaMan              := ( cFacRecT )->nIvaMan
      nManObr              := ( cFacRecT )->nManObr
      lIvaInc              := ( cFacRecT )->lIvaInc
      cCodDiv              := ( cFacRecT )->cDivFac
      nPctRet              := ( cFacRecT )->nPctRet
      nKgsTrn              := ( cFacRecT )->nKgsTrn
      lPntVer              := ( cFacRecT )->lOperPV
      nRegIva              := ( cFacRecT )->nRegIva
      bCondition           := {|| ( cFacRecL )->cSerie + Str( ( cFacRecL )->nNumFac ) + ( cFacRecL )->cSufFac == cFactura .AND. !( cFacRecL)->( eof() ) }
      ( cFacRecL )->( dbSeek( cFactura ) )
   end





   cPouDiv                 := cPouDiv( cCodDiv, cDiv )
   cPorDiv                 := cPorDiv( cCodDiv, cDiv )
   cPpvDiv                 := cPpvDiv( cCodDiv, cDiv )
   nDouDiv                 := nDouDiv( cCodDiv, cDiv )
   nRouDiv                 := nRouDiv( cCodDiv, cDiv )
   nDpvDiv                 := nDpvDiv( cCodDiv, cDiv )

   while Eval( bCondition )

      if lValLine( cFacRecL )



         if ( lExcCnt == nil                                 .OR. ( lExcCnt .AND. ( cFacRecL )->nCtlStk <> 2 )      .OR. ( !lExcCnt .AND. ( cFacRecL )->nCtlStk == 2 ) )

            if ( cFacRecL )->lTotLin





               if ( cFacRecL )->nPreUnit <> nTotLin .OR. ( cFacRecL )->nUniCaja <> nTotUnd

                  if ( cFacRecL )->( dbRLock() )
                     ( cFacRecL )->nPreUnit := nTotLin
                     ( cFacRecL )->nUniCaja := nTotUnd
                     ( cFacRecL )->( dbUnLock() )
                  end

               end





               nTotLin           := 0
               nTotUnd           := 0

            else

               nTotArt           := nTotLFacRec( cFacRecL, nDouDiv, nRouDiv, , , .F., .F. )
               nTotTrn           := nTrnLFacRec( cFacRecL, nDouDiv )
               nTotIvm           := nTotIFacRec( cFacRecL, nDouDiv, nRouDiv )
               nTotPnt           := if( lPntVer, nPntLFacRec( cFacRecL, nDpvDiv ), 0 )
               nTotCos           += nCosLFacRec( cFacRecL, nDouDiv, nRouDiv )
               nTotPes           += nPesLFacRec( cFacRecL )
               nDescuentosLineas += nTotDtoLFacRec( cFacRecL, nDouDiv )

               if aTmp <> nil
                  nTotAge        += nComLFacRec( aTmp, cFacRecL, nDouDiv, nRouDiv )
               else
                  nTotAge        += nComLFacRec( cFacRecT, cFacRecL, nDouDiv, nRouDiv )
               end





               nTotLin           += nTotArt
               nNumArt           += nTotNFacRec( cFacRecL )
               nNumCaj           += ( cFacRecL )->nCanEnt





               oTotalDoc:setArrayImpuesto( ( cFacRecL )->nIva, lRecargo, ( cFacRecL )->nReq, nTotArt, nTotIvm, nTotTrn, nTotPnt )



                if ( cFacRecL )->nValImp <> 0

                  do case
                     case aTotIvm[ 1, 2 ] == 0 .OR. aTotIvm[ 1, 2 ] == ( cFacRecL )->nValImp
                        aTotIvm[ 1, 1 ]      += nTotNFacRec ( cFacRecL ) * if( ( cFacRecL )->lVolImp, NotCero( ( cFacRecL )->nVolumen ), 1 )
                        aTotIvm[ 1, 2 ]      := ( cFacRecL )->nValImp
                        aTotIvm[ 1, 3 ]      := aTotIvm[ 1, 1 ] * aTotIvm[ 1, 2 ]

                     case aTotIvm[ 2, 2 ] == 0 .OR. aTotIvm[ 2, 2 ] == ( cFacRecL )->nValImp
                        aTotIvm[ 2, 1 ]      += nTotNFacRec( cFacRecL ) * if( ( cFacRecL )->lVolImp, NotCero( ( cFacRecL )->nVolumen ), 1 )
                        aTotIvm[ 2, 2 ]      := ( cFacRecL )->nValImp
                        aTotIvm[ 2, 3 ]      := aTotIvm[ 2, 1 ] * aTotIvm[ 2, 2 ]

                     case aTotIvm[ 3, 2 ] == 0 .OR. aTotIvm[ 3, 2 ] == ( cFacRecL )->nValImp
                        aTotIvm[ 3, 1 ]      += nTotNFacRec( cFacRecL ) * if( ( cFacRecL )->lVolImp, NotCero( ( cFacRecL )->nVolumen ), 1 )
                        aTotIvm[ 3, 2 ]      := ( cFacRecL )->nValImp
                        aTotIvm[ 3, 3 ]      := aTotIvm[ 3, 1 ] * aTotIvm[ 3, 2 ]

                  end

                end

            end

         else





            nTotLin  := 0
            nTotUnd  := 0

         end

      end

      ( cFacRecL )->( dbSkip() )

   end

   ( cFacRecL )->( dbGoTo( nRec ) )





    aTotIva          := oTotalDoc:getArrayImpuesto()
    aTotIva          := aSort( aTotIva,,, {|x,y| hGet( x, "porcentajeiva" ) > hGet( y, "porcentajeiva" ) } )

    nTotBrt            := oTotalDoc:getTotalBruto()

    if nDtoEsp <> 0
           nTotDto := oTotalDoc:setDescuentoEspecial( nDtoEsp )
       end
       if nDtoPP <> 0
           nTotDPP := oTotalDoc:setDescuentoProntoPago( nDtoPP )
       end
       if nDtoUno <> 0
           nTotUno := oTotalDoc:setDescuentoUno( nDtoUno )
       end
       if nDtoDos <> 0
           nTotDos := oTotalDoc:setDescuentoDos( nDtoDos )
       end





       oTotalDoc:setImportesImpuesto( lIvaInc, nRegIva, nRouDiv )

       if lRecargo .AND. lIvaInc
        nTotBrt            := oTotalDoc:getTotalBruto()
    end



   if nManObr <> 0

      if lIvaInc
         nIvaGasto   := Round( nManObr / ( 100 / nIvaMan + 1 ), nRouDiv )
         nBaseGasto  := nManObr - nIvaGasto
      else
         nBaseGasto  := nManObr
         nIvaGasto   := Round( nManObr * nIvaMan / 100, nRouDiv )
      end

      oTotalDoc:setGastos( nIvaMan, nBaseGasto, nIvaGasto )

   end





   nTotNet           := oTotalDoc:getTotalNeto()





   nTotNet           += oTotalDoc:getTotalTrn()





   nTotPnt           := oTotalDoc:getTotalPntVer()



   nTotIvm           := oTotalDoc:getTotalIvmh()




   nTotTrn           := oTotalDoc:getTotalTrn()





   nTotIva           := oTotalDoc:getTotalIva()





   nTotReq           := oTotalDoc:getTotalRE()





   nTotImp           := Round( nTotIva + nTotReq + nTotIvm , nRouDiv )





   nTotRet           := Round( nTotNet * nPctRet / 100, nRouDiv )





   nTotRnt           := Round(         nTotNet - nManObr - nTotAge - nTotPnt - nTotCos, nRouDiv )

   nPctRnt           := nRentabilidad( nTotNet - nManObr - nTotAge - nTotPnt, 0, nTotCos )





   nTotFac           := Round( nTotNet + nTotImp - nTotRet, nRouDiv )





   nTotAge           := Round( nTotAge, nRouDiv )





   if nKgsTrn <> 0
      nTotDif        := nKgsTrn - nTotPes
   else
      nTotDif        := 0
   end





   nTotalDto         := nDescuentosLineas + nTotDto + nTotDpp + nTotUno + nTotDos





   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet         := nCnv2Div( nTotNet, cCodDiv, cDivRet )
      nTotIva         := nCnv2Div( nTotIva, cCodDiv, cDivRet )
      nTotReq         := nCnv2Div( nTotReq, cCodDiv, cDivRet )
      nTotFac         := nCnv2Div( nTotFac, cCodDiv, cDivRet )
      nTotRet         := nCnv2Div( nTotRet, cCodDiv, cDivRet )
      nTotPnt         := nCnv2Div( nTotPnt, cCodDiv, cDivRet )
      nTotTrn         := nCnv2Div( nTotTrn, cCodDiv, cDivRet )
      nTotAnt         := nCnv2Div( nTotAnt, cCodDiv, cDivRet )
      cPorDiv         := cPorDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( nTotFac, cPorDiv ), nTotFac ) )



STATIC FUNCTION RecalculaTotal( aTmp )

   local nPagFacCli     := nPagFacRec( nil, D():FacturasRectificativas( nView ), dbfTmpPgo, dbfIva, dbfDiv, nil, .T. )
   local nTotFacCli     := nTotFacRec( nil, D():FacturasRectificativas( nView ), dbfTmpLin, dbfIva, dbfDiv, aTmp, nil, .F. )





   if oBrwIva <> nil
         oBrwIva:SetArray( aTotIva, , , .F. )
      oBrwIva:Refresh()
   end

   if oGetAge <> nil
      oGetAge:SetText( Trans( nTotAge, cPorDiv ) )
   end

   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPorDiv ) )
   end


   IF oGetIva <> nil
      oGetIva:SetText( Trans( nTotIva, cPorDiv ) )
   end

   IF oGetReq <> nil
      oGetReq:SetText( Trans( nTotReq, cPorDiv ) )
   end

   IF oGetTotal <> nil
      oGetTotal:SetText( Trans( nTotFac, cPorDiv ) )
   end

   IF oGetTotPg <> nil
      oGetTotPg:SetText( Trans( nTotFac, cPorDiv ) )
   end

   IF oGetTotIvm <> nil
      oGetTotIvm:SetText( Trans( nTotIvm, cPorDiv ) )
   end

   IF oGetTotPnt <> nil
      oGetTotPnt:SetText( Trans( nTotPnt, cPorDiv ) )
   end

   IF oGetTrn <> nil
      oGetTrn:SetText( Trans( nTotTrn, cPorDiv ) )
   end





   if oGetPag <> nil
      oGetPag:SetText( Trans( nPagFacCli, cPorDiv ) )
   end

   if oGetPdt <> nil
      oGetPdt:SetText( Trans( nTotFacCli - nPagFacCli, cPorDiv ) )
   end

   if oGetPes <> nil
      oGetPes:cText( nTotPes )
   end

   if oGetPes <> nil
      oGetPes:cText( nTotPes )
   end

   if oGetDif <> nil
      oGetDif:cText( nTotDif )
   end

Return .T.







FUNCTION mkFacRec( cPath, oMeter, nLenCodCli )

   if oMeter <> nil
        oMeter:cText    := "Generando Bases"
        sysrefresh()
    end

   CreateFiles( cPath, .T. )

RETURN NIL






FUNCTION rxFacRec( cPath, oMeter, cDriver )

   local cFacRecT
   local dbfFacRecL
   local dbfFacRecI
   local dbfFacRecD
   local dbfFacRecS
   local dbfFacRecE

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;










   if !lExistTable( cPath + "FacRecT.Dbf" )   .OR. !lExistTable( cPath + "FacRecL.Dbf" )   .OR. !lExistTable( cPath + "FacRecI.Dbf" )   .OR. !lExistTable( cPath + "FacRecD.Dbf" )   .OR. !lExistTable( cPath + "FacRecS.Dbf" )   .OR. !lExistTable( cPath + "FacRecE.Dbf" )
      mkfacrec( cPath, nil, .F. )
   end

   fEraseIndex( cPath + "FacRecT.Cdx" )
   fEraseIndex( cPath + "FacRecL.Cdx" )
   fEraseIndex( cPath + "FacRecI.Cdx" )
   fEraseIndex( cPath + "FacRecD.Cdx" )
   fEraseIndex( cPath + "FacRecS.Cdx" )
   fEraseIndex( cPath + "FacRecE.Cdx" )

   dbUseArea( .T., cDriver, cPath + "FacRecL.DBF", cCheckArea( "FacRecL", @dbfFacRecL ), .F. )
   if !( dbfFacRecL )->( neterr() )
      ( dbfFacRecL )->( __dbPack() )

      ( dbfFacRecL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacRecL )->( ordCreate( cPath + "FacRecL.CDX", "NNUMFAC", "CSERIE + Str(NNUMFAC) + CSUFFAC", {|| Field->CSERIE + Str( Field->NNUMFAC ) + Field->CSUFFAC }, ) )

      ( dbfFacRecL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacRecL )->( ordCreate( cPath + "FacRecL.CDX", "CFACREF", "CSERIE + Str(NNUMFAC) + CSUFFAC + CREF", {|| Field->CSERIE + Str( Field->NNUMFAC ) + Field->CSUFFAC + Field->CREF }, ) )

      ( dbfFacRecL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacRecL )->( ordCreate( cPath + "FacRecL.CDX", "CREF", "CREF", {|| Field->CREF }, ) )

      ( dbfFacRecL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacRecL )->( ordCreate( cPath + "FacRecL.CDX", "Lote", "cLote", {|| Field->cLote }, ) )

      ( dbfFacRecL )->( ordCondSet( "!lValidado .and. !lControl .and. nCtlStk < 2 .and. !Deleted()", {|| !Field->lValidado .AND. !Field->lControl .AND. Field->nCtlStk < 2 .AND. !Deleted() }, , , , , , , , , .T. ) )
      ( dbfFacRecL )->( ordCreate( cPath + "FacRecL.Cdx", "cStkFast", "cRef + cAlmLin + dtos( dFecFac ) + tFecFac", {|| Field->cRef + Field->cAlmLin + dtos( Field->dFecFac ) + Field->tFecFac } ) )

      ( dbfFacRecL)->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfFacRecL )->( ordCreate( cPath + "FacRecL.Cdx", "iNumFac", "'14' + cSerie + Str( nNumFac ) + Space( 1 ) + cSufFac + Str( nNumLin )", {|| "14" + Field->cSerie + Str( Field->nNumFac ) + Space( 1 ) + Field->cSufFac + Str( Field->nNumLin ) } ) )

      ( dbfFacRecL )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( dbfFacRecL )->( ordCreate( cPath + "FacRecL.CDX", "nPosPrint", "cSerie + Str(nNumFac) + cSufFac + str( nPosPrint )", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nPosPrint ) }, ) )

      ( dbfFacRecL )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas rectificativas de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "FacRecI.DBF", cCheckArea( "FacRecI", @dbfFacRecI ), .F. )
   if !( dbfFacRecI )->( neterr() )
      ( dbfFacRecI )->( __dbPack() )

      ( dbfFacRecI )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacRecI )->( ordCreate( cPath + "FacRecI.Cdx", "nNumFac", "cSerie + STR( nNumFac ) + cSufFac", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacRecI )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfFacRecI )->( ordCreate( cPath + "FacRecI.Cdx", "iNumFac", "'14' + cSerie + Str( nNumFac ) + Space( 1 ) + cSufFac", {|| "14" + Field->cSerie + Str( Field->nNumFac ) + Space( 1 ) + Field->cSufFac } ) )

      ( dbfFacRecI )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas rectificativas de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "FacRecD.DBF", cCheckArea( "FacRecD", @dbfFacRecD ), .F. )
   if !( dbfFacRecD )->( neterr() )
      ( dbfFacRecD )->( __dbPack() )

      ( dbfFacRecD )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfFacRecD )->( ordCreate( cPath + "FacRecD.Cdx", "nNumFac", "cSerFac + STR( nNumFac ) + cSufFac", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacRecD )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfFacRecD )->( ordCreate( cPath + "FacRecD.Cdx", "iNumFac", "'14' + cSerFac + Str( nNumFac ) + Space( 1 ) + cSufFac", {|| "14" + Field->cSerFac + Str( Field->nNumFac ) + Space( 1 ) + Field->cSufFac } ) )

      ( dbfFacRecD )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas rectificativas de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "FacRecT.DBF", cCheckArea( "FacRecT", @cFacRecT ), .F. )
   if !( cFacRecT )->( neterr() )
      ( cFacRecT )->( __dbPack() )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "NNUMFAC", "CSERIE + Str( NNUMFAC ) + CSUFFAC", {|| Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac }, ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "dFecFac", "dFecFac", {|| Field->dFecFac } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CCODCLI", "CCODCLI", {|| Field->CCODCLI } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CNOMCLI", "Upper( CNOMCLI )", {|| Upper( Field->CNOMCLI ) } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CCODOBR", "CCODOBR", {|| Field->CCODOBR } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CTURFAC", "CTURFAC + CSUFFAC + CCODCAJ", {|| Field->CTURFAC + Field->CSUFFAC + Field->CCODCAJ } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "cCodAge", "cCodAge", {|| Field->cCodAge } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CCODRUT", "CCODRUT", {|| Field->CCODRUT } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "cCodPago", "cCodPago", {|| Field->cCodPago } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CPOBCLI", "CPOBCLI + CNOMCLI", {|| Field->CPOBCLI + Field->CNOMCLI } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CDOCORG", "CDOCORG", {|| Field->CDOCORG } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CAGEFEC", "CCODAGE + DtoS( DFECFAC )", {|| Field->CCODAGE + DtoS( Field->DFECFAC ) } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "NNUMLIQ", "Str( NNUMLIQ ) + CSUFLIQ", {|| Str( Field->NNUMLIQ ) + Field->CSUFLIQ } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CABNFAC", "CABNFAC", {|| Field->CABNFAC } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "lSndDoc", "lSndDoc", {|| Field->lSndDoc } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() } ))
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "cNumDoc", "cNumDoc", {|| Field->cNumDoc } ) )

      ( cFacRecT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.Cdx", "cCodUsr", "Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre", {|| Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre } ) )

      ( cFacRecT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.Cdx", "cNumFac", "Field->cNumFac", {|| Field->cNumFac } ) )

      ( cFacRecT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.Cdx", "iNumFac", "'14' + cSerie + Str( nNumFac ) + Space( 1 ) + cSufFac", {|| "14" + Field->cSerie + Str( Field->nNumFac ) + Space( 1 ) + Field->cSufFac } ) )

      ( cFacRecT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.Cdx", "cCtrCoste", "cCtrCoste", {|| Field->cCtrCoste } ) )

      ( cFacRecT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.Cdx", "nTotFac", "nTotFac", {|| Field->nTotFac } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "Poblacion", "UPPER( Field->cPobCli )", {|| UPPER( Field->cPobCli ) } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "Provincia", "UPPER( Field->cPrvCli )", {|| UPPER( Field->cPrvCli ) } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "CodPostal", "Field->cPosCli", {|| Field->cPosCli } ) )

      ( cFacRecT )->( ordCondSet("!Deleted()", {|| !Deleted() }, , , , , , , , , .T. ) )
      ( cFacRecT )->( ordCreate( cPath + "FacRecT.CDX", "dDesFec", "dFecFac", {|| Field->dFecFac } ) )

      ( cFacRecT )->( dbCloseArea() )

   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas rectificativas de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "FacRecS.Dbf", cCheckArea( "FacRecS", @dbfFacRecS ), .F. )

   if !( dbfFacRecS )->( neterr() )
      ( dbfFacRecS )->( __dbPack() )

      ( dbfFacRecS )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfFacRecS )->( ordCreate( cPath + "FacRecS.Cdx", "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumLin )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumLin ) } ) )

      ( dbfFacRecS )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacRecS )->( ordCreate( cPath + "FacRecS.Cdx", "cRefSer", "cRef + cAlmLin + cNumSer", {|| Field->cRef + Field->cAlmLin + Field->cNumSer } ) )

      ( dbfFacRecS )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacRecS )->( ordCreate( cPath + "FacRecS.CDX", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( dbfFacRecS )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacRecS )->( ordCreate( cPath + "FacRecS.Cdx", "iNumFac", "'14' + cSerFac + Str( nNumFac ) + Space( 1 ) + cSufFac", {|| "14" + Field->cSerFac + Str( Field->nNumFac ) + Space( 1 ) + Field->cSufFac } ) )

      ( dbfFacRecS )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de números de series de facturas rectificativas de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "FacRecE.Dbf", cCheckArea( "FacRecE", @dbfFacrecE ), .F. )

   if !( dbfFacrecE )->( neterr() )
      ( dbfFacrecE )->( __dbPack() )

      ( dbfFacrecE )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfFacrecE )->( ordCreate( cPath + "FacRecE.Cdx", "nNumFac", "cSerFac + str( nNumFac ) + cSufFac", {|| Field->cSerFac + str( Field->nNumFac ) + Field->cSufFac } ) )

      ( dbfFacrecE )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacrecE )->( ordCreate( cPath + "FacRecE.Cdx", "cSitua", "cSitua", {|| Field->cSitua } ) )

      ( dbfFacrecE )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfFacrecE )->( ordCreate( cPath + "FacRecE.Cdx", "idPs", "str( idPs )", {|| str( Field->idPs ) } ) )

      ( dbfFacrecE )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de entidades de facturas de clientes" )
   end

Return nil







FUNCTION dFecFacRec( cFacRec, cFacRecT )

   local aStatus
    local dFecFac    := CtoD("")

   if IsObject( cFacRecT )

      cFacRecT:GetStatus( .T. )

      if cFacRecT:Seek( cFacRec )
         dFecFac  := cFacRecT:dFecFac
      end

      cFacRecT:SetStatus()

   else

      aStatus     := aGetStatus( cFacRecT, .T. )

      if ( cFacRecT )->( dbSeek( cFacRec ) )
         dFecFac  := ( cFacRecT )->dFecFac
      end

      SetStatus( cFacRecT, aStatus )

   end

RETURN ( dFecFac )







FUNCTION tFecFacRec( cFacRec, cFacRecT )

   local aStatus
   local tFecFac    := Replicate( "0", 6 )

   if IsObject( cFacRecT )
      cFacRecT:GetStatus( .T. )
      if cFacRecT:Seek( cFacRec )
         tFecFac  := cFacRecT:tFecFac
      end
      cFacRecT:SetStatus()
   else
      aStatus     := aGetStatus( cFacRecT, .T. )
      if ( cFacRecT )->( dbSeek( cFacRec ) )
         tFecFac  := ( cFacRecT )->tFecFac
      end
      SetStatus( cFacRecT, aStatus )
   end

RETURN ( tFecFac )






FUNCTION cCliFacRec( cFacRecT, uFacRecT )

   local cCodCli  := ""

   do case
      case ValType( uFacRecT ) == "C"
         if (uFacRecT)->( dbSeek( cFacRecT ) )
            cCodCli     := (uFacRecT)->CCODCLI
         end
      case ValType( uFacRecT ) == "O"
         if uFacRecT:Seek( cFacRecT )
            cCodCli     := uFacRecT:cCodCli
         end
   end

RETURN ( cCodCli )







FUNCTION cNbrFacRec( cFacRec, cFacRecT )

   local cNomCli  := ""

   if ( cFacRecT )->( dbSeek( cFacRecT ) )
      cNomCli     := ( cFacRecT )->CNOMCLI
    end

RETURN ( cNomCli )







FUNCTION cPgoFacRec( cFacRec, cFacRecT )

   local cCodPgo  := ""

   if ValType( cFacRecT ) == "O"
      if cFacRecT:Seek( cFacRecT )
         cCodPgo  := cFacRecT:cCodPago
      end
   else
      if ( cFacRecT )->( dbSeek( cFacRecT ) )
         cCodPgo  := ( cFacRecT )->cCodPago
      end
   end

RETURN ( cCodPgo )



FUNCTION cProFacRec( cFacRec, cFacRecT )

   local cCodPro  := ""

   if ( cFacRecT )->( dbSeek( cFacRecT ) )
      cCodPro     := ( cFacRecT )->CCODPRO
    end

RETURN ( cCodPro )






FUNCTION lConFacRec( cFacRec, cFacRecT )

   local lConFac  := .F.

   if ( cFacRecT )->( dbSeek( cFacRecT ) )
      lConFac     := ( cFacRecT )->lContab
    end

RETURN ( lConFac )






FUNCTION cAgeFacRec( cFacRec, cFacRecT )

   local cCliFac  := ""

   if ValType( cFacRecT ) == "O"
      if cFacRecT:Seek( cFacRecT )
         cCliFac  := cFacRecT:cCodAge
      end
   else
      if ( cFacRecT )->( dbSeek( cFacRecT ) )
         cCliFac  := ( cFacRecT )->cCodAge
      end
   end

RETURN ( cCliFac )







function nTotDFacRec( cCodArt, dbfFacRecL, cCodAlm )

   local nOrd     := ( dbfFacRecL )->( OrdSetFocus( "cRef" ) )
   local nRec     := ( dbfFacRecL )->( Recno() )
   local nTotVta  := 0

   if ( dbfFacRecL )->( dbSeek( cCodArt ) )

      while ( dbfFacRecL )->CREF == cCodArt .AND. !( dbfFacRecL )->( eof() )

         if !( dbfFacRecL )->LTOTLIN
            if cCodAlm <> nil
               if cCodAlm == ( dbfFacRecL )->cAlmLin
                  nTotVta  += nTotNFacRec( dbfFacRecL ) * NotCero( ( dbfFacRecL )->nFacCnv )
               end
            else
               nTotVta     += nTotNFacRec( dbfFacRecL ) * NotCero( ( dbfFacRecL )->nFacCnv )
            end
         end

         ( dbfFacRecL )->( dbSkip() )

      end

   end

   ( dbfFacRecL )->( OrdSetFocus( nOrd  ) )
   ( dbfFacRecL )->( dbGoTo( nRec ) )

return ( nTotVta )



FUNCTION nVolLFacRec( dbfLin )

   local nCalculo    := 0

   if !( dbfLin )->lTotLin
      nCalculo       := nTotNFacRec( dbfLin ) * ( dbfLin )->nVolumen
   end

RETURN ( nCalculo )






FUNCTION nTotFFacRec( cFacRecL, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo := 0

   nCalculo       += nTotLFacRec( cFacRecL, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn )
   nCalculo       += nIvaLFacRec( cFacRecL, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn )

return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nTotPFacRec( cFacRecL, nDec, nVdv, cPorDiv )

   local nCalculo

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cFacRecL )->lTotLin

      nCalculo       := nTotUFacRec( cFacRecL, nDec )

   else





      nCalculo       := nTotUFacRec( cFacRecL, nDec )
      nCalculo       -= Round( ( cFacRecL )->nDtoDiv , nDec )

      if ( cFacRecL )->nDto <> 0
         nCalculo    -= nCalculo * ( cFacRecL )->nDto / 100
      end

      if ( cFacRecL )->nDtoPrm <> 0
         nCalculo    -= nCalculo * ( cFacRecL )->nDtoPrm / 100
      end

   end

   nCalculo          := Round( nCalculo / nVdv, nDec )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )







FUNCTION nDtoLFacRec( cFacRecL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cFacRecL )->nDto <> 0 .AND. !( cFacRecL )->lTotLin

      nCalculo          := nTotUFacRec( cFacRecL, nDec ) * nTotNFacRec( cFacRecL )





      nCalculo          -= Round( ( cFacRecL )->nDtoDiv / nVdv , nDec )

      nCalculo          := nCalculo * ( cFacRecL )->nDto / 100


      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )






FUNCTION nPrmLFacRec( cFacRecL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cFacRecL )->nDtoPrm <> 0 .AND. !( cFacRecL )->lTotLin

      nCalculo          := nTotUFacRec( cFacRecL, nDec ) * nTotNFacRec( cFacRecL )





      nCalculo          -= Round( ( cFacRecL )->nDtoDiv / nVdv , nDec )

      if ( cFacRecL )->nDto <> 0
         nCalculo       -= nCalculo * ( cFacRecL )->nDto / 100
      end

      nCalculo          := nCalculo * ( cFacRecL )->nDtoPrm / 100

      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )




Function nTotDtoLFacRec( cFacRecL, nDec, nVdv, cPorDiv )

   local nCalculo

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nDtoLFacRec( cFacRecL, nDec, nVdv ) * nTotNFacRec( cFacRecL )

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

   nCalculo          := Round( nCalculo, nDec )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION sTotLFacRec( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local uTotLFacRec
   local nTotLFacRec := nTotLFacRec( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )

   if nTotLFacRec == 0 .AND. !( dbfLin )->lControl
      uTotLFacRec    := "S/C"
   else
      uTotLFacRec    := if( cPorDiv <> NIL, Trans( nTotLFacRec, cPorDiv ), nTotLFacRec )
   end

RETURN ( uTotLFacRec )



FUNCTION nTotIFacRec( dbfLin, nDec, nRouDec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( dbfLin == nil, dbfLin := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := 0, ) ;
   If( nRouDec == nil, nRouDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLin )->lTotLin





      nCalculo       := Round( ( dbfLin )->nValImp, nDec )





      nCalculo       *= nTotNFacRec( dbfLin )

      if ( dbfLin )->lVolImp
         nCalculo    *= NotCero( ( dbfLin )->nVolumen )
      end

      nCalculo       := Round( nCalculo / nVdv, nRouDec )

   end

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nImpUFacRec( uFacRecT, uFacRecL, nDec, nVdv, lIva )

   local lIvaInc
   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lIva == nil, lIva := .F., ) ;

   nCalculo       := nTotUFacRec( uFacRecL, nDec, nVdv )

   if IsArray( uFacRecT )

      nCalculo    -= Round( nCalculo * uFacRecT[ 42 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacRecT[ 44    ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacRecT[ 46 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacRecT[ 48 ]  / 100, nDec )
      lIvaInc     := uFacRecT[ 58 ]

   else

      nCalculo    -= Round( nCalculo * ( uFacRecT )->nDtoEsp / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacRecT )->nDpp    / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacRecT )->nDtoUno / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacRecT )->nDtoDos / 100, nDec )
      lIvaInc     := ( uFacRecT )->lIvaInc

   end

   if IsArray( uFacRecL )

      if lIva .AND. uFacRecL[ 11 ] <> 0
         if !lIvaInc
            nCalculo    += nCalculo * uFacRecL[ 11 ] / 100
         end
      else
         if lIvaInc .AND. uFacRecL[ 11 ] <> 0
            nCalculo    -= Round( nCalculo / ( 100 / uFacRecL[ 11 ] + 1 ), nDec )
         end
      end

   else

      if lIva .AND. ( uFacRecL )->nIva <> 0
         if !lIvaInc
            nCalculo    += nCalculo * ( uFacRecL )->nIva / 100
         end
      else
         if lIvaInc .AND. ( uFacRecL )->nIva <> 0
            nCalculo    -= Round( nCalculo / ( 100 / ( uFacRecL )->nIva + 1 ), nDec )
         end
      end

   end

RETURN ( Round( nCalculo, nDec ) )







FUNCTION nImpLFacRec( uFacRecT, dbfFacRecL, nDec, nRou, nVdv, lIva, lDto, lPntVer, lImpTrn, cPouDiv )

   local lIvaInc
   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nRou == nil, nRou := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lIva == nil, lIva := .F., ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .F., ) ;
   If( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo       := nTotLFacRec( dbfFacRecL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if ValType( uFacRecT ) == "A"
      nCalculo    -= Round( nCalculo * uFacRecT[ 42 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacRecT[ 44    ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacRecT[ 46 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacRecT[ 48 ]  / 100, nRou )
      lIvaInc     := uFacRecT[ 58 ]
   else
      nCalculo    -= Round( nCalculo * ( uFacRecT )->nDtoEsp / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacRecT )->nDpp    / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacRecT )->nDtoUno / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacRecT )->nDtoDos / 100, nRou )
      lIvaInc     := ( uFacRecT )->lIvaInc
   end

   if lIva .AND. ( dbfFacRecL )->nIva <> 0
      if !lIvaInc
         nCalculo += nCalculo * ( dbfFacRecL )->nIva / 100
      end
   else
      if lIvaInc .AND. ( dbfFacRecL )->nIva <> 0
         nCalculo -= Round( nCalculo / ( 100 / ( dbfFacRecL )->nIva + 1 ), nRou )
      end
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )






FUNCTION nNetLFacRec( dbfFacRecL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo

   If( nDec == nil, nDec := 2, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .T., ) ;

   nCalculo       := nTotLFacRec( dbfFacRecL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )

   if ( dbfFacRecL )->nIva <> 0 .AND. ( dbfFacRecL )->lIvaLin
      if nRou <> nil
         nCalculo -= Round( nCalculo / ( 100 / ( dbfFacRecL )->nIva + 1 ), nRou )
      else
         nCalculo -= ( nCalculo / ( 100 / ( dbfFacRecL )->nIva + 1 ) )
      end
   end

RETURN ( if( cPouDiv <> NIL, Trans( nCalculo, cPouDiv ), nCalculo ) )



function nVtaFacRec( cCodCli, dDesde, dHasta, cFacRecT, dbfFacRecL, dbfIva, dbfDiv, nYear )

   local nCon     := 0
   local nOrd     := ( cFacRecT )->( OrdSetFocus( "CCODCLI" ) )
   local nRec     := ( cFacRecT )->( Recno() )





   if ( cFacRecT )->( dbSeek( cCodCli ) )

      while ( cFacRecT )->cCodCli = cCodCli .AND. !( cFacRecT )->( Eof() )



         if ( dDesde == nil .OR. ( cFacRecT )->DFECFAC >= dDesde ) .AND. ( dHasta == nil .OR. ( cFacRecT )->DFECFAC <= dHasta ) .AND. ( nYear == nil .OR. Year( ( cFacRecT )->dFecFac ) == nYear )

            nCon  += nTotFacRec( ( cFacRecT )->cSerie + Str( ( cFacRecT )->nNumFac ) + ( cFacRecT )->cSufFac, cFacRecT, dbfFacRecL, dbfIva, dbfDiv, nil, cDivEmp(), .F. )

         end

         ( cFacRecT )->( dbSkip() )

         SysRefresh()

      end

   end

   ( cFacRecT )->( OrdSetFocus( nOrd ) )
   ( cFacRecT )->( dbGoTo( nRec ) )

return nCon







FUNCTION nTotNFacRec( uDbf )

   local nTotUnd

   If( uDbf == nil, uDbf := D():FacturasRectificativasLineas( nView ), ) ;

   do case
   case ValType( uDbf ) == "C"
      nTotUnd        := NotBulto( ( uDbf )->nBultos )
      nTotUnd     *= NotCaja( ( uDbf )->nCanEnt )
      nTotUnd     *= ( uDbf )->nUniCaja
      nTotUnd     *= NotCero( ( uDbf )->nUndKit )
      nTotUnd     *= NotCero( ( uDbf )->nMedUno )
      nTotUnd     *= NotCero( ( uDbf )->nMedDos )
      nTotUnd     *= NotCero( ( uDbf )->nMedTre )

   case ValType( uDbf ) == "A"
      nTotUnd     := NotBulto( uDbf[ 76 ] )
      nTotUnd     *= NotCaja( uDbf[ 12 ] )
      nTotUnd     *= uDbf[ 18 ]
      nTotUnd     *= NotCero( uDbf[ 19 ] )
      nTotUnd     *= NotCero( uDbf[ 68 ] )
      nTotUnd     *= NotCero( uDbf[ 69 ] )
      nTotUnd     *= NotCero( uDbf[ 70 ] )

   otherwise
      nTotUnd     := NotBulto( uDbf:nBultos )
      nTotUnd     *= NotCaja( uDbf:nCanEnt )
      nTotUnd     *= uDbf:nUniCaja
      nTotUnd     *= NotCero( uDbf:nUndKit )
      nTotUnd     *= NotCero( uDbf:nMedUno )
      nTotUnd     *= NotCero( uDbf:nMedDos )
      nTotUnd     *= NotCero( uDbf:nMedTre )

   end

RETURN ( nTotUnd )



Function nTotVFacRec( uDbf )

   local nTotUnd

   If( uDbf == nil, uDbf := D():FacturasRectificativasLineas( nView ), ) ;

   do case
      case ValType( uDbf ) == "A"

         nTotUnd  := nTotNFacRec( uDbf ) * NotCero( uDbf[ 31 ] )

      case ValType( uDbf ) == "C"

         nTotUnd  := nTotNFacRec( uDbf ) * NotCero( ( uDbf )->nFacCnv )

      otherwise

         nTotUnd  := nTotNFacRec( uDbf ) * NotCero( uDbf:nFacCnv )

   end

Return ( nTotUnd )



Static function lImpLin( dbfTmpLin, oBrwDet )

   ( dbfTmpLin )->lImpLin  := !( dbfTmpLin )->lImpLin

   oBrwDet:Refresh()

Return nil



function aItmFacRec()

   local aItmFacRec  := {}

   aAdd( aItmFacRec, { "cSerie"      ,"C",  1, 0, "Serie de la factura " ,                                   "Serie",                   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nNumFac"     ,"N",  9, 0, "Número de la factura" ,                                   "Numero",                  "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cSufFac"     ,"C",  2, 0, "Sufijo de la factura" ,                                   "Sufijo",                  "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cGuid"       ,"C", 40, 0, "Guid de la factura" ,                                     "GUID",                        "", "( cDbf )", {|| win_uuidcreatestring() } } )
   aAdd( aItmFacRec, { "cTurFac"     ,"C",  6, 0, "Sesión de la factura" ,                                   "Turno",                   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "dFecFac"     ,"D",  8, 0, "Fecha de la factura" ,                                    "Fecha",                   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodCli"     ,"C", 12, 0, "Código del cliente" ,                                     "Cliente",                 "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodAlm"     ,"C", 16, 0, "Código de almacén" ,                                      "Almacen",                 "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodCaj"     ,"C",  3, 0, "Código de caja" ,                                         "Caja",                    "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cNomCli"     ,"C", 80, 0, "Nombre del cliente" ,                                     "NombreCliente",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDirCli"     ,"C",100, 0, "Domicilio del cliente" ,                                  "DomicilioCliente",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cPobCli"     ,"C", 25, 0, "Población del cliente" ,                                  "PoblacionCliente",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cPrvCli"     ,"C", 20, 0, "Provincia del cliente" ,                                  "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nCodProv"    ,"N",  2, 0, "Número de provincia cliente" ,                            "ProvinciaCliente",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cPosCli"     ,"C", 15, 0, "Código postal del cliente" ,                              "CodigoPostalCliente",     "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDniCli"     ,"C", 30, 0, "DNI/Cif del cliente" ,                                    "DniCliente",              "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lModCli"     ,"L",  1, 0, "Lógico de modificar datos del cliente" ,                  "ModificarDatosCliente",   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lMayor"      ,"L",  1, 0, "Lógico de mayorista" ,                                    "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nTarifa"     ,"N",  1, 0, "Tarifa de precio aplicada" ,                              "NumeroTarifa",            "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodAge"     ,"C",  3, 0, "Código del agente" ,                                      "Agente",                  "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodRut"     ,"C",  4, 0, "Código de la ruta" ,                                      "Ruta",                    "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodTar"     ,"C",  5, 0, "Código de la tarifa" ,                                    "Tarifa",                  "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodObr"     ,"C", 10, 0, "Código de la dirección" ,                                 "Direccion",               "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nPctComAge"  ,"N",  6, 2, "Porcentaje de comisión del agente" ,                      "ComisionAgente",          "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lLiquidada"  ,"L",  1, 0, "Lógico de la liquidación" ,                               "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lContab"     ,"L",  1, 0, "Lógico de la contabilización" ,                           "Contabilizada",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cConGuid"    ,"C", 40, 0, "Guid del apunte contable" ,                               "GuidApunteContable",      "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "dFecEnt"     ,"D",  8, 0, "Fecha de entrega" ,                                       "FechaEntrega",            "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cSufac"      ,"C", 10, 0, "Su factura" ,                                             "SuFactura",               "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lImpAlb"     ,"L",  1, 0, "Lógico si la factura se importó de albaranes" ,           "ImportadaAlbaran",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCondEnt"    ,"C",100, 0, "Condición de entrada" ,                                   "CondicionEntrada",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "mComent"     ,"M", 10, 0, "Comentarios" ,                                            "Comentarios",             "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "mObserv"     ,"M", 10, 0, "Observaciones" ,                                          "Observaciones",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodPago"    ,"C",  2, 0, "Código del tipo de pago" ,                                "Pago",                    "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nBultos"     ,"N",  5, 0, "Número de bultos" ,                                       "Bultos",                  "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nPortes"     ,"N",  6, 0, "Valor del porte" ,                                        "Portes",                  "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nIvaMan"     ,"N",  6, 2, "Porcentaje de " + cImp() + " del gasto" ,                 "ImpuestoGastos",          "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nManObr"     ,"N", 16, 6, "Gastos" ,                                                 "Gastos",                  "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cNumFac"     ,"C", 12, 0, "Número de factura" ,                                      "NumeroFactura",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nTipoFac"    ,"N",  1, 0, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDtoEsp"     ,"C", 50, 0, "Descripción de porcentaje de descuento especial" ,        "DescripcionDescuento1",   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoEsp"     ,"N",  6, 2, "Porcentaje de descuento especial" ,                       "PorcentajeDescuento1",    "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDpp"        ,"C", 50, 0, "Descripción de porcentaje de descuento por pronto pago",  "DescripcionDescuento2",   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDpp"        ,"N",  6, 2, "Porcentaje de descuento por pronto pago" ,                "PorcentajeDescuento2",    "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDtoUno"     ,"C", 25, 0, "Descripción de porcentaje de descuento personalizado",    "DescripcionDescuento3",   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoUno"     ,"N",  6, 2, "Porcentaje de descuento por descuento personalizado" ,    "PorcentajeDescuento3",    "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDtoDos"     ,"C", 25, 0, "Descripción de porcentaje de descuento personalizado" ,   "DescripcionDescuento4",   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoDos"     ,"N",  4, 1, "Porcentaje de descuento por descuento personalizado" ,    "PorcentajeDescuento4",    "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoCnt"     ,"N",  6, 2, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoRap"     ,"N",  6, 2, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoPub"     ,"N",  6, 2, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoPgo"     ,"N",  6, 2, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoPtf"     ,"N",  7, 2, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nTipoIva"    ,"N",  1, 0, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nPorcIva"    ,"N",  4, 1, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lRecargo"    ,"L",  1, 0, "Lógico para recargo" ,                                    "RecargoEquivalencia",     "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cRemitido"   ,"C", 50, 0, "Campo de remitido" ,                                      "Remitido",                "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lIvaInc"     ,"L",  1, 0, cImp() + " incluido" ,                                     "ImpuestosIncluidos",      "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lSndDoc"     ,"L",  1, 0, "Lógico para documento enviado" ,                          "Envio",                   "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDivFac"     ,"C",  3, 0, "Código de la divisa" ,                                    "Divisa",                  "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nVdvFac"     ,"N", 10, 4, "Cambio de la divisa" ,                                    "ValorDivisa",             "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cRetPor"     ,"C",100, 0, "Retirado por" ,                                           "RetiradoPor",             "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cRetMat"     ,"C", 20, 0, "Matrícula" ,                                              "Matricula",               "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cNumDoc"     ,"C", 13, 0, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nRegIva"     ,"N",  1, 0, "Regimen de " + cImp() ,                                   "TipoImpuesto",            "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodPro"     ,"C",  9, 0, "Código de proyecto en contabilidad" ,                     "ProyectoContable",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDocOrg"     ,"C", 10, 0, "Número del documento origen" ,                            "DocumentoOrigen",         "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nNumLiq"     ,"N",  9, 0, "Número liquidación",                                      "NumeroLiquidacion",       "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cSufLiq"     ,"C",  2, 0, "Sufijo de la liquidación",                                "SufijoLiquidacion",       "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nImpLiq"     ,"N", 16, 6, "Importe liquidación",                                     "ImporteLiquidacion",      "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "dFecLiq"     ,"D",  8, 0, "Fecha liquidación",                                       "FechaLiquidacion",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodTrn"     ,"C",  9, 0, "Código del transportista" ,                               "Transportista",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nKgsTrn"     ,"N", 16, 6, "TARA del transportista" ,                                 "TaraTransportista",       "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lCloFac"     ,"L",  1, 0, "" ,                                                       "DocumentoCerrado",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cAbnFac"     ,"C", 12, 0, "" ,                                                       "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cAntFac"     ,"C", 12, 0, "Factura de anticipo" ,                                    "",                        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nPctRet"     ,"N",  6, 2, "Porcentaje de retención",                                 "PorcentajeRetencion",     "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodUsr"     ,"C",  3, 0, "Código de usuario",                                       "Usuario",                 "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "dFecCre"     ,"D",  8, 0, "Fecha de creación del documento",                         "FechaCreacion",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cTimCre"     ,"C",  5, 0, "Hora de creación del documento",                          "HoraCreacion",            "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodGrp"     ,"C",  4, 0, "Código de grupo de cliente" ,                             "GrupoCliente",            "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lImprimido"  ,"L",  1, 0, "Lógico de imprimido" ,                                    "Imprimido",               "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "dFecImp"     ,"D",  8, 0, "Última fecha de impresión" ,                              "FechaImpresion",          "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cHorImp"     ,"C",  5, 0, "Hora de la última impresión" ,                            "HoraImpresion",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCodDlg"     ,"C",  2, 0, "Código delegación" ,                                      "Delegacion",              "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cManObr"     ,"C",250, 0, "Literal de gastos" ,                                      "LiteralGastos",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cMotRec"     ,"C",250, 0, "Motivo de la factura rectificativa",                      "MotivoRectificativa",     "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCauRec"     ,"C",250, 0, "Causa de la factura rectificativa",                       "CausaRectificativa",      "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cTlfCli"     ,"C", 20, 0, "Teléfono del cliente" ,                                   "TelefonoCliente",         "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nTotNet"     ,"N", 16, 6, "Total neto" ,                                             "TotalNeto",               "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nTotIva"     ,"N", 16, 6, "Total " + cImp() ,                                        "TotalImpuesto",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nTotReq"     ,"N", 16, 6, "Total recargo" ,                                          "TotalRecargo",            "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nTotFac"     ,"N", 16, 6, "Total factura" ,                                          "TotalDocumento",          "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cBanco"      ,"C", 50, 0, "Nombre del banco del cliente" ,                           "NombreBanco",             "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cPaisIBAN"   ,"C",  2, 0, "País IBAN de la cuenta bancaria del cliente",             "CuentaIBAN",                "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCtrlIBAN"   ,"C",  2, 0, "Dígito de control IBAN de la cuenta bancaria del cliente","DigitoControlIBAN",       "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cEntBnc"     ,"C",  4, 0, "Entidad de la cuenta bancaria del cliente" ,              "EntidadCuenta",           "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cSucBnc"     ,"C",  4, 0, "Sucursal de la cuenta bancaria del cliente" ,             "SucursalCuenta",          "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cDigBnc"     ,"C",  2, 0, "Dígito de control de la cuenta bancaria del cliente" ,    "DigitoControlCuenta",     "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCtaBnc"     ,"C", 10, 0, "Cuenta bancaria del cliente" ,                            "CuentaBancaria",          "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "lOperpv"     ,"L",  1, 0, "Lógico para operar con punto verde" ,                     "OperarPuntoVerde",        "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "nDtoTarifa"  ,"N",  6, 2, "Descuento de tarifa de cliente",                          "DescuentoTarifa",         "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "tFecFac"     ,"C",  9, 0, "Hora de la factura rectificativa",                        "HoraFactura",             "", "( cDbf )", nil } )
   aAdd( aItmFacRec, { "cCtrCoste"   ,"C",  9, 0, "Código del centro de coste",                              "CentroCoste",             "", "( cDbf )", nil } )

RETURN ( aItmFacRec )







function aColFacRec()

   local aColFacRec  := {}

   aAdd( aColFacRec, { "cSerie"      ,"C",  1, 0, ""                                      , "Serie",                       "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nNumFac"     ,"N",  9, 0, ""                                      , "Numero",                      "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cSufFac"     ,"C",  2, 0, ""                                      , "Sufijo",                      "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cRef"        ,"C", 18, 0, "Referencia del artículo"               , "Articulo",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cDetalle"    ,"C",250, 0, "Detalle del artículo"                  , "DescripcionArticulo",         "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nPreUnit"    ,"N", 16, 6, ""                                      , "PrecioVenta",                 "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nPntVer"     ,"N", 16, 6, "Importe punto verde"                   , "PuntoVerde",                  "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nImpTrn"     ,"N", 16, 6, "Importe de portes"                     , "Portes",                      "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nDto"        ,"N",  6, 2, "Descuento"                             , "DescuentoPorcentual",         "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nDtoPrm"     ,"N",  6, 2, "Descuento promocional"                 , "DescuentoPromocion",          "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nIva"        ,"N",  6, 2, "Porcentaje de " + cImp()               , "PorcentajeImpuesto",          "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nCanEnt"     ,"N", 16, 6, "Cajas"                                 , "Cajas",                       "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lControl"    ,"L",  1, 0, ""                                      , "LineaControl",                "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nPesoKg"     ,"N", 16, 6, "Peso del producto"                     , "Peso",                        "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cPesoKg"     ,"C",  2, 0, "Unidad de peso del producto"           , "UnidadMedicionPeso",          "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cUnidad"     ,"C",  2, 0, "Unidades de venta"                     , "UnidadMedicion",              "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nComAge"     ,"N",  6, 2, "Comisión del agente"                   , "ComisionAgente",              "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nUniCaja"    ,"N", 16, 6, "Unidades por caja"                     , "Unidades",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nUndKit"     ,"N", 16, 6, "Unidades del producto kit"             , "UnidadesKit",                 "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "dFecha"      ,"D",  8, 0, "Fecha de detalle"                      , "FechaEntrega",                "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cTipMov"     ,"C",  2, 0, "Tipo de movimiento"                    , "Tipo",                        "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "mLngDes"     ,"M", 10, 0, "Descripción de artículo sin codificar" , "DescripcionAmpliada",         "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cCodAlb"     ,"C", 12, 0, "Código del albarán de procedencia"     , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "dFecAlb"     ,"D",  8, 0, "Fecha del albarán de procedencia"      , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lTotLin"     ,"L",  1, 0, "Valor lógico para línea de total"      , "LineaTotal",                  "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lImpLin"     ,"L",  1, 0, "Valor lógico línea no imprimible"      , "LineaNoImprimible",           "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cCodPr1"     ,"C", 20, 0, "Código de primera propiedad"           , "CodigoPropiedad1",            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cCodPr2"     ,"C", 20, 0, "Código de segunda propiedad"           , "CodigoPropiedad2",            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cValPr1"     ,"C", 20, 0, "Valor de primera propiedad"            , "ValorPropiedad1",             "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cValPr2"     ,"C", 20, 0, "Valor de segunda propiedad"            , "ValorPropiedad2",             "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nFacCnv"     ,"N", 16, 6, "Factor de conversión de la compra"     , "FactorConversion",            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nDtoDiv"     ,"N", 16, 6, "Descuento lineal de la compra"         , "DescuentoLineal",             "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lSel"        ,"L",  1, 0, ""                                      , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nNumLin"     ,"N",  4, 0, "Número de la línea"                    , "NumeroLinea",                 "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nCtlStk"     ,"N",  1, 0, "Tipo de stock de la linea"             , "TipoStock",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nCosDiv"     ,"N", 16, 6, "Costo del producto"                    , "PrecioCosto",                 "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nPvpRec"     ,"N", 16, 6, "Precio de venta recomendado"           , "PrecioVentaRecomendado",      "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cAlmLin"     ,"C", 16, 0, "Código de almacén"                     , "Almacen",                     "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lIvaLin"     ,"L",  1, 0, cImp() + " incluido"                    , "LineaImpuestoIncluido",       "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cCodImp"     ,"C",  3, 0, "Código del impuesto especial"          , "ImpuestoEspecial",            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nValImp"     ,"N", 16, 6, "Importe del impuesto especial"         , "ImporteImpuestoEspecial",     "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lLote"       ,"L",  1, 0, ""                                      , "LogicoLote",                  "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nLote"       ,"N",  9, 0, ""                                      , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cLote"       ,"C", 64, 0, "Número de lote"                        , "Lote",                        "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "dFecCad"     ,"D",  8, 0, "Fecha de caducidad"                    , "FechaCaducidad",              "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lKitArt"     ,"L",  1, 0, "Línea con escandallo"                  , "LineaEscandallo",             "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lKitChl"     ,"L",  1, 0, "Línea pertenciente a escandallo"       , "LineaPerteneceEscandallo",    "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lKitPrc"     ,"L",  1, 0, ""                                      , "LineaEscandalloPrecio",       "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nMesGrt"     ,"N",  2, 0, "Meses de garantía"                     , "MesesGarantia",               "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lNotVta"     ,"L",  1, 0, "No permitir venta sin stocks"          , "NoPermitirSinStock",          "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cCodTip"     ,"C",  4, 0, "Código del tipo de artículo"           , "TipoArticulo",                "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "mNumSer"     ,"M", 10, 0, ""                                      , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cCodFam"     ,"C", 16, 0, "Código de familia"                     , "Familia",                     "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cGrpFam"     ,"C",  3, 0, "Código del grupo de familia"           , "GrupoFamilia",                "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nReq"        ,"N", 16, 6, "Recargo de equivalencia"               , "RecargoEquivalencia",         "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "mObsLin"     ,"M", 10, 0, "Observaciones de linea"                , "Observaciones",               "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cCodPrv"     ,"C", 12, 0, "Código del proveedor"                  , "Proveedor",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cNomPrv"     ,"C", 30, 0, "Nombre del proveedor"                  , "NombreProveedor",             "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cImagen"     ,"C",128, 0, "Fichero de imagen"                     , "Imagen",                      "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nPunTos"     ,"N", 15, 6, "Puntos del artículo"                   , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nValPnt"     ,"N", 16, 6, "Valor del punto"                       , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nDtoPnt"     ,"N",  5, 2, "Descuento puntos"                      , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nIncPnt"     ,"N",  5, 2, "Incremento porcentual"                 , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cRefPrv"     ,"C", 18, 0, "Referencia proveedor"                  , "ReferenciaProveedor",         "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nVolumen"    ,"N", 16, 6, "Volumen del producto"                  , "Volumen",                     "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cVolumen"    ,"C",  2, 0, "Unidad del volumen"                    , "UnidadMedicionVolumen",       "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nNumMed"     ,"N",  1, 0, "Número de mediciones"                  , "NumeroMedidiones",            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nMedUno"     ,"N", 16, 6, "Primera unidad de medición"            , "Medicion1",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nMedDos"     ,"N", 16, 6, "Segunda unidad de medición"            , "Medicion2",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nMedTre"     ,"N", 16, 6, "Tercera unidad de medición"            , "Medicion3",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nTarLin"     ,"N",  1, 0, "Tarifa de precio aplicada"             , "NumeroTarifa",                "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "Descrip"     ,"M", 10, 0, "Descripción larga del artículo"        , "DescripcionTecnica",          "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lLinOfe"     ,"L",  1, 0, "Linea con oferta"                      , "LineaOferta",                 "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lVolImp"     ,"L",  1, 0, "Aplicar volumen impuestos especiales " , "VolumenImpuestosEspeciales",  "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "dFecFac"     ,"D",  8, 0, "Fecha de la factura rectificativa"     , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nBultos"       ,"N", 16, 6, "Numero de bultos en líneas"              , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cFormato"      ,"C",100, 0, "Formato de venta"                             , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "tFecfac"      ,"C",  6, 0, "Hora de la factura rectificativa"      , "HoraFactura",                 "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cCtrCoste"      ,"C",  9, 0, "Código del centro de coste"            , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lLabel"      ,"L",  1, 0, "Lógico para marca de etiqueta"         , "LogicoEtiqueta",              "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nLabel"      ,"N",  6, 0, "Unidades de etiquetas a imprimir"      , "NumeroEtiqueta",              "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cObrLin"     ,"C", 10, 0, "Dirección de la linea"                 , "Direccion",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cRefAux"     ,"C", 18, 0, "Referencia auxiliar"                   , "ReferenciaAuxiliar",          "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cRefAux2"    ,"C", 18, 0, "Segunda referencia auxiliar"           , "ReferenciaAuxiliar2",         "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nPosPrint"   ,"N",  4, 0, "Posición de impresión"                 , "PosicionImpresion",           "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cTipCtr"     ,"C", 20, 0, "Tipo tercero centro de coste"          , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "cTerCtr"     ,"C", 20, 0, "Tercero centro de coste"               , "",                            "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "id_tipo_v"   ,"N", 16, 0, "Identificador tipo de venta"           , "IdentificadorTipoVenta",      "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "nRegIva"     ,"N",  1, 0, "Régimen de " + cImp()                  , "TipoImpuesto",                "", "( cDbfCol )", nil } )
   aAdd( aColFacRec, { "lValidado"   ,"L",  1, 0, "Lógico validado con consolidación"       , "LogicoValidado",              "", "( cDbfCol )", .F. } )

return ( aColFacRec )



function aCocFacRec()

   local aCocFacRec  := {}

   aAdd( aCocFacRec, {"( Descrip( cDbfCol ) )",                                 "C", 50, 0, "Detalle del artículo",              "",            "Descripción", "" } )
   aAdd( aCocFacRec, {"( nTotNFacRec( cDbfCol ) )",                             "N", 16, 6, "Total unidades artículo",           "MasUnd()",    "Unidades",    "" } )
   aAdd( aCocFacRec, {"( nTotUFacRec( cDbfCol, nDouDivFac ) )",                 "N", 16, 6, "Precio unitario del artículo",      "cPouDivFac",  "Precio",      "" } )
   aAdd( aCocFacRec, {"( nTotPFacRec( cDbfCol, nDouDivFac, nVdvDivFac ) )",     "N", 16, 6, "Precio unitario con descuentos",    "cPouDivFac",  "Precio neto", "" } )
   aAdd( aCocFacRec, {"( nPntUFacRec( cDbfCol, nDpvDivFac ) )",                 "N", 16, 6, "Punto verde del artículo",          "cPpvDivFac",  "Punto verde", "" } )
   aAdd( aCocFacRec, {"( nTotLFacRec( cDbfCol, nDouDivFac, nRouDivFac ) )",     "N", 16, 6, "Total línea del factura",           "cPorDivFac",  "Total",       "" } )
   aAdd( aCocFacRec, {"( nTotFFacRec( cDbfCol, nDouDivFac, nRouDivFac ) )",     "N", 16, 6, "Total final línea del factura ",    "cPorDivFac",  "Total neto",  "" } )
   aAdd( aCocFacRec, {"( nDtoLFacRec( cDbfCol, nDouDivFac, nVdvDivFac ) )",     "N", 16, 6, "Importe descuento línea del factura","cPouDivFac", "Dto.",        "" } )
   aAdd( aCocFacRec, {"( nTotDtoLFacRec( cDbfCol, nDouDivFac, nVdvDivFac ) )",  "N", 16, 6, "Total descuento línea del factura ","cPouDivFac",  "Total dto.",  "" } )

return ( aCocFacRec )



function aIncFacRec()

   local aIncFacRec  := {}

   aAdd( aIncFacRec, { "cSerie",  "C",    1,  0, "Serie de factura" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacRec, { "nNumFac", "N",    9,  0, "Número de factura" ,             "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aIncFacRec, { "cSufFac", "C",    2,  0, "Sufijo de factura" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacRec, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacRec, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,        "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacRec, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,  "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacRec, { "lListo",  "L",    1,  0, "Lógico de listo" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacRec, { "lAviso",  "L",    1,  0, "Lógico de Aviso" ,               "",                   "", "( cDbfCol )" } )

return ( aIncFacRec )



function aFacRecDoc()

   local aFacRecDoc  := {}

   aAdd( aFacRecDoc, { "cSerFac", "C",    1,  0, "Serie de factura" ,                "",                   "", "( cDbfCol )" } )
   aAdd( aFacRecDoc, { "nNumFac", "N",    9,  0, "Número de factura" ,               "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aFacRecDoc, { "cSufFac", "C",    2,  0, "Sufijo de factura" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aFacRecDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aFacRecDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aFacRecDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

return ( aFacRecDoc )



function aSerFacRec()

   local aColFacRec  := {}

   aAdd( aColFacRec,  { "cSerFac",     "C",  1,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacRec,  { "nNumFac",     "N",  9,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacRec,  { "cSufFac",     "C",  2,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacRec,  { "dFecFac",     "D",  8,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacRec,  { "nNumLin",     "N",  4,   0, "Número de la línea",               "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColFacRec,  { "cRef",        "C", 18,   0, "Referencia del artículo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColFacRec,  { "cAlmLin",     "C", 16,   0, "Almacen del artículo",             "",                  "", "( cDbfCol )" } )
   aAdd( aColFacRec,  { "lUndNeg",     "L",  1,   0, "Lógico de unidades negativas",     "",                  "", "( cDbfCol )" } )
   aAdd( aColFacRec,  { "cNumSer",     "C", 30,   0, "Número de serie",                  "",                  "", "( cDbfCol )" } )

return ( aColFacRec )



function aFacRecEst()

   local aFacRecEst  := {}

   aAdd( aFacRecEst, { "cSerFac", "C",    1,  0, "Serie de Factura rectificativa" ,               "",         "", "( cDbfCol )" } )
   aAdd( aFacRecEst, { "nNumFac", "N",    9,  0, "Numero de Factura rectificativa" ,   "'999999999'",         "", "( cDbfCol )" } )
   aAdd( aFacRecEst, { "cSufFac", "C",    2,  0, "Sufijo de Factura rectificativa" ,              "",         "", "( cDbfCol )" } )
   aAdd( aFacRecEst, { "cSitua",  "C",  140,  0, "Situación" ,                                     "",         "", "( cDbfCol )" } )
   aAdd( aFacRecEst, { "dFecSit", "D",    8,  0, "Fecha de la situación" ,                        "",         "", "( cDbfCol )" } )
   aAdd( aFacRecEst, { "tFecSit", "C",    6,  0, "Hora de la situación" ,                         "",         "", "( cDbfCol )" } )
   aAdd( aFacRecEst, { "idPs",    "N",   11,  0, "Id prestashop" ,                                "",         "", "( cDbfCol )" } )

return ( aFacRecEst )







function nTotRFacRec( cNumFac, dFecRes, cCodArt, cValPr1, cValPr2, cLote, cFacRecT, dbfFacRecL )

   local nTot        := 0
   local aStaFac     := aGetStatus( cFacRecT, .T. )
   local aStaLin     := aGetStatus( dbfFacRecL, .F. )

   If( cValPr1 == nil, cValPr1 := Space( 40 ), ) ;
   If( cValPr2 == nil, cValPr2 := Space( 40 ), ) ;

   ( dbfFacRecL )->( dbGoTop() )

   if ( dbfFacRecL )->( dbSeek( cNumFac ) )
      while ( dbfFacRecL )->cSerie + str( ( dbfFacRecL )->nNumFac, 9 ) + ( dbfFacRecL )->cSufFac == cNumFac .AND. !( dbfFacRecL )->( eof() )
         if ( dbfFacRecL )->cRef + ( dbfFacRecL )->cValPr1 + ( dbfFacRecL )->cValPr2 == cCodArt + cValPr1 + cValPr2
            if empty( dFecRes ) .OR. dFecRes <= dFecFacRec( ( dbfFacRecL )->cSerFac + Str( ( dbfFacRecL )->nNumFac ) + ( dbfFacRecL )->cSufFac, cFacRecT )
               if ( dbfFacRecL )->nLote == cLote
                  nTot  += nTotNFacRec( dbfFacRecL )
               end
            end
         end
         ( dbfFacRecL )->( dbSkip() )
      end
   end

   SetStatus( cFacRecT, aStaFac )
   SetStatus( dbfFacRecL, aStaLin )

return ( nTot )



Function AppFacRec( cCodCli, cCodArt, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacRec( nil, nil, cCodCli, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         WinAppRec( nil, bEdtRec, D():FacturasRectificativas( nView ), cCodCli, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



Function EdtFacRec( cNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacRec()
         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            WinEdtRec( nil, bEdtRec, D():FacturasRectificativas( nView ) )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION ZooFacRec( cNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacRec()
         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            WinZooRec( nil, bEdtRec, D():FacturasRectificativas( nView ) )
         end
         CloseFiles()
      end

   end

Return .T.



FUNCTION DelFacRec( cNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 16 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacRec()
         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            WinDelRec( nil, D():FacturasRectificativas( nView ), {|| QuiFacRec() } )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            WinDelRec( nil, D():FacturasRectificativas( nView ), {|| QuiFacRec() } )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION PrnFacRec( cNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacRec()
         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            GenFacRec( 1 )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            GenFacRec( 1 )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION VisFacRec( cNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacRec()
         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            GenFacRec( 2 )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumFac, "nNumFac", D():FacturasRectificativas( nView ) )
            GenFacRec( 2 )
         end

         CloseFiles()

      end

   end

Return .T.



function SynFacRec( cPath )

   local oBlock
   local oError
   local aTotFac
   local cCodImp
   local cNumSer
   local aNumSer
   local dbfFacRecL
   local dbfArticulo
   local hConsolidacion

   If( cPath == nil, cPath := cPatEmp(), ) ;

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacRecT.DBF" ), ( cCheckArea( "FacRecT", @dbfFacRecT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPath + "FacRecT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @dbfFacRecL ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPath + "FacRecL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacRecS.Dbf" ), ( cCheckArea( "FacRecS", @dbfFacRecS ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPath + "FacRecS.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacRecI.DBF" ), ( cCheckArea( "FacRecI", @dbfFacRecI ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPath + "FacRecI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPath + "FacRecE.DBF" ), ( cCheckArea( "FacRecE", @dbfFacRecE ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPath + "FacRecE.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacCliP.DBF" ), ( cCheckArea( "FacCliP", @dbfFacCliP ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacCliP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ( dbfFacCliP )->( OrdSetFocus( "rNumFac" ) )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "Client.DBF" ), ( cCheckArea( "Client", @dbfClient ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "Client.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      oNewImp        := TNewImp():Create( cPatEmp() )
      oNewImp:OpenFiles()



        ( dbfFacRecT )->( ordSetFocus( 0 ) )
        ( dbfFacRecT )->( dbGoTop() )

      while !( dbfFacRecT )->( eof() )

         if empty( ( dbfFacRecT )->cSufFac )
            ( dbfFacRecT )->cSufFac := "00"
         end

         if !empty( ( dbfFacRecT )->cNumFac ) .AND. Len( alltrim( ( dbfFacRecT )->cNumFac ) ) <> 12
               ( dbfFacRecT )->cNumFac := alltrim( ( dbfFacRecT )->cNumFac ) + "00"
          end

         if empty( ( dbfFacRecT )->cCodCaj )
            ( dbfFacRecT )->cCodCaj := "000"
         end





         if empty( ( dbfFacRecT )->cGuid )
            ( dbfFacRecT )->cGuid  := win_uuidcreatestring()
         end

         ( dbfFacRecT )->( dbSkip() )

      end

        ( dbfFacRecT )->( ordSetFocus( 1 ) )



        ( dbfFacRecL )->( ordSetFocus( 0 ) )
        ( dbfFacRecL )->( dbGoTop() )

      while !( dbfFacRecL )->( eof() )

         if empty( ( dbfFacRecL )->cSufFac )
              ( dbfFacRecL )->cSufFac     := "00"
         end

         if !empty( ( dbfFacRecL )->cCodAlb ) .AND. Len( alltrim( ( dbfFacRecL )->cCodAlb ) ) <> 12
               ( dbfFacRecL )->cCodAlb    := alltrim( ( dbfFacRecL )->cCodAlb ) + "00"
          end

          if empty( ( dbfFacRecL )->cLote ) .AND. !empty( ( dbfFacRecL )->nLote )
             ( dbfFacRecL )->cLote      := alltrim( Str( ( dbfFacRecL )->nLote ) )
          end

          if empty( ( dbfFacRecL )->nVolumen )
             ( dbfFacRecL )->nVolumen   :=  RetFld( ( dbfFacRecL )->cRef, dbfArticulo, "nVolumen" )
          end

         if empty( ( dbfFacRecL )->cAlmLin )
            ( dbfFacRecL )->cAlmLin    := RetFld( ( dbfFacRecL )->cSerie + Str( ( dbfFacRecL )->nNumFac ) + ( dbfFacRecL )->cSufFac, dbfFacRecT, "cCodAlm" )
         end

         if ( dbfFacRecL )->nRegIva <> RetFld( ( dbfFacRecL )->cSerie + str( ( dbfFacRecL )->nNumFac ) + ( dbfFacRecL )->cSufFac, dbfFacRecT, "nRegIva" )
            if ( dbfFacRecL )->( dbRLock() )
               ( dbfFacRecL )->nRegIva    := RetFld( ( dbfFacRecL )->cSerie + str( ( dbfFacRecL )->nNumFac ) + ( dbfFacRecL )->cSufFac, dbfFacRecT, "nRegIva" )
               ( dbfFacRecL )->( dbUnLock() )
            end
         end


         if !empty( ( dbfFacRecL )->mNumSer )

             aNumSer                       := hb_aTokens( ( dbfFacRecL )->mNumSer, "," )
             for each cNumSer in aNumSer
                ( dbfFacRecS )->( dbAppend() )
                ( dbfFacRecS )->cSerFac    := ( dbfFacRecL )->cSerie
                ( dbfFacRecS )->nNumFac    := ( dbfFacRecL )->nNumFac
                ( dbfFacRecS )->cSufFac    := ( dbfFacRecL )->cSufFac
                ( dbfFacRecS )->cRef       := ( dbfFacRecL )->cRef
                ( dbfFacRecS )->cAlmLin    := ( dbfFacRecL )->cAlmLin
                ( dbfFacRecS )->nNumLin    := ( dbfFacRecL )->nNumLin
                ( dbfFacRecS )->cNumSer    := cNumSer
             next

            ( dbfFacRecL )->mNumSer       := ""

         end

         if empty( ( dbfFacRecL )->nPosPrint )
            ( dbfFacRecL )->nPosPrint        := ( dbfFacRecL )->nPosPrint
         end

         ( dbfFacRecL )->( dbSkip() )

         SysRefresh()

      end

        ( dbfFacRecL )->( ordSetFocus( 1 ) )



        ( dbfFacRecS )->( ordSetFocus( 0 ) )
        ( dbfFacRecS )->( dbGoTop() )

      while !( dbfFacRecS )->( eof() )

          if empty( ( dbfFacRecS )->cSufFac )
              ( dbfFacRecS )->cSufFac := "00"
           end

            if empty( ( dbfFacRecS )->dFecFac )
               ( dbfFacRecS )->dFecFac     := RetFld( ( dbfFacRecS )->cSerie + Str( ( dbfFacRecS )->nNumFac ) + ( dbfFacRecS )->cSufFac, dbfFacRecT, "dFecFac" )
            end

            ( dbfFacRecS )->( dbSkip() )

            SysRefresh()

      end

      ( dbfFacRecS )->( ordSetFocus( 1 ) )





        ( dbfFacRecT )->( dbGoTop() )
      while !( dbfFacRecT )->( eof() )

         if ( dbfFacRecT )->nTotFac == 0
            aTotFac                 := aTotFacRec( ( dbfFacRecT )->cSerie + Str( ( dbfFacRecT )->nNumFac ) + ( dbfFacRecT )->cSufFac, dbfFacRecT, dbfFacRecL, dbfIva, dbfDiv, ( dbfFacRecT )->cDivFac )
            ( dbfFacRecT )->nTotNet := aTotFac[1]
            ( dbfFacRecT )->nTotIva := aTotFac[2]
            ( dbfFacRecT )->nTotReq := aTotFac[3]
            ( dbfFacRecT )->nTotFac := aTotFac[4]
         end

         ( dbfFacRecT )->( dbSkip() )

      end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos de facturas rectificativas de clientes." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfFacRecT  )->( dbCloseArea() )
   ( dbfFacRecL  )->( dbCloseArea() )
   ( dbfFacRecS  )->( dbCloseArea() )
   ( dbfFacRecI  )->( dbCloseArea() )
   ( dbfFacRecE  )->( dbCloseArea() )
   ( dbfFacCliP  )->( dbCloseArea() )
   ( dbfAntCliT  )->( dbCloseArea() )
   ( dbfFamilia  )->( dbCloseArea() )
   ( dbfIva      )->( dbCloseArea() )
   ( dbfArticulo )->( dbCloseArea() )
   ( dbfDiv      )->( dbCloseArea() )
   ( dbfClient   )->( dbCloseArea() )

   if !empty( oNewImp )
      oNewImp:end()
   end

   oNewImp              := nil

Return nil



FUNCTION nTotalRecibosGeneradosRectificativasCliente( cFactura, cFacCliT, dbfFacCliP, dbfIva, dbfDiv, cDivRet )

Return ( nPagFacRec( cFactura, cFacCliT, dbfFacCliP, dbfIva, dbfDiv, cDivRet, .F., .F. ) )



FUNCTION nTotalRecibosPagadosRectificativasCliente( cFactura, cFacCliT, dbfFacCliP, dbfIva, dbfDiv, cDivRet )

Return ( nPagFacRec( cFactura, cFacCliT, dbfFacCliP, dbfIva, dbfDiv, cDivRet, .T., .F. ) )







FUNCTION nPagFacRec( cFactura, cFacRecT, dbfFacCliP, dbfIva, dbfDiv, cDivRet, lOnlyCob, lPic )

   local nOrd
   local nRec
   local cPorDiv
   local nRouDiv        := 2
   local nTotalPagado   := 0
   local cCodDiv        := cDivEmp()

   If( lOnlyCob == nil, lOnlyCob := .T., ) ;
   If( lPic == nil, lPic := .F., ) ;





   cCodDiv              := ( dbfFacCliP )->cDivPgo
   cPorDiv              := cPorDiv( cCodDiv, dbfDiv )
   nRouDiv              := nRouDiv( cCodDiv, dbfDiv )

   if empty( cFactura )

      nRec              := ( dbfFacCliP )->( Recno() )

      ( dbfFacCliP )->( dbGoTop() )
      while !( dbfFacCliP )->( Eof() )

         if ( lOnlyCob .AND. ( dbfFacCliP )->lCobrado .AND. !( dbfFacCliP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( dbfFacCliP )->lDevuelto )
            nTotalPagado+= ( dbfFacCliP )->nImporte
         end

         ( dbfFacCliP )->( dbSkip() )

      end

      ( dbfFacCliP )->( dbGoTo( nRec ) )

   else

      nRec              := ( dbfFacCliP )->( Recno() )
      nOrd              := ( dbfFacCliP )->( OrdSetFocus( "rNumFac" ) )

      if ( dbfFacCliP )->( dbSeek( cFactura ) )

         while ( ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFactura )

            if ( lOnlyCob .AND. ( dbfFacCliP )->lCobrado .AND. !( dbfFacCliP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( dbfFacCliP )->lDevuelto )
               nTotalPagado   += ( dbfFacCliP )->nImporte
            end

            ( dbfFacCliP )->( dbSkip() )

         end

      end

      ( dbfFacCliP )->( OrdSetFocus( nOrd ) )
      ( dbfFacCliP )->( dbGoTo( nRec ) )

   end

   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      nTotalPagado      := nCnv2Div( nTotalPagado, cCodDiv, cDivRet )
      cPorDiv           := cPorDiv( cDivRet, dbfDiv )
      nRouDiv           := nRouDiv( cDivRet, dbfDiv )
   end

   nTotalPagado         := Round( nTotalPagado, nRouDiv )

   if lPic
      nTotalPagado      := Trans( nTotalPagado, cPorDiv )
   end

RETURN ( nTotalPagado )



FUNCTION nChkPagFacRec( cFacRec, cFacRecT, dbfFacCliP )

   local nBitmap        := 3

   if ( cFacRecT )->lLiquidada

      nBitmap           := 1

   elseif ( dbfFacCliP )->( dbSeek( cFacRec ) )

      while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cFacRec .AND. !( dbfFacCliP )->( eof() )

         if ( dbfFacCliP )->lCobrado

            nBitmap     := 2
            exit

         end

         ( dbfFacCliP )->( dbSkip() )

      end

   end

RETURN nBitmap



FUNCTION cChkPagFacRec( cFacRec, cFacRecT, dbfFacCliP )

   local cChkPag        := ""
   local nChkPag        := nChkPagFacRec( cFacRec, cFacRecT, dbfFacCliP )

   do case
      case nChkPag == 1
         cChkPag        := "Cobrado"

      case nChkPag == 2
         cChkPag        := "Parcialmente"

      case nChkPag == 3
         cChkPag        := "Pendiente"

   end

RETURN ( cChkPag )



FUNCTION ChkLqdFacRec( aTmp, cFacRecT, dbfFacRecL, dbfFacCliP, dbfIva, dbfDiv )

   local nTotal
   local lChkLqd
   local cDivFac
   local cFactura
   local nPagFacCli
   local nRec                    := ( dbfFacCliP )->( RecNo() )

   if aTmp <> nil
      cFactura                   := aTmp[1 ] + Str( aTmp[2] ) + aTmp[3]
      cDivFac                    := aTmp[60]
   else
      cFactura                   := ( cFacRecT )->CSERIE + Str( ( cFacRecT )->NNUMFAC ) + ( cFacRecT )->CSUFFAC
      cDivFac                    := ( cFacRecT )->CDIVFAC
   end

   nTotal                        := abs( nTotFacRec( cFactura, cFacRecT, dbfFacRecL, dbfIva, dbfDiv, nil, nil, .F. ) )
   nPagFacCli                    := abs( nPagFacRec( cFactura, cFacRecT, dbfFacCliP, dbfIva, dbfDiv, nil, .T. ) )

   lChkLqd                       := !lMayorIgual( nTotal, nPagFacCli, 0.1 )

   if aTmp <> nil
      aTmp[ 25 ]        := lChkLqd
   end

   if dbLock( cFacRecT )
      ( cFacRecT )->lLiquidada   := lChkLqd
      ( cFacRecT )->( dbUnLock() )
   end

   ( dbfFacCliP )->( dbGoTo( nRec ) )

RETURN ( lChkLqd )



FUNCTION nPesLFacRec( cFacRecL )

   local nCalculo    := 0

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView ), ) ;

   if !( cFacRecL )->lTotLin
      nCalculo       := Abs( nTotNFacRec( cFacRecL ) ) * ( cFacRecL )->nPesoKg
   end

RETURN ( nCalculo )



STATIC FUNCTION DupSerie( oWndBrw )

   local oDlg
   local oSerIni
   local oSerFin
   local oTxtDup
   local nTxtDup     := 0
   local nRecno      := ( D():FacturasRectificativas( nView ) )->( Recno() )
   local nOrdAnt     := ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( D():FacturasRectificativas( nView ) )->cSerie, ( D():FacturasRectificativas( nView ) )->nNumFac, ( D():FacturasRectificativas( nView ) )->cSufFac, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel
   local oFecDoc
   local cFecDoc     := GetSysDate()




   oDlg = TDialog():New(,,,, "Duplicar series de facturas rectificativas", "DUPSERDOC",, .F.,,,,, oWndBrw, .F.,,,,,, .F.,, "oDlg", nil, )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )




   oFecDoc := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cFecDoc, cFecDoc:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )





   oTxtDup := TApoloMeter():ReDefine( 160, { | u | If( PCount()==0, nTxtDup, nTxtDup:= u ) }, ( D():FacturasRectificativas( nView ) )->( OrdKeyCount() ), oDlg, .F.,,, .T.,,,, )

      oDlg:AddFastKey( 116, {|| DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( D():FacturasRectificativas( nView ) )->( dbGoTo( nRecNo ) )
   ( D():FacturasRectificativas( nView ) )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



FUNCTION IsFacRec( cPath )

   If( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "FacRecT.Dbf" )
      dbCreate( cPath + "FacRecT.Dbf", aSqlStruct( aItmFacRec() ), cDriver() )
   end

   if !lExistTable( cPath + "FacRecL.Dbf" )
      dbCreate( cPath + "FacRecL.Dbf", aSqlStruct( aColFacRec() ), cDriver() )
   end

   if !lExistTable( cPath + "FacRecI.Dbf" )
      dbCreate( cPath + "FacRecI.Dbf", aSqlStruct( aIncFacRec() ), cDriver() )
   end

   if !lExistTable( cPath + "FacRecD.Dbf" )
      dbCreate( cPath + "FacRecD.Dbf", aSqlStruct( aFacRecDoc() ), cDriver() )
   end




   if !lExistIndex( cPath + "FacRecT.Cdx" ) .OR.  !lExistIndex( cPath + "FacRecL.Cdx" ) .OR.  !lExistIndex( cPath + "FacRecI.Cdx" ) .OR.  !lExistTable( cPath + "FacRecD.Cdx" )

      rxFacRec( cPath )

   end

Return ( nil )



Function DesignReportFacRec( oFr, dbfDoc)

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "CallHbFunc('nTotFacRec');"                                 + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "MasterData",  "MainPage", 6 )
         oFr:SetProperty(     "MasterData",  "Top", 200 )
         oFr:SetProperty(     "MasterData",  "Height", 0 )
         oFr:SetProperty(     "MasterData",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "MasterData",  "DataSet", "Facturas rectificativas" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de facturas rectificativas" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function mailReportFacRec( cCodigoDocumento )

Return ( printReportFacRec( 6, 1, ImpresoraDefectoUsuario(), cCodigoDocumento ) )



Function PrintReportFacRec( nDevice, nCopies, cPrinter )

   local oFr
   local cFilePdf       := cPatOut() + "FacturasRectificativasCliente" + StrTran( ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac, " ", "" ) + ".Pdf"
   local nOrd

   If( nDevice == nil, nDevice := 2, ) ;
   If( nCopies == nil, nCopies := 1, ) ;

   if Empty( cPrinter )
      cPrinter                := ImpresoraDefectoUsuario()
   end

   SysRefresh()

   nOrd                         := ( D():FacturasRectificativasLineas( nView) )->( ordSetFocus( "nPosPrint" ) )

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( D():Documentos( nView ) )->( Select() ), "mReport" ) } )





   DataReport( oFr )





   if !empty( ( D():Documentos( nView ) )->mReport )

      oFr:LoadFromBlob( ( D():Documentos( nView ) )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2

            oFr:ShowPreparedReport()

         case nDevice == 1

            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

      end

   end





   oFr:DestroyFr()

   ( D():FacturasRectificativasLineas( nView) )->( ordSetFocus( nOrd ) )

Return cFilePdf







FUNCTION cDesFacRec( cFacRecL, cFacRecS )

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView), ) ;
   If( cFacRecS == nil, cFacRecS := dbfFacRecS, ) ;

RETURN ( Descrip( cFacRecL, cFacRecS ) )



FUNCTION cDesFacRecLeng( cFacRecL, cFacRecS, cArtLeng )

   If( cFacRecL == nil, cFacRecL := D():FacturasRectificativasLineas( nView), ) ;
   If( cFacRecS == nil, cFacRecS := dbfFacRecS, ) ;
   If( cArtLeng == nil, cArtLeng := D():ArticuloLenguaje( nView ), ) ;

RETURN ( DescripLeng( cFacRecL, cFacRecS, cArtLeng ) )



Function cCtaFacRec( cFacRecT, cFacCliP, cBncCli )

   local cCtaFacRec  := ""

   If( cFacRecT == nil, cFacRecT := D():FacturasRectificativas( nView ), ) ;
   If( cFacCliP == nil, cFacCliP := dbfFacCliP, ) ;
   If( cBncCli == nil, cBncCli := dbfCliBnc, ) ;

   cCtaFacRec        := Rtrim( ( cFacRecT )->cEntBnc + ( cFacRecT )->cSucBnc + ( cFacRecT )->cDigBnc + ( cFacRecT )->cCtaBnc )

   if empty( cCtaFacRec )
      if dbSeekInOrd( ( cFacRecT )->cSerie + Str( ( cFacRecT )->nNumFac ) + ( cFacRecT )->cSufFac, "rNumFac", cFacCliP )
         cCtaFacRec  := cClientCuenta( ( cFacCliP )->cCodCli, cBncCli )
      end
   end

Return ( cCtaFacRec )




Function isLineaTotalFacRec( uFacRecL )

   if isArray( uFacRecL )
      Return ( uFacRecL[ 25 ] )
   end

Return ( ( uFacRecL )->lTotLin )



Function nDescuentoLinealFacRec( uFacRecL, nDec, nVdv )

   local nDescuentoLineal

   if isArray( uFacRecL )
      nDescuentoLineal  := uFacRecL[ 32 ]
   else
      nDescuentoLineal  := ( uFacRecL )->nDtoDiv
   end

Return ( Round( nDescuentoLineal / nVdv, nDec ) )



Function nDescuentoPorcentualFacRec( uFacRecL )

   local nDescuentoPorcentual

   if isArray( uFacRecL )
      nDescuentoPorcentual  := uFacRecL[ 9 ]
   else
      nDescuentoPorcentual  := ( uFacRecL )->nDto
   end

Return ( nDescuentoPorcentual )



Function nDescuentoPromocionFacRec( uFacRecL )

   local nDescuentoPromocion

   if isArray( uFacRecL )
      nDescuentoPromocion  := uFacRecL[ 10 ]
   else
      nDescuentoPromocion  := ( uFacRecL )->nDtoPrm
   end

Return ( nDescuentoPromocion )



Function nPuntoVerdeFacRec( uFacRecL )

   local nPuntoVerde

   if isArray( uFacRecL )
      nPuntoVerde  := uFacRecL[ 7 ]
   else
      nPuntoVerde  := ( uFacRecL )->nPntVer
   end

Return ( nPuntoVerde )



Function nTransporteFacRec( uFacRecL )

   local nTransporte

   if isArray( uFacRecL )
      nTransporte  := uFacRecL[ 8 ]
   else
      nTransporte  := ( uFacRecL )->nImpTrn
   end

Return ( nTransporte )




FUNCTION nTotLFacRec( uFacRecL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo
   local nUnidades

   If( uFacRecL == nil, uFacRecL := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .T., ) ;
   If( lImpTrn == nil, lImpTrn := .T., ) ;

   if isLineaTotalFacRec( uFacRecL )

      nCalculo          := nTotUFacRec( uFacRecL, nDec, nVdv )

   else

      nUnidades         := nTotNFacRec( uFacRecL )
      nCalculo          := nTotUFacRec( uFacRecL, nDec, nVdv ) * nUnidades





      nCalculo          -= nDescuentoLinealFacRec( uFacRecL, nDec, nVdv ) * nUnidades

      if lDto .AND. nDescuentoPorcentualFacRec( uFacRecL ) <> 0
         nCalculo       -= nCalculo * nDescuentoPorcentualFacRec( uFacRecL ) / 100
      end

      if lDto .AND. nDescuentoPromocionFacRec( uFacRecL ) <> 0
         nCalculo       -= nCalculo * nDescuentoPromocionFacRec( uFacRecL ) / 100
      end





      if lPntVer .AND. nPuntoVerdeFacRec( uFacRecL ) <> 0
         nCalculo       += nPuntoVerdeFacRec( uFacRecL ) * nUnidades
      end





      if lImpTrn .AND. nTransporteFacRec( uFacRecL ) <> 0
         nCalculo       += nTransporteFacRec( uFacRecL ) * nUnidades
      end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   if nRou <> nil
      nCalculo          := Round( nCalculo, nRou )
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )







FUNCTION nTotUFacRec( uTmpLin, nDec, nVdv )

   local nCalculo    := 0

   If( uTmpLin == nil, uTmpLin := D():FacturasRectificativasLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   do case
      case IsChar( uTmpLin )
         nCalculo    := ( uTmpLin )->nPreUnit

      case IsObject( uTmpLin )
         nCalculo    := uTmpLin:nPreUnit

      case IsArray( uTmpLin )
         nCalculo    := uTmpLin[ 6 ]

      case IsHash( uTmpLin )
         nCalculo    := hGet( uTmpLin, "PrecioVenta" )
   end

   nCalculo          := nCalculo / nVdv

RETURN ( Round( nCalculo, nDec ) )



Function nImportaLineas()

   local oDlg
   local oBmp
   local oBtnOk
   local oBtnCancel
   local oOption
   local nOption  := 1
   local cText    := "¿Desea importar las lineas de la factura?"

   oDlg = TDialog():New(,,,,, "IMPFACREC",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )

   oBmp := TBitmap():ReDefine( 500, "gc_question_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )

   TSay():ReDefine( 100, {|| cText}, oDlg,,,, .F.,, .F., .F., )



   oOption := TRadMenu():Redefine( { | u | If( PCount()==0, nOption, nOption:= u ) }, oDlg,, { 110, 120 },,,,, .F.,, )

   oBtnOk := TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )

   oBtnCancel := TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult <> 1
      nOption     := 0
   end

   if !empty( oBmp )
      oBmp:End()
   end

RETURN ( nOption )



FUNCTION sTotFacRec( cFactura, cFacRecT, dbfFacRecL, dbfIva, dbfDiv, dbfFacCliP, cDivRet )

   local sTotal
   local nCobro

   nTotFacRec( cFactura, cFacRecT, dbfFacRecL, dbfIva, dbfDiv, nil, cDivRet, .F. )

   sTotal                                 := sTotal()

   sTotal:nTotalBruto                     := nTotBrt
   sTotal:nTotalNeto                      := nTotNet
   sTotal:nTotalIva                       := nTotIva
   sTotal:nTotalRecargoEquivalencia       := nTotReq
   sTotal:nTotalRetencion                 := nTotRet
   sTotal:nTotalDocumento                 := nTotFac
   sTotal:nTotalPuntoVerde                := nTotPnt
   sTotal:nTotalTransporte                := nTotTrn
   sTotal:nTotalAgente                    := nTotAge
   sTotal:nTotalCosto                     := nTotCos
   sTotal:nTotalImpuestoHidrocarburos     := nTotIvm
   sTotal:nTotalRentabilidad              := nTotRnt

   sTotal:nTotalDescuentoGeneral          := nTotDto
   sTotal:nTotalDescuentoProntoPago       := nTotDpp
   sTotal:nTotalDescuentoUno              := nTotUno
   sTotal:nTotalDescuentoDos              := nTotDos

   sTotal:aTotalIva                       := aTotIva

   nCobro                                 := nPagFacRec( cFactura, cFacRecT, dbfFacCliP, dbfIva, dbfDiv, nil, .T. )

   sTotal:nTotalCobrado                   := nCobro

Return ( sTotal )



FUNCTION browseFacturasRectificativas( oGet, oIva, nView )

    local oDlg
    local oBrw
   local oGet1
   local cGet1
   local oCbxOrd
   local cCbxOrd
   local nOrd
   local aCbxOrd

   aCbxOrd        := { "Número", "Fecha", "Cliente", "Nombre" }
   nOrd           := GetBrwOpt( "BrwFacRec" )
   nOrd           := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd        := aCbxOrd[ nOrd ]

   D():getStatusFacturasRectificativas( nView )

   oDlg = TDialog():New(,,,, "Facturas rectificativas de clientes", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, D():FacturasRectificativas( nView ) ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, D():FacturasRectificativas( nView ), nil, nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( D():FacturasRectificativas( nView ) )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := D():FacturasRectificativas( nView )
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Factura de cliente.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->cSerie + "/" + RTrim( Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) ) + "/" + ( D():FacturasRectificativas( nView ) )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( D():FacturasRectificativas( nView ) )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| Rtrim( ( D():FacturasRectificativas( nView ) )->cCodCli ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| Rtrim( ( D():FacturasRectificativas( nView ) )->cNomCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( D():FacturasRectificativas( nView ) )->nTotFac }
         :cEditPicture     := cPorDiv( ( D():FacturasRectificativas( nView ) )->cDivFac, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :cSortOrder       := "nTotFac"
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end





        TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





        TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      oGet:cText( ( D():FacturasRectificativas( nView ) )->cSerie + Str( ( D():FacturasRectificativas( nView ) )->nNumFac ) + ( D():FacturasRectificativas( nView ) )->cSufFac )

      oGet:bWhen   := {|| .F. }

      if !empty( oIva )
         oIva:Click( ( D():FacturasRectificativas( nView ) )->lIvaInc ):Refresh()
      end

   end

   SetBrwOpt( "BrwFacRec", ( D():FacturasRectificativas( nView ) )->( OrdNumber() ) )

   D():setStatusFacturasRectificativas( nView )





   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )



Function DesignLabelFacturaRectificativaClientes( oFr, cDoc )

   local oLabel
   local lOpenFiles  := empty( nView )

   if lOpenFiles .AND. !Openfiles()
      Return .F.
   endif

   oLabel            := TLabelGeneratorFacturasRectificativaClientes():New( nView )



   oLabel:createTempLabelReport()
   oLabel:loadTempLabelReport()
   oLabel:dataLabel( oFr )



   if !empty( ( cDoc )->mReport )
      oFr:LoadFromBlob( ( cDoc )->( Select() ), "mReport")
   else
      oFr:AddPage(         "MainPage" )
      oFr:AddBand(         "MasterData",  "MainPage",       6 )
      oFr:SetProperty(     "MasterData",  "Top",            200 )
      oFr:SetProperty(     "MasterData",  "Height",         100 )
      oFr:SetObjProperty(  "MasterData",  "DataSet",        "Lineas de facturas" )
   end

   oFr:DesignReport()
   oFr:DestroyFr()

   oLabel:DestroyTempReport()
   oLabel:End()

Return .T.



Static Function lChangeRegIva( aTmp )

   lImpuestos     := ( aTmp[ 65 ] <= 1 )

   if !empty( oImpuestos )
      oImpuestos:Refresh()
   end

return ( .T. )


Function getExtraFieldFacturaRectificativa( cFieldName )

Return ( getExtraField( cFieldName, oDetCamposExtra, D():FacturasRectificativasId( nView ) ) )



Function nombrePrimeraPropiedadFacturasRectificativasLineas()

Return ( nombrePropiedad( ( D():FacturasRectificativasLineas( nView ) )->cCodPr1, ( D():FacturasRectificativasLineas( nView ) )->cValPr1, nView ) )



Function nombreSegundaPropiedadFacturasRectificativasLineas()

Return ( nombrePropiedad( ( D():FacturasRectificativasLineas( nView ) )->cCodPr2, ( D():FacturasRectificativasLineas( nView ) )->cValPr2, nView ) )



Function FacturasRectificativasId()

Return ( D():FacturasRectificativasId( nView ) )



_HB_CLASS TFacturasRectificativasSenderReciver ; function TFacturasRectificativasSenderReciver ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFacturasRectificativasSenderReciver", iif( .T., { @TSenderReciverItem() }, { @HBObject() } ), @TFacturasRectificativasSenderReciver() ) ) ;

   _HB_MEMBER { cFileNameFacturas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileNameFacturas"}, .F. )

   _HB_MEMBER { lSuccesfullSendFacturas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lSuccesfullSendFacturas"}, .F. )

   _HB_MEMBER { nFacturaNumberSend } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nFacturaNumberSend"}, .F. )

   _HB_MEMBER CreateData(); oClass:AddMethod( "CreateData", @TFacturasRectificativasSenderReciver_CreateData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RestoreData(); oClass:AddMethod( "RestoreData", @TFacturasRectificativasSenderReciver_RestoreData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SendData(); oClass:AddMethod( "SendData", @TFacturasRectificativasSenderReciver_SendData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ReciveData(); oClass:AddMethod( "ReciveData", @TFacturasRectificativasSenderReciver_ReciveData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Process(); oClass:AddMethod( "Process", @TFacturasRectificativasSenderReciver_Process(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nGetFacturaNumberToSend(); oClass:AddInline( "nGetFacturaNumberToSend", {|Self | ( ( Self ) ), ( ::nFacturaNumberSend     := GetPvProfInt( "Numero", "Facturas rectificativas", ::nFacturaNumberSend, ::cIniFile ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER IncFacturaNumberToSend(); oClass:AddInline( "IncFacturaNumberToSend", {|Self | ( ( Self ) ), ( WritePProString( "Numero", "Facturas rectificativas",    cValToChar( ++::nFacturaNumberSend ),  ::cIniFile ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validateRecepcion( tmpFacRecT, cFacRecT); oClass:AddMethod( "validateRecepcion", @TFacturasRectificativasSenderReciver_validateRecepcion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFacturasRectificativasSenderReciver ;



static FUNCTION TFacturasRectificativasSenderReciver_CreateData( ) ; local Self AS CLASS TFacturasRectificativasSenderReciver := QSelf() AS CLASS TFacturasRectificativasSenderReciver

   local oBlock
   local oError
   local nOrd
   local cFacRecT
   local dbfFacRecL
   local dbfFacRecI
   local tmpFacRecT
   local tmpFacRecL
   local tmpFacRecI
   local lSndFacRec           := .F.

   if ::oSender:lServer
      ::cFileNameFacturas       := "FacRec" + win_uuidcreatestring() + ".All"
   else
      ::cFileNameFacturas       := "FacRec" + win_uuidcreatestring() + "." + RetSufEmp()
   end

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecT.DBF" ), ( cCheckArea( "FacRecT", @cFacRecT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @dbfFacRecL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecI.DBF" ), ( cCheckArea( "FacRecI", @dbfFacRecI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end





   mkFacRec( cPatSnd() )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacRecT.DBF" ), ( cCheckArea( "FacRecT", @tmpFacRecT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacRecT.CDX" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @tmpFacRecL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacRecL.CDX" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacRecI.DBF" ), ( cCheckArea( "FacRecI", @tmpFacRecI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacRecI.CDX" ) )

   if !empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( cFacRecT )->( LastRec() )
   end

   ::oSender:SetText( "Enviando facturas rectificativas de clientes" )

   nOrd  := ( cFacRecT )->( OrdSetFocus( "lSndDoc" ) )

   if ( cFacRecT )->( dbSeek( .T. ) )
      while !( cFacRecT )->( eof() )

         if ( cFacRecT )->lSndDoc

            lSndFacRec  := .T.

            dbPass( cFacRecT, tmpFacRecT, .T. )
            ::oSender:SetText( ( cFacRecT )->cSerie + "/" + alltrim( Str( ( cFacRecT )->nNumFac ) ) + "/" + alltrim( ( cFacRecT )->cSufFac ) + "; " + Dtoc( ( cFacRecT )->dFecFac ) + ";" + alltrim( ( cFacRecT )->cCodCli ) + "; " + ( cFacRecT )->cNomCli )

            if ( dbfFacRecL )->( dbSeek( ( cFacRecT )->cSerie + Str( ( cFacRecT )->nNumFac ) + ( cFacRecT )->cSufFac ) )
               while ( ( dbfFacRecL )->cSerie + Str( ( dbfFacRecL )->nNumFac ) + ( dbfFacRecL )->cSufFac ) == ( ( cFacRecT )->cSerie + Str( ( cFacRecT )->nNumFac ) + ( cFacRecT )->cSufFac ) .AND. !( dbfFacRecL )->( eof() )
                  dbPass( dbfFacRecL, tmpFacRecL, .T. )
                  ( dbfFacRecL )->( dbSkip() )
               end
            end

            if ( dbfFacRecI )->( dbSeek( ( cFacRecT )->cSerie + Str( ( cFacRecT )->nNumFac ) + ( cFacRecT )->cSufFac ) )
               while ( ( dbfFacRecI )->cSerie + Str( ( dbfFacRecI )->nNumFac ) + ( dbfFacRecI )->cSufFac ) == ( ( cFacRecT )->cSerie + Str( ( cFacRecT )->nNumFac ) + ( cFacRecT )->cSufFac ) .AND. !( dbfFacRecI )->( eof() )
                  dbPass( dbfFacRecI, tmpFacRecI, .T. )
                  ( dbfFacRecI )->( dbSkip() )
               end
            end

         end

         ( cFacRecT )->( dbSkip() )

         if !empty( ::oSender:oMtr )
            ::oSender:oMtr:Set( ( cFacRecT )->( OrdKeyNo() ) )
         end

      end
   end

   ( cFacRecT )->( OrdSetFocus( nOrd ) )

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( cFacRecT )->( dbCloseArea() )
   ( dbfFacRecL )->( dbCloseArea() )
   ( dbfFacRecI )->( dbCloseArea() )
   ( tmpFacRecT )->( dbCloseArea() )
   ( tmpFacRecL )->( dbCloseArea() )
   ( tmpFacRecI )->( dbCloseArea() )

   if lSndFacRec





      ::oSender:SetText( "Comprimiendo facturas rectificativas" )

      if ::oSender:lZipData( ::cFileNameFacturas )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay facturas rectificativas de clientes para enviar" )

   end

Return ( Self )



static FUNCTION TFacturasRectificativasSenderReciver_RestoreData( ) ; local Self AS CLASS TFacturasRectificativasSenderReciver := QSelf() AS CLASS TFacturasRectificativasSenderReciver

   local cFacRecT

   if ::lSuccesfullSendFacturas

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecT.DBF" ), ( cCheckArea( "FacRecT", @cFacRecT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ( cFacRecT )->( OrdSetFocus( "lSndDoc" ) )

      while ( cFacRecT )->( dbSeek( .T. ) ) .AND. !( cFacRecT )->( eof() )
         if ( cFacRecT )->( dbRLock() )
            ( cFacRecT )->lSndDoc := .F.
            ( cFacRecT )->( dbRUnlock() )
         end
      end


      ( cFacRecT )->( dbCloseArea() )

   end

Return ( Self )



static FUNCTION TFacturasRectificativasSenderReciver_SendData( ) ; local Self AS CLASS TFacturasRectificativasSenderReciver := QSelf() AS CLASS TFacturasRectificativasSenderReciver

   local cDirectory           := ""

   ::lSuccesfullSendFacturas  := .F.





   if File( cPatOut() + ::cFileNameFacturas )

      if ::oSender:SendFiles( cPatOut() + ::cFileNameFacturas, cDirectory + ::cFileNameFacturas, cDirectory )
         ::lSuccesfullSendFacturas  := .T.
         ::oSender:SetText( "Fichero facturas rectificativas enviados " + ::cFileNameFacturas )
      else
         ::oSender:SetText( "ERROR al enviar fichero de facturas rectificativas" )
      end

   end









Return ( Self )



static FUNCTION TFacturasRectificativasSenderReciver_ReciveData( ) ; local Self AS CLASS TFacturasRectificativasSenderReciver := QSelf() AS CLASS TFacturasRectificativasSenderReciver

   local n
   local aExt

   aExt     := ::oSender:aExtensions()





   ::oSender:SetText( "Recibiendo facturas rectificativas de clientes" )

   for n := 1 to len( aExt )
      ::oSender:GetFiles( "FacRec*." + aExt[ n ], cPatIn() )
   next

   ::oSender:SetText( "Facturas rectificativas de clientes recibidos" )

Return Self



static FUNCTION TFacturasRectificativasSenderReciver_Process( ) ; local Self AS CLASS TFacturasRectificativasSenderReciver := QSelf() AS CLASS TFacturasRectificativasSenderReciver

   local m
   local cFacRecT
   local dbfFacRecL
   local tmpFacRecT
   local tmpFacRecL
   local oBlock
   local oError
   local lClient        := ::oSender:lServer
   local aFiles         := Directory( cPatIn() + "FacRec*.*" )
   local cNumeroFactura
   local cTextoFactura  := ""

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE





      if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )






         if file( cPatSnd() + "FacRecT.Dbf" ) .AND. file( cPatSnd() + "FacRecL.Dbf" )

            dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacRecT.DBF" ), ( cCheckArea( "FacRecT", @tmpFacRecT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )

            dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @tmpFacRecL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacRecL.CDX" ) )

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecT.DBF" ), ( cCheckArea( "FacRecT", @cFacRecT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @dbfFacRecL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            ( tmpFacRecT )->( dbGoTop() )

            while ( tmpFacRecT )->( !eof() )





               if ::validateRecepcion( tmpFacRecT, cFacRecT )

                  cNumeroFactura    := ( tmpFacRecT )->cSerie + str( ( tmpFacRecT )->nNumFac ) + ( tmpFacRecT )->cSufFac
                  cTextoFactura     := ( tmpFacRecT )->cSerie + "/" + alltrim( str( ( tmpFacRecT )->nNumFac ) ) + "/" + alltrim( ( tmpFacRecT )->cSufFac ) + "; " + Dtoc( ( tmpFacRecT )->dFecFac ) + "; " + alltrim( ( tmpFacRecT )->cCodCli ) + "; " + ( tmpFacRecT )->cNomCli

                  while ( cFacRecT )->( dbseek( cNumeroFactura ) )
                     dbLockDelete( cFacRecT )
                  end

                  while ( dbfFacRecL )->( dbseek( cNumeroFactura ) )
                     dbLockDelete( dbfFacRecL )
                  end

                  dbPass( tmpFacRecT, cFacRecT, .T. )

                  if dbLock( cFacRecT )
                     ( cFacRecT )->lSndDoc := .F.
                     ( cFacRecT )->( dbUnLock() )
                  end

                  ::oSender:SetText( "Añadida rectificativa : " + cTextoFactura )

                  if ( tmpFacRecL )->( dbSeek( ( tmpFacRecT )->cSerie + Str( ( tmpFacRecT )->nNumFac ) + ( tmpFacRecT )->cSufFac ) )
                     while ( tmpFacRecL )->cSerie + Str( ( tmpFacRecL )->nNumFac ) + ( tmpFacRecL )->cSufFac == cNumeroFactura .AND. !( tmpFacRecL )->( eof() )
                        dbPass( tmpFacRecL, dbfFacRecL, .T. )
                        ( tmpFacRecL )->( dbSkip() )
                     end
                  end

                  ::oSender:setText( "Añadidas lineas de rectificativa : " + cTextoFactura )

               else

                  ::oSender:SetText( "Factura fecha invalida : " + cTextoFactura )

               end

               ( tmpFacRecT )->( dbSkip() )

            end

            ( cFacRecT )->( dbCloseArea() )
            ( dbfFacRecL )->( dbCloseArea() )
            ( tmpFacRecT )->( dbCloseArea() )
            ( tmpFacRecL )->( dbCloseArea() )

            ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

         else

            ::oSender:SetText( "Faltan ficheros" )

            if !file( cPatSnd() + "FacRecT.Dbf" )
               ::oSender:SetText( "Falta" + cPatSnd() + "FacRecT.Dbf" )
            end

            if !file( cPatSnd() + "FacRecL.Dbf" )
               ::oSender:SetText( "Falta" + cPatSnd() + "FacRecL.Dbf" )
            end

         end

      else

         ::oSender:SetText( "Error al descomprimir los ficheros" )

      end

      RECOVER USING oError

         ( cFacRecT )->( dbCloseArea() )
         ( dbfFacRecL )->( dbCloseArea() )
         ( tmpFacRecT )->( dbCloseArea() )
         ( tmpFacRecL )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self



static FUNCTION TFacturasRectificativasSenderReciver_validateRecepcion( tmpFacRecT, cFacRecT ) ; local Self AS CLASS TFacturasRectificativasSenderReciver := QSelf() AS CLASS TFacturasRectificativasSenderReciver

   ::cErrorRecepcion       := "Pocesando rectificativa de cliente número " + ( cFacRecT )->cSerie + "/" + alltrim( Str( ( cFacRecT )->nNumFac ) ) + "/" + alltrim( ( cFacRecT )->cSufFac ) + " "

   if !( lValidaOperacion( ( tmpFacRecT )->dFecFac, .F. ) )
      ::cErrorRecepcion    += "la fecha " + dtoc( ( tmpFacRecT )->dFecFac ) + " no es valida en esta empresa"
      Return .F.
   end

   if !( ( cFacRecT )->( dbSeek( ( tmpFacRecT )->cSerie + Str( ( tmpFacRecT )->nNumFac ) + ( tmpFacRecT )->cSufFac ) ) )
      Return .T.
   end

   if dtos( ( cFacRecT )->dFecCre ) + ( cFacRecT )->cTimCre >= dtos( ( tmpFacRecT )->dFecCre ) + ( tmpFacRecT )->cTimCre
      ::cErrorRecepcion    += "la fecha en la empresa " + dtoc( ( cFacRecT )->dFecCre ) + " " + ( cFacRecT )->cTimCre + " es más reciente que la recepción " + dtoc( ( tmpFacRecT )->dFecCre ) + " " + ( tmpFacRecT )->cTimCre
      Return .F.
   end

Return ( .T. )



Static Function importarArticulosScaner()

   local memoArticulos

   memoArticulos  := dialogArticulosScaner()

   if memoArticulos <> nil
      msgstop( memoArticulos, "procesar")
   end

Return nil



FUNCTION hStockBufferFacRec( aTmp )

   local hBuffer := {=>}

   do case
      case hb_isArray( aTmp )

         hset( hBuffer, "codigo_articulo", AllTrim( aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "cRef" ) ) ] ) )
         hset( hBuffer, "codigo_almacen_entrada", "" )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "cAlmLin" ) ) ] ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "cCodPr1" ) ) ] ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "cValPr1" ) ) ] ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "cCodPr2" ) ) ] ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "cValPr2" ) ) ] ) )
         hset( hBuffer, "lote", AllTrim( aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "clote" ) ) ] ) )
         hset( hBuffer, "bultos_articulo", aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nBultos" ) ) ] )
         hset( hBuffer, "cajas_articulo", aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "nCanEnt" ) ) ] )
         hset( hBuffer, "unidades_articulo", nTotNFacRec( aTmp ) )
         hset( hBuffer, "fecha", aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "dFecFac" ) ) ] )
         hset( hBuffer, "hora", AllTrim( aTmp[ ( D():FacturasRectificativasLineas( nView ) )->( fieldpos( "tFecFac" ) ) ] ) )

      case hb_isChar( aTmp )

         hset( hBuffer, "codigo_articulo", AllTrim( ( aTmp )->cRef ) )
         hset( hBuffer, "codigo_almacen_entrada", "" )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( ( aTmp )->cAlmLin ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( ( aTmp )->cCodPr1 ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( ( aTmp )->cValPr1 ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( ( aTmp )->cCodPr2 ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( ( aTmp )->cValPr2 ) )
         hset( hBuffer, "lote", AllTrim( ( aTmp )->clote ) )
         hset( hBuffer, "bultos_articulo", ( aTmp )->nBultos )
         hset( hBuffer, "cajas_articulo", ( aTmp )->nCanEnt )
         hset( hBuffer, "unidades_articulo", nTotNFacRec( aTmp ) )
         hset( hBuffer, "fecha", ( aTmp )->dFecFac )
         hset( hBuffer, "hora", AllTrim( ( aTmp )->tFecFac ) )

   end

RETURN ( hBuffer )



Static Function LoadTrans( aTmp, oGetCod, oGetKgs, oSayTrn )

   local uValor   := oGetCod:VarGet()

   if empty( uValor )

      oSayTrn:cText( "" )
      oGetKgs:cText( 0 )

   else

      if oTrans:oDbf:SeekInOrd( uValor, "cCodTrn" )
         oGetCod:cText( uValor )
         oSayTrn:cText( oTrans:oDbf:cNomTrn )
         oGetKgs:cText( oTrans:oDbf:nKgsTrn )
      else
         msgStop( "Código de transportista no encontrado." )
         Return .F.
      end

   end

   RecalculaTotal( aTmp )

Return .T.
