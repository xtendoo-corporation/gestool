#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 214 ".\.\Prg\Factprv.prg"
memvar cDbf
memvar cDbfCol
memvar cDbfRec
memvar cDbfAlm
memvar cDbfPrv
memvar cDbfPgo
memvar cDbfIva
memvar cDbfDiv
memvar cDbfArt
memvar cDbfKit
memvar cDbfPro
memvar cDbfTblPro
memvar aTotIva
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aDatVcto
memvar aImpVcto
memvar nTotBrt
memvar nTotNet
memvar nTotSup
memvar nTotIva
memvar nTotIvm
memvar nTotReq
memvar nTotRet
memvar nTotFac
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotImp
memvar nTotUnd
memvar nPagFac
memvar nTipRet
memvar nTotPage
memvar cPinDivFac
memvar cPirDivFac
memvar cPicEurFac
memvar nDinDivFac
memvar nDirDivFac
memvar nVdvDivFac
memvar nPagina
memvar lEnd
memvar aImpVto
memvar aDatVto





static oWndBrw
static oBrwIva
static oInf
static dbfFacPrvT
static dbfIva
static dbfFacPrvL
static filFacPrvL
static tmpFacPrvT
static tmpFacPrvP
static tmpFacPrvL
static tmpFacPrvI
static tmpFacPrvS
static dbfFacPrvP
static dbfFacPrvI
static dbfFacPrvD
static dbfFacPrvS
static dbfPrv
static dbfArtPrv
static dbfFPago
static dbfTmp
static dbfTmpSer
static dbfKit
static dbfArticulo
static dbfCodebar
static dbfFamilia
static dbfArtCom
static dbfDiv

static dbfCount
static oBandera
static dbfAlbPrvT
static dbfAlbPrvL
static dbfAlbPrvS
static dbfAlm

static oStock
static TComercio

static oDetMenu

static oNewImp
static cNewFile
static cPicEur
static cPicUnd
static cPinDiv
static cPouDiv
static cPorDiv
static cTmpInc
static cTmpDoc
static cTmpPgo
static cTmpSer
static dbfTmpInc
static dbfTmpDoc
static dbfTmpPgo
static cPirDiv
static nDinDiv
static nRinDiv
static oGetTotal
static oGetTotPg
static oGetRet
static oGetNet
static oGetIva
static oGetReq
static oGetIvm
static oGetPgd
static oGetPdt
static oUsr
static cUsr
static oFntTot

static oMnuPgo
static oMnuRec

static aNumAlb
static nGetNeto         := 0
static nGetIva          := 0
static nGetReq          := 0
static nGetPgd          := 0
static cOldCodCli       := ""
static cOldCodArt       := ""
static cOldPrpArt       := ""
static cOldUndMed       := ""
static lOpenFiles       := .F.
static lExternal        := .F.
static nLabels          := 1
static cFiltroUsuario   := ""
static bEdtRec          := { |aTmp, aGet, dbfFacPrvT, oBrw, bWhen, bValid, nMode, cNumAlb | EdtRec( aTmp, aGet, dbfFacPrvT, oBrw, bWhen, bValid, nMode, cNumAlb ) }
static bEdtDet          := { |aTmp, aGet, dbfFacPrvT, oBrw, bWhen, bValid, nMode, aFac    | EdtDet( aTmp, aGet, dbfFacPrvT, oBrw, bWhen, bValid, nMode ) }
static bEdtInc          := { |aTmp, aGet, dbfFacPrvI, oBrw, bWhen, bValid, nMode, aTmpLin | EdtInc( aTmp, aGet, dbfFacPrvI, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtDoc          := { |aTmp, aGet, dbfFacPrvD, oBrw, bWhen, bValid, nMode, aTmpLin | EdtDoc( aTmp, aGet, dbfFacPrvD, oBrw, bWhen, bValid, nMode, aTmpLin ) }

static oNumerosSerie
static oBtnNumerosSerie

static oDetCamposExtra
static oLinDetCamposExtra

static oCentroCoste

static nView

static oMailing

static Counter

static oTipoCtrCoste
static cTipoCtrCoste
static aTipoCtrCoste   := { "Centro de coste", "Proveedor", "Agente", "Cliente" }

static oGetCelda
static cGetCelda



Static Function initPublics()

   public nTotBrt    := 0
   public nTotNet    := 0
   public nTotSup    := 0
   public nTotIva    := 0
   public nTotReq    := 0
   public nTotRet    := 0
   public nTotFac    := 0
   public nTotDto    := 0
   public nTotDpp    := 0
   public nTotUno    := 0
   public nTotDos    := 0
   public nTotImp    := 0
   public nTotIvm    := 0
   public nTotUnd    := 0
   public nPagFac    := 0
   public nTipRet    := 0









   public aTotIva    := {{    "porcentajeiva" => nil, "logrecargo"   => .F., "porcentajere" => nil, "bruto"        => nil, "neto"         => nil, "impiva"       => nil, "impre"        => nil, "nivmh"        => nil, "ntransporte"  => nil, "npntver"      => nil }}
   public aIvaUno    := {}
   public aIvaDos    := {}
   public aIvaTre    := {}

Return ( nil )





STATIC FUNCTION OpenFiles( lExt )

   local oBlock

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de facturas a proveedores" )
      Return ( .F. )
   end

   If( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      DisableAcceso()

      aNumAlb           := excluyentArray()

      lOpenFiles        := .T.

      nView             := D():CreateView()

      D():FacturasProveedores( nView )

      D():Proveedores( nView )

      D():GruposProveedores( nView )

      D():FacturasProveedoresLineas( nView )

      D():FacturasProveedoresIncidencias( nView )

      D():FacturasProveedoresDocumentos( nView )

      D():FacturasProveedoresSeries( nView )

      D():FacturasProveedoresPagos( nView )

      D():TiposIva( nView )

      D():ProveedorArticulo( nView )
      ( D():ProveedorArticulo( nView ) )->( OrdSetFocus( "cCodPrv" ) )

      D():Articulos( nView )

      D():ArticulosCodigosBarras( nView )

      D():Familias( nView )

      D():Kit( nView )

      D():FormasPago( nView )

      D():ArticuloPrecioPropiedades( nView )

      D():Divisas( nView )

      D():AlbaranesProveedores( nView )

      D():AlbaranesProveedoresLineas( nView )

      D():AlbaranesProveedoresSeries( nView )

      D():PedidosProveedores( nView )

      D():Propiedades( nView )

      D():PropiedadesLineas( nView )

      D():Almacen( nView )

      D():Documentos( nView )
      ( D():Documentos( nView ) )->( ordSetFocus( "CTIPO" ) )

      D():UbicacionLineas( nView )

      D():Delegaciones( nView )

      D():Contadores( nView )

      D():Empresa( nView )

      D():FacturasRectificativasProveedores( nView )

      D():BancosProveedores( nView )



      D():GetObject( "UnidadMedicion", nView )

      D():GetObject( "Bancos", nView )

      D():ImpuestosEspeciales( nView )

      D():ArticuloLenguaje( nView )

      oStock            := TStock():Create( cPatEmp() )
      if !oStock:lOpenFiles()
         lOpenFiles     := .F.
      end

      oBandera          := TBandera():New()

      CodigosPostales():GetInstance():OpenFiles()

      TComercio         := TComercio():new( nView, oStock )

      Counter           := TCounter():New( nView, "nFacPrv" )





      oNumerosSerie           := TNumerosSerie()
      oNumerosSerie:lCompras  := .T.
      oNumerosSerie:oStock    := oStock

      oMailing                := TGenmailingDatabaseFacturaProveedor():New( nView )





      oDetCamposExtra         := TDetCamposExtra():New()
      oDetCamposExtra:OpenFiles()
      oDetCamposExtra:SetTipoDocumento( "Facturas a proveedores" )
      oDetCamposExtra:setbId( {|| D():FacturasProveedoresId( nView ) } )

      oLinDetCamposExtra               := TDetCamposExtra():New()
      oLinDetCamposExtra:OpenFiles()
      oLinDetCamposExtra:setTipoDocumento( "Lineas facturas a proveedores" )
      oLinDetCamposExtra:setbId( {|| D():FacturasProveedoresLineasNumeroId( nView ) } )





      oCentroCoste            := TCentroCoste():Create( cPatDat() )
      if !oCentroCoste:OpenFiles()
         lOpenFiles           := .F.
      end



      oNewImp           := TNewImp():Create( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

      oFntTot                 := TFont():New( "Arial", 8, 26, .F., .T. )

      public nTotBrt    := 0
      public nTotNet    := 0
      public nTotSup    := 0
      public nTotIva    := 0
      public nTotReq    := 0
      public nTotRet    := 0
      public nTotFac    := 0
      public nTotDto    := 0
      public nTotDpp    := 0
      public nTotUno    := 0
      public nTotDos    := 0
      public nTotImp    := 0
      public nTotIvm    := 0
      public nTotUnd    := 0
      public nPagFac    := 0
      public nTipRet    := 0









      public aTotIva    := { {   "porcentajeiva" => 0, "logrecargo"   => .F., "porcentajere" => 0, "bruto"        => 0, "neto"         => 0, "impiva"       => 0, "impre"        => 0, "nivmh"        => 0, "ntransporte"  => 0, "npntver"      => 0 } }
      public aIvaUno    := {}
      public aIvaDos    := {}
      public aIvaTre    := {}



      if RolesModel():getRolFiltrarVentas( Auth():rolUuid() )
         cFiltroUsuario       := "Field->cCodUsr == '" + Auth():Codigo()  + "' .and. Field->cCodCaj == '" + Application():CodigoCaja() + "'"
      end

      EnableAcceso()

   RECOVER

      lOpenFiles        := .F.

      EnableAcceso()

      msgStop( "Imposible abrir todas las bases de datos" )

   end

   ErrorBlock( oBlock )

Return ( lOpenFiles )



Static Function CloseFiles()

   DisableAcceso()

   DestroyFastFilter( D():FacturasProveedores( nView ), .T., .T. )

   if oStock <> nil
      oStock:end()
   end

   if !empty( oNewImp )
      oNewImp:end()
   end

   D():DeleteView( nView )

   CodigosPostales():GetInstance():CloseFiles()

   oBandera    := nil
   oStock      := nil
   oNewImp     := nil

   lOpenFiles  := .F.

   oWndBrw     := nil

   if !empty( oFntTot )
      oFntTot:end()
   end

   if !empty( oDetCamposExtra )
      oDetCamposExtra:CloseFiles()
   end

   if !empty( oLinDetCamposExtra )
      oLinDetCamposExtra:CloseFiles()
      oLinDetCamposExtra:End()
   end

   if !empty( oCentroCoste )
      oCentroCoste:CloseFiles()
   end

   if !empty(oMailing)
      oMailing:end()
   end

   TComercio:end()

   nView       := nil

   EnableAcceso()

RETURN .T.



FUNCTION FacPrv( oMenuItem, oWnd, cCodPrv, cCodArt, cNumAlb )

   local oSnd
   local oRpl
   local oImp
   local oRotor
   local oFlt
   local oDel
   local oPrv
   local oPdf
   local oMail
   local oBtnEur
   local nLevel
   local lEuro          := .F.
   local oLiq
   local oScript

   If( oMenuItem == nil, oMenuItem := "facturas_de_proveedores", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;
   If( cCodPrv == nil, cCodPrv := "", ) ;
   If( cCodArt == nil, cCodArt := "", ) ;
   If( cNumAlb == nil, cNumAlb := "", ) ;





   nLevel               := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return .F.
   end



   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end



   runEventScript( "FacturasProveedores\beforeOpenFiles" )



   if !OpenFiles()



      runEventScript( "FacturasProveedores\afterOpenFiles" )

      return .F.

   end



   setScriptSystem( "FacturasProveedores" )



   DisableAcceso()





















   oWndBrw := TShell():New( 0, 0, 22, 80, "Facturas de proveedores",, oWnd,,, .F.,,, ( D():FacturasProveedores( nView ) ),,,,, {"Número", "Fecha", "Código", "Nombre", "Su factura", "Número documento", "Pago", "NFC"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, D():FacturasProveedores( nView ), cCodPrv, cCodArt, cNumAlb ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, D():FacturasProveedores( nView ), cCodPrv, cCodArt, cNumAlb ) )}, {||( WinDelRec( oWndBrw:oBrw, D():FacturasProveedores( nView ), {|| QuiFacPrv() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, D():FacturasProveedores( nView ), cCodPrv, cCodArt, cNumAlb ) )}, nil, nLevel, "gc_document_text_businessman_16", ( ( 0 + ( 114 * 256 ) + ( 198 * 65536 ) ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, D():FacturasProveedores( nView ) ) )}, .T. )

      oWndBrw:lFechado     := .T.

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->lCloFac }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "gc_lock2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "gc_mail2_12", "Nil16" } )
         :AddResource( "gc_mail2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pagado"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| ChkPagFacPrv( D():FacturasProveedores( nView ), D():FacturasProveedoresPagos( nView ) ) }
         :nWidth           := 20
         :AddResource( "gc_check_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_money2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Contabilizado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->lContab }
         :nWidth           := 20
         :SetCheck( { "gc_folder2_12", "Nil16" } )
         :AddResource( "gc_folder2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_check_12" )
         :AddResource( "gc_document_information_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Rectificada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| lRectificadaPrv( ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac, D():FacturasProveedores( nView ), D():FacturasRectificativasProveedores( nView ) ) }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "gc_document_text_delete2_12", "Nil16" } )
         :AddResource( "gc_document_text_delete2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Impreso"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "gc_printer2_12", "Nil16" } )
         :AddResource( "gc_printer2_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cSerFac + "/" + Alltrim( Str( ( D():FacturasProveedores( nView ) )->nNumFac ) )  }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cSufFac  }
         :nWidth           := 20
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Su factura"
         :cSortOrder       := "cSuPed"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cSuPed }
         :nWidth           := 80
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "NFC"
         :cSortOrder       := "cNfc"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cNFC }
         :nWidth           := 160
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| Trans( ( D():FacturasProveedores( nView ) )->cTurFac, "######" ) }
         :nWidth           := 60
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número documento"
         :cSortOrder       := "cNumDoc"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cNumDoc }
         :nWidth           := 80
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dDesFec"
         :bEditValue       := {|| Dtoc( ( D():FacturasProveedores( nView ) )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Hora"
         :bEditValue       := {|| trans( ( D():FacturasProveedores( nView ) )->tFecFac, "@R 99:99:99") }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cCodPrv }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomPrv"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cNomPrv }
         :nWidth           := 260
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pago"
         :cSortOrder       := "cCodPago"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cCodPago }
         :nWidth           := 40
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->nTotNet }
         :cEditPicture     := cPirDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->nTotIva }
         :cEditPicture     := cPirDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->nTotReq }
         :cEditPicture     := cPirDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->nTotFac }
         :cEditPicture     := cPirDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( D():FacturasProveedores( nView ) )->cDivFac ), D():Divisas( nView ) ) }
         :nWidth           := 30
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Centro de coste"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cCtrCoste }
         :nWidth           := 30
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Creación/Modificación"
         :bEditValue       := {|| dtoc( ( D():FacturasProveedores( nView ) )->dFecChg ) + space( 1 ) + ( D():FacturasProveedores( nView ) )->cTimChg }
         :nWidth           := 120
         :lHide            := .T.
      end

      oDetCamposExtra:addCamposExtra( oWndBrw )

      oWndBrw:lAutoSeek    := .F.
      oWndBrw:cHtmlHelp    := "Factura de proveedor"

      oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()








   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",,, 2,, .F. )







   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )







   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )







   oDel := oWndBrw:NewAt( "DEL",,, {||( oWndBrw:RecDel() )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )







   oImp := oWndBrw:NewAt( "IMP",,, {||( nGenFacPrv( 1 ) )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oImp, 1 )





   oWndBrw:NewAt( "GC_PRINTER2_",,, {||( ImprimirSeriesFacturasProveedores() )}, "Imp(r)imir series", "R",,, 32,, .F. )







   oPrv := oWndBrw:NewAt( "PREV1",,, {||( nGenFacPrv( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oPrv, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( nGenFacPrv( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oPdf, 3 )





   oMail := oWndBrw:NewAt( "GC_MAIL_EARTH_",,, {||( oMailing:documentsDialog( oWndBrw:oBrw:aSelected ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )






   oWndBrw:NewAt( "gc_portable_barcode_scanner_",,, {||( TLabelGeneratorFacturaProveedores():New( nView, oNewImp ):Dialog() )}, "Eti(q)uetas", "Q",,, 32,, .F. )





   oLiq := oWndBrw:NewAt( "gc_money2_",,, {||( lLiquida( oWndBrw:oBrw ) )}, "Pagar",,,, 4,, .F. )







      oWndBrw:NewAt( "gc_money2_",,, {||( aGetSelRec( oWndBrw, {|| lLiquida( oWndBrw:oBrw, ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac ) }, "Liquidar series de facturas", .T., nil, .T., nil ) )}, "Pagar series",,,, 4, oLiq, .F. )






   oWndBrw:NewAt( "BmpConta",,, {||( aGetSelRec( oWndBrw, {|lChk1, lChk2, oTree| actionContabilidad( lChk1, lChk2, oTree ) }, "Contabilizar facturas", lHideCheck1Contabilidad(), "Simular resultados", lHideCheck2Contabilidad(), "Contabilizar recibos", , {|| postActionContabilidad() } ) )}, "(C)ontabilizar", "C",,, 4,, .F. )

   if RolesModel():getRolCambiarEstado( Auth():rolUuid() )






   oWndBrw:NewAt( "ChgState",,, {||( aGetSelRec( oWndBrw, {|lChk1| lCntFacPrv( lChk1, D():FacturasProveedores( nView ) ) }, "Cambiar estado", .F., "Contabilizado", .T., "" ) )}, "Cambiar Es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "Lbl",, "Seleccionar facturas para ser enviados", {||lSnd( oWndBrw, D():FacturasProveedores( nView ) )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )





   oBtnEur := oWndBrw:NewAt( "gc_currency_euro_",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )






   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "03", ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac ) )}, "I(n)forme documento", "N",,, 4,, .F. )




   oWndBrw:NewAt( "gc_document_text_pencil_",,, {||( Counter:OpenDialog() )}, "Establecer contadores",,,,,, .F. )

   if RolesModel():getRolCambiarCampos( Auth():rolUuid() )






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():FacturasProveedores( nView ), aItmFacPrv() ) )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():FacturasProveedoresLineas( nView ), aColFacPrv() ) )}, "Líneas",,,, 4, oRpl, .F. )

   end





   oScript := oWndBrw:NewAt( "gc_folder_document_",,, {||( oScript:Expand() )}, "Scripts",,,,,, .F. )
      ImportScript( oWndBrw, oScript, "FacturasProveedores", nView, oStock )




   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,,, 4,, .F. )





      oWndBrw:NewAt( "gc_businessman_",,, {||( EdtPrv( ( D():FacturasProveedores( nView ) )->cCodPrv ) )}, "Modificar proveedor",,,, 4, oRotor, .F. )





      oWndBrw:NewAt( "INFO",,, {||( InfProveedor( ( D():FacturasProveedores( nView ) )->cCodPrv ) )}, "Informe proveedor",,,, 4, oRotor, .F. )





      oWndBrw:NewAt( "gc_document_empty_businessman_",,, {||( if( !empty( ( D():FacturasProveedores( nView ) )->cNumAlb ), ZooAlbPrv( ( D():FacturasProveedores( nView ) )->cNumAlb ), MsgStop( "La factura no proviene de un albarán" ) ) )}, "Visualizar albarán",,,, 4, oRotor, .F. )






      oWndBrw:NewAt( "gc_briefcase2_businessman_",,, {||( RecPrv( , , { ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac } ) )}, "Modificar recibo",,,, 4, oRotor, .T. )






      oWndBrw:NewAt( "GC_DOCUMENT_TEXT_BUSINESSMAN_",,, {||( FactCli( nil, nil, { "Factura" => ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac } ) )}, "Generar factura",,,, 2, oRotor, .T. )





   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .T. )

   oWndBrw:oActiveFilter:SetFields( aItmFacPrv() )
   oWndBrw:oActiveFilter:SetFilterType( "03" )

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp, .F. )

   EnableAcceso()

   if !empty( oWndBrw )

      if uFieldempresa( "lFltYea" )
         oWndBrw:setYearCombobox()
      end

      if !empty( cCodPrv ) .OR. !empty( cCodArt ) .OR. !empty( cNumAlb )
         oWndBrw:RecAdd()
      end

      cCodPrv  := nil
      cCodArt  := nil
      cNumAlb  := nil

   end



   setScriptSystem()

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbf, oBrw, cCodPrv, cCodArt, nMode, cNumAlb )

   local n
   local oDlg
   local oFld
   local oBtnOk
   local oBrwLin
   local oBrwPgo
   local oBrwInc
   local oBrwDoc
   local cGetRet
   local oGet        := Array( 7 )
   local cGet        := Array( 7 )
   local oSayLabels  := Array( 7 )
   local cTlfPrv
   local oTlfPrv
   local oBmpDiv
   local oBmpEmp
   local nOrd        := ( D():FacturasProveedores( nView ) )->( ordSetFocus( 1 ) )
   local aControl    := Array( 6 )
   local oSayGas     := Array( 16 )
   local oBmpGeneral

   cTlfPrv           := RetFld( aTmp[ 6 ], D():Proveedores( nView ), "Telefono" )
   cUsr              := UsuariosModel():getNombreWhereCodigo( aTmp[ 47 ] )

   do case
   case nMode == 1

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 1 ]     := cNewSer( "nFacPrv", D():Contadores( nView ) )
      aTmp[ 3 ]     := RetSufEmp()
      aTmp[ 4 ]     := cCurSesion()
      aTmp[ 36 ]     := cDivEmp()
      aTmp[ 37 ]     := nChgDiv( aTmp[ 36 ], D():Divisas( nView ) )
      aTmp[ 7 ]     := Application():codigoAlmacen()
      aTmp[ 8 ]     := Application():CodigoCaja()
      aTmp[ 38 ]     := .T.
      aTmp[ 43 ]     := cProCnt()
      aTmp[ 47 ]     := Auth():Codigo()
      aTmp[ 55 ]     := Application():CodigoDelegacion()
      aTmp[ 17 ]     := Ctod( "" )
      aTmp[ 49 ]     := Ctod( "" )
      aTmp[ 83 ]     := getSysTime()

      if !empty( cCodPrv )
         aTmp[ 6 ]  := cCodPrv
      end

      if !empty( cNumAlb )
         aTmp[ 26 ]  := cNumAlb
      end

   case nMode == 4

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 8 ]  := Application():CodigoCaja()
      aTmp[ 38 ]  := .T.
      aTmp[ 17 ]  := Ctod( "" )
      aTmp[ 49 ]  := Ctod( "" )
      aTmp[ 45 ]  := .F.
      aTmp[ 16 ]  := .F.
      aTmp[ 72    ]  := Space( 20 )
      aTmp[ 47 ]     := Auth():Codigo()

   case nMode == 2

      if aTmp[ 16 ] .AND. !ApoloMsgNoYes( "La modificación de esta factura puede provocar descuadres contables." + Chr(13)+Chr(10) + "¿ Desea continuar ?", "Factura ya contabilizada" )
         return .F.
      end

      if aTmp[ 44 ]
         MsgStop( "El documento ha sido recibido por internet", "Imposible modificar" )
         return .F.
      end

      if aTmp[ 45 ] .AND. !oUser():lAdministrador()
         msgStop( "Solo puede modificar los facturas cerradas los administradores." )
         return .F.
      end

   end

   if empty( aTmp[ 29 ] )
      aTmp[ 29 ]  := Padr( "General", 50 )
   end

   if empty( aTmp[ 31 ] )
      aTmp[ 31 ]     := Padr( "Pronto pago", 50 )
   end





   if BeginTrans( aTmp, nMode )
      Return .F.
   end





   cOldCodCli           := aTmp[ 6 ]

   cPicUnd              := MasUnd()
   cPinDiv              := cPinDiv( aTmp[ 36 ], D():Divisas( nView ) )
   cPirDiv              := cPirDiv( aTmp[ 36 ], D():Divisas( nView ) )
   nDinDiv              := nDinDiv( aTmp[ 36 ], D():Divisas( nView ) )
   nRinDiv              := nRinDiv( aTmp[ 36 ], D():Divisas( nView ) )
   cPouDiv              := cPouDiv( aTmp[ 36 ], D():Divisas( nView ) )
   cPorDiv              := cPorDiv( aTmp[ 36 ], D():Divisas( nView ) )





   cGet[ 1 ]            := RetFld( aTmp[ 7 ], D():Almacen( nView ) )
   cGet[ 2 ]            := RetFld( aTmp[ 6 ], D():Proveedores( nView ) )
   cGet[ 3 ]            := RetFld( aTmp[ 23], D():FormasPago( nView ) )
   cGet[ 5 ]            := RetFld( aTmp[ 8 ], D():Cajas( nView ) )
   cGet[ 6 ]            := RetFld( cCodEmp() + aTmp[ 55 ], D():Delegaciones( nView ), "cNomDlg" )
   cGet[ 7 ]            := RetFld( aTmp[ 85 ], D():Almacen( nView ) )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "facturas a proveedores", "PEDPRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )











      oFld := TFolder():ReDefine( 400, {"&Factura", "Da&tos", "&Incidencias", "D&ocumentos"}, { "FACPRV_1","FACPRV_2","PEDCLI_3","PEDCLI_4" }, oDlg,,,,, .F., )





      aGet[ 72 ] := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, aTmp[ 72 ], aTmp[ 72 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      oBmpGeneral := TBitmap():ReDefine( 990, "gc_document_text_businessman_48",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_folders2_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_information_48",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_address_book_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )








      aGet[ 6 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, ( RetPicCodPrvEmp() ), {||    ( loaPrv( aGet, aTmp, D():Proveedores( nView ), nMode, oGet[ 2 ], oTlfPrv ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProvee( aGet[ 6 ], oGet[ 2 ] ) )}, nil, "LUPA",, )





      aGet[ 9 ] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 14 ] := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oTlfPrv := TGetHlp():ReDefine( 107, { | u | If( PCount()==0, cTlfPrv, cTlfPrv:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ 10 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 10 ], Rtrim( aTmp[ 11 ] ) + Space( 1 ) + Rtrim( aTmp[ 12 ] ) )}, nil, "gc_earth_lupa_16",, )





      aGet[ 11 ] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 12 ] := TGetHlp():ReDefine( 108, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 13 ] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],,, {||    ( CodigosPostales():GetInstance():validCodigoPostal() )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ 7 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],,, {||    cAlmacen( aGet[7], , oGet[ 1 ] )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|brwAlmacen( aGet[ 7 ], oGet[ 1 ] )}, nil, "LUPA",, )






      oGet[1] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cGet[1], cGet[1]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ExpAlmacen( aTmp[ 7 ], dbfTmp, oBrwLin ) )}, nil, "Bot",, )









      aGet[ 85 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 85 ], aTmp[ 85 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[ 85 ], , oGet[ 7 ] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 85 ], oGet[ 7 ] ) )}, nil, "LUPA", 342, )






      oGet[ 7 ] := TGetHlp():ReDefine( 341, { | u | If( PCount()==0, cGet[ 7 ], cGet[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ExpAlmacenOrigen( aTmp[ 85 ], dbfTmp, oBrwLin ) )}, nil, "Bot",, )









      aGet[ 23 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    cFPago( aGet[ 23 ], D():FormasPago( nView ), oGet[3] )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,, {|Self|BrwFPago( aGet[ 23 ], oGet[3] )}, nil, "LUPA",, )





      oGet[3] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cGet[3], cGet[3]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 75 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 75 ], aTmp[ 75 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,, {|Self|( BrwBncPrv( aGet[ 75 ], aGet[ 76 ], aGet[ 77 ], aGet[ 78 ], aGet[ 79 ], aGet[ 80 ], aGet[ 81 ], aTmp[ 6 ] ) )}, nil, "LUPA",, )






      aGet[ 76 ] := TGetHlp():ReDefine( 305, { | u | If( PCount()==0, aTmp[ 76 ], aTmp[ 76 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( lIbanDigit( aTmp[ 76 ], aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aTmp[ 81 ], aGet[ 77 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 77 ] := TGetHlp():ReDefine( 306, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lIbanDigit( aTmp[ 76 ], aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aTmp[ 81 ], aGet[ 77 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 78 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aTmp[ 81 ], aGet[ 80 ], aTmp[ 76 ] ), aGet[ 76 ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 79 ] := TGetHlp():ReDefine( 302, { | u | If( PCount()==0, aTmp[ 79 ], aTmp[ 79 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aTmp[ 81 ], aGet[ 80 ], aTmp[ 76 ] ), aGet[ 76 ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 80 ] := TGetHlp():ReDefine( 303, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aTmp[ 81 ], aGet[ 80 ], aTmp[ 76 ] ), aGet[ 76 ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 81 ] := TGetHlp():ReDefine( 304, { | u | If( PCount()==0, aTmp[ 81 ], aTmp[ 81 ]:= u ) }, oFld:aDialogs[1],, "9999999999", {||    (  lCalcDC( aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aTmp[ 81 ], aGet[ 80 ], aTmp[ 76 ] ), aGet[ 76 ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )












      aGet[ 8 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,, {||    cCajas( aGet[ 8 ], D():Cajas( nView ), oGet[ 5 ] )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 8 ], oGet[ 5 ] ) )}, nil, "LUPA",, )




      oGet[ 5 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cGet[ 5 ], cGet[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 82 ] := TCheckBox():ReDefine( 195, { | u | If( PCount()==0, aTmp[ 82 ], aTmp[ 82 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||     ( nMode <> 3 )}, .F. )












      aGet[ 36 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivIn( aGet[ 36 ], oBmpDiv, aGet[ 37 ], @cPinDiv, @nDinDiv, @cPirDiv, @nRinDiv, nil, D():Divisas( nView ), oBandera ) )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 36 ], oBmpDiv, aGet[ 37 ], D():Divisas( nView ), oBandera )}, nil, "LUPA",, )




      oBmpDiv := TBitmap():ReDefine( 171, "BAN_EURO",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )





      aGet[ 37 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 37 ], aTmp[ 37 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.9999",,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgFacPrv.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )









      aControl[1] := TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      aControl[2] := TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo )  )},,, .F. )





      aControl[3] := TButton():ReDefine( 502, {||( WinDelRec( oBrwLin, dbfTmp, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )




      aControl[4] := TButton():ReDefine( 503, {||( if( !( dbfTmp )->lControl, WinZooRec( oBrwLin, bEdtDet, dbfTmp, aTmp ), ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





      TButton():ReDefine( 512, {||( GrpAlb( aGet[ 6 ], aTmp, oBrwLin ), RecalculaTotal( aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      aControl[5] := TButton():ReDefine( 524, {||( LineUp( dbfTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      aControl[6] := TButton():ReDefine( 525, {||( LineDown( dbfTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwLin:cAlias          := dbfTmp

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:lFooter         := .T.
      oBrwLin:cName           := "Lineas de facturas a proveedor"

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Cm. Cambio"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmp )->lChgLin }
            :nWidth           := 20
            :lHide            := .T.
            :SetCheck( { "Sel16", "Nil16" } )
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Número"
            :bEditValue       := {|| if( ( dbfTmp )->lKitChl, "", Trans( ( dbfTmp )->nNumLin, "@Z 9999" ) ) }
            :nWidth           := 65
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader             := "Posición"
            :cSortOrder          := "nPosPrint"
            :bEditValue          := {|| ( dbfTmp )->nPosPrint }
            :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | if( !empty( oCol ), oCol:SetOrder(), ) }
            :cEditPicture        := "9999"
            :nWidth              := 60
            :nDataStrAlign       := 1
            :nHeadStrAlign       := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmp )->cRef }
            :nWidth           := 80
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "C. Barras"
            :bEditValue       := {|| cCodigoBarrasDefecto( ( dbfTmp )->cRef, D():ArticulosCodigosBarras( nView ) ) }
            :nWidth           := 100
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Código proveedor"
            :bEditValue       := {|| ( dbfTmp )->cRefPrv }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| if( empty( ( dbfTmp )->cRef ) .AND. !( dbfTmp )->lControl, ( dbfTmp )->mLngDes, ( dbfTmp )->cDetalle ) }
            :nWidth           := 286
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Prop. 1"
            :bEditValue       := {|| ( dbfTmp )->cValPr1 }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Valor prop. 1"
            :bEditValue       := {|| nombrePropiedad( ( dbfTmp )->cCodPr1, ( dbfTmp )->cValPr1, nView ) }
            :nWidth           := 40
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Prop. 2"
            :bEditValue       := {|| ( dbfTmp )->cValPr2 }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Valor prop. 2"
            :bEditValue       := {|| nombrePropiedad( ( dbfTmp )->cCodPr2, ( dbfTmp )->cValPr2, nView ) }
            :nWidth           := 40
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Lote"
            :bEditValue       := {|| ( dbfTmp )->cLote }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Caducidad"
            :bEditValue       := {|| ( dbfTmp )->dFecCad }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Bultos"
            :bEditValue       := {|| ( dbfTmp )->nBultos }
            :cEditPicture     := cPicUnd
            :nWidth           := 60
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nFooterType      := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := cNombreCajas()
            :bEditValue       := {|| ( dbfTmp )->nCanEnt }
            :cEditPicture     := cPicUnd
            :nWidth           := 60
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nFooterType      := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := cNombreUnidades()
            :bEditValue       := {|| nTotNFacPrv( dbfTmp ) }
            :cEditPicture     := cPicUnd
            :nWidth           := 60
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nFooterType      := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "UM. Unidad de medición"
            :bEditValue       := {|| ( dbfTmp )->cUnidad }
            :nWidth           := 25
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Almacén destino"
            :bEditValue       := {|| ( dbfTmp )->cAlmLin }
            :nWidth           := 65
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Almacén origen"
            :bEditValue       := {|| ( dbfTmp )->cAlmOrigen }
            :nWidth           := 65
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| nTotUFacPrv( dbfTmp, nDinDiv ) }
            :cEditPicture     := cPinDiv
            :nWidth           := 90
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% Dto."
            :bEditValue       := {|| ( dbfTmp )->nDtoLin }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% Prm."
            :bEditValue       := {|| ( dbfTmp )->nDtoPrm }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 40
            :lHide            := .T.
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% " + cImp()
            :bEditValue       := {|| ( dbfTmp )->nIva }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Total"
            :bEditValue       := {|| nTotLFacPrv( dbfTmp, nDinDiv, nRinDiv ) }
            :cEditPicture     := cPirDiv
            :nWidth           := 90
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nFooterType      := 1
         end

         with object ( oBrwLin:addCol() )
            :cHeader       := "P. Venta 1"
            :bEditValue    := {|| ArticulosModel():getField( "pVenta1", "Codigo", ( dbfTmp )->cRef ) }
            :cEditPicture  := cPirDiv
            :nWidth        := 100
            :nDataStrAlign := 1
            :nHeadStrAlign := 1
            :lHide         := .T.
         end

         with object ( oBrwLin:addCol() )
            :cHeader       := "Total venta"
            :bEditValue    := {|| ( nTotNAlbPrv( dbfTmp ) * ArticulosModel():getField( "pVenta1", "Codigo", ( dbfTmp )->cRef ) ) }
            :cEditPicture  := cPirDiv
            :nWidth        := 100
            :nDataStrAlign := 1
            :nHeadStrAlign := 1
            :nFooterType   := 1
            :lHide         := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Centro de coste"
            :bEditValue       := {|| ( dbfTmp )->cCtrCoste }
            :nWidth           := 20
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Ref. Albarán"
            :bEditValue       := {|| ( dbfTmp )->iNumAlb }
            :nWidth           := 100
            :lHide            := .T.
         end

         if nMode <> 3
            oBrwLin:bLDblClick   := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
         end

      oBrwLin:CreateFromResource( 190 )









      aGet[ 58 ] := TMultiGet():ReDefine( 290, { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[1],, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, .F.,, )











       aGet[ 59 ] := TGetHlp():ReDefine( 600, { | u | If( PCount()==0, aTmp[ 59 ], aTmp[ 59 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








       aGet[ 62 ] := TGetHlp():ReDefine( 601, { | u | If( PCount()==0, aTmp[ 62 ], aTmp[ 62 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[11] := TSay():ReDefine( 602, {|| Trans( aTmp[ 59 ] * aTmp[ 62 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )








      aGet[ 65 ] := TGetHlp():ReDefine( 603, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 33 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[12] := TSay():ReDefine( 604, {|| Trans( aTmp[ 59 ] * aTmp[ 65 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )











      aGet[ 60 ] := TGetHlp():ReDefine( 610, { | u | If( PCount()==0, aTmp[ 60 ], aTmp[ 60 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 63 ] := TGetHlp():ReDefine( 611, { | u | If( PCount()==0, aTmp[ 63 ], aTmp[ 63 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[13] := TSay():ReDefine( 612, {|| Trans( aTmp[ 60 ] * aTmp[ 63 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )








      aGet[ 66 ] := TGetHlp():ReDefine( 613, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 33 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[14] := TSay():ReDefine( 614, {|| Trans( aTmp[ 60 ] * aTmp[ 66 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )











      aGet[ 61 ] := TGetHlp():ReDefine( 620, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 64 ] := TGetHlp():ReDefine( 621, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[15] := TSay():ReDefine( 622, {|| Trans( aTmp[ 61 ] * aTmp[ 64 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )








      aGet[ 67 ] := TGetHlp():ReDefine( 623, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 33 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[16] := TSay():ReDefine( 624, {|| Trans( aTmp[ 61 ] * aTmp[ 67 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )









      aGet[ 29 ] := TGetHlp():ReDefine( 199, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )







      aGet[ 30 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 31 ] := TGetHlp():ReDefine( 209, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )







      aGet[ 32 ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 39 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 40 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 41 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[1],, "@!",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 42 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oBrwIva                        := IXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva )

      oBrwIva:lHScroll               := .F.
      oBrwIva:lVScroll               := .F.
      oBrwIva:nMarqueeStyle          := 5
      oBrwIva:lRecordSelector        := .F.

      oBrwIva:CreateFromResource( 490 )

      with object ( oBrwIva:AddCol() )
         :cHeader          := "Base"
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hGet( aTotIva[ oBrwIva:nArrayAt ], "neto" ) <> 0 .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "neto" ) <> 0 ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "neto" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "%" + cImp()
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) <> nil ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ), "@E 999.99" ), "" ), "" ) }
         :bEditValue       := {|| hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) }
         :nWidth           := 44
         :cEditPicture     := "@E 999.99"
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFootStrAlign    := 1



      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := cImp()
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "impiva" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "impiva" ) <> nil ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "impiva" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "% R.E."
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ) <> nil .AND. aTmp[ 33 ] ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ), cPicReq() ), "" ), "" ) }
         :nWidth           := 44
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "R.E."
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "impre" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "impre" ) <> nil .AND. aTmp[ 33 ] ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "impre" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end








      oGetNet := TSay():ReDefine( 370, {|| nGetNeto}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetIva := TSay():ReDefine( 380, {|| nGetIva}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetReq := TSay():ReDefine( 390, {|| nGetReq}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetIvm := TSay():ReDefine( 403, {|| nTotIvm}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      aGet[ 33 ] := TCheckBox():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||     ( nMode <> 3 )}, .F. )




      oGetTotal := TSay():ReDefine( 410, {|| nTotFac}, oFld:aDialogs[1],,,, .F., oFntTot, .F., .F., )









      aGet[ 1 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[ 1 ] >= "A" .AND. aTmp[ 1 ] <= "Z"  )},,,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[ 1 ] ) )}, {||  ( DwSerie( aGet[ 1 ] ) )},,,, nil,,, )

         aGet[ 1 ]:bLostFocus := {|| aGet[ 43 ]:cText( cProCnt( aTmp[ 1 ] ) ) }





      aGet[2] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      aGet[3] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      aGet[5] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 83 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 83 ], aTmp[ 83 ]:= u ) }, oFld:aDialogs[1],, "@R 99:99:99", {||    ( iif(   !validTime( aTmp[ 83 ] ), ( msgStop( "El formato de la hora no es correcto" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 18 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[1],,, {||    ( ValidaSuFactura( aGet ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 26 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[1],, "@R A/#########/##", {||    ( cAlbPrv( aGet, oBrwLin, nMode, aTmp ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|( brwAlbPrv( aGet[ 26 ], D():AlbaranesProveedores( nView ), D():AlbaranesProveedoresLineas( nView ), D():TiposIva( nView ), D():Divisas( nView ) ) )}, nil, "LUPA",, )






      aGet[ 57 ] := TCheckBox():ReDefine( 550, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oFld:aDialogs[1],, {||( ShowKitFacPrv( D():FacturasProveedores( nView ), oBrwLin, cCodPrv, nil, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva ), RecalculaTotal( aTmp ), .T. )},,,,, .F., {||     ( nMode == 1 )}, .F. )







      aGet[ 51 ] := TComboBox():ReDefine( 440, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, { "Ret. S/Base", "Ret. S/Total" }, oFld:aDialogs[ 1 ],, {||    ( RecalculaTotal( aTmp ) )}, {|Self|( RecalculaTotal( aTmp ) )},,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 51 ]",,,,,,, )








      aGet[ 52 ] := TGetHlp():ReDefine( 450, { | u | If( PCount()==0, aTmp[ 52 ], aTmp[ 52 ]:= u ) }, oFld:aDialogs[ 1 ],, "@E 99.9", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )



      oGetRet := TSay():ReDefine( 491, {|| cGetRet}, oFld:aDialogs[1],,,, .F.,, .F., .F., )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 701,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 3 ] := TSay():ReDefine( 702,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 4 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 5 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 6 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 7 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )

      oSayGas[ 1 ] := TSay():ReDefine( 707,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 2 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 3 ] := TSay():ReDefine( 709,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 4 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 5 ] := TSay():ReDefine( 711,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 6 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 7 ] := TSay():ReDefine( 713,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 8 ] := TSay():ReDefine( 714,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 9 ] := TSay():ReDefine( 715,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 10] := TSay():ReDefine( 716,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )





      aGet[ 47 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[2],,, {||       ( oUsr:cText( UsuariosModel():getNombreWhereCodigo( aTmp[ 47 ] ) ), .T.  )},,,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )




      oUsr := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, cUsr, cUsr:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )










      aGet[ 17 ] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 46 ] := TGetHlp():ReDefine( 142, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 56 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[2],, { 270, 271, 272, 273 },,,,, .F., {||     ( nMode <> 3 )}, )




      aGet[ 55 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oGet[ 6 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cGet[ 6 ], cGet[ 6 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[ 84 ] := TGetHlp():ReDefine( 510, { | u | If( PCount()==0, aTmp[ 84 ], aTmp[ 84 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oCentroCoste:Existe( aGet[ 84 ], aGet[ 84 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 84 ] ) )}, nil, "LUPA",, 511 )









      aGet[ 73 ] := TGetHlp():ReDefine( 370, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[ 2 ],, ( Replicate( "X", nLenSubcuentaContaplus() ) ), {||    ( MkSubcuenta( aGet[ 73 ], nil, aGet[ 73 ]:oHelpText ) )},,,,,, .F., {||     ( aTmp[ 57 ] .AND. nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkSubcuenta( aGet[ 73 ], aGet[ 73 ]:oHelpText ) )}, nil, "Lupa",, 371 )









      aGet[ 43 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[2],, "@R ###.######", {||    ( ChkProyecto( aTmp[ 43 ], oGet[ 4 ] ), .T. )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProyecto( aGet[ 43 ], oGet[ 4 ] ) )}, nil, "Lupa",, )




      oGet[ 4 ] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, cGet[ 4 ], cGet[ 4 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      aGet[ 24 ] := TGetHlp():ReDefine( 132, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[2],, "999999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )










      aGet[ 20 ] := TMultiGet():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      oBrwPgo                 := IXBrowse():New( oFld:aDialogs[2] )

      oBrwPgo:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwPgo:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwPgo:cAlias          := dbfTmpPgo
      oBrwPgo:cName           := "Pagos de facturas a proveedor"

      oBrwPgo:nMarqueeStyle   := 6

      oBrwPgo:CreateFromResource( 220 )

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Pg. Pagado"
            :bStrData         := {|| "" }
            :bBmpData         := {|| nEstadoReciboProveedor( dbfTmpPgo ) }
            :nWidth           := 22
            :AddResource( "Cnt16" )
            :AddResource( "Sel16" )
            :AddResource( "gc_undo_16" )
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Cn. Contabilizado"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpPgo )->lConPgo }
            :nWidth           := 22
            :SetCheck( { "Sel16", "Nil16" } )
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Sesión"
            :bEditValue       := {|| Trans( ( dbfTmpPgo )->cTurRec, "######" ) }
            :nWidth           := 40
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dPreCob ) }
            :nWidth           := 75
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Vencimiento"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dFecVto ) }
            :lHide            := .T.
            :nWidth           := 70
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Cobro"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dEntrada ) }
            :nWidth           := 75
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpPgo )->cDescrip }
            :nWidth           := 180
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| nTotRecPrv( dbfTmpPgo, D():Divisas( nView ), nil, .T. ) }
            :nWidth           := 85
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Divisa"
            :bEditValue       := {|| cSimDiv( ( dbfTmpPgo )->cDivPgo, D():Divisas( nView ) ) }
            :nWidth           := 55
         end

         if nMode <> 3
            oBrwPgo:bLDblClick   := {|| ExtEdtRecPrv( dbfTmpPgo, nView, ,oCentroCoste ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) }
         end





      TButton():ReDefine( 501, {||( ExtEdtRecPrv( dbfTmpPgo, nView, ,oCentroCoste ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 502, {||( ExtDelRecPrv( dbfTmpPgo ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 505, {||( PrnRecPrv( ( dbfTmpPgo )->cSerFac + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ), .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 506, {||( VisRecPrv( ( dbfTmpPgo )->cSerFac + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ), .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )



      oGetTotPg := TSay():ReDefine( 405, {|| nTotFac}, oFld:aDialogs[2],,,, .F.,, .F., .F., )



      oGetPgd := TSay():ReDefine( 400, {|| nGetPgd}, oFld:aDialogs[2],,,, .F.,, .F., .F., )



      oGetPdt := TSay():ReDefine( 410, {|| ( nTotFac - nGetPgd )}, oFld:aDialogs[2],,,, .F.,, .F., .F., )






      aGet[ 48 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 49 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 50 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 5
      oBrwInc:cName           := "Incidencias de albaranes a proveedor"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 60
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 410
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )





      oBrwDoc                 := IXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 5
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

         with object ( oBrwDoc:AddCol() )
            :cHeader          := "Documento"
            :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
            :nWidth           := 885
         end

         if nMode <> 3
            oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
         end

         oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .F. ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )





      TButton():ReDefine( 4, {||( RecalculaFacturaProveedores( aTmp, oDlg ), ( oBrwLin:Refresh() ), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      oBtnOk := TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 3, {||( if( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg ), GenFacPrv( 1 ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( If( ExitNoSave( nMode, dbfTmp ), ( oDlg:end() ), ) )}, oDlg,,, .F.,,,, .T. )

   CodigosPostales():GetInstance():setBinding( { "CodigoPostal" => aGet[ 13 ], "Poblacion" => aGet[ 11 ], "Provincia" => aGet[ 12 ] } )

   if nMode <> 3
      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| WinDelRec( oBrwLin, dbfTmp, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) } )

      oFld:aDialogs[2]:AddFastKey( 114, {|| ExtEdtRecPrv( dbfTmpPgo, nView ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) } )
      oFld:aDialogs[2]:AddFastKey( 115, {|| ExtDelRecPrv( dbfTmpPgo ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .F. ) } )

      oDlg:AddFastKey( 116,             {|| EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg ) } )
      oDlg:AddFastKey( 117,             {|| if( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg ), GenFacPrv( 1 ), ) } )
      oDlg:AddFastKey( 120,             {|| oDetCamposExtra:Play( Space(1) ) } )
      oDlg:AddFastKey( 65,                {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )
   end

   oDlg:AddFastKey ( 112, {|| GoHelp() } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 47 ] ), , oDlg:end() ) }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 47 ] ), AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt ), oDlg:end() ) }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt ) }

      otherwise
         oDlg:bStart := {|| StartEdtRecFacProv( aGet, oGet, nMode ) }

   end




   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|( RecalculaTotal( aTmp ) )}, .T.,,, {|Self|( InitDialog( cNumAlb, aGet, aTmp, oDlg, oBrwLin, cCodPrv, oBrwPgo, oBrwInc, dbfTmpInc, aControl, oSayGas, oSayLabels, oBrwIva ) )}, oDlg:bRClicked,,, )

   oBmpEmp:End()
   oBmpGeneral:End()





   if oDlg:nResult <> 1
      for each cNumAlb in aNumAlb:Get()
         if ( D():AlbaranesProveedores( nView ) )->( dbSeek( cNumAlb ) )
            setFacturadoAlbaranProveedorCabecera( .F., nView )
         end
      next
   end

   ( D():FacturasProveedores( nView ) )->( OrdSetFocus( nOrd ) )





   ChkLqdFacPrv( nil, nView )





   KillTrans( oBrwLin )

RETURN ( oDlg:nResult == 1 )



Static Function StartEdtRecFacProv( aGet, oGet, nMode )

   if uFieldEmpresa( "lShowOrg" )
      aGet[ 85 ]:Show()
      oGet[7]:Show()
   else
      aGet[ 85 ]:Hide()
      oGet[7]:Hide()
   end

   if nMode <> 1

      if !empty( aGet[ 84 ] )
         aGet[ 84 ]:lValid()
      endif

   endif


Return ( .T. )



Static Function EdtRecMenu( aTmp, oDlg )

   oMnuRec := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

            if !lExternal





            MenuAddItem( "&1. Campos extra [F9]", "Mostramos y rellenamos los campos extra para la familia", .F.,, {|oMenuItem|( oDetCamposExtra:Play( space(1) ) )},, "gc_form_plus2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&2. Visualizar albarán", "Visualiza el albarán del que proviene", .F.,, {|oMenuItem|( if( !empty( ( D():FacturasProveedores( nView ) )->cNumAlb ), ZooAlbPrv( ( D():FacturasProveedores( nView ) )->cNumAlb ), MsgStop( "La factura no proviene de un albarán" ) ))},, "gc_document_empty_businessman_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

            MenuAddItem(,,,,,,,,,,,,,,,,,.T.,,,,,,,,,,,,,,,,,)




            MenuAddItem( "&3. Modificar proveedor", "Modificar la ficha del proveedor", .F.,, {|oMenuItem|( EdtPrv( aTmp[ 6 ] ) )},, "gc_businessman_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&4. Informe de proveedor", "Abrir el informe del proveedor", .F.,, {|oMenuItem|( InfProveedor( aTmp[ 6 ] ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )
            MenuAddItem(,,,,,,,,,,,,,,,,,.T.,,,,,,,,,,,,,,,,,)

            end




            MenuAddItem( "&5. Informe del documento", "Abrir el informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "03", ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMnuRec )

Return ( oMnuRec )



Static Function InitDialog( cNumAlb, aGet, aTmp, oDlg, oBrwLin, cCodPrv, oBrwPgo, oBrwInc, dbfTmpInc, aControl, oSayGas, oSayLabels, oBrwIva )

   if !empty( cNumAlb )
      aGet[ 26 ]:lValid()
   endif

   EdtRecMenu( aTmp, oDlg )

   oBrwLin:MakeTotals()

   ShowKitFacPrv( D():FacturasProveedores( nView ), oBrwLin, cCodPrv, dbfTmpInc, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva )

   oBrwLin:Load()
   oBrwPgo:Load()
   oBrwInc:Load()

return( .T. )



Static Function RecalculaFacturaProveedores( aTmp, oDlg )

   local nRecNum
   local nPreCom




   if !ApoloMsgNoYes( "¡Atención!,"                                  + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿ Desea proceder ?" )
      return nil
   end

   oDlg:Disable()

   ( D():Articulos( nView ) )->( ordSetFocus( "Codigo" ) )

   nRecNum                          := ( dbfTmp )->( RecNo() )

   ( dbfTmp )->( dbGotop() )
   while !( dbfTmp )->( eof() )





      nPreCom                       := nComPro( ( dbfTmp )->cRef, ( dbfTmp )->cCodPr1, ( dbfTmp )->cValPr1, ( dbfTmp )->cCodPr2, ( dbfTmp )->cValPr2, D():ArticuloPrecioPropiedades( nView ) )

      if nPrecom  <> 0

         ( dbfTmp )->nPreUnit       := nPreCom

      else

         if uFieldEmpresa( "lCosPrv", .F. )
            nPreCom                 := nPrecioReferenciaProveedor( aTmp[ 6 ], ( dbfTmp )->cRef, D():ProveedorArticulo( nView ) )
         end

         if nPreCom <> 0
            ( dbfTmp )->nPreUnit    := nPreCom
         else
            ( dbfTmp )->nPreUnit    := nCosto( ( dbfTmp )->cRef, D():Articulos( nView ), D():Kit( nView ), .F., aTmp[ 36 ], D():Divisas( nView ) )
         end





         if uFieldEmpresa( "lCosPrv", .F. )

            nPreCom                 := nDescuentoReferenciaProveedor( aTmp[ 6 ], ( dbfTmp )->cRef, D():ProveedorArticulo( nView ) )

            if nPreCom <> 0
               ( dbfTmp )->nDtoLin  := nPreCom
            end





            nPreCom                 := nPromocionReferenciaProveedor( aTmp[ 6 ], ( dbfTmp )->cRef, D():ProveedorArticulo( nView ) )

            if nPreCom <> 0
               ( dbfTmp )->nDtoPrm  :=  nPreCom
            end

         end

      end

      ( dbfTmp )->( dbSkip() )

   end

   ( dbfTmp )->( dbGoTo( nRecNum ) )

   oDlg:Enable()

return nil



Static Function EdtInc( aTmp, aGet, cFacPrvI, oBrw, bWhen, bValid, nMode, aTmpFac )

   local oDlg

   if nMode == 1

      aTmp[ 1  ] := aTmpFac[ 1 ]
      aTmp[ 2  ] := aTmpFac[ 2 ]
      aTmp[ 3  ] := aTmpFac[ 3 ]

      if IsMuebles()
         aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]  := .T.
      end

   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de facturas a proveedores", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



Static Function EdtDoc( aTmp, aGet, dbfAlbPrvD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de facturas a proveedor", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )






STATIC FUNCTION EdtDet( aTmp, aGet, dbf, oBrw, aTmpFac, cCodArtEnt, nMode )

   local oDlg
   local oFld
   local oBtn
   local oTotal
   local oSayFam
   local cSayFam        := ""
   local cSay2
   local oSay2
   local oBmp
   local oBrwPrp
   local oSayPr1
   local oSayPr2
   local oSayVp1
   local oSayVp2
   local cSayVp1           := ""
   local cSayVp2           := ""
   local cSayPr1           := ""
   local cSayPr2           := ""
   local nTotal            := 0
   local oBeneficioSobre   := Array( 6 )
   local cBeneficioSobre   := Afill( Array( 6 ), "" )
   local aBeneficioSobre   := { "Costo", "Venta" }
   local oSayLote
   local cCodArt           := Padr( aTmp[ 4 ], 200 )





   cOldCodArt              := aTmp[ 4    ]
   cOldPrpArt              := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]
   cOldUndMed              := aTmp[ 12 ]
   cTipoCtrCoste           := AllTrim( aTmp[ 108 ] )
   cGetCelda               := Space(20)

   do case
   case nMode == 1

      aTmp[ 13 ]    := 1
      aTmp[ 104 ] := aTmpFac[ 85 ]
      aTmp[ 57  ]    := aTmpFac[ 7 ]
      aTmp[ 62  ]    := nLastNum( dbfTmp )
      aTmp[ 107 ]   := nLastNum( dbfTmp, "nPosPrint" )
      aTmp[ 14  ]    := lActCos()
      aTmp[ 87  ]    := Ctod( "" )

      if !empty( cCodArtEnt )
         cCodArt           := cCodArtEnt
      end

      cTipoCtrCoste        := "Centro de coste"

      oLinDetCamposExtra:setTemporalAppend()

   case nMode == 2

      if !empty( aTmp[ 4 ] )
         ( D():Articulos( nView ) )->( dbSeek( Alltrim( aTmp[ 4 ] ) ) )
      end

   end





   cBeneficioSobre[ 1 ]    := aBeneficioSobre[ Max( aTmp[ 32 ], 1 ) ]
   cBeneficioSobre[ 2 ]    := aBeneficioSobre[ Max( aTmp[ 33 ], 1 ) ]
   cBeneficioSobre[ 3 ]    := aBeneficioSobre[ Max( aTmp[ 34 ], 1 ) ]
   cBeneficioSobre[ 4 ]    := aBeneficioSobre[ Max( aTmp[ 35 ], 1 ) ]
   cBeneficioSobre[ 5 ]    := aBeneficioSobre[ Max( aTmp[ 36 ], 1 ) ]
   cBeneficioSobre[ 6 ]    := aBeneficioSobre[ Max( aTmp[ 37 ], 1 ) ]





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "líneas a facturas de proveedores", "LALBPRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )











      oFld := TFolder():ReDefine( 400, {"&General", "&Precios", "&Observaciones", "&Centro coste"}, { "LFACPRV_7","LALBPRV_2","LFACPRV_5","LCTRCOSTE" }, oDlg,,,,, .F., )





      aGet[ 4 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      aGet[ 4 ]:bValid       := {|| LoaArt( cCodArt, aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oDlg, oSayLote, oBeneficioSobre, oTotal, nMode ) }
      aGet[ 4 ]:bHelp        := {|| BrwArticulo( aGet[ 4 ], aGet[ 6 ], .F., .T., oBtn, aGet[ 61 ], aTmp[ 52 ], aTmp[ 53 ], aGet[ 54 ], aGet[ 55 ], aGet[ 87 ], if( uFieldEmpresa( "lStockAlm" ), aTmp[ 57 ], nil ) ) }








     oSayLote := TSay():ReDefine( 111,, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      aGet[ 61 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ 87 ] := TGetHlp():ReDefine( 113, { | u | If( PCount()==0, aTmp[ 87 ], aTmp[ 87 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 114, )




      aGet[6] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[6], aTmp[6]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( ( lModDes() .OR. empty( aTmp[ 6 ] ) ) .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[15] := TMultiGet():ReDefine( 121, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )









      aGet[ 9 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( if( lTiva( D():TiposIva( nView ), aTmp[ 9 ], @aTmp[ 80 ] ), ( aGet[ 50 ]:cText( aTmp[ 9 ] ), .T. ), .F. ) )},,,,,, .F., {||     ( lModIva() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 9 ], D():TiposIva( nView ), , .T. ) )}, nil, "LUPA",, )










      aGet[ 101 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 101 ], aTmp[ 101 ]:= u ) }, oFld:aDialogs[1],, cPinDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 126, )














      aGet[ 54 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 54 ], oSayVp1, aTmp[ 52 ], D():PropiedadesLineas( nView ) ), LoaArt( cCodArt, aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oDlg, oSayLote, oBeneficioSobre, oTotal, nMode ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 54 ], oSayVp1, aTmp[ 52 ] ) )}, nil, "LUPA",, )

         aGet[ 54 ]:bChange   := {|| aGet[ 54 ]:Assign() }



      oSayPr1 := TSay():ReDefine( 221, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      oSayVp1 := TGetHlp():ReDefine( 222, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 55 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 55 ], oSayVp2, aTmp[ 53 ], D():PropiedadesLineas( nView ) ), LoaArt( cCodArt, aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oDlg, oSayLote, oBeneficioSobre, oTotal, nMode ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 55 ], oSayVp2, aTmp[ 53 ] ) )}, nil, "LUPA",, )

         aGet[ 55 ]:bChange   := {|| aGet[ 55 ]:Assign() }



      oSayPr2 := TSay():ReDefine( 231, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      oSayVp2 := TGetHlp():ReDefine( 232, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 78 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[ 1 ],,, {||       ( oSayFam:cText( RetFld( aTmp[ 78  ], D():Familias( nView ) ) ), .T. )},,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwFamilia( aGet[ 78 ], oSayFam ) )}, nil, "LUPA",, )





      oSayFam := TGetHlp():ReDefine( 271, { | u | If( PCount()==0, cSayFam, cSayFam:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )



      oBrwPrp                       := IXBrowse():New( oFld:aDialogs[1] )

      oBrwPrp:nDataType             := 2

      oBrwPrp:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwPrp:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwPrp:lHScroll              := .T.
      oBrwPrp:lVScroll              := .T.

      oBrwPrp:nMarqueeStyle         := 3
      oBrwPrp:nFreeze               := 1

      oBrwPrp:lRecordSelector       := .F.
      oBrwPrp:lFastEdit             := .T.
      oBrwPrp:lFooter               := .T.

      oBrwPrp:SetArray( {}, .F., 0, .F. )

      oBrwPrp:MakeTotals()

      oBrwPrp:CreateFromResource( 100 )





      oGetCelda := TGetHlp():ReDefine( 183, { | u | If( PCount()==0, cGetCelda, cGetCelda:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,, 184, )

      oGetCelda:bValid              := {|| SearchProperty( oGetCelda, oBrwPrp ), .T. }













      aGet[12] := TGetHlp():ReDefine( 152, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],,, {||    ( D():GetObject( "UnidadMedicion", nView ):Existe( aGet[ 12 ], aGet[ 12 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( D():GetObject( "UnidadMedicion", nView ):Buscar( aGet[ 12 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 153 )











      aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 421, )

      aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 431, )

      aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 440, { | u | If( PCount()==0, aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 441, )

      aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )










      aGet[ 97 ] := TGetHlp():ReDefine( 470, { | u | If( PCount()==0, aTmp[ 97 ], aTmp[ 97 ]:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     ( uFieldEmpresa( "lUseBultos" ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,, 471, )









      aGet[10] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[10], aTmp[10]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )},,,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 141, )









      aGet[13] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[13], aTmp[13]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 151, )









      aGet[7] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],, cPinDiv, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )









      aGet[ 16 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )









      aGet[ 17 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )







      aGet[18] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[18], aTmp[18]:= u ) }, oFld:aDialogs[1],, "@E 99.99",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 92 ] := TCheckBox():ReDefine( 460, { | u | If( PCount()==0, aTmp[ 92 ], aTmp[ 92 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )

      aGet[ 92 ]:bChange   := {|| if( aTmp[ 92 ], ( aGet[ 9 ]:cText( 0 ), aGet[ 9 ]:HardDisable() ), ( aGet[ 9 ]:HardEnable() ) ) }




      aGet[ 98 ] := TGetHlp():ReDefine( 480, { | u | If( PCount()==0, aTmp[ 98 ], aTmp[ 98 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 5 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      oTotal := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nTotal, nTotal:= u ) }, oFld:aDialogs[1],, cPirDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 104 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 104 ], aTmp[ 104 ]:= u ) }, oFld:aDialogs[1],,, {||    (  cAlmacen( aGet[ 104 ], , aGet[ 104 ]:oHelpText ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 104 ], aGet[ 104 ]:oHelpText ) )}, nil, "LUPA", 332, 331 )








      aGet[57] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[57], aTmp[57]:= u ) }, oFld:aDialogs[1],,, {||    (  cAlmacen( aGet[57], , oSay2 ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( Self, oSay2 ) )}, nil, "LUPA",, )




      oSay2 := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cSay2, cSay2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 50 ] := TGetHlp():ReDefine( 80, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[2],, "@E 999.99",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      aGet[ 51 ] := TCheckBox():ReDefine( 90, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[ 19 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[2],, cPinDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 20 ] := TCheckBox():ReDefine( 500, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 26 ] := TGetHlp():ReDefine( 510, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99",,,,,,, .F., {||     ( aTmp[ 20 ] .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      aGet[ 26 ]:bChange     := {|| aGet[ 26 ]:lValid() }
      aGet[ 26 ]:bValid      := {|| lCalPre( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 20 ], aTmp[ 26 ], aTmp[ 9 ], aGet[ 38 ], aGet[ 44 ], nDinDiv ) }






      oBeneficioSobre[ 1 ] := TComboBox():ReDefine( 520, { | u | If( PCount()==0, cBeneficioSobre[ 1 ], cBeneficioSobre[ 1 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oBeneficioSobre[ 1 ]",,,,,,, )

      oBeneficioSobre[ 1 ]:bChange  := {|| if( aTmp[ 20 ], aGet[ 26 ]:lValid(), aGet[ 38 ]:lValid() ) }






      aGet[ 38 ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||        ( !aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 38 ]:bChange  := {|| aGet[ 38 ]:lValid() }
      aGet[ 38 ]:bValid   := {|| CalBnfPts( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 38 ], aGet[ 26 ], aTmp[ 9 ], aGet[ 44 ], nDinDiv ) }






      aGet[ 44 ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||        ( aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 44 ]:bChange  := {|| aGet[ 44 ]:lValid() }
      aGet[ 44 ]:bValid   := {|| CalBnfIva( oBeneficioSobre[ 1 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 44 ], aGet[ 26 ], aTmp[ 9 ], aGet[ 38 ], nDinDiv ) }





      aGet[ 21 ] := TCheckBox():ReDefine( 550, { | u | If( PCount()==0, aTmp[ 21 ], aTmp[ 21 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 27 ] := TGetHlp():ReDefine( 560, { | u | If( PCount()==0, aTmp[ 27 ], aTmp[ 27 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99",,,,,,, .F., {||     ( aTmp[ 21 ] .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      aGet[ 27 ]:bChange  := {|| aGet[ 27 ]:lValid() }
      aGet[ 27 ]:bValid   := {|| lCalPre( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 21 ], aTmp[ 27 ], aTmp[ 9 ], aGet[ 39 ], aGet[ 45 ], nDinDiv ) }






      oBeneficioSobre[ 2 ] := TComboBox():ReDefine( 570, { | u | If( PCount()==0, cBeneficioSobre[ 2 ], cBeneficioSobre[ 2 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oBeneficioSobre[ 2 ]",,,,,,, )

      oBeneficioSobre[ 2 ]:bChange  := {|| if( aTmp[ 21 ], aGet[ 27 ]:lValid(), aGet[ 39 ]:lValid() ) }






      aGet[ 39 ] := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 39 ]:bChange  := {|| aGet[ 39 ]:lValid() }
      aGet[ 39 ]:bValid   := {|| CalBnfPts( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 39 ], aGet[ 27 ], aTmp[ 9 ], aGet[ 45 ], nDinDiv ) }







      aGet[ 45 ] := TGetHlp():ReDefine( 590, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .F.,,,,,, nil,,, )

      aGet[ 45 ]:bChange     := {|| aGet[ 45 ]:lValid() }
      aGet[ 45 ]:bValid      := {|| CalBnfIva( oBeneficioSobre[ 2 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 45 ], aGet[ 27 ], aTmp[ 9 ], aGet[ 39 ], nDinDiv ) }





      aGet[ 22 ] := TCheckBox():ReDefine( 600, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 28 ] := TGetHlp():ReDefine( 610, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99",,,,,,, .F., {||     ( aTmp[ 22 ] .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      aGet[ 28 ]:bChange  := {|| aGet[ 28 ]:lValid() }
      aGet[ 28 ]:bValid   := {|| lCalPre( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 22 ], aTmp[ 28 ], aTmp[ 9 ], aGet[ 40 ], aGet[ 46 ], nDinDiv ) }






      oBeneficioSobre[ 3 ] := TComboBox():ReDefine( 620, { | u | If( PCount()==0, cBeneficioSobre[ 3 ], cBeneficioSobre[ 3 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,, {|Self|( if( aTmp[ 22 ], aGet[ 28 ]:lValid(), aGet[ 40 ]:lValid() ) )},,,, .F., {||     ( nMode <> 3 )},,,,,, "oBeneficioSobre[ 3 ]",,,,,,, )






      aGet[ 40 ] := TGetHlp():ReDefine( 630, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 40 ]:bChange  := {|| aGet[ 40 ]:lValid() }
      aGet[ 40 ]:bValid   := {|| CalBnfPts( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 40 ], aGet[ 28 ], aTmp[ 9 ], aGet[ 46 ], nDinDiv ) }






      aGet[ 46 ] := TGetHlp():ReDefine( 640, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 46 ]:bChange  := {|| aGet[ 46 ]:lValid()  }
      aGet[ 46 ]:bValid   := {|| CalBnfIva( oBeneficioSobre[ 3 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 46 ], aGet[ 28 ], aTmp[ 9 ], aGet[ 40 ], nDinDiv ) }





      aGet[ 23 ] := TCheckBox():ReDefine( 650, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 29 ] := TGetHlp():ReDefine( 660, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99",,,,,,, .F., {||     ( aTmp[ 23 ] .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      aGet[ 29 ]:bChange  := {|| aGet[ 29 ]:lValid() }
      aGet[ 29 ]:bValid   := {|| lCalPre( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 23 ], aTmp[ 29 ], aTmp[ 9 ], aGet[ 41 ], aGet[ 47 ], nDinDiv ) }






      oBeneficioSobre[ 4 ] := TComboBox():ReDefine( 670, { | u | If( PCount()==0, cBeneficioSobre[ 4 ], cBeneficioSobre[ 4 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oBeneficioSobre[ 4 ]",,,,,,, )

      oBeneficioSobre[ 4 ]:bChange  := {|| if( aTmp[ 23 ], aGet[ 29 ]:lValid(), aGet[ 41 ]:lValid() ) }






      aGet[ 41 ] := TGetHlp():ReDefine( 680, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 41 ]:bChange  := {|| aGet[ 41 ]:lValid()  }
      aGet[ 41 ]:bValid   := {|| CalBnfPts( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 41 ], aGet[ 29 ], aTmp[ 9 ], aGet[ 47 ], nDinDiv ) }






      aGet[ 47 ] := TGetHlp():ReDefine( 690, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 47 ]:bChange  := {|| aGet[ 47 ]:lValid() }
      aGet[ 47 ]:bValid   := {|| CalBnfIva( oBeneficioSobre[ 4 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 47 ], aGet[ 29 ], aTmp[ 9 ], aGet[ 41 ], nDinDiv ) }





      aGet[ 24 ] := TCheckBox():ReDefine( 700, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 30 ] := TGetHlp():ReDefine( 710, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99",,,,,,, .F., {||     ( aTmp[ 24 ] .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      aGet[ 30 ]:bChange  := {|| aGet[ 30 ]:lValid() }
      aGet[ 30 ]:bValid   := {|| lCalPre( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 24 ], aTmp[ 30 ], aTmp[ 9 ], aGet[ 42 ], aGet[ 48 ], nDinDiv ) }






      oBeneficioSobre[ 5 ] := TComboBox():ReDefine( 720, { | u | If( PCount()==0, cBeneficioSobre[ 5 ], cBeneficioSobre[ 5 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oBeneficioSobre[ 5 ]",,,,,,, )

      oBeneficioSobre[ 5 ]:bChange  := {|| if( aTmp[ 24 ], aGet[ 30 ]:lValid(), aGet[ 42 ]:lValid() ) }






      aGet[ 42 ] := TGetHlp():ReDefine( 730, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 42 ]:bChange  := {|| aGet[ 42 ]:lValid() }
      aGet[ 42 ]:bValid   := {|| CalBnfPts( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 42 ], aGet[ 30 ], aTmp[ 9 ], aGet[ 48 ], nDinDiv ) }






      aGet[ 48 ] := TGetHlp():ReDefine( 740, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 48 ]:bChange  := {|| aGet[ 48 ]:lValid() }
      aGet[ 48 ]:bValid   := {|| CalBnfIva( oBeneficioSobre[ 5 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 48 ], aGet[ 30 ], aTmp[ 9 ], aGet[ 42 ], nDinDiv ) }





      aGet[ 25 ] := TCheckBox():ReDefine( 750, { | u | If( PCount()==0, aTmp[ 25 ], aTmp[ 25 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )








      aGet[ 31 ] := TGetHlp():ReDefine( 760, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[ 2 ],, "@E 999.99",,,,,,, .F., {||     ( aTmp[ 25 ] .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( ::lValid() ) }, .F., .T.,,,,,, nil,,, )

      aGet[ 31 ]:bChange  := {|| aGet[ 31 ]:lValid() }
      aGet[ 31 ]:bValid   := {|| lCalPre( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 19 ], aTmp[ 25 ], aTmp[ 31 ], aTmp[ 9 ], aGet[ 43 ], aGet[ 49 ], nDinDiv ) }






      oBeneficioSobre[ 6 ] := TComboBox():ReDefine( 770, { | u | If( PCount()==0, cBeneficioSobre[ 6 ], cBeneficioSobre[ 6 ]:= u ) }, aBeneficioSobre, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oBeneficioSobre[ 6 ]",,,,,,, )

      oBeneficioSobre[ 6 ]:bChange  := {|| if( aTmp[ 25 ], aGet[ 31 ]:lValid(), aGet[ 43 ]:lValid() ) }






      aGet[ 43 ] := TGetHlp():ReDefine( 780, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( !aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 43 ]:bChange  := {|| aGet[ 43 ]:lValid() }
      aGet[ 43 ]:bValid   := {|| CalBnfPts( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 43 ], aGet[ 31 ], aTmp[ 9 ], aGet[ 49 ], nDinDiv ) }






      aGet[ 49 ] := TGetHlp():ReDefine( 790, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[ 2 ],, cPinDiv,,,,,,, .F., {||     ( aTmp[ 51 ] .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )

      aGet[ 49 ]:bChange  := {|| aGet[ 49 ]:lValid() }
      aGet[ 49 ]:bValid   := {|| CalBnfIva( oBeneficioSobre[ 6 ]:nAt <= 1, aTmp[ 51 ], aTmp[ 19 ], aTmp[ 49 ], aGet[ 31 ], aTmp[ 9 ], aGet[ 43 ], nDinDiv ) }










      aGet[ 58 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )





      aGet[ 14 ] := TCheckBox():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 .AND. lActCos() )}, .F. )





      aGet[ 93 ] := TGetHlp():ReDefine( 370, { | u | If( PCount()==0, aTmp[ 93 ], aTmp[ 93 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 102 ] := TGetHlp():ReDefine( 371, { | u | If( PCount()==0, aTmp[ 102 ], aTmp[ 102 ]:= u ) }, oFld:aDialogs[2],, "@R 99:99:99", {||    ( iif(   !validTime( aTmp[ 102 ] ), ( msgStop( "El formato de la hora no es correcto" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[81] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[81], aTmp[81]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )












      aGet[ 103 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 103 ], aTmp[ 103 ]:= u ) }, oFld:aDialogs[4],,, {||    ( oCentroCoste:Existe( aGet[ 103 ], aGet[ 103 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 103 ] ) )}, nil, "LUPA",, 411 )






      oTipoCtrCoste := TComboBox():ReDefine( 140, { | u | If( PCount()==0, cTipoCtrCoste, cTipoCtrCoste:= u ) }, aTipoCtrCoste, oFld:aDialogs[4],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oTipoCtrCoste",,,,,,, )

         oTipoCtrCoste:bChange   := {|| clearGet( aGet[ 109 ] ), loadGet( aGet[ 109 ], cTipoCtrCoste ) }







      aGet[ 109 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 109 ], aTmp[ 109 ]:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 160 )





      oBtn := TButton():ReDefine( 1, {||( SaveDeta( aTmp, aGet, oBrw, oDlg, nMode, oTotal, oFld, aTmpFac, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oSayLote, oBrwPrp, oBtn ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( GoHelp() )}, oDlg,,, .F.,,,, .F. )




      oBtnNumerosSerie := TButton():ReDefine( 552, {||( EditarNumerosSerie( aTmp, nMode ) )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 117, {|| oBtnNumerosSerie:Click() } )
      oDlg:AddFastKey( 116, {|| oBtn:SetFocus(), oBtn:Click() } )
      oDlg:AddFastKey( 120, {|| oLinDetCamposExtra:Play( if( nMode == 1, "", Str( ( dbfTmp )->( OrdKeyNo() ) ) ) ) } )
   end

   oDlg:AddFastKey ( 112, {|| GoHelp() } )



   oDlg:bStart    := {|| SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oSayLote, oTotal, oBrwPrp ), loadGet( aGet[ 109 ], cTipoCtrCoste ), aGet[ 109 ]:lValid(), if( !empty( cCodArtEnt ), aGet[ 4 ]:lValid(), ) }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( menuEdtDet( aGet[ 4 ], oDlg, if( nMode == 1, "", Str( ( dbfTmp )->( OrdKeyNo() ) ) ) ) )}, oDlg:bRClicked,,, )

   if !Empty( oDetMenu )
      oDetMenu:End()
   end

RETURN ( oDlg:nResult == 1 )



STATIC FUNCTION SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oSayLote, oTotal, oBrwPrp )

   local cCodArt        := Left( aGet[ 4 ]:VarGet(), 18 )

   if !uFieldEmpresa( "lUseBultos" )
      aGet[ 97 ]:Hide()
   else
      if !empty( aGet[ 97 ] )
         aGet[ 97 ]:SetText( uFieldempresa( "cNbrBultos" ) )
      end
   end

   if !lUseCaj()
      aGet[ 10 ]:Hide()
   else
      aGet[ 10 ]:SetText( cNombreCajas() )
   end

   aGet[ 13 ]:SetText( cNombreUnidades() )

   if empty( aTmp[57 ] )
      aTmp[ 57 ]  := aTmpFac[ 7 ]
   end

   if empty( aTmp[ 104 ] )
      aTmp[ 104 ]  := aTmpFac[ 85 ]
   end

   if uFieldEmpresa( "lShowOrg" )
      aGet[ 104 ]:Show()
   else
      aGet[ 104 ]:Hide()
   end

   oBrwPrp:Hide()
   oGetCelda:hide()

   oSayPr1:SetText( "" )
   oSayVp1:SetText( "" )

   oSayPr2:SetText( "" )
   oSayVp2:SetText( "" )





   oFld:aEnable   := { .T., !empty( aTmp[ 4 ] ), .T., .T. }
   oFld:SetOption( 1 )

   do case
   case nMode == 1

      aGet[ 4    ]:Show()
      aGet[ 4    ]:cText( Space( 200 ) )

      aGet[ 6]:Show()
      aGet[ 15 ]:Hide()
      aGet[ 61   ]:Hide()
      aGet[ 87 ]:Hide()
      aGet[ 10 ]:cText( 1 )
      aGet[ 13]:cText( 1 )
      aGet[ 104 ]:cText( aTmpFac[ 85 ] )
      aGet[ 57 ]:cText( aTmpFac[ 7 ] )

      aGet[ 9    ]:cText( nIva( D():TiposIva( nView ), cDefIva() ) )
      aGet[ 50 ]:cText( nIva( D():TiposIva( nView ), cDefIva() ) )

      aTmp[ 80    ]  := nReq( D():TiposIva( nView ), cDefIva() )
      aTmp[ 62 ]  := nLastNum( dbfTmp )
      aTmp[ 107 ]:= nLastNum( dbfTmp, "nPosPrint" )

      oSayLote:Hide()

      aGet[ 103 ]:cText( aTmpFac[ 84 ] )

      if !empty( aGet[ 103 ] )
         aGet[ 103 ]:lValid()
      endif

      cTipoCtrCoste        := "Centro de coste"
      oTipoCtrCoste:Refresh()
      clearGet( aGet[ 109 ] )

   case nMode <> 1 .AND. empty( cCodArt )

      aGet[ 4    ]:Hide()
      aGet[ 6]:Hide()
      aGet[ 15 ]:Show()
      aGet[ 61   ]:Hide()
      aGet[ 87 ]:Hide()

      oSayLote:Hide()

      if !empty( aGet[ 103 ] )
         aGet[ 103 ]:lValid()
      endif

   case nMode <> 1 .AND. !empty( cCodArt )

      aGet[ 4    ]:Show()
      aGet[ 6]:Show()
      aGet[ 15 ]:Hide()

      if aTmp[ 59   ]
         aGet[ 61   ]:Show()
         aGet[ 5 ]:Show()
         oSayLote:Show()
      else
         aGet[ 61   ]:Hide()
         aGet[ 87 ]:Hide()
         oSayLote:Hide()
      end

      if !empty( aGet[ 103 ] )
         aGet[ 103 ]:lValid()
      endif

   end

   lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

   if !empty( aTmp[ 52 ] )
      aGet[ 54 ]:Show()
      aGet[ 54 ]:lValid()
      oSayPr1:Show()
      oSayVp1:Show()
      oSayPr1:SetText( retProp( aTmp[52], D():Propiedades( nView ) ) )
   else
      aGet[ 54 ]:Hide()
      oSayPr1:Hide()
      oSayVp1:Hide()
   end

   if !empty( aTmp[ 53 ] )
      aGet[ 55 ]:Show()
      aGet[ 55 ]:lValid()
      oSayPr2:Show()
      oSayVp2:Show()
      oSayPr2:SetText( retProp(  aTmp[53], D():Propiedades( nView ) ) )
   else
      aGet[ 55 ]:Hide()
      oSayPr2:Hide()
      oSayVp2:Hide()
   end





   aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
   aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
   aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()

   if D():GetObject( "UnidadMedicion", nView ):oDbf:Seek(  aTmp[ 12 ] )

      if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 1 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim1 )
         aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim1 )
         aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 2 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim2 )
         aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim2 )
         aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 3 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim3 )
         aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim3 )
         aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end

   aGet[ 57 ]:lValid()
   aGet[ 104  ]:lValid()
   aGet[ 4    ]:SetFocus()

Return Nil



STATIC FUNCTION SaveDeta( aTmp, aGet, oBrw, oDlg2, nMode, oTotal, oFld, aTmpFac, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oSayLote, oBrwPrp, oBtn )

   local n
   local i

   oBtn:SetFocus()

   if !aGet[ 4 ]:lValid()
      Return nil
   end

   if empty( aTmp[ 4 ] ) .AND. lRetCodArt()
      MsgStop( "No se pueden añadir lineas sin codificar" )
      Return .F.
   end





   if empty( aTmp[ 57 ] )
      MsgStop( "Código de almacen no puede estar vacio" )
      aGet[ 57 ]:SetFocus()
      Return nil
   end

   if !cAlmacen( aGet[ 57 ] )
      MsgStop( "Código de almacen no encontrado" )
      Return nil
   end

   if ( aTmp[ 57 ] == aTmp[ 104 ] )
      MsgStop( "El almacén de origen debe ser distinto al almacén de destino" )
      aGet[ 104 ]:SetFocus()
      Return nil
   end





   if ( nMode == 1 ) .AND. ( aTmp[ 95 ] )

      if ( aTmp[ 96 ] )

         AutoNumerosSerie( aTmp, nMode )

      elseif !( dbfTmpSer )->( dbSeek( Str( aTmp[ 62 ], 4 ) + aTmp[ 4 ] ) )

         msgStop( "Tiene que introducir números de serie para este artículo." )

         EditarNumerosSerie( aTmp, nMode )

         Return .F.

      end

   end





   cOldCodArt        := ""
   cOldUndMed        := ""
   aTmp[ 108 ]  := cTipoCtrCoste

   if nMode == 1

      if aTmp[ 59 ]
         saveLoteActual( aTmp[ 4 ], aTmp[ 61 ], nView )
      end

      if !empty( oBrwPrp:Cargo )

         for n := 1 to len( oBrwPrp:Cargo )

            for i := 1 to len( oBrwPrp:Cargo[ n ] )

               if !Empty( oBrwPrp:Cargo[ n, i ] )

                  if IsNum( oBrwPrp:Cargo[ n, i ]:Value ) .AND. oBrwPrp:Cargo[ n, i ]:Value <> 0

                     aTmp[ 62 ]     := nLastNum( dbfTmp )
                     aTmp[ 107 ]   := nLastNum( dbfTmp, "nPosPrint" )
                     aTmp[ 13]     := oBrwPrp:Cargo[ n, i ]:Value
                     aTmp[ 52 ]     := oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad1
                     aTmp[ 54 ]     := oBrwPrp:Cargo[ n, i ]:cValorPropiedad1
                     aTmp[ 53 ]     := oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad2
                     aTmp[ 55 ]     := oBrwPrp:Cargo[ n, i ]:cValorPropiedad2

                     if oBrwPrp:Cargo[ n, i ]:nPrecioCompra <> 0
                        aTmp[ 7]  := oBrwPrp:Cargo[ n, i ]:nPrecioCompra
                     end

                     WinGather( aTmp, aGet, dbfTmp, oBrw, nMode, nil, .F. )

                  end

               end

            next

         next

         aCopy( dbBlankRec( dbfTmp ), aTmp )

         aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      else

         WinGather( aTmp, aGet, dbfTmp, oBrw, nMode )

      end

      if lEntCon()
         RecalculaTotal( aTmpFac )
         SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oSayLote, oTotal, oBrwPrp )
      else
         oDlg2:End( 1 )
      end

   else

      WinGather( aTmp, aGet, dbfTmp, oBrw, nMode )

      oDlg2:end( 1 )

   end

   if nMode == 1
      oLinDetCamposExtra:SaveTemporalAppend( ( dbfTmp )->( OrdKeyNo() ) )
   end

   if !empty( aGet[ 12 ] )
      aGet[ 12 ]:lValid()
   end

   if !empty( oBrwPrp )
      oBrwPrp:Cargo                 := nil
   end

RETURN NIL







STATIC FUNCTION AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt )

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden modificar registros de una factura con pagos" )
      return .F.
   end

   WinAppRec( oBrwLin, bEdtDet, dbfTmp, aTmp, cCodArt )

RETURN ( RecalculaTotal( aTmp ) )







STATIC FUNCTION EdtDeta( oBrwLin, bEdtDet, aTmp, cLoop )

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden modificar registros de una factura con pagos" )
      return .F.
   end

   if !( dbfTmp )->lControl
      WinEdtRec( oBrwLin, bEdtDet, dbfTmp, aTmp )
   end

RETURN ( RecalculaTotal( aTmp ) )






STATIC FUNCTION DelDeta()

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden eliminar registros de una factura con pagos" )
      return .F.
   end

   CursorWait()

   while ( dbfTmpSer )->( dbSeek( Str( ( dbfTmp )->nNumLin, 4 ) ) )
      ( dbfTmpSer )->( dbDelete() )
   end

   if ( dbfTmp )->lKitArt
      dbDelKit( , dbfTmp, ( dbfTmp )->nNumLin )
   end

   CursorWE()

RETURN ( .T. )



STATIC FUNCTION PrnSerie( oBrw )

   local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local cSerIni     := ( D():FacturasProveedores( nView ) )->cSerFac
   local cSerFin     := ( D():FacturasProveedores( nView ) )->cSerFac
   local nDocIni     := ( D():FacturasProveedores( nView ) )->nNumFac
   local nDocFin     := ( D():FacturasProveedores( nView ) )->nNumFac
   local cSufIni     := ( D():FacturasProveedores( nView ) )->cSufFac
   local cSufFin     := ( D():FacturasProveedores( nView ) )->cSufFac
   local oPrinter
   local cPrinter    := ImpresoraDefectoUsuario()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) )
   local oRango
   local nRango      := 1
   local dFecDesde   := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dFecHasta   := Date()

   if empty( cFmtDoc )
      cFmtDoc        := cSelPrimerDoc( "FP" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de facturas", "IMPSERIES",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



   oRango := TRadMenu():Redefine( { | u | If( PCount()==0, nRango, nRango:= u ) }, oDlg,, { 201, 202 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 210, { | u | If( PCount()==0, dFecDesde, dFecDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 220, { | u | If( PCount()==0, dFecHasta, dFecHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, D():Documentos( nView ) ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "FP" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "gc_document_text_pencil_12",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "gc_printer2_check_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) } )

   oDlg:bStart := { || oSerIni:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta )

   local nCopyProvee
   local nRecno
   local nOrdAnt

   oDlg:disable()

   if nRango == 1

      nRecno      := ( D():FacturasProveedores( nView ) )->( Recno() )
      nOrdAnt     := ( D():FacturasProveedores( nView ) )->( OrdSetFocus( "NNUMFAC" ) )

      if !lInvOrden

         ( D():FacturasProveedores( nView ) )->( dbSeek( cDocIni, .T. ) )


         while ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac >= cDocIni .AND.  ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac <= cDocFin

               lChgImpDoc( D():FacturasProveedores( nView ) )

            if lCopiasPre

               nCopyProvee    := if( nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) )

               GenFacPrv( 1, "Imprimiendo documento : " + ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

            else

               GenFacPrv( 1, "Imprimiendo documento : " + ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nNumCop )

            end

         (D():FacturasProveedores( nView ))->( dbSkip() )

         end

      else

         ( D():FacturasProveedores( nView ) )->( dbSeek( cDocFin ) )



         while ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac >= cDocIni .AND.  ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac <= cDocFin .AND. !( D():FacturasProveedores( nView ) )->( Bof() )

               lChgImpDoc( D():FacturasProveedores( nView ) )

            if lCopiasPre

               nCopyProvee    := if( nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) )

               GenFacPrv( 1, "Imprimiendo documento : " + ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

            else

               GenFacPrv( 1, "Imprimiendo documento : " + ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nNumCop )

            end

         ( D():FacturasProveedores( nView ) )->( dbSkip( -1 ) )

         end

      end

   else

   nRecno      := ( D():FacturasProveedores( nView ) )->( Recno() )
   nOrdAnt     := ( D():FacturasProveedores( nView ) )->( OrdSetFocus( "DFECFAC" ) )

      if !lInvOrden

         ( D():FacturasProveedores( nView ) )->( dbGoTop() )

         while !( D():FacturasProveedores( nView ) )->( Eof() )

            if ( D():FacturasProveedores( nView ) )->dFecFac >= dFecDesde .AND. ( D():FacturasProveedores( nView ) )->dFecFac <= dFecHasta

               lChgImpDoc( D():FacturasProveedores( nView ) )

               if lCopiasPre

                  nCopyProvee    := if( nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) )

                  GenFacPrv( 1, "Imprimiendo documento : " + ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

               else

                  GenFacPrv( 1, "Imprimiendo documento : " + ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nNumCop )

               end

            end

         (D():FacturasProveedores( nView ))->( dbSkip() )

         end

      else

         ( D():FacturasProveedores( nView ) )->( dbGoBottom() )

         while !( D():FacturasProveedores( nView ) )->( Bof() )

            if ( D():FacturasProveedores( nView ) )->dFecFac >= dFecDesde .AND. ( D():FacturasProveedores( nView ) )->dFecFac <= dFecHasta

               lChgImpDoc( D():FacturasProveedores( nView ) )

               if lCopiasPre

                  nCopyProvee    := if( nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) )

                  GenFacPrv( 1, "Imprimiendo documento : " + ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

               else

                  GenFacPrv( 1, "Imprimiendo documento : " + ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + (D():FacturasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nNumCop )

               end

            end

         ( D():FacturasProveedores( nView ) )->( dbSkip( -1 ) )

         end

      end

   end

   ( D():FacturasProveedores( nView ) )->( ordSetFocus( nOrdAnt ) )
   ( D():FacturasProveedores( nView ) )->( dbGoTo( nRecNo ) )

   oDlg:enable()

RETURN NIL







STATIC FUNCTION lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

   oTotal:cText( nTotLFacPrv( aTmp, nDinDiv, nRinDiv ) )





   aGet[ 19 ]:cText( nNetUFacPrv( aTmp, aTmpFac, nDinDiv, nRinDiv, aTmpFac[ 37 ] ) )

   if aTmp[ 20 ]
      aGet[ 26 ]:lValid()
   else
      aGet[ 44 ]:lValid()
      aGet[ 38 ]:lValid()
   end

   if aTmp[ 21 ]
      aGet[ 27 ]:lValid()
   else
      aGet[ 45 ]:lValid()
      aGet[ 39 ]:lValid()
   end

   if aTmp[ 22 ]
      aGet[ 28 ]:lValid()
   else
      aGet[ 46 ]:lValid()
      aGet[ 40 ]:lValid()
   end

   if aTmp[ 23 ]
      aGet[ 29 ]:lValid()
   else
      aGet[ 47 ]:lValid()
      aGet[ 41 ]:lValid()
   end

   if aTmp[ 24 ]
      aGet[ 30 ]:lValid()
   else
      aGet[ 48 ]:lValid()
      aGet[ 42 ]:lValid()
   end

   if aTmp[ 25 ]
      aGet[ 31 ]:lValid()
   else
      aGet[ 49 ]:lValid()
      aGet[ 43 ]:lValid()
   end

   if lActCos()
      aGet[ 14 ]:Click( aTmp[ 7 ] <> 0 )
   end

RETURN .T.



Static Function RecalculaTotal( aTmp )

   nTotFacPrv( nil, D():FacturasProveedores( nView ), dbfTmp, D():TiposIva( nView ), D():Divisas( nView ), dbfTmpPgo, aTmp )

   if oBrwIva <> nil
      oBrwIva:SetArray( aTotIva, , , .F. )
      oBrwIva:refresh()
   end

   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPirDiv ) )
   end

   if oGetIva <> nil
      oGetIva:SetText( Trans( nTotIva, cPirDiv ) )
   end

   if oGetReq <> nil
      oGetReq:SetText( Trans( nTotReq, cPirDiv ) )
   end

   if oGetIvm <> nil
      oGetIvm:SetText( Trans( nTotIvm, cPirDiv ) )
   end

   if oGetTotal <> nil
      oGetTotal:SetText( Trans( nTotFac, cPirDiv ) )
   end

   if oGetRet <> nil
      oGetRet:SetText( Trans( nTotRet, cPirDiv ) )
   end

   if oGetTotPg <> nil
      oGetTotPg:SetText( Trans( nTotFac, cPirDiv ) )
   end

   if oGetPgd <> nil
      oGetPgd:SetText( Trans( nPagFac, cPirDiv ) )
   end

   if oGetPdt <> nil
      oGetPdt:SetText( Trans( nTotFac - nPagFac, cPirDiv ) )
   end

Return .T.



Static Function nGenFacPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local nFac

   CursorWait()

   for each nFac in ( oWndBrw:oBrw:aSelected )

      ( D():FacturasProveedores( nView ) )->( dbGoTo( nFac ) )

      GenFacPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   next

   CursorWE()

Return ( nil )



Static Function GenFacPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oDevice
   local nFactura

   if ( D():FacturasProveedores( nView ) )->( Lastrec() ) == 0
      Return nil
   end

   nFactura             := ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac

   If( nDevice == nil, nDevice := 1, ) ;
   If( cCaption == nil, cCaption := "Imprimiendo facturas de proveedores", ) ;
   If( cCodDoc == nil, cCodDoc := cFormatoDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ), ) ;
   If( nCopies == nil, nCopies := if( nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) ) ), ) ;

   if empty( cCodDoc )
      cCodDoc           := cFirstDoc( "FP", D():Documentos( nView ) )
   end

   if !lExisteDocumento( cCodDoc, D():Documentos( nView ) )
      return nil
   end





   if lVisualDocumento( cCodDoc, D():Documentos( nView ) )
      PrintReportFacPrv( nDevice, nCopies, cPrinter )
   else
      msgStop( "El formato ya no es soportado" )
   end

   lChgImpDoc( D():FacturasProveedores( nView ) )

RETURN NIL



Static Function FacPrvReportSkipper()

   ( D():FacturasProveedoresLineas( nView ) )->( dbSkip() )

   nTotPage              += nTotLFacPrv( D():FacturasProveedoresLineas( nView ) )

Return nil



STATIC FUNCTION lMoreIva( nCodIva )





   IF aTotIva[ 1, 3 ] == NIL .OR. aTotIva[ 2, 3 ] == NIL .OR. aTotIva[ 3, 3 ] == NIL
      RETURN .T.
   end

   IF aTotIva[ 1, 3 ] == nCodIva .OR. aTotIva[ 2, 3 ] == nCodIva .OR. aTotIva[ 3, 3 ] == nCodIva
      RETURN .T.
   end

   MsgStop( "Factura con mas de 3 tipos de " + cImp(), "Imposible añadir" )

RETURN .F.



STATIC FUNCTION loaPrv( aGet, aTmp, dbf, nMode, oSay, oTlfPrv )

   local lValid      := .F.
   local cNewCodCli  := aGet[ 6 ]:VarGet()
   local lChgCodCli  := ( empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if empty( cNewCodCli )
      Return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[ 6 ], "0", RetNumCodPrvEmp() )
   else
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodPrvEmp() )
   end

   if ( D():Proveedores( nView ) )->( dbSeek( cNewCodCli ) )

      if ( D():Proveedores( nView ) )->lBlqPrv
         msgStop( "Proveedor bloqueado, no se pueden realizar operaciones de compra" )
         return .F.
      end

      aGet[ 6 ]:cText( ( D():Proveedores( nView ) )->Cod )

      if empty( aGet[9]:varGet() ) .OR. lChgCodCli
         aGet[9]:cText( ( D():Proveedores( nView ) )->Titulo )
      end

      if oTlfPrv <> nil
         oTlfPrv:SetText( ( D():Proveedores( nView ) )->Telefono )
      end

      if empty( aGet[10]:varGet() ) .OR. lChgCodCli
         aGet[10]:cText( ( D():Proveedores( nView ) )->Domicilio )
      endif

      if empty( aGet[11]:varGet() ) .OR. lChgCodCli
         aGet[11]:cText( (D():Proveedores( nView ))->POBLACION )
      endif

      if empty( aGet[ 12 ]:varGet() ) .OR. lChgCodCli
         aGet[ 12 ]:cText( (D():Proveedores( nView ))->PROVINCIA )
      endif

      if empty( aGet[13]:varGet() ) .OR. lChgCodCli
         aGet[13]:cText( (D():Proveedores( nView ))->CODPOSTAL )
      endif

      if empty( aGet[14]:varGet() ) .OR. lChgCodCli
         aGet[14]:cText( (D():Proveedores( nView ))->NIF )
      endif

      if lChgCodCli
         aGet[ 29 ]:cText( ( D():Proveedores( nView ) )->cDtoEsp )
         aGet[ 30 ]:cText( ( D():Proveedores( nView ) )->nDtoEsp )
         aGet[ 31    ]:cText( ( D():Proveedores( nView ) )->cDtoPP )
         aGet[ 32    ]:cText( ( D():Proveedores( nView ) )->DtoPP )
      end

      if empty( aGet[ 23 ]:VarGet() ) .OR. lChgCodCli
         aGet[ 23 ]:cText( ( D():Proveedores( nView ) )->fPago )
         aGet[ 23 ]:lValid()





         if retFld( aTmp[ 23 ], D():FormasPago( nView ), "lUtlBnc" )

            if dbSeekInOrd( ( D():Proveedores( nView ) )->Cod, "cCodDef", D():BancosProveedores( nView ) )

               if !empty( aGet[ 75 ] )
                  aGet[ 75 ]:cText( ( D():BancosProveedores( nView ) )->cCodBnc )
                  aGet[ 75 ]:lValid()
               end

               if !empty( aGet[ 76 ] )
                  aGet[ 76 ]:cText( ( D():BancosProveedores( nView ) )->cPaisIBAN )
                  aGet[ 76 ]:lValid()
               end

               if !empty( aGet[ 77 ] )
                  aGet[ 77 ]:cText( ( D():BancosProveedores( nView ) )->cCtrlIBAN )
                  aGet[ 77 ]:lValid()
               end

               if !empty( aGet[ 78 ] )
                  aGet[ 78 ]:cText( ( D():BancosProveedores( nView ) )->cEntBnc )
                  aGet[ 78 ]:lValid()
               end

               if !empty( aGet[ 79 ] )
                  aGet[ 79 ]:cText( ( D():BancosProveedores( nView ) )->cSucBnc )
                  aGet[ 79 ]:lValid()
               end

               if !empty( aGet[ 80 ] )
                  aGet[ 80 ]:cText( ( D():BancosProveedores( nView ) )->cDigBnc )
                  aGet[ 80 ]:lValid()
               end

               if !empty( aGet[ 81 ] )
                  aGet[ 81 ]:cText( ( D():BancosProveedores( nView ) )->cCtaBnc )
                  aGet[ 81 ]:lValid()
               end

            end

         end

      end

      if empty( aGet[ 51 ]:VarGet() ) .OR. lChgCodCli
         aGet[ 51 ]:oGet:cText(  ( D():Proveedores( nView ) )->nTipRet )
         aGet[ 51 ]:Select(      ( D():Proveedores( nView ) )->nTipRet )
      end

      if empty( aGet[ 52 ]:VarGet() ) .OR. lChgCodCli
         aGet[ 52 ]:cText( ( D():Proveedores( nView ) )->nPctRet )
      end

      if nMode == 1

         aGet[ 56 ]:nOption( Max( ( D():Proveedores( nView ) )->nRegIva, 1 ) )
         aGet[ 56 ]:Refresh()

         if empty( aTmp[ 1 ] )

            if !empty( ( D():Proveedores( nView ) )->Serie )
               aGet[ 1 ]:cText( ( D():Proveedores( nView ) )->Serie )
            end

         else

            if !empty( ( D():Proveedores( nView ) )->Serie ) .AND. aTmp[ 1 ] <> ( D():Proveedores( nView ) )->Serie .AND. ApoloMsgNoYes( "La serie del proveedor seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( D():Proveedores( nView ) )->Serie )
            end

         end

      end

      if lChgCodCli
         aTmp[ 33 ] := ( D():Proveedores( nView ) )->lReq
         aGet[ 33 ]:Refresh()

         aTmp[ 82 ]    := ( D():Proveedores( nView ) )->lRecc
         aGet[ 82 ]:Refresh()
      end

      if ( D():Proveedores( nView ) )->lMosCom .AND. !empty( ( D():Proveedores( nView ) )->mComent ) .AND. lChgCodCli
         MsgStop( AllTrim( ( D():Proveedores( nView ) )->mComent ) )
      end

      cOldCodCli  := ( D():Proveedores( nView ) )->Cod
      lValid      := .T.

   ELSE

      msgStop( "Proveedor no encontrado" )

   end

RETURN lValid







STATIC FUNCTION LoaArt( cCodArt, aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oDlg, oSayLote, oBeneficioSobre, oTotal, nMode )

   local hHas128
   local cLote       := Space( 64 )
   local dFechaCaducidad
   local nIva
   local nOrdAnt
   local nPreUnt
   local nPreCom
   local cCodFam
   local cPrpArt
   local cCodPrv
   local lChgCodArt
   local lSeek       := .F.

   nIva              := 0
   cPrpArt           := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]
   cCodPrv           := aTmpFac[ 6 ]
   lChgCodArt        := ( Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) .OR. Rtrim( cOldPrpArt ) <> Rtrim( cPrpArt ) )

   if empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

      aGet[ 9     ]:bWhen := {|| .T. }

      aGet[ 6 ]:Hide()

      aGet [15  ]:Show()
      aGet [15  ]:SetFocus()

      if !empty( oBrwPrp )
         oBrwPrp:Hide()
      end

      if !empty( oGetCelda )
         oGetCelda:Hide()
      end

   else

      if lModIva()
         aGet[ 9 ]:bWhen  := {|| .T. }
      else
         aGet[ 9 ]:bWhen  := {|| .F. }
      end

      aGet[ 4    ]:Show()
      aGet[ 6]:Show()
      aGet[ 15 ]:Hide()





      if Len( Alltrim( cCodArt ) ) > 18

         hHas128              := GetHashGs128( cCodArt )
         if !empty( hHas128 )
            cCodArt           := uGetCodigo( hHas128, "01" )
            cLote             := Upper( uGetCodigo( hHas128, "10" ) )
            dFechaCaducidad   := uGetCodigo( hHas128, "15" )
            if Empty( dFechaCaducidad )
               dFechaCaducidad   := uGetCodigo( hHas128, "17" )
            end
         end

      end





      if lIntelliArtciculoSearch( cCodArt, cCodPrv, D():Articulos( nView ), D():ProveedorArticulo( nView ), D():ArticulosCodigosBarras( nView ) )

         if ( lChgCodArt )

            if ( D():Articulos( nView ) )->lObs
               MsgStop( "Artículo catalogado como obsoleto" )
               return .F.
            end

            cCodArt              := ( D():Articulos( nView ) )->Codigo

            aGet[ 4 ]:cText( Padr( cCodArt, 200 ) )
            aTmp[ 4 ]        := cCodArt



            aTmp[ 105 ]     := ( D():Articulos( nView ) )->cRefAux
            aTmp[ 106 ]    := ( D():Articulos( nView ) )->cRefAux2






            aTmp[ 59  ]      := ( D():Articulos( nView ) )->lLote

            if ( D():Articulos( nView ) )->lLote





               if empty( cLote ) .AND. uFieldempresa( "lLoaUltLot" )
                  if !Empty( ( D():Articulos( nView ) )->cLote )
                     cLote       := ( D():Articulos( nView ) )->cLote
                  else
                     cLote       := Space( 64 )
                  end
               end

               oSayLote:Show()
               aGet[ 61   ]:Show()
               aGet[ 61   ]:cText( cLote )





               if empty( dFechaCaducidad )
                  dFechaCaducidad   := StocksModel():getFechaCaducidad( cCodArt, aTmp[ 52 ], aTmp[ 53 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 61 ] )
               end

               aGet[ 87 ]:Show()

               if empty( aTmp[ 87 ] )
                  aGet[ 87 ]:cText( dFechaCaducidad )
               end

            else

               oSayLote:Hide()
               aGet[ 61   ]:Hide()
               aGet[ 87 ]:Hide()

            end





            cCodFam                 := ( D():Articulos( nView ) )->Familia
            if !empty( cCodFam )
               aTmp[ 78 ]     := cCodFam
               aTmp[ 79 ]     := cGruFam( cCodFam, D():Familias( nView ) )
            end





            if ( D():Articulos( nView ) )->lKitArt

               aTmp[ 64 ]     := ( D():Articulos( nView ) )->lKitArt
               aTmp[ 67 ]     := lImprimirCompuesto( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
               aTmp[ 66 ]     := lPreciosCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )

               if lStockCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
                  aTmp[ 58 ]  := ( D():Articulos( nView ) )->nCtlStock
               else
                  aTmp[ 58 ]  := 3
               end

            else

               aTmp[ 67 ]     := .F.
               aTmp[ 58 ]     := ( D():Articulos( nView ) )->nCtlStock

            end



            aTmp[ 95 ]        := ( D():Articulos( nView ) )->lNumSer
            aTmp[ 96 ]        := ( D():Articulos( nView ) )->lAutSer



            nPreUnt                 := aGet[ 7 ]:VarGet()



            oFld:aEnable            := { .T., .T., .T., .T. }
            oFld:refresh()

            aGet[4    ]:cText( ( D():Articulos( nView ) )->Codigo )
            aGet[6]:cText( ( D():Articulos( nView ) )->Nombre )

            if ( D():Articulos( nView ) )->lMosCom .AND. !empty( ( D():Articulos( nView ) )->mComent )
               MsgStop( Trim( ( D():Articulos( nView ) )->mComent ) )
            end



            if aTmpFac[ 56 ] <= 1

               nIva           := nIva( D():TiposIva( nView ), ( D():Articulos( nView ) )->TipoIva )
               aGet[ 9    ]:cText( nIva )
               aGet[ 50 ]:cText( nIva )
               aGet[ 51 ]:Click( ( D():Articulos( nView ) )->lIvaInc )

               aTmp[ 80 ]  := nReq( D():TiposIva( nView ), ( D():Articulos( nView ) )->TipoIva )

            end



            aTmp[ 100 ]  := ( D():Articulos( nView ) )->cCodImp

            oNewImp:setCodeAndValue( aTmp[ 100 ], aGet[ 101 ] )



            if ( D():Articulos( nView ) )->nCajEnt <> 0
               aGet[ 10 ]:cText( ( D():Articulos( nView ) )->nCajEnt )
            end

            if ( D():Articulos( nView ) )->nUniCaja <> 0
               aGet[ 13 ]:cText( ( D():Articulos( nView ) )->nUniCaja )
            end



            nOrdAnt                 := ( D():ProveedorArticulo( nView ) )->( OrdSetFocus( "cCodPrv" ) )

            if ( D():ProveedorArticulo( nView ) )->( dbSeek( cCodPrv + cCodArt) )

               if !empty( aGet[ 5 ] )
                  aGet[ 5 ]:cText( ( D():ProveedorArticulo( nView ) )->cRefPrv )
               end

            else

               if !empty( aGet[ 5 ] )
                  aGet[ 5 ]:cText( Space( 20 ) )
               end

            end

            ( D():ProveedorArticulo( nView ) )->( ordSetFocus( nOrdAnt ) )





            aTmp[ 82 ]     := ( D():Articulos( nView ) )->PvpRec





            aTmp[ 52 ]     := ( D():Articulos( nView ) )->cCodPrp1
            aTmp[ 53 ]     := ( D():Articulos( nView ) )->cCodPrp2

            if ( !empty( aTmp[ 52 ] ) .OR. !empty( aTmp[ 53 ] ) ) .AND. uFieldEmpresa( "lUseTbl" ) .AND. ( nMode == 1 )

               nPreCom           := nCosto( nil, D():Articulos( nView ), D():Kit( nView ), .F., aTmpFac[ 36 ], D():Divisas( nView ) )

               setPropertiesTable( cCodArt, aTmp[ 52 ], aTmp[ 53 ], nPreCom, aGet[ 13 ], oBrwPrp, nView )

               if !empty( oGetCelda )
                  oGetCelda:Show()
               end

            else

               hidePropertiesTable( oBrwPrp )

               if !empty( aTmp[ 52 ] )

                  if aGet[ 54 ] <> nil
                     aGet[ 54 ]:Show()
                     aGet[ 54 ]:SetFocus()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp1, D():Propiedades( nView ) ) )
                     oSayPr1:Show()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Show()
                  end

               else

                  if aGet[ 54 ] <>  nil
                     aGet[ 54 ]:Hide()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:Hide()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Hide()
                  end

               end

               if !empty( aTmp[ 53 ] )

                  if aGet[ 55 ] <> nil
                     aGet[ 55 ]:Show()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp2, D():Propiedades( nView ) ) )
                     oSayPr2:Show()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:Show()
                  end

               else

                  if aGet[ 55 ] <> nil
                     aGet[ 55 ]:Hide()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:Hide()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:Hide()
                  end

               end

            end





            if !empty( aGet[ 12 ] )
               aGet[ 12 ]:cText( ( D():Articulos( nView ) )->cUnidad )
               aGet[ 12 ]:lValid()
            else
               aTmp[ 12 ]  := ( D():Articulos( nView ) )->cUnidad
            end

            ValidaMedicion( aTmp, aGet)

         end

         cPrpArt                 := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]

         if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt )





            if !empty( aGet[ 19 ] )
               aGet[ 19 ]:cText( nNetUFacPrv( aTmp, aTmpFac, nDinDiv, nRinDiv, aTmpFac[ 37 ] ) )
            end

            nPreCom              := nComPro( cCodArt, aTmp[ 52 ], aTmp[ 54 ], aTmp[ 53 ], aTmp[ 55 ], D():ArticuloPrecioPropiedades( nView ) )
            if nPrecom  <> 0

               aGet[ 7 ]:cText( nPreCom )

            else

               if uFieldEmpresa( "lCosPrv", .F. )
                  nPreCom        := nPrecioReferenciaProveedor( cCodPrv, cCodArt, D():ProveedorArticulo( nView ) )
               end

               if nPreCom <> 0
                  aGet[ 7 ]:cText( nPreCom )
               else
                  aGet[ 7 ]:cText( nCosto( nil, D():Articulos( nView ), D():Kit( nView ), .F., aTmpFac[ 36 ], D():Divisas( nView ) ) )
               end

            end





            if uFieldEmpresa( "lCosPrv", .F. )

               nPreCom           := nDescuentoReferenciaProveedor( cCodPrv, cCodArt, D():ProveedorArticulo( nView ) )

               if nPreCom <> 0
                  aGet[ 16 ]:cText( nPreCom )
               end





               nPreCom           := nPromocionReferenciaProveedor( cCodPrv, cCodArt, D():ProveedorArticulo( nView ) )

               if nPreCom <> 0
                  aGet[ 17 ]:cText( nPreCom )
               end

            end





            aGet[ 26 ]:cText( ( D():Articulos( nView ) )->Benef1 )
            aGet[ 27 ]:cText( ( D():Articulos( nView ) )->Benef2 )
            aGet[ 28 ]:cText( ( D():Articulos( nView ) )->Benef3 )
            aGet[ 29 ]:cText( ( D():Articulos( nView ) )->Benef4 )
            aGet[ 30 ]:cText( ( D():Articulos( nView ) )->Benef5 )
            aGet[ 31 ]:cText( ( D():Articulos( nView ) )->Benef6 )

            aGet[ 20 ]:Click( ( D():Articulos( nView ) )->lBnf1 )
            aGet[ 21 ]:Click( ( D():Articulos( nView ) )->lBnf2 )
            aGet[ 22 ]:Click( ( D():Articulos( nView ) )->lBnf3 )
            aGet[ 23 ]:Click( ( D():Articulos( nView ) )->lBnf4 )
            aGet[ 24 ]:Click( ( D():Articulos( nView ) )->lBnf5 )
            aGet[ 25 ]:Click( ( D():Articulos( nView ) )->lBnf6 )

            aGet[ 38 ]:cText( ( D():Articulos( nView ) )->pVenta1  )
            aGet[ 39 ]:cText( ( D():Articulos( nView ) )->pVenta2  )
            aGet[ 40 ]:cText( ( D():Articulos( nView ) )->pVenta3  )
            aGet[ 41 ]:cText( ( D():Articulos( nView ) )->pVenta4  )
            aGet[ 42 ]:cText( ( D():Articulos( nView ) )->pVenta5  )
            aGet[ 43 ]:cText( ( D():Articulos( nView ) )->pVenta6  )

            aGet[ 44 ]:cText( ( D():Articulos( nView ) )->pVtaIva1 )
            aGet[ 45 ]:cText( ( D():Articulos( nView ) )->pVtaIva2 )
            aGet[ 46 ]:cText( ( D():Articulos( nView ) )->pVtaIva3 )
            aGet[ 47 ]:cText( ( D():Articulos( nView ) )->pVtaIva4 )
            aGet[ 48 ]:cText( ( D():Articulos( nView ) )->pVtaIva5 )
            aGet[ 49 ]:cText( ( D():Articulos( nView ) )->pVtaIva6 )

            oBeneficioSobre[ 1 ]:Select( Max( ( D():Articulos( nView ) )->nBnfSbr1, 1 ) )
            oBeneficioSobre[ 2 ]:Select( Max( ( D():Articulos( nView ) )->nBnfSbr2, 1 ) )
            oBeneficioSobre[ 3 ]:Select( Max( ( D():Articulos( nView ) )->nBnfSbr3, 1 ) )
            oBeneficioSobre[ 4 ]:Select( Max( ( D():Articulos( nView ) )->nBnfSbr4, 1 ) )
            oBeneficioSobre[ 5 ]:Select( Max( ( D():Articulos( nView ) )->nBnfSbr5, 1 ) )
            oBeneficioSobre[ 6 ]:Select( Max( ( D():Articulos( nView ) )->nBnfSbr6, 1 ) )

         end





         lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

      else

         MsgStop( "Artículo no encontrado" )
         Return .F.

      end

   end

   cOldCodArt                    := cCodArt
   cOldPrpArt                    := cPrpArt

Return .T.



STATIC FUNCTION LoadPreCosto( aGet, oGet )

   local xValor   := aGet[4]:varGet()

   IF empty( xValor )
      RETURN .F.
   end

   if oGet == nil
      return .F.
   end

   IF ( D():Articulos( nView ) )->( dbSeek( xValor ) )
      oGet:cText( ( D():Articulos( nView ) )->pCosto )
   end

   aGet[4]:bWhen := {|| .F. }

RETURN .F.



STATIC FUNCTION LoadArtPed( aGet )

   local lValid               := .F.
   local xValor               := aGet[4]:varGet()

   IF empty( xValor )

      aGet[9]:cText( 0 )
      aGet[9]:bWhen       := {|| .T. }

      aGet[6]:cText( Space( 50 ) )
      aGet[6]:bWhen   := {|| .T. }

      RETURN .T.

   end

   if ( D():Articulos( nView ) )->( dbSeek( xValor ) )

      aGet[4    ]:cText( ( D():Articulos( nView ) )->Codigo )
      aGet[4    ]:bWhen   := {|| .T. }

      aGet[6]:cText( ( D():Articulos( nView ) )->Nombre )
      aGet[7]:cText( ( D():Articulos( nView ) )->pCosto )

      lValid                  := .T.

   else

      MsgStop( "Artículo no encontrado" )

   end

RETURN lValid



STATIC FUNCTION GetArtPrv( cRefPrv, cCodPrv, aGet )

   local nOrdAnt

   if empty( cRefPrv )

      return .T.

   else

      nOrdAnt  := ( D():ProveedorArticulo( nView ) )->( ordSetFocus( 3 ) )

      if ( D():ProveedorArticulo( nView ) )->( dbSeek( cCodPrv + cRefPrv ) )

         aGet[ 4 ]:cText( ( D():ProveedorArticulo( nView ) )->cCodArt )
         aGet[ 4 ]:lValid()

      else

         msgStop( "Referencia de proveedor no encontrada" )

      end

      ( D():ProveedorArticulo( nView ) )->( ordSetFocus( nOrdAnt ) )

   end

return .T.



Static Function AppendPropiedadesArticulos( aTbl, aTmp )

   if !( D():ArticuloPrecioPropiedades( nView ) )->( dbSeek( aTbl[ 4 ] +  aTbl[ 52 ] + aTbl[ 53 ] + aTbl[ 54 ] + aTbl[ 55 ] ) )

      ( D():ArticuloPrecioPropiedades( nView ) )->( dbAppend() )
      ( D():ArticuloPrecioPropiedades( nView ) )->cCodDiv    := aTmp[ 36 ]
      ( D():ArticuloPrecioPropiedades( nView ) )->cCodArt    := aTbl[ 4    ]
      ( D():ArticuloPrecioPropiedades( nView ) )->cCodPr1    := aTbl[ 52 ]
      ( D():ArticuloPrecioPropiedades( nView ) )->cCodPr2    := aTbl[ 53 ]
      ( D():ArticuloPrecioPropiedades( nView ) )->cValPr1    := aTbl[ 54 ]
      ( D():ArticuloPrecioPropiedades( nView ) )->cValPr2    := aTbl[ 55 ]
      ( D():ArticuloPrecioPropiedades( nView ) )->nPreCom    := aTbl[ 19 ]
      ( D():ArticuloPrecioPropiedades( nView ) )->( dbUnlock() )

   end

Return ( nil )



STATIC FUNCTION SearchFact( oBrw )

   local oDlg
   local xToSearch
   local nNumFac  := 0
   local cCodCli  := (D():FacturasProveedores( nView ))->CCODPRV
   local dFactura := date()
   local nIndex   := (D():FacturasProveedores( nView ))->(OrdNumber())

   oDlg = TDialog():New(,,,,, "FINFACPRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







      TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nNumFac, nNumFac:= u ) }, oDlg,, "999999999", {||    ( xToSearch := nNumFac, .T. )}, "N/W*",,,,, .F., {||     ( nIndex == 1 )},, .F., .F.,,,,,, nil,,, )






      TGetHlp():ReDefine( 140, { | u | If( PCount()==0, dFactura, dFactura:= u ) }, oDlg,,, {||    ( xToSearch := dFactura, .T. )}, "N/W*",,,,, .F., {||     ( nIndex == 2 )},, .F., .F.,,,,,, nil,,, )






      TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cCodCli, cCodCli:= u ) }, oDlg,,, {||    ( xToSearch := cCodCli, .T. )}, "N/W*",,,,, .F., {||     ( nIndex == 3 )},, .F., .F.,,,,,, nil,,, )




      TButton():ReDefine( 504, {||( (D():FacturasProveedores( nView ))->( dbSeek( xToSearch ) ), oBrw:Refresh() )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 510, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN NIL



STATIC FUNCTION EPage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
   private lEnd         := oInf:lFinish





   PrintItems( cCodDoc, oInf )

RETURN NIL



STATIC FUNCTION lHideCheck1Contabilidad()

   do case
      case lAplicacionA3()
         Return ( .T. )

      case lAplicacionMonitor()
         Return ( .T. )

      case lAplicacionSage50()
         Return ( .T. )

   end

Return ( .F. )



STATIC FUNCTION lHideCheck2Contabilidad()

   do case

      case lAplicacionMonitor()
         Return ( .T. )

      case lAplicacionSage50()
         Return ( .T. )

   end

Return ( .F. )



STATIC FUNCTION actionContabilidad( lChk1, lChk2, oTree )

   do case
      case lAplicacionContaplus() .OR. lAplicacionA3()
         CntFacPrv( lChk1, lChk2, .T., oTree, nil, nil, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ), D():FacturasProveedoresPagos( nView ), D():Proveedores( nView ), D():Divisas( nView ), D():Articulos( nView ), D():FormasPago( nView ), D():TiposIva( nView ) )

      case lAplicacionMonitor()
         EnlaceMonitor():GetInstance():ContabilizaFacturaProveedor( nView, oTree )

      case lAplicacionSage()
         MsgStop( "Opción desabilitada para sage" )

      case lAplicacionSage50()
         EnlaceSage50():GetInstance():ContabilizaFacturaProveedor( nView, oTree )


   end

Return ( .T. )



STATIC FUNCTION postActionContabilidad()

   do case
      case lAplicacionA3()
         EnlaceA3():GetInstance():WriteASCII()
         EnlaceA3():DestroyInstance()

      case lAplicacionMonitor()
         EnlaceMonitor():GetInstance():WriteASCII()
         EnlaceMonitor():DestroyInstance()

      case lAplicacionSage50()
         EnlaceSage50():GetInstance():WriteASCII()
         EnlaceSage50():DestroyInstance()

   end

Return ( .T. )



STATIC FUNCTION aGetSelRec( oBrw, bAction, cTitle, lHide1, cTitle1, lHide2, cTitle2, bPreAction, bPostAction )

   local oDlg
   local oBtn
   local oBtnCancel
   local oRad
   local nRad        := 1
   local aRet        := {}
   local oTree
   local oChk1
   local oChk2
   local lChk1       := .T.
   local lChk2       := .T.
   local nRecno      := ( D():FacturasProveedores( nView ) )->( Recno() )
   local nOrdAnt     := ( D():FacturasProveedores( nView ) )->( OrdSetFocus( 1 ) )
   local oSerIni
   local oSerFin
   local cSerIni     := ( D():FacturasProveedores( nView ) )->cSerFac
   local cSerFin     := ( D():FacturasProveedores( nView ) )->cSerFac
   local oDocIni
   local oDocFin
   local nDocIni     := ( D():FacturasProveedores( nView ) )->nNumFac
   local nDocFin     := ( D():FacturasProveedores( nView ) )->nNumFac
   local oSufIni
   local oSufFin
   local cSufIni     := ( D():FacturasProveedores( nView ) )->cSufFac
   local cSufFin     := ( D():FacturasProveedores( nView ) )->cSufFac
   local oMtrInf
   local nMtrInf
   local lFechas     := .T.
   local dDesde      := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dHasta      := Date()
   local oImageList

   If( cTitle == nil, cTitle := "", ) ;
   If( lHide1 == nil, lHide1 := .F., ) ;
   If( cTitle1 == nil, cTitle1 := "", ) ;
   If( lHide2 == nil, lHide2 := .F., ) ;
   If( cTitle2 == nil, cTitle2 := "", ) ;

   oImageList        := TImageList():New( 16, 16 )
   oImageList:AddMasked( TBitmap():Define( "gc_delete_12" ),    ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   oImageList:AddMasked( TBitmap():Define( "gc_check_12" ),  ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )

   oDlg = TDialog():New(,,,, cTitle, "SelectRango",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



   oRad := TRadMenu():Redefine( { | u | If( PCount()==0, nRad, nRad:= u ) }, oDlg,, { 80, 81 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 101, "Up16",,,,, {|Self|( dbFirst( D():FacturasProveedores( nView ), "nNumFac", oDocIni, cSerIni, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 111, "Down16",,,,, {|Self|( dbLast( D():FacturasProveedores( nView ), "nNumFac", oDocFin, cSerFin, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )






   oDocIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )






   oDocFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )





   oSufIni := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )





   oSufFin := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )



   oChk1 := TCheckBox():ReDefine( 160, { | u | If( PCount()==0, lChk1, lChk1:= u ) }, oDlg,,,,,,, .F.,, .F. )



   oChk2 := TCheckBox():ReDefine( 180, { | u | If( PCount()==0, lChk2, lChk2:= u ) }, oDlg,,,,,,, .F.,, .F. )







   TCheckBox():ReDefine( 300, { | u | If( PCount()==0, lFechas, lFechas:= u ) }, oDlg,,,,,,, .F.,, .F. )





   TGetHlp():ReDefine( 310, { | u | If( PCount()==0, dDesde, dDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 320, { | u | If( PCount()==0, dHasta, dHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





   oTree             := TTreeView():Redefine( 170, oDlg )
   oTree:bLDblClick  := {|| TreeChanged( oTree ) }





   oMtrInf := TApoloMeter():ReDefine( 200, { | u | If( PCount()==0, nMtrInf, nMtrInf:= u ) },, oDlg, .F.,,, .T.,,,, )

   oMtrInf:SetTotal( ( D():FacturasProveedores( nView ) )->( OrdKeyCount() ) )




   oBtn := TButton():ReDefine( 1, {||( MakSelRec( bAction, bPreAction, bPostAction, cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oBtnCancel, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ), oTree, oBrw, oMtrInf ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart := {|| StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 ) }

   oDlg:AddFastKey( 116, {|| oBtn:Click() } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oTree:SetImageList( oImageList ) )}, oDlg:bRClicked,,, )

   ( D():FacturasProveedores( nView ) )->( ordSetFocus( nOrdAnt ) )
   ( D():FacturasProveedores( nView ) )->( dbGoTo( nRecNo ) )

   oImageList:End()

   oTree:Destroy()

   oBrw:SetFocus()
   oBrw:Refresh()

RETURN ( aRet )



Static Function StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 )

   if !empty( oBrw ) .AND. ( len( oBrw:oBrw:aSelected ) > 1 )

      oRad:SetOption( 1 )

   else

      oRad:SetOption( 2 )

      oSerIni:Enable()
      oSerFin:Enable()
      oDocIni:Enable()
      oDocFin:Enable()
      oSufIni:Enable()
      oSufFin:Enable()

   end

   if lHide1
      oChk1:Hide()
   else
      SetWindowText( oChk1:hWnd, cTitle1 )
      oChk1:Refresh()
   end

   if lHide2
      oChk2:Hide()
   else
      SetWindowText( oChk2:hWnd, cTitle2 )
      oChk2:Refresh()
   end

Return ( nil )



Static Function TreeChanged( oTree )

   local oItemTree   := oTree:GetItem()

   if !empty( oItemTree ) .AND. !empty( oItemTree:bAction )
      Eval( oItemTree:bAction )
   end

RETURN NIL



static function MakSelRec( bAction, bPreAction, bPostAction, cDocIni, cDocFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oBtnCancel, cFacPrvT, cFacPrvL, oTree, oBrw, oMtrInf )

   local n        := 0
   local nPos     := 0
   local nRec     := ( D():FacturasProveedores( nView ) )->( Recno() )
   local aPos
   local lPre
   local lRet
   local lWhile   := .T.





   if lChk1
      aPos        := { 0, 0 }
      ClientToScreen( oDlg:hWnd, aPos )
      oDlg:Move( aPos[ 1 ] - 26, aPos[ 2 ] - 510 )
   end





   oDlg:Disable()

   oTree:Enable()
   oTree:DeleteAll()

   oBtnCancel:bAction   := {|| lWhile := .F. }
   oBtnCancel:Enable()

   if !empty( bPreAction )
      lPre              := Eval( bPreAction )
   end

   if !IsLogic( lPre ) .OR. lPre

      if ( nRad == 1 )

         for each nPos in ( oBrw:oBrw:aSelected )

            ( D():FacturasProveedores( nView ) )->( dbGoTo( nPos ) )

            if lFechas .OR.( ( D():FacturasProveedores( nView ) )->dFecFac >= dDesde .AND. ( D():FacturasProveedores( nView ) )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ) )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ++n )

            SysRefresh()

            if !lWhile
               exit
            end

         next

      else

         ( D():FacturasProveedores( nView ) )->( dbSeek( cDocIni, .T. ) )




         while ( lWhile )                                                                                         .AND. ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac, 9 ) + ( D():FacturasProveedores( nView ) )->cSufFac >= cDocIni   .AND.  ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac, 9 ) + ( D():FacturasProveedores( nView ) )->cSufFac <= cDocFin   .AND.  !( D():FacturasProveedores( nView ) )->( eof() )

            if lFechas .OR.( ( D():FacturasProveedores( nView ) )->dFecFac >= dDesde .AND. ( D():FacturasProveedores( nView ) )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ) )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ( D():FacturasProveedores( nView ) )->( OrdKeyNo() ) )

            ( D():FacturasProveedores( nView ) )->( dbSkip() )

            SysRefresh()

         end

      end

      if !empty( bPostAction )
         Eval( bPostAction )
      end

   end

   oMtrInf:Set( ( D():FacturasProveedores( nView ) )->( LastRec() ) )

   ( D():FacturasProveedores( nView ) )->( dbGoTo( nRec ) )

   if lChk1
      WndCenter( oDlg:hWnd )
   end

   oBtnCancel:bAction   := {|| oDlg:End() }

   oDlg:Enable()

   if oBrw <> nil
      oBrw:Refresh()
   end

RETURN ( nil )






STATIC FUNCTION ContFactu( lSimula, lPago, oTree )

   local n
   local nAsiento    := 0
   local cCtaVent
   local nPosicion
   local nPosIva
   local dFecha
   local aTotFac
   local nTotFac
   local nTotRet
   local aTotIva
   local cConcepto
   local cConCompr
   local cSubCtaIva
   local cSubCtaReq
   local cRuta
   local cCodEmp
   local nImpDeta
   local nDinDiv     := nDinDiv( ( D():FacturasProveedores( nView ) )->cDivFac, D():Divisas( nView ) )
   local nRinDiv     := nRinDiv( ( D():FacturasProveedores( nView ) )->cDivFac, D():Divisas( nView ) )
   local aSimula     := {}
   local aIva        := {}
   local aVentas     := {}
   local cCodDiv     := ( D():FacturasProveedores( nView ) )->cDivFac
   local cCtaPrv     := cPrvCta( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ) )
   local cCtaPrvVta  := cPrvCtaVta( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ) )
   local nFactura    := ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac
   local cFactura    := ( D():FacturasProveedores( nView ) )->cSerFac + "/" + Ltrim( Str( ( D():FacturasProveedores( nView ) )->nNumFac ) ) + "/" + ( D():FacturasProveedores( nView ) )->cSufFac
   local nNumFac     := ( D():FacturasProveedores( nView ) )->nNumFac
   local cCodPro     := Left( ( D():FacturasProveedores( nView ) )->cCodPro, 3 )
   local cClave      := Right( ( D():FacturasProveedores( nView ) )->cCodPro, 6 )
   local lErrorFound := .F.
   local cTerNif     := ( D():FacturasProveedores( nView ) )->cDniPrv
   local cTerNom     := ( D():FacturasProveedores( nView ) )->cNomPrv
   local lReturn





   if ( D():FacturasProveedores( nView ) )->lContab
      oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " ya contabilizada.", 0 ) )
      lErrorFound    := .T.
   end

   if !ChkRuta( cRutCnt() )
      oTree:Select( oTree:Add( "Factura : " + rtrim( cFactura ) + " ruta no valida.", 0 ) )
      lErrorFound    := .T.
   end





   cRuta             := cRutCnt()
   cCodEmp           := cCodEmpCnt( ( D():FacturasProveedores( nView ) )->cSerFac )

   if empty( cCtaPrvVta )
      cCtaPrvVta     := cCtaPrv()
   end

   if !ChkSubcuenta( cRutCnt(), cCodEmp, cCtaPrv, , .F., .F. )
      oTree:Select( oTree:Add( "Factura : " + rtrim( cFactura ) + " subcuenta " + cCtaPrv + " no encontada.", 0 ) )
      lErrorFound    := .T.
   end





   aTotFac           := aTotFacPrv( nFactura, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ), D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos( nView ) )
   nTotFac           := aTotFac[ 4 ]
   aTotIva           := aTotFac[ 5 ]
   nTotRet           := aTotFac[ 6 ]





   if ( D():FacturasProveedores( nView ) )->lFacGas

      aAdd( aVentas, { ( D():FacturasProveedores( nView ) )->SubCta, aTotFac[ 1 ] } )





      for n := 1 to Len( aTotIva )

         if ( D():FacturasProveedores( nView ) )->nRegIva == 2
            cSubCtaIva  := uFieldEmpresa( "cCtaCeeRpt" )
            cSubCtaReq  := uFieldEmpresa( "cCtaCeeSpt" )
         else
            cSubCtaIva  := cSubCuentaIva(       aTotIva[ n, 3 ], ( D():FacturasProveedores( nView ) )->lRecargo, cRuta, cCodEmp, D():TiposIva( nView ), .F. )
            cSubCtaReq  := cSubCuentaRecargo(   aTotIva[ n, 3 ], ( D():FacturasProveedores( nView ) )->lRecargo, cRuta, cCodEmp, D():TiposIva( nView ) )
         end

         nPosIva        := aScan( aIva, {|x| x[ 1 ] == aTotIva[ n, 3 ] } )
         if nPosIva == 0
            aAdd( aIva, { aTotIva[ n, 3 ], cSubCtaIva, cSubCtaReq, aTotIva[ n, 1 ] } )
         else
            aIva[ nPosIva, 4 ]   += aTotIva[ n, 1 ]
         end

      next

   else





      if ( D():FacturasProveedoresLineas( nView ) )->( dbSeek( nFactura ) )

         while ( ( D():FacturasProveedoresLineas( nView ) )->cSerFac + Str( ( D():FacturasProveedoresLineas( nView ) )->nNumFac ) + ( D():FacturasProveedoresLineas( nView ) )->cSufFac == nFactura .AND. !( D():FacturasProveedoresLineas( nView ) )->( eof() ) )

            nImpDeta       := nTotLFacPrv( D():FacturasProveedoresLineas( nView ), nDinDiv, nRinDiv )

            if nImpDeta <> 0

               cCtaVent    := RetCtaCom( ( D():FacturasProveedoresLineas( nView ) )->cRef, ( nImpDeta < 0 ), D():Articulos( nView ) )
               if empty( cCtaVent )
                  cCtaVent := cCtaPrvVta + RetGrpVta( ( D():FacturasProveedoresLineas( nView ) )->cRef, cRuta, cCodEmp, ( D():FacturasProveedoresLineas( nView ) )->nIva )
               end

               nPosicion   := aScan( aVentas, {|x| x[1] == cCtaVent } )

               if nPosicion == 0
                  aadd( aVentas, { cCtaVent, nImpDeta } )
               else
                  aVentas[ nPosicion, 2 ] += nImpDeta
               end





               if ( D():FacturasProveedores( nView ) )->nRegIva == 2
                  cSubCtaIva  := uFieldEmpresa( "cCtaCeeRpt" )
                  cSubCtaReq  := uFieldEmpresa( "cCtaCeeSpt" )
               else
                  cSubCtaIva  := cSubCuentaIva( ( D():FacturasProveedoresLineas( nView ) )->nIva, ( D():FacturasProveedores( nView ) )->lRecargo, cRuta, cCodEmp, D():TiposIva( nView ), .F. )
                  cSubCtaReq  := cSubCuentaRecargo( ( D():FacturasProveedoresLineas( nView ) )->nIva, ( D():FacturasProveedores( nView ) )->lRecargo, cRuta, cCodEmp, D():TiposIva( nView ) )
               end

               nPosIva        := aScan( aIva, {|x| x[1] == ( D():FacturasProveedoresLineas( nView ) )->nIva } )
               if nPosIva == 0
                  aadd( aIva, { ( D():FacturasProveedoresLineas( nView ) )->nIva, cSubCtaIva, cSubCtaReq, nImpDeta } )
               else
                  aIva[ nPosIva, 4 ]   += nImpDeta
               end

            end

            ( D():FacturasProveedoresLineas( nView ) )->( dbSkip() )

         end

      else

         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " factura sin artículos.", 0 ) )

         lErrorFound    := .T.

      end

   end





   for n := 1 TO Len( aVentas )

      if ( D():FacturasProveedores( nView ) )->nDtoEsp <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( D():FacturasProveedores( nView ) )->nDtoEsp / 100, nRinDiv )
      end

      if ( D():FacturasProveedores( nView ) )->nDpp <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( D():FacturasProveedores( nView ) )->nDpp / 100, nRinDiv )
      end

      if ( D():FacturasProveedores( nView ) )->nDtoUno <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( D():FacturasProveedores( nView ) )->nDtoUno / 100, nRinDiv )
      end

      if ( D():FacturasProveedores( nView ) )->nDtoDos <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( D():FacturasProveedores( nView ) )->nDtoDos / 100, nRinDiv )
      end

   next





   for n := 1 to Len( aIva )

      if ( D():FacturasProveedores( nView ) )->nDtoEsp <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( D():FacturasProveedores( nView ) )->nDtoEsp / 100, nRinDiv )
      end

      if ( D():FacturasProveedores( nView ) )->nDpp <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( D():FacturasProveedores( nView ) )->nDpp / 100, nRinDiv )
      end

      if ( D():FacturasProveedores( nView ) )->nDtoUno <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( D():FacturasProveedores( nView ) )->nDtoUno / 100, nRinDiv )
      end

      if ( D():FacturasProveedores( nView ) )->nDtoDos <> 0
         aIva[ n, 2 ] -= Round( aIva[ n, 4 ] * ( D():FacturasProveedores( nView ) )->nDtoDos / 100, nRinDiv )
      end

   next





   for n := 1 TO len( aVentas )
      if !ChkSubcuenta( cRutCnt(), cCodEmp, aVentas[ n, 1 ], , .F., .F. )
         oTree:Select( oTree:Add( "Factura : " + rtrim( cFactura ) + " subcuenta " + aVentas[ n, 1 ] + " no encontada.", 0 ) )
         lErrorFound    := .T.
      end
   next





   for n := 1 to len( aIva )

      if !ChkSubcuenta( cRuta, cCodEmp, aIva[ n, 2 ], , .F., .F. )
         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " subcuenta " + aIva[ n, 2 ] + " no encontada.", 0 ) )
         lErrorFound    := .T.
      end

      if !ChkSubcuenta( cRuta, cCodEmp, aIva[ n, 3 ], , .F., .F. )
         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " subcuenta " + aIva[ n, 3 ] + " no encontada.", 0 ) )
         lErrorFound    := .T.
      end

   next

   if nTotRet <> 0

      if !ChkSubcuenta( cRuta, cCodEmp, cCtaRet(), , .F., .F. )
         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " subcuenta " + cCtaRet() + " no encontada.", 0 ) )
         lErrorFound    := .T.
      end

   end





   if !ChkFecha( , , ( D():FacturasProveedores( nView ) )->dFecFac, .F. )
      oTree:Select( oTree:Add(  "Factura : " + Rtrim( cFactura ) + " asiento fuera de fechas.", 0 ) )
      lErrorFound    := .T.
   end





   if lSimula .OR. !lErrorFound

      if empty( ( D():FacturasProveedores( nView ) )->dFecEnt )
         dFecha      := ( D():FacturasProveedores( nView ) )->dFecFac
      else
         dFecha      := ( D():FacturasProveedores( nView ) )->dFecEnt
      end

      cConCompr      := "S/Fcta."
      if !empty( ( D():FacturasProveedores( nView ) )->cSuPed )
         nNumFac     := Val( ( D():FacturasProveedores( nView ) )->cSuPed )
         cConCompr   += " N." + Rtrim( ( D():FacturasProveedores( nView ) )->cSuPed )
      elseif !empty( ( D():FacturasProveedores( nView ) )->cNumDoc )
         cConCompr   += " Doc. " + Rtrim( ( D():FacturasProveedores( nView ) )->cNumDoc )
      else
         cConCompr   += " N." + Rtrim( cFactura )
      end
      cConcepto      := cConCompr + Space( 1 ) + DtoC( ( D():FacturasProveedores( nView ) )->dFecFac )
      cConCompr      += Space( 1 ) + Rtrim( ( D():FacturasProveedores( nView ) )->cNomPrv )





      if OpenDiario( , cCodEmp )
         nAsiento    := contaplusUltimoAsiento()
      else
         oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " imposible abrir ficheros de contaplus.", 0 ) )
         return .F.
      end

      setAsientoIntraComunitario( ( D():FacturasProveedores( nView ) )->nRegIva == 2 )

























      aAdd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, cCtaPrv, , , cConcepto, nTotFac, nNumFac, , , , ( D():FacturasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )





      for n := 1 TO len( aVentas )





















         aAdd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, aVentas[ n, 1 ], , aVentas[ n, 2 ], cConCompr, , nNumFac, , , , ( D():FacturasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

      next





      if ( D():FacturasProveedores( nView ) )->nRegIva == 2

         for n := 1 to len( aIva )

            if aIva[ n, 1 ] <> 0 .OR. uFieldEmpresa( "lConIva" )





















               aadd( aSimula, MkAsiento(  nAsiento,  cCodDiv, dFecha,  aIva[ n, 3 ], aIva[ n, 2 ], Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), nNumFac, aIva[ n, 4 ], aIva[ n, 1 ], If( ( D():FacturasProveedores( nView ) )->lRecargo, nPReq( D():TiposIva( nView ), aIva[ n, 1 ] ), 0 ), ( D():FacturasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

            end

         next

      else

         for n := 1 to len( aIva )

            if aIva[ n, 1 ] <> 0 .OR. uFieldEmpresa( "lConIva" )





















               aadd( aSimula, MkAsiento(  nAsiento,  cCodDiv, dFecha,  aIva[ n, 2 ], cCtaPrv, Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, , nNumFac, aIva[ n, 4 ], aIva[ n, 1 ], If( ( D():FacturasProveedores( nView ) )->lRecargo, nPReq( D():TiposIva( nView ), aIva[ n, 1 ] ), 0 ), ( D():FacturasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

            end

         next





         if ( D():FacturasProveedores( nView ) )->lRecargo

            for n := 1 to len( aIva )

               if aIva[ n, 1 ] <> 0 .OR. uFieldEmpresa( "lConIva" )





















                  aadd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, aIva[ n, 3 ], , Round( nPReq( D():TiposIva( nView ), aIva[ n, 1 ] ) * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, , nNumFac, , , , ( D():FacturasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

               end

            next

         end

      end





      if nTotRet <> 0





















         aadd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, cCtaRet(), , , cConCompr, nTotRet, nNumFac, , , , ( D():FacturasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

      end






      if lPago .AND. ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( nFactura ) )

         while ( ( D():FacturasProveedoresPagos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresPagos( nView ) )->nNumFac ) + ( D():FacturasProveedoresPagos( nView ) )->cSufFac = nFactura ) .AND. !( D():FacturasProveedoresPagos( nView ) )->( eof() )

            lReturn  := CntRecPrv( lSimula, oTree, nAsiento, aSimula, .T., D():FacturasRectificativasProveedores( nView ), D():FacturasProveedoresPagos( nView ), D():Proveedores( nView ), D():FormasPago( nView ), D():Divisas( nView ) )

            if IsFalse( lReturn )
               exit
            end

            ( D():FacturasProveedoresPagos( nView ) )->( dbSkip() )

         end

      end





      if !lSimula

         lReturn  := ChgContabilizado( .T., cFactura, nAsiento, oTree )

      else

         lReturn  := msgTblCon( aSimula, cCodDiv, D():Divisas( nView ), !lErrorFound, cFactura, {|| aWriteAsiento( aSimula, cCodDiv, .T., oTree, cFactura, nAsiento ), ChgContabilizado( .T., cFactura, nAsiento, oTree ) } )

      end

      CloseDiario()

      setAsientoIntraComunitario( .F. )

   end

Return ( lReturn )












STATIC FUNCTION GrpAlb( oGet, aTmp, oBrw )

   local oDlg
   local oBmp
   local oTitle
   local oTitle1
   local oTitle2
   local oTitle3
   local oTitle4
   local oTitle5
   local oBrwLin
   local cDetalle    := ""
   local aAlbaranes  := {}
   local nItem       := 1
   local cCodPrv     := oGet:varGet()
   local nOrd        := ( D():AlbaranesProveedores( nView ) )->( ordSetFocus( "CCODPRV" ) )

   if empty( cCodPrv )
      MsgStop( "Es necesario codificar un proveedor" )
      ( D():AlbaranesProveedores( nView ) )->( ordSetFocus( nOrd ) )
      return .T.
   end






   if !( D():AlbaranesProveedores( nView ) )->( dbSeek( cCodPrv ) )
      MsgStop( "No existen albaranes por facturar." )
      return .T.
   end

   while ( ( D():AlbaranesProveedores( nView ) )->cCodPrv = cCodPrv .AND. !( D():AlbaranesProveedores( nView ) )->( eof() ) )

      if D():AlbaranesProveedoresNoFacturado( nView )






         aAdd( aAlbaranes, {  .F., ( D():AlbaranesProveedoresId( nView ) ), ( D():AlbaranesProveedores( nView ) )->cSuAlb  , ( D():AlbaranesProveedores( nView ) )->dFecAlb , ( D():AlbaranesProveedores( nView ) )->cCodPrv , ( D():AlbaranesProveedores( nView ) )->cNomPrv , nTotAlbPrv( D():AlbaranesProveedoresId( nView ), D():AlbaranesProveedores( nView ), D():AlbaranesProveedoresLineas( nView ), D():TiposIva( nView ), D():Divisas( nView ), nil, nil, .T. ) } )

      endif

      (D():AlbaranesProveedores( nView ) )->( DbSkip(1) )

   end





   if Len( aAlbaranes ) == 0
      MsgStop( "No existen albaranes por facturar." )
      Return .T.
   end






   oDlg = TDialog():New(,,,,, "SET_ALBARAN",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





   oBmp := TBitmap():ReDefine( 500, "gc_document_text_gear_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )



   oTitle := TSay():ReDefine( 100, {|| "Proveedor: "}, oDlg,,,, .F.,, .F., .F., )



   oTitle1 := TSay():ReDefine( 110, {|| ""}, oDlg,,,, .F.,, .F., .F., )



   oTitle2 := TSay():ReDefine( 504, {|| ""}, oDlg,,,, .F.,, .F., .F., )



   oTitle3 := TSay():ReDefine( 501, {|| RTrim( aTmp[ 9 ] )}, oDlg,,,, .F.,, .F., .F., )



   oTitle4 := TSay():ReDefine( 502, {|| ""}, oDlg,,,, .F.,, .F., .F., )



   oTitle5 := TSay():ReDefine( 503, {|| ""}, oDlg,,,, .F.,, .F., .F., )

   oBrwLin                       := IXBrowse():New( oDlg )

   oBrwLin:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
   oBrwLin:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

   oBrwLin:SetArray( aAlbaranes, , , .F. )

   oBrwLin:nMarqueeStyle         := 5
   oBrwLin:cName                 := "Factura de proveedor.Agrupar albaranes"

   oBrwLin:bRClicked             := {| nRow, nCol, nFlags | oBrwLin:RButtonDown( nRow, nCol, nFlags ) }

   oBrwLin:CreateFromResource( 130 )

      with object ( oBrwLin:addCol() )
         :cHeader       := "Sl. Seleccionado"
         :bStrData      := {|| "" }
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 1 ] }
         :nWidth        := 18
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Albarán"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 2 ] }
         :cEditPicture  := "@R #/999999999/##"
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Su albarán"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 3 ] }
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Fecha"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 4 ] }
         :nDataStrAlign := 3
         :nHeadStrAlign := 3
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Código"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 5 ] }
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Proveedor"
         :nWidth        := 200
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 6 ] }
      end

      with object ( oBrwLin:AddCol() )
         :cHeader       := "Total"
         :nWidth        := 80
         :bEditValue    := {|| aAlbaranes[ oBrwLin:nArrayAt, 7 ] }
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end

      oBrwLin:bLDblClick      := {|| aAlbaranes[ oBrwLin:nArrayAt, 1 ] := !aAlbaranes[ oBrwLin:nArrayAt, 1 ], oBrwLin:Refresh() }




      TButton():ReDefine( 514, {||( aAlbaranes[ oBrwLin:nArrayAt, 1 ] := !aAlbaranes[ oBrwLin:nArrayAt, 1 ], oBrwLin:Refresh() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 517, {||( aEval( aAlbaranes, { |aItem| aItem[1] := .F. } ), oBrwLin:Refresh() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 516, {||( aEval( aAlbaranes, { |aItem| aItem[1] := .T. } ), oBrwLin:Refresh() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 1, {||( oDlg:End( 1 ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   CursorWait()





   ( D():AlbaranesProveedores( nView ) )->( ordSetFocus( 1 ) )

   if oDlg:nResult == 1

      for nItem := 1 to Len( aAlbaranes )

         if aAlbaranes[ nItem, 1 ]

            aNumAlb:Add( aAlbaranes[ nItem, 2 ] )

            if ( D():AlbaranesProveedoresLineas( nView ) )->( dbSeek( aAlbaranes[ nItem, 2 ] ) )

               cDetalle                := "Albaran Nº" + ( D():AlbaranesProveedoresLineas( nView ) )->cSerAlb + "/" + AllTrim( Str( ( D():AlbaranesProveedoresLineas( nView ) )->nNumAlb ) ) + "/" + Rtrim( ( D():AlbaranesProveedoresLineas( nView ) )->cSufAlb )
               if !empty( Alltrim( aAlbaranes[ nItem, 3 ] ) )
                  cDetalle             += " - " + Alltrim( aAlbaranes[ nItem, 3 ] )
               end
               cDetalle                += " - Fecha " + Dtoc( aAlbaranes[ nItem, 4 ] )

               ( dbfTmp )->( dbAppend() )

               ( dbfTmp )->cDetalle    := cDetalle
               ( dbfTmp )->lControl    := .T.
               ( dbfTmp )->nNumLin     := nLastNum(  dbfTmp )
               ( dbfTmp )->nPosPrint   := nLastNum(  dbfTmp, "nPosPrint" )

               AddLineasAlbaranProveedor( aAlbaranes[ nItem, 2 ], .T. )

            end





            oBrw:Refresh()

         end

      next






      nTotFacPrv( nil, D():FacturasProveedores( nView ), dbfTmp, D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos( nView ), aTmp )

   end

   ( D():AlbaranesProveedores( nView ) )->( ordSetFocus( nOrd ) )





   oBrwLin:CloseData()

   CursorWE()

RETURN .T.







STATIC FUNCTION cAlbPrv( aGet, oBrw, nMode, aTmp )

   local lValid   := .F.
   local cAlbaran := aGet[ 26 ]:varGet()

   if nMode <> 1 .OR. empty( cAlbaran )
      return .T.
   end

   if ( D():AlbaranesProveedores( nView ) )->( dbSeek( cAlbaran ) )

      if ( D():AlbaranesProveedoresFacturado( nView ) )

         MsgStop( "Albaran facturado" )
         lValid   := .F.

      else

         aGet[ 1 ]:cText( ( D():AlbaranesProveedores( nView ) )->cSerAlb )

         aGet[ 6 ]:cText( ( D():AlbaranesProveedores( nView ) )->cCodPrv )
         aGet[ 6 ]:lValid()

         aGet[ 7 ]:cText( ( D():AlbaranesProveedores( nView ) )->cCodAlm )
         aGet[ 7 ]:lValid()

         aGet[ 85 ]:cText( ( D():AlbaranesProveedores( nView ) )->cAlmOrigen )
         aGet[ 85 ]:lValid()

         aGet[ 8 ]:cText( ( D():AlbaranesProveedores( nView ) )->cCodCaj )
         aGet[ 8 ]:lValid()

         aGet[ 23]:cText( ( D():AlbaranesProveedores( nView ) )->cCodPgo )
         aGet[ 23]:lValid()

         aGet[ 29 ]:cText( ( D():AlbaranesProveedores( nView ) )->cDtoEsp )
         aGet[ 30 ]:cText( ( D():AlbaranesProveedores( nView ) )->nDtoEsp )

         aGet[ 31    ]:cText( ( D():AlbaranesProveedores( nView ) )->cDpp )
         aGet[ 32    ]:cText( ( D():AlbaranesProveedores( nView ) )->nDpp )

         aGet[ 39 ]:cText( ( D():AlbaranesProveedores( nView ) )->cDtoUno )
         aGet[ 40 ]:cText( ( D():AlbaranesProveedores( nView ) )->nDtoUno )

         aGet[ 41 ]:cText( ( D():AlbaranesProveedores( nView ) )->cDtoDos )
         aGet[ 42 ]:cText( ( D():AlbaranesProveedores( nView ) )->nDtoDos )

         aGet[ 56 ]:nOption( Max( ( D():Proveedores( nView ) )->nRegIva, 1 ) )
         aGet[ 56 ]:Refresh()

         aGet[ 84 ]:cText( ( D():AlbaranesProveedores( nView ) )->cCtrCoste )
         aGet[ 84 ]:lValid()

         aGet[ 20 ]:cText( ( D():AlbaranesProveedores( nView ) )->cObserv )

         aGet[ 46 ]:cText( ( D():AlbaranesProveedores( nView ) )->cSuAlb )





         addLineasAlbaranProveedor( cAlbaran )





         oBrw:Refresh()





         setFacturadoAlbaranProveedorCabecera( .T., nView )

      end

      aGet[ 26 ]:bWhen           := {|| .F. }





      aNumAlb:Add( cAlbaran )

   else

      MsgStop( "Albaran no encontrado." )

   end

   nTotFacPrv( nil, D():FacturasProveedores( nView ), dbfTmp, D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos( nView ), aTmp )

RETURN lValid



STATIC FUNCTION BeginTrans( aTmp, nMode )

   local oError
   local oBlock
   local lErrors  := .F.
   local cDbf     := "FPrvL"
   local cDbfInc  := "FPrvI"
   local cDbfDoc  := "FPrvD"
   local cDbfPgo  := "FPrvP"
   local cDbfSer  := "FPrvS"
   local nFactura := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]

   oBlock         := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      TComercio:resetProductsToUpdateStocks()

      CursorWait()

      aNumAlb:Init()

      cNewFile    := cGetNewFileName( cPatTmp() + cDbf )
      cTmpInc     := cGetNewFileName( cPatTmp() + cDbfInc )
      cTmpDoc     := cGetNewFileName( cPatTmp() + cDbfDoc )
      cTmpPgo     := cGetNewFileName( cPatTmp() + cDbfPgo )
      cTmpSer     := cGetNewFileName( cPatTmp() + cDbfSer )





      dbCreate( cNewFile, aSqlStruct( aColFacPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFile, cCheckArea( cDbf, @dbfTmp ), .F. )

      if !( dbfTmp )->( neterr() )
         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )

         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "nPosPrint", "Str( nPosPrint, 4 )", {|| Str( Field->nPosPrint ) } ) )

      end





      oLinDetCamposExtra:initArrayValue()

      if ( D():FacturasProveedoresLineas( nView ) )->( dbSeek( nFactura ) )
         while ( ( D():FacturasProveedoresLineas( nView ) )->CSERFAC + Str( ( D():FacturasProveedoresLineas( nView ) )->NNUMFAC ) + ( D():FacturasProveedoresLineas( nView ) )->CSUFFAC == nFactura .AND. !( D():FacturasProveedoresLineas( nView ) )->( eof() ) )
            dbPass( D():FacturasProveedoresLineas( nView ), dbfTmp, .T. )
            oLinDetCamposExtra:SetTemporalLines( ( dbfTmp )->cSerFac + str( ( dbfTmp )->nNumFac ) + ( dbfTmp )->cSufFac + str( ( dbfTmp )->nNumLin ), ( dbfTmp )->( OrdKeyNo() ), nMode )
            ( D():FacturasProveedoresLineas( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmp )->( dbGoTop() )





      dbCreate( cTmpInc, aSqlStruct( aIncFacPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )
      if !( dbfTmpInc )->( neterr() )
         ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpInc )->( ordCreate( cTmpInc, "Recno", "Recno()", {|| Recno() } ) )
      end





      if ( nMode <> 4 ) .AND. ( D():FacturasProveedoresIncidencias( nView ) )->( dbSeek( nFactura ) )
         while ( ( D():FacturasProveedoresIncidencias( nView ) )->cSerie + Str( ( D():FacturasProveedoresIncidencias( nView ) )->nNumFac ) + ( D():FacturasProveedoresIncidencias( nView ) )->cSufFac == nFactura ) .AND. ( D():FacturasProveedoresIncidencias( nView ) )->( !eof() )
            dbPass( D():FacturasProveedoresIncidencias( nView ), dbfTmpInc, .T. )
            ( D():FacturasProveedoresIncidencias( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpInc )->( dbGoTop() )





      dbCreate( cTmpDoc, aSqlStruct( aFacPrvDoc() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )
      if !( dbfTmpDoc )->( neterr() )
         ( dbfTmpDoc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpDoc )->( ordCreate( cTmpDoc, "Recno", "Recno()", {|| Recno() } ) )
      end





      if ( nMode <> 4 ) .AND. ( D():FacturasProveedoresDocumentos( nView ) )->( dbSeek( nFactura ) )
         while ( ( D():FacturasProveedoresDocumentos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresDocumentos( nView ) )->nNumFac ) + ( D():FacturasProveedoresDocumentos( nView ) )->cSufFac == nFactura ) .AND. ( D():FacturasProveedoresDocumentos( nView ) )->( !eof() )
            dbPass( D():FacturasProveedoresDocumentos( nView ), dbfTmpDoc, .T. )
            ( D():FacturasProveedoresDocumentos( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpDoc )->( dbGoTop() )





      dbCreate( cTmpSer, aSqlStruct( aSerFacPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpSer, cCheckArea( cDbf, @dbfTmpSer ), .F. )

      if !( dbfTmpSer )->( neterr() )
         ( dbfTmpSer )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpSer )->( OrdCreate( cTmpSer, "nNumLin", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin, 4 ) + Field->cRef } ) )
      end





      if ( nMode <> 4 ) .AND. ( D():FacturasProveedoresSeries( nView ) )->( dbSeek( nFactura ) )
         while ( ( D():FacturasProveedoresSeries( nView ) )->cSerFac + Str( ( D():FacturasProveedoresSeries( nView ) )->nNumFac ) + ( D():FacturasProveedoresSeries( nView ) )->cSufFac == nFactura .AND. !( D():FacturasProveedoresSeries( nView ) )->( eof() ) )
            dbPass( D():FacturasProveedoresSeries( nView ), dbfTmpSer, .T. )
            ( D():FacturasProveedoresSeries( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpSer )->( dbGoTop() )





      dbCreate( cTmpPgo, aSqlStruct( aItmRecPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpPgo, cCheckArea( cDbfPgo, @dbfTmpPgo ), .F. )
      if !( dbfTmpPgo )->( neterr() )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "cRecDev", "cRecDev", {|| Field->cRecDev } ) )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumRec )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumRec ) }, ) )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "Recno", "Recno()", {|| Recno() } ) )

      end





      if ( nMode <> 4 ) .AND. ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( nFactura ) ) .AND. nMode <> 4
         while ( ( D():FacturasProveedoresPagos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresPagos( nView ) )->nNumFac ) + ( D():FacturasProveedoresPagos( nView ) )->cSufFac == nFactura ) .AND. ( D():FacturasProveedoresPagos( nView ) )->( !eof() )
            dbPass( D():FacturasProveedoresPagos( nView ), dbfTmpPgo, .T. )
            ( D():FacturasProveedoresPagos( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpPgo )->( dbGoTop() )

      oDetCamposExtra:SetTemporal( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "", nMode )

      CursorWE()

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

RETURN ( lErrors )



STATIC FUNCTION EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDec, oDlg )

   local aTbl
   local nItem
   local nNumLin
   local cSerFac
   local nNumNFC
   local nNumFac
   local cSufFac
   local dFecFac
   local cNumAlb
   local oError
   local oBlock

   if empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   nNumLin              := 1
   cSerFac              := aTmp[ 1 ]
   nNumFac              := aTmp[ 2 ]
   cSufFac              := aTmp[ 3 ]
   dFecFac              := aTmp[ 5 ]





   if !lValidaOperacion( aTmp[ 5 ] )
      Return .F.
   end

   if !lValidaSerie( aTmp[ 1 ] )
      Return .F.
   end





   if empty( aTmp[ 6 ] )
      msgStop( "Proveedor no puede estar vacío." )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 7 ] )
      msgStop( "Almacen no puede estar vacío." )
      aGet[ 7 ]:SetFocus()
      return .F.
   end

   if ( aTmp[ 7 ] == aTmp[ 85 ] )
      msgStop( "Almacén origen debe ser distinto al almacén destino" )
      aGet[ 85 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 8 ] )
      msgStop( "Caja no puede estar vacía." )
      aGet[ 8 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 23 ] )
      msgStop( "Forma de pago no puede estar vacía." )
      aGet[ 23 ]:SetFocus()
      return .F.
   end

   if !aTmp[ 57 ] .AND. ( dbfTmp )->( lastrec() ) == 0
      MsgStop( "No puede almacenar un documento sin líneas." )
      return .F.
   end





   CursorWait()

   oDlg:Disable()

   oMsgText( "Archivando" )

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   BeginTransaction()





   aTmp[ 53 ]  := GetSysDate()
   aTmp[ 54 ]  := Time()





   do case
   case isAppendOrDuplicateMode( nMode )

      oMsgText( "Obteniendo contadores" )

      nNumFac           := nNewDoc( cSerFac, D():FacturasProveedores( nView ), "NFACPRV", , D():Contadores( nView ) )
      aTmp[ 2 ]  := nNumFac
      cSufFac           := retSufEmp()
      aTmp[ 3 ]  := cSufFac

      aTmp[ 28 ]  := !aNumAlb:empty() .OR. !empty( aTmp[ 26 ] )

   case isEditMode( nMode )

      oMsgText( "Eliminando información anterior" )

      while ( D():FacturasProveedoresLineas( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) ) .AND. !( D():FacturasProveedoresLineas( nView ) )->( eof() )

         aNumAlb:Add( getNumeroAlbaranProveedorLinea( nView ) )

         TComercio:appendProductsToUpadateStocks( ( D():FacturasProveedoresLineas( nView ) )->cRef, nView )

         setNoFacturadoAlbaranProveedorLinea( nView )

         dbLockDelete( D():FacturasProveedoresLineas( nView ) )

      end

      oMsgText( "Eliminando incidencias anteriores" )

      while ( D():FacturasProveedoresIncidencias( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) ) .AND. !( D():FacturasProveedoresIncidencias( nView ) )->( eof() )
         dbLockDelete( D():FacturasProveedoresIncidencias( nView ) )
      end

      oMsgText( "Eliminando documentos anterior" )

      while ( D():FacturasProveedoresDocumentos( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) ) .AND. !( D():FacturasProveedoresDocumentos( nView ) )->( eof() )
         dbLockDelete( D():FacturasProveedoresDocumentos( nView ) )
      end

      oMsgText( "Eliminando pagos anterior" )

      while ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) ) .AND. !( D():FacturasProveedoresPagos( nView ) )->( eof() )
         dbLockDelete( D():FacturasProveedoresPagos( nView ) )
      end

      oMsgText( "Eliminando series anterior" )

      while ( D():FacturasProveedoresSeries( nView ) )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) ) .AND. !( D():FacturasProveedoresSeries( nView ) )->( eof() )
         dbLockDelete( D():FacturasProveedoresSeries( nView ) )
      end

   end



   ( dbfTmp )->( dbClearFilter() )

   oMsgText( "Escribiendo cabecera de documento" )
   oMsgProgress()
   oMsgProgress():SetRange( 0, ( dbfTmp )->( LastRec() ) )



   ( dbfTmp )->( dbGoTop() )
   while !( dbfTmp )->( eof() )

      aTbl                 := dbScatter( dbfTmp )
      aTbl[ 1 ]     := cSerFac
      aTbl[ 2 ]     := nNumFac
      aTbl[ 3 ]     := cSufFac
      aTbl[ 14 ]     := .F.
      aTbl[ 19 ]     := nNetUFacPrv( aTbl, aTmp, nDinDiv, nRinDiv )

      if empty( aTbl[ 93 ] )
         aTbl[ 93 ] := aTmp[ 5 ]
      end

      if empty( aTbl[ 102 ] )
         aTbl[ 102 ] := aTmp[ 83 ]
      end





      appendReferenciaProveedor( aTbl[ 5 ], aTmp[ 6 ], aTbl[ 4 ], aTbl[ 16 ], aTbl[ 17 ], aTmp[ 36 ], aTbl[ 7 ], D():ProveedorArticulo( nView ), nMode )

      appendPropiedadesArticulos( aTbl, aTmp )





      if ( D():Articulos( nView ) )->( dbSeek( ( dbfTmp )->cRef ) ) .AND. ( dbfTmp )->lChgLin
         CambioPrecio( aTmp[ 5 ], D():Articulos( nView ), dbfTmp )
      end

      dbGather( aTbl, D():FacturasProveedoresLineas( nView ), .T. )

      oLinDetCamposExtra:saveExtraField( cSerFac + Str( nNumFac ) + cSufFac + Str( ( dbfTmp )->nNumLin ), ( dbfTmp )->( OrdKeyNo() ) )

      setFacturadoAlbaranProveedorLinea( cSerFac, nNumFac, cSufFac, nView )

      TComercio:appendProductsToUpadateStocks( ( dbfTmp )->cRef, nView )

      ( dbfTmp )->( dbSkip() )

      oMsgProgress():Deltapos(1)

   end





   oMsgText( "Escribiendo incidencias")

   ( dbfTmpInc )->( dbGoTop() )
   while ( dbfTmpInc )->( !eof() )
      dbPass( dbfTmpInc, D():FacturasProveedoresIncidencias( nView ), .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpInc )->( dbSkip() )
   end





   oMsgText( "Escribiendo documentos")

   ( dbfTmpDoc )->( dbGoTop() )
   while ( dbfTmpDoc )->( !eof() )
      dbPass( dbfTmpDoc, D():FacturasProveedoresDocumentos( nView ), .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpDoc )->( dbSkip() )
   end





   oMsgText( "Escribiendo series")

   ( dbfTmpSer )->( dbGoTop() )
   while ( dbfTmpSer )->( !eof() )
      dbPass( dbfTmpSer, D():FacturasProveedoresSeries( nView ), .T., cSerFac, nNumFac, cSufFac, dFecFac )
      ( dbfTmpSer )->( dbSkip() )
   end





   oMsgText( "Escribiendo pagos" )

   ( dbfTmpPgo )->( dbGoTop() )
   while ( dbfTmpPgo )->( !eof() )

      if ( dbfTmpPgo )->cCodPrv <> aTmp[ 6 ]
         ( dbfTmpPgo )->cCodPrv := aTmp[ 6 ]
      end

      if ( dbfTmpPgo )->cNomPrv <> aTmp[ 9 ]
         ( dbfTmpPgo )->cNomPrv := aTmp[ 9 ]
      end

      ( dbfTmpPgo )->( dbSkip() )

   end





   ( dbfTmpPgo )->( dbGoTop() )
   while ( dbfTmpPgo )->( !eof() )

      if !empty( aTmp[ 84 ] )
         ( dbfTmpPgo )->cCtrCoste := aTmp[ 84 ]
      endif

      dbPass( dbfTmpPgo, D():FacturasProveedoresPagos( nView ), .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpPgo )->( dbSkip() )
   end



   aTmp[ 68 ]  := nTotNet
   aTmp[ 74 ]  := nTotSup
   aTmp[ 69 ]  := nTotIva
   aTmp[ 70 ]  := nTotReq
   aTmp[ 71 ]  := nTotFac





   oDetCamposExtra:saveExtraField( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "" )



   oMsgText( "Escribiendo cabecera de documento" )

   WinGather( aTmp, , D():FacturasProveedores( nView ), , nMode )



   CommitTransaction()



   oMsgText( "Generando pagos" )

   GenPgoFacPrv( cSerFac + Str( nNumFac ) + cSufFac, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ), D():FacturasProveedoresPagos( nView ), D():Proveedores( nView ), D():TiposIva( nView ), D():FormasPago( nView ), D():Divisas( nView ) )



   oMsgText( "Actualiza estado de albaranes" )

   aEval( aNumAlb:Get(), {|cNumAlb| setEstadoAlbaranProveedor( cNumAlb, nView ) } )

   if isAppendMode( nMode )
      aEval( aNumAlb:Get(), {|cNumAlb| RollBackAlbPrvFromFacPrv( cNumAlb, nView ) } )
   end

   RECOVER USING oError

      RollBackTransaction()

      msgStop( ErrorMessage( oError ), "Imposible almacenar documentos"  )

   end
   ErrorBlock( oBlock )

   oMsgText()
   EndProgress()

   TComercio:updateWebProductStocks()

   oDlg:Enable()
   oDlg:End( 1 )



   runEventScript( "FacturasProveedores\afterSave", cSerFac + Str( nNumFac ) + cSufFac, nMode, nView, oStock )

   CursorWE()

RETURN .T.



STATIC FUNCTION KillTrans( oBrwLin )





   if !empty( dbfTmp ) .AND. ( dbfTmp )->( Used() )
      ( dbfTmp )->( dbCloseArea() )
   end

   if !empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !empty( dbfTmpPgo ) .AND. ( dbfTmpPgo )->( Used() )
      ( dbfTmpPgo )->( dbCloseArea() )
   end

   if !empty( dbfTmpSer ) .AND. ( dbfTmpSer )->( Used() )
      ( dbfTmpSer )->( dbCloseArea() )
   end

   dbfTmp            := nil
   dbfTmpInc         := nil
   dbfTmpDoc         := nil
   dbfTmpPgo         := nil
   dbfTmpSer         := nil

   dbfErase( cNewFile )
   dbfErase( cTmpInc  )
   dbfErase( cTmpDoc  )
   dbfErase( cTmpPgo  )
   dbfErase( cTmpSer  )

   aNumAlb:Init()

   if !empty( oMnuRec )
      oMnuRec:End()
   end

   if oBrwLin <> nil
      oBrwLin:CloseData()
   end

RETURN NIL



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "FACPRVT.DBF", cLocalDriver() )
      dbCreate( cPath + "FACPRVT.DBF", aSqlStruct( aItmFacPrv() ), cLocalDriver() )
   end
   if !lExistTable( cPath + "FACPRVL.DBF", cLocalDriver() )
      dbCreate( cPath + "FACPRVL.DBF", aSqlStruct( aColFacPrv() ), cLocalDriver() )
   end
   if !lExistTable( cPath + "FACPRVI.DBF", cLocalDriver() )
      dbCreate( cPath + "FACPRVI.DBF", aSqlStruct( aIncFacPrv() ), cLocalDriver() )
   end
   if !lExistTable( cPath + "FACPRVD.DBF", cLocalDriver() )
      dbCreate( cPath + "FACPRVD.DBF", aSqlStruct( aFacPrvDoc() ), cLocalDriver() )
   end
   if !lExistTable( cPath + "FACPRVS.DBF", cLocalDriver() )
      dbCreate( cPath + "FACPRVS.DBF", aSqlStruct( aSerFacPrv() ), cLocalDriver() )
   end

RETURN NIL







STATIC FUNCTION ChgContabilizado( lContabilizado, cFactura, nAsiento, oTree )

   local lReturn  := .T.

   if dbDialogLock( D():FacturasProveedores( nView ) )
      ( D():FacturasProveedores( nView ) )->lContab := lContabilizado
      ( D():FacturasProveedores( nView ) )->( dbUnlock() )
   else
      lReturn     := .F.
   end

   if !empty( oTree )
      oTree:Select( oTree:Add( "Factura : " + Rtrim( cFactura ) + " asiento generado num. " + Alltrim( Str( nAsiento ) ), 1 ) )
   end

Return ( lReturn )



STATIC FUNCTION ImpFactura( oBrw, aGet, aTmp )

   local oDlg
   local oBrwFac
   local oGetDes
   local cGetDes
   local cSelFac  := ""
   local aLinFac  := {}

   local nChgDiv  := aTmp[ 37 ]

   IF empty( aGet[ 6 ]:varGet() )
      msgStop( "Es necesario codificar un proveedor" )
      RETURN .T.
   end

   oDlg = TDialog():New(,,,,, "IMPFACPRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







      oGetDes := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cGetDes, cGetDes:= u ) }, oDlg,,, {||    ( loadFac( cGetDes, oBrwFac, @aLinFac ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( oGetDes:cText( cGetFile( "*.dat", "Seleccione el fichero de la factura" ) ) )}, nil, "LUPA",, )





      oBrwFac := TListBox():ReDefine( 120, { | u | If( PCount()==0, cSelFac, cSelFac:= u ) }, {},, oDlg,,,,,,,,, .F.,, )





      TButton():ReDefine( 1, {||(  appdFac( aGet, cSelFac, oBrwFac:aItems, aLinFac, nChgDiv ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN NIL







STATIC FUNCTION loadFac( cGetDes, oBrwFac, aLinFac )

   local a1
   local a2
   local cIni
   local cSep
   local oText
   local nCont    := 0

   IF empty( cGetDes )
      RETURN .T.
   end

   CursorWait()

   IF file( cGetDes )

      oText          := TTxtFile():New( cGetDes )
      oText:Open()





      aLinFac        := {}
      oBrwFac:reset()





      WHILE !oText:lEof()

         a1 := oText:cGetStr( 6 )
               oText:cGetStr( 1 )
         a2 := oText:cGetStr( 6 )
               oText:cGetStr( 1 )

         ++nCont
         aadd( aLinFac, {} )

         oBrwFac:Add( a1 + space( 1 ) + substr( a2, 1, 2 ) + "/" + substr( a2, 3, 2 ) + "/" + substr( a2, 5, 2 ) )

         WHILE !oText:lEof()





            cIni  := oText:cGetStr( 1 )

            IF cIni == chr( 255 )
               EXIT
            end











            aadd( aLinFac[ nCont ], {  cIni + oText:cGetStr( 5 ), oText:cGetStr( 13 ), oText:cGetStr( 30 ), oText:cGetStr(  7 ), oText:cGetStr(  7 ), oText:cGetStr(  1 ) } )





            cSep  := oText:cGetStr( 1 )

            IF cSep == chr( 254 )
               LOOP
            end

         end

      end

      oText:Close()

   ELSE

      msgStop( "Fichero no encontrado" )

   end

   oBrwFac:setFocus()

   CursorWe()

RETURN .T.







STATIC FUNCTION appdFac( aGet, cSelFac, aSelFac, aLinFac, nChgDiv )

   local n
   local nIva
   local nSelFac

   nSelFac     := AScan( aSelFac, { | cItem | Upper( AllTrim( cItem ) ) == Upper( AllTrim( cSelFac ) ) } )
   if nSelFac  <> 0

      aGet[ 18 ]:cText( substr( cSelFac, 1, 6 ) )

      FOR n := 1 TO len( aLinFac[ nSelFac ] )

         (dbfTmp)->( dbAppend() )

         (dbfTmp)->CREF       := aLinFac[ nSelFac, n, 1 ]
         (dbfTmp)->CDETALLE   := aLinFac[ nSelFac, n, 3 ]
         (dbfTmp)->NUNICAJA   := val( aLinFac[ nSelFac, n, 4 ] ) / 100
         (dbfTmp)->NPREUNIT   := val( aLinFac[ nSelFac, n, 5 ] ) / 100





         DO CASE
         CASE aLinFac[ nSelFac, n, 6 ] == "1"
            nIva  := 7
         CASE aLinFac[ nSelFac, n, 6 ] == "2"
            nIva  := 16
         CASE aLinFac[ nSelFac, n, 6 ] == "3"
            nIva  := 4
         end

         (dbfTmp)->NIVA       := nIva





         IF ( D():Articulos( nView ) )->( DbSeek( ( dbfTmp )->CREF ) )





            IF (dbfTmp)->NPREUNIT <> ( D():Articulos( nView ) )->PCOSTO / nChgDiv
               (dbfTmp)->LCHGLIN := .T.
            end





            (dbfTmp)->NBNFLIN1   := ( D():Articulos( nView ) )->BENEF1
            (dbfTmp)->NBNFLIN2   := ( D():Articulos( nView ) )->BENEF2
            (dbfTmp)->NBNFLIN3   := ( D():Articulos( nView ) )->BENEF3
            (dbfTmp)->NBNFLIN4   := ( D():Articulos( nView ) )->BENEF4
            (dbfTmp)->NBNFLIN5   := ( D():Articulos( nView ) )->BENEF5
            (dbfTmp)->NBNFLIN6   := ( D():Articulos( nView ) )->BENEF6






            (dbfTmp)->NPVPLIN1   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN1 / 100 + ( dbfTmp )->NPREUNIT
            IF ( D():Articulos( nView ) )->LIVAINC
               (dbfTmp)->NPVPLIN1 += (dbfTmp)->NPVPLIN1 * nIva / 100
            end

            (dbfTmp)->NPVPLIN2   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN2 / 100 + ( dbfTmp )->NPREUNIT
            IF ( D():Articulos( nView ) )->LIVAINC
               (dbfTmp)->NPVPLIN2 += (dbfTmp)->NPVPLIN2 * nIva / 100
            end

            (dbfTmp)->NPVPLIN3   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN3 / 100 + ( dbfTmp )->NPREUNIT
            IF ( D():Articulos( nView ) )->LIVAINC
               (dbfTmp)->NPVPLIN3 += (dbfTmp)->NPVPLIN3 * nIva / 100
            end

            (dbfTmp)->NPVPLIN4   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN4 / 100 + ( dbfTmp )->NPREUNIT
            IF ( D():Articulos( nView ) )->LIVAINC
               (dbfTmp)->NPVPLIN4 += (dbfTmp)->NPVPLIN4 * nIva / 100
            end

            (dbfTmp)->NPVPLIN5   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN5 / 100 + ( dbfTmp )->NPREUNIT
            IF ( D():Articulos( nView ) )->LIVAINC
               (dbfTmp)->NPVPLIN5 += (dbfTmp)->NPVPLIN5 * nIva / 100
            end

            (dbfTmp)->NPVPLIN6   := ( dbfTmp )->NPREUNIT * ( dbfTmp )->NBNFLIN6 / 100 + ( dbfTmp )->NPREUNIT
            IF ( D():Articulos( nView ) )->LIVAINC
               (dbfTmp)->NPVPLIN6 += (dbfTmp)->NPVPLIN6 * nIva / 100
            end

         ELSE

            (dbfTmp)->LCHGLIN    := .T.

         end

      NEXT

      (dbfTmp)->( dbGoTop() )

   end

RETURN NIL



static function lNotOpen()

   if NetErr()
      msgStop( "Imposible abrir ficheros." )
      CloseFiles()
      return .T.
   end

return .F.







static function lRecibosPagados( uFacPrv, cFacPrvP )

   local cNumFac
   local lRecPgd  := .F.
   local nRecAct  := ( cFacPrvP )->( Recno() )
   local nOrdAct  := ( cFacPrvP )->( OrdSetFocus( "NNUMFAC" ) )

   if ValType( uFacPrv ) == "A"
      cNumFac     := uFacPrv[ 1 ] + Str( uFacPrv[ 2 ], 9 ) + uFacPrv[ 3 ]
   else
      cNumFac     := ( uFacPrv )->CSERFAC + Str( ( uFacPrv )->NNUMFAC ) + ( uFacPrv )->CSUFFAC
   end

   if ( cFacPrvP )->( dbSeek( cNumFac ) )
      while cNumFac == ( cFacPrvP )->cSerFac + Str( ( cFacPrvP )->nNumFac ) + ( cFacPrvP )->cSufFac .AND. !( cFacPrvP )->( eof() )
         if ( cFacPrvP )->lCobrado .AND. !( cFacPrvP )->lDevuelto
            lRecPgd   := .T.
            exit
         end
         ( cFacPrvP )->( dbSkip() )
      end
   end

   ( cFacPrvP )->( OrdSetFocus( nOrdAct ) )
   ( cFacPrvP )->( dbGoTo( nRecAct) )

return ( lRecPgd )



static function lGenFac( oBrw, oBtn, nDevice )

   local bAction

   If( nDevice == nil, nDevice := 1, ) ;

   if empty( oBtn )
      return nil
   end

   IF !( D():Documentos( nView ) )->( dbSeek( "FP" ) )








         oWndBrw:NewAt( "gc_document_white_",,, {||( msgStop( "No hay facturas de proveedores predefinidos" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   ELSE

      WHILE ( D():Documentos( nView ) )->cTipo == "FP" .AND. !( D():Documentos( nView ) )->( eof() )

         bAction  := bGenFac( nDevice, "Imprimiendo facturas de proveedores", ( D():Documentos( nView ) )->Codigo )

         oWndBrw:NewAt( "gc_document_white_", , , bAction, Rtrim( ( D():Documentos( nView ) )->cDescrip ) , , , , , oBtn )

         ( D():Documentos( nView ) )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenFac( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle  )
   local cCod  := by( cCodDoc )

   if nDev == 1
      bGen     := {|| nGenFacPrv( nDevice, cTit, cCod ) }
   else
      bGen     := {|| nGenFacPrv( nDevice, cTit, cCod ) }
   end

return bGen



Static Function QuiFacPrv( lDetail )

   local nOrdAnt
   local cFactura

   If( lDetail == nil, lDetail := .T., ) ;

   if ( D():FacturasProveedores( nView ) )->lCloFac .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar facturas cerradas los administradores." )
      Return .F.
   end

   CursorWait()

   cFactura          := D():FacturasProveedoresId( nView )

   if lDetail
      DelDetalle( cFactura )
   end



   nOrdAnt           := ( D():AlbaranesProveedores( nView ) )->( OrdSetFocus( "cNumFac" ) )

   if ( D():AlbaranesProveedores( nView ) )->( dbSeek( cFactura ) )

      while ( D():AlbaranesProveedores( nView ) )->cNumFac == cFactura .AND. !( D():AlbaranesProveedores( nView ) )->( eof() )

         setFacturadoAlbaranProveedor( .F., nView )

         ( D():AlbaranesProveedores( nView ) )->( dbSkip() )

      end

   end

   ( D():AlbaranesProveedores( nView ) )->( OrdSetFocus( nOrdAnt ) )



   if uFieldEmpresa( "lRecNumFac" )
      nPutDoc( ( D():FacturasProveedores( nView ) )->cSerFac, ( D():FacturasProveedores( nView ) )->nNumFac, ( D():FacturasProveedores( nView ) )->cSufFac, D():FacturasProveedores( nView ), "nFacPrv", , D():Contadores( nView ) )
   end

   CursorWE()

Return .T.



Static Function delDetalle( cFactura )

   local nOrdAnt

   If( cFactura == nil, cFactura := D():FacturasProveedoresId( nView ), ) ;

   CursorWait()

   TComercio:resetProductsToUpdateStocks()

   nOrdAnt           := ( D():FacturasProveedoresLineas( nView ) )->( OrdSetFocus( "nNumFac" ) )

   while ( D():FacturasProveedoresLineas( nView ) )->( dbSeek( cFactura ) ) .AND. !( D():FacturasProveedoresLineas( nView ) )->( eof() )

      TComercio:appendProductsToUpadateStocks( ( D():FacturasProveedoresLineas( nView ) )->cRef, nView )

      aNumAlb:add( getNumeroAlbaranProveedorLinea( nView ) )

      setNoFacturadoAlbaranProveedorLinea( nView )

      dbLockDelete( D():FacturasProveedoresLineas( nView ) )

   end

   ( D():FacturasProveedoresLineas( nView ) )->( OrdSetFocus( nOrdAnt ) )

   while ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( cFactura ) ) .AND. !( D():FacturasProveedoresPagos( nView ) )->( eof() )
      dbLockDelete( D():FacturasProveedoresPagos( nView ) )
   end

   while ( D():FacturasProveedoresIncidencias( nView ) )->( dbSeek( cFactura ) .AND. !( D():FacturasProveedoresIncidencias( nView ) )->( eof() ) )
      dbLockDelete( D():FacturasProveedoresIncidencias( nView ) )
   end

   while ( D():FacturasProveedoresDocumentos( nView ) )->( dbSeek( cFactura ) .AND. !( D():FacturasProveedoresDocumentos( nView ) )->( eof() ) )
      dbLockDelete( D():FacturasProveedoresDocumentos( nView ) )
   end

   while ( D():FacturasProveedoresSeries( nView ) )->( dbSeek( cFactura ) .AND. !( D():FacturasProveedoresSeries( nView ) )->( eof() ) )
      dbLockDelete( D():FacturasProveedoresSeries( nView ) )
   end

   aEval( aNumAlb:get(), {|cNumAlb| setEstadoAlbaranProveedor( cNumAlb, nView ) } )

   aEval( aNumAlb:get(), {|cNumAlb| RecalculaStockAlbPrvFromFacPrv( cNumAlb, nView ) } )



   TComercio:updateWebProductStocks()

   CursorWe()

RETURN NIL



STATIC FUNCTION lLiquida( oBrw, cFactura, cDivFac )

   If( cFactura == nil, cFactura := ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac, ) ;
   If( cDivFac == nil, cDivFac := ( D():FacturasProveedores( nView ) )->cDivFac, ) ;

   if ( D():FacturasProveedores( nView ) )->lLiquidada
      MsgStop( "Factura ya pagada" )
      return .F.
   end





   ( D():FacturasProveedoresPagos( nView ) )->( dbGoTop() )

   if ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( cFactura ) )

      while ( D():FacturasProveedoresPagos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresPagos( nView ) )->nNumFac ) + ( D():FacturasProveedoresPagos( nView ) )->cSufFac == cFactura .AND. !( D():FacturasProveedoresPagos( nView ) )->( eof() )

         if empty( ( D():FacturasProveedoresPagos( nView ) )->cTipRec ) .AND. !( D():FacturasProveedoresPagos( nView ) )->lCobrado

            EdtRecPrv( ( D():FacturasProveedoresPagos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresPagos( nView ) )->nNumFac ) + ( D():FacturasProveedoresPagos( nView ) )->cSufFac, .F. )

            exit

         end

         ( D():FacturasProveedoresPagos( nView ) )->( dbSkip() )

      end





      ChkLqdFacPrv( nil, nView )

   end

   oBrw:Refresh()
   oBrw:SetFocus()

return .T.



Static Function nEstadoIncidencia( cNumFac )

   local nEstado  := 0

   if ( D():FacturasProveedoresIncidencias( nView ) )->( dbSeek( cNumFac ) )

      while ( D():FacturasProveedoresIncidencias( nView ) )->cSerie + Str( ( D():FacturasProveedoresIncidencias( nView ) )->nNumFac ) + ( D():FacturasProveedoresIncidencias( nView ) )->cSufFac == cNumFac .AND. !( D():FacturasProveedoresIncidencias( nView ) )->( Eof() )

         if ( D():FacturasProveedoresIncidencias( nView ) )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( D():FacturasProveedoresIncidencias( nView ) )->( dbSkip() )

      end

   end

Return ( nEstado )



static function lRecibosPagadosTmp( dbfTmpPgo )

   local lRecPgd  := .F.
   local nRecAct  := ( dbfTmpPgo )->( Recno() )

   while !( dbfTmpPgo )->( eof() )
      if ( dbfTmpPgo )->lCobrado .AND. !( dbfTmpPgo )->lDevuelto
         lRecPgd  := .T.
         exit
      end
      ( dbfTmpPgo )->( dbSkip() )
   end

   ( dbfTmpPgo )->( dbGoTo( nRecAct) )

return ( lRecPgd )



static function ShowKitFacPrv( dbfMaster, oBrw, cCodPrv, dbfTmpInc, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva )

   if !empty( aGet )

      if ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) )
         aGet[ ( dbfMaster )->( FieldPos( "lRecargo" ) ) ]:Enable()
      else
         aGet[ ( dbfMaster )->( FieldPos( "lRecargo" ) ) ]:Disable()
      end

      if !empty( cCodPrv )
         aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:cText( cCodPrv )
         aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:lValid()
      end

      aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:SetFocus()

      aGet[ ( dbfMaster )->( FieldPos( "SubCta" ) ) ]:lValid()

      if !empty( aTmp ) .AND. aTmp[ 57 ]

         oBrw:Hide()
         oBrwIva:Hide()
         aEval( aControl, {| o | o:Hide() } )

         oSayLabels[1]:Hide()
         oSayLabels[2]:Hide()
         oSayLabels[3]:Hide()
         oSayLabels[4]:Hide()
         oSayLabels[5]:Hide()

         aGet[ 29 ]:Hide()
         aGet[ 31    ]:Hide()
         aGet[ 30 ]:Hide()
         aGet[ 32    ]:Hide()
         aGet[ 39 ]:Hide()
         aGet[ 40 ]:Hide()
         aGet[ 41 ]:Hide()
         aGet[ 42 ]:Hide()

         aEval( oSayGas, {| o | o:Show() } )

         aGet[ 58  ]:Show()
         aGet[ 59 ]:Show()
         aGet[ 60 ]:Show()
         aGet[ 61 ]:Show()
         aGet[ 62 ]:Show()
         aGet[ 63 ]:Show()
         aGet[ 64 ]:Show()
         aGet[ 65  ]:Show()
         aGet[ 66  ]:Show()
         aGet[ 67  ]:Show()

      else

         oBrw:Show()
         oBrwIva:Show()
         aEval( aControl, {| o | o:Show() } )

         oSayLabels[1]:Show()
         oSayLabels[2]:Show()
         oSayLabels[3]:Show()
         oSayLabels[4]:Show()
         oSayLabels[5]:Show()

         aGet[ 29 ]:Show()
         aGet[ 31    ]:Show()
         aGet[ 30 ]:Show()
         aGet[ 32    ]:Show()
         aGet[ 39 ]:Show()
         aGet[ 40 ]:Show()
         aGet[ 41 ]:Show()
         aGet[ 42 ]:Show()

         aEval( oSayGas, {| o | o:Hide() } )

         aGet[ 58  ]:Hide()
         aGet[ 58  ]:Hide()
         aGet[ 59 ]:Hide()
         aGet[ 60 ]:Hide()
         aGet[ 61 ]:Hide()
         aGet[ 62 ]:Hide()
         aGet[ 63 ]:Hide()
         aGet[ 64 ]:Hide()
         aGet[ 65  ]:Hide()
         aGet[ 66  ]:Hide()
         aGet[ 67  ]:Hide()

      end

   end





   if !empty( dbfTmpInc )

      while !( dbfTmpInc )->( Eof() )
         if ( dbfTmpInc )->lAviso .AND. !( dbfTmpInc )->lListo
            MsgInfo( Trim( ( dbfTmpInc )->mDesInc ), "¡Incidencia!" )
         end
         ( dbfTmpInc )->( dbSkip() )
      end

      ( dbfTmpInc )->( dbGoTop() )

   end

   oBrw:Refresh()

return nil



STATIC FUNCTION ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 12 ]:VarGet





   if ( empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if D():GetObject( "UnidadMedicion", nView ):oDbf:Seek( aTmp[ 12 ] )

         if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 1 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim1 )
            if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim1 )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( ( D():Articulos( nView ) )->nLngArt )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := ( D():Articulos( nView ) )->nLngArt
            end
         else
            if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 1 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim2 )
            if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim2 )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( ( D():Articulos( nView ) )->nAltArt )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := ( D():Articulos( nView ) )->nAltArt
            end

         else
            if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
                 aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 1 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim3 )
            if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim3 )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( ( D():Articulos( nView ) ) ->nAncArt )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := ( D():Articulos( nView ) )->nAncArt
            end
         else
            if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !empty( aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

RETURN .T.



Static Function DataLabel( oFr, lTemporal )





   oFr:ClearDataSets()

   if lTemporal
      oFr:SetWorkArea(  "Lineas de facturas", ( tmpFacPrvL )->( Select() ), .F., { 0, 0, 0 } )
   else
      oFr:SetWorkArea(  "Lineas de facturas", ( D():FacturasProveedoresLineas( nView ) )->( Select() ), .F., { 0, 2, 20 } )
   end

   oFr:SetFieldAliases( "Lineas de facturas", cItemsToReport( aColFacPrv() ) )

   oFr:SetWorkArea(     "Facturas", ( D():FacturasProveedores( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Facturas", cItemsToReport( aItmFacPrv() ) )

   oFr:SetWorkArea(     "Artículos", ( D():Articulos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Precios por propiedades", ( D():ArticuloPrecioPropiedades( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Precios por propiedades", cItemsToReport( aItmVta() ) )

   oFr:SetWorkArea(     "Incidencias de facturas", ( D():FacturasProveedoresIncidencias( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de facturas", cItemsToReport( aIncFacPrv() ) )

   oFr:SetWorkArea(     "Documentos de facturas", ( D():FacturasProveedoresDocumentos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de facturas", cItemsToReport( aFacPrvDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( D():Empresa( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Proveedores", ( D():Proveedores( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Proveedores", cItemsToReport( aItmPrv() ) )

   oFr:SetWorkArea(     "Almacenes", ( D():Almacen( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Formas de pago", ( D():FormasPago( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( D():Articulos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Código de proveedores", ( D():ProveedorArticulo( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Código de proveedores", cItemsToReport( aItmArtPrv() ) )

   oFr:SetWorkArea(     "Unidades de medición",  D():GetObject( "UnidadMedicion", nView ):Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( D():GetObject( "UnidadMedicion", nView ):oDbf ) )

   oFr:SetWorkArea(     "Bancos", ( D():BancosProveedores( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Bancos", cItemsToReport( aPrvBnc() ) )

   oFr:SetWorkArea(     "Impuestos especiales",  oNewImp:Select() )
   oFr:SetFieldAliases( "Impuestos especiales",  cObjectsToReport( oNewImp:oDbf ) )

   if lTemporal
      oFr:SetMasterDetail( "Lineas de facturas", "Facturas",                  {|| ( tmpFacPrvL )->cSerFac + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Artículos",                 {|| ( tmpFacPrvL )->cRef } )
      oFr:SetMasterDetail( "Lineas de facturas", "Precios por propiedades",   {|| ( tmpFacPrvL )->cRef + ( tmpFacPrvL )->cCodPr1 + ( tmpFacPrvL )->cCodPr2 + ( tmpFacPrvL )->cValPr1 + ( tmpFacPrvL )->cValPr2 } )
      oFr:SetMasterDetail( "Lineas de facturas", "Incidencias de facturas",   {|| ( tmpFacPrvL )->cSerFac + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Documentos de facturas",    {|| ( tmpFacPrvL )->cSerFac + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Impuestos especiales",      {|| ( tmpFacPrvL )->cCodImp } )
   else
      oFr:SetMasterDetail( "Lineas de facturas", "Facturas",                  {|| ( D():FacturasProveedoresLineas( nView ) )->cSerFac + Str( ( D():FacturasProveedoresLineas( nView ) )->nNumFac ) + ( D():FacturasProveedoresLineas( nView ) )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Artículos",                 {|| ( D():FacturasProveedoresLineas( nView ) )->cRef } )
      oFr:SetMasterDetail( "Lineas de facturas", "Precios por propiedades",   {|| ( D():FacturasProveedoresLineas( nView ) )->cRef + ( D():FacturasProveedoresLineas( nView ) )->cCodPr1 + ( D():FacturasProveedoresLineas( nView ) )->cCodPr2 + ( D():FacturasProveedoresLineas( nView ) )->cValPr1 + ( D():FacturasProveedoresLineas( nView ) )->cValPr2 } )
      oFr:SetMasterDetail( "Lineas de facturas", "Incidencias de facturas",   {|| ( D():FacturasProveedoresLineas( nView ) )->cSerFac + Str( ( D():FacturasProveedoresLineas( nView ) )->nNumFac ) + ( D():FacturasProveedoresLineas( nView ) )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Documentos de facturas",    {|| ( D():FacturasProveedoresLineas( nView ) )->cSerFac + Str( ( D():FacturasProveedoresLineas( nView ) )->nNumFac ) + ( D():FacturasProveedoresLineas( nView ) )->cSufFac } )
      oFr:SetMasterDetail( "Lineas de facturas", "Impuestos especiales",      {|| ( D():FacturasProveedoresLineas( nView ) )->cCodImp } )
   end

   oFr:SetMasterDetail(    "Facturas", "Proveedores",                         {|| ( D():FacturasProveedores( nView ) )->cCodPrv } )
   oFr:SetMasterDetail(    "Facturas", "Almacenes",                           {|| ( D():FacturasProveedores( nView ) )->cCodAlm } )
   oFr:SetMasterDetail(    "Facturas", "Formas de pago",                      {|| ( D():FacturasProveedores( nView ) )->cCodPago} )
   oFr:SetMasterDetail(    "Facturas", "Bancos",                              {|| ( D():FacturasProveedores( nView ) )->cCodPrv } )
   oFr:SetMasterDetail(    "Facturas", "Empresa",                             {|| cCodigoEmpresaEnUso() } )

   oFr:SetResyncPair(      "Lineas de facturas", "Facturas" )
   oFr:SetResyncPair(      "Lineas de facturas", "Artículos" )
   oFr:SetResyncPair(      "Lineas de facturas", "Precios por propiedades" )
   oFr:SetResyncPair(      "Lineas de facturas", "Incidencias de facturas" )
   oFr:SetResyncPair(      "Lineas de facturas", "Documentos de facturas" )
   oFr:SetResyncPair(      "Lineas de facturas", "Impuestos especiales" )

   oFr:SetResyncPair(      "Facturas", "Proveedores" )
   oFr:SetResyncPair(      "Facturas", "Almacenes" )
   oFr:SetResyncPair(      "Facturas", "Formas de pago" )
   oFr:SetResyncPair(      "Facturas", "Bancos" )
   oFr:SetResyncPair(      "Facturas", "Empresa" )

Return nil



Static Function DataReport( oFr )

   local np





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Facturas", ( D():FacturasProveedores( nView ) )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Facturas", cItemsToReport( aItmFacPrv() ) )

   oFr:SetWorkArea(     "Lineas de facturas", ( D():FacturasProveedoresLineas( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de facturas", cItemsToReport( aColFacPrv() ) )

   oFr:SetWorkArea(     "Incidencias de facturas", ( D():FacturasProveedoresIncidencias( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de facturas", cItemsToReport( aIncFacPrv() ) )

   oFr:SetWorkArea(     "Documentos de facturas", ( D():FacturasProveedoresDocumentos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de facturas", cItemsToReport( aFacPrvDoc() ) )

   oFr:SetWorkArea(     "Empresa", ( D():Empresa( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Proveedores", ( D():Proveedores( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Proveedores", cItemsToReport( aItmPrv() ) )

   oFr:SetWorkArea(     "Almacenes", ( D():Almacen( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Formas de pago", ( D():FormasPago( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( D():Articulos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Código de proveedores", ( D():ProveedorArticulo( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Código de proveedores", cItemsToReport( aItmArtPrv() ) )

   oFr:SetWorkArea(     "Unidades de medición",  D():GetObject( "UnidadMedicion", nView ):Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( D():GetObject( "UnidadMedicion", nView ):oDbf ) )

   oFr:SetWorkArea(     "Bancos", ( D():BancosProveedores( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Bancos", cItemsToReport( aPrvBnc() ) )

   oFr:SetWorkArea(     "Centro de coste",  D():CentroCoste( nView ):Select() )
   oFr:SetFieldAliases( "Centro de coste",  cObjectsToReport( D():CentroCoste( nView ):oDbf ) )







   oFr:setUserDataSet( "Impuestos factura", "porcentajeiva;logrecargo;porcentajere;bruto;neto;impiva;impre;nivmh;ntransporte;npntver", {||np := 1}, {||np := np + 1}, {||np := np - 1}, {||np > Len( aTotIva )}, {|key| hGet( aTotIva[np], key ) } )

   oFr:SetMasterDetail( "Facturas", "Lineas de facturas",      {|| ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Incidencias de facturas", {|| ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Documentos de facturas",  {|| ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas", "Proveedores",             {|| ( D():FacturasProveedores( nView ) )->cCodPrv } )
   oFr:SetMasterDetail( "Facturas", "Almacenes",               {|| ( D():FacturasProveedores( nView ) )->cCodAlm } )
   oFr:SetMasterDetail( "Facturas", "Formas de pago",          {|| ( D():FacturasProveedores( nView ) )->cCodPago} )
   oFr:SetMasterDetail( "Facturas", "Bancos",                  {|| ( D():FacturasProveedores( nView ) )->cCodPrv } )
   oFr:SetMasterDetail( "Facturas", "Empresa",                 {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Facturas", "Centro de coste",         {|| ( D():FacturasProveedores( nView ) )->cCtrCoste } )

   oFr:SetMasterDetail( "Lineas de facturas", "Artículos",               {|| ( D():FacturasProveedoresLineas( nView ) )->cRef } )
   oFr:SetMasterDetail( "Lineas de facturas", "Código de proveedores",   {|| ( D():FacturasProveedores( nView ) )->cCodPrv + ( D():FacturasProveedoresLineas( nView ) )->cRef } )
   oFr:SetMasterDetail( "Lineas de facturas", "Unidades de medición",    {|| ( D():FacturasProveedoresLineas( nView ) )->cUnidad } )

   oFr:SetResyncPair(   "Facturas", "Lineas de facturas" )
   oFr:SetResyncPair(   "Facturas", "Incidencias de facturas" )
   oFr:SetResyncPair(   "Facturas", "Documentos de facturas" )
   oFr:SetResyncPair(   "Facturas", "Proveedores" )
   oFr:SetResyncPair(   "Facturas", "Almacenes" )
   oFr:SetResyncPair(   "Facturas", "Formas de pago" )
   oFr:SetResyncPair(   "Facturas", "Bancos" )

   oFr:SetResyncPair(   "Lineas de facturas", "Artículos" )
   oFr:SetResyncPair(   "Lineas de facturas", "Código de proveedores" )
   oFr:SetResyncPair(   "Lineas de facturas", "Unidades de medición" )

Return nil



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Facturas" )
   oFr:DeleteCategory(  "Lineas de facturas" )





   oFr:AddVariable(     "Facturas",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Facturas",             "Total factura",                       "GetHbVar('nTotFac')" )
   oFr:AddVariable(     "Facturas",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Facturas",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Facturas",             "Total primer descuento definible",    "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Facturas",             "Total segundo descuento definible",   "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Facturas",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Facturas",             "Total " + cImp(),                     "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Facturas",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Facturas",             "Total retenciones por IRPF",          "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Facturas",             "Total impuestos",                     "GetHbVar('nTotImp')" )
   oFr:AddVariable(     "Facturas",             "Total unidades",                      "GetHbVar('nTotUnd')" )
   oFr:AddVariable(     "Facturas",             "Total impuestos especiales",          "GetHbVar('nTotIvm')" )



















   oFr:AddVariable(     "Facturas",             "Cuenta bancaria proveedor",                 "CallHbFunc('cCtaFacPrv')" )

   oFr:AddVariable(     "Lineas de facturas",   "Código del artículo con propiedades",       "CallHbFunc('cPrpFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Detalle del artículo",                      "CallHbFunc('cDesFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Detalle del artículo otro lenguaje",        "CallHbFunc('cDesFacPrvLeng')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total unidades artículo",                   "CallHbFunc('nTotNFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Precio unitario de factura",                "CallHbFunc('nTotUFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Total línea de factura",                    "CallHbFunc('nTotLFacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Código de barras para primera propiedad",   "CallHbFunc('cBarPrp1FacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Código de barras para segunda propiedad",   "CallHbFunc('cBarPrp2FacPrv')" )
   oFr:AddVariable(     "Lineas de facturas",   "Nombre primera propiedad",                  "CallHbFunc('cNomValPrp1')" )
   oFr:AddVariable(     "Lineas de facturas",   "Nombre segunda propiedad",                  "CallHbFunc('cNomValPrp2')" )

   oFr:AddVariable(     "Lineas de facturas",   "Stock actual en almacén",                   "CallHbFunc('nStockLineaFacPrv')" )

Return nil



Function YearComboBoxChange()

   if ( oWndBrw:oWndBar:cYearComboBox() <> "[Todos]" )
      oWndBrw:oWndBar:setYearComboBoxExpression( "Year( Field->dFecFac ) == " + oWndBrw:oWndBar:cYearComboBox() )
   else
      oWndBrw:oWndBar:setYearComboBoxExpression( "" )
   end

   oWndBrw:chgFilter()

Return nil



Function AddLineasAlbaranProveedor( cAlbaran, lNewLin )

   local nNumLin
   local nNewLin

   If( lNewLin == nil, lNewLin := .F., ) ;





   if ( D():AlbaranesProveedoresLineas( nView ) )->( dbSeek( cAlbaran ) )

      while ( D():AlbaranesProveedoresLineasId( nView ) == cAlbaran ) .AND. !( D():AlbaranesProveedoresLineas( nView ) )->( eof() )

         nNumLin                 := ( D():AlbaranesProveedoresLineas( nView ) )->nNumLin

         if ( D():AlbaranesProveedoresLineasNoFacturada( nView ) )

            ( dbfTmp )->( dbAppend() )

            if lNewLin

               nNewLin                 := nLastNum( dbfTmp )
               ( dbfTmp )->nNumLin     := nNewLin
               ( dbfTmp )->nPosPrint   := nNewLin
            else
               ( dbfTmp )->nNumLin     := nNumLin
               ( dbfTmp )->nPosPrint   := ( D():AlbaranesProveedoresLineas( nView ) )->nPosPrint
            end

            ( dbfTmp )->cRef        := ( D():AlbaranesProveedoresLineas( nView ) )->cRef
            ( dbfTmp )->cDetalle    := ( D():AlbaranesProveedoresLineas( nView ) )->cDetalle
            ( dbfTmp )->mLngDes     := ( D():AlbaranesProveedoresLineas( nView ) )->mLngDes
            ( dbfTmp )->mNumSer     := ( D():AlbaranesProveedoresLineas( nView ) )->mNumSer
            ( dbfTmp )->nIva        := ( D():AlbaranesProveedoresLineas( nView ) )->nIva
            ( dbfTmp )->nReq        := ( D():AlbaranesProveedoresLineas( nView ) )->nReq
            ( dbfTmp )->nPreUnit    := ( D():AlbaranesProveedoresLineas( nView ) )->nPreDiv
            ( dbfTmp )->nPreCom     := ( D():AlbaranesProveedoresLineas( nView ) )->nPreCom
            ( dbfTmp )->nUniCaja    := ( D():AlbaranesProveedoresLineas( nView ) )->nUniCaja
            ( dbfTmp )->nCanEnt     := ( D():AlbaranesProveedoresLineas( nView ) )->nCanEnt
            ( dbfTmp )->nDtoLin     := ( D():AlbaranesProveedoresLineas( nView ) )->nDtoLin
            ( dbfTmp )->nDtoPrm     := ( D():AlbaranesProveedoresLineas( nView ) )->nDtoPrm
            ( dbfTmp )->nDtoRap     := ( D():AlbaranesProveedoresLineas( nView ) )->nDtoRap
            ( dbfTmp )->cAlmLin     := ( D():AlbaranesProveedoresLineas( nView ) )->cAlmLin
            ( dbfTmp )->cAlmOrigen  := ( D():AlbaranesProveedoresLineas( nView ) )->cAlmOrigen
            ( dbfTmp )->nUndKit     := ( D():AlbaranesProveedoresLineas( nView ) )->nUndKit
            ( dbfTmp )->lKitChl     := ( D():AlbaranesProveedoresLineas( nView ) )->lKitChl
            ( dbfTmp )->lKitArt     := ( D():AlbaranesProveedoresLineas( nView ) )->lKitArt
            ( dbfTmp )->lKitPrc     := ( D():AlbaranesProveedoresLineas( nView ) )->lKitPrc
            ( dbfTmp )->lIvaLin     := ( D():AlbaranesProveedoresLineas( nView ) )->lIvaLin
            ( dbfTmp )->cCodPr1     := ( D():AlbaranesProveedoresLineas( nView ) )->cCodPr1
            ( dbfTmp )->cCodPr2     := ( D():AlbaranesProveedoresLineas( nView ) )->cCodPr2
            ( dbfTmp )->cValPr1     := ( D():AlbaranesProveedoresLineas( nView ) )->cValPr1
            ( dbfTmp )->cValPr2     := ( D():AlbaranesProveedoresLineas( nView ) )->cValPr2
            ( dbfTmp )->nBnfLin1    := ( D():AlbaranesProveedoresLineas( nView ) )->nBnfLin1
            ( dbfTmp )->nBnfLin2    := ( D():AlbaranesProveedoresLineas( nView ) )->nBnfLin2
            ( dbfTmp )->nBnfLin3    := ( D():AlbaranesProveedoresLineas( nView ) )->nBnfLin3
            ( dbfTmp )->nBnfLin4    := ( D():AlbaranesProveedoresLineas( nView ) )->nBnfLin4
            ( dbfTmp )->nBnfLin5    := ( D():AlbaranesProveedoresLineas( nView ) )->nBnfLin5
            ( dbfTmp )->nBnfLin6    := ( D():AlbaranesProveedoresLineas( nView ) )->nBnfLin6
            ( dbfTmp )->lBnfLin1    := ( D():AlbaranesProveedoresLineas( nView ) )->lBnfLin1
            ( dbfTmp )->lBnfLin2    := ( D():AlbaranesProveedoresLineas( nView ) )->lBnfLin2
            ( dbfTmp )->lBnfLin3    := ( D():AlbaranesProveedoresLineas( nView ) )->lBnfLin3
            ( dbfTmp )->lBnfLin4    := ( D():AlbaranesProveedoresLineas( nView ) )->lBnfLin4
            ( dbfTmp )->lBnfLin5    := ( D():AlbaranesProveedoresLineas( nView ) )->lBnfLin5
            ( dbfTmp )->lBnfLin6    := ( D():AlbaranesProveedoresLineas( nView ) )->lBnfLin6
            ( dbfTmp )->nPvpLin1    := ( D():AlbaranesProveedoresLineas( nView ) )->nPvpLin1
            ( dbfTmp )->nPvpLin2    := ( D():AlbaranesProveedoresLineas( nView ) )->nPvpLin2
            ( dbfTmp )->nPvpLin3    := ( D():AlbaranesProveedoresLineas( nView ) )->nPvpLin3
            ( dbfTmp )->nPvpLin4    := ( D():AlbaranesProveedoresLineas( nView ) )->nPvpLin4
            ( dbfTmp )->nPvpLin5    := ( D():AlbaranesProveedoresLineas( nView ) )->nPvpLin5
            ( dbfTmp )->nPvpLin6    := ( D():AlbaranesProveedoresLineas( nView ) )->nPvpLin6
            ( dbfTmp )->nIvaLin1    := ( D():AlbaranesProveedoresLineas( nView ) )->nIvaLin1
            ( dbfTmp )->nIvaLin2    := ( D():AlbaranesProveedoresLineas( nView ) )->nIvaLin2
            ( dbfTmp )->nIvaLin3    := ( D():AlbaranesProveedoresLineas( nView ) )->nIvaLin3
            ( dbfTmp )->nIvaLin4    := ( D():AlbaranesProveedoresLineas( nView ) )->nIvaLin4
            ( dbfTmp )->nIvaLin5    := ( D():AlbaranesProveedoresLineas( nView ) )->nIvaLin5
            ( dbfTmp )->nIvaLin6    := ( D():AlbaranesProveedoresLineas( nView ) )->nIvaLin6
            ( dbfTmp )->lLote       := ( D():AlbaranesProveedoresLineas( nView ) )->lLote
            ( dbfTmp )->nLote       := ( D():AlbaranesProveedoresLineas( nView ) )->nLote
            ( dbfTmp )->cLote       := ( D():AlbaranesProveedoresLineas( nView ) )->cLote
            ( dbfTmp )->mObsLin     := ( D():AlbaranesProveedoresLineas( nView ) )->mObsLin
            ( dbfTmp )->cRefPrv     := ( D():AlbaranesProveedoresLineas( nView ) )->cRefPrv
            ( dbfTmp )->cUnidad     := ( D():AlbaranesProveedoresLineas( nView ) )->cUnidad
            ( dbfTmp )->nNumMed     := ( D():AlbaranesProveedoresLineas( nView ) )->nNumMed
            ( dbfTmp )->nMedUno     := ( D():AlbaranesProveedoresLineas( nView ) )->nMedUno
            ( dbfTmp )->nMedDos     := ( D():AlbaranesProveedoresLineas( nView ) )->nMedDos
            ( dbfTmp )->nMedTre     := ( D():AlbaranesProveedoresLineas( nView ) )->nMedTre
            ( dbfTmp )->dFecCad     := ( D():AlbaranesProveedoresLineas( nView ) )->dFecCad
            ( dbfTmp )->nBultos     := ( D():AlbaranesProveedoresLineas( nView ) )->nBultos
            ( dbfTmp )->cFormato    := ( D():AlbaranesProveedoresLineas( nView ) )->cFormato
            ( dbfTmp )->cCodImp     := ( D():AlbaranesProveedoresLineas( nView ) )->cCodImp
            ( dbfTmp )->nValImp     := ( D():AlbaranesProveedoresLineas( nView ) )->nValImp
            ( dbfTmp )->dFecFac     := ( D():AlbaranesProveedoresLineas( nView ) )->dFecAlb
            ( dbfTmp )->tFecFac     := ( D():AlbaranesProveedoresLineas( nView ) )->tFecAlb
            ( dbfTmp )->cCtrCoste   := ( D():AlbaranesProveedoresLineas( nView ) )->cCtrCoste
            ( dbfTmp )->cCodFam     := ( D():AlbaranesProveedoresLineas( nView ) )->cCodFam
            ( dbfTmp )->cRefAux     := ( D():AlbaranesProveedoresLineas( nView ) )->cRefAux
            ( dbfTmp )->cRefAux2    := ( D():AlbaranesProveedoresLineas( nView ) )->cRefAux2
            ( dbfTmp )->cCtrCoste   := ( D():AlbaranesProveedoresLineas( nView ) )->cCtrCoste
            ( dbfTmp )->cTipCtr     := ( D():AlbaranesProveedoresLineas( nView ) )->cTipCtr
            ( dbfTmp )->cTerCtr     := ( D():AlbaranesProveedoresLineas( nView ) )->cTerCtr

            ( dbfTmp )->iNumAlb     := D():AlbaranesProveedoresLineasNumero( nView )



            if ( D():AlbaranesProveedoresSeries( nView ) )->( dbSeek( cAlbaran + Str( nNumLin ) ) )

               while ( ( D():AlbaranesProveedoresSeries( nView ) )->cSerAlb + Str( ( D():AlbaranesProveedoresSeries( nView ) )->nNumAlb ) + ( D():AlbaranesProveedoresSeries( nView ) )->cSufAlb + Str( ( D():AlbaranesProveedoresSeries( nView ) )->nNumLin ) == cAlbaran + Str( nNumLin ) ) .AND. !( D():AlbaranesProveedoresSeries( nView ) )->( eof() )

                  ( dbfTmpSer )->( dbAppend() )

                  if lNewLin
                     ( dbfTmpSer )->nNumLin  := nNewLin
                  else
                     ( dbfTmpSer )->nNumLin  := nNumLin
                  end

                  ( dbfTmpSer )->cSerFac     := ( D():AlbaranesProveedoresSeries( nView ) )->cSerAlb
                  ( dbfTmpSer )->nNumFac     := ( D():AlbaranesProveedoresSeries( nView ) )->nNumAlb
                  ( dbfTmpSer )->cSufFac     := ( D():AlbaranesProveedoresSeries( nView ) )->cSufAlb
                  ( dbfTmpSer )->cRef        := ( D():AlbaranesProveedoresSeries( nView ) )->cRef
                  ( dbfTmpSer )->cAlmLin     := ( D():AlbaranesProveedoresSeries( nView ) )->cAlmLin
                  ( dbfTmpSer )->lUndNeg     := ( D():AlbaranesProveedoresSeries( nView ) )->lUndNeg
                  ( dbfTmpSer )->cNumSer     := ( D():AlbaranesProveedoresSeries( nView ) )->cNumSer

                  ( D():AlbaranesProveedoresSeries( nView ) )->( dbSkip() )

               end

            end

         end

         ( D():AlbaranesProveedoresLineas( nView ) )->( dbSkip() )

      end

      ( dbfTmp )->( dbGoTop() )

   end

Return ( nil )



Static Function EditarNumerosSerie( aTmp, nMode )

   AutoNumerosSerie( aTmp, nMode )

   oNumerosSerie:Resource()

Return ( nil )



Static Function AutoNumerosSerie( aTmp, nMode )

   oNumerosSerie:nMode              := nMode

   oNumerosSerie:cCodArt            := aTmp[ 4    ]
   oNumerosSerie:cCodAlm            := aTmp[ 57 ]
   oNumerosSerie:nNumLin            := aTmp[ 62 ]
   oNumerosSerie:lAutoSerializacion := aTmp[ 96 ]

   oNumerosSerie:nTotalUnidades     := nTotNFacPrv( aTmp )

   oNumerosSerie:uTmpSer            := dbfTmpSer

   if oNumerosSerie:lAutoSerializacion
       oNumerosSerie:AutoSerializa()
   end

Return ( nil )



Static Function ValidaSuFactura( aGet, nMode )

   local nRecno
   local cSuFactura

   if nMode <> 1
      Return .T.
   end

   cSuFactura        := aGet[ 6 ]:VarGet() + Upper( aGet[ 18 ]:VarGet() )

   nRecno            := ( D():FacturasProveedores( nView ) )->( Recno() )

   if dbSeekInOrd( cSuFactura, "cPrvFac", D():FacturasProveedores( nView ) )
      MsgInfo( "La referencia de esta factura ya existe.")
   end

   ( D():FacturasProveedores( nView ) )->( dbGoTo( nRecno ) )

Return ( .T. )



Static Function ImprimirSeriesFacturasProveedores( nDevice, lExt )

   local aStatus
   local oPrinter
   local cFormato

   If( nDevice == nil, nDevice := 1, ) ;
   If( lExt == nil, lExt := .F., ) ;



   oPrinter          := PrintSeries():New( nView ):SetCompras()



   oPrinter:Serie(      ( D():FacturasProveedores( nView ) )->cSerFac )
   oPrinter:Documento(  ( D():FacturasProveedores( nView ) )->nNumFac )
   oPrinter:Sufijo(     ( D():FacturasProveedores( nView ) )->cSufFac )

   if lExt

      oPrinter:oFechaInicio:cText( ( D():FacturasProveedores( nView ) )->dFecFac )
      oPrinter:oFechaFin:cText( ( D():FacturasProveedores( nView ) )->dFecFac )

   end

   oPrinter:oFormatoDocumento:TypeDocumento( "FP" )



   cFormato          := cFormatoDocumento( ( D():FacturasProveedores( nView ) )->cSerFac, "nFacPrv", D():Contadores( nView ) )
   if empty( cFormato )
      cFormato       := cFirstDoc( "FP", D():Documentos( nView ) )
   end
   oPrinter:oFormatoDocumento:cText( cFormato )



   aStatus           := D():GetInitStatus( "FacPrvT", nView )

   oPrinter:bInit    := {||   ( D():FacturasProveedores( nView ) )->( dbSeek( oPrinter:DocumentoInicio(), .T. ) ) }


   oPrinter:bWhile   := {||   oPrinter:InRangeDocumento( D():FacturasProveedoresId( nView ) ) .AND.  ( D():FacturasProveedores( nView ) )->( !eof() ) }



   oPrinter:bFor     := {||   oPrinter:InRangeFecha( ( D():FacturasProveedores( nView ) )->dFecFac ) .AND.  oPrinter:InRangeProveedor( ( D():FacturasProveedores( nView ) )->cCodPrv ) .AND.  oPrinter:InRangeGrupoProveedor( RetFld( ( D():FacturasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "cCodGrp" ) ) }

   oPrinter:bSkip    := {||   ( D():FacturasProveedores( nView ) )->( dbSkip() ) }

   oPrinter:bAction  := {||   GenFacPrv( nDevice, "Imprimiendo documento : " + D():FacturasProveedoresId( nView ), oPrinter:oFormatoDocumento:uGetValue, oPrinter:oImpresora:uGetValue, oPrinter:oCopias:uGetValue ) }

   oPrinter:bStart   := {||   if( lExt, oPrinter:DisableRange(), ) }



   oPrinter:Resource():End()



   D():SetStatus( "FacPrvT", nView, aStatus )

   if !empty( oWndBrw )
      oWndBrw:Refresh()
   end

Return .T.












FUNCTION nPagFacPrv( cFactura, cFacPrvP, cDivRet, cDiv, lOnlyCob, aTmp )

   local nRec
   local nOrd
   local nRinDiv
   local cCodDiv
   local nTotalPagado   := 0

   If( cFacPrvP == nil, cFacPrvP := D():FacturasProveedoresPagos( nView ), ) ;
   If( cDivRet == nil, cDivRet := cDivEmp(), ) ;
   If( lOnlyCob == nil, lOnlyCob := .T., ) ;

   nRinDiv              := nRinDiv( cDivRet, cDiv )





   nRec                    := ( cFacPrvP )->( Recno() )

   if !empty( aTmp )

      cCodDiv              := ( cFacPrvP )->cDivPgo

      ( cFacPrvP )->( dbGoTop() )
      while !( cFacPrvP )->( Eof() )

         if ( lOnlyCob .AND. ( cFacPrvP )->lCobrado .AND. !( cFacPrvP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( cFacPrvP )->lDevuelto )

            nTotalPagado   += ( cFacPrvP )->nImporte

         end

         ( cFacPrvP )->( dbSkip() )

      end

      ( cFacPrvP )->( dbGoTo( nRec ) )

   else

      nOrd                 := ( cFacPrvP )->( OrdSetFocus( "NNUMFAC" ) )

      if ( cFacPrvP )->( dbSeek( cFactura, .T. ) )

         cCodDiv           := ( cFacPrvP )->cDivPgo

         while ( ( cFacPrvP )->cSerFac + Str( ( cFacPrvP )->nNumFac ) + ( cFacPrvP )->cSufFac = cFactura )

            if ( lOnlyCob .AND. ( cFacPrvP )->lCobrado .AND. !( cFacPrvP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( cFacPrvP )->lDevuelto )

               nTotalPagado   += ( cFacPrvP )->nImporte

            end

            ( cFacPrvP )->( dbSkip() )

         end

      end

      ( cFacPrvP )->( OrdSetFocus( nOrd ) )

   end

   ( cFacPrvP )->( dbGoTo( nRec ) )

   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      nTotalPagado   := nCnv2Div( nTotalPagado, cCodDiv, cDivRet )
   else
      nTotalPagado   := Round( nTotalPagado, nRinDiv )
   end

RETURN ( nTotalPagado )



FUNCTION ChkPagFacPrv( cFacPrvT, cFacPrvP )

   local nBitmap

   do case
   case ( cFacPrvT )->lLiquidada
      nBitmap  := 1
   case lRecibosPagados( cFacPrvT, cFacPrvP )
      nBitmap  := 2
   otherwise
      nBitmap  := 3
   end

RETURN nBitmap






FUNCTION ChkLqdFacPrv( aTmp, nView )

   local oError
   local oBlock
   local nTotFac
   local cDivFac
   local cNumFac
   local nPagFac

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if aTmp <> nil
      cNumFac        := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]
      cDivFac        := aTmp[ 36 ]
   else
      cNumFac        := D():FacturasProveedoresId( nView )
      cDivFac        := ( D():FacturasProveedores( nView ) )->cDivFac
   end

   nPagFac           := abs( nPagFacPrv( cNumFac, D():FacturasProveedoresPagos(nView), cDivFac, D():Divisas( nView ) ) )
   nTotFac           := abs( nTotFacPrv( cNumFac, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ), D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos(nView), nil, nil, .F. ) )

   if aTmp <> nil
      aTmp[ 15 ]           := ( ( nPagFac == nTotFac ) .OR. ( nPagFac > nTotFac ) )
   else
      if dbLock( D():FacturasProveedores( nView ) )
         ( D():FacturasProveedores( nView ) )->lLiquidada := ( ( nPagFac == nTotFac ) .OR. ( nPagFac > nTotFac ) )
         ( D():FacturasProveedores( nView ) )->( dbRUnLock() )
      end
   end

   RECOVER USING oError

   end

   ErrorBlock( oBlock )

RETURN NIL



FUNCTION nNetUFacPrv( uFacPrvL, uFacPrvT, nDec, nRec, nVdv, cPinDiv )

   local nDtoEsp
   local nDtoPP
   local nDtoUno
   local nDtoDos
   local nCalculo
   local nDtoLin
   local nDtoPrm
   local nPorte

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRec == nil, nRec := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacPrv( uFacPrvL, nDec, nVdv )

   if ValType( uFacPrvL ) == "A"
      nDtoLin     := uFacPrvL[ 16 ]
      nDtoPrm     := uFacPrvL[ 17 ]
   else
      nDtoLin     := ( uFacPrvL )->nDtoLin
      nDtoPrm     := ( uFacPrvL )->nDtoPrm
   end

   if nDtoLin <> 0
      nCalculo    -= nCalculo * nDtoLin / 100
   end

   if nDtoPrm <> 0
      nCalculo    -= nCalculo * nDtoPrm / 100
   end





   if ValType( uFacPrvT ) == "A"
      nDtoEsp     := uFacPrvT[ 30 ]
      nDtoPP      := uFacPrvT[ 32    ]
      nDtoUno     := uFacPrvT[ 40 ]
      nDtoDos     := uFacPrvT[ 42 ]
      nPorte      := uFacPrvT[ 25 ]
   else
      nDtoEsp     := (uFacPrvT)->NDTOESP
      nDtoPP      := (uFacPrvT)->NDPP
      nDtoUno     := (uFacPrvT)->NDTOUNO
      nDtoDos     := (uFacPrvT)->NDTODOS
      nPorte      := (uFacPrvT)->NPORTES
   end

   if nDtoEsp <> 0
      nCalculo    -= Round( nCalculo * nDtoEsp / 100, nDec )
   end

   if nDtoPP <> 0
      nCalculo    -= Round( nCalculo * nDtoPP  / 100, nDec )
   end

   if nDtoUno <> 0
      nCalculo    -= Round( nCalculo * nDtoUno / 100, nDec )
   end

   if nDtoDos <> 0
      nCalculo    -= Round( nCalculo * nDtoDos / 100, nDec )
   end

   nCalculo       := Round( nCalculo, nDec )

RETURN ( if( cPinDiv <> NIL, Trans( nCalculo, cPinDiv ), nCalculo ) )



FUNCTION nImpUFacPrv( uFacPrvT, cFacPrvL, nDec, nVdv, lIva, cPouDiv )

   local nCalculo

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lIva == nil, lIva := .F., ) ;

   nCalculo       := nTotUFacPrv( cFacPrvL, nDec, nVdv )

   if ValType( uFacPrvT ) == "A"
      nCalculo    -= Round( nCalculo * uFacPrvT[ 30 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 32    ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 40 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 42 ]  / 100, nDec )
   else
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoEsp / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDpp    / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoUno / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoDos / 100, nDec )
   end

   if lIva .AND. ( cFacPrvL )->nIva <> 0
      nCalculo    += nCalculo * ( cFacPrvL )->nIva / 100
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nImpLFacPrv( uFacPrvT, cFacPrvL, nDec, nRou, nVdv, lIva, cPouDiv )

   local nCalculo

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lIva == nil, lIva := .F., ) ;

   nCalculo       := nTotLFacPrv( cFacPrvL, nDec, nRou, nVdv )

   if ValType( uFacPrvT ) == "A"
      nCalculo    -= Round( nCalculo * uFacPrvT[ 30 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 32    ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 40 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 42 ]  / 100, nRou )
   else
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoEsp / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDpp    / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoUno / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoDos / 100, nRou )
   end

   if lIva .AND. ( cFacPrvL )->nIva <> 0
      nCalculo    += nCalculo * ( cFacPrvL )->nIva / 100
   end

RETURN ( if( cPouDiv <> NIL, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nTotIFacPrv( dbfLin, nDec, nRouDec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( dbfLin == nil, dbfLin := D():Get( "FacPrvL", nView ), ) ;
   If( nDec == nil, nDec := 0, ) ;
   If( nRouDec == nil, nRouDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := Round( ( dbfLin )->nValImp, nDec )
   nCalculo          *= nTotNFacPrv( dbfLin )
   nCalculo          := Round( nCalculo / nVdv, nRouDec )

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nTotFacPrv( cFactura, cFacPrvT, cFacPrvL, cIva, cDiv, cFacPrvP, aTmp, cDivRet, lPic )

   local bCondition
   local nTotalArt
   local lRecargo
   local dFecFac
   local nDtoEsp
   local nDtoPP
   local nDtoUno
   local nDtoDos
   local nPorte
   local nPctRet
   local nRecno
   local cCodDiv
   local cCodPgo
   local nRegIva
   local lFacGas        := .F.
   local aTotalUno      := { 0, 0, 0 }
   local aTotalDos      := { 0, 0, 0 }
   local aTotalDto      := { 0, 0, 0 }
   local aTotalDPP      := { 0, 0, 0 }
   local aNetGas        := { 0, 0, 0 }
   local aPIvGas        := { 0, 0, 0 }
   local aPReGas        := { 0, 0, 0 }
   local nImpuestoEspecial
   local lIvaInc        := .F.
   local nRouDiv

   local NBASIVA1   := 0
   local NBASIVA2   := 0
   local NBASIVA3   := 0

   local NIMPIVA1   := 0
   local NIMPIVA2   := 0
   local NIMPIVA3   := 0

   local NIMPREQ1   := 0
   local NIMPREQ2   := 0
   local NIMPREQ3   := 0

   local NBRTIVA1   := 0
   local NPCTIVA1   := 0
   local NPCTREQ1   := 0
   local NBRTIVA2   := 0
   local NPCTIVA2   := 0
   local NPCTREQ2   := 0
   local NBRTIVA3   := 0
   local NPCTIVA3   := 0
   local NPCTREQ3   := 0

   local oTotalDoc      := nTotalDocumento():new( nView )

   if !empty( nView )
      If( cFacPrvT == nil, cFacPrvT := D():FacturasProveedores( nView ), ) ;
      If( cFacPrvL == nil, cFacPrvL := D():FacturasProveedoresLineas( nView ), ) ;
      If( cIva == nil, cIva := D():TiposIva( nView ), ) ;
      If( cDiv == nil, cDiv := D():Divisas( nView ), ) ;
      If( cFacPrvP == nil, cFacPrvP := D():FacturasProveedoresPagos( nView ), ) ;
      If( cFactura == nil, cFactura := ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac, ) ;
   end

   If( lPic == nil, lPic := .F., ) ;

   public nTotBrt       := 0
   public nTotNet       := 0
   public nTotSup       := 0
   public nTotIva       := 0
   public nTotReq       := 0
   public nTotRet       := 0
   public nTotFac       := 0
   public nTotDto       := 0
   public nTotDpp       := 0
   public nTotUno       := 0
   public nTotDos       := 0
   public nTotImp       := 0
   public nTotIvm       := 0
   public nTotUnd       := 0
   public nPagFac       := 0
   public nTipRet       := 0









   public aTotIva       := {{    "porcentajeiva" => nil, "logrecargo"   => .F., "porcentajere" => nil, "bruto"        => nil, "neto"         => nil, "impiva"       => nil, "impre"        => nil, "nivmh"        => nil, "ntransporte"  => nil, "npntver"      => nil }}

   public aIvaUno    := {}
   public aIvaDos    := {}
   public aIvaTre    := {}

   nRecno               := ( cFacPrvL )->( recno() )

   if aTmp <> nil

      dFecFac        := aTmp[ 5 ]
      lRecargo       := aTmp[ 33]
      nDtoEsp        := aTmp[ 30 ]
      nDtoPP         := aTmp[ 32    ]
      nDtoUno        := aTmp[ 40 ]
      nDtoDos        := aTmp[ 42 ]
      nPorte         := aTmp[ 25 ]
      cCodDiv        := aTmp[ 36 ]
      cCodPgo        := aTmp[ 23]
      nTipRet        := aTmp[ 51 ]
      nPctRet        := aTmp[ 52 ]
      nRegIva        := aTmp[ 56 ]
      lFacGas        := aTmp[ 57 ]
      aNetGas        := { aTmp[ 59 ], aTmp[ 60 ], aTmp[ 61 ] }
      aPIvGas        := { aTmp[ 62 ], aTmp[ 63 ], aTmp[ 64 ] }
      aPReGas        := { aTmp[ 65  ], aTmp[ 66  ], aTmp[ 67  ] }
      bCondition     := {|| ( cFacPrvL )->( !eof() ) }
      nRouDiv        := nRouDiv( aTmp[ 36 ], cDiv )

      ( cFacPrvL )->( dbGoTop() )

   else

      dFecFac        := ( cFacPrvT )->dFecFac
      lRecargo       := ( cFacPrvT )->lRecargo
      nDtoEsp        := ( cFacPrvT )->nDtoEsp
      nDtoPP         := ( cFacPrvT )->nDpp
      nDtoUno        := ( cFacPrvT )->nDtoUno
      nDtoDos        := ( cFacPrvT )->nDtoDos
      nPorte         := ( cFacPrvT )->nPortes
      cCodDiv        := ( cFacPrvT )->cDivFac
      cCodPgo        := ( cFacPrvT )->cCodPago
      nTipRet        := ( cFacPrvT )->nTipRet
      nPctRet        := ( cFacPrvT )->nPctRet
      nRegIva        := ( cFacPrvT )->nRegIva
      lFacGas        := ( cFacPrvT )->lFacGas
      aNetGas        := { ( cFacPrvT )->nNetGas1, ( cFacPrvT )->nNetGas2, ( cFacPrvT )->nNetGas3 }
      aPIvGas        := { ( cFacPrvT )->nIvaGas1, ( cFacPrvT )->nIvaGas2, ( cFacPrvT )->nIvaGas3 }
      aPReGas        := { ( cFacPrvT )->nReGas1,  ( cFacPrvT )->nReGas2,  ( cFacPrvT )->nReGas3  }
      bCondition     := {|| ( cFacPrvL )->cSerFac + Str( ( cFacPrvL )->nNumFac ) + ( cFacPrvL )->cSufFac == cFactura .AND. ( cFacPrvL )->( !eof() ) }
      nRouDiv        := nRouDiv( ( cFacPrvT )->cDivFac, cDiv )

      ( cFacPrvL )->( dbSeek( cFactura ) )

   end





   cPinDiv           := cPinDiv( cCodDiv, cDiv )
   cPirDiv           := cPirDiv( cCodDiv, cDiv )
   nDinDiv           := nDinDiv( cCodDiv, cDiv )
   nRinDiv           := nRinDiv( cCodDiv, cDiv )

   if !lFacGas

      while Eval( bCondition )

         if lValLine( cFacPrvL )

            nTotalArt            := nTotLFacPrv( cFacPrvL, nDinDiv, nRinDiv )
            nImpuestoEspecial    := nTotIFacPrv( cFacPrvL, nDinDiv, nRinDiv )

            if nTotalArt <> 0

               if ( cFacPrvL )->lGasSup
                  nTotSup        += nTotalArt
               end





               oTotalDoc:setArrayImpuesto( ( cFacPrvL )->nIva, lRecargo, ( cFacPrvL )->nReq, nTotalArt, nImpuestoEspecial, 0, 0 )

            end

            nTotUnd              += nTotNFacPrv( cFacPrvL )

         end

         ( cFacPrvL )->( dbSkip() )

      end

      ( cFacPrvL )->( dbGoto( nRecno ) )

   else

      NBRTIVA1   := aNetGas[1]
      NPCTIVA1   := aPIvGas[1]
      NPCTREQ1   := aPReGas[1]

      NBRTIVA2   := aNetGas[2]
      NPCTIVA2   := aPIvGas[2]
      NPCTREQ2   := aPReGas[2]

      NBRTIVA3   := aNetGas[3]
      NPCTIVA3   := aPIvGas[3]
      NPCTREQ3   := aPReGas[3]

   end





   aTotIva         := oTotalDoc:getArrayImpuesto()
   aTotIva         := aSort( aTotIva,,, {|x,y| hGet( x, "porcentajeiva" ) > hGet( y, "porcentajeiva" ) } )

   nTotBrt         := oTotalDoc:getTotalBruto()



   if lFacGas
      NBASIVA1            := Round( NBRTIVA1, nRinDiv )
      NBASIVA2            := Round( NBRTIVA2, nRinDiv )
      NBASIVA3            := Round( NBRTIVA3, nRinDiv )

      nTotBrt              := NBASIVA1 + NBASIVA2 + NBASIVA3
   end





   nTotBrt              += nPorte



































































   if lFacGas
      nTotNet           := Round( NBASIVA1 + NBASIVA2 + NBASIVA3, nRinDiv )
   end

   if nDtoEsp <> 0
      nTotDto := oTotalDoc:setDescuentoEspecial( nDtoEsp )
   end
   if nDtoPP <> 0
      nTotDPP := oTotalDoc:setDescuentoProntoPago( nDtoPP )
   end
   if nDtoUno <> 0
      nTotUno := oTotalDoc:setDescuentoUno( nDtoUno )
   end
   if nDtoDos <> 0
      nTotDos := oTotalDoc:setDescuentoDos( nDtoDos )
   end



   if lFacGas

      if nRegIva <= 1

         NIMPIVA1         := if( NPCTIVA1 <> NIL, Round( NBASIVA1 * NPCTIVA1 / 100, nRinDiv ), 0 )
         NIMPIVA2         := if( NPCTIVA2 <> NIL, Round( NBASIVA2 * NPCTIVA2 / 100, nRinDiv ), 0 )
         NIMPIVA3         := if( NPCTIVA3 <> NIL, Round( NBASIVA3 * NPCTIVA3 / 100, nRinDiv ), 0 )





         if lRecargo
            NIMPREQ1   := if( NPCTIVA1 <> NIL, Round( NBASIVA1 * NPCTREQ1 / 100, nRinDiv ), 0 )
            NIMPREQ2   := if( NPCTIVA2 <> NIL, Round( NBASIVA2 * NPCTREQ2 / 100, nRinDiv ), 0 )
            NIMPREQ3   := if( NPCTIVA3 <> NIL, Round( NBASIVA3 * NPCTREQ3 / 100, nRinDiv ), 0 )
         end

      end










      aAdd( aTotIva, {  "porcentajeiva" => NPCTIVA1, "logrecargo"   => lRecargo, "porcentajere" => NPCTREQ1, "bruto"        => NBRTIVA1, "neto"         => NBASIVA1, "impiva"       => NIMPIVA1, "impre"        => NIMPREQ1, "nivmh"        => 0, "ntransporte"  => 0, "npntver"      => 0 } )










      aAdd( aTotIva, {  "porcentajeiva" => NPCTIVA2, "logrecargo"   => lRecargo, "porcentajere" => NPCTREQ2, "bruto"        => NBRTIVA2, "neto"         => NBASIVA2, "impiva"       => NIMPIVA2, "impre"        => NIMPREQ2, "nivmh"        => 0, "ntransporte"  => 0, "npntver"      => 0 } )










      aAdd( aTotIva, {  "porcentajeiva" => NPCTIVA3, "logrecargo"   => lRecargo, "porcentajere" => NPCTREQ3, "bruto"        => NBRTIVA3, "neto"         => NBASIVA3, "impiva"       => NIMPIVA3, "impre"        => NIMPREQ3, "nivmh"        => 0, "ntransporte"  => 0, "npntver"      => 0 } )

   end

   if !lFacGas
      oTotalDoc:setImportesImpuesto( lIvaInc, nRegIva, nRouDiv )
   end

   if !lFacGas
      if lRecargo .AND. lIvaInc
         nTotBrt         := oTotalDoc:getTotalBruto()
      end
   else
      nTotBrt            := NBRTIVA1 + NBRTIVA2 + NBRTIVA3
   end


   if lFacGas
      nTotNet           := NBASIVA1 + NBASIVA2 + NBASIVA3
   else
      nTotNet           := oTotalDoc:getTotalNeto()
   end



   if lFacGas
   nTotIva           := Round( NIMPIVA1 + NIMPIVA2 + NIMPIVA3, nRinDiv )
   else
   nTotIva           := oTotalDoc:getTotalIva()
   end



   if lFacGas
   nTotReq           := Round( NIMPREQ1 + NIMPREQ2 + NIMPREQ3, nRinDiv )
   else
   nTotReq           := oTotalDoc:getTotalRE()
   end




   nTotIvm           := oTotalDoc:getTotalIvmh()



   nTotImp           := Round( nTotIva + nTotReq , nRinDiv )
   if !uFieldEmpresa( "lIvaImpEsp" )
      nTotImp        += Round( nTotIvm , nRinDiv )
   end



   if isNum( nTipRet )
      if nTipRet <= 1
         nTotRet     := Round( ( nTotNet - nTotSup ) * nPctRet / 100, nRinDiv )
      else
         nTotRet     := Round( ( nTotNet - nTotSup + nTotIva ) * nPctRet / 100, nRinDiv )
      end
   end



   nTotFac           := Round( nTotNet + nTotImp - nTotRet, nRinDiv )



   if cFacPrvP <> nil
      nPagFac        := nPagFacPrv( cFactura, cFacPrvP, cCodDiv, cDiv, .T., aTmp )
   end







   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet        := nCnv2Div( nTotNet, cCodDiv, cDivRet )
      nTotIva        := nCnv2Div( nTotIva, cCodDiv, cDivRet )
      nTotReq        := nCnv2Div( nTotReq, cCodDiv, cDivRet )
      nTotFac        := nCnv2Div( nTotFac, cCodDiv, cDivRet )
      cPirDiv        := cPirDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( nTotFac, cPirDiv ), nTotFac ) )



function nVtaFacPrv( cCodPrv, dDesde, dHasta, cFacPrvT, cFacPrvL, cFacPrvP, cIva, cDiv, nYear )

   local nCon     := 0
   local nRec     := ( cFacPrvT )->( Recno() )





   if ( cFacPrvT )->( dbSeek( cCodPrv ) )

      while ( cFacPrvT )->cCodPrv == cCodPrv .AND. !( cFacPrvT )->( Eof() )



         if ( dDesde == nil .OR. ( cFacPrvT )->dFecFac >= dDesde )    .AND. ( dHasta == nil .OR. ( cFacPrvT )->dFecFac <= dHasta )    .AND. ( nYear == nil .OR. Year( ( cFacPrvT )->dFecFac ) == nYear )

            nCon  += nTotFacPrv( ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac, cFacPrvT, cFacPrvL, cIva, cDiv, cFacPrvP, nil, cDivEmp(), .F. )

         end

         ( cFacPrvT )->( dbSkip() )

      end

   end

   ( cFacPrvT )->( dbGoTo( nRec ) )

return nCon






function nCobFacPrv( cCodPrv, dDesde, dHasta, cFacPrvT, cFacPrvP, cIva, cDiv, lOnlyCob, nYear )

   local nCob        := 0
   local nOrd        := ( cFacPrvT )->( OrdSetFocus( "cCodPrv" ) )
   local nRec        := ( cFacPrvT )->( Recno() )

   If( lOnlyCob == nil, lOnlyCob := .T., ) ;





   if ( cFacPrvT )->( dbSeek( cCodPrv ) )

      while ( cFacPrvT )->cCodPrv = cCodPrv .AND. !( cFacPrvT )->( Eof() )



         if ( dDesde == nil .OR. ( cFacPrvT )->DFECFAC >= dDesde ) .AND. ( dHasta == nil .OR. ( cFacPrvT )->DFECFAC <= dHasta ) .AND. ( nYear == nil .OR. Year( ( cFacPrvT )->dFecFac ) == nYear )

            nCob  += nPagFacPrv( ( cFacPrvT )->cSerFac + Str( (cFacPrvT)->nNumFac ) + (cFacPrvT)->cSufFac, cFacPrvP, cDivEmp(), cDiv, lOnlyCob )

         end

         ( cFacPrvT )->( dbSkip() )

      end

   end

   ( cFacPrvT )->( OrdSetFocus( nOrd ) )
   ( cFacPrvT )->( dbGoTo( nRec ) )

return nCob



FUNCTION mkFacPrv( cPath, oMeter )

   IF oMeter <> NIL
      oMeter:cText   := "Generando Bases"
      sysrefresh()
   end

   createFiles( cPath )

   rxFacPrv( cPath, cLocalDriver() )

RETURN NIL



FUNCTION rxFacPrv( cPath, cDriver )

   local cFacPrvT
   local cFacPrvL

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;





   if !lExistTable( cPath + "FacPrvT.Dbf", cDriver ) .OR.  !lExistTable( cPath + "FacPrvL.Dbf", cDriver ) .OR.  !lExistTable( cPath + "FacPrvI.Dbf", cDriver ) .OR.  !lExistTable( cPath + "FacPrvD.Dbf", cDriver ) .OR.  !lExistTable( cPath + "FacPrvS.Dbf", cDriver )
      createFiles( cPath )
   end





   fEraseIndex( cPath + "FacPrvT.Cdx", cDriver )
   fEraseIndex( cPath + "FacPrvL.Cdx", cDriver )
   fEraseIndex( cPath + "FacPrvI.Cdx", cDriver )
   fEraseIndex( cPath + "FacPrvD.Cdx", cDriver )
   fEraseIndex( cPath + "FacPrvS.Cdx", cDriver )

   dbUseArea( .T., cDriver, cPath + "FACPRVT.DBF", cCheckArea( "FACPRVT", @cFacPrvT ), .F. )

   if !( cFacPrvT )->( neterr() )

      ( cFacPrvT )->( __dbPack() )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "NNUMFAC", "CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "DFECFAC", "DFECFAC", {|| Field->DFECFAC } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "CCODPRV", "CCODPRV", {|| Field->CCODPRV } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "CNOMPRV", "Upper( CNOMPRV )", {|| Upper( Field->CNOMPRV ) } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cSuPed", "Upper( cSuPed )", {|| Upper( Field->cSuPed ) } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cNumDoc", "Upper( cNumDoc )", {|| Upper( Field->cNumDoc ) } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cNfc", "Upper( cNfc )", {||  Upper( Field->cNfc ) } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "CTURFAC", "CTURFAC + CSUFFAC + cCodCaj", {|| Field->CTURFAC + Field->CSUFFAC + Field->cCodCaj } ) )

      ( cFacPrvT)->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT)->( ordCreate( cPath + "FacPrvT.Cdx", "cCodUsr", "Field->cCodUsr + Dtos( Field->dFecChg ) + Field->cTimChg", {|| Field->cCodUsr + Dtos( Field->dFecChg ) + Field->cTimChg } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cCodPago", "cCodPago", {|| Field->cCodPago } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "iNumFac", "'03' + CSERFAC + STR( NNUMFAC ) + Space( 1 ) + CSUFFAC", {|| "03" + Field->CSERFAC + STR( Field->NNUMFAC ) + Space( 1 ) + Field->CSUFFAC } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cPrvFac", "cCodPrv + Upper( cSuPed )", {|| Field->cCodPrv + Upper( Field->cSuPed ) } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "cCtrCoste", "cCtrCoste", {|| Field->cCtrCoste } ) )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}, , , , , , , , , .T.  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FACPRVT.CDX", "DDESFEC", "DFECFAC", {|| Field->DFECFAC } ) )

      ( cFacPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de proveedores" )
   end





   dbUseArea( .T., cDriver, cPath + "FACPRVL.DBF", cCheckArea( "FACPRVL", @cFacPrvL ), .F. )
   if !( cFacPrvL )->( neterr() )
      ( cFacPrvL )->( __dbPack() )

      ( cFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "NNUMFAC", "CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( cFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "cRef", "cRef + cValPr1 + cValPr2", {|| Field->cRef + Field->cValPr1 + Field->cValPr2 }, ) )

      ( cFacPrvL )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cFacPrvL )->( ordCreate( cPath + "FacPrvL.Cdx", "cRefLote", "cRef + cValPr1 + cValPr2 + cLote", {|| Field->cRef + Field->cValPr1 + Field->cValPr2 + Field->cLote } ) )

      ( cFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "Lote", "cLote", {|| Field->cLote }, ) )

      ( cFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "cRefPrv", "cSerFac + Str( nNumFac ) + cSufFac + cRef + cRefPrv", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Field->cRef + Field->cRefPrv } ) )

      ( cFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}, , , , , , , , , .T. ) )
      ( cFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "cRefFec", "cRef + dTos( dFecFac )", {|| Field->cRef + dTos( Field->dFecFac ) } ) )

      ( cFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvL )->( ordCreate( cPath + "FACPRVL.CDX", "iNumFac", "'03' + CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| "03" + Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( cFacPrvL )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cFacPrvL )->( ordCreate( cPath + "FACPRVL.Cdx", "cArtLote", "cRef + cLote", {|| Field->cRef + Field->cLote } ) )

      ( cFacPrvL )->( ordCondSet( "!lValidado .and. !lControl .and. nCtlStk < 2 .and. !Deleted()", {|| !Field->lValidado .AND. !Field->lControl .AND. Field->nCtlStk < 2 .AND. !Deleted()}, , , , , , , , , .T. ) )
      ( cFacPrvL )->( ordCreate( cPath + "FacPrvL.Cdx", "cStkFast", "cRef + cAlmLin + dtos( dFecFac ) + tFecFac", {|| Field->cRef + Field->cAlmLin + dtos( Field->dFecFac ) + Field->tFecFac } ) )

      ( cFacPrvL )->( ordCondSet( "!lValidado .and. !lControl .and. nCtlStk < 2 .and. !Deleted()", {|| !Field->lValidado .AND. !Field->lControl .AND. Field->nCtlStk < 2 .AND. !Deleted()}, , , , , , , , , .T. ) )
      ( cFacPrvL )->( ordCreate( cPath + "FacPrvL.Cdx", "cStkFastOu", "cRef + cAlmOrigen + dtos( dFecFac ) + tFecFac", {|| Field->cRef + Field->cAlmOrigen + dtos( Field->dFecFac ) + Field->tFecFac } ) )

      ( cFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvL )->( ordCreate( cPath + "FacPrvL.CDX", "nPosPrint", "cSerFac + Str( nNumFac ) + cSufFac + Str( nPosPrint )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + str( Field->nPosPrint ) } ) )

      ( cFacPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvL )->( ordCreate( cPath + "FacPrvL.CDX", "dFecFac", "dFecFac", {|| Field->dFecFac } ) )

      ( cFacPrvL )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de proveedores" )
   end

   dbUseArea( .T., cDriver, cPath + "FacPrvI.DBF", cCheckArea( "FacPrvI", @cFacPrvT ), .F. )
   if !( cFacPrvT )->( neterr() )
      ( cFacPrvT )->( __dbPack() )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FacPrvI.CDX", "nNumFac", "cSerie + Str( nNumFac ) + cSufFac", {|| Field->cSerie + STR( Field->nNumFac ) + Field->cSufFac } ) )

      ( cFacPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de proveedores" )
   end

   dbUseArea( .T., cDriver, cPath + "FacPrvD.DBF", cCheckArea( "FacPrvD", @cFacPrvT ), .F. )
   if !( cFacPrvT )->( neterr() )
      ( cFacPrvT )->( __dbPack() )

      ( cFacPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FacPrvD.CDX", "nNumFac", "cSerFac + STR( nNumFac ) + cSufFac", {|| Field->cSerFac + STR( Field->nNumFac ) + Field->cSufFac } ) )

      ( cFacPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas de proveedores" )
   end

   dbUseArea( .T., cDriver, cPath + "FacPrvS.DBF", cCheckArea( "FacPrvS", @cFacPrvT ), .F. )
   if !( cFacPrvT )->( neterr() )
      ( cFacPrvT )->( __dbPack() )

      ( cFacPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FacPrvS.CDX", "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumLin )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumLin ) } ) )

      ( cFacPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FacPrvS.CDX", "cRefSer", "cRef + cAlmLin + cNumSer", {|| Field->cRef + Field->cAlmLin + Field->cNumSer } ) )

      ( cFacPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cFacPrvT )->( ordCreate( cPath + "FacPrvS.CDX", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( cFacPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de numeros de series de facturas de proveedores" )
   end

RETURN NIL



function aIncFacPrv()

   local aIncFacPrv  := {}

   aAdd( aIncFacPrv, { "cSerie",  "C",    1,  0, "Serie de factura" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "nNumFac", "N",    9,  0, "Número de factura" ,             "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "cSufFac", "C",    2,  0, "Sufijo de factura" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,        "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,  "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "lListo",  "L",    1,  0, "Lógico de listo" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "lAviso",  "L",    1,  0, "Lógico de aviso" ,               "",                   "", "( cDbfCol )" } )

return ( aIncFacPrv )



function aFacPrvDoc()

   local aFacPrvDoc  := {}

   aAdd( aFacPrvDoc, { "cSerFac", "C",    1,  0, "Serie de facturas" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "nNumFac", "N",    9,  0, "Número de facturas" ,              "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cSufFac", "C",    2,  0, "Sufijo de facturas" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

return ( aFacPrvDoc )







FUNCTION dFecFacPrv( cFacPrv, cFacPrvT )

   local dFecFac  := Ctod("")

   IF (cFacPrvT)->( dbSeek( cFacPrv ) )
      dFecFac  := (cFacPrvT)->DFECFAC
   end

RETURN ( dFecFac )







FUNCTION tFecFacPrv( cFacPrv, cFacPrvT )

   local tFecFac  := Replicate( "0", 6 )

   IF ( cFacPrvT )->( dbSeek( cFacPrv ) )
      tFecFac  := ( cFacPrvT )->TFECFAC
   end

RETURN ( tFecFac )






FUNCTION cPrvFacPrv( cFacPrv, cFacPrvT )

   local cCodPrv  := ""

   IF (cFacPrvT)->( dbSeek( cFacPrv ) )
      cCodPrv  := (cFacPrvT)->CCODPRV
   end

RETURN ( cCodPrv )






FUNCTION cNbrFacPrv( cFacPrv, cFacPrvT )

   local cNomPrv  := ""

   IF (cFacPrvT)->( dbSeek( cFacPrv ) )
      cNomPrv  := (cFacPrvT)->CNOMPRV
   end

RETURN ( cNomPrv )



FUNCTION nEstFacPrv( cFacPrv, cFacPrvT, cFacPrvP )

   local nBitmap  := 3

   if ( cFacPrvT )->( dbSeek( cFacPrv ) )
      nBitmap     := ChkPagFacPrv( cFacPrvT, cFacPrvP )
   end

RETURN nBitmap







FUNCTION GenPgoFacPrv( cNumFac, cFacPrvT, cFacPrvL, cFacPrvP, cPrv, cIva, cFPago, cDiv, aTmp )

   local nCobro
   local cCodPgo
   local cSerFac
   local nNumFac
   local cSufFac
   local cDivFac
   local nVdvFac
   local dFecFac
   local cCodPrv
   local cNomPrv
   local cCodUsr
   local cCodCaj
   local nTotal
   local nTotCob
   local nDec
   local nInc        := 0
   local n           := 0
   local nTotAcu     := 0
   local nPlazos     := 0
   local cBanco
   local cPaisIBAN
   local cCtrlIBAN
   local cEntidad
   local cSucursal
   local cControl
   local cCuenta

   if aTmp <> nil
      cSerFac        := aTmp[ 1    ]
      nNumFac        := aTmp[ 2    ]
      cSufFac        := aTmp[ 3    ]
      cDivFac        := aTmp[ 36    ]
      nVdvFac        := aTmp[ 37    ]
      dFecFac        := aTmp[ 5    ]
      cCodPgo        := aTmp[ 23   ]
      cCodPrv        := aTmp[ 6    ]
      cNomPrv        := aTmp[ 9    ]
      cCodUsr        := aTmp[ 47    ]
      cCodCaj        := aTmp[ 8    ]
      cEntidad       := aTmp[ 78    ]
      cSucursal      := aTmp[ 79    ]
      cControl       := aTmp[ 80    ]
      cCuenta        := aTmp[ 81    ]
      cBanco         := aTmp[ 75     ]
      cPaisIBAN      := aTmp[ 76  ]
      cCtrlIBAN      := aTmp[ 77  ]
      cEntidad       := aTmp[ 78    ]
      cSucursal      := aTmp[ 79    ]
      cControl       := aTmp[ 80    ]
      cCuenta        := aTmp[ 81    ]
   else
      cSerFac        := ( cFacPrvT )->cSerFac
      nNumFac        := ( cFacPrvT )->nNumFac
      cSufFac        := ( cFacPrvT )->cSufFac
      cDivFac        := ( cFacPrvT )->cDivFac
      nVdvFac        := ( cFacPrvT )->nVdvFac
      dFecFac        := ( cFacPrvT )->dFecFac
      cCodPgo        := ( cFacPrvT )->cCodPago
      cCodPrv        := ( cFacPrvT )->cCodPrv
      cNomPrv        := ( cFacPrvT )->cNomPrv
      cCodUsr        := ( cFacPrvT )->cCodUsr
      cCodCaj        := ( cFacPrvT )->cCodCaj
      cBanco         := ( cFacPrvT )->cBanco
      cPaisIBAN      := ( cFacPrvT )->cPaisIBAN
      cCtrlIBAN      := ( cFacPrvT )->cCtrlIBAN
      cEntidad       := ( cFacPrvT )->cEntBnc
      cSucursal      := ( cFacPrvT )->cSucBnc
      cControl       := ( cFacPrvT )->cDigBnc
      cCuenta        := ( cFacPrvT )->cCtaBnc
   end





   nTotal            := nTotFacPrv( cNumFac, cFacPrvT, cFacPrvL, cIva, cDiv, cFacPrvP, nil, nil, .F. )
   nTotCob           := nPagFacPrv( cNumFac, cFacPrvP, nil, cDiv, .F. )
   nDec              := nRouDiv( cDivFac, cDiv )

   if nTotal <> nTotCob





      if ( cFacPrvP )->( dbSeek( cNumFac ) )
         while cNumFac == ( cFacPrvP )->cSerFac + Str( ( cFacPrvP )->nNumFac ) + ( cFacPrvP )->cSufFac .AND. !( cFacPrvP )->( eof() )
            if !( cFacPrvP )->lCobrado .AND. dbLock( cFacPrvP )
               ( cFacPrvP )->( dbDelete() )
               ( cFacPrvP )->( dbUnLock() )
            else
               nInc  := ( cFacPrvP )->nNumRec
            end
            ( cFacPrvP )->( dbSkip() )
         end
      end

      nTotal         -= nPagFacPrv( cNumFac, cFacPrvP, nil, cDiv, .F. )





      if ( cFPago )->( dbSeek( cCodPgo ) )

         nTotAcu        := nTotal
         nPlazos        := Max( ( cFPago )->nPlazos, 1 )

         for n := 1 to nPlazos

            if n <> nPlazos
               nTotAcu  -= Round( nTotal / nPlazos, nDec )
            end

            ( cFacPrvP)->( dbAppend() )

            ( cFacPrvP )->cSerFac       := cSerFac
            ( cFacPrvP )->nNumFac       := nNumFac
            ( cFacPrvP )->cSufFac       := cSufFac
            ( cFacPrvP )->cCodPrv       := cCodPrv
            ( cFacPrvP )->cNomPrv       := cNomPrv
            ( cFacPrvP )->nNumRec       := ++nInc
            ( cFacPrvP )->nImporte      := if( n <> nPlazos, Round( nTotal / nPlazos, nDec ), Round( nTotAcu, nDec ) )
            ( cFacPrvP )->cTurRec       := cCurSesion()
            ( cFacPrvP )->cDescrip      := "Recibo nº" + AllTrim( Str( ( cFacPrvP )->nNumRec ) ) + " de factura " + cSerFac  + "/" + allTrim( Str( nNumFac ) ) + "/" + cSufFac
            ( cFacPrvP )->cDivPgo       := cDivFac
            ( cFacPrvP )->nVdvPgo       := nVdvFac
            ( cFacPrvP )->lCobRado      := ( ( cFPago )->nCobRec == 1 )
            ( cFacPrvP )->dPreCob       := dFecFac
            ( cFacPrvP )->dFecVto       := dNexDay( dFecFac + ( cFPago )->nPlaUno + ( ( cFPago )->nDiaPla * ( n - 1 ) ), cPrv )
            ( cFacPrvP )->cCtaRec       := ( cFPago )->cCtaCobro
            ( cFacPrvP )->dFecChg       := GetSysDate()
            ( cFacPrvP )->cTimChg       := Time()
            ( cFacPrvP )->cCodPgo       := cCodPgo
            ( cFacPrvP )->lNotArqueo    := .F.
            ( cFacPrvP )->cCodCaj       := cCodCaj
            ( cFacPrvP )->cCodUsr       := cCodUsr

            if !empty( ( cFacPrvT )->cCtrCoste )
               ( cFacPrvP )->cCtrCoste  := ( cFacPrvT )->cCtrCoste
            endif

            if ( cFPago )->lUtlBnc
               ( cFacPrvP )->cEPaisIBAN := ( cFPago )->cPaisIBAN
               ( cFacPrvP )->cECtrlIBAN := ( cFPago )->cCtrlIBAN
               ( cFacPrvP )->cBncEmp    := ( cFPago )->cBanco
               ( cFacPrvP )->cEntEmp    := ( cFPago )->cEntBnc
               ( cFacPrvP )->cSucEmp    := ( cFPago )->cSucBnc
               ( cFacPrvP )->cDigEmp    := ( cFPago )->cDigBnc
               ( cFacPrvP )->cCtaEmp    := ( cFPago )->cCtaBnc
            end

            ( cFacPrvP )->cPaisIBAN     := cPaisIBAN
            ( cFacPrvP )->cCtrlIBAN     := cCtrlIBAN
            ( cFacPrvP )->cBncPrv       := cBanco
            ( cFacPrvP )->cEntPrv       := cEntidad
            ( cFacPrvP )->cSucPrv       := cSucursal
            ( cFacPrvP )->cDigPrv       := cControl
            ( cFacPrvP )->cCtaPrv       := cCuenta

            if ( cFPago )->nCobRec == 1
               ( cFacPrvP )->dEntrada   := dNexDay( dFecFac + ( cFPago )->nPlaUno + ( ( cFPago )->nDiaPla * ( n - 1 ) ), cPrv )
            end

            ( cFacPrvP )->( dbUnLock() )

         next

      end

   end

RETURN NIL






function nTotVFacPrv( cCodArt, cFacPrvL, nDinDiv, nDirDiv )

   local nTotVta  := 0
   local nRecno   := ( cFacPrvL )->( Recno() )

   if ( cFacPrvL )->( dbSeek( cCodArt ) )

      while ( cFacPrvL )->cRef == cCodArt .AND. !( cFacPrvL )->( eof() )

         nTotVta  += nTotLFacPrv( cFacPrvL, nDinDiv, nDirDiv )

         ( cFacPrvL )->( dbSkip() )

      end

   end

   ( cFacPrvL )->( dbGoTo( nRecno ) )

return ( nTotVta )






function nTotDFacPrv( cCodArt, cFacPrvL, cCodAlm )

   local nTotVta  := 0
   local nRecno   := ( cFacPrvL )->( Recno() )

   if ( cFacPrvL )->( dbSeek( cCodArt ) )

      while ( cFacPrvL )->CREF == cCodArt .AND. !( cFacPrvL )->( eof() )

         if cCodAlm <> nil
            if cCodAlm == ( cFacPrvL )->cAlmLin
               nTotVta  += nTotNFacPrv( cFacPrvL )
            end
         else
            nTotVta     += nTotNFacPrv( cFacPrvL )
         end

         ( cFacPrvL )->( dbSkip() )

      end

   end

   ( cFacPrvL )->( dbGoTo( nRecno ) )

return ( nTotVta )







FUNCTION dPrvFacPrv( cFacPrv, cFacPrvT )

   local cCodPrv  := ""

   if dbSeekInOrd( cFacPrv, "nNumFac", cFacPrvT )
      cCodPrv     := (cFacPrvT)->cCodPrv
   end

RETURN ( cCodPrv )






FUNCTION cPgoFacPrv( cFacPrv, cFacPrvT )

   local cCodPgo  := ""

   if dbSeekInOrd( cFacPrv, "nNumFac", cFacPrvT )
      cCodPgo     := ( cFacPrvT )->cCodPago
   end

RETURN ( cCodPgo )



FUNCTION cNomFacPrv( cFacPrv, cFacPrvT )

   local cNomPrv := ""

   if dbSeekInOrd( cFacPrv, "nNumFac", cFacPrvT )
      cNomPrv  := ( cFacPrvT )->cNomPrv
   end

RETURN ( cNomPrv )



FUNCTION cCodFacPrv( cFacPrv, uFacPrvT )

   local cCodPrv := ""

   if ValType( uFacPrvT ) == "O"

      if uFacPrvT:SeekInOrd( cFacPrv, "nNumFac" )
         cCodPrv  := uFacPrvT:cCodPrv
      end

   else

      if dbSeekInOrd( cFacPrv, "nNumFac", D():FacturasProveedores( nView ) )
         cCodPrv  := ( uFacPrvT )->cCodPrv
      end

   end

RETURN ( cCodPrv )







FUNCTION lConFacPrv( cFacPrv, cFacPrvT )

   local lConFac  := .F.

   if dbSeekInOrd( cFacPrv, "nNumFac", cFacPrvT )
      lConFac     := ( cFacPrvT )->lContab
   end

RETURN ( lConFac )



function dFecVtoPrv( nVto )

   local dVto     := Ctod( "  /  /  " )

   If( nVto == nil, nVto := 1, ) ;

   if nVto <= len( aDatVcto )
      dVto        := aDatVcto[ nVto ]
   end

return ( dVto )



function nImpVtoPrv( nVto )

   local nImp     := 0

   If( nVto == nil, nVto := 1, ) ;

   if nVto <= len( aImpVcto )
      nImp        := aImpVcto[ nVto ]
   end

return ( nImp )



FUNCTION cProFacPrv( cFacPro, cFacPrvT )

   local cCodPro  := ""

   if dbSeekInOrd( cFacPro, "nNumFac", cFacPrvT )
      cCodPro     := ( cFacPrvT )->cCodPro
   end

RETURN ( cCodPro )



FUNCTION nTotNFacPrv( uDbf )

   local nTotUnd

   If( uDbf == nil, uDbf := D():FacturasProveedoresLineas( nView ), ) ;

   do case
      case ValType( uDbf ) == "A"
         nTotUnd  := uDbf[ 13 ]
         nTotUnd  *= NotBulto( uDbf[ 97 ] )
         nTotUnd  *= NotCaja( uDbf[ 10 ] )
         nTotUnd  *= NotCero( uDbf[ 63 ] )
         nTotUnd  *= NotCero( uDbf[ 84 ] )
         nTotUnd  *= NotCero( uDbf[ 85 ] )
         nTotUnd  *= NotCero( uDbf[ 86 ] )

      case ValType( uDbf ) == "O"
         nTotUnd  := uDbf:nUniCaja
         nTotUnd  *= NotBulto( uDbf:nBultos )
         nTotUnd  *= NotCaja( uDbf:nCanEnt )
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )

      otherwise
         nTotUnd  := ( uDbf )->nUniCaja
         nTotUnd  *= NotBulto( ( uDbf )->nBultos )
         nTotUnd  *= NotCaja( ( uDbf )->nCanEnt )
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )

   end

RETURN ( nTotUnd )



FUNCTION nBrtLFacPrv( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo := 0

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRec == nil, nRec := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacPrv( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo       *= nTotNFacPrv( uTmpLin )

   nCalculo       := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nIvaUFacPrv( dbfTmp, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacPrv( dbfTmp, nDec, nVdv )

   if !( dbfTmp )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmp )->nIva / 100
   end

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nIvaLFacPrv( dbfLin, nDec, nRou, nVdv, cPorDiv )

   local nCalculo

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRou == nil, nRou := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotLFacPrv( dbfLin, nDec, nRou, nVdv )

   nCalculo       := Round( nCalculo * ( dbfLin )->nIva / 100, nRou )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )







FUNCTION aTotFacPrv( cFactura, cFacPrvT, cFacPrvL, cIva, cDiv, cFacPrvP, cDivRet )

   nTotFacPrv( cFactura, cFacPrvT, cFacPrvL, cIva, cDiv, cFacPrvP, nil, cDivRet )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotFac, aTotIva, nTotRet } )



Function sTotFacPrv( cFactura, cFacPrvT, cFacPrvL, cIva, cDiv, cFacPrvP, cDivRet )

   local sTotal

   nTotFacPrv( cFactura, cFacPrvT, cFacPrvL, cIva, cDiv, cFacPrvP, nil, cDivRet )

   sTotal                                 := sTotal()
   sTotal:nTotalBruto                     := nTotBrt
   sTotal:nTotalSuplidos                  := nTotSup
   sTotal:nTotalNeto                      := nTotNet
   sTotal:nTotalIva                       := nTotIva
   sTotal:aTotalIva                       := aTotIva
   sTotal:nTotalRecargoEquivalencia       := nTotReq
   sTotal:nTotalDocumento                 := nTotFac
   sTotal:nTotalDescuentoGeneral          := nTotDto
   sTotal:nTotalDescuentoProntoPago       := nTotDpp
   sTotal:nTotalDescuentoUno              := nTotUno
   sTotal:nTotalDescuentoDos              := nTotDos

Return ( sTotal )







FUNCTION nNetLFacPrv( uFacPrvL, uFacPrvT, nDec, nRec, nVdv, cPirDiv )

   local nCalculo

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRec == nil, nRec := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nNetUFacPrv( uFacPrvL, uFacPrvT, nDec, nRec, nVdv )

   nCalculo       *= nTotNFacPrv( uFacPrvL )





   if ValType( uFacPrvL ) == "A"

      if uFacPrvL[ 8 ]<> 0
         nCalculo    -= nCalculo * uFacPrvL[ 8 ] / 100
      end

   else

      if ( uFacPrvL )->nDto <> 0
         nCalculo    -= nCalculo * ( uFacPrvL )->nDto / 100
      end

   end

   nCalculo          := Round( nCalculo, nRec )

RETURN ( if( cPirDiv <> NIL, Trans( nCalculo, cPirDiv ), nCalculo ) )



FUNCTION aDocFacPrv()

   local aDoc  := {}





   aAdd( aDoc, { "Empresa",         "EM" } )
   aAdd( aDoc, { "Factura",         "FP" } )
   aAdd( aDoc, { "Proveedor",       "PR" } )
   aAdd( aDoc, { "Almacen",         "AL" } )
   aAdd( aDoc, { "Divisas",         "DV" } )
   aAdd( aDoc, { "Formas de pago",  "PG" } )
   aAdd( aDoc, { "Recibos",         "RP" } )

RETURN ( aDoc )



function aItmFacPrv()

   local aItmFacPrv  := {}

   aAdd( aItmFacPrv, { "CSERFAC"    ,"C",  1, 0, "Serie de factura"                         ,"",                   "", "( cDbf )", "A" } )
   aAdd( aItmFacPrv, { "NNUMFAC"    ,"N",  9, 0, "Número de factura"                        ,"'999999999'",        "", "( cDbf )", 0 } )
   aAdd( aItmFacPrv, { "CSUFFAC"    ,"C",  2, 0, "Sufijo de factura"                        ,"",                   "", "( cDbf )", Space( 2 ) } )
   aAdd( aItmFacPrv, { "CTURFAC"    ,"C",  6, 0, "Sesión del factura"                       ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "DFECFAC"    ,"D",  8, 0, "Fecha de la factura"                      ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODPRV"    ,"C", 12, 0, "Código del proveedor"                     ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODALM"    ,"C", 16, 0, "Código de almacen"                        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODCAJ"    ,"C",  3, 0, "Código de caja"                           ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CNOMPRV"    ,"C",150, 0, "Nombre del proveedor"                     ,"'@!'",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDIRPRV"    ,"C",200, 0, "Domicilio del proveedor"                  ,"'@!'",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CPOBPRV"    ,"C",200, 0, "Población del proveedor"                  ,"'@!'",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CPROVPROV"  ,"C",100, 0, "Provincia del proveedor"                  ,"'@!'",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CPOSPRV"    ,"C",  5, 0, "Código postal del proveedor"              ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDNIPRV"    ,"C", 30, 0, "DNI/CIF del proveedor"                    ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LLIQUIDADA" ,"L",  1, 0, "Lógico de la liquidación"                 ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LCONTAB"    ,"L",  1, 0, "Lógico de la contabilización"             ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "DFECENT"    ,"D",  8, 0, "Fecha de entrada"                         ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CSUPED"     ,"C", 50, 0, "Su factura"                               ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCONDENT"   ,"C", 20, 0, "Condición de entrada"                     ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "MCOMENT"    ,"M", 10, 0, "Comentarios"                              ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CEXPED"     ,"C", 20, 0, "Expedición"                               ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "COBSERV"    ,"C", 20, 0, "Observaciones"                            ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODPAGO"   ,"C",  2, 0, "Código del tipo de pago"                  ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NBULTOS"    ,"N",  3, 0, "Número de bultos"                         ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NPORTES"    ,"N",  6, 0, "Valor de los portes"                      ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CNUMALB"    ,"C", 12, 0, "Número de albaran"                        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CSUFALB"    ,"C",  2, 0, "Sufijo de albaran"                        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LIMPALB"    ,"L",  1, 0, "Factura importada desde albaranes"        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDTOESP"    ,"C", 50, 0, "Descripción de descuento especial"        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NDTOESP"    ,"N",  5, 2, "Porcentaje de descuento especial"         ,"'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDPP"       ,"C", 50, 0, "Descripción descuento por pronto pago"    ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NDPP"       ,"N",  5, 2, "Porcentaje de descuento por pronto pago"  ,"'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LRECARGO"   ,"L",  1, 0, "Lógico para recargo"                      ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NIRPF"      ,"N",  4, 1, ""                                         ,"'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODAGE"    ,"C",  3, 0, "Código del agente"                        ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDIVFAC"    ,"C",  3, 0, "Código de divisa"                         ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NVDVFAC"    ,"N", 13, 6, "Valor del cambio de la divisa"            ,"'@E 999,999.999999'","", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LSNDDOC"    ,"L",  1, 0, "Enviar documento por internet"            ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDTOUNO"    ,"C", 25, 0, "Descripción de primer descuento personalizado", "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NDTOUNO"    ,"N",  5, 2, "Porcentaje de primer descuento personalizado",  "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CDTODOS"    ,"C", 25, 0, "Descripción de segundo descuento personalizado","",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "NDTODOS"    ,"N",  5, 2, "Porcentaje de segundo descuento personalizado", "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODPRO"    ,"C",  9, 0, "Código de proyecto en contabilidad",            "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LRECDOC"    ,"L",  1, 0, "Documento recibido por internet"          ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LCLOFAC"    ,"L",  1, 0, ""                                         ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CNUMDOC"    ,"C", 50, 0, "Número de documento"                      ,"",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CCODUSR"    ,"C",  3, 0, "Código de usuario",                        "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "LIMPRIMIDO" ,"L",  1, 0, "Lógico de imprimido del documento",        "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "DFECIMP"    ,"D",  8, 0, "Última fecha de impresión del documento",  "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "CHORIMP"    ,"C",  5, 0, "Hora de la última impresión del documento","",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTipRet"    ,"N",  1, 0, "Tipo de retención ( 1. Base / 2. Base+IVA )","",                 "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nPctRet"    ,"N",  6, 2, "Porcentaje de retención IRPF",             "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "dFecChg"    ,"D",  8, 0, "Fecha de modificación del documento",      "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cTimChg"    ,"C",  5, 0, "Hora de modificación del documento",       "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cCodDlg"    ,"C",  2, 0, "Código delegación",                        "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nRegIva"    ,"N",  1, 0, "Régimen de " + cImp(),                     "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "lFacGas"    ,"L",  1, 0, "Lógico factura de gastos",                 "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "mComGas"    ,"M", 10, 0, "Comentario de gastos",                     "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nNetGas1"   ,"N", 16, 6, "Primer importe neto de gastos",            "cPirDivFac",         "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nNetGas2"   ,"N", 16, 6, "Segundo importe neto de gastos",           "cPirDivFac",         "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nNetGas3"   ,"N", 16, 6, "Tercer importe neto de gastos",            "cPirDivFac",         "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nIvaGas1"   ,"N",  6, 2, "Porcentaje primer tipo " + cImp() + " de gastos",  "'@EZ 99.99'","", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nIvaGas2"   ,"N",  6, 2, "Porcentaje segundo tipo " + cImp() + " de gastos", "'@EZ 99.99'","", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nIvaGas3"   ,"N",  6, 2, "Porcentaje tercer tipo " + cImp() + " de gastos",  "'@EZ 99.99'","", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nReGas1"    ,"N",  6, 2, "Porcentaje primer R.E. de gastos",         "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nReGas2"    ,"N",  6, 2, "Porcentaje segundo R.E. de gastos",        "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nReGas3"    ,"N",  6, 2, "Porcentaje tercer R.E. de gastos",         "'@EZ 99.99'",        "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotNet"    ,"N", 16, 6, "Total neto",                               "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotIva"    ,"N", 16, 6, "Total " + cImp(),                          "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotReq"    ,"N", 16, 6, "Total req",                                "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotFac"    ,"N", 16, 6, "Total factura",                            "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cNFC"       ,"C", 20, 0, "Código NFC" ,                              "'@!",                "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "SubCta"     ,"C", 12, 0, "Código subcuenta para gastos enlace contaplus", "",              "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "nTotSup"    ,"N", 16, 6, "Total gastos suplidos",                    "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cBanco"     ,"C", 50, 0, "Nombre del banco del proveedor" ,          "",                   "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cPaisIBAN"  ,"C",  2, 0, "País IBAN de la cuenta bancaria del proveedor" ,          "",    "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cCtrlIBAN"  ,"C",  2, 0, "Dígito de control IBAN de la cuenta bancaria del proveedor" , "","", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cEntBnc"    ,"C",  4, 0, "Entidad de la cuenta bancaria del proveedor" ,          "",      "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cSucBnc"    ,"C",  4, 0, "Sucursal de la cuenta bancaria del proveedor" ,         "",      "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cDigBnc"    ,"C",  2, 0, "Dígito de control de la cuenta bancaria del proveedor" ,"",      "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cCtaBnc"    ,"C", 10, 0, "Cuenta bancaria del proveedor" ,                        "",      "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "lRECC"      ,"L",  1, 0, "Acogida al régimen especial del criterio de caja",      "",      "", "( cDbf )", .F. } )
   aAdd( aItmFacPrv, { "tFecFac"    ,"C",  6, 0, "Hora de la Factura" ,                     "",                    "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cCtrCoste"  ,"C",  9, 0, " Código del centro de coste" ,            "",                    "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cAlmOrigen" ,"C", 16, 0, "Almacén de origen de la mercancía" ,      "",           "",      "", "( cDbf )", nil } )

return ( aItmFacPrv )



function aCalFacPrv()





























   local aCalFacPrv :=  {{"aTotIva[1,1]", "N", 16,  6, "Bruto primer tipo de " + cImp(),    "cPirDivFac",         "aTotIva[1,1] != 0" }, { "aTotIva[2,1]", "N", 16,  6, "Bruto segundo tipo de " + cImp(),   "cPirDivFac",         "aTotIva[2,1] != 0" }, { "aTotIva[3,1]", "N", 16,  6, "Bruto tercer tipo de " + cImp(),    "cPirDivFac",         "aTotIva[3,1] != 0" }, { "aTotIva[1,2]", "N", 16,  6, "Base primer tipo de " + cImp(),     "cPirDivFac",         "aTotIva[1,2] != 0" }, { "aTotIva[2,2]", "N", 16,  6, "Base segundo tipo de " + cImp(),    "cPirDivFac",         "aTotIva[2,2] != 0" }, { "aTotIva[3,2]", "N", 16,  6, "Base tercer tipo de " + cImp(),     "cPirDivFac",         "aTotIva[3,2] != 0" }, { "aTotIva[1,3]", "N",  6,  2, "Porcentaje primer tipo " + cImp(),  "'@R 99 %'",          "aTotIva[1,3] != 0" }, { "aTotIva[2,3]", "N",  6,  2, "Porcentaje segundo tipo " + cImp(), "'@R 99 %'",          "aTotIva[2,3] != 0" }, { "aTotIva[3,3]", "N",  6,  2, "Porcentaje tercer tipo " + cImp(),  "'@R 99 %'",          "aTotIva[3,3] != 0" }, { "aTotIva[1,4]", "N",  6,  2, "Porcentaje primer tipo RE",   "'@R 99 %'",          "aTotIva[1,4] != 0" }, { "aTotIva[2,4]", "N",  6,  2, "Porcentaje segundo tipo RE",  "'@R 99 %'",          "aTotIva[2,4] != 0" }, { "aTotIva[3,4]", "N",  6,  2, "Porcentaje tercer tipo RE",   "'@R 99 %'",          "aTotIva[3,4] != 0" }, { "Round( aTotIva[1,2] * aTotIva[1,3] / 100, nDouDivFac )",   "N", 16, 6, "Importe primer tipo " + cImp(),  "cPirDivFac", "aTotIva[1,2] != 0" }, { "Round( aTotIva[2,2] * aTotIva[2,3] / 100, nDouDivFac )",   "N", 16, 6, "Importe segundo tipo " + cImp(), "cPirDivFac", "aTotIva[2,2] != 0" }, { "Round( aTotIva[3,2] * aTotIva[3,3] / 100, nDouDivFac )",   "N", 16, 6, "Importe tercer tipo " + cImp(),  "cPirDivFac", "aTotIva[3,2] != 0" }, { "Round( aTotIva[1,2] * aTotIva[1,4] / 100, nDouDivFac )",   "N", 16, 6, "Importe primer RE",        "cPirDivFac", "aTotIva[1,2] != 0" }, { "Round( aTotIva[2,2] * aTotIva[2,4] / 100, nDouDivFac )",   "N", 16, 6, "Importe segundo RE",       "cPirDivFac", "aTotIva[2,2] != 0" }, { "Round( aTotIva[3,2] * aTotIva[3,4] / 100, nDouDivFac )",   "N", 16, 6, "Importe tercer RE",        "cPirDivFac", "aTotIva[3,2] != 0" }, { "nTotBrt",      "N", 16,  6, "Total bruto",                 "cPirDivFac",         "lEnd" }, { "nTotDto",      "N", 16,  6, "Total descuento",             "cPirDivFac",         "lEnd" }, { "nTotDpp",      "N", 16,  6, "Total descuento pronto pago", "cPirDivFac",         "lEnd" }, { "nTotNet",      "N", 16,  6, "Total neto",                  "cPirDivFac",         "lEnd" }, { "nTotIva",      "N", 16,  6, "Total " + cImp(),             "cPirDivFac",         "lEnd" }, { "nTotReq",      "N", 16,  6, "Total RE",                    "cPirDivFac",         "lEnd" }, { "nTotRet",      "N", 16,  6, "Total retenciones por IRPF",  "cPirDivFac",         "lEnd" }, { "nTotFac",      "N", 16,  6, "Total factura",               "cPirDivFac",         "lEnd" }, { "nTotPage",     "N", 16,  6, "Total página",                "cPirDivFac",         "!lEnd" }, { "nPagina",      "N",  2,  0, "Número de página",            "'99'",               "" }, { "lEnd",         "L",  1,  0, "Fin del documento",           "",                   "" } }

return ( aCalFacPrv )



function aColFacPrv()

   local aColFacPrv  := {}

   aAdd( aColFacPrv, { "CSERFAC"    ,"C",  1, 0, "Serie de factura"            ,"",                    "", "( cDbfCol )", "A" } )
   aAdd( aColFacPrv, { "NNUMFAC"    ,"N",  9, 0, "Número de factura"           ,"'999999999'",         "", "( cDbfCol )", 0 } )
   aAdd( aColFacPrv, { "CSUFFAC"    ,"C",  2, 0, "Sufijo de factura"           ,"",                    "", "( cDbfCol )", Space( 2 ) } )
   aAdd( aColFacPrv, { "CREF"       ,"C", 18, 0, "Referencia artículo"         ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CREFPRV"    ,"C", 20, 0, "Referencia del proveedor"    ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CDETALLE"   ,"C",240, 0, "Detalle de articulo"         ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPREUNIT"   ,"N", 16, 6, "Precio unitario"             ,"cPinDivFac",          "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NDTO"       ,"N",  6, 2, ""                            ,"'@E 99,99'",          "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVA"       ,"N",  6, 2, "Porcentaje de " + cImp()     ,"'@E 99,99'",          "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NCANENT"    ,"N", 16, 6, "Cajas recibidas"             ,"MasUnd()",            "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LCONTROL"   ,"L",  1, 0, "Control reservado"           ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CUNIDAD"    ,"C",  2, 0, "Unidad de venta"             ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NUNICAJA"   ,"N", 16, 6, "Unidades recibidas"          ,"MasUnd()",            "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LCHGLIN"    ,"L",  1, 0, "Cambio de precio"            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "MLNGDES"    ,"M", 10, 0, "Descripción larga de artículo","",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NDTOLIN"    ,"N",  6, 2, "Descuento lineal"            ,"'@E 999,99'",         "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NDTOPRM"    ,"N",  6, 2, "Descuento por promoción"     ,"'@E 999,99'",         "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NDTORAP"    ,"N",  6, 2, "Descuento por rappels"       ,"'@E 999,99'",         "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPRECOM"    ,"N", 16, 6, "Precio de compra"            ,"cPinDivFac",          "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN1"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN2"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN3"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN4"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN5"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LBNFLIN6"   ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN1"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN2"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN3"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN4"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN5"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFLIN6"   ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR1"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR2"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR3"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR4"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR5"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NBNFSBR6"   ,"N",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN1"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN2"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN3"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN4"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN5"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NPVPLIN6"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN1"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN2"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN3"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN4"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN5"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN6"   ,"N", 16, 6, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NIVALIN"    ,"N",  6, 2, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LIVALIN"    ,"L",  1, 0, ""                            ,"",                    "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODPR1"    ,"C", 20, 0, "Código de la propiedad 1",     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODPR2"    ,"C", 20, 0, "Código de la propiedad 2",     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALPR1"    ,"C", 20, 0, "Valor de la propiedad 1" ,     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALPR2"    ,"C", 20, 0, "Valor de la propiedad 2" ,     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NFACCNV"    ,"N", 16, 6, "Factor de conversión de la compra", "",              "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CALMLIN"    ,"C", 16, 0, "Código del almacen" ,          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NCTLSTK"    ,"N",  1, 0, "Tipo de stock de la línea",    "'9'",                "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LLOTE"      ,"L",  1, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NLOTE"      ,"N",  9, 0, "",                             "'999999999'",        "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cLote"      ,"C", 64, 0, "Número de lote",               "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NNUMLIN"    ,"N",  4, 0, "Número de la línea",           "9999",               "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NUNDKIT"    ,"N", 16, 6, "Unidades del producto kit",    "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LKITART"    ,"L",  1, 0, "Línea con escandallo",         "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LKITCHL"    ,"L",  1, 0, "Línea pertenciente a escandallo", "",                "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LKITPRC"    ,"L",  1, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "LIMPLIN"    ,"L",  1, 0, "Imprimir linea",               "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "MNUMSER"    ,"M", 10, 0, "" ,                            "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODUBI1"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODUBI2"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODUBI3"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALUBI1"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALUBI2"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CVALUBI3"   ,"C",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CNOMUBI1"   ,"C", 30, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CNOMUBI2"   ,"C", 30, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CNOMUBI3"   ,"C", 30, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CCODFAM"    ,"C", 16, 0, "Código de familia",            "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "CGRPFAM"    ,"C",  3, 0, "Código del grupo de familia",  "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "NREQ"       ,"N", 16, 6, "Recargo de equivalencia",      "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "MOBSLIN"    ,"M", 10, 0, "Observacion de línea",         "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nPvpRec"    ,"N", 16, 6, "Precio de venta recomendado",  "cPinDivFac",         "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nNumMed"    ,"N",  1, 0, "Número de mediciones",         "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nMedUno"    ,"N", 16, 6, "Primera unidad de medición",   "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nMedDos"    ,"N", 16, 6, "Segunda unidad de medición",   "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nMedTre"    ,"N", 16, 6, "Tercera unidad de medición",   "MasUnd()",           "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "dFecCad"    ,"D",  8, 0, "Fecha de caducidad",           "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nUndLin"    ,"N",  5, 0, "",                             "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lLabel"     ,"L",  1, 0, "Lógico de etiqueta",           "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nLabel"     ,"N",  5, 0, "Número de etiquetas",          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cSuPed"     ,"C", 10, 0, "Su pedido",                    "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lGasSup"    ,"L",  1, 0, "Linea de gastos suplidos",     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "dFecFac"    ,"D",  8, 0, "Fecha de la factura",          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cCodPrv"    ,"C", 12, 0, "Código de proveedor",          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lNumSer"    ,"L",  1, 0, "Lógico solicitar numero de serie", "",               "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lAutSer"    ,"L",  1, 0, "Lógico de autoserializar",     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "nBultos"    ,"N", 16, 6, "Numero de bultos en líneas",   "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cFormato"   ,"C",100, 0, "Formato de compra",            "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "iNumAlb"    ,"C", 16, 0, "Identificador del albarán",    "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cCodImp"    ,"C",  3, 0, "Código de impuesto especial",  "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nValImp"    ,"N", 16, 6, "Importe de impuesto especial", "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "tFecFac"    ,"C",  6, 0, "Hora de la Factura" ,          "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cCtrCoste"  ,"C",  9, 0, "Codig del centro de coste" ,   "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cAlmOrigen" ,"C", 16, 0, "Almacén de origen de la mercancía", "",              "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cRefAux"    ,"C", 18, 0, "Referencia auxiliar",          "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "cRefAux2"   ,"C", 18, 0, "Segunda referencia auxiliar",  "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nPosPrint"  ,"N",  4, 0, "Posición de impresión",        "9999",               "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cTipCtr"    ,"C", 20, 0, "Tipo tercero centro de coste", "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cTerCtr"    ,"C", 20, 0, "Tercero centro de coste" ,     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lValidado"  ,"L",  1, 0, "Lógico validado con consolidación", "",              "", "( cDbfCol )", .F. } )

return ( aColFacPrv )



function aCocFacPrv()




   local aCocFacPrv  := {{"( Descrip( cDbfCol ) )",                                           "C", 50, 0, "Descripción larga",           "",            "Descripción", "" }, { "( nTotNFacPrv( cDbfCol ) )",                                       "N", 16, 6, "Total unidades",              "cPinDivFac",  cNombreUnidades(),    "" }, { "( nTotUFacPrv( cDbfCol, nDinDivFac, nVdvDivFac ) )",               "N", 16, 6, "Precio unitario de factura",  "cPinDivFac",  "Precio",      "" }, { "( nTotLFacPrv( cDbfCol, nDinDivFac, nDirDivFac, nVdvDivFac ) )",   "N", 16, 6, "Total linea de factura",      "cPirDivFac",  "Total",       "" } }

return ( aCocFacPrv )



function aSerFacPrv()

   local aColFacPrv  := {}

   aAdd( aColFacPrv,  { "cSerFac", "C",  1,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "nNumFac", "N",  9,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cSufFac", "C",  2,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "dFecFac", "D",  8,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "nNumLin", "N",  4,   0, "Número de la línea",               "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cRef",    "C", 18,   0, "Referencia del artículo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cAlmLin", "C",  3,   0, "Código de almacen",                "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "lUndNeg", "L",  1,   0, "Lógico de unidades en negativo",   "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cNumSer", "C", 30,   0, "Numero de serie",                  "",                  "", "( cDbfCol )" } )

return ( aColFacPrv )



Function SynFacPrv( cPath )

   local oError
   local oBlock
   local aTotFac
   local aNumSer
   local cNumSer
   local cArtDiv
   local hConsolidacion

   BEGIN SEQUENCE
   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvT.Dbf" ), ( cCheckArea( "FacPrvT", @dbfFacPrvT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvL.Dbf" ), ( cCheckArea( "FacPrvL", @dbfFacPrvL ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvS.Dbf" ), ( cCheckArea( "FacPrvS", @dbfFacPrvS ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPRVI.Dbf" ), ( cCheckArea( "FacPRVI", @dbfFacPrvI ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPRVI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvP.Dbf" ), ( cCheckArea( "FacPrvP", @dbfFacPrvP ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.Dbf" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTICULO.Dbf" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROVART.Dbf" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTDIV.Dbf" ), ( cCheckArea( "ARTDIV", @dbfArtPrv ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.Dbf" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.Dbf" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end



   ( dbfFacPrvT )->( OrdSetFocus( 0 ) )
   ( dbfFacPrvT )->( dbGoTop() )

   while !( dbfFacPrvT )->( eof() )

      if empty( ( dbfFacPrvT )->cSufFac )
         ( dbfFacPrvT )->cSufFac := "00"
      end

      if !empty( ( dbfFacPrvT )->cNumAlb ) .AND. Len( AllTrim( ( dbfFacPrvT )->cNumAlb ) ) <> 12
         ( dbfFacPrvT )->cNumAlb := AllTrim( ( dbfFacPrvT )->cNumAlb ) + "00"
      end

      if empty( ( dbfFacPrvT )->cCodCaj )
         ( dbfFacPrvT )->cCodCaj := "000"
      end

      if empty( ( dbfFacPrvT )->cPaisIBAN )
         ( dbfFacPrvT )->cPaisIBAN  := "ES"
      end

      if empty( ( dbfFacPrvT )->cCtrlIBAN )
         ( dbfFacPrvT )->cCtrlIBAN  := IbanDigit( ( dbfFacPrvT )->cPaisIBAN, ( dbfFacPrvT )->cEntBnc, ( dbfFacPrvT )->cSucBnc, ( dbfFacPrvT )->cDigBnc, ( dbfFacPrvT )->cCtaBnc )
      end

      ( dbfFacPrvT )->( dbSkip() )

      SysRefresh()

   end

   ( dbfFacPrvT )->( OrdSetFocus( 1 ) )



   ( dbfFacPrvL )->( OrdSetFocus( 0 ) )
   ( dbfFacPrvL )->( dbGoTop() )

   while !( dbfFacPrvL )->( eof() )

      if empty( ( dbfFacPrvL )->cSufFac )
         ( dbfFacPrvL )->cSufFac := "00"
      end

      if empty( ( dbfFacPrvL )->cLote ) .AND. !empty( ( dbfFacPrvL )->nLote )
         ( dbfFacPrvL )->cLote   := AllTrim( Str( ( dbfFacPrvL )->nLote ) )
      end

      if !empty( ( dbfFacPrvL )->cRef ) .AND. empty( ( dbfFacPrvL )->cCodFam )
         ( dbfFacPrvL )->cCodFam := RetFamArt( ( dbfFacPrvL )->cRef, dbfArticulo )
      end

      if !empty( ( dbfFacPrvL )->cRef ) .AND. !empty( ( dbfFacPrvL )->cCodFam )
         ( dbfFacPrvL )->cGrpFam := cGruFam( ( dbfFacPrvL )->cCodFam, dbfFamilia )
      end

      if empty( ( dbfFacPrvL )->nReq )
         ( dbfFacPrvL )->nReq    := nPReq( dbfIva, ( dbfFacPrvL )->nIva )
      end

      if ( dbfFacPrvL )->dFecFac <> RetFld( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac, dbfFacPrvT, "dFecFac" )
         ( dbfFacPrvL )->dFecFac := RetFld( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac, dbfFacPrvT, "dFecFac" )
      end

      if ( dbfFacPrvL )->tFecFac <> RetFld( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac, dbfFacPrvT, "tFecFac" )
         ( dbfFacPrvL )->tFecFac := RetFld( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac, dbfFacPrvT, "tFecFac" )
      end

      if empty( ( dbfFacPrvL )->cAlmLin )
         ( dbfFacPrvL )->cAlmLin    := RetFld( ( dbfFacPrvL )->cSerFac + Str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac, dbfFacPrvT, "cCodAlm" )
      end






































      if empty( ( dbfFacPrvL )->nPosPrint )
         ( dbfFacPrvL )->nPosPrint := ( dbfFacPrvL )->nNumLin
      end

      ( dbfFacPrvL )->( dbSkip() )

      SysRefresh()

   end

   ( dbfFacPrvL )->( OrdSetFocus( 1 ) )



   ( dbfFacPrvI )->( OrdSetFocus( 0 ) )
   ( dbfFacPrvI )->( dbGoTop() )

   while !( dbfFacPrvI )->( eof() )

      if empty( ( dbfFacPrvI )->cSufFac )
         ( dbfFacPrvI )->cSufFac := "00"
      end

      ( dbfFacPrvI )->( dbSkip() )

      SysRefresh()

   end

   ( dbfFacPrvI )->( OrdSetFocus( 1 ) )



   ( dbfFacPrvS )->( OrdSetFocus( 0 ) )
   ( dbfFacPrvS )->( dbGoTop() )

   while !( dbfFacPrvS )->( eof() )

      if empty( ( dbfFacPrvS )->cSufFac )
         ( dbfFacPrvS )->cSufFac := "00"
      end

      if ( dbfFacPrvS )->dFecFac <> ( dbfFacPrvT )->dFecFac
         ( dbfFacPrvS )->dFecFac := ( dbfFacPrvT )->dFecFac
      end

      ( dbfFacPrvS )->( dbSkip() )

      SysRefresh()

   end

   ( dbfFacPrvS )->( OrdSetFocus( 1 ) )



   ( dbfFacPrvT )->( OrdSetFocus( 0 ) )
   ( dbfFacPrvT )->( dbGoTop() )

   while !( dbfFacPrvT )->( eof() )

      if ( dbfFacPrvT )->nTotFac == 0 .AND. dbLock( dbfFacPrvT )

         aTotFac                 := aTotFacPrv( ( dbfFacPrvT )->cSerFac + Str( ( dbfFacPrvT )->nNumFac ) + ( dbfFacPrvT )->cSufFac, dbfFacPrvT, dbfFacPrvL, dbfIva, dbfDiv, dbfFacPrvP, ( dbfFacPrvT )->cDivFac )

         ( dbfFacPrvT )->nTotNet := aTotFac[1]
         ( dbfFacPrvT )->nTotIva := aTotFac[2]
         ( dbfFacPrvT )->nTotReq := aTotFac[3]
         ( dbfFacPrvT )->nTotFac := aTotFac[4]

         ( dbfFacPrvT )->( dbUnLock() )

      end

      ( dbfFacPrvT )->( dbSkip() )

      SysRefresh()

   end

   ( dbfFacPrvT )->( OrdSetFocus( 1 ) )



   ( dbfFacPrvL )->( dbGoTop() )
   while !( dbfFacPrvL )->( eof() )

      if !( dbfFacPrvT )->( dbSeek( ( dbfFacPrvL )->cSerFac + str( ( dbfFacPrvL )->nNumFac ) + ( dbfFacPrvL )->cSufFac ) )
         if ( dbfFacPrvL )->( dbRLock() )
            ( dbfFacPrvL )->( dbDelete() )
            ( dbfFacPrvL )->( dbRUnLock() )
         end
      end

      ( dbfFacPrvL )->( dbSkip() )

   end

   ( dbfFacPrvS )->( dbGoTop() )
   while !( dbfFacPrvS )->( eof() )

      if !( dbfFacPrvT )->( dbSeek( ( dbfFacPrvS )->cSerFac + str( ( dbfFacPrvS )->nNumFac ) + ( dbfFacPrvS )->cSufFac ) )
         if ( dbfFacPrvS )->( dbRLock() )
            ( dbfFacPrvS )->( dbDelete() )
            ( dbfFacPrvS )->( dbRUnLock() )
         end
      end

      ( dbfFacPrvS )->( dbSkip() )

   end

   ( dbfFacPrvI )->( dbGoTop() )
   while !( dbfFacPrvI )->( eof() )

      if !( dbfFacPrvT )->( dbSeek( ( dbfFacPrvI )->cSerie + str( ( dbfFacPrvI )->nNumFac ) + ( dbfFacPrvI )->cSufFac ) )
         if ( dbfFacPrvI )->( dbRLock() )
            ( dbfFacPrvI )->( dbDelete() )
            ( dbfFacPrvI )->( dbRUnLock() )
         end
      end

      ( dbfFacPrvI )->( dbSkip() )

   end

   RECOVER USING oError
      msgStop( "Imposible sincronizar factura de proveedores" + Chr(13)+Chr(10) + ErrorMessage( oError ) )
   end
   ErrorBlock( oBlock )

   if !empty( dbfFacPrvT ) .AND. ( dbfFacPrvT )->( Used() )
      ( dbfFacPrvT )->( dbCloseArea() )
   end

   if !empty( dbfFacPrvL ) .AND. ( dbfFacPrvL )->( Used() )
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if !empty( dbfFacPrvS ) .AND. ( dbfFacPrvS )->( Used() )
      ( dbfFacPrvS )->( dbCloseArea() )
   end

   if !empty( dbfFacPrvI ) .AND. ( dbfFacPrvI )->( Used() )
      ( dbfFacPrvI )->( dbCloseArea() )
   end

   if !empty( dbfFacPrvP ) .AND. ( dbfFacPrvP )->( Used() )
      ( dbfFacPrvP )->( dbCloseArea() )
   end

   if !empty( dbfArticulo ) .AND. ( dbfArticulo )->( Used() )
      ( dbfArticulo )->( dbCloseArea() )
   end

   if !empty( dbfFamilia ) .AND. ( dbfFamilia )->( Used() )
      ( dbfFamilia )->( dbCloseArea() )
   end

   if !empty( dbfArtPrv ) .AND. ( dbfArtPrv )->( Used() )
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if !empty( dbfIva ) .AND. ( dbfIva )->( Used() )
      ( dbfIva )->( dbCloseArea() )
   end

   if !empty( dbfDiv ) .AND. ( dbfDiv )->( Used() )
      ( dbfDiv )->( dbCloseArea() )
   end

   if !empty( cArtDiv ) .AND. ( cArtDiv )->( Used() )
      ( cArtDiv )->( dbCloseArea() )
   end

return nil








_HB_CLASS TFacturasProveedorSenderReciver ; function TFacturasProveedorSenderReciver ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFacturasProveedorSenderReciver", iif( .T., { @TSenderReciverItem() }, { @HBObject() } ), @TFacturasProveedorSenderReciver() ) ) ;

   _HB_MEMBER { cFileName } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileName"}, .F. )

   _HB_MEMBER CreateData(); oClass:AddMethod( "CreateData", @TFacturasProveedorSenderReciver_CreateData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RestoreData(); oClass:AddMethod( "RestoreData", @TFacturasProveedorSenderReciver_RestoreData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SendData(); oClass:AddMethod( "SendData", @TFacturasProveedorSenderReciver_SendData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ReciveData(); oClass:AddMethod( "ReciveData", @TFacturasProveedorSenderReciver_ReciveData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Process(); oClass:AddMethod( "Process", @TFacturasProveedorSenderReciver_Process(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validateRecepcion( tmpFacPrvT, dbfFacPrvT); oClass:AddMethod( "validateRecepcion", @TFacturasProveedorSenderReciver_validateRecepcion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFacturasProveedorSenderReciver ;



static FUNCTION TFacturasProveedorSenderReciver_CreateData( ) ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local oBlock
   local oError
   local lSnd        := .F.
   local cFacPrvT
   local cFacPrvL
   local cFacPrvI
   local cFacPrvP

   if ::oSender:lServer
      ::cFileName         := "FacPrv" + win_uuidcreatestring() + ".All"
   else
      ::cFileName         := "FacPrv" + win_uuidcreatestring() + "." + RetSufEmp()
   end

   ::oSender:SetText( "Enviando facturas a proveedores" )

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVT.DBF" ), ( cCheckArea( "FACPRVT", @cFacPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @cFacPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvI.DBF" ), ( cCheckArea( "FacPrvI", @cFacPrvI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvP.DBF" ), ( cCheckArea( "FacPrvP", @cFacPrvP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end



   mkFacPrv( cPatSnd() )

   mkRecPrv( cPatSnd() )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FACPRVT.DBF" ), ( cCheckArea( "FACPRVT", @tmpFacPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FACPRVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @tmpFacPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacPrvI.DBF" ), ( cCheckArea( "FacPrvI", @tmpFacPrvI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FacPrvI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacPrvP.DBF" ), ( cCheckArea( "FacPrvP", @tmpFacPrvP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatSnd() + "FacPrvP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   if !empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( cFacPrvT )->( LastRec() )
   end

   while !( cFacPrvT )->( eof() )

      if ( cFacPrvT )->lSndDoc

         lSnd  := .T.

         dbPass( cFacPrvT, tmpFacPrvT, .T. )
         ::oSender:SetText( ( cFacPrvT )->cSerFac + "/" + AllTrim( Str( ( cFacPrvT )->nNumFac ) ) + "/" + AllTrim( ( cFacPrvT )->cSufFac ) + "; " + Dtoc( ( cFacPrvT )->dFecFac ) + "; " + AllTrim( ( cFacPrvT )->cCodPrv ) + "; " + ( cFacPrvT )->cNomPrv )

         if ( cFacPrvL )->( dbSeek( ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac ) )
            while ( cFacPrvL )->cSerFac + Str( ( cFacPrvL )->nNumFac ) + ( cFacPrvL )->cSufFac == ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac .AND. !( cFacPrvL )->( eof() )
               dbPass( cFacPrvL, tmpFacPrvL, .T. )
               ( cFacPrvL )->( dbSkip() )
            end
         end

         if ( cFacPrvI )->( dbSeek( ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac ) )
            while ( cFacPrvI )->cSerFac + Str( ( cFacPrvI )->nNumFac ) + ( cFacPrvI )->cSufFac == ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac .AND. !( cFacPrvI )->( eof() )
               dbPass( cFacPrvI, tmpFacPrvI, .T. )
               ( cFacPrvI )->( dbSkip() )
            end
         end

         if ( cFacPrvP )->( dbSeek( ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac ) )
            while ( cFacPrvP )->cSerFac + Str( ( cFacPrvL )->nNumFac ) + ( cFacPrvL )->cSufFac == ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac .AND. !( cFacPrvP )->( eof() )
               dbPass( cFacPrvP, tmpFacPrvP, .T. )
               ( cFacPrvP )->( dbSkip() )
            end
         end

      end

      ( cFacPrvT )->( dbSkip() )

      if !empty( ::oSender:oMtr )
         ::oSender:oMtr:Set( ( cFacPrvT )->( OrdKeyNo() ) )
      end

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( cFacPrvT )->( dbCloseArea() )
   ( cFacPrvL )->( dbCloseArea() )
   ( cFacPrvI )->( dbCloseArea() )
   ( cFacPrvP )->( dbCloseArea() )
   ( tmpFacPrvT )->( dbCloseArea() )
   ( tmpFacPrvL )->( dbCloseArea() )
   ( tmpFacPrvI )->( dbCloseArea() )
   ( tmpFacPrvP )->( dbCloseArea() )

   if lSnd





      ::oSender:SetText( "Comprimiendo facturas de proveedores" )

      if ::oSender:lZipData( ::cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay facturas de proveedores para enviar" )

   end

Return ( Self )



static FUNCTION TFacturasProveedorSenderReciver_RestoreData( ) ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local oBlock
   local oError
   local cFacPrvT

   if ::lSuccesfullSend

   oBlock            := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvT.DBF" ), ( cCheckArea( "FacPrvT", @cFacPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      lSelectAll( oWndBrw, cFacPrvT, "lSndDoc", .F., .T., .T. )

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

      ( cFacPrvT )->( dbCloseArea() )

   end

Return ( Self )



static FUNCTION TFacturasProveedorSenderReciver_SendData( ) ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   if file( cPatOut() + ::cFileName )

      if ::oSender:SendFiles( cPatOut() + ::cFileName, ::cFileName )
         ::lSuccesfullSend := .T.
         ::oSender:SetText( "Fichero enviado " + ::cFileName )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



static FUNCTION TFacturasProveedorSenderReciver_ReciveData( ) ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local n
   local aExt

   aExt     := ::oSender:aExtensions()





   ::oSender:SetText( "Recibiendo facturas de proveedores" )

   if !::oSender:lFranquiciado

      for n := 1 to len( aExt )
         ::oSender:GetFiles( "FacPrv*." + aExt[ n ], cPatIn() )
      next

   else

      for n := 1 to len( aExt )
         ::oSender:GetFiles( "FacCli*." + aExt[ n ], cPatIn() )
      next

   end

   ::oSender:SetText( "Facturas de proveedores recibidas" )

Return Self



static FUNCTION TFacturasProveedorSenderReciver_Process( ) ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   local m
   local oStock
   local cFacPrvT
   local cFacPrvL
   local cFacPrvP
   local dbfProvee
   local dbfCount
   local aFiles
   local oBlock
   local oError
   local cSerie
   local nNumero
   local cSufijo

   if !::oSender:lFranquiciado
      aFiles      := Directory( cPatIn() + "FacPrv*.*" )
   else
      aFiles      := Directory( cPatIn() + "FacCli*.*" )
   end





   ::oSender:SetText( "Recibiendo facturas de proveedores" )

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )




      if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )





         if !::oSender:lFranquiciado







            if lExistTable( cPatSnd() + "FacPrvT.DBF", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "FacPrvL.DBF", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "FacPrvP.DBF", cLocalDriver() )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacPrvT.DBF" ), ( cCheckArea( "FacPrvT", @tmpFacPrvT ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacPrvT.CDX" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacPrvL.DBF" ), ( cCheckArea( "FacPrvL", @tmpFacPrvL ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )


               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacPrvP.Dbf" ), ( cCheckArea( "FacPrvP", @tmpFacPrvP ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacPrvP.Cdx" ) )

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvT.DBF" ), ( cCheckArea( "FacPrvT", @cFacPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvL.DBF" ), ( cCheckArea( "FacPrvL", @cFacPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvP.DBF" ), ( cCheckArea( "FacPrvP", @cFacPrvP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               oStock            := TStock():New()
               oStock:cFacPrvT   := cFacPrvT
               oStock:cFacPrvL   := cFacPrvL

               ( tmpFacPrvT )->( OrdSetFocus(0) )
               ( tmpFacPrvT )->( dbGoTop() )

               while ( tmpFacPrvT )->( !eof() )





                  if ::validateRecepcion( tmpFacPrvT, cFacPrvT )

                     while ( cFacPrvT )->( dbseek( ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )
                        dbLockDelete( cFacPrvT )
                     end

                     while ( cFacPrvL )->( dbseek( ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )
                        dbLockDelete( cFacPrvL )
                     end

                     dbPass( tmpFacPrvT, cFacPrvT, .T. )

                     if dbLock( cFacPrvT )
                        ( cFacPrvT )->lSndDoc := .F.
                        ( cFacPrvT )->( dbUnLock() )
                     end

                     ::oSender:SetText( "Añadido     : " + ( tmpFacPrvT )->cSerFac + "/" + AllTrim( Str( ( tmpFacPrvT )->nNumFac ) ) +"/" + AllTrim( ( tmpFacPrvT )->cSufFac ) + "; " + Dtoc( ( tmpFacPrvT )->dFecFac ) + "; " + AllTrim( ( tmpFacPrvT )->cCodPrv ) + ( tmpFacPrvT )->cNomPrv )





                        ( tmpFacPrvL )->( dbGoTop() )



                        while !( tmpFacPrvL )->( eof() )

                           if ( tmpFacPrvL )->cSerFac + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac == ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac

                              dbPass( tmpFacPrvL, cFacPrvL, .T. )

                           end

                           ( tmpFacPrvL )->( dbSkip() )

                        end







                     if ( tmpFacPrvP )->( dbSeek( ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )
                        while ( tmpFacPrvP )->cSerFac + Str( ( tmpFacPrvP )->nNumFac ) + ( tmpFacPrvP )->cSufFac == ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac .AND. !( tmpFacPrvP )->( eof() )
                           dbPass( tmpFacPrvP, cFacPrvP, .T. )
                           ( tmpFacPrvP )->( dbSkip() )
                        end
                     end

                  end

                  ( tmpFacPrvT )->( dbSkip() )

               end

               ( cFacPrvT )->( dbCloseArea() )
               ( cFacPrvL )->( dbCloseArea() )
               ( cFacPrvP )->( dbCloseArea() )
               ( tmpFacPrvT )->( dbCloseArea() )
               ( tmpFacPrvL )->( dbCloseArea() )
               ( tmpFacPrvP )->( dbCloseArea() )

               oStock:end()

            end

         else







            if lExistTable( cPatSnd() + "FacCliT.Dbf", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "FacPrvL.Dbf", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "FacCliP.Dbf", cLocalDriver() )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacCliT.DBF" ), ( cCheckArea( "FacCliT", @tmpFacPrvT ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacCliT.CDX" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacPrvL.DBF" ), ( cCheckArea( "FacPrvL", @tmpFacPrvL ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacPrvL.CDX" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "FacCliP.DBF" ), ( cCheckArea( "FacCliP", @tmpFacPrvP ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "FacCliP.CDX" ) )

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvT.DBF" ), ( cCheckArea( "FacPrvT", @cFacPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvL.DBF" ), ( cCheckArea( "FacPrvL", @cFacPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacPrvP.DBF" ), ( cCheckArea( "FacPrvP", @cFacPrvP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "FacPrvP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "nCount.DBF" ), ( cCheckArea( "nCount", @dbfCount ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "nCount.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               while ( tmpFacPrvT )->( !eof() )





                  ( cFacPrvT )->( OrdSetFocus( "cSuPed" ) )

                  if !( cFacPrvT )->( dbSeek( ( tmpFacPrvT )->cSerie + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )





                     cSerie      := ( tmpFacPrvT )->cSerie
                     nNumero     := nNewDoc( ( tmpFacPrvT )->cSerie, cFacPrvT, "NFACPRV", , dbfCount )
                     cSufijo     := Application():CodigoDelegacion()

                     ( cFacPrvT)->( dbAppend() )

                     ( cFacPrvT)->CSERFAC     := cSerie
                     ( cFacPrvT)->NNUMFAC     := nNumero
                     ( cFacPrvT)->CSUFFAC     := cSufijo
                     ( cFacPrvT)->CTURFAC     := cCurSesion()
                     ( cFacPrvT)->DFECFAC     := ( tmpFacPrvT )->dFecFac
                     ( cFacPrvT)->CCODPRV     := ( tmpFacPrvT )->cCodCli
                     ( cFacPrvT)->CCODALM     := Application():codigoAlmacen()
                     ( cFacPrvT)->CCODCAJ     := Application():CodigoCaja()
                     ( cFacPrvT)->CNOMPRV     := ( tmpFacPrvT )->cNomCli
                     ( cFacPrvT)->CDIRPRV     := ( tmpFacPrvT )->cDirCli
                     ( cFacPrvT)->CPOBPRV     := ( tmpFacPrvT )->cPobCli
                     ( cFacPrvT)->CPROVPROV   := ( tmpFacPrvT )->cPrvCli
                     ( cFacPrvT)->CPOSPRV     := ( tmpFacPrvT )->cPosCli
                     ( cFacPrvT)->CDNIPRV     := ( tmpFacPrvT )->cDniCli
                     ( cFacPrvT)->LLIQUIDADA  := ( tmpFacPrvT )->lLiquidada
                     ( cFacPrvT)->LCONTAB     := .F.
                     ( cFacPrvT)->DFECENT     := ( tmpFacPrvT )->DFECENT
                     ( cFacPrvT)->CSUPED      := ( tmpFacPrvT )->cSerie + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac
                     ( cFacPrvT)->CCONDENT    := ( tmpFacPrvT )->cCondEnt
                     ( cFacPrvT)->MCOMENT     := ( tmpFacPrvT )->mComent
                     ( cFacPrvT)->CCODPAGO    := ( tmpFacPrvT )->cCodPago
                     ( cFacPrvT)->CDTOESP     := ( tmpFacPrvT )->cDtoEsp
                     ( cFacPrvT)->NDTOESP     := ( tmpFacPrvT )->nDtoEsp
                     ( cFacPrvT)->CDPP        := ( tmpFacPrvT )->cDpp
                     ( cFacPrvT)->NDPP        := ( tmpFacPrvT )->nDpp
                     ( cFacPrvT)->LRECARGO    := ( tmpFacPrvT )->lRecargo
                     ( cFacPrvT)->CDIVFAC     := ( tmpFacPrvT )->cDivFac
                     ( cFacPrvT)->NVDVFAC     := ( tmpFacPrvT )->nVdvFac
                     ( cFacPrvT)->LSNDDOC     := .F.
                     ( cFacPrvT)->CDTOUNO     := ( tmpFacPrvT )->cDtoUno
                     ( cFacPrvT)->NDTOUNO     := ( tmpFacPrvT )->nDtoUno
                     ( cFacPrvT)->CDTODOS     := ( tmpFacPrvT )->cDtoDos
                     ( cFacPrvT)->NDTODOS     := ( tmpFacPrvT )->nDtoDos
                     ( cFacPrvT)->LCLOFAC     := .F.
                     ( cFacPrvT)->CCODUSR     := Auth():Codigo()
                     ( cFacPrvT)->nTipRet     := ( tmpFacPrvT )->nTipRet
                     ( cFacPrvT)->nPctRet     := ( tmpFacPrvT )->nPctRet
                     ( cFacPrvT)->dFecChg     := GetSysDate()
                     ( cFacPrvT)->cTimChg     := Time()
                     ( cFacPrvT)->cCodDlg     := Application():CodigoDelegacion()
                     ( cFacPrvT)->nRegIva     := ( tmpFacPrvT )->nRegIva
                     ( cFacPrvT)->nTotNet     := ( tmpFacPrvT )->nTotNet
                     ( cFacPrvT)->nTotIva     := ( tmpFacPrvT )->nTotIva
                     ( cFacPrvT)->nTotReq     := ( tmpFacPrvT )->nTotReq
                     ( cFacPrvT)->nTotFac     := ( tmpFacPrvT )->nTotFac

                     ( cFacPrvT )->( dbUnLock() )

                     ::oSender:SetText( "Añadida factura : " + cSerie + "/" + AllTrim( Str( nNumero ) ) + "/" +  AllTrim( cSufijo ) )



                     if ( tmpFacPrvL )->( dbSeek( ( tmpFacPrvT )->cSerie + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )

                        while ( tmpFacPrvL )->cSerie + Str( ( tmpFacPrvL )->nNumFac ) + ( tmpFacPrvL )->cSufFac == ( tmpFacPrvT )->cSerie + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac .AND. !( tmpFacPrvL )->( eof() )

                           ( cFacPrvL)->( dbAppend() )

                           ( cFacPrvL)->CSERFAC    := cSerie
                           ( cFacPrvL)->NNUMFAC    := nNumero
                           ( cFacPrvL)->CSUFFAC    := cSufijo
                           ( cFacPrvL)->CREF       := ( tmpFacPrvL )->cRef
                           ( cFacPrvL)->CREFPRV    := ( tmpFacPrvL )->cRefPrv
                           ( cFacPrvL)->CDETALLE   := ( tmpFacPrvL )->cDetalle
                           ( cFacPrvL)->NPREUNIT   := ( tmpFacPrvL )->nPreUnit
                           ( cFacPrvL)->NDTO       := ( tmpFacPrvL )->nDto
                           ( cFacPrvL)->NIVA       := ( tmpFacPrvL )->nIva
                           ( cFacPrvL)->NCANENT    := ( tmpFacPrvL )->nCanEnt
                           ( cFacPrvL)->LCONTROL   := ( tmpFacPrvL )->lControl
                           ( cFacPrvL)->CUNIDAD    := ( tmpFacPrvL )->cUnidad
                           ( cFacPrvL)->NUNICAJA   := ( tmpFacPrvL )->nUniCaja
                           ( cFacPrvL)->MLNGDES    := ( tmpFacPrvL )->mLngDes
                           ( cFacPrvL)->NDTOLIN    := ( tmpFacPrvL )->nDtoDiv
                           ( cFacPrvL)->NDTOPRM    := ( tmpFacPrvL )->nDtoPrm
                           ( cFacPrvL)->NIVALIN    := ( tmpFacPrvL )->nIva
                           ( cFacPrvL)->LIVALIN    := ( tmpFacPrvL )->lIvaLin
                           ( cFacPrvL)->CCODPR1    := ( tmpFacPrvL )->cCodPr1
                           ( cFacPrvL)->CCODPR2    := ( tmpFacPrvL )->cCodPr2
                           ( cFacPrvL)->CVALPR1    := ( tmpFacPrvL )->cValPr1
                           ( cFacPrvL)->CVALPR2    := ( tmpFacPrvL )->cValPr2
                           ( cFacPrvL)->NFACCNV    := ( tmpFacPrvL )->nFacCnv
                           ( cFacPrvL)->CALMLIN    := ( tmpFacPrvL )->cAlmLin
                           ( cFacPrvL)->NCTLSTK    := ( tmpFacPrvL )->nCtlStk
                           ( cFacPrvL)->LLOTE      := ( tmpFacPrvL )->lLote
                           ( cFacPrvL)->NLOTE      := ( tmpFacPrvL )->nLote
                           ( cFacPrvL)->CLOTE      := ( tmpFacPrvL )->cLote
                           ( cFacPrvL)->NNUMLIN    := ( tmpFacPrvL )->nNumLin
                           ( cFacPrvL)->NUNDKIT    := ( tmpFacPrvL )->nUndKit
                           ( cFacPrvL)->LKITART    := ( tmpFacPrvL )->lKitArt
                           ( cFacPrvL)->LKITCHL    := ( tmpFacPrvL )->lKitChl
                           ( cFacPrvL)->LKITPRC    := ( tmpFacPrvL )->lKitPrc
                           ( cFacPrvL)->MNUMSER    := ( tmpFacPrvL )->mNumSer
                           ( cFacPrvL)->CCODFAM    := ( tmpFacPrvL )->cCodFam
                           ( cFacPrvL)->CGRPFAM    := ( tmpFacPrvL )->cGrpFam
                           ( cFacPrvL)->NREQ       := ( tmpFacPrvL )->nReq
                           ( cFacPrvL)->MOBSLIN    := ( tmpFacPrvL )->mObsLin
                           ( cFacPrvL)->nNumMed    := ( tmpFacPrvL )->nNumMed
                           ( cFacPrvL)->nMedUno    := ( tmpFacPrvL )->nMedUno
                           ( cFacPrvL)->nMedDos    := ( tmpFacPrvL )->nMedDos
                           ( cFacPrvL)->nMedTre    := ( tmpFacPrvL )->nMedTre
                           ( cFacPrvL)->dFecCad    := ( tmpFacPrvL )->dFecCad
                           ( cFacPrvL)->cSuPed     := ( tmpFacPrvT )->cSerie + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac
                           ( cFacPrvL)->dFecFac    := ( tmpFacPrvT )->dFecFac
                           ( cFacPrvL)->cCodPrv    := ( tmpFacPrvT )->cCodCli

                           ( cFacPrvL )->( dbUnLock() )

                           ( tmpFacPrvL )->( dbSkip() )

                        end

                     end



                     if ( tmpFacPrvP )->( dbSeek( ( tmpFacPrvT )->cSerie + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) )

                        while ( tmpFacPrvP )->cSerie + Str( ( tmpFacPrvP )->nNumFac ) + ( tmpFacPrvP )->cSufFac == ( tmpFacPrvT )->cSerie + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac .AND. !( tmpFacPrvP )->( eof() )

                           ( cFacPrvP)->( dbAppend() )

                           ( cFacPrvP )->cSerFac    := cSerie
                           ( cFacPrvP )->nNumFac    := nNumero
                           ( cFacPrvP )->cSufFac    := cSufijo
                           ( cFacPrvP )->nNumRec    := ( tmpFacPrvP )->nNumRec
                           ( cFacPrvP )->cTipRec    := ( tmpFacPrvP )->cTipRec
                           ( cFacPrvP )->CCODCAJ    := Application():CodigoCaja()
                           ( cFacPrvP )->CCODPRV    := ( tmpFacPrvT )->cCodCli
                           ( cFacPrvP )->cNomPrv    := ( tmpFacPrvP )->cNomCli
                           ( cFacPrvP )->DENTRADA   := ( tmpFacPrvP )->dEntrada
                           ( cFacPrvP )->NIMPORTE   := ( tmpFacPrvP )->nImporte
                           ( cFacPrvP )->CDESCRIP   := ( tmpFacPrvP )->cDescrip
                           ( cFacPrvP )->DPRECOB    := ( tmpFacPrvP )->dPreCob
                           ( cFacPrvP )->CPGDOPOR   := ( tmpFacPrvP )->cPgdoPor
                           ( cFacPrvP )->LCOBRADO   := ( tmpFacPrvP )->lCobrado
                           ( cFacPrvP )->CDIVPGO    := ( tmpFacPrvP )->cDivPgo
                           ( cFacPrvP )->NVDVPGO    := ( tmpFacPrvP )->nVdvPgo
                           ( cFacPrvP )->DFECVTO    := ( tmpFacPrvP )->dFecVto
                           ( cFacPrvP )->cCodUsr    := Auth():Codigo()
                           ( cFacPrvP )->dFecChg    := GetSysDate()
                           ( cFacPrvP )->cTimChg    := Time()
                           ( cFacPrvP )->cTurRec    := cCurSesion()
                           ( cFacPrvP )->cCodPgo    := ( tmpFacPrvP )->cCodPgo

                            if !empty( ( tmpFacPrvT )->cCtrCoste )
                              ( cFacPrvP )->cCtrCoste  := ( tmpFacPrvT )->cCtrCoste
                           endif

                           ( cFacPrvP )->( dbUnLock() )

                           ( tmpFacPrvP )->( dbSkip() )

                        end

                     end

                  else

                     ::oSender:SetText( "Desestimada factura : " + ( tmpFacPrvT )->cSerie + "/" + AllTrim( Str( ( tmpFacPrvT )->nNumFac ) ) + "/" +  AllTrim( ( tmpFacPrvL )->cSufFac ) + "; " + Dtoc( ( tmpFacPrvT )->dFecFac ) + "; " + AllTrim( ( tmpFacPrvT )->cCodCli ) + "; " + ( tmpFacPrvT )->cNomCli )

                  end

                  ( tmpFacPrvT )->( dbSkip() )

               end

               ( cFacPrvT )->( dbCloseArea() )
               ( cFacPrvL )->( dbCloseArea() )
               ( cFacPrvP )->( dbCloseArea() )
               ( tmpFacPrvT )->( dbCloseArea() )
               ( tmpFacPrvL )->( dbCloseArea() )
               ( tmpFacPrvP )->( dbCloseArea() )
               ( dbfCount   )->( dbCloseArea() )

               ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

            else

               ::oSender:SetText( "Faltan ficheros" )

               if !file( cPatSnd() + "FacCliT.Dbf" )
                  ::oSender:SetText( "Falta" + cPatSnd() + "FacCliT.Dbf" )
               end

               if !file( cPatSnd() + "FacPrvL.Dbf" )
                  ::oSender:SetText( "Falta" + cPatSnd() + "FacPrvL.Dbf" )
               end

               if !file( cPatSnd() + "FacCliP.Dbf" )
                  ::oSender:SetText( "Falta" + cPatSnd() + "FacCliP.Dbf" )
               end

            end

         end

      end

      ::oSender:AppendFileRecive( aFiles[ m, 1 ] )


















   next

Return Self



static FUNCTION TFacturasProveedorSenderReciver_validateRecepcion( tmpFacPrvT, cFacPrvT ) ; local Self AS CLASS TFacturasProveedorSenderReciver := QSelf() AS CLASS TFacturasProveedorSenderReciver

   ::cErrorRecepcion       := "Pocesando factura de proveedor número " + ( cFacPrvT )->cSerFac + "/" + alltrim( Str( ( cFacPrvT )->nNumFac ) ) + "/" + alltrim( ( cFacPrvT )->cSufFac ) + " "

   if !( lValidaOperacion( ( tmpFacPrvT )->dFecFac, .F. ) )
      ::cErrorRecepcion    += "la fecha " + dtoc( ( tmpFacPrvT )->dFecFac ) + " no es valida en esta empresa"
      Return .F.
   end

   if !( ( cFacPrvT )->( dbSeek( ( tmpFacPrvT )->cSerFac + Str( ( tmpFacPrvT )->nNumFac ) + ( tmpFacPrvT )->cSufFac ) ) )
      Return .T.
   end

   if dtos( ( cFacPrvT )->dFecChg ) + ( cFacPrvT )->cTimChg >= dtos( ( tmpFacPrvT )->dFecChg ) + ( tmpFacPrvT )->cTimChg
      ::cErrorRecepcion    += "la fecha en la empresa " + dtoc( ( cFacPrvT )->dFecChg ) + " " + ( cFacPrvT )->cTimChg + " es más reciente que la recepción " + dtoc( ( tmpFacPrvT )->dFecChg ) + " " + ( tmpFacPrvT )->cTimChg
      Return .F.
   end

Return ( .T. )




FUNCTION aEtqFacPrv( dbfDocFld, dbfDocCol )

   local aDoc  := {}

   aAdd( aDoc, { "Empresa",         "EM" } )
   aAdd( aDoc, { "Proveedor",       "PR" } )
   aAdd( aDoc, { "Artículos",       "AR" } )
   aAdd( aDoc, { "Factura cabecera","FP" } )
   aAdd( aDoc, { "Factura líneas",  "FX" } )

RETURN ( aDoc )



Function AppFacPrv( cCodPrv, cCodArt, lOpenBrowse )

   local nLevel         := Auth():Level( "facturas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv( nil, nil, cCodPrv, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         WinAppRec( nil, bEdtRec, D():FacturasProveedores( nView ), cCodPrv, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



Function bGenEdtFacPrv( nNumFac )

   local bGen
   local cDoc           := by( nNumFac )

   bGen                 := {|| EdtFacPrv( nNumFac ) }

return ( bGen )



FUNCTION EdtFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "facturas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            nTotFacPrv()
            WinEdtRec( nil, bEdtRec, D():FacturasProveedores( nView ) )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION ZooFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "facturas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            nTotFacPrv()
            WinZooRec( nil, bEdtRec, D():FacturasProveedores( nView ) )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION DelFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "facturas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 16 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            WinDelRec( nil, D():FacturasProveedores( nView ), {|| QuiFacPrv() } )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            WinDelRec( nil, D():FacturasProveedores( nView ), {|| QuiFacPrv() } )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

Return nil



FUNCTION PrnFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "facturas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            GenFacPrv( 1 )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            nTotFacPrv()
            GenFacPrv( 1 )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION VisFacPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "facturas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FacPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            GenFacPrv( 2 )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasProveedores( nView ) )
            nTotFacPrv()
            GenFacPrv( 2 )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

Return nil



Function IsFacPrv( cPath )

   If( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "FacPrvT.Dbf" )
      dbCreate( cPath + "FacPrvT.Dbf", aSqlStruct( aItmFacPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "FacPrvL.Dbf" )
      dbCreate( cPath + "FacPrvL.Dbf", aSqlStruct( aColFacPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "FacPrvI.Dbf" )
      dbCreate( cPath + "FacPrvI.Dbf", aSqlStruct( aIncFacPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "FacPrvD.Dbf" )
      dbCreate( cPath + "FacPrvD.Dbf", aSqlStruct( aFacPrvDoc() ), cDriver() )
   end




   if !lExistIndex( cPath + "FacPrvT.Cdx" ) .OR.  !lExistIndex( cPath + "FacPrvL.Cdx" ) .OR.  !lExistIndex( cPath + "FacPrvI.Cdx" ) .OR.  !lExistIndex( cPath + "FacPrvD.Cdx" )

      rxFacPrv( cPath )

   end

Return ( nil )



FUNCTION cPrpFacPrv( cFacPrvL )

   local cReturn     := ""

   If( cFacPrvL == nil, cFacPrvL := if( !empty( tmpFacPrvL ), tmpFacPrvL, D():FacturasProveedoresLineas( nView ) ), ) ;

   cReturn           += Alltrim( ( cFacPrvL )->cRef )

   if !empty( ( cFacPrvL )->cValPr1 )
      cReturn        += "."
      cReturn        += Alltrim( ( cFacPrvL )->cValPr1 )
   end

   if !empty( ( cFacPrvL )->cValPr2 )
      cReturn        += "."
      cReturn        += Alltrim( ( cFacPrvL )->cValPr2 )
   end

RETURN ( cReturn )







FUNCTION cDesFacPrv( cFacPrvT, cFacPrvL, cFacPrvS )

   local cReturn     := ""

   If( cFacPrvT == nil, cFacPrvT := D():FacturasProveedores( nView ), ) ;
   If( cFacPrvL == nil, cFacPrvL := D():FacturasProveedoresLineas( nView ), ) ;
   If( cFacPrvS == nil, cFacPrvS := D():FacturasProveedoresSeries( nView ), ) ;

   if ( cFacPrvT )->lFacGas
      cReturn        := Rtrim( ( cFacPrvT )->cDetalle )
   else
      cReturn        := Descrip( cFacPrvL, cFacPrvS )
   end

RETURN ( cReturn )



FUNCTION cDesFacPrvLeng( cFacPrvT, cFacPrvL, cFacPrvS, cArtLeng )

   local cReturn     := ""

   If( cFacPrvT == nil, cFacPrvT := D():FacturasProveedores( nView ), ) ;
   If( cFacPrvL == nil, cFacPrvL := D():FacturasProveedoresLineas( nView ), ) ;
   If( cFacPrvS == nil, cFacPrvS := D():FacturasProveedoresSeries( nView ), ) ;
   If( cArtLeng == nil, cArtLeng := D():ArticuloLenguaje( nView ), ) ;

   if ( cFacPrvT )->lFacGas
      cReturn        := Rtrim( ( cFacPrvT )->cDetalle )
   else
      cReturn        := DescripLeng( cFacPrvL, cFacPrvS, cArtLeng )
   end

RETURN ( cReturn )



Function cCtaFacPrv( cFacPrvT, cFacPrvP, cBncPrv )

   local cCtaFacPrv  := ""

   If( cFacPrvT == nil, cFacPrvT := D():FacturasProveedores( nView ), ) ;
   If( cFacPrvP == nil, cFacPrvP := D():FacturasProveedoresPagos( nView ), ) ;
   If( cBncPrv == nil, cBncPrv := D():BancosProveedores( nView ), ) ;

   cCtaFacPrv        := Rtrim( ( cFacPrvT )->cEntBnc + ( cFacPrvT )->cSucBnc + ( cFacPrvT )->cDigBnc + ( cFacPrvT )->cCtaBnc )

   if empty( cCtaFacPrv )
      if dbSeekInOrd( ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac, "nNumFac", cFacPrvP )
         cCtaFacPrv  := cProveeCuenta( ( cFacPrvP )->cCodPrv, cBncPrv )
      end
   end

Return ( cCtaFacPrv )







Function lRectificadaPrv( cNumFac, cFacPrvT, cRctPrvT )

   local lRectificada   := .F.

   If( cFacPrvT == nil, cFacPrvT := D():FacturasProveedores( nView ), ) ;
   If( cRctPrvT == nil, cRctPrvT := D():FacturasRectificativasProveedores( nView ), ) ;
   If( cNumFac == nil, cNumFac := ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac, ) ;

   if dbSeekInOrd( cNumFac, "CNUMFAC", cRctPrvT )
      lRectificada      := .T.
   end

return ( lRectificada )






FUNCTION nTotLFacPrv( uFacPrvL, nDec, nRec, nVdv, cPirDiv )

   local nCalculo
   local nDtoLin
   local nDtoPrm

   If( uFacPrvL == nil, uFacPrvL := if( !empty( tmpFacPrvL ), tmpFacPrvL, D():FacturasProveedoresLineas( nView ) ), ) ;
   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRec == nil, nRec := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nTotUFacPrv( uFacPrvL, nDec, nVdv )

   do case
   case ValType( uFacPrvL ) == "A"
      nDtoLin        := uFacPrvL[ 16 ]
      nDtoPrm        := uFacPrvL[ 17 ]
   case ValType( uFacPrvL ) == "C"
      nDtoLin        := ( uFacPrvL )->nDtoLin
      nDtoPrm        := ( uFacPrvL )->nDtoPrm
   case ValType( uFacPrvL ) == "O"
      nDtoLin        := uFacPrvL:nDtoLin
      nDtoPrm        := uFacPrvL:nDtoPrm
   end

   if nDtoLin <> 0
      nCalculo       -= nCalculo * nDtoLin / 100
   end

   if nDtoPrm <> 0
      nCalculo       -= nCalculo * nDtoPrm / 100
   end

   nCalculo          *= nTotNFacPrv( uFacPrvL )

   nCalculo          := Round( nCalculo, nRec )

RETURN ( if( cPirDiv <> NIL, Trans( nCalculo, cPirDiv ), nCalculo ) )




FUNCTION nTotFFacPrv( cFacPrvL, nDec, nRou, nVdv, cPorDiv )

   local nCalculo := 0

   nCalculo       += nTotLFacPrv( cFacPrvL, nDec, nRou, nVdv )
   nCalculo       += nIvaLFacPrv( cFacPrvL, nDec, nRou, nVdv )

return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )






FUNCTION nDtoLFacPrv( cFacPrvL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cFacPrvL == nil, cFacPrvL := D():FacturasProveedoresLineas( nView ), ) ;
   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRou == nil, nRou := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cFacPrvL )->nDtoLin <> 0

      nCalculo          := nTotUFacPrv( cFacPrvL, nDec ) * nTotNFacPrv( cFacPrvL )





      nCalculo          := nCalculo * ( cFacPrvL )->nDtoLin / 100


      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )






FUNCTION nPrmLFacPrv( cFacPrvL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cFacPrvL == nil, cFacPrvL := D():FacturasProveedoresLineas( nView ), ) ;
   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRou == nil, nRou := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cFacPrvL )->nDtoPrm <> 0

      nCalculo          := nTotUFacPrv( cFacPrvL, nDec ) * nTotNFacPrv( cFacPrvL )





      if ( cFacPrvL )->nDtoLin <> 0
         nCalculo       -= nCalculo * ( cFacPrvL )->nDtoLin / 100
      end

      nCalculo          := nCalculo * ( cFacPrvL )->nDtoPrm / 100

      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )



FUNCTION nTotUFacPrv( uFacPrvL, nDec, nVdv, cPinDiv )

   local nCalculo

   If( uFacPrvL == nil, uFacPrvL := if( !empty( tmpFacPrvL ), tmpFacPrvL, D():FacturasProveedoresLineas( nView ) ), ) ;
   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   do case
   case ValType( uFacPrvL ) == "O"
      nCalculo          := uFacPrvL:nPreUnit       / NotCero( nVdv )
   case ValType( uFacPrvL ) == "A"
      nCalculo          := uFacPrvL[ 7 ]   / NotCero( nVdv )
   case ValType( uFacPrvL ) == "C"
      nCalculo          := ( uFacPrvL )->nPreUnit  / NotCero( nVdv )
   end

   nCalculo             := Round( nCalculo, nDec )

RETURN ( ( if( cPinDiv <> nil, Trans( nCalculo, cPinDiv ), nCalculo ) )  )



FUNCTION cBarPrp1FacPrv( uFacPrvL, uTblPro )

   local cBarPrp1    := ""

   If( uFacPrvL == nil, uFacPrvL := if( !empty( tmpFacPrvL ), tmpFacPrvL, D():FacturasProveedoresLineas( nView ) ), ) ;
   If( uTblPro == nil, uTblPro := D():PropiedadesLineas( nView ), ) ;

   if dbSeekInOrd( ( uFacPrvL )->cCodPr1 + ( uFacPrvL )->cValPr1, "cCodPro", uTblPro )
      cBarPrp1       := ( uTblPro )->nBarTbl
   end

RETURN ( cBarPrp1 )



FUNCTION cBarPrp2FacPrv( uFacPrvL, uTblPro )

   local cBarPrp2    := ""

   If( uFacPrvL == nil, uFacPrvL := if( !empty( tmpFacPrvL ), tmpFacPrvL, D():FacturasProveedoresLineas( nView ) ), ) ;
   If( uTblPro == nil, uTblPro := D():PropiedadesLineas( nView ), ) ;

   if dbSeekInOrd( ( uFacPrvL )->cCodPr2 + ( uFacPrvL )->cValPr2, "cCodPro", uTblPro )
      cBarPrp2       := ( uTblPro )->nBarTbl
   end

RETURN ( cBarPrp2 )



FUNCTION cNomValPrp1( cCodPrp1, cValPrp1 )

RETURN( PropiedadesLineasModel():getNombre( cCodPrp1, cValPrp1 ) )
















FUNCTION cNomValPrp2( cCodPrp2, cValPrp2 )

RETURN( PropiedadesLineasModel():getNombre( cCodPrp2, cValPrp2 ) )
















Function nStockLineaFacPrv()

Return ( StocksModel():nStockArticulo( ( D():FacturasProveedoresLineas( nView ) )->cRef, ( D():FacturasProveedoresLineas( nView ) )->cAlmLin, ( D():FacturasProveedoresLineas( nView ) )->cCodPr1, ( D():FacturasProveedoresLineas( nView ) )->cCodPr2, ( D():FacturasProveedoresLineas( nView ) )->cValPr1, ( D():FacturasProveedoresLineas( nView ) )->cValPr2, ( D():FacturasProveedoresLineas( nView ) )->cLote ) )



Function DesignLabelFacturaProveedor( oFr, cDbfDoc )

   local oLabel
   local lOpenFiles  := empty( nView )

   if lOpenFiles .AND. !Openfiles()
      Return .F.
   endif

   oLabel            := TLabelGeneratorFacturaProveedores():New( nView, oNewImp )



   oLabel:createTempLabelReport()
   oLabel:loadTempLabelReport()

   oLabel:dataLabel( oFr )



   if !empty( ( cDbfDoc )->mReport )
      oFr:LoadFromBlob( ( cDbfDoc )->( Select() ), "mReport")
   else
      oFr:AddPage(         "MainPage" )
      oFr:AddBand(         "MasterData",  "MainPage",       6 )
      oFr:SetProperty(     "MasterData",  "Top",            200 )
      oFr:SetProperty(     "MasterData",  "Height",         100 )
      oFr:SetObjProperty(  "MasterData",  "DataSet",        "Lineas de facturas" )
   end





   oLabel:prepareTempReport( oFr )



   VariableReport( oFr )



   oFr:DesignReport()



   oFr:DestroyFr()

   oLabel:DestroyTempReport()
   oLabel:End()

   if lOpenFiles
      closeFiles()
   end

Return .T.



Function DesignReportFacPrv( oFr, cDoc )

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !empty( ( cDoc )->mReport )

         oFr:LoadFromBlob( ( cDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "CallHbFunc('nTotFacPrv');"                                 + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "MasterData",  "MainPage", 6 )
         oFr:SetProperty(     "MasterData",  "Top", 200 )
         oFr:SetProperty(     "MasterData",  "Height", 0 )
         oFr:SetProperty(     "MasterData",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "MasterData",  "DataSet", "Facturas" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de facturas" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:SetTabTreeExpanded( 16, .F. )
      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function mailReportFacPrv( cCodigoDocumento )

Return ( printReportFacPrv( 6, 1, ImpresoraDefectoUsuario(), cCodigoDocumento ) )



Function PrintReportFacPrv( nDevice, nCopies, cPrinter, cDoc )

   local oFr
   local cFilePdf       := cPatOut() + "FacturaProveedor" + StrTran( ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac, " ", "" ) + ".Pdf"
   local nOrd

   If( nDevice == nil, nDevice := 2, ) ;
   If( nCopies == nil, nCopies := 1, ) ;

   if Empty( cPrinter )
      cPrinter                := ImpresoraDefectoUsuario()
   end

   SysRefresh()

   nOrd                 := ( D():FacturasProveedoresLineas( nView ) )->( ordSetFocus( "nPosPrint" ) )

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( cDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr )






   if !empty( ( D():Documentos( nView ) )->mReport )

      oFr:LoadFromBlob( ( D():Documentos( nView ) )->( Select() ), "mReport" )





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2
            oFr:PrepareReport()
            oFr:ShowPreparedReport()

         case nDevice == 1
            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:PrepareReport()
            oFr:Print()

         case nDevice == 3
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf  )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

      end

   end





   oFr:DestroyFr()

   ( D():FacturasProveedoresLineas( nView ) )->( ordSetFocus( nOrd ) )

Return cFilePdf





FUNCTION nIncUFacPrv( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUFacPrv( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmpLin )->nIva / 100
   end

   IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nIncLFacPrv( dbfLin, nDec, nRou, nVdv )

   local nCalculo := nTotLFacPrv( dbfLin, nDec, nRou, nVdv )

   if !( dbfLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( nCalculo )



Function BrwFacPrv( oGet, nView )

   local oDlg
   local oBrw
   local cPriorFocus
   local nOrd
   local oGet1
   local cGet1
   local oCbxOrd
   local cCbxOrd
   local aCbxOrd

   aCbxOrd           := { "Número", "Fecha", "Proveedor", "Nombre" }
   nOrd              := GetBrwOpt( "BrwFacPrv" )
   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   cPriorFocus       := ( D():FacturasProveedores( nView ) )->( OrdSetFocus( nOrd ) )

   oDlg = TDialog():New(,,,, "Facturas rectificativas de clientes", "HelpEntry",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||       ( OrdClearScope( oBrw, D():FacturasProveedores( nView ) ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, D():FacturasProveedores( nView ), nil, nil, .F. ) ) }, .F., .F.,,,,,, nil, "Find",, )






      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( D():FacturasProveedores( nView ) )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := D():FacturasProveedores( nView )
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Factura de proveedores.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cSerFac + "/" + RTrim( Str( ( D():FacturasProveedores( nView ) )->nNumFac ) ) + "/" + ( D():FacturasProveedores( nView ) )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( D():FacturasProveedores( nView ) )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Proveedor"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| Rtrim( ( D():FacturasProveedores( nView ) )->cCodPrv ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomPrv"
         :bEditValue       := {|| Rtrim( ( D():FacturasProveedores( nView ) )->cNomPrv ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotFacPrv( ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ), D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos( nView ), nil, cDivEmp(), .T. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end





      TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





      TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGet:cText( ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac )
      oGet:bWhen   := {|| .F. }
   end

   SetBrwOpt( "BrwFacPrv", ( D():FacturasProveedores( nView ) )->( OrdNumber() ) )

   ( D():FacturasProveedores( nView ) )->( OrdSetFocus( cPriorFocus ) )





   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )



Function BrwFacPrvLiq( oGet, oFacPrvT, oFacPrvL, oIva, oDivisas )

   local oDlg
   local oBrw
   local cPriorFocus
   local nOrd
   local oGet1
   local cGet1
   local oCbxOrd
   local cCbxOrd
   local aCbxOrd

   aCbxOrd           := { "Número", "Fecha", "Proveedor", "Nombre" }
   nOrd              := GetBrwOpt( "BrwFacPrv" )
   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]
   cPriorFocus       := ( oFacPrvT )->( OrdSetFocus( nOrd ) )

   oDlg = TDialog():New(,,,, "Facturas rectificativas de clientes", "HelpEntry",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||       ( OrdClearScope( oBrw, oFacPrvT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, oFacPrvT, nil, nil, .F. ) ) }, .F., .F.,,,,,, nil, "Find",, )






      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( oFacPrvT )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := oFacPrvT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Factura de proveedores.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( oFacPrvT )->cSerFac + "/" + RTrim( Str( ( oFacPrvT )->nNumFac ) ) + "/" + ( oFacPrvT )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( oFacPrvT )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Proveedor"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| Rtrim( ( oFacPrvT )->cCodPrv ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomPrv"
         :bEditValue       := {|| Rtrim( ( oFacPrvT )->cNomPrv ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotFacPrv( ( oFacPrvT )->cSerFac + Str( ( oFacPrvT )->nNumFac ) + ( oFacPrvT )->cSufFac, oFacPrvT, oFacPrvL, oIva, oDivisas, , nil, cDivEmp(), .T. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end





      TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





      TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGet:cText( ( oFacPrvT )->cSerFac + Str( ( oFacPrvT )->nNumFac ) + ( oFacPrvT )->cSufFac )
      oGet:bWhen   := {|| .F. }
   end

   SetBrwOpt( "BrwFacPrv", ( oFacPrvT )->( OrdNumber() ) )

   ( oFacPrvT )->( OrdSetFocus( cPriorFocus ) )





   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )



FUNCTION BrowseInformesFacPrv( oGet, oGet2 )

   local oDlg
   local oBrw
   local oGet1
   local cGet1
   local oCbxOrd
   local cCbxOrd
   local nOrd
   local aCbxOrd

   if !OpenFiles()
      Return .F.
   end

   aCbxOrd           := { "Número", "Fecha", "Proveedor", "Nombre" }
   nOrd              := GetBrwOpt( "BrwFacPrv" )
   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   oDlg = TDialog():New(,,,, "Facturas de proveedor", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, D():FacturasProveedores( nView ) ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, D():FacturasProveedores( nView ), nil, nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( D():FacturasProveedores( nView ) )->( OrdSetFocus( oCbxOrd:nAt ) ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := D():FacturasProveedores( nView )
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Factura de proveedor.Browse informes"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( D():FacturasProveedores( nView ) )->cSerFac + "/" + RTrim( Str( ( D():FacturasProveedores( nView ) )->nNumFac ) ) + "/" + ( D():FacturasProveedores( nView ) )->cSufFac }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecFac"
         :bEditValue       := {|| Dtoc( ( D():FacturasProveedores( nView ) )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Proveedor"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| Rtrim( ( D():FacturasProveedores( nView ) )->cCodPrv ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| Rtrim( ( D():FacturasProveedores( nView ) )->cNomPrv ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotFacPrv( ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ), D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos( nView ), nil, cDivEmp(), .F. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end





      TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





      TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   if oDlg:nResult == 1
      oGet:cText( ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac )
      oGet2:cText( ( D():FacturasProveedores( nView ) )->cNomPrv )
   end

   SetBrwOpt( "BrwFacPrv", ( D():FacturasProveedores( nView ) )->( OrdNumber() ) )

   ( D():FacturasProveedores( nView ) )->( dbClearFilter() )

   CloseFiles()





   oBrw:CloseData()

RETURN ( oDlg:nResult == 1 )



FUNCTION lValidInformeFacPrv( oGet, oGet2 )

   local lClose   := .F.
   local lValid   := .F.
   local xValor   := oGet:varGet()

   if empty( xValor )
      return .T.
   end

   if !OpenFiles()
      Return .F.
   end

   if ( D():FacturasProveedores( nView ) )->( dbSeek( xValor ) )

      oGet:cText( ( D():FacturasProveedores( nView ) )->cSerFac + Str( ( D():FacturasProveedores( nView ) )->nNumFac ) + ( D():FacturasProveedores( nView ) )->cSufFac )

      oGet2:cText( ( D():FacturasProveedores( nView ) )->cNomPrv )

      lValid   := .T.

   else

      msgStop( "Factura no encontrada" )

   end

   CloseFiles()

RETURN lValid



Function lIntelliArtciculoSearch( cCodArt, cCodPrv, cArticulo, cArtPrv, cCodebar )

   local nOrdAnt
   local cCodigoArticulo
   local cCodigoProveedor





   cCodArt                 := cSeekCodebar( cCodArt, cCodebar, cArticulo )

   if ( cArticulo )->( dbSeek( cCodArt ) ) .OR. ( cArticulo )->( dbSeek( Upper( cCodArt ) ) )
      cCodigoArticulo      := ( cArticulo )->Codigo
   end





   nOrdAnt                 := ( cArtPrv )->( OrdSetFocus( "cRefPrv" ) )

   if ( cArtPrv )->( dbSeek( cCodPrv + cCodArt ) )
      cCodigoProveedor     := ( cArtPrv )->cCodArt
   end

   ( cArtPrv )->( ordSetFocus( nOrdAnt ) )





   do case
      case empty( cCodigoArticulo ) .AND. empty( cCodigoProveedor )

         Return ( .F. )

      case !empty( cCodigoArticulo ) .AND. empty( cCodigoProveedor )

         if ( cArticulo )->( dbSeek( cCodigoArticulo ) )
            Return ( .T. )
         end

      case empty( cCodigoArticulo ) .AND. !empty( cCodigoProveedor )

         if ( cArticulo )->( dbSeek( cCodigoProveedor ) )
            Return ( .T. )
         end

      case !empty( cCodigoArticulo ) .AND. !empty( cCodigoProveedor )

         if uFieldEmpresa( "nCopSea") == 1
            if ( cArticulo )->( dbSeek( cCodigoArticulo ) )
               Return ( .T. )
            end
         else
            if ( cArticulo )->( dbSeek( cCodigoProveedor ) )
               Return ( .T. )
            end
         end

   end

Return ( .F. )



FUNCTION structTotalFacturaProveedoresVista( id, nView )

   local structTotal := sTotFacPrv( id, D():FacturasProveedores( nView ), D():FacturasProveedoresLineas( nView ), D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos( nView ) )

Return ( structTotal )



Function AppendFacturaProveedores( hHeader, aLines )

   local n
   local oError
   local oBlock
   local nFieldPos











   hHeader  := {  "Serie"  => "A", "Numero" => 1, "Fecha"  => Date(), "Lineas" => {  {  "Serie"  => "A", "Numero" => 1, "Codigo" => "123"}, {  "Serie"  => "A", "Numero" => 2, "Codigo" => "124"}, } }

   hHeader  := hb_serialize( hHeader )

   hb_MemoWrit( "c:\ads\serialize.txt", hHeader )

   hHeader  := hb_deserialize( memoread( "c:\ads\serialize.txt" ) )

   Return .F.

   if !OpenFiles()
      return .F.
   end

   CursorWait()

   oBlock      := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ( D():FacturasProveedores( nView ) )->( dbAppend() )

      for n := 1 to len( hHeader )

         nFieldPos   := ( D():FacturasProveedores( nView ) )->( fieldPos( HGetKeyAt( hHeader, n ) ) )
         if nFieldPos <> 0
            ( D():FacturasProveedores( nView ) )->( fieldput( nFieldPos, HGetValueAt( hHeader, n ) ) )
         end

      next

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible crear factura de proveedores"  )

   end
   ErrorBlock( oBlock )

   CloseFiles()

   CursorWE()

Return .F.



Function getExtraFieldFacturaProveedor( cFieldName )

Return ( getExtraField( cFieldName, oDetCamposExtra, D():FacturasProveedoresId( nView ) ) )



function loadGet( oGet, cTipo )

   do case
      case AllTrim( cTipo ) == "Centro de coste"
         oGet:bValid := {|| .T. }
         oGet:bHelp  := {|| nil }
         oGet:Disable()

      case AllTrim( cTipo ) == "Proveedor"
         oGet:bValid := {|| cProvee( oGet, , oGet:oHelpText ) }
         oGet:bHelp  := {|| BrwProvee( oGet, oGet:oHelpText ) }
         oGet:Enable()

      case AllTrim( cTipo ) == "Agente"
         oGet:bValid := {|| cAgentes( oGet, , oGet:oHelpText ) }
         oGet:bHelp  := {|| BrwAgentes( oGet, oGet:oHelpText ) }
         oGet:Enable()

      case AllTrim( cTipo ) == "Cliente"
         oGet:bValid := {|| cClient( oGet, , oGet:oHelpText ) }
         oGet:bHelp  := {|| BrwClient( oGet, oGet:oHelpText ) }
         oGet:Enable()

   end

Return .T.



function clearGet( oGet )

   oGet:cText( Space( 20 ) )
   oGet:oHelpText:cText( Space( 200 ) )

Return .T.



Function ExpAlmacenOrigen( cCodAlm, dbfTmpLin, oBrw )

   local nRec  := ( dbfTmpLin )->( Recno() )

   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( eof() )

      if ( dbfTmpLin )->cAlmOrigen <> cCodAlm
         ( dbfTmpLin )->cAlmOrigen := cCodAlm
      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRec ) )

   oBrw:Refresh()

Return nil



static Function menuEdtDet( oCodArt, oDlg, nIdLin )

   oDetMenu := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .T.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )


      MenuAddItem( "&1. Rotor  ",, .F.,,,, "Rotor16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )




            MenuAddItem( "&1. Campos extra [F9]", "Mostramos y rellenamos los campos extra", .F.,, {|oMenuItem|( oLinDetCamposExtra:Play( nIdLin ) )},, "GC_FORM_PLUS2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&2. Modificar artículo", "Modificar la ficha del artículo", .F.,, {|oMenuItem|( EdtArticulo( oCodArt:VarGet() ) )},, "gc_object_cube_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&3. Informe de artículo", "Abrir el informe del artículo", .F.,, {|oMenuItem|( if( RolesModel():getRolNoVerPreciosCosto( Auth():rolUuid() ), msgStop( "No tiene permiso para ver los precios de costo" ), InfArticulo( oCodArt:VarGet() ) ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&4. Informe de stock", "Abrir el informe del stock", .F.,, {|oMenuItem|( InfStock( oCodArt:VarGet() ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oDetMenu )

Return ( oDetMenu )



FUNCTION hStockBufferFacPrv( aTmp )

   local hBuffer := {=>}

   do case
      case hb_isArray( aTmp )

         hset( hBuffer, "codigo_articulo", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "cRef" ) ) ] ) )
         hset( hBuffer, "codigo_almacen_entrada", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "cAlmLin" ) ) ] ) )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "cAlmOrigen" ) ) ] ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "cCodPr1" ) ) ] ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "cValPr1" ) ) ] ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "cCodPr2" ) ) ] ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "cValPr2" ) ) ] ) )
         hset( hBuffer, "lote", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "clote" ) ) ] ) )
         hset( hBuffer, "bultos_articulo", aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nBultos" ) ) ] )
         hset( hBuffer, "cajas_articulo", aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "nCanEnt" ) ) ] )
         hset( hBuffer, "unidades_articulo", nTotNFacPrv( aTmp ) )
         hset( hBuffer, "fecha", aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "dFecFac" ) ) ] )
         hset( hBuffer, "hora", AllTrim( aTmp[ ( D():FacturasProveedoresLineas( nView ) )->( fieldpos( "tFecFac" ) ) ] ) )

      case hb_isChar( aTmp )

         hset( hBuffer, "codigo_articulo", AllTrim( ( aTmp )->cRef ) )
         hset( hBuffer, "codigo_almacen_entrada", AllTrim( ( aTmp )->cAlmLin ) )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( ( aTmp )->cAlmOrigen ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( ( aTmp )->cCodPr1 ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( ( aTmp )->cValPr1 ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( ( aTmp )->cCodPr2 ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( ( aTmp )->cValPr2 ) )
         hset( hBuffer, "lote", AllTrim( ( aTmp )->clote ) )
         hset( hBuffer, "bultos_articulo", ( aTmp )->nBultos )
         hset( hBuffer, "cajas_articulo", ( aTmp )->nCanEnt )
         hset( hBuffer, "unidades_articulo", nTotNFacPrv( aTmp ) )
         hset( hBuffer, "fecha", ( aTmp )->dFecFac )
         hset( hBuffer, "hora", AllTrim( ( aTmp )->tFecFac ) )

   end

RETURN ( hBuffer )
