#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 8 ".\.\Prg\FacturarLineasAlbaranes.prg"
_HB_CLASS TFacturarLineasAlbaranes ; function TFacturarLineasAlbaranes ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFacturarLineasAlbaranes", iif( .F., { }, { @HBObject() } ), @TFacturarLineasAlbaranes() ) ) ;

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )

   _HB_MEMBER { cPath } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPath"}, .F. )

   _HB_MEMBER { nView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nView"}, .F. )

   _HB_MEMBER { cNumAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNumAlb"}, .F. )
   _HB_MEMBER { cNumFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNumFac"}, .F. )

   _HB_MEMBER { lPrint } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lPrint"}, .F. )

   _HB_MEMBER { cTmpAlbLin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTmpAlbLin"}, .F. )
   _HB_MEMBER { cTmpFacLin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTmpFacLin"}, .F. )

   _HB_MEMBER { cTemporalLineaAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTemporalLineaAlbaran"}, .F. )
   _HB_MEMBER { cTemporalLineaFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTemporalLineaFactura"}, .F. )

   _HB_MEMBER { oBrwLineasAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwLineasAlbaran"}, .F. )
   _HB_MEMBER { oBrwLineasFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwLineasFactura"}, .F. )

   _HB_MEMBER { nPorcentajeAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nPorcentajeAlbaran"}, .F. )
   _HB_MEMBER { nPorcentajeFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nPorcentajeFactura"}, .F. )

   _HB_MEMBER { oBtnUnidadAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnUnidadAlbaran"}, .F. )
   _HB_MEMBER { oBtnLineaAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnLineaAlbaran"}, .F. )
   _HB_MEMBER { oBtnTodoAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnTodoAlbaran"}, .F. )

   _HB_MEMBER { oBtnUnidadFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnUnidadFactura"}, .F. )
   _HB_MEMBER { oBtnLineaFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnLineaFactura"}, .F. )
   _HB_MEMBER { oBtnTodoFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnTodoFactura"}, .F. )

   _HB_MEMBER { oPorcentajePropuestoAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPorcentajePropuestoAlbaran"}, .F. )
   _HB_MEMBER { nPorcentajePropuestoAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nPorcentajePropuestoAlbaran"}, .F. )
   _HB_MEMBER { oPorcentajePropuestoFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPorcentajePropuestoFactura"}, .F. )
   _HB_MEMBER { nPorcentajePropuestoFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nPorcentajePropuestoFactura"}, .F. )

   _HB_MEMBER { oSerieFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSerieFactura"}, .F. )
   _HB_MEMBER { cSerieFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerieFactura"}, .F. )
   _HB_MEMBER { nNumeroFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumeroFactura"}, .F. )
   _HB_MEMBER { cSufijoFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijoFactura"}, .F. )
   _HB_MEMBER { oFechaFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFechaFactura"}, .F. )
   _HB_MEMBER { dFechaFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFechaFactura"}, .F. )

   _HB_MEMBER { oSayNeto } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayNeto"}, .F. )
   _HB_MEMBER { nSayNeto } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nSayNeto"}, .F. )
   _HB_MEMBER { oSayIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayIva"}, .F. )
   _HB_MEMBER { nSayIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nSayIva"}, .F. )
   _HB_MEMBER { oSayTotal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayTotal"}, .F. )
   _HB_MEMBER { nSayTotal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nSayTotal"}, .F. )
   _HB_MEMBER { oSayTextoTotal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayTextoTotal"}, .F. )

   _HB_MEMBER { nTotalAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nTotalAlbaran"}, .F. )

   _HB_MEMBER { oColNetoAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColNetoAlbaran"}, .F. )
   _HB_MEMBER { oColNetoFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColNetoFactura"}, .F. )

   _HB_MEMBER { oColIVAAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColIVAAlbaran"}, .F. )
   _HB_MEMBER { oColIVAFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColIVAFactura"}, .F. )

   _HB_MEMBER { oColReqAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColReqAlbaran"}, .F. )
   _HB_MEMBER { oColReqFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColReqFactura"}, .F. )

   _HB_MEMBER { oColTotalAlbaran } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColTotalAlbaran"}, .F. )
   _HB_MEMBER { oColTotalFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColTotalFactura"}, .F. )

   _HB_MEMBER FacturarLineas( cNumAlb); oClass:AddMethod( "FacturarLineas", @TFacturarLineasAlbaranes_FacturarLineas(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CreaTemporales(); oClass:AddMethod( "CreaTemporales", @TFacturarLineasAlbaranes_CreaTemporales(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CargaTemporal(); oClass:AddMethod( "CargaTemporal", @TFacturarLineasAlbaranes_CargaTemporal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EliminaTemporales(); oClass:AddMethod( "EliminaTemporales", @TFacturarLineasAlbaranes_EliminaTemporales(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource(); oClass:AddMethod( "Resource", @TFacturarLineasAlbaranes_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitResource(); oClass:AddMethod( "InitResource", @TFacturarLineasAlbaranes_InitResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ActualizaPantalla(); oClass:AddMethod( "ActualizaPantalla", @TFacturarLineasAlbaranes_ActualizaPantalla(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CalculaPorcentajes(); oClass:AddMethod( "CalculaPorcentajes", @TFacturarLineasAlbaranes_CalculaPorcentajes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER PasaUnidadAlbaran(); oClass:AddMethod( "PasaUnidadAlbaran", @TFacturarLineasAlbaranes_PasaUnidadAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER PasaLineaAlbaran(); oClass:AddMethod( "PasaLineaAlbaran", @TFacturarLineasAlbaranes_PasaLineaAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER PasaTodoAlbaran(); oClass:AddMethod( "PasaTodoAlbaran", @TFacturarLineasAlbaranes_PasaTodoAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER PasaUnidadFactura(); oClass:AddMethod( "PasaUnidadFactura", @TFacturarLineasAlbaranes_PasaUnidadFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER PasaLineaFactura(); oClass:AddMethod( "PasaLineaFactura", @TFacturarLineasAlbaranes_PasaLineaFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER PasaTodoFactura(); oClass:AddMethod( "PasaTodoFactura", @TFacturarLineasAlbaranes_PasaTodoFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GuardaAlbaran(); oClass:AddMethod( "GuardaAlbaran", @TFacturarLineasAlbaranes_GuardaAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GuardaAlbaranModa(); oClass:AddMethod( "GuardaAlbaranModa", @TFacturarLineasAlbaranes_GuardaAlbaranModa(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GeneraFactura(); oClass:AddMethod( "GeneraFactura", @TFacturarLineasAlbaranes_GeneraFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EndResource(); oClass:AddMethod( "EndResource", @TFacturarLineasAlbaranes_EndResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CalculaTotales(); oClass:AddMethod( "CalculaTotales", @TFacturarLineasAlbaranes_CalculaTotales(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ChangePorcentajePropuestoAlbaran(); oClass:AddMethod( "ChangePorcentajePropuestoAlbaran", @TFacturarLineasAlbaranes_ChangePorcentajePropuestoAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ChangePorcentajePropuestoFactura(); oClass:AddMethod( "ChangePorcentajePropuestoFactura", @TFacturarLineasAlbaranes_ChangePorcentajePropuestoFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RecalculaPorcentajes(); oClass:AddMethod( "RecalculaPorcentajes", @TFacturarLineasAlbaranes_RecalculaPorcentajes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RefreshPorcentajePropuesto(); oClass:AddInline( "RefreshPorcentajePropuesto", {|Self | ( ( Self ) ), ( ::oPorcentajePropuestoAlbaran:Refresh(), ::oPorcentajePropuestoFactura:Refresh() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ComprobacionesCalculoPorcentajes(); oClass:AddMethod( "ComprobacionesCalculoPorcentajes", @TFacturarLineasAlbaranes_ComprobacionesCalculoPorcentajes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lPorcentajeAlcanzado(); oClass:AddInline( "lPorcentajeAlcanzado", {|Self | ( ( Self ) ), ( ( Round( ::nPorcentajeFactura, 0 ) < ::nPorcentajePropuestoFactura ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SaltoRegistro(); oClass:AddMethod( "SaltoRegistro", @TFacturarLineasAlbaranes_SaltoRegistro(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFacturarLineasAlbaranes ;



static FUNCTION TFacturarLineasAlbaranes_FacturarLineas( nView ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   ::cNumFac   := ""
   ::lPrint    := .F.
   ::nView     := nView
   ::cNumAlb   := D():AlbaranesClientesId( ::nView )





   if lFacturado( D():Get( "AlbCliT", ::nView ) )
      msgStop( "Albarán ya facturado" )
      Return .F.
   end

   if Empty( ( D():Get( "AlbCliT", ::nView ) )->cSerAlb )
      msgStop( "Tiene que seleccionar un albarán para facturarlo" )
      Return .F.
   end

   if ::nView < 1
      msgStop( "La vista creada no es válida" )
      Return .F.
   end





   ::nPorcentajeAlbaran             := 100
   ::nPorcentajeFactura             := 0

   if ( "MODA" $ appParamsMain() )
      ::nPorcentajePropuestoAlbaran := 50
      ::nPorcentajePropuestoFactura := 50
   else
      ::nPorcentajePropuestoAlbaran := 100
      ::nPorcentajePropuestoFactura := 0
   end

   ::nSayNeto                       := 0
   ::nSayIva                        := 0
   ::nSayTotal                      := 0

   ::cSerieFactura                  := "A"
   ::dFechaFactura                  := GetSysDate()





   ::CreaTemporales()





   ::Resource()





   ::EliminaTemporales()

Return ( ::lPrint )



static FUNCTION TFacturarLineasAlbaranes_CreaTemporales( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   local cDbfAlbLin     := "ACliL"
   local cDbfFacLin     := "FCliL"

   ::cTmpAlbLin         := cGetNewFileName( cPatTmp() + cDbfAlbLin )
   ::cTmpFacLin         := cGetNewFileName( cPatTmp() + cDbfFacLin )





   dbCreate( ::cTmpAlbLin, aSqlStruct( aColAlbCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), ::cTmpAlbLin, cCheckArea( cDbfAlbLin, @::cTemporalLineaAlbaran ), .F. )

   ( ::cTemporalLineaAlbaran )->( OrdCondSet( "!Deleted()", {|| !Deleted() } ) )
   ( ::cTemporalLineaAlbaran )->( OrdCreate( ::cTmpAlbLin, "cLinArt", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin ) + Field->cRef } ) )

   ( ::cTemporalLineaAlbaran )->( OrdCondSet( "!Deleted()", {|| !Deleted() } ) )
   ( ::cTemporalLineaAlbaran )->( OrdCreate( ::cTmpAlbLin, "nNumAlb", "Str( Recno() )", {|| Str( Recno() ) } ) )





   ::CargaTemporal()





   dbCreate( ::cTmpFacLin, aSqlStruct( aColAlbCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), ::cTmpFacLin, cCheckArea( cDbfFacLin, @::cTemporalLineaFactura ), .F. )

   ( ::cTemporalLineaFactura )->( OrdCondSet( "!Deleted()", {|| !Deleted() } ) )
   ( ::cTemporalLineaFactura )->( OrdCreate( ::cTmpFacLin, "cLinArt", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin ) + Field->cRef } ) )

   ( ::cTemporalLineaFactura )->( OrdCondSet( "!Deleted()", {|| !Deleted() } ) )
   ( ::cTemporalLineaFactura )->( OrdCreate( ::cTmpFacLin, "nNumFac", "Str( Recno() )", {|| Str( Recno() ) } ) )

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_CargaTemporal( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   if ( D():Get( "AlbCliL", ::nView ) )->( dbSeek( ::cNumAlb ) )
      while ( ( D():Get( "AlbCliL", ::nView ) )->cSerAlb + Str( ( D():Get( "AlbCliL", ::nView ) )->nNumAlb ) + ( D():Get( "AlbCliL", ::nView ) )->cSufAlb ) == ::cNumAlb .AND. !( D():Get( "AlbCliL", ::nView ) )->( eof() )
         dbPass( D():Get( "AlbCliL", ::nView ), ::cTemporalLineaAlbaran, .T. )
         ( D():Get( "AlbCliL", ::nView ) )->( dbSkip() )
      end
      end

   ( ::cTemporalLineaAlbaran )->( dbGoTop() )

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_EliminaTemporales( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   if !Empty( ::cTemporalLineaAlbaran ) .AND. ( ::cTemporalLineaAlbaran )->( Used() )
      ( ::cTemporalLineaAlbaran )->( dbCloseArea() )
   end

   if !Empty( ::cTemporalLineaFactura ) .AND. ( ::cTemporalLineaFactura )->( Used() )
      ( ::cTemporalLineaFactura )->( dbCloseArea() )
   end

   ::cTemporalLineaAlbaran      := nil
   ::cTemporalLineaFactura      := nil

   dbfErase( ::cTmpAlbLin )
   dbfErase( ::cTmpFacLin )

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_Resource( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   local oFont             := TFont():New( "Arial", 8, 26, .F., .T. )

   ::oDlg = TDialog():New(,,,,, "FacturaLineasAlbaranes",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )













      ::oPorcentajePropuestoAlbaran := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::nPorcentajePropuestoAlbaran, ::nPorcentajePropuestoAlbaran:= u ) }, ::oDlg,, "999", {||    ( ::nPorcentajePropuestoAlbaran > 0 .AND. ::nPorcentajePropuestoAlbaran < 101 )},,,,,, .F.,,, .F., .T.,,, {||      0}, {||      100},, nil,,, )

         ::oPorcentajePropuestoAlbaran:bChange  := {|| ::ChangePorcentajePropuestoAlbaran() }

      TBtnBmp():ReDefine( 101, "gc_recycle_16",,,,,{|| ::RecalculaPorcentajes() }, ::oDlg, .F., , .F.,  )





      ::oBrwLineasAlbaran                 := IXBrowse():New( ::oDlg )

      ::oBrwLineasAlbaran:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwLineasAlbaran:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      ::oBrwLineasAlbaran:bClrStd         := {|| { if( ( ::cTemporalLineaAlbaran )->lKitChl, 8421504, 0 ), GetSysColor( 5 ) } }

      ::oBrwLineasAlbaran:cAlias          := ::cTemporalLineaAlbaran

      ::oBrwLineasAlbaran:lFooter         := .T.

      ::oBrwLineasAlbaran:nMarqueeStyle   := 6
      ::oBrwLineasAlbaran:cName           := "Temporal albaran clientes"

      ::oBrwLineasAlbaran:CreateFromResource( 110 )

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Código"
         :bEditValue          := {|| ( ::cTemporalLineaAlbaran )->cRef }
         :nWidth              := 40
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| Descrip( ::cTemporalLineaAlbaran ) }
         :nWidth              := 175
         :bFooter             := {|| Trans( ::nPorcentajeAlbaran, "@E 999.99%" ) }
         :nFootStrAlign       := 1
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ( ::cTemporalLineaAlbaran )->cValPr1 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ( ::cTemporalLineaAlbaran )->cValPr2 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Lote"
         :bEditValue          := {|| ( ::cTemporalLineaAlbaran )->cLote }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Caducidad"
         :bEditValue          := {|| Dtoc( ( ::cTemporalLineaAlbaran)->dFecCad ) }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := cNombreCajas()
         :bEditValue          := {|| ( ::cTemporalLineaAlbaran )->nCanEnt }
         :cEditPicture        := MasUnd()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| ( ::cTemporalLineaAlbaran )->nUniCaja }
         :cEditPicture        := MasUnd()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Total " + cNombreUnidades()
         :bEditValue          := {|| nTotNAlbCli( ::cTemporalLineaAlbaran ) }
         :cEditPicture        := MasUnd()
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| nNetUAlbCli( ::cTemporalLineaAlbaran ) }
         :cEditPicture        := cPouDiv()
         :nWidth              := 55
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      if ( "MODA" $ appParamsMain() )

      with object ( ::oColTotalAlbaran := ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nNetLAlbCli( D():Get( "AlbCliT", ::nView ), ::cTemporalLineaAlbaran, , , , .F. ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      else

      with object ( ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ( ::cTemporalLineaAlbaran )->nIva }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 35
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( ::oColNetoAlbaran := ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Base"
         :bEditValue          := {|| nNetLAlbCli( D():Get( "AlbCliT", ::nView ), ::cTemporalLineaAlbaran, , , , .F. ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( ::oColIVAAlbaran := ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "IVA"
         :bEditValue          := {|| nIvaLAlbCli( ::cTemporalLineaAlbaran ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 45
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end

      with object ( ::oColReqAlbaran := ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "R.E."
         :bEditValue          := {|| nReqLAlbCli( ::cTemporalLineaAlbaran ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 45
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end

      with object ( ::oColTotalAlbaran := ::oBrwLineasAlbaran:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nNetLAlbCli( D():Get( "AlbCliT", ::nView ), ::cTemporalLineaAlbaran, , , , .F. ) + nIvaLAlbCli( ::cTemporalLineaAlbaran ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 45
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end

      end








      ::oBtnUnidadAlbaran := TButton():ReDefine( 140, {||( ::PasaUnidadAlbaran() )}, ::oDlg,,, .F.,,,, .F. )




      ::oBtnLineaAlbaran := TButton():ReDefine( 130, {||( ::PasaLineaAlbaran() )}, ::oDlg,,, .F.,,,, .F. )




      ::oBtnTodoAlbaran := TButton():ReDefine( 120, {||( ::PasaTodoAlbaran() )}, ::oDlg,,, .F.,,,, .F. )













      ::oPorcentajePropuestoFactura := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::nPorcentajePropuestoFactura, ::nPorcentajePropuestoFactura:= u ) }, ::oDlg,, "999", {||    ( ::nPorcentajePropuestoFactura > 0 .AND. ::nPorcentajePropuestoFactura < 101 )},,,,,, .F.,,, .F., .T.,,, {||      0}, {||      100},, nil,,, )

         ::oPorcentajePropuestoFactura:bChange  := {|| ::ChangePorcentajePropuestoFactura() }

      TBtnBmp():ReDefine( 201, "gc_recycle_16",,,,,{|| ::RecalculaPorcentajes() }, ::oDlg, .F., , .F.,  )












      ::oSerieFactura := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::cSerieFactura, ::cSerieFactura:= u ) }, ::oDlg,, "@!", {||    ( ::cSerieFactura >= "A" .AND. ::cSerieFactura <= "Z"  )},,,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oSerieFactura ) )}, {||  ( DwSerie( ::oSerieFactura ) )},,,, nil,,, )








      ::oFechaFactura := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::dFechaFactura, ::dFechaFactura:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





      ::oBrwLineasFactura                 := IXBrowse():New( ::oDlg )

      ::oBrwLineasFactura:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwLineasFactura:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      ::oBrwLineasFactura:bClrStd         := {|| { if( ( ::cTemporalLineaFactura )->lKitChl, 8421504, 0 ), GetSysColor( 5 ) } }

      ::oBrwLineasFactura:cAlias          := ::cTemporalLineaFactura

      ::oBrwLineasFactura:lFooter         := .T.

      ::oBrwLineasFactura:nMarqueeStyle   := 6
      ::oBrwLineasFactura:cName           := "Temporal facturas clientes"

      ::oBrwLineasFactura:CreateFromResource( 230 )

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Código"
         :bEditValue          := {|| ( ::cTemporalLineaFactura )->cRef }
         :nWidth              := 40
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| Descrip( ::cTemporalLineaFactura ) }
         :nWidth              := 175
         :bFooter             := {|| Trans( ::nPorcentajeFactura, "@E 999.99%" ) }
         :nFootStrAlign       := 1
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ( ::cTemporalLineaFactura )->cValPr1 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ( ::cTemporalLineaFactura )->cValPr2 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Lote"
         :bEditValue          := {|| ( ::cTemporalLineaFactura )->cLote }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Caducidad"
         :bEditValue          := {|| Dtoc( ( ::cTemporalLineaFactura )->dFecCad ) }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := cNombreCajas()
         :bEditValue          := {|| ( ::cTemporalLineaFactura )->nCanEnt }
         :cEditPicture        := MasUnd()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| ( ::cTemporalLineaFactura )->nUniCaja }
         :cEditPicture        := MasUnd()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Total " + cNombreUnidades()
         :bEditValue          := {|| nTotNAlbCli( ::cTemporalLineaFactura ) }
         :cEditPicture        := MasUnd()
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| nNetUAlbCli( ::cTemporalLineaFactura ) }
         :cEditPicture        := cPouDiv()
         :nWidth              := 55
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( ::oBrwLineasFactura:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ( ::cTemporalLineaFactura )->nIva }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 35
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( ::oColNetoFactura := ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Base"
         :bEditValue          := {|| nNetLAlbCli( D():Get( "AlbCliT", ::nView ), ::cTemporalLineaFactura, , , , .F. ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( ::oColIVAFactura := ::oBrwLineasFactura:AddCol() )
         :cHeader             := "IVA"
         :bEditValue          := {|| nIvaLAlbCli( ::cTemporalLineaFactura ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end

      with object ( ::oColReqFactura := ::oBrwLineasFactura:AddCol() )
         :cHeader             := "R.E."
         :bEditValue          := {|| nReqLAlbCli( ::cTemporalLineaFactura ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end

      with object ( ::oColTotalFactura := ::oBrwLineasFactura:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nNetLAlbCli( D():Get( "AlbCliT", ::nView ), ::cTemporalLineaFactura, , , , .F. ) + nIvaLAlbCli( ::cTemporalLineaFactura ) }
         :cEditPicture        := cPorDiv()
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end








      ::oBtnUnidadFactura := TButton():ReDefine( 240, {||( ::PasaUnidadFactura )}, ::oDlg,,, .F.,,,, .F. )




      ::oBtnLineaFactura := TButton():ReDefine( 250, {||( ::PasaLineaFactura )}, ::oDlg,,, .F.,,,, .F. )




      ::oBtnTodoFactura := TButton():ReDefine( 260, {||( ::PasaTodoFactura )}, ::oDlg,,, .F.,,,, .F. )







      ::oSayNeto := TSay():ReDefine( 270, {|| ::nSayNeto}, ::oDlg,,,, .F.,, .F., .F., )



      ::oSayIva := TSay():ReDefine( 280, {|| ::nSayIva}, ::oDlg,,,, .F.,, .F., .F., )




      ::oSayTotal := TSay():ReDefine( 290, {|| ::nSayTotal}, ::oDlg,,,, .F., oFont, .F., .F., )




      ::oSayTextoTotal := TSay():ReDefine( 291,, ::oDlg,,,, .F., oFont, .F., .F., )








      TButton():ReDefine( 500, {||( ::EndResource( .T. ) )}, ::oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 1, {||( ::EndResource() )}, ::oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( ::oDlg:End() )}, ::oDlg,,, .F.,,,, .T. )

      if ( "MODA" $ appParamsMain() )
         ::oDlg:bStart  := {|| ::RecalculaPorcentajes() }
      else
         ::oDlg:bStart  := {|| ::ActualizaPantalla() }
      end

      ::oDlg:Activate( , , , .T., , , {|| ::InitResource() } )

      ::oBrwLineasAlbaran:CloseData()
      ::oBrwLineasFactura:CloseData()

      oFont:End()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_InitResource( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   ::oBrwLineasAlbaran:Load()

   ::oBrwLineasFactura:Load()

Return ( .T. )



static FUNCTION TFacturarLineasAlbaranes_PasaUnidadAlbaran( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   if ( ::cTemporalLineaAlbaran )->( OrdKeyCount() ) == 0
      Return .T.
   end





   do case
      case ( ::cTemporalLineaAlbaran )->nUniCaja > 1

         if !dbSeekInOrd( Str( ( ::cTemporalLineaAlbaran )->nNumLin, 4 ) + ( ::cTemporalLineaAlbaran )->cRef , "cLinArt", ::cTemporalLineaFactura )

            dbPass( ::cTemporalLineaAlbaran, ::cTemporalLineaFactura, .T. )

            if dbDialogLock( ::cTemporalLineaFactura )
               ( ::cTemporalLineaFactura )->nUniCaja := 1
               ( ::cTemporalLineaFactura )->( dbUnLock() )
            end

         else

            if dbDialogLock( ::cTemporalLineaFactura )
               ( ::cTemporalLineaFactura )->nUnicaja++
               ( ::cTemporalLineaFactura )->( dbUnLock() )
            end

         end

         if dbDialogLock( ::cTemporalLineaAlbaran )
            ( ::cTemporalLineaAlbaran )->nUniCaja--
            ( ::cTemporalLineaAlbaran )->( dbUnLock() )
         end

      case ( ::cTemporalLineaAlbaran )->nUniCaja <= 0

         dbPass( ::cTemporalLineaAlbaran, ::cTemporalLineaFactura, .T. )

         if dbDialogLock( ::cTemporalLineaAlbaran )
            ( ::cTemporalLineaAlbaran )->( dbDelete() )
            ( ::cTemporalLineaAlbaran )->( dbUnLock() )
         end

      otherwise

         if !dbSeekInOrd( Str( ( ::cTemporalLineaAlbaran )->nNumLin, 4 ) + ( ::cTemporalLineaAlbaran )->cRef , "cLinArt", ::cTemporalLineaFactura )

            dbPass( ::cTemporalLineaAlbaran, ::cTemporalLineaFactura, .T. )

         else

            if dbDialogLock( ::cTemporalLineaFactura )
               ( ::cTemporalLineaFactura )->nUniCaja++
               ( ::cTemporalLineaFactura )->( dbUnLock() )
            end

         end

         if dbDialogLock( ::cTemporalLineaAlbaran )
            ( ::cTemporalLineaAlbaran )->( dbDelete() )
            ( ::cTemporalLineaAlbaran )->( dbUnLock() )
         end

   end





   ::ActualizaPantalla()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_PasaLineaAlbaran( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   if ( ::cTemporalLineaAlbaran )->( OrdKeyCount() ) == 0
      Return .T.
   end





   dbPass( ::cTemporalLineaAlbaran, ::cTemporalLineaFactura, .T. )





   if dbDialogLock( ::cTemporalLineaAlbaran )
      ( ::cTemporalLineaAlbaran )->( dbDelete() )
      ( ::cTemporalLineaAlbaran )->( dbUnLock() )
   end

   if ( ::cTemporalLineaAlbaran )->( OrdKeyCount() ) == 0
      ( ::cTemporalLineaAlbaran )->( __dbZap() )
   end





   ::ActualizaPantalla()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_PasaTodoAlbaran( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   ( ::cTemporalLineaAlbaran )->( dbGoTop() )

   while !( ::cTemporalLineaAlbaran )->( Eof() )

      dbPass( ::cTemporalLineaAlbaran, ::cTemporalLineaFactura, .T. )

      ( ::cTemporalLineaAlbaran )->( dbSkip() )

   end





   ( ::cTemporalLineaAlbaran )->( __dbZap() )





   ::ActualizaPantalla()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_PasaUnidadFactura( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   if ( ::cTemporalLineaFactura )->( OrdKeyCount() ) == 0
      Return .T.
   end





   do case
      case ( ::cTemporalLineaFactura )->nUniCaja > 1

         if !dbSeekInOrd( Str( ( ::cTemporalLineaFactura )->nNumLin, 4 ) + ( ::cTemporalLineaFactura )->cRef , "cLinArt", ::cTemporalLineaAlbaran )

            dbPass( ::cTemporalLineaFactura, ::cTemporalLineaAlbaran, .T. )

            if dbDialogLock( ::cTemporalLineaAlbaran )
               ( ::cTemporalLineaAlbaran )->nUniCaja := 1
               ( ::cTemporalLineaAlbaran )->( dbUnLock() )
            end

         else

            if dbDialogLock( ::cTemporalLineaAlbaran )
               ( ::cTemporalLineaAlbaran )->nUnicaja++
               ( ::cTemporalLineaAlbaran )->( dbUnLock() )
            end

         end

         if dbDialogLock( ::cTemporalLineaFactura )
            ( ::cTemporalLineaFactura )->nUniCaja--
            ( ::cTemporalLineaFactura )->( dbUnLock() )
         end

      case ( ::cTemporalLineaFactura )->nUniCaja <= 0

         dbPass( ::cTemporalLineaFactura, ::cTemporalLineaAlbaran, .T. )

         if dbDialogLock( ::cTemporalLineaFactura )
            ( ::cTemporalLineaFactura )->( dbDelete() )
            ( ::cTemporalLineaFactura )->( dbUnLock() )
         end

      otherwise

         if !dbSeekInOrd( Str( ( ::cTemporalLineaFactura )->nNumLin, 4 ) + ( ::cTemporalLineaFactura )->cRef , "cLinArt", ::cTemporalLineaAlbaran )

            dbPass( ::cTemporalLineaFactura, ::cTemporalLineaAlbaran, .T. )

         else

            if dbDialogLock( ::cTemporalLineaAlbaran )
               ( ::cTemporalLineaAlbaran )->nUniCaja++
               ( ::cTemporalLineaAlbaran )->( dbUnLock() )
            end

         end

         if dbDialogLock( ::cTemporalLineaFactura )
            ( ::cTemporalLineaFactura )->( dbDelete() )
            ( ::cTemporalLineaFactura )->( dbUnLock() )
         end

   end




   ::ActualizaPantalla()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_PasaLineaFactura( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   if ( ::cTemporalLineaFactura )->( OrdKeyCount() ) == 0
      Return .F.
   end





   dbPass( ::cTemporalLineaFactura, ::cTemporalLineaAlbaran, .T. )





   if dbDialogLock( ::cTemporalLineaFactura )
      ( ::cTemporalLineaFactura )->( dbDelete() )
      ( ::cTemporalLineaFactura )->( dbUnLock() )
   end

   if ( ::cTemporalLineaFactura )->( OrdKeyCount() ) == 0
      ( ::cTemporalLineaFactura )->( __dbZap() )
   end





   ::ActualizaPantalla()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_PasaTodoFactura( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   ( ::cTemporalLineaAlbaran )->( __dbZap() )






   ::CargaTemporal()





   ( ::cTemporalLineaFactura )->( __dbZap() )





   ::ActualizaPantalla()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_ActualizaPantalla( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   if !Empty( ::oBrwLineasAlbaran )
      ::oBrwLineasAlbaran:MakeTotals()
      ::oBrwLineasAlbaran:Refresh()
   end

   if !Empty( ::oBrwLineasFactura )
      ::oBrwLineasFactura:MakeTotals()
      ::oBrwLineasFactura:Refresh()
   end





   ::CalculaPorcentajes()





   ::CalculaTotales()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_CalculaPorcentajes( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   local nTotal

   ::oBrwLineasAlbaran:MakeTotals()
   ::oBrwLineasFactura:MakeTotals()

   nTotal                  := ::oColTotalAlbaran:nTotal + ::oColTotalFactura:nTotal

   ::nPorcentajeAlbaran    := ( ::oColTotalAlbaran:nTotal * 100 ) / nTotal

   ::nPorcentajeFactura    := ( ::oColTotalFactura:nTotal * 100 ) / nTotal





   if !Empty( ::oBrwLineasAlbaran )
      ::oBrwLineasAlbaran:Refresh()
   end

   if !Empty( ::oBrwLineasFactura )
      ::oBrwLineasFactura:Refresh()
   end

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_EndResource( lPrint ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   If( lPrint == nil, lPrint := .F., ) ;

   if ( ::cTemporalLineaFactura )->( OrdKeyCount() ) == 0
      MsgStop( "Tiene que pasar al menos una línea del albarán para crear una nueva factura." )
      Return .F.
   end





   if ( "MODA" $ appParamsMain() )
      ::GuardaAlbaranModa()
   else
      ::GuardaAlbaran()
   end





   ::GeneraFactura()





   if lPrint
      ::lPrint       := lPrint
      PrnFacCli( ::cNumFac )
   end





   ::oDlg:End( 1 )

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_GuardaAlbaran( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   local aTotAlb





   while ( D():Get( "AlbCliL", ::nView ) )->( dbSeek( ::cNumAlb ) ) .AND. !( D():Get( "AlbCliL", ::nView ) )->( eof() )
      if dbLock( D():Get( "AlbCliL", ::nView ) )
         ( D():Get( "AlbCliL", ::nView ) )->( dbDelete() )
         ( D():Get( "AlbCliL", ::nView ) )->( dbUnLock() )
      end
   end





   ( ::cTemporalLineaAlbaran )->( dbGoTop() )

   while !( ::cTemporalLineaAlbaran )->( eof() )

      dbPass( ::cTemporalLineaAlbaran, D():Get( "AlbCliL", ::nView ), .T. )

      ( ::cTemporalLineaAlbaran )->( dbSkip() )

   end









   aTotAlb  := aTotAlbCli( ::cNumAlb, D():Get( "AlbCliT", ::nView ), D():Get( "AlbCliL", ::nView ), D():Get( "TIva", ::nView ), D():Get( "Divisas", ::nView ) )

   if dbLock( D():Get( "AlbCliT", ::nView ) )
      ( D():Get( "AlbCliT", ::nView ) )->nTotNet    := aTotAlb[1]
      ( D():Get( "AlbCliT", ::nView ) )->nTotIva    := aTotAlb[2]
      ( D():Get( "AlbCliT", ::nView ) )->nTotReq    := aTotAlb[3]
      ( D():Get( "AlbCliT", ::nView ) )->nTotAlb    := aTotAlb[4]
      ( D():Get( "AlbCliT", ::nView ) )->( dbUnLock() )
   end

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_GuardaAlbaranModa( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   local aTotAlb





   while ( D():Get( "AlbCliL", ::nView ) )->( dbSeek( ::cNumAlb ) ) .AND. !( D():Get( "AlbCliL", ::nView ) )->( eof() )
      if dbLock( D():Get( "AlbCliL", ::nView ) )
         ( D():Get( "AlbCliL", ::nView ) )->( dbDelete() )
         ( D():Get( "AlbCliL", ::nView ) )->( dbUnLock() )
      end
   end





   ( ::cTemporalLineaAlbaran )->( dbGoTop() )

   while !( ::cTemporalLineaAlbaran )->( eof() )




      appendRegisterByHash(::cTemporalLineaAlbaran, D():Get( "AlbCliL", ::nView ), {  "nIva" => 0, "nReq" => 0 } )

      ( ::cTemporalLineaAlbaran )->( dbSkip() )

   end









   aTotAlb  := aTotAlbCli( ::cNumAlb, D():Get( "AlbCliT", ::nView ), D():Get( "AlbCliL", ::nView ), D():Get( "TIva", ::nView ), D():Get( "Divisas", ::nView ) )

   if dbLock( D():Get( "AlbCliT", ::nView ) )
      ( D():Get( "AlbCliT", ::nView ) )->nTotNet    := aTotAlb[1]
      ( D():Get( "AlbCliT", ::nView ) )->nTotIva    := aTotAlb[2]
      ( D():Get( "AlbCliT", ::nView ) )->nTotReq    := aTotAlb[3]
      ( D():Get( "AlbCliT", ::nView ) )->nTotAlb    := aTotAlb[4]
      ( D():Get( "AlbCliT", ::nView ) )->( dbUnLock() )
   end

Return ( Self )




static FUNCTION TFacturarLineasAlbaranes_GeneraFactura( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   local aTotFac

   ::oDlg:Disable()

   CursorWait()





   ::nNumeroFactura     := nNewDoc( ::cSerieFactura, D():Get( "FacCliT", ::nView ), "NFACCLI", , D():Get( "NCount", ::nView ) )
   ::cSufijoFactura     := ( D():Get( "AlbCliT", ::nView ) )->cSufAlb

   ::cNumFac            := ::cSerieFactura + Str( ::nNumeroFactura ) + ::cSufijoFactura












   appendRegisterByHash(D():Get( "AlbCliT", ::nView ), D():Get( "FacCliT", ::nView ), {  "cSerie"    => ::cSerieFactura, "nNumFac"   => ::nNumeroFactura, "cSufFac"   => ::cSufijoFactura, "dFecFac"   => ::dFechaFactura, "cTurFac"   => cCurSesion(), "lCloFac"   => .F. } )





   ( ::cTemporalLineaFactura )->( dbGoTop() )

   while !( ::cTemporalLineaFactura )->( Eof() )







      appendRegisterByHash(::cTemporalLineaFactura, D():Get( "FacCliL", ::nView ), {  "cSerie"    => ::cSerieFactura, "nNumFac"   => ::nNumeroFactura, "cSufFac"   => ::cSufijoFactura, "dFecFac"   => ::dFechaFactura, "cCodAlb"   => ::cNumAlb } )

      ( ::cTemporalLineaFactura )->( dbSkip() )

   end











   aTotFac  := aTotFacCli( ::cSerieFactura + str( ::nNumeroFactura ) + ::cSufijoFactura, D():Get( "FacCliT", ::nView ), D():Get( "FacCliL", ::nView ), D():Get( "TIva", ::nView ), D():Get( "Divisas", ::nView ), D():Get( "FacCliP", ::nView ), D():Get( "AntCliT", ::nView ) )

   if dbLock( D():Get( "FacCliT", ::nView ) )
      ( D():Get( "FacCliT", ::nView ) )->nTotNet    := aTotFac[1]
      ( D():Get( "FacCliT", ::nView ) )->nTotIva    := aTotFac[2]
      ( D():Get( "FacCliT", ::nView ) )->nTotReq    := aTotFac[3]
      ( D():Get( "FacCliT", ::nView ) )->nTotFac    := aTotFac[4]
      ( D():Get( "FacCliT", ::nView ) )->( dbUnLock() )
   end














   GenPgoFacCli( ::cSerieFactura + Str( ::nNumeroFactura ) + ::cSufijoFactura, D():Get( "FacCliT", ::nView ), D():Get( "FacCliL", ::nView ), D():Get( "FacCliP", ::nView ), D():Get( "AntCliT", ::nView ), D():Get( "Client", ::nView ), D():Get( "FPago", ::nView ), D():Get( "Divisas", ::nView ), D():Get( "TIva", ::nView ), 1 )











   ChkLqdFacCli( nil, D():Get( "FacCliT", ::nView ), D():Get( "FacCliL", ::nView ), D():Get( "FacCliP", ::nView ), D():Get( "AntCliT", ::nView ), D():Get( "TIva", ::nView ), D():Get( "Divisas", ::nView ) )





   if ( "MODA" $ appParamsMain() )

      if dbLock( D():Get( "AlbCliT", ::nView ) )
         ( D():Get( "AlbCliT", ::nView ) )->lRecargo   := .F.
         ( D():Get( "AlbCliT", ::nView ) )->( dbUnLock() )
      end

   end

   CursorWe()

   ::oDlg:Enable()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_CalculaTotales( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   if ( "MODA" $ appParamsMain() )

      ::nSayNeto     := ::oColTotalAlbaran:nTotal + ::oColNetoFactura:nTotal

      ::nSayIva      := ::oColIVAFactura:nTotal

      ::nSayTotal    := ::oColTotalAlbaran:nTotal + ::oColTotalFactura:nTotal

      if ( D():Get( "AlbCliT", ::nView ) )->lRecargo
         ::nSayIva   += ::oColReqFactura:nTotal
         ::nSayTotal += ::oColReqFactura:nTotal
      end

   else

      ::nSayNeto  := ::oColNetoAlbaran:nTotal + ::oColNetoFactura:nTotal

      ::nSayIva   := ::oColIVAAlbaran:nTotal + ::oColIVAFactura:nTotal

      ::nSayTotal := ::oColTotalAlbaran:nTotal + ::oColTotalFactura:nTotal

      if ( D():Get( "AlbCliT", ::nView ) )->lRecargo
         ::nSayIva   += ::oColReqAlbaran:nTotal
         ::nSayIva   += ::oColReqFactura:nTotal
         ::nSayTotal += ::oColReqAlbaran:nTotal
         ::nSayTotal += ::oColReqFactura:nTotal
      end

   end





   if !Empty( ::oSayNeto )
      ::oSayNeto:Refresh()
   end

   if !Empty( ::oSayIva )
      ::oSayIva:Refresh()
   end

   if !Empty( ::oSayTotal )
      ::oSayTotal:Refresh()
   end

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_ChangePorcentajePropuestoAlbaran( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   ::oPorcentajePropuestoFactura:cText( 100 - ::nPorcentajePropuestoAlbaran )

   ::RefreshPorcentajePropuesto()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_ChangePorcentajePropuestoFactura( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   ::oPorcentajePropuestoAlbaran:cText( 100 - ::nPorcentajePropuestoFactura )

   ::RefreshPorcentajePropuesto()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_RecalculaPorcentajes( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   local nUnidadesCalculadas  := 0





   if ::nPorcentajePropuestoAlbaran == 100 .AND. ( ::cTemporalLineaFactura )->( OrdKeyCount() ) == 0
      Return .F.
   end

   ::ComprobacionesCalculoPorcentajes()





   while ::lPorcentajeAlcanzado()

      ::PasaUnidadAlbaran()

      ::SaltoRegistro()

   end





   ::ActualizaPantalla()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_ComprobacionesCalculoPorcentajes( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes





   if ( ::cTemporalLineaFactura )->( OrdKeyCount() ) <> 0





      ( ::cTemporalLineaAlbaran )->( __dbZap() )





      ::CargaTemporal()





      ( ::cTemporalLineaFactura )->( __dbZap() )

   end

   ( ::cTemporalLineaAlbaran )->( dbGoTop() )

Return ( Self )



static FUNCTION TFacturarLineasAlbaranes_SaltoRegistro( ) ; local Self AS CLASS TFacturarLineasAlbaranes := QSelf() AS CLASS TFacturarLineasAlbaranes

   ( ::cTemporalLineaAlbaran )->( dbSkip() )

   if ( ::cTemporalLineaAlbaran )->( Eof() )

      ( ::cTemporalLineaAlbaran )->( dbGoTop() )

   end

Return ( Self )
