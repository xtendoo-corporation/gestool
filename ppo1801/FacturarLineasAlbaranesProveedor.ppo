#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 18 ".\.\Prg\FacturarLineasAlbaranesProveedor.prg"
_HB_CLASS TFacturarLineasAlbaranesProveedor ; function TFacturarLineasAlbaranesProveedor ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFacturarLineasAlbaranesProveedor", iif( .T., { @DialogBuilder() }, { @HBObject() } ), @TFacturarLineasAlbaranesProveedor() ) ) ;

   _HB_MEMBER { cPath } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPath"}, .F. )

   _HB_MEMBER { lImported } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lImported"}, .F. )

   _HB_MEMBER { oProveedor } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oProveedor"}, .F. )
   _HB_MEMBER { oArticulo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oArticulo"}, .F. )
   _HB_MEMBER { oPeriodo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPeriodo"}, .F. )

   _HB_MEMBER { oPropiedad1 } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPropiedad1"}, .F. )
   _HB_MEMBER { oPropiedad2 } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPropiedad2"}, .F. )

   _HB_MEMBER { oBrwEntrada } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwEntrada"}, .F. )
   _HB_MEMBER { oBrwSalida } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwSalida"}, .F. )

   _HB_MEMBER { oBase } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBase"}, .F. )
   _HB_MEMBER { oIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oIva"}, .F. )
   _HB_MEMBER { oTotal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTotal"}, .F. )

   _HB_MEMBER { tmpEntrada } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"tmpEntrada"}, .F. )
   _HB_MEMBER { tmpSalida } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"tmpSalida"}, .F. )

   _HB_MEMBER { cSerieFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerieFactura"}, .F. )
   _HB_MEMBER { nNumeroFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumeroFactura"}, .F. )
   _HB_MEMBER { cSufijoFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijoFactura"}, .F. )

   _HB_MEMBER { aAlbaranesProcesados } ; oClass:AddMultiData(, {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aAlbaranesProcesados"}, .F. )

   _HB_MEMBER New( nView); oClass:AddMethod( "New", @TFacturarLineasAlbaranesProveedor_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource(); oClass:AddMethod( "Resource", @TFacturarLineasAlbaranesProveedor_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER validArticulo(); oClass:AddMethod( "validArticulo", @TFacturarLineasAlbaranesProveedor_validArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER startResource(); oClass:AddMethod( "startResource", @TFacturarLineasAlbaranesProveedor_startResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CreaTemporales(); oClass:AddMethod( "CreaTemporales", @TFacturarLineasAlbaranesProveedor_CreaTemporales(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CierraTemporales(); oClass:AddMethod( "CierraTemporales", @TFacturarLineasAlbaranesProveedor_CierraTemporales(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER loadAlbaranes(); oClass:AddMethod( "loadAlbaranes", @TFacturarLineasAlbaranesProveedor_loadAlbaranes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER loadAlbaran( id); oClass:AddMethod( "loadAlbaran", @TFacturarLineasAlbaranesProveedor_loadAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setIdFacturaProveedor(); oClass:AddMethod( "setIdFacturaProveedor", @TFacturarLineasAlbaranesProveedor_setIdFacturaProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getIdFacturaProveedor(); oClass:AddInline( "getIdFacturaProveedor", {|Self | ( ( Self ) ), ( ::cSerieFactura + str( ::nNumeroFactura ) + ::cSufijoFactura ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER saveAlbaran(); oClass:AddMethod( "saveAlbaran", @TFacturarLineasAlbaranesProveedor_saveAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER setLineasFacturadas(); oClass:AddMethod( "setLineasFacturadas", @TFacturarLineasAlbaranesProveedor_setLineasFacturadas(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER setLineaFacturada(); oClass:AddMethod( "setLineaFacturada", @TFacturarLineasAlbaranesProveedor_setLineaFacturada(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER setAlbaranesFacturados(); oClass:AddMethod( "setAlbaranesFacturados", @TFacturarLineasAlbaranesProveedor_setAlbaranesFacturados(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

      _HB_MEMBER addAlbaranFacturado(); oClass:AddInline( "addAlbaranFacturado", {|Self, id | ( ( Self ) ), (  iif(  aScan( ::aAlbaranesProcesados, id ) == 0, aAdd( ::aAlbaranesProcesados, id ), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER passLineas(); oClass:AddMethod( "passLineas", @TFacturarLineasAlbaranesProveedor_passLineas(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER passLinea(); oClass:AddMethod( "passLinea", @TFacturarLineasAlbaranesProveedor_passLinea(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lPassedLinea(); oClass:AddMethod( "lPassedLinea", @TFacturarLineasAlbaranesProveedor_lPassedLinea(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER deleteLineas(); oClass:AddInline( "deleteLineas", {|Self | ( ( Self ) ), ( ::oBrwSalida:SelectAll(), ::deleteLinea() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER deleteLinea(); oClass:AddInline( "deleteLinea", {|Self | ( ( Self ) ), ( dbdel( D():Tmp( "TmpPrvO", ::nView ) ), ::oBrwSalida:refresh(), ::oBrwEntrada:refresh() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER recalculaTotal(); oClass:AddMethod( "recalculaTotal", @TFacturarLineasAlbaranesProveedor_recalculaTotal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER genNuevaFacturaProveedor(); oClass:AddMethod( "genNuevaFacturaProveedor", @TFacturarLineasAlbaranesProveedor_genNuevaFacturaProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER genCabeceraFacturaProveedor(); oClass:AddMethod( "genCabeceraFacturaProveedor", @TFacturarLineasAlbaranesProveedor_genCabeceraFacturaProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
         _HB_MEMBER cargaProveedor(); oClass:AddMethod( "cargaProveedor", @TFacturarLineasAlbaranesProveedor_cargaProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER genLineasFacturaProveedor(); oClass:AddMethod( "genLineasFacturaProveedor", @TFacturarLineasAlbaranesProveedor_genLineasFacturaProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
         _HB_MEMBER insertLineaFacturaProveedor(); oClass:AddMethod( "insertLineaFacturaProveedor", @TFacturarLineasAlbaranesProveedor_insertLineaFacturaProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER guardaTotalesFacturaProveedor(); oClass:AddMethod( "guardaTotalesFacturaProveedor", @TFacturarLineasAlbaranesProveedor_guardaTotalesFacturaProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER genPagosFacturaProveedor(); oClass:AddMethod( "genPagosFacturaProveedor", @TFacturarLineasAlbaranesProveedor_genPagosFacturaProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSuAlb(); oClass:AddMethod( "getSuAlb", @TFacturarLineasAlbaranesProveedor_getSuAlb(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFacturarLineasAlbaranesProveedor ;



static FUNCTION TFacturarLineasAlbaranesProveedor_New( nView ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   ::nView           := nView



   if ::nView < 1
      msgStop( "La vista creada no es válida" )
      Return .F.
   end



   ::oProveedor      := GetProveedor():Build( { "idGet" => 130, "idSay" => 140, "oContainer" => Self } )

   ::oArticulo       := GetArticulo():Build( { "idGet" => 160, "idSay" => 161, "oContainer" => Self } )
   ::oArticulo:bValid:= {|| ::ValidArticulo() }

   ::oPropiedad1     := GetPropiedadActual():Build( { "idGet" => 170, "idSay" => 171, "oContainer" => Self } )

   ::oPropiedad2     := GetPropiedadActual():Build( { "idGet" => 180, "idSay" => 181, "oContainer" => Self } )

   ::oPeriodo        := GetPeriodo():Build( { "idCombo" => 100, "idFechaInicio" => 110, "idFechaFin" => 120, "oContainer" => Self } )

   ::oBase           := SayCompras():New( 400, Self )

   ::oIva            := SayCompras():New( 410, Self )

   ::oTotal          := SayCompras():New( 420, Self )



   ::CreaTemporales()



   ::Resource()



   ::CierraTemporales()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_CreaTemporales( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor












   D():BuildTmp(  "AlbProvL", "TmpPrvI", {  {  "tagName" => "nNumAlb" , "tagExpresion" => "cSerAlb + str( nNumAlb ) + cSufAlb + str( nNumLin )", "tagBlock" => {|| Field->cSerAlb + str( Field->nNumAlb ) + Field->cSufAlb + str( Field->nNumLin ) } }, {  "tagName" => "cSuAlb" , "tagExpresion" => "cSuAlb", "tagBlock" => {|| Field->cSuAlb } }, {  "tagName" => "cDetalle" , "tagExpresion" => "cDetalle", "tagBlock" => {|| Field->cDetalle } } }, ::nView )













   D():BuildTmp(  "AlbProvL", "TmpPrvO", {  {  "tagName" => "nNumAlb" , "tagExpresion" => "cSerAlb + str( nNumAlb ) + cSufAlb + str( nNumLin )", "tagBlock" => {|| Field->cSerAlb + str( Field->nNumAlb ) + Field->cSufAlb + str( Field->nNumLin ) } }, {  "tagName" => "cSuAlb" , "tagExpresion" => "cSuAlb", "tagBlock" => {|| Field->cSuAlb } }, {  "tagName" => "cDetalle" , "tagExpresion" => "cDetalle", "tagBlock" => {|| Field->cDetalle } } }, ::nView )

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_CierraTemporales( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   D():CloseTmp( "TmpPrvI", ::nView )

   D():CloseTmp( "TmpPrvO", ::nView )

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_Resource( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   ::oDlg = TDialog():New(,,,,, "FacturaLineasCompletasAlbaranes",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )

      aEval( ::aComponents, {| o | o:Resource(::oDlg) } )

      TBtnBmp():ReDefine( 150, "gc_recycle_16",,,,, {|| ::loadAlbaranes() }, ::oDlg, .F., , .F. )



      ::oBrwEntrada        := IXBrowse():New( ::oDlg )
      ::oBrwEntrada:cAlias := D():Tmp( "TmpPrvI", ::nView )
      ::oBrwEntrada:cName  := "Lineas de albaranes a proveedor entradas"

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Pasado"
         :nHeadBmpNo       := 1
         :bStrData         := {|| "" }
         :bEditValue       := {|| ::lPassedLinea() }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Albarán"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->cSerAlb + "/" + Alltrim( Str( ( D():Tmp( "TmpPrvI", ::nView ) )->nNumAlb ) ) }
         :nWidth           := 80
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Núm"
         :bEditValue       := {|| if( ( D():Tmp( "TmpPrvI", ::nView ) )->lKitChl, "", Trans( ( D():Tmp( "TmpPrvI", ::nView ) )->nNumLin, "9999" ) ) }
         :nWidth           := 40
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Código"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->cRef }
         :nWidth           := 80
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "C. Barras"
         :bEditValue       := {|| cCodigoBarrasDefecto( ( D():Tmp( "TmpPrvI", ::nView ) )->cRef, D():ArticulosCodigosBarras( ::nView ) ) }
         :nWidth           := 100
         :lHide            := .T.
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Código proveedor"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->cRefPrv }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Descripción"
         :cSortOrder       := "cDetalle"
         :bEditValue       := {|| if( Empty( ( D():Tmp( "TmpPrvI", ::nView ) )->cRef ) .AND. !Empty( ( D():Tmp( "TmpPrvI", ::nView ) )->mLngDes ), ( D():Tmp( "TmpPrvI", ::nView ) )->mLngDes, ( D():Tmp( "TmpPrvI", ::nView ) )->cDetalle ) }
         :nWidth           := 305
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | if( !empty( oCol ), oCol:SetOrder(), ) }
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Prop. 1"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->cValPr1 }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Prop. 2"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->cValPr2 }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Lote"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->cLote }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Caducidad"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->dFecCad }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Pedido cliente"
         :bEditValue       := {|| if( !Empty( ( D():Tmp( "TmpPrvI", ::nView ) )->cNumPed ), Trans( ( D():Tmp( "TmpPrvI", ::nView ) )->cNumPed, "@R #/#########/##" ), "" ) }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Cliente"
         :bEditValue       := {|| if( !Empty( (D():Tmp( "TmpPrvI", ::nView ))->cNumPed ), GetCliente( (D():Tmp( "TmpPrvI", ::nView ))->cNumPed ), "" ) }
         :nWidth           := 180
         :lHide            := .T.
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Su albarán"
         :cSortOrder       := "cSuAlb"
         :bEditValue       := {|| if( !Empty( (D():Tmp( "TmpPrvI", ::nView ))->cSuAlb ), (D():Tmp( "TmpPrvI", ::nView ))->cSuAlb , "" ) }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | if( !empty( oCol ), oCol:SetOrder(), ) }
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := cNombreUnidades()
         :bEditValue       := {|| nTotNAlbPrv( D():Tmp( "TmpPrvI", ::nView ) ) }
         :cEditPicture     := MasUnd()
         :nWidth           := 60
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFooterType      := 1
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "UM. Unidad de medición"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->cUnidad }
         :nWidth           := 25
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Almacen"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->cAlmLin }
         :nWidth           := 60
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotUAlbPrv( D():Tmp( "TmpPrvI", ::nView ), nDinDiv() ) }
         :cEditPicture     := cPinDiv()
         :nWidth           := 90
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "% Dto."
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->nDtoLin }
         :cEditPicture     := "@E 999.99"
         :nWidth           := 50
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "% Prm."
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->nDtoPrm }
         :cEditPicture     := "@E 999.99"
         :nWidth           := 40
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "% " + cImp()
         :bEditValue       := {|| ( D():Tmp( "TmpPrvI", ::nView ) )->nIva }
         :cEditPicture     := "@E 999.99"
         :nWidth           := 50
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwEntrada:AddCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| nTotLAlbPrv( D():Tmp( "TmpPrvI", ::nView ), nDinDiv(), nRouDiv() ) }
         :cEditPicture     := cPirDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFooterType      := 1
      end

      ::oBrwEntrada:bClrSel            := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwEntrada:bClrSelFocus       := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      ::oBrwEntrada:bLDblClick         := {|| ::passLineas(), ::recalculaTotal() }

      ::oBrwEntrada:nMarqueeStyle      := 6
      ::oBrwEntrada:lFooter            := .T.

      ::oBrwEntrada:CreateFromResource( 200 )



      ::oBrwSalida         := IXBrowse():New( ::oDlg )
      ::oBrwSalida:cAlias  := D():Tmp( "TmpPrvO", ::nView )
      ::oBrwSalida:cName   := "Lineas de albaranes a proveedor salidas"

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Albarán"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->cSerAlb + "/" + Alltrim( Str( ( D():Tmp( "TmpPrvO", ::nView ) )->nNumAlb ) ) }
         :nWidth           := 80
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Núm"
         :bEditValue       := {|| if( ( D():Tmp( "TmpPrvO", ::nView ) )->lKitChl, "", Trans( ( D():Tmp( "TmpPrvO", ::nView ) )->nNumLin, "9999" ) ) }
         :nWidth           := 40
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Código"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->cRef }
         :nWidth           := 80
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "C. Barras"
         :bEditValue       := {|| cCodigoBarrasDefecto( ( D():Tmp( "TmpPrvO", ::nView ) )->cRef, D():ArticulosCodigosBarras( ::nView ) ) }
         :nWidth           := 100
         :lHide            := .T.
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Código proveedor"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->cRefPrv }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Descripción"
         :cSortOrder       := "cDetalle"
         :bEditValue       := {|| if( Empty( ( D():Tmp( "TmpPrvO", ::nView ) )->cRef ) .AND. !Empty( ( D():Tmp( "TmpPrvO", ::nView ) )->mLngDes ), ( D():Tmp( "TmpPrvO", ::nView ) )->mLngDes, ( D():Tmp( "TmpPrvO", ::nView ) )->cDetalle ) }
         :nWidth           := 305
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | if( !empty( oCol ), oCol:SetOrder(), ) }
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Su albarán"
         :cSortOrder       := "cSuAlb"
         :bEditValue       := {|| if( !Empty( (D():Tmp( "TmpPrvO", ::nView ))->cSuAlb ),  (D():Tmp( "TmpPrvO", ::nView ))->cSuAlb , "" ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | if( !empty( oCol ), oCol:SetOrder(), ) }
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Prop. 1"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->cValPr1 }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Prop. 2"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->cValPr2 }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Lote"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->cLote }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Caducidad"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->dFecCad }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := cNombreUnidades()
         :bEditValue       := {|| nTotNAlbPrv( D():Tmp( "TmpPrvO", ::nView ) ) }
         :cEditPicture     := MasUnd()
         :nWidth           := 60
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFooterType      := 1
      end



      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "UM. Unidad de medición"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->cUnidad }
         :nWidth           := 25
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Almacen"
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->cAlmLin }
         :nWidth           := 60
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotUAlbPrv( D():Tmp( "TmpPrvO", ::nView ), nDinDiv() ) }
         :cEditPicture     := cPinDiv()
         :nWidth           := 90
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "% Dto."
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->nDtoLin }
         :cEditPicture     := "@E 999.99"
         :nWidth           := 50
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "% Prm."
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->nDtoPrm }
         :cEditPicture     := "@E 999.99"
         :nWidth           := 40
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "% " + cImp()
         :bEditValue       := {|| ( D():Tmp( "TmpPrvO", ::nView ) )->nIva }
         :cEditPicture     := "@E 999.99"
         :nWidth           := 50
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrwSalida:AddCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| nTotLAlbPrv( D():Tmp( "TmpPrvO", ::nView ), nDinDiv(), nRouDiv() ) }
         :cEditPicture     := cPirDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFooterType      := 1
      end

      ::oBrwSalida:bClrSel             := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwSalida:bClrSelFocus        := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oBrwSalida:nMarqueeStyle       := 6
      ::oBrwSalida:lFooter             := .T.

      ::oBrwSalida:CreateFromResource( 300 )






      TButton():ReDefine( 210, {||( ::passLineas( .T. ), ::recalculaTotal() )}, ::oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 220, {||( ::passLineas(), ::recalculaTotal() )}, ::oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 310, {||( ::deleteLinea(), ::recalculaTotal() )}, ::oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 320, {||( ::deleteLineas( .T. ), ::recalculaTotal() )}, ::oDlg,,, .F.,,,, .F. )






      TButton():ReDefine( 1, {||( ::saveAlbaran() )}, ::oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( ::oDlg:End() )}, ::oDlg,,, .F.,,,, .T. )

   ::oDlg:Activate( , , , .T., , , {|| ::StartResource() } )

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_getSuAlb( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

    local cSuAlb     := ""
    local nOrd
    local nNumAlb     := (D():Tmp( "TmpPrvI", ::nView ))->cSerAlb + str( (D():Tmp( "TmpPrvI", ::nView ))->nNumAlb ) + (D():Tmp( "TmpPrvI", ::nView ))->cSufAlb


    nOrd                    := ( D():AlbaranesProveedores( ::nView ) )->( OrdSetFocus( "nNumAlb" ) )


    if ( D():AlbaranesProveedores( ::nView ) )-> ( dbSeek( nNumAlb ) )
        cSuAlb     := ( D():AlbaranesProveedores( ::nView ) )->cSufAlb
       end

   (  D():AlbaranesProveedores( ::nView ) )->( OrdSetFocus( nOrd ) )

Return ( cSuAlb )



static FUNCTION TFacturarLineasAlbaranesProveedor_validArticulo( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   if cArticulo( ::oArticulo:oGetControl, D():Get( "Articulo", ::nView ), ::oArticulo:oSayControl )
      ::oPropiedad1:PropiedadActual( ( D():Articulos( ::nView ) )->cCodPrp1 )
      ::oPropiedad2:PropiedadActual( ( D():Articulos( ::nView ) )->cCodPrp2 )
   end

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_startResource( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   ::oBrwEntrada():load()

   ::oBrwSalida:Load()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_loadAlbaranes( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   local cCodigoProveedor     := ::oProveedor:Value()

   if empty( cCodigoProveedor )
      msgStop( "Debe cumplimentar un proveedor.")
      Return .F.
   end

   if ( D():Tmp( "TmpPrvI", ::nView ) )->( ordkeycount() ) > 0

      if !msgYesNo(  "Ya hay registros importados," + Chr(13)+Chr(10) +  "¿desea volver a importar las líneas de albaranes?" )
         Return .F.
      end
   end



   Cursorwait()

   ::lImported                := .F.

   ( D():Tmp( "TmpPrvI", ::nView ) )->( __dbzap() )

   D():GetStatus( "AlbProvT", ::nView )

   ( D():AlbaranesProveedores( ::nView ) )->( ordsetfocus( "cCodPrv" ) )

   if ( D():AlbaranesProveedores( ::nView ) )->( dbSeek( cCodigoProveedor ) )
      while ( D():AlbaranesProveedores( ::nView ) )->cCodPrv == cCodigoProveedor

         if ::oPeriodo:InRange( D():AlbaranesProveedoresFecha( ::nView ) )
            ::loadAlbaran( D():AlbaranesProveedoresId( ::nView ) )
         end

         ( D():AlbaranesProveedores( ::nView ) )->( dbskip() )

      end
   end

   D():SetStatus( "AlbProvT", ::nView )

   ( D():Tmp( "TmpPrvI", ::nView ) )->( dbgotop() )

   ::oBrwEntrada:refresh()

   Cursorwe()

   if !::lImported
      msgStop( "No hay líneas de albaranes en las condiciones solicitadas.")
   end

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_loadAlbaran( id ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   if ( D():AlbaranesProveedoresLineas( ::nView ) )->( dbSeek( id ) )

      while D():AlbaranesProveedoresLineasId( ::nView ) == id .AND. !( D():AlbaranesProveedoresLineas( ::nView ) )->( eof() )




         if !( D():AlbaranesProveedoresLineas( ::nView ) )->lFacturado                                                              .AND.  ( empty( ::oArticulo:Value() ) .OR. ( D():AlbaranesProveedoresLineas( ::nView ) )->cRef == ::oArticulo:Value() )        .AND.  ( empty( ::oPropiedad1:Value() ) .OR. ( D():AlbaranesProveedoresLineas( ::nView ) )->cValPr1 == ::oPropiedad1:Value() ) .AND.  ( empty( ::oPropiedad2:Value() ) .OR. ( D():AlbaranesProveedoresLineas( ::nView ) )->cValPr2 == ::oPropiedad2:Value() )

            dbPass( D():AlbaranesProveedoresLineas( ::nView ), D():Tmp( "TmpPrvI", ::nView ), .T. )

            ::lImported       := .T.

         end

         ( D():AlbaranesProveedoresLineas( ::nView ) )->( dbskip() )

      end

   end

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_passLineas( lSelectAll ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   local nRecno

   If( lSelectAll == nil, lSelectAll := .F., ) ;

   if lSelectAll
      ::oBrwEntrada:SelectAll()
   end

   Cursorwait()

   for each nRecno in ( ::oBrwEntrada:aSelected )

      ( ::oBrwEntrada:cAlias )->( dbgoto( nRecno ) )

      ::passLinea()

   next

   Cursorwe()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_passLinea( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   if ::lPassedLinea()

      msgStop( "Esta línea ya ha sido agregada a la factura.")
      Return ( Self )

   else

      dbpass( ::oBrwEntrada:cAlias, ::oBrwSalida:cAlias, .T. )

   end

   ::oBrwEntrada:refresh()
   ::oBrwSalida:refresh()

Return ( Self )



static FUNCTION TFacturarLineasAlbaranesProveedor_lPassedLinea( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   local nRecno
   local lPassedLinea   := .F.

   nRecno         := ( D():Tmp( "TmpPrvO", ::nView ) )->( recno() )

   lPassedLinea   := ( D():Tmp( "TmpPrvO", ::nView ) )->( dbSeek( ( D():Tmp( "TmpPrvI", ::nView ) )->cSerAlb + str( (  D():Tmp( "TmpPrvI", ::nView ) )->nNumAlb ) + (  D():Tmp( "TmpPrvI", ::nView ) )->cSufAlb + str( (  D():Tmp( "TmpPrvI", ::nView ) )->nNumLin ) ) )

   ( D():Tmp( "TmpPrvO", ::nView ) )->( dbgoto( nRecno ) )

Return ( lPassedLinea )



static FUNCTION TFacturarLineasAlbaranesProveedor_recalculaTotal( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   local nBase    := 0
   local nIva     := 0
   local nTotal   := 0

   D():GetStatusTmp( "TmpPrvO", ::nView )

   ( D():Tmp( "TmpPrvO", ::nView ) )->( dbgotop() )

   while ( !( D():Tmp( "TmpPrvO", ::nView ) )->( eof() ) )

      nBase       += nTotLAlbPrv( D():Tmp( "TmpPrvO", ::nView ), nDinDiv(), nRouDiv() )
      nIva        += nIvaLAlbPrv( D():Tmp( "TmpPrvO", ::nView ), nDinDiv(), nRouDiv() )

      ( D():Tmp( "TmpPrvO", ::nView ) )->( dbskip() )

   end

   nTotal         := nBase + nIva

   ::oBase:cText( nBase )
   ::oIva:cText( nIva )
   ::oTotal:cText( nTotal )

   D():SetStatusTmp( "TmpPrvO", ::nView )

Return ( .T. )



static FUNCTION TFacturarLineasAlbaranesProveedor_saveAlbaran( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   ::aAlbaranesProcesados  := {}



   if ( D():Tmp( "TmpPrvO", ::nView ) )->( ordkeycount() ) == 0
      MsgStop( "No se puede crear una factura sin lineas" )
      Return ( .T. )
   end



   ::genNuevaFacturaProveedor()



   ::setLineasFacturadas()



   ::setAlbaranesFacturados()



   ::oDlg:End()

Return ( .T. )



static FUNCTION TFacturarLineasAlbaranesProveedor_setLineasFacturadas( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   ( D():Tmp( "TmpPrvO", ::nView ) )->( dbgotop() )
   while ( !( D():Tmp( "TmpPrvO", ::nView ) )->( eof() ) )

      ::setLineaFacturada( ( D():Tmp( "TmpPrvO", ::nView ) )->cSerAlb + str( (  D():Tmp( "TmpPrvO", ::nView ) )->nNumAlb ) + (  D():Tmp( "TmpPrvO", ::nView ) )->cSufAlb + str( (  D():Tmp( "TmpPrvO", ::nView ) )->nNumLin ) )

      ::addAlbaranFacturado( ( D():Tmp( "TmpPrvO", ::nView ) )->cSerAlb + str( (  D():Tmp( "TmpPrvO", ::nView ) )->nNumAlb ) + (  D():Tmp( "TmpPrvO", ::nView ) )->cSufAlb )

      ( D():Tmp( "TmpPrvO", ::nView ) )->( dbskip() )

   end

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_setLineaFacturada( id ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   local ordSetFocus

   ordSetFocus    := ( D():AlbaranesProveedoresLineas( ::nView ) )->( ordsetfocus( "nNumLin" ) )

   if ( D():AlbaranesProveedoresLineas( ::nView ) )->( dbSeek( id ) )

      if D():Lock( "AlbProvL", ::nView )
         ( D():AlbaranesProveedoresLineas( ::nView ) )->cNumFac      := ::getIdFacturaProveedor()
         ( D():AlbaranesProveedoresLineas( ::nView ) )->lFacturado   := .T.
         D():UnLock( "AlbProvL", ::nView )
      end

   end

   ( D():AlbaranesProveedoresLineas( ::nView ) )->( ordsetfocus( ordSetFocus ) )

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_setAlbaranesFacturados( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   local id

   for each id in ::aAlbaranesProcesados
      setEstadoAlbaranProveedor( id, ::nView )
      RollBackAlbPrvFromFacPrv( id, ::nView )
   next

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_genNuevaFacturaProveedor( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   ::setIdFacturaProveedor()

   ::genCabeceraFacturaProveedor()

   ::genLineasFacturaProveedor()

   ::guardaTotalesFacturaProveedor()

   ::genPagosFacturaProveedor()

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_setIdFacturaProveedor( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   ::cSerieFactura         := "A"
   ::nNumeroFactura        := nNewDoc( ::cSerieFactura, D():FacturasProveedores( ::nView ), "nFacPrv", , D():Contadores( ::nView ) )
   ::cSufijoFactura        := retSufEmp()

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_genCabeceraFacturaProveedor( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   if ( D():FacturasProveedores( ::nView ) )->( dbappend( .T. ) )

      ( D():FacturasProveedores( ::nView ) )->cSerFac    := ::cSerieFactura
      ( D():FacturasProveedores( ::nView ) )->nNumFac    := ::nNumeroFactura
      ( D():FacturasProveedores( ::nView ) )->cSufFac    := ::cSufijoFactura
      ( D():FacturasProveedores( ::nView ) )->dFecFac    := getSysDate()
      ( D():FacturasProveedores( ::nView ) )->cTurFac    := cCurSesion()
      ( D():FacturasProveedores( ::nView ) )->cDivFac    := cDivEmp()
      ( D():FacturasProveedores( ::nView ) )->nVdvFac    := nChgDiv( cDivEmp(), D():Divisas( ::nView ) )
      ( D():FacturasProveedores( ::nView ) )->cCodAlm    := Application():codigoAlmacen()
      ( D():FacturasProveedores( ::nView ) )->cCodCaj    := Application():CodigoCaja()
      ( D():FacturasProveedores( ::nView ) )->cCodPro    := cProCnt()
      ( D():FacturasProveedores( ::nView ) )->cCodUsr    := Auth():Codigo()
      ( D():FacturasProveedores( ::nView ) )->cCodDlg    := Application():CodigoDelegacion()
      ( D():FacturasProveedores( ::nView ) )->cCodPrv    := ::oProveedor:Value()

      ::cargaProveedor()

      ( D():FacturasProveedores( ::nView ) )->( dbUnLock() )

   end

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_cargaProveedor( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   if ( D():Proveedores( ::nView ) )->( dbSeek( ( D():FacturasProveedores( ::nView ) )->cCodPrv ) )
      ( D():FacturasProveedores( ::nView ) )->cNomPrv    := ( D():Proveedores( ::nView ) )->Titulo
      ( D():FacturasProveedores( ::nView ) )->cDirPrv    := ( D():Proveedores( ::nView ) )->Domicilio
      ( D():FacturasProveedores( ::nView ) )->cPobPrv    := ( D():Proveedores( ::nView ) )->Poblacion
      ( D():FacturasProveedores( ::nView ) )->cProvProv  := ( D():Proveedores( ::nView ) )->Provincia
      ( D():FacturasProveedores( ::nView ) )->cPosPrv    := ( D():Proveedores( ::nView ) )->CodPostal
      ( D():FacturasProveedores( ::nView ) )->cDniPrv    := ( D():Proveedores( ::nView ) )->Nif
   end

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_genLineasFacturaProveedor( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   ( D():Tmp( "TmpPrvO", ::nView ) )->( dbgotop() )
   while ( !( D():Tmp( "TmpPrvO", ::nView ) )->( eof() ) )

      ::insertLineaFacturaProveedor()

      ( D():Tmp( "TmpPrvO", ::nView ) )->( dbskip() )

   end

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_insertLineaFacturaProveedor( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   local nNumeroLinea                                          := ( D():Tmp( "TmpPrvO", ::nView ) )->( Recno() )

   if ( D():FacturasProveedoresLineas( ::nView ) )->( dbappend( .T. ) )

      ( D():FacturasProveedoresLineas( ::nView ) )->cSerFac    := ::cSerieFactura
      ( D():FacturasProveedoresLineas( ::nView ) )->nNumFac    := ::nNumeroFactura
      ( D():FacturasProveedoresLineas( ::nView ) )->cSufFac    := ::cSufijoFactura
      ( D():FacturasProveedoresLineas( ::nView ) )->nNumLin    := nNumeroLinea
      ( D():FacturasProveedoresLineas( ::nView ) )->nPosPrint  := nNumeroLinea
      ( D():FacturasProveedoresLineas( ::nView ) )->cRef       := ( D():Tmp( "TmpPrvO", ::nView ) )->cRef
      ( D():FacturasProveedoresLineas( ::nView ) )->cDetalle   := ( D():Tmp( "TmpPrvO", ::nView ) )->cDetalle
      ( D():FacturasProveedoresLineas( ::nView ) )->mLngDes    := ( D():Tmp( "TmpPrvO", ::nView ) )->mLngDes
      ( D():FacturasProveedoresLineas( ::nView ) )->mNumSer    := ( D():Tmp( "TmpPrvO", ::nView ) )->mNumSer
      ( D():FacturasProveedoresLineas( ::nView ) )->nIva       := ( D():Tmp( "TmpPrvO", ::nView ) )->nIva
      ( D():FacturasProveedoresLineas( ::nView ) )->nReq       := ( D():Tmp( "TmpPrvO", ::nView ) )->nReq
      ( D():FacturasProveedoresLineas( ::nView ) )->nPreUnit   := ( D():Tmp( "TmpPrvO", ::nView ) )->nPreDiv
      ( D():FacturasProveedoresLineas( ::nView ) )->nPreCom    := ( D():Tmp( "TmpPrvO", ::nView ) )->nPreCom
      ( D():FacturasProveedoresLineas( ::nView ) )->nUniCaja   := ( D():Tmp( "TmpPrvO", ::nView ) )->nUniCaja
      ( D():FacturasProveedoresLineas( ::nView ) )->nCanEnt    := ( D():Tmp( "TmpPrvO", ::nView ) )->nCanEnt
      ( D():FacturasProveedoresLineas( ::nView ) )->nDtoLin    := ( D():Tmp( "TmpPrvO", ::nView ) )->nDtoLin
      ( D():FacturasProveedoresLineas( ::nView ) )->nDtoPrm    := ( D():Tmp( "TmpPrvO", ::nView ) )->nDtoPrm
      ( D():FacturasProveedoresLineas( ::nView ) )->nDtoRap    := ( D():Tmp( "TmpPrvO", ::nView ) )->nDtoRap
      ( D():FacturasProveedoresLineas( ::nView ) )->cAlmLin    := ( D():Tmp( "TmpPrvO", ::nView ) )->cAlmLin
      ( D():FacturasProveedoresLineas( ::nView ) )->nUndKit    := ( D():Tmp( "TmpPrvO", ::nView ) )->nUndKit
      ( D():FacturasProveedoresLineas( ::nView ) )->lKitChl    := ( D():Tmp( "TmpPrvO", ::nView ) )->lKitChl
      ( D():FacturasProveedoresLineas( ::nView ) )->lKitArt    := ( D():Tmp( "TmpPrvO", ::nView ) )->lKitArt
      ( D():FacturasProveedoresLineas( ::nView ) )->lKitPrc    := ( D():Tmp( "TmpPrvO", ::nView ) )->lKitPrc
      ( D():FacturasProveedoresLineas( ::nView ) )->lIvaLin    := ( D():Tmp( "TmpPrvO", ::nView ) )->lIvaLin
      ( D():FacturasProveedoresLineas( ::nView ) )->cCodPr1    := ( D():Tmp( "TmpPrvO", ::nView ) )->cCodPr1
      ( D():FacturasProveedoresLineas( ::nView ) )->cCodPr2    := ( D():Tmp( "TmpPrvO", ::nView ) )->cCodPr2
      ( D():FacturasProveedoresLineas( ::nView ) )->cValPr1    := ( D():Tmp( "TmpPrvO", ::nView ) )->cValPr1
      ( D():FacturasProveedoresLineas( ::nView ) )->cValPr2    := ( D():Tmp( "TmpPrvO", ::nView ) )->cValPr2
      ( D():FacturasProveedoresLineas( ::nView ) )->nBnfLin1   := ( D():Tmp( "TmpPrvO", ::nView ) )->nBnfLin1
      ( D():FacturasProveedoresLineas( ::nView ) )->nBnfLin2   := ( D():Tmp( "TmpPrvO", ::nView ) )->nBnfLin2
      ( D():FacturasProveedoresLineas( ::nView ) )->nBnfLin3   := ( D():Tmp( "TmpPrvO", ::nView ) )->nBnfLin3
      ( D():FacturasProveedoresLineas( ::nView ) )->nBnfLin4   := ( D():Tmp( "TmpPrvO", ::nView ) )->nBnfLin4
      ( D():FacturasProveedoresLineas( ::nView ) )->nBnfLin5   := ( D():Tmp( "TmpPrvO", ::nView ) )->nBnfLin5
      ( D():FacturasProveedoresLineas( ::nView ) )->nBnfLin6   := ( D():Tmp( "TmpPrvO", ::nView ) )->nBnfLin6
      ( D():FacturasProveedoresLineas( ::nView ) )->lBnfLin1   := ( D():Tmp( "TmpPrvO", ::nView ) )->lBnfLin1
      ( D():FacturasProveedoresLineas( ::nView ) )->lBnfLin2   := ( D():Tmp( "TmpPrvO", ::nView ) )->lBnfLin2
      ( D():FacturasProveedoresLineas( ::nView ) )->lBnfLin3   := ( D():Tmp( "TmpPrvO", ::nView ) )->lBnfLin3
      ( D():FacturasProveedoresLineas( ::nView ) )->lBnfLin4   := ( D():Tmp( "TmpPrvO", ::nView ) )->lBnfLin4
      ( D():FacturasProveedoresLineas( ::nView ) )->lBnfLin5   := ( D():Tmp( "TmpPrvO", ::nView ) )->lBnfLin5
      ( D():FacturasProveedoresLineas( ::nView ) )->lBnfLin6   := ( D():Tmp( "TmpPrvO", ::nView ) )->lBnfLin6
      ( D():FacturasProveedoresLineas( ::nView ) )->nPvpLin1   := ( D():Tmp( "TmpPrvO", ::nView ) )->nPvpLin1
      ( D():FacturasProveedoresLineas( ::nView ) )->nPvpLin2   := ( D():Tmp( "TmpPrvO", ::nView ) )->nPvpLin2
      ( D():FacturasProveedoresLineas( ::nView ) )->nPvpLin3   := ( D():Tmp( "TmpPrvO", ::nView ) )->nPvpLin3
      ( D():FacturasProveedoresLineas( ::nView ) )->nPvpLin4   := ( D():Tmp( "TmpPrvO", ::nView ) )->nPvpLin4
      ( D():FacturasProveedoresLineas( ::nView ) )->nPvpLin5   := ( D():Tmp( "TmpPrvO", ::nView ) )->nPvpLin5
      ( D():FacturasProveedoresLineas( ::nView ) )->nPvpLin6   := ( D():Tmp( "TmpPrvO", ::nView ) )->nPvpLin6
      ( D():FacturasProveedoresLineas( ::nView ) )->nIvaLin1   := ( D():Tmp( "TmpPrvO", ::nView ) )->nIvaLin1
      ( D():FacturasProveedoresLineas( ::nView ) )->nIvaLin2   := ( D():Tmp( "TmpPrvO", ::nView ) )->nIvaLin2
      ( D():FacturasProveedoresLineas( ::nView ) )->nIvaLin3   := ( D():Tmp( "TmpPrvO", ::nView ) )->nIvaLin3
      ( D():FacturasProveedoresLineas( ::nView ) )->nIvaLin4   := ( D():Tmp( "TmpPrvO", ::nView ) )->nIvaLin4
      ( D():FacturasProveedoresLineas( ::nView ) )->nIvaLin5   := ( D():Tmp( "TmpPrvO", ::nView ) )->nIvaLin5
      ( D():FacturasProveedoresLineas( ::nView ) )->nIvaLin6   := ( D():Tmp( "TmpPrvO", ::nView ) )->nIvaLin6
      ( D():FacturasProveedoresLineas( ::nView ) )->lLote      := ( D():Tmp( "TmpPrvO", ::nView ) )->lLote
      ( D():FacturasProveedoresLineas( ::nView ) )->nLote      := ( D():Tmp( "TmpPrvO", ::nView ) )->nLote
      ( D():FacturasProveedoresLineas( ::nView ) )->cLote      := ( D():Tmp( "TmpPrvO", ::nView ) )->cLote
      ( D():FacturasProveedoresLineas( ::nView ) )->mObsLin    := ( D():Tmp( "TmpPrvO", ::nView ) )->mObsLin
      ( D():FacturasProveedoresLineas( ::nView ) )->cRefPrv    := ( D():Tmp( "TmpPrvO", ::nView ) )->cRefPrv
      ( D():FacturasProveedoresLineas( ::nView ) )->cUnidad    := ( D():Tmp( "TmpPrvO", ::nView ) )->cUnidad
      ( D():FacturasProveedoresLineas( ::nView ) )->nNumMed    := ( D():Tmp( "TmpPrvO", ::nView ) )->nNumMed
      ( D():FacturasProveedoresLineas( ::nView ) )->nMedUno    := ( D():Tmp( "TmpPrvO", ::nView ) )->nMedUno
      ( D():FacturasProveedoresLineas( ::nView ) )->nMedDos    := ( D():Tmp( "TmpPrvO", ::nView ) )->nMedDos
      ( D():FacturasProveedoresLineas( ::nView ) )->nMedTre    := ( D():Tmp( "TmpPrvO", ::nView ) )->nMedTre
      ( D():FacturasProveedoresLineas( ::nView ) )->dFecCad    := ( D():Tmp( "TmpPrvO", ::nView ) )->dFecCad
      ( D():FacturasProveedoresLineas( ::nView ) )->nBultos    := ( D():Tmp( "TmpPrvO", ::nView ) )->nBultos
      ( D():FacturasProveedoresLineas( ::nView ) )->cFormato   := ( D():Tmp( "TmpPrvO", ::nView ) )->cFormato
      ( D():FacturasProveedoresLineas( ::nView ) )->iNumAlb    := ( D():Tmp( "TmpPrvO", ::nView ) )->cSerAlb + str( ( D():Tmp( "TmpPrvO", ::nView ) )->nNumAlb, 9 ) + ( D():Tmp( "TmpPrvO", ::nView ) )->cSufAlb + str( ( D():Tmp( "TmpPrvO", ::nView ) )->nNumLin, 4 )
      ( D():FacturasProveedoresLineas( ::nView ) )->cAlmOrigen := ( D():Tmp( "TmpPrvO", ::nView ) )->cAlmOrigen

      ( D():FacturasProveedoresLineas( ::nView ) )->( dbUnLock() )

   end

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_guardaTotalesFacturaProveedor( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   local structTotal    := structTotalFacturaProveedoresVista( ::getIdFacturaProveedor(), ::nView )

   if ( D():FacturasProveedores( ::nView ) )->( dbseek( ::getIdFacturaProveedor() ) ) .AND. ( D():FacturasProveedores( ::nView ) )->( dbrlock() )

      ( D():FacturasProveedores( ::nView ) )->nTotNet  := structTotal:nTotalNeto
      ( D():FacturasProveedores( ::nView ) )->nTotSup  := structTotal:nTotalSuplidos
      ( D():FacturasProveedores( ::nView ) )->nTotIva  := structTotal:nTotalIva
      ( D():FacturasProveedores( ::nView ) )->nTotReq  := structTotal:nTotalRecargoEquivalencia
      ( D():FacturasProveedores( ::nView ) )->nTotFac  := structTotal:nTotalDocumento

      ( D():FacturasProveedores( ::nView ) )->( dbunlock() )

   end

Return ( nil )



static FUNCTION TFacturarLineasAlbaranesProveedor_genPagosFacturaProveedor( ) ; local Self AS CLASS TFacturarLineasAlbaranesProveedor := QSelf() AS CLASS TFacturarLineasAlbaranesProveedor

   genPgoFacPrv( ::getIdFacturaProveedor(), D():FacturasProveedores( ::nView ), D():FacturasProveedoresLineas( ::nView ), D():FacturasProveedoresPagos( ::nView ), D():Proveedores( ::nView ), D():TiposIva( ::nView ), D():FormasPago( ::nView ), D():Divisas( ::nView ) )

Return ( nil )
