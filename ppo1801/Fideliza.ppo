#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 8 ".\.\Prg\Fideliza.prg"
Function StartTFideliza()

   local oFideliza

   oFideliza      := TFideliza():New( cPatEmp(), cDriver(), oWnd(), "programa_de_fidelizacion" )

   if !Empty( oFideliza )
      oFideliza:Activate()
   end

Return nil



_HB_CLASS TFideliza ; function TFideliza ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFideliza", iif( .T., { @TMasDet() }, { @HBObject() } ), @TFideliza() ) ) ;

   _HB_MEMBER { cMru } ; oClass:AddMultiData(, "gc_id_card_16", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cMru"}, .F. )
   _HB_MEMBER { cBitmap } ; oClass:AddMultiData(, ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cBitmap"}, .F. )
   _HB_MEMBER { aData } ; oClass:AddMultiData(, {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aData"}, .F. )

   _HB_MEMBER { oDetFideliza } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDetFideliza"}, .F. )

   _HB_MEMBER { oImageList } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oImageList"}, .F. )

   _HB_MEMBER { oTreeRango } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTreeRango"}, .F. )
   _HB_MEMBER { oBrwRango } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwRango"}, .F. )

   _HB_MEMBER { oDbfFam } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfFam"}, .F. )
   _HB_MEMBER { oDbfTip } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfTip"}, .F. )
   _HB_MEMBER { oDbfCat } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfCat"}, .F. )
   _HB_MEMBER { oDbfFab } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfFab"}, .F. )
   _HB_MEMBER { oDbfTem } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfTem"}, .F. )

   _HB_MEMBER { oChk } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oChk"}, .F. )
   _HB_MEMBER { lAll } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lAll"}, .F. )

   _HB_MEMBER { oBtnSelectAll } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnSelectAll"}, .F. )
   _HB_MEMBER { oBtnSelectNone } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnSelectNone"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @TFideliza_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CreateInit( cPath); oClass:AddMethod( "CreateInit", @TFideliza_CreateInit(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER Create( cPath); oClass:AddMethod( "Create", @TFideliza_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles( lExclusive); oClass:AddMethod( "OpenFiles", @TFideliza_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER OpenService( lExclusive); oClass:AddMethod( "OpenService", @TFideliza_OpenService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TFideliza_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TFideliza_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode); oClass:AddMethod( "Resource", @TFideliza_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lPreSave( oGet, nMode); oClass:AddMethod( "lPreSave", @TFideliza_lPreSave(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitResource(); oClass:AddMethod( "InitResource", @TFideliza_InitResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER TreeChanged(); oClass:AddMethod( "TreeChanged", @TFideliza_TreeChanged(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER TreeLostFocus() ; oClass:AddVirtual( "TreeLostFocus" )

   _HB_MEMBER BrowseDblClick(); oClass:AddMethod( "BrowseDblClick", @TFideliza_BrowseDblClick(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ChkChanged(); oClass:AddMethod( "ChkChanged", @TFideliza_ChkChanged(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadFamilia(); oClass:AddMethod( "LoadFamilia", @TFideliza_LoadFamilia(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadTipo(); oClass:AddMethod( "LoadTipo", @TFideliza_LoadTipo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadFabricante(); oClass:AddMethod( "LoadFabricante", @TFideliza_LoadFabricante(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadTemporada(); oClass:AddMethod( "LoadTemporada", @TFideliza_LoadTemporada(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SelectedToMemo(); oClass:AddMethod( "SelectedToMemo", @TFideliza_SelectedToMemo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InPrograma( cCodigoArticulo, dFechaVenta, dbfArticulo); oClass:AddMethod( "InPrograma", @TFideliza_InPrograma(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nPorcentajePrograma( nImporte); oClass:AddMethod( "nPorcentajePrograma", @TFideliza_nPorcentajePrograma(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFideliza ;



static FUNCTION TFideliza_New( cPath, cDriver, oWndParent, oMenuItem ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;

   ::cDriver            := cDriver

   if oMenuItem <> nil .AND. ::nLevel == nil
      ::nLevel          := Auth():Level( oMenuItem )
   else
      ::nLevel          := 1
   end

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return nil
   end

   ::cPath              := cPath
   ::oWndParent         := oWndParent

   ::bFirstKey          := {|| ::oDbf:cCodigo }

   ::oDetFideliza       := TDetFideliza():New( cPath, cDriver, Self )
   ::AddDetail( ::oDetFideliza )

RETURN ( Self )



static FUNCTION TFideliza_CreateInit( cPath, cDriver ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   ::cPath              := cPath
   ::cDriver            := cDriver

   ::bFirstKey          := {|| ::oDbf:cCodigo }

   ::oDetFideliza       := TDetFideliza():New( cPath, cDriver, Self )
   ::addDetail( ::oDetFideliza )

RETURN ( Self )



static FUNCTION TFideliza_Create( cPath, cDriver ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   ::cPath              := cPath
   ::cDriver            := cDriver

   ::oDbf               := nil

RETURN ( Self )



static FUNCTION TFideliza_OpenFiles( lExclusive ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local lOpen          := .T.
   local oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   If( lExclusive == nil, lExclusive := .F., ) ;

   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

      ::OpenDetails()

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos de programas de fidelizaciones" )

      ::CloseFiles()

      lOpen             := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TFideliza_OpenService( lExclusive, cPath ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local lOpen          := .T.
   local oBlock

   If( lExclusive == nil, lExclusive := .F., ) ;
   If( cPath == nil, cPath := ::cPath, ) ;

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::DefineFiles( cPath )
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

   RECOVER

      lOpen             := .F.

      ::CloseFiles()

      msgStop( "Imposible abrir todas las bases de datos de programas de fidelizaciones" )

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TFideliza_CloseFiles( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
      ::oDbf      := nil
   end

   ::CloseDetails()

   if ::oDbfFam <> nil .AND. ::oDbfFam:Used()
      ::oDbfFam:End()
   end

   if ::oDbfTip <> nil .AND. ::oDbfTip:Used()
      ::oDbfTip:End()
   end

   if ::oDbfCat <> nil .AND. ::oDbfCat:Used()
      ::oDbfCat:End()
   end

   if ::oDbfFab <> nil .AND. ::oDbfFab:Used()
      ::oDbfFab:End()
   end

   if ::oDbfTem <> nil .AND. ::oDbfTem:Used()
      ::oDbfTem:End()
   end

RETURN .T.



static FUNCTION TFideliza_DefineFiles( cPath, cDriver ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   If( cPath == nil, cPath := ::cPath, ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   ::oDbf := DbfServer( "Fideliza.Dbf", "Fideliza" ):New( "Fideliza.Dbf", "Fideliza", ( cDriver ), "Fidelización", ( cPath ) )

      ::oDbf:AddField( "cCodigo", "C", 03, 0,,,,, "Código", .F., 60, .F., {} )
      ::oDbf:AddField( "cDescrip", "C", 35, 0,,,,, "Nombre", .F., 400, .F., {} )
      ::oDbf:AddField( "dInicio", "D", 08, 0,,,,, "Inicio", .F., 80, .F., {} )
      ::oDbf:AddField( "dFin", "D", 08, 0,,,,, "Fin", .F., 80, .F., {} )
      ::oDbf:AddField( "mFamilia", "M", 10, 0,,,,, "Familia", .F.,, .T., {} )
      ::oDbf:AddField( "mTipo", "M", 10, 0,,,,, "Tipo", .F.,, .T., {} )
      ::oDbf:AddField( "mFabricant", "M", 10, 0,,,,, "Fabricante", .F.,, .T., {} )
      ::oDbf:AddField( "mTemporada", "M", 10, 0,,,,, "Temporada", .F.,, .T., {} )
      ::oDbf:AddField( "lFamilia", "L", 01, 0,,,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "lTipo", "L", 01, 0,,,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "lFabricant", "L", 01, 0,,,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "lTemporada", "L", 01, 0,,,,, "", .F.,, .T., {} )

      ::oDbf:AddIndex( "cCodigo", "Fideliza.Cdx", "cCodigo",,, .F., .F., "Código",,, .T., .F. )
      ::oDbf:AddIndex( "cDescrip", "Fideliza.Cdx", "cDescrip",,, .F., .F., "Nombre",,, .T., .F. )



RETURN ( ::oDbf )



static FUNCTION TFideliza_Resource( nMode ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

    local oDlg
   local oGet
   local oBrwLineas
   local oGetSec
   local oGetHor
   local oBmpGeneral

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "programa de fidelización", "Fideliza",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_id_card_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )






      oGet := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:cCodigo, ::oDbf:cCodigo:= u ) }, oDlg,, "@!", {||    NotValid( oGet, ::oDbf:cAlias, .T., "0" )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbf:cDescrip, ::oDbf:cDescrip:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbf:dInicio, ::oDbf:dInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::oDbf:dFin, ::oDbf:dFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      ::oImageList                  := TImageList():New( 16, 16 )

      ::oTreeRango                  := TTreeView():Redefine( 300, oDlg )
      ::oTreeRango:bChanged         := {|| ::TreeChanged() }
      ::oTreeRango:bLostFocus       := {|| ::TreeLostFocus() }





      ::oBrwRango                   := IXBrowse():New( oDlg )

      ::oBrwRango:bClrSel           := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwRango:bClrSelFocus      := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oBrwRango:SetArray( ::aData, , , .F. )

      ::oBrwRango:lHScroll          := .F.
      ::oBrwRango:lVScroll          := .F.
      ::oBrwRango:nMarqueeStyle     := 5
      ::oBrwRango:lRecordSelector   := .T.

      ::oBrwRango:bLDblClick        := {|| ::BrowseDblClick() }

      ::oBrwRango:CreateFromResource( 310 )

      with object ( ::oBrwRango:AddCol() )
         :cHeader       := "Sel."
         :bEditValue    := {|| ::aData[ ::oBrwRango:nArrayAt, 1 ] }
         :nWidth        := 25
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( ::oBrwRango:AddCol() )
         :cHeader       := "Código"
         :bEditValue    := {|| ::aData[ ::oBrwRango:nArrayAt, 2 ] }
         :nWidth        := 100
      end

      with object ( ::oBrwRango:AddCol() )
         :cHeader       := "Nombre"
         :bEditValue    := {|| ::aData[ ::oBrwRango:nArrayAt, 3 ] }
         :nWidth        := 300
      end





      ::oBtnSelectAll := TButton():ReDefine( 320, {||( ::BrowseDblClick( .T. ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





      ::oBtnSelectNone := TButton():ReDefine( 330, {||( ::BrowseDblClick( .F. ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )






      ::oChk := TCheckBox():ReDefine( 340, { | u | If( PCount()==0, ::lAll, ::lAll:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )
      ::oChk:bChange := {|| ::ChkChanged() }









        TButton():ReDefine( 500, {||( ::oDetFideliza:Append( oBrwLineas ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 501, {||( ::oDetFideliza:Edit( oBrwLineas ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 502, {||( ::oDetFideliza:Zoom() )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 503, {||( ::oDetFideliza:Del( oBrwLineas ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )

      oBrwLineas                    := IXBrowse():New( oDlg )

      oBrwLineas:bClrSel            := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLineas:bClrSelFocus       := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oDetFideliza:oDbfVir:SetBrowse( oBrwLineas )

      oBrwLineas:nMarqueeStyle      := 5

      oBrwLineas:bLDblClick         := { || ::oDetFideliza:Edit( oBrwLineas ) }

      oBrwLineas:CreateFromResource( 200 )

      with object ( oBrwLineas:AddCol() )
         :cHeader                   := "Naturaleza"
         :bStrData                  := {|| if( ::oDetFideliza:oDbfVir:nImpUni == 1, "Importe > " + Alltrim( Trans( ::oDetFideliza:oDbfVir:nImporte, cPouDiv() ) ), "Unidades > " + Alltrim( Trans( ::oDetFideliza:oDbfVir:nUnidades, MasUnd() ) ) ) }
         :nWidth                    := 580
      end

      with object ( oBrwLineas:AddCol() )
         :cHeader                   := "% Descuento"
         :bStrData                  := {|| ::oDetFideliza:oDbfVir:nPorcen }
         :cEditPicture              := "@E 999.99"
         :nWidth                    := 130
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
      end





      TButton():ReDefine( 1, {||( if( ::lPreSave( oGet, nMode ), oDlg:end( 1 ), ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )





      TButton():ReDefine( 559, {||( MsgInfo( "Ayuda no definida" ) )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3
         oDlg:AddFastKey( 113, {|| ::oDetFideliza:Append( oBrwLineas ) } )
         oDlg:AddFastKey( 114, {|| ::oDetFideliza:Edit( oBrwLineas ) } )
         oDlg:AddFastKey( 115, {|| ::oDetFideliza:Del( oBrwLineas ) } )
         oDlg:AddFastKey( 116, {|| if( ::lPreSave( oGet, nMode ), oDlg:end( 1 ), ) } )
      end

      oDlg:bStart := {|| ::InitResource() }

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oBmpGeneral:End()

RETURN ( oDlg:nResult == 1 )



static FUNCTION TFideliza_lPreSave( oGet, nMode ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   if nMode == 1 .OR. nMode == 4

      if Empty( ::oDbf:cCodigo )
         MsgStop( "Código del programa no puede estar vacío." )
         return .F.
      end

      if ::oDbf:SeekInOrd( ::oDbf:cCodigo, "cCodigo" )
         msgStop( "Código del programa ya existe." )
         return .F.
      end

   end

   if Empty( ::oDbf:cDescrip )
      MsgStop( "La descripción del programa no puede estar vacio." )
      return .F.
   end

RETURN .T.



static FUNCTION TFideliza_InitResource( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   ::oTreeRango:Add( "Familias",    0 )
   ::oTreeRango:Add( "Tipos",       1 )
   ::oTreeRango:Add( "Fabricantes", 2 )
   ::oTreeRango:Add( getConfigTraslation( "Temporadas" ),  4 )

   ::oImageList:AddMasked( TBitmap():Define( "gc_cubes_16" ), ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_objects_16" ), ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_photographic_filters_16" ), ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_bolt_16" ), ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_cloud_sun_16" ), ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )

   ::oTreeRango:SetImagelist( ::oImageList )

   ::LoadFamilia()

   ::ChkChanged()

RETURN ( Self )



static FUNCTION TFideliza_TreeChanged( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local oItemSelect := ::oTreeRango:GetSelected()

   if oItemSelect <> nil .AND. oItemSelect:ClassName() == "TTVITEM"

      ::aData        := {}

      do case
         case oItemSelect:cPrompt == "Familias"
            ::LoadFamilia()
         case oItemSelect:cPrompt == "Tipos"
            ::LoadTipo()
         case oItemSelect:cPrompt == "Fabricantes"
            ::LoadFabricante()
         case oItemSelect:cPrompt == getConfigTraslation( "Temporadas" )
            ::LoadTemporada()
      end

      if !Empty( ::oBrwRango )
         ::oBrwRango:aArrayData  := ::aData
         ::oBrwRango:GoTop()
         ::oBrwRango:Refresh()
      end

   end

Return ( self )



static FUNCTION TFideliza_BrowseDblClick( lAllSelected ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local oItemSelect
   local cItemSelect             := "Familias"

   if !Empty( ::aData )

      oItemSelect                := ::oTreeRango:GetSelected()

      if oItemSelect <> nil .AND. oItemSelect:ClassName() == "TTVITEM"
         cItemSelect             := oItemSelect:cPrompt
      end

      do case
         case IsNil( lAllSelected )

            ::aData[ ::oBrwRango:nArrayAt, 1 ]  := !::aData[ ::oBrwRango:nArrayAt, 1 ]

         case IsTrue( lAllSelected )

            aEval( ::aData, {|a| a[ 1 ] := .T. } )

         case IsFalse( lAllSelected )

            aEval( ::aData, {|a| a[ 1 ] := .F. } )

      end

      do case
         case cItemSelect == "Familias"
            ::oDbf:mFamilia      := ::SelectedToMemo()
         case cItemSelect == "Tipos"
            ::oDbf:mTipo         := ::SelectedToMemo()
         case cItemSelect == "Fabricantes"
            ::oDbf:mFabricant    := ::SelectedToMemo()
         case cItemSelect == getConfigTraslation( "Temporadas" )
            ::oDbf:mTemporada    := ::SelectedToMemo()
      end

   end

   if !Empty( ::oBrwRango )
      ::oBrwRango:Refresh()
   end

Return ( self )



static FUNCTION TFideliza_ChkChanged( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local oItemSelect
   local cItemSelect             := "Familias"

   if !Empty( ::aData )

      oItemSelect                := ::oTreeRango:GetSelected()

      if oItemSelect <> nil .AND. oItemSelect:ClassName() == "TTVITEM"
         cItemSelect             := oItemSelect:cPrompt
      end

      do case
         case cItemSelect == "Familias"
            ::oDbf:lFamilia      := ::lAll
         case cItemSelect == "Tipos"
            ::oDbf:lTipo         := ::lAll
         case cItemSelect == "Fabricantes"
            ::oDbf:lFabricant    := ::lAll
         case cItemSelect == getConfigTraslation( "Temporadas" )
            ::oDbf:lTemporada    := ::lAll
      end

      if ::lAll
         ::oBrwRango:Hide()
         ::oBtnSelectAll:Hide()
         ::oBtnSelectNone:Hide()
      else
         ::oBrwRango:Show()
         ::oBtnSelectAll:Show()
         ::oBtnSelectNone:Show()
      end

   end

Return ( self )



static FUNCTION TFideliza_LoadFamilia( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local aFamilia := hb_ATokens( Alltrim( ::oDbf:mFamilia ), "," )

   if ::oDbfFam == nil .OR. !::oDbfFam:Used()
      ::oDbfFam := DbfServer( "FAMILIAS.DBF", ):NewOpen( "FAMILIAS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfFam:AddBag( "FAMILIAS.CDX" ) ; ::oDbfFam:AddBag( ) ; ::oDbfFam:AutoIndex()
   end

   ::oDbfFam:GoTop()
   while ! ::oDbfFam:Eof()
      aAdd( ::aData, { aScan( aFamilia, Alltrim( ::oDbfFam:cCodFam ) ) <> 0, ::oDbfFam:cCodFam, ::oDbfFam:cNomFam } )
      ::oDbfFam:Skip()
   end

   if !Empty( ::oChk )
      ::oChk:Click( ::oDbf:lFamilia )
   end

Return ( Self )



static FUNCTION TFideliza_LoadTipo( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local aTipo := hb_ATokens( Alltrim( ::oDbf:mTipo ) )

   if ::oDbfTip == nil .OR. !::oDbfTip:Used()
      ::oDbfTip := DbfServer( "TipArt.Dbf", ):NewOpen( "TipArt.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfTip:AddBag( "TipArt.Cdx" ) ; ::oDbfTip:AddBag( ) ; ::oDbfTip:AutoIndex()
   end

   ::oDbfTip:GoTop()
   while ! ::oDbfTip:Eof()
      aAdd( ::aData, { aScan( aTipo, Alltrim( ::oDbfTip:cCodTip ) ) <> 0, ::oDbfTip:cCodTip, ::oDbfTip:cNomTip } )
      ::oDbfTip:Skip()
   end

   ::oChk:Click( ::oDbf:lTipo )

Return ( Self )



static FUNCTION TFideliza_LoadFabricante( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local aFabricante := hb_ATokens( Alltrim( ::oDbf:mFabricant ) )

   if ::oDbfFab == nil .OR. !::oDbfFab:Used()
      ::oDbfFab := DbfServer( "Fabric.Dbf", ):NewOpen( "Fabric.Dbf", "FABRIC", ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfFab:AddBag( "Fabric.Cdx" ) ; ::oDbfFab:AddBag( ) ; ::oDbfFab:AutoIndex()
   end

   ::oDbfFab:GoTop()
   while ! ::oDbfFab:Eof()
      aAdd( ::aData, { aScan( aFabricante, Alltrim( ::oDbfFab:cCodFab ) ) <> 0, ::oDbfFab:cCodFab, ::oDbfFab:cNomFab } )
      ::oDbfFab:Skip()
   end

   ::oChk:Click( ::oDbf:lFabricant )

Return ( Self )



static FUNCTION TFideliza_LoadTemporada( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local aTemporada  := hb_ATokens( Alltrim( ::oDbf:mTemporada ) )

   if ::oDbfTem == nil .OR. !::oDbfTem:Used()
      ::oDbfTem := DbfServer( "Temporadas.Dbf", ):NewOpen( "Temporadas.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfTem:AddBag( "Temporadas.Cdx" ) ; ::oDbfTem:AddBag( ) ; ::oDbfTem:AutoIndex()
   end

   ::oDbfTem:GoTop()
   while ! ::oDbfTem:Eof()
      aAdd( ::aData, { aScan( aTemporada, Alltrim( ::oDbfTem:cCodigo ) ) <> 0, ::oDbfTem:cCodigo, ::oDbfTem:cNombre } )
      ::oDbfTem:Skip()
   end

   ::oChk:Click( ::oDbf:lTemporada )

Return ( Self )



static FUNCTION TFideliza_SelectedToMemo( ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local cMemo := ""

   aEval( ::aData, {|aItem| if( aItem[ 1 ], cMemo += Rtrim( aItem[ 2 ] ) + ",", ) } )

Return ( cMemo )



static FUNCTION TFideliza_InPrograma( cCodigoArticulo, dFechaVenta, dbfArticulo ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   if IsObject( dbfArticulo )
      dbfArticulo    := dbfArticulo:cAlias
   end





   if dbSeekInOrd( cCodigoArticulo, "Codigo", dbfArticulo )

      ::oDbf:GoTop()
      while !::oDbf:Eof()






         if ( dFechaVenta >= ::oDbf:dInicio  .OR. Empty( ::oDbf:dInicio ) ) .AND.  ( dFechaVenta <= ::oDbf:dFin     .OR. Empty( ::oDbf:dFin ) )








            if ( Empty( ( dbfArticulo )->Familia ) .OR. ::oDbf:lFamilia    .OR. lScanInMemo( ( dbfArticulo )->Familia, ::oDbf:mFamilia   ) ) .AND. ( Empty( ( dbfArticulo )->cCodTip ) .OR. ::oDbf:lTipo       .OR. lScanInMemo( ( dbfArticulo )->cCodTip, ::oDbf:mTipo      ) ) .AND. ( Empty( ( dbfArticulo )->cCodFab ) .OR. ::oDbf:lFabricant  .OR. lScanInMemo( ( dbfArticulo )->cCodFab, ::oDbf:mFabricant ) ) .AND. ( Empty( ( dbfArticulo )->cCodTemp) .OR. ::oDbf:lTemporada  .OR. lScanInMemo( ( dbfArticulo )->cCodTemp,::oDbf:mTemporada ) )

               return .T.

            end

         end

         ::oDbf:Skip()

      end

   end

Return ( .F. )



static FUNCTION TFideliza_nPorcentajePrograma( nImporte ) ; local Self AS CLASS TFideliza := QSelf() AS CLASS TFideliza

   local nPorcentaje             := 0





   ::oDbf:GoTop()
   while !::oDbf:Eof()

      if ::oDetFideliza:oDbf:Seek( ::oDbf:cCodigo )

         while ::oDetFideliza:oDbf:cCodigo == ::oDbf:cCodigo .AND. !::oDetFideliza:oDbf:Eof()

            if ::oDetFideliza:oDbf:nImpUni == 1 .AND. ::oDetFideliza:oDbf:nImporte <= abs( nImporte )

               if ::oDetFideliza:oDbf:nPorcen > nPorcentaje

                  nPorcentaje    := ::oDetFideliza:oDbf:nPorcen

               end

            end

            ::oDetFideliza:oDbf:Skip()

         end

      end

      ::oDbf:Skip()

   end

Return ( nPorcentaje )



Function lScanInMemo( cString, mString )

Return ( aScan( hb_ATokens( Alltrim( mString ), "," ), Alltrim( cString ) ) <> 0 )
