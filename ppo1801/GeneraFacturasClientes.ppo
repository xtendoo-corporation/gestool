#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 8 ".\.\Prg\GeneraFacturasClientes.prg"
_HB_CLASS GeneraFacturasClientes ; function GeneraFacturasClientes ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "GeneraFacturasClientes", iif( .T., { @DialogBuilder() }, { @HBObject() } ), @GeneraFacturasClientes() ) ) ;

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )
   _HB_MEMBER { oPag } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPag"}, .F. )

   _HB_MEMBER { nView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nView"}, .F. )

   _HB_MEMBER { oBmp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBmp"}, .F. )
   _HB_MEMBER { oBtnPrv } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnPrv"}, .F. )
   _HB_MEMBER { oBtnNxt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnNxt"}, .F. )
   _HB_MEMBER { oMetMsg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMetMsg"}, .F. )
   _HB_MEMBER { nMetMsg } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nMetMsg"}, .F. )

   _HB_MEMBER { oPeriodo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPeriodo"}, .F. )
   _HB_MEMBER { oClientes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oClientes"}, .F. )
   _HB_MEMBER { oGruposClientes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGruposClientes"}, .F. )
   _HB_MEMBER { oSeries } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSeries"}, .F. )
   _HB_MEMBER { oAgruparCliente } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAgruparCliente"}, .F. )
   _HB_MEMBER { oAgruparDireccion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAgruparDireccion"}, .F. )
   _HB_MEMBER { oAgruparDescuentos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAgruparDescuentos"}, .F. )
   _HB_MEMBER { oEntregados } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oEntregados"}, .F. )
   _HB_MEMBER { oUnificarPago } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oUnificarPago"}, .F. )
   _HB_MEMBER { oTotalizar } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTotalizar"}, .F. )

   _HB_MEMBER { oBrwAlbaranes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwAlbaranes"}, .F. )
   _HB_MEMBER { oTreeTotales } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTreeTotales"}, .F. )

   _HB_MEMBER { lNodoActivo } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lNodoActivo"}, .F. )
   _HB_MEMBER { cClaveAnterior } ; oClass:AddMultiData(, "", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cClaveAnterior"}, .F. )

   _HB_MEMBER { oSerieFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSerieFactura"}, .F. )
   _HB_MEMBER { cSerieFactura } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerieFactura"}, .F. )
   _HB_MEMBER { nTipoSerie } ; oClass:AddMultiData(, 1, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nTipoSerie"}, .F. )

   _HB_MEMBER { nRadFec } ; oClass:AddMultiData(, 1, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nRadFec"}, .F. )
   _HB_MEMBER { dFecFac } ; oClass:AddMultiData(, GetSysDate(), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFecFac"}, .F. )

   _HB_MEMBER { cSerie } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerie"}, .F. )
   _HB_MEMBER { nNumero } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumero"}, .F. )
   _HB_MEMBER { cSufijo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijo"}, .F. )

   _HB_MEMBER getFacturaId(); oClass:AddInline( "getFacturaId", {|Self | ( ( Self ) ), ( ::cSerie + Str( ::nNumero ) + ::cSufijo ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER { nNumLin } ; oClass:AddMultiData(, 1, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumLin"}, .F. )

   _HB_MEMBER { lMedia } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lMedia"}, .F. )

   _HB_MEMBER { nBrutoAlbaran } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nBrutoAlbaran"}, .F. )
   _HB_MEMBER { nDescuentoAcumulado1 } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuentoAcumulado1"}, .F. )
   _HB_MEMBER { nDescuentoAcumulado2 } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuentoAcumulado2"}, .F. )
   _HB_MEMBER { nDescuentoAcumulado3 } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuentoAcumulado3"}, .F. )
   _HB_MEMBER { nDescuentoAcumulado4 } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuentoAcumulado4"}, .F. )

   _HB_MEMBER { nDescuento1 } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuento1"}, .F. )
   _HB_MEMBER { nDescuento2 } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuento2"}, .F. )
   _HB_MEMBER { nDescuento3 } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuento3"}, .F. )
   _HB_MEMBER { nDescuento4 } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuento4"}, .F. )

   _HB_MEMBER { nGastosFacturas } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nGastosFacturas"}, .F. )

   _HB_MEMBER { nNumPgo } ; oClass:AddMultiData(, 1, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumPgo"}, .F. )

   _HB_MEMBER { aListaAlbaranes } ; oClass:AddMultiData(, {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aListaAlbaranes"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @GeneraFacturasClientes_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lOpenFiles(); oClass:AddMethod( "lOpenFiles", @GeneraFacturasClientes_lOpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @GeneraFacturasClientes_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource(); oClass:AddMethod( "Resource", @GeneraFacturasClientes_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER NextPage(); oClass:AddMethod( "NextPage", @GeneraFacturasClientes_NextPage(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER PrevPage(); oClass:AddMethod( "PrevPage", @GeneraFacturasClientes_PrevPage(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadAlbaranes(); oClass:AddMethod( "LoadAlbaranes", @GeneraFacturasClientes_LoadAlbaranes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CreaFacturas(); oClass:AddMethod( "CreaFacturas", @GeneraFacturasClientes_CreaFacturas(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CreateListaAlbaranes(); oClass:AddMethod( "CreateListaAlbaranes", @GeneraFacturasClientes_CreateListaAlbaranes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER OrdenaListaAlbaranes(); oClass:AddMethod( "OrdenaListaAlbaranes", @GeneraFacturasClientes_OrdenaListaAlbaranes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CreateTree(); oClass:AddMethod( "CreateTree", @GeneraFacturasClientes_CreateTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetItemTree(); oClass:AddMethod( "GetItemTree", @GeneraFacturasClientes_GetItemTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetImporteTree(); oClass:AddMethod( "GetImporteTree", @GeneraFacturasClientes_GetImporteTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getImporteTotalTree(); oClass:AddMethod( "getImporteTotalTree", @GeneraFacturasClientes_getImporteTotalTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getDocumentosTotalTree(); oClass:AddMethod( "getDocumentosTotalTree", @GeneraFacturasClientes_getDocumentosTotalTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GetItemCheck(); oClass:AddMethod( "GetItemCheck", @GeneraFacturasClientes_GetItemCheck(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetFpagoTree(); oClass:AddMethod( "GetFpagoTree", @GeneraFacturasClientes_GetFpagoTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetDto1(); oClass:AddMethod( "GetDto1", @GeneraFacturasClientes_GetDto1(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetDto2(); oClass:AddMethod( "GetDto2", @GeneraFacturasClientes_GetDto2(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetDto3(); oClass:AddMethod( "GetDto3", @GeneraFacturasClientes_GetDto3(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetDto4(); oClass:AddMethod( "GetDto4", @GeneraFacturasClientes_GetDto4(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SetTreeBrowse(); oClass:AddMethod( "SetTreeBrowse", @GeneraFacturasClientes_SetTreeBrowse(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER SetTotalesDocumentos(); oClass:AddMethod( "SetTotalesDocumentos", @GeneraFacturasClientes_SetTotalesDocumentos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ChangeBrowse(); oClass:AddMethod( "ChangeBrowse", @GeneraFacturasClientes_ChangeBrowse(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SetValueCheck(); oClass:AddMethod( "SetValueCheck", @GeneraFacturasClientes_SetValueCheck(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER UpdatePadre(); oClass:AddMethod( "UpdatePadre", @GeneraFacturasClientes_UpdatePadre(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER isFechaFacturaActual(); oClass:AddInline( "isFechaFacturaActual", {|Self | ( ( Self ) ), ( ::nRadFec == 1 ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lIsFacturable(); oClass:AddMethod( "lIsFacturable", @GeneraFacturasClientes_lIsFacturable(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lValidaNodo(); oClass:AddMethod( "lValidaNodo", @GeneraFacturasClientes_lValidaNodo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CreaNodo(); oClass:AddMethod( "CreaNodo", @GeneraFacturasClientes_CreaNodo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AbreNodo(); oClass:AddInline( "AbreNodo", {|Self | ( ( Self ) ), ( TreeBegin(), ::lNodoActivo   := .T. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CierraNodo(); oClass:AddMethod( "CierraNodo", @GeneraFacturasClientes_CierraNodo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cClaveAlbaran(); oClass:AddMethod( "cClaveAlbaran", @GeneraFacturasClientes_cClaveAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AgregaNodo(); oClass:AddMethod( "AgregaNodo", @GeneraFacturasClientes_AgregaNodo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER ExisteNodo( hAlbaran); oClass:AddMethod( "ExisteNodo", @GeneraFacturasClientes_ExisteNodo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitClaves(); oClass:AddMethod( "InitClaves", @GeneraFacturasClientes_InitClaves(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER setClaveAnterior(); oClass:AddInline( "setClaveAnterior", {|Self, cValor | ( ( Self ) ), ( ::cClaveAnterior := cValor ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AppendFactura( oItem); oClass:AddMethod( "AppendFactura", @GeneraFacturasClientes_AppendFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AppendFacturaCabecera( oItem); oClass:AddMethod( "AppendFacturaCabecera", @GeneraFacturasClientes_AppendFacturaCabecera(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AppendFacturaLineas( oItem); oClass:AddMethod( "AppendFacturaLineas", @GeneraFacturasClientes_AppendFacturaLineas(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER cTextoNodoPadre( hCargo); oClass:AddMethod( "cTextoNodoPadre", @GeneraFacturasClientes_cTextoNodoPadre(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cTextoNodoHijo( hCargo); oClass:AddMethod( "cTextoNodoHijo", @GeneraFacturasClientes_cTextoNodoHijo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getFilterDatabase(); oClass:AddMethod( "getFilterDatabase", @GeneraFacturasClientes_getFilterDatabase(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )




























   _HB_MEMBER GetHashAlbaranes(); oClass:AddInline( "GetHashAlbaranes", {|Self, aTotal | ( ( Self ) ), ( { "seleccionado" => .T., "documentos"   => "", "clave"        => ::cClaveAlbaran(), "id"           => D():AlbaranesClientesId( ::nView ), "textoid"      => D():AlbaranesClientesIdTextShort( ::nView ), "cliente"      => ( D():AlbaranesClientes( ::nView ) )->cCodCli, "nombre"       => ( D():AlbaranesClientes( ::nView ) )->cNomCli, "serie"        => ( D():AlbaranesClientes( ::nView ) )->cSerAlb, "formapago"    => ( D():AlbaranesClientes( ::nView ) )->cCodPago, "livaincluido" => ( D():AlbaranesClientes( ::nView ) )->lIvaInc, "lrecargo"     => ( D():AlbaranesClientes( ::nView ) )->lRecargo, "direccion"    => ( D():AlbaranesClientes( ::nView ) )->cCodObr, "fecha"        => ( D():AlbaranesClientes( ::nView ) )->dFecAlb, "hora"         => ( D():AlbaranesClientes( ::nView ) )->tFecAlb, "total"        => ( D():AlbaranesClientes( ::nView ) )->nTotAlb, "pDto1"        => ( D():AlbaranesClientes( ::nView ) )->nDtoEsp, "pDto2"        => ( D():AlbaranesClientes( ::nView ) )->nDpp, "pDto3"        => ( D():AlbaranesClientes( ::nView ) )->nDtoUno, "pDto4"        => ( D():AlbaranesClientes( ::nView ) )->nDtoDos, "sualbaran"    => ( D():AlbaranesClientes( ::nView ) )->cCodSuAlb, "textogasto"   => ( D():AlbaranesClientes( ::nView ) )->cManObr, "ivagastos"    => ( D():AlbaranesClientes( ::nView ) )->nIvaMan, "totalgastos"  => ( D():AlbaranesClientes( ::nView ) )->nManObr, "nbruto"       => aTotal[16], "ndto1"        => aTotal[12], "ndto2"        => aTotal[13], "ndto3"        => aTotal[14], "ndto4"        => aTotal[15] } ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSerie( oITem); oClass:AddMethod( "getSerie", @GeneraFacturasClientes_getSerie(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getFormaPago( oItem); oClass:AddMethod( "getFormaPago", @GeneraFacturasClientes_getFormaPago(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getDireccion( oItem); oClass:AddMethod( "getDireccion", @GeneraFacturasClientes_getDireccion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getFecha( oItem); oClass:AddMethod( "getFecha", @GeneraFacturasClientes_getFecha(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getIvaIncluido(); oClass:AddInline( "getIvaIncluido", {|Self, oItem | ( ( Self ) ), ( hGet( oItem:Cargo, "livaincluido" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getRecargo(); oClass:AddInline( "getRecargo", {|Self, oItem | ( ( Self ) ), ( hGet( oItem:Cargo, "lrecargo" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getTextoGasto(); oClass:AddInline( "getTextoGasto", {|Self, oItem | ( ( Self ) ), ( hGet( oItem:Cargo, "textogasto" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getIvaGastos(); oClass:AddInline( "getIvaGastos", {|Self, oItem | ( ( Self ) ), ( hGet( oItem:Cargo, "ivagastos" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER procesaDescuentosFactura( oItem); oClass:AddMethod( "procesaDescuentosFactura", @GeneraFacturasClientes_procesaDescuentosFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lMediaDescuento( oItem); oClass:AddMethod( "lMediaDescuento", @GeneraFacturasClientes_lMediaDescuento(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetMediaDescuento( oItem); oClass:AddMethod( "GetMediaDescuento", @GeneraFacturasClientes_GetMediaDescuento(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CompruebaDescuento( oItem); oClass:AddMethod( "CompruebaDescuento", @GeneraFacturasClientes_CompruebaDescuento(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER initAcuDto(); oClass:AddInline( "initAcuDto", {|Self | ( ( Self ) ), ( ::nBrutoAlbaran := 0, ::nDescuentoAcumulado1 := 0, ::nDescuentoAcumulado2 := 0, ::nDescuentoAcumulado3 := 0, ::nDescuentoAcumulado4 := 0 ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER initDescuentosTotales(); oClass:AddInline( "initDescuentosTotales", {|Self | ( ( Self ) ), ( ::nDescuento1 := nil, ::nDescuento2 := nil, ::nDescuento3 := nil, ::nDescuento4 := nil ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER initNumeroLinea(); oClass:AddInline( "initNumeroLinea", {|Self | ( ( Self ) ), ( ::nNumLin := 1 ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER initNumeroPago(); oClass:AddInline( "initNumeroPago", {|Self | ( ( Self ) ), ( ::nNumPgo := 1 ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER procesaGastosFactura(); oClass:AddMethod( "procesaGastosFactura", @GeneraFacturasClientes_procesaGastosFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getGastosFactura(); oClass:AddInline( "getGastosFactura", {|Self | ( ( Self ) ), ( ::nGastosFacturas ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER initGastosFactura(); oClass:AddInline( "initGastosFactura", {|Self | ( ( Self ) ), ( ::nGastosFacturas := 0 ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER acumulaGastosFactura(); oClass:AddInline( "acumulaGastosFactura", {|Self, oItem | ( ( Self ) ), ( ::nGastosFacturas += hGet( oItem:Cargo, "totalgastos" )  ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setDescuento( hash); oClass:AddMethod( "setDescuento", @GeneraFacturasClientes_setDescuento(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AcumulaDatosAlbaran( hash); oClass:AddMethod( "AcumulaDatosAlbaran", @GeneraFacturasClientes_AcumulaDatosAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CalculaMediaDescuentos(); oClass:AddMethod( "CalculaMediaDescuentos", @GeneraFacturasClientes_CalculaMediaDescuentos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER appendCabeceraAlbaran( oItem); oClass:AddMethod( "appendCabeceraAlbaran", @GeneraFacturasClientes_appendCabeceraAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER appendLineasAlbaran( oItem); oClass:AddMethod( "appendLineasAlbaran", @GeneraFacturasClientes_appendLineasAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER SetTotalesFactura( oItem); oClass:AddMethod( "SetTotalesFactura", @GeneraFacturasClientes_SetTotalesFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AppendLineaTotal( oItem); oClass:AddMethod( "AppendLineaTotal", @GeneraFacturasClientes_AppendLineaTotal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GeneraPagos( oItem); oClass:AddMethod( "GeneraPagos", @GeneraFacturasClientes_GeneraPagos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER EstadoFactura( oItem); oClass:AddMethod( "EstadoFactura", @GeneraFacturasClientes_EstadoFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER appendPagosAbaranes( oItem); oClass:AddMethod( "appendPagosAbaranes", @GeneraFacturasClientes_appendPagosAbaranes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setEstadoAlbaran( oItem); oClass:AddMethod( "setEstadoAlbaran", @GeneraFacturasClientes_setEstadoAlbaran(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER clickOnCheckHeader(); oClass:AddMethod( "clickOnCheckHeader", @GeneraFacturasClientes_clickOnCheckHeader(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS GeneraFacturasClientes ;



static FUNCTION GeneraFacturasClientes_New( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if !lCurSesion()
      MsgStop( "No hay sesiones activas, imposible añadir documentos" )
      Return ( self )
   end

   if ::lOpenFiles()




      ::oPeriodo           := GetPeriodo():Build( {            "idCombo" => 110, "idFechaInicio" => 120, "idFechaFin" => 130, "oContainer" => Self } )








      ::oGruposClientes    := GetRangoGrupoCliente():Build( {  "idAll" => 140, "idGetInicio" => 150, "idSayInicio" => 151, "idTextInicio" => 152, "idGetFin" => 160, "idSayFin" => 161, "idTextFin" => 162, "oContainer" => Self } )








      ::oClientes          := GetRangoCliente():Build( {       "idAll" => 170, "idGetInicio" => 180, "idSayInicio" => 181, "idTextInicio" => 182, "idGetFin" => 190, "idSayFin" => 191, "idTextFin" => 192, "oContainer" => Self } )




      ::oSeries            := GetRangoSeries():Build( {        "idTodas" => 310, "idNinguna" => 320, "idInicio" => 370, "oContainer" => Self } )

      ::oAgruparCliente          := ComponentCheck():New( 270, .T., Self )

      ::oAgruparDireccion        := ComponentCheck():New( 280, .F., Self )
      ::oAgruparDireccion:bWhen  := {|| ::oAgruparCliente:Value() }

      ::oAgruparDescuentos       := ComponentCheck():New( 293, .F., Self )

      ::oEntregados              := ComponentCheck():New( 290, .F., Self )

      ::oUnificarPago            := ComponentCheck():New( 291, .T., Self )

      ::oTotalizar               := ComponentCheck():New( 292, .F., Self )

      ::Resource()

      ::CloseFiles()

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_lOpenFiles( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local lOpen    := .T.
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      ::nView        := D():CreateView()

      D():Clientes( ::nView )

      D():ClientesBancos( ::nView )

      D():objectGruposClientes( ::nView )

      D():Contadores( ::nView )

      D():AlbaranesClientes( ::nView )

      D():AlbaranesClientesLineas( ::nView )

      D():AlbaranesClientesSeries( ::nView )

      D():AlbaranesClientesCobros( ::nView )

      D():FacturasClientes( ::nView )

      D():FacturasClientesLineas( ::nView )

      D():FacturasClientesSeries( ::nView )

      D():FacturasClientesCobros( ::nView )

      D():AnticiposClientes( ::nView )

      D():Divisas( ::nView )

      D():TiposIva( ::nView )

      D():FormasPago( ::nView )

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      ::CloseFiles()
      lOpen          := .F.

   end

   ErrorBlock( oBlock )

Return ( lOpen )



static FUNCTION GeneraFacturasClientes_CloseFiles( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   D():DeleteView( ::nView )

RETURN ( Self )



static FUNCTION GeneraFacturasClientes_Resource( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::cSerieFactura         := cNewSer( "nFacCli", D():Contadores( ::nView ) )

   if Empty( ::cSerieFactura )
      ::cSerieFactura      := "A"
   end

   ::oDlg = TDialog():New(,,,,, "GENERARFACTURA",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )





   ::oPag := TPages():Redefine( 110, ::oDlg, {"GENFAC_03", "GENFAC_04"},,,, )





   ::oBmp := TBitmap():ReDefine( 600, "gc_document_text_gear_48",, ::oDlg,,, .F., .F.,,, .F.,,, .T. )

   ::oPeriodo:Resource( ::oPag:aDialogs[1] )

   ::oGruposClientes:Resource( ::oPag:aDialogs[1] )

   ::oClientes:Resource( ::oPag:aDialogs[1] )

   ::oSeries:Resource( ::oPag:aDialogs[ 1 ] )



   TRadMenu():Redefine( { | u | If( PCount()==0, ::nRadFec, ::nRadFec:= u ) }, ::oPag:aDialogs[ 1 ],, { 210, 220 },,,,, .F.,, )





   TGetHlp():ReDefine( 230, { | u | If( PCount()==0, ::dFecFac, ::dFecFac:= u ) }, ::oPag:aDialogs[ 1 ],,,,,,,,, .F., {||     ( ::isFechaFacturaActual() )},, .F., .T.,,,,,, nil,,, )



   TRadMenu():Redefine( { | u | If( PCount()==0, ::nTipoSerie, ::nTipoSerie:= u ) }, ::oPag:aDialogs[ 1 ],, { 240, 241, 250 },,,,, .F.,, )









   ::oSerieFactura := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, ::cSerieFactura, ::cSerieFactura:= u ) }, ::oPag:aDialogs[ 1 ],, "@!", {||    ( ::cSerieFactura >= "A" .AND. ::cSerieFactura <= "Z"  )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( ::oSerieFactura ) )}, {||  ( DwSerie( ::oSerieFactura ) )},,,, nil,,, )

   ::oSerieFactura:bWhen := {|| ( ::nTipoSerie == 3 ) }

   ::oAgruparCliente:Resource( ::oPag:aDialogs[ 1 ] )

   ::oAgruparDireccion:Resource( ::oPag:aDialogs[ 1 ] )

   ::oEntregados:Resource( ::oPag:aDialogs[ 1 ] )

   ::oUnificarPago:Resource( ::oPag:aDialogs[ 1 ] )

   ::oTotalizar:Resource( ::oPag:aDialogs[ 1 ] )

   ::oAgruparDescuentos:Resource( ::oPag:aDialogs[ 1 ] )

   ::oMetMsg      := TApoloMeter():ReDefine( 120, { | u | if( pCount() == 0, ::nMetMsg, ::nMetMsg := u ) }, 10, ::oDlg, .F., , , .T., ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), , ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) ) )





   ::oBrwAlbaranes                  := IXBrowse():New( ::oPag:aDialogs[ 2 ] )

   ::oBrwAlbaranes:bClrSel          := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
   ::oBrwAlbaranes:bClrSelFocus     := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

   ::oBrwAlbaranes:lVScroll         := .T.
   ::oBrwAlbaranes:lHScroll         := .T.
   ::oBrwAlbaranes:lFooter          := .T.

   ::oBrwAlbaranes:nMarqueeStyle    := 6

   with object ( ::oBrwAlbaranes:AddCol() )
      :cHeader                      := "S."
      :bStrData                     := {|| "" }
      :bEditValue                   := {|| ::GetItemCheck() }
      :nWidth                       := 20
      :bLClickHeader                := {|nMRow, nMCol, nFlags, oColumn| ::clickOnCheckHeader( oColumn ) }
      :SetCheck( { "sel16", "nil16" } )
   end

   with object ( ::oBrwAlbaranes:AddCol() )
      :cHeader                      := "Concepto"
      :nWidth                       := 480
      :bStrData                     := {|| ::GetItemTree() }
      :bFooter                      := {|| "Total documentos " + alltrim( trans( ::getDocumentosTotalTree(), "9999" ) ) }
   end

   with object ( ::oBrwAlbaranes:AddCol() )
      :cHeader                      := "Pago"
      :nWidth                       := 40
      :bStrData                     := {|| ::GetFpagoTree() }
      :lHide                        := .T.
   end

   with object ( ::oBrwAlbaranes:AddCol() )
      :cHeader                      := "Dto. 1"
      :nWidth                       := 40
      :bStrData                     := {|| ::GetDto1() }
      :nDataStrAlign                := 1
      :nHeadStrAlign                := 1
      :lHide                        := .T.
   end

   with object ( ::oBrwAlbaranes:AddCol() )
      :cHeader                      := "Dto. 2"
      :nWidth                       := 40
      :bStrData                     := {|| ::GetDto2() }
      :nDataStrAlign                := 1
      :nHeadStrAlign                := 1
      :lHide                        := .T.
   end

   with object ( ::oBrwAlbaranes:AddCol() )
      :cHeader                      := "Dto. 3"
      :nWidth                       := 40
      :bStrData                     := {|| ::GetDto3() }
      :nDataStrAlign                := 1
      :nHeadStrAlign                := 1
      :lHide                        := .T.
   end

   with object ( ::oBrwAlbaranes:AddCol() )
      :cHeader                      := "Dto. 4"
      :nWidth                       := 40
      :bStrData                     := {|| ::GetDto4() }
      :nDataStrAlign                := 1
      :nHeadStrAlign                := 1
      :lHide                        := .T.
   end

   with object ( ::oBrwAlbaranes:AddCol() )
      :cHeader                      := "Importes"
      :nWidth                       := 80
      :bStrData                     := {|| ::GetImporteTree() }
      :nDataStrAlign                := 1
      :nHeadStrAlign                := 1
      :nFootStrAlign                := 1
      :bFooter                      := {|| Trans( ::getImporteTotalTree(), cPorDiv() ) }
   end

   ::oBrwAlbaranes:bLDblClick       := {|| ::ChangeBrowse() }

   ::oBrwAlbaranes:CreateFromResource( 100 )




   ::oBtnPrv := TButton():ReDefine( 500, {||( ::PrevPage() )}, ::oDlg,,, .F.,,,, .F. )




   ::oBtnNxt := TButton():ReDefine( 501, {||( ::NextPage() )}, ::oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( ::oDlg:End() )}, ::oDlg,,, .F.,,,, .T. )

      ::oDlg:bStart  := {|| ::oBtnPrv:Hide() }

   ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

   ::oBmp:End()

Return ( self )



static FUNCTION GeneraFacturasClientes_NextPage( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   do case
   case ::oPag:nOption == 1

      ::LoadAlbaranes()

      if Empty( ::oTreeTotales )
         MsgStop( "No existen registros en las condiciones solicitadas." )
         Return .F.
      end

      if ::oTreeTotales:nCount() == 0 .OR. Len( ::aListaAlbaranes ) <= 0
         MsgStop( "No existen registros en las condiciones solicitadas." )
         Return .F.
      end

      ::oBtnPrv:Show()

      SetWindowText( ::oBtnNxt:hWnd, "&Terminar" )

      ::oPag:GoNext()

   case ::oPag:nOption == 2

      ::CreaFacturas()

      MsgInfo( "Proceso terminado con éxito." )

      ::oDlg:End()

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_PrevPage( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if ::oPag:nOption == 2
      SetWindowText( ::oBtnNxt:hWnd, "&Siguiente >" )
      ::oBtnPrv:Hide()
      ::oPag:GoPrev()
   end

Return ( self )



static FUNCTION GeneraFacturasClientes_LoadAlbaranes( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::CreateListaAlbaranes()

   ::OrdenaListaAlbaranes()

   if Len( ::aListaAlbaranes ) > 0

      ::CreateTree()

      if ::oTreeTotales:nCount() > 0

         ::SetTreeBrowse()
         ::SetTotalesDocumentos()

      end

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_SetTreeBrowse( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if empty( ::oBrwAlbaranes:oTree )

      ::oBrwAlbaranes:SetTree( ::oTreeTotales, { "gc_navigate_minus_16", "gc_navigate_plus_16", "Nil16" } )

      if len( ::oBrwAlbaranes:aCols ) > 1
         ::oBrwAlbaranes:aCols[ 1 ]:cHeader    := ""
         ::oBrwAlbaranes:aCols[ 1 ]:nWidth     := 20
      end

   else

      ::oBrwAlbaranes:oTree     := ::oTreeTotales
      ::oBrwAlbaranes:oTreeItem := ::oTreeTotales:oFirst

   end

   ::oBrwAlbaranes:Refresh()

Return ( self )



static FUNCTION GeneraFacturasClientes_SetTotalesDocumentos( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local oItem
   local nCount   := 0
   local cTexto   := ""

   if !Empty( ::oBrwAlbaranes:oTree )

      oItem := ::oBrwAlbaranes:oTree:oFirst

      while oItem <> nil

         if !Empty( oItem:oTree )

            oItem:oTree:Eval( { | o | if( o:nLevel >= oItem:nLevel, nCount++, ) } )
            cTexto := " [" + AllTrim( Str( nCount ) ) + if( nCount > 1, " docs.]", " doc.]" )
            hSet( oItem:Cargo, "documentos", cTexto )

         end

         oItem    := oItem:GetNext()
         nCount   := 0

      end

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_CreateListaAlbaranes( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local aTotAlbaran
   local nRec           := ( D():AlbaranesClientes( ::nView ) )->( Recno() )
   local nOrdAnt        := ( D():AlbaranesClientes( ::nView ) )->( OrdSetFocus( "cCodObr" ) )

   ::aListaAlbaranes    := {}





   if CreateFastFilter( ::getFilterDatabase(), D():AlbaranesClientes( ::nView ), .F. )

      ::oMetMsg:SetTotal( ( D():AlbaranesClientes( ::nView ) )->( OrdKeyCount() ) )

      ( D():AlbaranesClientes( ::nView ) )->( dbGoTop() )

      while !( D():AlbaranesClientes( ::nView ) )->( Eof() )

         if ::lIsFacturable()

            aTotAlbaran    := aTotAlbCli( D():AlbaranesClientesId( ::nView ), D():AlbaranesClientes( ::nView ), D():AlbaranesClientesLineas( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ) )

            aAdd( ::aListaAlbaranes, ::GetHashAlbaranes( aTotAlbaran ) )

         end

         ( D():AlbaranesClientes( ::nView ) )->( dbSkip() )

         ::oMetMsg:Set( ( D():AlbaranesClientes( ::nView ) )->( OrdKeyNo() ) )

      end

      ::oMetMsg:Set( ( D():AlbaranesClientes( ::nView ) )->( OrdKeyCount() ) )





      DestroyFastFilter( D():AlbaranesClientes( ::nView ) )

   end

   ( D():AlbaranesClientes( ::nView ) )->( OrdSetFocus( nOrdAnt ) )
   ( D():AlbaranesClientes( ::nView ) )->( dbGoTo( nRec ) )

Return ( self )



static FUNCTION GeneraFacturasClientes_getFilterDatabase( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cSentence  := ""

   cSentence       := "!Field->lFacturado"

   if ::oEntregados:Value()
      cSentence    += " .and. Field->lEntregado"
   end

   if !::oGruposClientes:oAll:Value()
      cSentence    += ' .and. Field->cCodGrp >= "' + Rtrim( ::oGruposClientes:oInicio:Value() ) + '" .and. Field->cCodGrp <= "' + Rtrim( ::oGruposClientes:oFin:Value() ) + '"'
   end
   if !::oClientes:oAll:Value()
      cSentence    += ' .and. Field->cCodCli >= "' + Rtrim( ::oClientes:oInicio:Value() ) + '" .and. Field->cCodCli <= "' + Rtrim( ::oClientes:oFin:Value() ) + '"'
   end
   cSentence       += ' .and. Field->dFecAlb >= Ctod( "' + Dtoc( ::oPeriodo:oFechaInicio:Value() ) + '" ) .and. Field->dFecAlb <= Ctod( "' + Dtoc( ::oPeriodo:oFechaFin:Value() ) + '" )'
   cSentence       += " .and. !Deleted()"

Return ( cSentence )



static FUNCTION GeneraFacturasClientes_OrdenaListaAlbaranes( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if len( ::aListaAlbaranes ) > 1
      aSort( ::aListaAlbaranes, , , {|x, y| hGet( x, "clave" ) + hGet( x, "direccion" ) + dtos( hGet( x, "fecha" ) ) < hGet( y, "clave" ) + hGet( y, "direccion" ) + dtos( hGet( y, "fecha" ) ) }  )
   end

Return ( self )



static FUNCTION GeneraFacturasClientes_CreateTree( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local hAlbaran

   TreeInit()

   ::oTreeTotales                := TreeBegin( "gc_navigate_minus_16", "gc_navigate_plus_16" )

   ::InitClaves()

   for each hAlbaran in ::aListaAlbaranes

      ::ExisteNodo( hAlbaran )

      ::AgregaNodo( hAlbaran )

   next

   ::CierraNodo()

Return ( self )



static FUNCTION GeneraFacturasClientes_ExisteNodo( hAlbaran ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if !::lValidaNodo( hAlbaran )

      ::CierraNodo()

      ::CreaNodo( hAlbaran )

      ::AbreNodo()

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_GetItemTree( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cItem    := ""

   if empty( ::oBrwAlbaranes:oTreeItem )
      return ( cItem )
   end

   if empty( ::oBrwAlbaranes:oTreeItem:oTree )
      cItem       := ::cTextoNodoHijo( ::oBrwAlbaranes:oTreeItem:Cargo )
   else
      cItem       := ::cTextoNodoPadre( ::oBrwAlbaranes:oTreeItem:Cargo )
   end

Return ( cItem )



static FUNCTION GeneraFacturasClientes_GetItemCheck( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cItem    := .F.

   if !Empty( ::oBrwAlbaranes:oTreeItem )
      cItem       := hGet( ::oBrwAlbaranes:oTreeItem:Cargo, "seleccionado" )
   end

Return ( cItem )



static FUNCTION GeneraFacturasClientes_GetFpagoTree( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cItem    := .F.

   if !Empty( ::oBrwAlbaranes:oTreeItem )
      cItem       := hGet( ::oBrwAlbaranes:oTreeItem:Cargo, "formapago" )
   end

Return ( cItem )



static FUNCTION GeneraFacturasClientes_GetImporteTree( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cItem    := ""
   local nTotAlb  := 0

   if !Empty( ::oBrwAlbaranes:oTreeItem )
      if Empty( ::oBrwAlbaranes:oTreeItem:oTree )
         cItem    := Trans( hGet( ::oBrwAlbaranes:oTreeItem:Cargo, "total" ), cPorDiv() )
      else
         ::oBrwAlbaranes:oTreeItem:oTree:Eval( { | o | if( o:nLevel >= ::oBrwAlbaranes:oTreeItem:nLevel, ( nTotAlb := nTotAlb + hGet( o:Cargo, "total" ) ), ) } )
         cItem    := Trans( nTotAlb, cPorDiv() )
      end
   end

Return ( cItem )



static FUNCTION GeneraFacturasClientes_getImporteTotalTree( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local oItem
   local nImporteTotal     := 0

   if empty( ::oBrwAlbaranes:oTree )
      Return ( nImporteTotal )
   end

   oItem                   := ::oBrwAlbaranes:oTree:oFirst
   while oItem <> nil

      if !empty( oItem:oTree )
         oItem:oTree:Eval( {|oItem| if( hGet( oItem:Cargo, "seleccionado" ), nImporteTotal += hGet( oItem:Cargo, "total" ), ) } )
      end

      oItem                := oItem:getNext()

   end

Return ( nImporteTotal )



static FUNCTION GeneraFacturasClientes_getDocumentosTotalTree( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local oItem
   local nDocumentosTotal  := 0

   if empty( ::oBrwAlbaranes:oTree )
      Return ( nDocumentosTotal )
   end

   oItem                   := ::oBrwAlbaranes:oTree:oFirst
   while oItem <> nil

      if !empty( oItem:oTree )
         oItem:oTree:Eval( {|oItem| if( hGet( oItem:Cargo, "seleccionado" ), nDocumentosTotal++, ) } )
      end

      oItem                := oItem:getNext()

   end

Return ( nDocumentosTotal )




static FUNCTION GeneraFacturasClientes_GetDto1( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cItem    := ""

   if !Empty( ::oBrwAlbaranes:oTreeItem )
      cItem    := Trans( hGet( ::oBrwAlbaranes:oTreeItem:Cargo, "pDto1" ), cPorDiv( cDivEmp(), D():Divisas( ::nView ) ) )
   end

Return ( cItem )



static FUNCTION GeneraFacturasClientes_GetDto2( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cItem    := ""

   if !Empty( ::oBrwAlbaranes:oTreeItem )
      cItem    := Trans( hGet( ::oBrwAlbaranes:oTreeItem:Cargo, "pDto2" ), cPorDiv( cDivEmp(), D():Divisas( ::nView ) ) )
   end

Return ( cItem )



static FUNCTION GeneraFacturasClientes_GetDto3( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cItem    := ""

   if !Empty( ::oBrwAlbaranes:oTreeItem )
      cItem    := Trans( hGet( ::oBrwAlbaranes:oTreeItem:Cargo, "pDto3" ), cPorDiv( cDivEmp(), D():Divisas( ::nView ) ) )
   end

Return ( cItem )



static FUNCTION GeneraFacturasClientes_GetDto4( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cItem    := ""

   if !Empty( ::oBrwAlbaranes:oTreeItem )
      cItem    := Trans( hGet( ::oBrwAlbaranes:oTreeItem:Cargo, "pDto4" ), cPorDiv( cDivEmp(), D():Divisas( ::nView ) ) )
   end

Return ( cItem )



static FUNCTION GeneraFacturasClientes_ChangeBrowse( oTreeItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local nLevel

   If( oTreeItem == nil, oTreeItem := ::oBrwAlbaranes:oTreeItem, ) ;

   if Empty( oTreeItem )
      Return ( Self )
   end

   if Empty( oTreeItem:oTree )





      ::SetValueCheck( oTreeItem, !hGet( oTreeItem:Cargo, "seleccionado" ) )

      ::UpdatePadre( oTreeItem )

   else





      nLevel            := oTreeItem:oTree:oFirst:nLevel



      oTreeItem:oTree:Eval( { | oItem | iif( oItem:nLevel >= nLevel, ::SetValueCheck( oItem, !hGet( oTreeItem:Cargo, "seleccionado" ) ), ) } )

      ::SetValueCheck( oTreeItem, !hGet( ::oBrwAlbaranes:oTreeItem:Cargo, "seleccionado" ) )

   end

   ::oBrwAlbaranes:Refresh()

Return ( self )



static FUNCTION GeneraFacturasClientes_SetValueCheck( oItem, lValue ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   hSet( oItem:Cargo, "seleccionado", lValue )

Return ( self )



static FUNCTION GeneraFacturasClientes_UpdatePadre( oHijo ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local lSel     := .F.
   local oParent  := oHijo:Parent( oHijo:nLevel )

   oParent:oTree:Eval( { | oItem | If( oItem:nLevel >= oParent:nLevel, iif( hGet( oItem:Cargo, "seleccionado" ), lSel := .T., ), ) } )

   ::SetValueCheck( oParent, lSel )

Return ( self )



static FUNCTION GeneraFacturasClientes_lIsFacturable( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

















   if !::oSeries:InRange( ( D():AlbaranesClientes( ::nView ) )->cSerAlb )
      Return ( .F. )
   end





Return ( .T. )



static FUNCTION GeneraFacturasClientes_InitClaves( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::lNodoActivo     := .F.
   ::cClaveAnterior  := ""

Return ( self )



static FUNCTION GeneraFacturasClientes_lValidaNodo( hCargo ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local lValid         := .T.
   local cClaveActual   := hGet( hCargo, "clave" )

   if ::cClaveAnterior <> cClaveActual
      lValid            := .F.
   else
      if !::lNodoActivo
         lValid         := .F.
      end
   end

   ::setClaveAnterior( cClaveActual )

Return ( lValid )



static FUNCTION GeneraFacturasClientes_cClaveAlbaran( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cClave   := ""

   if !::oAgruparCliente:Value()
      cClave      += ( D():AlbaranesClientes( ::nView ) )->cSerAlb + Str( ( D():AlbaranesClientes( ::nView ) )->nNumAlb ) + ( D():AlbaranesClientes( ::nView ) )->cSufAlb
      Return ( cClave )
   end

   cClave         += if( ( D():AlbaranesClientes( ::nView ) )->lIvaInc, ".t.", ".f." )

   cClave         += if( ( D():AlbaranesClientes( ::nView ) )->lRecargo, ".t.", ".f." )

   cClave         += ( D():AlbaranesClientes( ::nView ) )->cManObr

   cClave         += transform( ( D():AlbaranesClientes( ::nView ) )->nIvaMan, "99.99" )

   if !::isFechaFacturaActual()
      cClave      += dtoc( ( D():AlbaranesClientes( ::nView ) )->dFecAlb )
   end

   if ::oAgruparDireccion:Value()
      cClave      += ( D():AlbaranesClientes( ::nView ) )->cCodCli + ( D():AlbaranesClientes( ::nView ) )->cCodObr
   else
      cClave      += ( D():AlbaranesClientes( ::nView ) )->cCodCli
   end

   if ::nTipoSerie == 1
      cClave      += ( D():AlbaranesClientes( ::nView ) )->cSerAlb
   end

   if ::oUnificarPago:Value()
      cClave      += ( D():AlbaranesClientes( ::nView ) )->cCodPago
   end

   if ::oAgruparDescuentos:Value()
      cClave      += str( ( D():AlbaranesClientes( ::nView ) )->nDtoEsp )
      cClave      += str( ( D():AlbaranesClientes( ::nView ) )->nDpp )
      cClave      += str( ( D():AlbaranesClientes( ::nView ) )->nDtoUno )
      cClave      += str( ( D():AlbaranesClientes( ::nView ) )->nDtoDos )
   end

Return ( cClave )



static FUNCTION GeneraFacturasClientes_cTextoNodoPadre( hCargo ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cClave   := ""

   if !::oAgruparCliente:Value()
      cClave      := "Albarán: " + hGet( hCargo, "textoid" ) + " Cliente: " + AllTrim( hGet( hCargo, "nombre" ) ) + hGet( hCargo, "documentos" )
      Return ( cClave )
   end

   if ::oAgruparDireccion:Value()
      cClave      := "Cliente: " + AllTrim( hGet( hCargo, "cliente" ) ) + " - " + AllTrim( hGet( hCargo, "nombre" ) ) + if( Empty( hGet( hCargo, "direccion" ) ), "   Sin dirección", "   Dirección: " ) + AllTrim( hGet( hCargo, "direccion" ) ) + hGet( hCargo, "documentos" )
   else
      cClave      := "Cliente: " + AllTrim( hGet( hCargo, "cliente" ) ) + " - " + AllTrim( hGet( hCargo, "nombre" ) ) + hGet( hCargo, "documentos" )
   end

Return ( cClave )



static FUNCTION GeneraFacturasClientes_cTextoNodoHijo( hCargo ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

Return ( "Albarán: " + hGet( hCargo, "textoid" ) + " Fecha: " + dtoc( hGet( hCargo, "fecha" ) ) + " Cliente: " + AllTrim( hGet( hCargo, "nombre" ) ) )



static FUNCTION GeneraFacturasClientes_CreaNodo( hCargo ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes


















   local h :=  {  "clave" =>        hGet( hCargo, "clave" ), "id" =>           hGet( hCargo, "id" ), "textoid" =>      hGet( hCargo, "textoid" ), "cliente" =>      hGet( hCargo, "cliente" ), "nombre" =>       hGet( hCargo, "nombre" ), "serie" =>        hGet( hCargo, "serie" ), "formapago" =>    hGet( hCargo, "formapago" ), "livaincluido" => hGet( hCargo, "livaincluido" ), "lrecargo" =>     hGet( hCargo, "lrecargo" ), "direccion" =>    hGet( hCargo, "direccion" ), "fecha" =>        hGet( hCargo, "fecha" ), "total" =>        hGet( hCargo, "total" ), "sualbaran" =>    hGet( hCargo, "sualbaran" ), "textogasto" =>   hGet( hCargo, "textogasto" ), "ivagastos" =>    hGet( hCargo, "ivagastos" ), "totalgastos" =>  hGet( hCargo, "totalgastos" ), "seleccionado" => .T., "documentos" =>   "" }

   TreeAddItem( hGet( hCargo, "clave" ) ):Cargo := h

Return ( self )



static FUNCTION GeneraFacturasClientes_CierraNodo( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if ::lNodoActivo
      TreeEnd()
      ::lNodoActivo := .F.
   end

Return ( self )



static FUNCTION GeneraFacturasClientes_AgregaNodo( hCargo ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   TreeAddItem( hGet( hCargo, "id" ) ):Cargo := hCargo

Return ( self )



static FUNCTION GeneraFacturasClientes_CreaFacturas( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local oItem

   ::oDlg:Disable()

   if !Empty( ::oBrwAlbaranes:oTree )

      oItem    := ::oBrwAlbaranes:oTree:oFirst

      while oItem <> nil

         if !Empty( oItem:oTree ) .AND. hGet( oItem:Cargo, "seleccionado" )
            ::AppendFactura( oItem )
         end

         oItem := oItem:GetNext()

      end

   end

   ::oDlg:Enable()

Return ( self )



static FUNCTION GeneraFacturasClientes_AppendFactura( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::procesaDescuentosFactura( oItem )

   ::procesaGastosFactura( oItem )

   ::appendFacturaCabecera( oItem )

   ::initNumeroLinea()

   ::initNumeroPago()

   oItem:oTree:Eval( { | o | if( o:nLevel >= oItem:nLevel, iif( hGet( o:Cargo, "seleccionado" ), ::AppendFacturaLineas( o ), ), ) } )

   ::SetTotalesFactura( oItem )

   ::GeneraPagos( oItem )

   ::EstadoFactura( oItem )

Return ( self )



static FUNCTION GeneraFacturasClientes_procesaDescuentosFactura( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes





   ::initDescuentosTotales()

   ::lMediaDescuento( oItem )

   if !::lMedia
      ::setDescuento( oItem:Cargo )
   else
      ::getMediaDescuento( oItem )
   end

Return ( self )



static FUNCTION GeneraFacturasClientes_lMediaDescuento( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::initDescuentosTotales()

   oItem:oTree:Eval( { | o | if( o:nLevel >= oItem:nLevel, ::compruebaDescuento( o ), ) } )

Return ( self )



static FUNCTION GeneraFacturasClientes_procesaGastosFactura( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::initGastosFactura()

   oItem:oTree:Eval( { | o | if( o:nLevel >= oItem:nLevel, ::acumulaGastosFactura( o ), ) } )

Return ( self )



static FUNCTION GeneraFacturasClientes_setDescuento( hash ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if isNil( ::nDescuento1 )
      ::nDescuento1 := hGet( hash:Cargo, "pDto1" )
   end

   if isNil( ::nDescuento2 )
      ::nDescuento2 := hGet( hash:Cargo, "pDto2" )
   end

   if isNil( ::nDescuento3 )
      ::nDescuento3 := hGet( hash:Cargo, "pDto3" )
   end

   if isNil( ::nDescuento4 )
      ::nDescuento4 := hGet( hash:Cargo, "pDto4" )
   end

Return ( self )



static FUNCTION GeneraFacturasClientes_CompruebaDescuento( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::lMedia       := .F.

   ::setDescuento( oItem )






   if ::nDescuento1 <> hGet( oItem:Cargo, "pDto1" ) .OR. ::nDescuento2 <> hGet( oItem:Cargo, "pDto2" ) .OR. ::nDescuento3 <> hGet( oItem:Cargo, "pDto3" ) .OR. ::nDescuento4 <> hGet( oItem:Cargo, "pDto4" )

      ::lMedia    := .T.

   end

return ( self )



static FUNCTION GeneraFacturasClientes_GetMediaDescuento( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   oItem:oTree:Eval( { | o | if( o:nLevel >= oItem:nLevel, ::AcumulaDatosAlbaran( o ), ) } )

   ::CalculaMediaDescuentos()

Return ( self )



static FUNCTION GeneraFacturasClientes_AcumulaDatosAlbaran( hash ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::nBrutoAlbaran         += hGet( hash:Cargo, "nbruto" )
   ::nDescuentoAcumulado1  += hGet( hash:Cargo, "ndto1" )
   ::nDescuentoAcumulado2  += hGet( hash:Cargo, "ndto2" )
   ::nDescuentoAcumulado3  += hGet( hash:Cargo, "ndto3" )
   ::nDescuentoAcumulado4  += hGet( hash:Cargo, "ndto4" )

Return ( self )



static FUNCTION GeneraFacturasClientes_CalculaMediaDescuentos( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::nDescuento1    := ( ::nDescuentoAcumulado1 * 100 ) / ::nBrutoAlbaran
   ::nDescuento2    := ( ::nDescuentoAcumulado2 * 100 ) / ( ::nBrutoAlbaran - ::nDescuentoAcumulado1 )
   ::nDescuento3    := ( ::nDescuentoAcumulado3 * 100 ) / ( ::nBrutoAlbaran - ::nDescuentoAcumulado1 - ::nDescuentoAcumulado2 )
   ::nDescuento4    := ( ::nDescuentoAcumulado4 * 100 ) / ( ::nBrutoAlbaran - ::nDescuentoAcumulado1 - ::nDescuentoAcumulado2 - ::nDescuentoAcumulado3 )

Return ( self )



static FUNCTION GeneraFacturasClientes_AppendFacturaCabecera( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cCodCli

   ::cSerie       := ::GetSerie( oItem )
   ::nNumero      := nNewDoc( ::cSerie, D():FacturasClientes( ::nView ), "NFACCLI", , D():Contadores( ::nView ) )
   ::cSufijo      := RetSufEmp()

   cCodCli        := hGet( oItem:Cargo, "cliente" )

   ( D():FacturasClientes( ::nView ) )->( dbAppend() )
   ( D():FacturasClientes( ::nView ) )->cSerie        := ::cSerie
   ( D():FacturasClientes( ::nView ) )->nNumFac       := ::nNumero
   ( D():FacturasClientes( ::nView ) )->cSufFac       := ::cSufijo
   ( D():FacturasClientes( ::nView ) )->cTurFac       := cCurSesion()
   ( D():FacturasClientes( ::nView ) )->cCodUsr       := Auth():Codigo()
   ( D():FacturasClientes( ::nView ) )->dFecCre       := date()
   ( D():FacturasClientes( ::nView ) )->cTimCre       := time()
   ( D():FacturasClientes( ::nView ) )->lImpAlb       := .T.
   ( D():FacturasClientes( ::nView ) )->cCodCaj       := Application():CodigoCaja()
   ( D():FacturasClientes( ::nView ) )->cCodDlg       := Application():CodigoDelegacion()
   ( D():FacturasClientes( ::nView ) )->cCodAlm       := Application():codigoAlmacen()
   ( D():FacturasClientes( ::nView ) )->cCodObr       := ::getDireccion( oItem )
   ( D():FacturasClientes( ::nView ) )->cCodPago      := ::getFormaPago( oItem )
   ( D():FacturasClientes( ::nView ) )->dFecFac       := ::getFecha( oItem )
   ( D():FacturasClientes( ::nView ) )->tFecFac       := GetSysTime()
   ( D():FacturasClientes( ::nView ) )->cDivFac       := cDivEmp()
   ( D():FacturasClientes( ::nView ) )->nVdvFac       := nChgDiv( cDivEmp(), D():Divisas( ::nView ) )
   ( D():FacturasClientes( ::nView ) )->lSndDoc       := .T.
   ( D():FacturasClientes( ::nView ) )->lIvaInc       := ::getIvaIncluido( oItem )
   ( D():FacturasClientes( ::nView ) )->lRecargo      := ::getRecargo( oItem )
   ( D():FacturasClientes( ::nView ) )->cDtoEsp       := D():getClientesField( ::nView, "cDtoEsp" )
   ( D():FacturasClientes( ::nView ) )->cDpp          := D():getClientesField( ::nView, "cDpp" )
   ( D():FacturasClientes( ::nView ) )->cDtoUno       := D():getClientesField( ::nView, "cDtoUno" )
   ( D():FacturasClientes( ::nView ) )->cDtoDos       := D():getClientesField( ::nView, "cDtoDos" )
   ( D():FacturasClientes( ::nView ) )->nDtoEsp       := ::nDescuento1
   ( D():FacturasClientes( ::nView ) )->nDpp          := ::nDescuento2
   ( D():FacturasClientes( ::nView ) )->nDtoUno       := ::nDescuento3
   ( D():FacturasClientes( ::nView ) )->nDtoDos       := ::nDescuento4

   ( D():FacturasClientes( ::nView ) )->cManObr       := ::getTextoGasto( oItem )
   ( D():FacturasClientes( ::nView ) )->nIvaMan       := ::getIvaGastos( oItem )
   ( D():FacturasClientes( ::nView ) )->nManObr       := ::getGastosFactura()



   ( D():FacturasClientes( ::nView ) )->cCodCli          := cCodCli

   if ( D():Clientes( ::nView ) )->( dbseek( cCodCli ) )
      ( D():FacturasClientes( ::nView ) )->cNomCli       := ( D():Clientes( ::nView ) )->Titulo
      ( D():FacturasClientes( ::nView ) )->cDirCli       := ( D():Clientes( ::nView ) )->Domicilio
      ( D():FacturasClientes( ::nView ) )->cPobCli       := ( D():Clientes( ::nView ) )->Poblacion
      ( D():FacturasClientes( ::nView ) )->cPrvCli       := ( D():Clientes( ::nView ) )->Provincia
      ( D():FacturasClientes( ::nView ) )->cPosCli       := ( D():Clientes( ::nView ) )->CodPostal
      ( D():FacturasClientes( ::nView ) )->cDniCli       := ( D():Clientes( ::nView ) )->Nif
      ( D():FacturasClientes( ::nView ) )->lOperPv       := ( D():Clientes( ::nView ) )->lPntVer
      ( D():FacturasClientes( ::nView ) )->cCodRut       := ( D():Clientes( ::nView ) )->cCodRut
      ( D():FacturasClientes( ::nView ) )->nTarifa       := max( ( D():Clientes( ::nView ) )->nTarifa, 1 )
      ( D():FacturasClientes( ::nView ) )->nRegIva       := ( D():Clientes( ::nView ) )->nRegIva
      ( D():FacturasClientes( ::nView ) )->cCodAge       := ( D():Clientes( ::nView ) )->cAgente

      if lBancoDefecto( cCodCli, D():ClientesBancos( ::nView ) )

         ( D():FacturasClientes( ::nView ) )->cBanco     := ( D():ClientesBancos( ::nView ) )->cCodBnc
         ( D():FacturasClientes( ::nView ) )->cPaisIBAN  := ( D():ClientesBancos( ::nView ) )->cPaisIBAN
         ( D():FacturasClientes( ::nView ) )->cCtrlIBAN  := ( D():ClientesBancos( ::nView ) )->cCtrlIBAN
         ( D():FacturasClientes( ::nView ) )->cEntBnc    := ( D():ClientesBancos( ::nView ) )->cEntBnc
         ( D():FacturasClientes( ::nView ) )->cSucBnc    := ( D():ClientesBancos( ::nView ) )->cSucBnc
         ( D():FacturasClientes( ::nView ) )->cDigBnc    := ( D():ClientesBancos( ::nView ) )->cDigBnc
         ( D():FacturasClientes( ::nView ) )->cCtaBnc    := ( D():ClientesBancos( ::nView ) )->cCtaBnc

      end

   end

   if !::oAgruparCliente:Value() .AND. dbSeekInOrd( hGet( oItem:Cargo, "id" ), "nNumAlb", D():AlbaranesClientes( ::nView ) )
      ( D():FacturasClientes( ::nView ) )->cNumAlb       := ( D():AlbaranesClientes( ::nView ) )->cSerAlb + Str( ( D():AlbaranesClientes( ::nView ) )->nNumAlb ) + ( D():AlbaranesClientes( ::nView ) )->cSufAlb

      ( D():FacturasClientes( ::nView ) )->cCodRut       := ( D():AlbaranesClientes( ::nView ) )->cCodRut
      ( D():FacturasClientes( ::nView ) )->cCodTar       := ( D():AlbaranesClientes( ::nView ) )->cCodTar
      ( D():FacturasClientes( ::nView ) )->cCodObr       := ( D():AlbaranesClientes( ::nView ) )->cCodObr
      ( D():FacturasClientes( ::nView ) )->mComent       := ( D():AlbaranesClientes( ::nView ) )->mComent
      ( D():FacturasClientes( ::nView ) )->mObserv       := ( D():AlbaranesClientes( ::nView ) )->mObserv
      ( D():FacturasClientes( ::nView ) )->cCodTrn       := ( D():AlbaranesClientes( ::nView ) )->cCodTrn
   end

   ( D():FacturasClientes( ::nView ) )->( dbunlock() )

Return ( self )



static FUNCTION GeneraFacturasClientes_AppendFacturaLineas( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   ::appendCabeceraAlbaran( oItem )

   ::appendLineasAlbaran( oItem )

   ::appendLineaTotal( oItem )

   ::appendPagosAbaranes( oItem )

   ::setEstadoAlbaran( oItem )

Return ( self )



static FUNCTION GeneraFacturasClientes_appendCabeceraAlbaran( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cDesAlb  := ""

   if lNumAlb() .OR. lSuAlb() .OR. !empty( hGet( oItem:Cargo, "direccion" ) )

      ( D():FacturasClientesLineas( ::nView ) )->( dbAppend() )
      ( D():FacturasClientesLineas( ::nView ) )->nNumLin    := ::nNumLin
      ( D():FacturasClientesLineas( ::nView ) )->nPosPrint  := ::nNumLin
      ( D():FacturasClientesLineas( ::nView ) )->cSerie     := ::cSerie
      ( D():FacturasClientesLineas( ::nView ) )->nNumFac    := ::nNumero
      ( D():FacturasClientesLineas( ::nView ) )->cSufFac    := ::cSufijo

      cDesAlb                    := ""
      if lNumAlb()
         cDesAlb                 += Alltrim( cNumAlb() ) + " " + AllTrim( hGet( oItem:Cargo, "textoid" ) ) + Space( 1 )
      end

      if lSuAlb()
         cDesAlb                 += Alltrim( cSuAlb() ) + " " + AllTrim( hGet( oItem:Cargo, "sualbaran" ) ) + Space( 1 )
      end

      if lNumObr()
         cDesAlb                 += Alltrim( cNumObr() ) + " " + AllTrim( hGet( oItem:Cargo, "direccion" ) ) + Space( 1 )
      end

      if !Empty( cDesAlb )
         cDesAlb                 += "Fecha: " + dtoc( hGet( oItem:Cargo, "fecha" ) )
      end

      ( D():FacturasClientesLineas( ::nView ) )->cDetalle   := cDesAlb
      ( D():FacturasClientesLineas( ::nView ) )->mLngDes    := cDesAlb
      ( D():FacturasClientesLineas( ::nView ) )->lControl   := .T.
      ( D():FacturasClientesLineas( ::nView ) )->cAlmLin    := Application():codigoAlmacen()

      ( D():FacturasClientesLineas( ::nView ) )->( dbUnlock() )

      ::nNumLin++

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_appendLineasAlbaran( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if ( D():AlbaranesClientesLineas( ::nView ) )->( dbSeek( hGet( oItem:Cargo, "id" ) ) )


      while ( D():AlbaranesClientesLineas( ::nView ) )->cSerAlb + Str( ( D():AlbaranesClientesLineas( ::nView ) )->nNumAlb ) + ( D():AlbaranesClientesLineas( ::nView ) )->cSufAlb == hGet( oItem:Cargo, "id" ) .AND. !( D():AlbaranesClientesLineas( ::nView ) )->( eof() )

            ( D():FacturasClientesLineas( ::nView ) )->( dbAppend() )

            ( D():FacturasClientesLineas( ::nView ) )->nNumLin    := ::nNumLin
            ( D():FacturasClientesLineas( ::nView ) )->nPosPrint  := ::nNumLin
            ( D():FacturasClientesLineas( ::nView ) )->cSerie     := ::cSerie
            ( D():FacturasClientesLineas( ::nView ) )->nNumFac    := ::nNumero
            ( D():FacturasClientesLineas( ::nView ) )->cSufFac    := ::cSufijo
            ( D():FacturasClientesLineas( ::nView ) )->cRef       := ( D():AlbaranesClientesLineas( ::nView ) )->cRef
            ( D():FacturasClientesLineas( ::nView ) )->cDetalle   := ( D():AlbaranesClientesLineas( ::nView ) )->cDetalle
            ( D():FacturasClientesLineas( ::nView ) )->mLngDes    := ( D():AlbaranesClientesLineas( ::nView ) )->mLngDes
            ( D():FacturasClientesLineas( ::nView ) )->mNumSer    := ( D():AlbaranesClientesLineas( ::nView ) )->mNumSer
            ( D():FacturasClientesLineas( ::nView ) )->nCanEnt    := ( D():AlbaranesClientesLineas( ::nView ) )->nCanEnt
            ( D():FacturasClientesLineas( ::nView ) )->cUnidad    := ( D():AlbaranesClientesLineas( ::nView ) )->cUnidad
            ( D():FacturasClientesLineas( ::nView ) )->nUniCaja   := ( D():AlbaranesClientesLineas( ::nView ) )->nUniCaja
            ( D():FacturasClientesLineas( ::nView ) )->nUndKit    := ( D():AlbaranesClientesLineas( ::nView ) )->nUndKit
            ( D():FacturasClientesLineas( ::nView ) )->nPesoKg    := ( D():AlbaranesClientesLineas( ::nView ) )->nPesoKg
            ( D():FacturasClientesLineas( ::nView ) )->nIva       := ( D():AlbaranesClientesLineas( ::nView ) )->nIva
            ( D():FacturasClientesLineas( ::nView ) )->nReq       := ( D():AlbaranesClientesLineas( ::nView ) )->nReq
            ( D():FacturasClientesLineas( ::nView ) )->nDto       := ( D():AlbaranesClientesLineas( ::nView ) )->nDto
            ( D():FacturasClientesLineas( ::nView ) )->nDtoDiv    := ( D():AlbaranesClientesLineas( ::nView ) )->nDtoDiv
            ( D():FacturasClientesLineas( ::nView ) )->nPntVer    := ( D():AlbaranesClientesLineas( ::nView ) )->nPntVer
            ( D():FacturasClientesLineas( ::nView ) )->nDtoPrm    := ( D():AlbaranesClientesLineas( ::nView ) )->nDtoPrm
            ( D():FacturasClientesLineas( ::nView ) )->nComAge    := ( D():AlbaranesClientesLineas( ::nView ) )->nComAge
            ( D():FacturasClientesLineas( ::nView ) )->dFecha     := ( D():AlbaranesClientesLineas( ::nView ) )->dFecha
            ( D():FacturasClientesLineas( ::nView ) )->cTipMov    := ( D():AlbaranesClientesLineas( ::nView ) )->cTipMov
            ( D():FacturasClientesLineas( ::nView ) )->cAlmLin    := ( D():AlbaranesClientesLineas( ::nView ) )->cAlmLin
            ( D():FacturasClientesLineas( ::nView ) )->cCodPr1    := ( D():AlbaranesClientesLineas( ::nView ) )->cCodPr1
            ( D():FacturasClientesLineas( ::nView ) )->cCodPr2    := ( D():AlbaranesClientesLineas( ::nView ) )->cCodPr2
            ( D():FacturasClientesLineas( ::nView ) )->cValPr1    := ( D():AlbaranesClientesLineas( ::nView ) )->cValPr1
            ( D():FacturasClientesLineas( ::nView ) )->cValPr2    := ( D():AlbaranesClientesLineas( ::nView ) )->cValPr2
            ( D():FacturasClientesLineas( ::nView ) )->nCtlStk    := ( D():AlbaranesClientesLineas( ::nView ) )->nCtlStk
            ( D():FacturasClientesLineas( ::nView ) )->nCosDiv    := ( D():AlbaranesClientesLineas( ::nView ) )->nCosDiv
            ( D():FacturasClientesLineas( ::nView ) )->lControl   := ( D():AlbaranesClientesLineas( ::nView ) )->lControl
            ( D():FacturasClientesLineas( ::nView ) )->lKitArt    := ( D():AlbaranesClientesLineas( ::nView ) )->lKitArt
            ( D():FacturasClientesLineas( ::nView ) )->lKitChl    := ( D():AlbaranesClientesLineas( ::nView ) )->lKitChl
            ( D():FacturasClientesLineas( ::nView ) )->lKitPrc    := ( D():AlbaranesClientesLineas( ::nView ) )->lKitPrc
            ( D():FacturasClientesLineas( ::nView ) )->lNotVta    := ( D():AlbaranesClientesLineas( ::nView ) )->lNotVta
            ( D():FacturasClientesLineas( ::nView ) )->lImpLin    := ( D():AlbaranesClientesLineas( ::nView ) )->lImpLin
            ( D():FacturasClientesLineas( ::nView ) )->nValImp    := ( D():AlbaranesClientesLineas( ::nView ) )->nValImp
            ( D():FacturasClientesLineas( ::nView ) )->lIvaLin    := ( D():AlbaranesClientesLineas( ::nView ) )->lIvaLin
            ( D():FacturasClientesLineas( ::nView ) )->nPreUnit   := ( D():AlbaranesClientesLineas( ::nView ) )->nPreUnit
            ( D():FacturasClientesLineas( ::nView ) )->cImagen    := ( D():AlbaranesClientesLineas( ::nView ) )->cImagen
            ( D():FacturasClientesLineas( ::nView ) )->cCodFam    := ( D():AlbaranesClientesLineas( ::nView ) )->cCodFam
            ( D():FacturasClientesLineas( ::nView ) )->cGrpFam    := ( D():AlbaranesClientesLineas( ::nView ) )->cGrpFam
            ( D():FacturasClientesLineas( ::nView ) )->lLote      := ( D():AlbaranesClientesLineas( ::nView ) )->lLote
            ( D():FacturasClientesLineas( ::nView ) )->nLote      := ( D():AlbaranesClientesLineas( ::nView ) )->nLote
            ( D():FacturasClientesLineas( ::nView ) )->cLote      := ( D():AlbaranesClientesLineas( ::nView ) )->cLote
            ( D():FacturasClientesLineas( ::nView ) )->dFecCad    := ( D():AlbaranesClientesLineas( ::nView ) )->dFecCad
            ( D():FacturasClientesLineas( ::nView ) )->cNumPed    := ( D():AlbaranesClientesLineas( ::nView ) )->cNumPed
            ( D():FacturasClientesLineas( ::nView ) )->cCtrCoste  := ( D():AlbaranesClientesLineas( ::nView ) )->cCtrCoste
            ( D():FacturasClientesLineas( ::nView ) )->cTipCtr    := ( D():AlbaranesClientesLineas( ::nView ) )->cTipCtr
            ( D():FacturasClientesLineas( ::nView ) )->cTerCtr    := ( D():AlbaranesClientesLineas( ::nView ) )->cTerCtr
            ( D():FacturasClientesLineas( ::nView ) )->cCodCli    := ( D():AlbaranesClientesLineas( ::nView ) )->cCodCli

            ( D():FacturasClientesLineas( ::nView ) )->cCodAlb    := hGet( oItem:Cargo, "id" )
            ( D():FacturasClientesLineas( ::nView ) )->dFecAlb    := hGet( oItem:Cargo, "fecha" )
            ( D():FacturasClientesLineas( ::nView ) )->dFecFac    := hGet( oItem:Cargo, "fecha" )

            ( D():FacturasClientesLineas( ::nView ) )->cCodObr    := ( D():AlbaranesClientesLineas( ::nView ) )->cObrLin



            if ( D():AlbaranesClientesSeries( ::nView ) )->( dbSeek( hGet( oItem:Cargo, "id" ) + Str( ( D():AlbaranesClientesLineas( ::nView ) )->nNumLin ) ) )


               while ( D():AlbaranesClientesSeries( ::nView ) )->cSerAlb + Str( ( D():AlbaranesClientesSeries( ::nView ) )->nNumAlb ) + ( D():AlbaranesClientesSeries( ::nView ) )->cSufAlb + Str( ( D():AlbaranesClientesSeries( ::nView ) )->nNumLin ) == hGet( oItem:Cargo, "id" ) + Str( ( D():AlbaranesClientesLineas( ::nView ) )->nNumLin ) .AND. !( D():AlbaranesClientesSeries( ::nView ) )->( Eof() )

                  ( D():FacturasClientesSeries( ::nView ) )->( dbAppend() )
                  ( D():FacturasClientesSeries( ::nView ) )->cSerFac  := ::cSerie
                  ( D():FacturasClientesSeries( ::nView ) )->nNumFac  := ::nNumero
                  ( D():FacturasClientesSeries( ::nView ) )->cSufFac  := ::cSufijo
                  ( D():FacturasClientesSeries( ::nView ) )->nNumLin  := ::nNumLin - 1
                  ( D():FacturasClientesSeries( ::nView ) )->cRef     := ( D():AlbaranesClientesSeries( ::nView ) )->cRef
                  ( D():FacturasClientesSeries( ::nView ) )->cAlmLin  := ( D():AlbaranesClientesSeries( ::nView ) )->cAlmLin
                  ( D():FacturasClientesSeries( ::nView ) )->cNumSer  := ( D():AlbaranesClientesSeries( ::nView ) )->cNumSer
                  ( D():FacturasClientesSeries( ::nView ) )->( dbUnLock() )

                  ( D():AlbaranesClientesSeries( ::nView ) )->( dbSkip() )

               end

            end

            ( D():AlbaranesClientesLineas( ::nView ) )->( dbUnlock() )

            ::nNumLin++

         ( D():AlbaranesClientesLineas( ::nView ) )->( dbSkip() )

      end

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_SetTotalesFactura( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes







   local aTotFac := aTotFacCli(  ::getFacturaId(), D():FacturasClientes( ::nView ), D():FacturasClientesLineas( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ), D():FacturasClientesCobros( ::nView ), D():AnticiposClientes( ::nView ) )

   if ( D():FacturasClientes( ::nView ) )->( dbSeek( ::getFacturaId() ) ) .AND. dbLock( D():FacturasClientes( ::nView ) )

      ( D():FacturasClientes( ::nView ) )->nTotNet    := aTotFac[1]
      ( D():FacturasClientes( ::nView ) )->nTotIva    := aTotFac[2]
      ( D():FacturasClientes( ::nView ) )->nTotReq    := aTotFac[3]
      ( D():FacturasClientes( ::nView ) )->nTotFac    := aTotFac[4]

      ( D():FacturasClientes( ::nView ) )->( dbUnlock() )

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_AppendLineaTotal( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local nNumero

   if ::oTotalizar:Value()

      ( D():FacturasClientesLineas( ::nView ) )->( dbAppend() )
      nNumero                                               := ::nNumLin++
      ( D():FacturasClientesLineas( ::nView ) )->nNumLin    := nNumero
      ( D():FacturasClientesLineas( ::nView ) )->nPosPrint  := nNumero
      ( D():FacturasClientesLineas( ::nView ) )->cSerie     := ::cSerie
      ( D():FacturasClientesLineas( ::nView ) )->nNumFac    := ::nNumero
      ( D():FacturasClientesLineas( ::nView ) )->cSufFac    := ::cSufijo
      ( D():FacturasClientesLineas( ::nView ) )->mLngDes    := "Total albaran..."
      ( D():FacturasClientesLineas( ::nView ) )->lTotLin    := .T.
      ( D():FacturasClientesLineas( ::nView ) )->( dbUnLock() )

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_getSerie( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cSerie   := ""

   do case
      case ::nTipoSerie == 1
         cSerie   := hGet( oItem:Cargo, "serie" )

      case ::nTipoSerie == 2
         cSerie   := RetFld( hGet( oItem:Cargo, "cliente" ), D():Clientes( ::nView ), "Serie" )

      case ::nTipoSerie == 3
         cSerie   := ::cSerieFactura

   end

   if Empty( cSerie )
      cSerie      := cDefSer()
   end

Return ( cSerie )



static FUNCTION GeneraFacturasClientes_getFormaPago( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cCodPago    := RetFld( hGet( oItem:Cargo, "cliente" ), D():Clientes( ::nView ), "CodPago" )

   if ::oUnificarPago:Value()
      cCodPago       := hGet( oItem:Cargo, "formapago" )
   end

   if Empty( cCodPago )
      cCodPago       := cDefFpg()
   end

Return ( cCodPago )



static FUNCTION GeneraFacturasClientes_getDireccion( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local cDireccion  := ""

   if ::oAgruparDireccion:Value()
      cDireccion     := hGet( oItem:Cargo, "direccion" )
   end

Return ( cDireccion )



static FUNCTION GeneraFacturasClientes_getFecha( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local dFecha      := ::dFecFac

   if !::isFechaFacturaActual()
      dFecha         := hGet( oItem:Cargo, "fecha" )
   end

Return ( dFecha )



static FUNCTION GeneraFacturasClientes_GeneraPagos( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes









   GenPgoFacCli(  ::getFacturaId(), D():FacturasClientes( ::nView ), D():FacturasClientesLineas( ::nView ), D():FacturasClientesCobros( ::nView ), D():AnticiposClientes( ::nView ), D():Clientes( ::nView ), D():FormasPago( ::nView ), D():Divisas( ::nView ), D():TiposIva( ::nView ) )

Return ( self )



static FUNCTION GeneraFacturasClientes_EstadoFactura( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if ( D():FacturasClientes( ::nView ) )->( dbSeek( ::getFacturaId() ) )








      ChkLqdFacCli(  nil, D():FacturasClientes( ::nView ), D():FacturasClientesLineas( ::nView ), D():FacturasClientesCobros( ::nView ), D():AnticiposClientes( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ), .F. )

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_appendPagosAbaranes( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if ( D():AlbaranesClientesCobros( ::nView ) )->( dbSeek( hGet( oItem:cargo, "id" ) ) )


      while D():AlbaranesClientesCobrosId( ::nView ) == hGet( oItem:cargo, "id" ) .AND. !( D():AlbaranesClientesCobros( ::nView ) )->( eof() )

            ( D():FacturasClientesCobros( ::nView ) )->( dbAppend() )

            ( D():FacturasClientesCobros( ::nView ) )->cSerie        := ::cSerie
            ( D():FacturasClientesCobros( ::nView ) )->nNumFac       := ::nNumero
            ( D():FacturasClientesCobros( ::nView ) )->cSufFac       := ::cSufijo
            ( D():FacturasClientesCobros( ::nView ) )->nNumRec       := ::nNumPgo++
            ( D():FacturasClientesCobros( ::nView ) )->cTurRec       := ( D():AlbaranesClientesCobros( ::nView ) )->cTurRec
            ( D():FacturasClientesCobros( ::nView ) )->lCloPgo       := ( D():AlbaranesClientesCobros( ::nView ) )->lCloPgo
            ( D():FacturasClientesCobros( ::nView ) )->cCodCaj       := ( D():AlbaranesClientesCobros( ::nView ) )->cCodCaj
            ( D():FacturasClientesCobros( ::nView ) )->cCodCli       := hGet( oItem:cargo, "cliente" )
            ( D():FacturasClientesCobros( ::nView ) )->cNomCli       := hGet( oItem:cargo, "nombre" )
            ( D():FacturasClientesCobros( ::nView ) )->dEntrada      := ( D():AlbaranesClientesCobros( ::nView ) )->dEntrega
            ( D():FacturasClientesCobros( ::nView ) )->dPreCob       := ( D():AlbaranesClientesCobros( ::nView ) )->dEntrega
            ( D():FacturasClientesCobros( ::nView ) )->dFecVto       := ( D():AlbaranesClientesCobros( ::nView ) )->dEntrega
            ( D():FacturasClientesCobros( ::nView ) )->nImporte      := ( D():AlbaranesClientesCobros( ::nView ) )->nImporte
            ( D():FacturasClientesCobros( ::nView ) )->nImpCob       := ( D():AlbaranesClientesCobros( ::nView ) )->nImporte

            if Empty( ( D():AlbaranesClientesCobros( ::nView ) )->cDescrip )
               ( D():FacturasClientesCobros( ::nView ) )->cDescrip   := "Cobro realizado desde el albarán " + hGet( oItem:cargo, "textoid" )
            else
               ( D():FacturasClientesCobros( ::nView ) )->cDescrip   := ( D():AlbaranesClientesCobros( ::nView ) )->cDescrip + " (" + hGet( oItem:cargo, "textoid" ) + ")"
            end

            ( D():FacturasClientesCobros( ::nView ) )->cPgdoPor      := ( D():AlbaranesClientesCobros( ::nView ) )->cPgdoPor
            ( D():FacturasClientesCobros( ::nView ) )->cCodPgo       := ( D():AlbaranesClientesCobros( ::nView ) )->cCodPgo
            ( D():FacturasClientesCobros( ::nView ) )->cDivPgo       := ( D():AlbaranesClientesCobros( ::nView ) )->cDivPgo
            ( D():FacturasClientesCobros( ::nView ) )->nVdvPgo       := ( D():AlbaranesClientesCobros( ::nView ) )->nVdvPgo
            ( D():FacturasClientesCobros( ::nView ) )->cCodAge       := ( D():AlbaranesClientesCobros( ::nView ) )->cCodAge
            ( D():FacturasClientesCobros( ::nView ) )->lCobrado      := .T.
            ( D():FacturasClientesCobros( ::nView ) )->lConPgo       := .F.
            ( D():FacturasClientesCobros( ::nView ) )->lRecImp       := .F.
            ( D():FacturasClientesCobros( ::nView ) )->lRecDto       := .F.


            ( D():FacturasClientesCobros( ::nView ) )->( dbUnLock() )

         ( D():AlbaranesClientesCobros( ::nView ) )->( dbSkip() )

      end

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_setEstadoAlbaran( oItem ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   if ( D():AlbaranesClientes( ::nView ) )->( dbSeek( hGet( oItem:Cargo, "id" ) ) )






      SetFacturadoAlbaranCliente(   .T., nil, D():AlbaranesClientes( ::nView ), D():AlbaranesClientesLineas( ::nView ), D():AlbaranesClientesSeries( ::nView ), ::getFacturaId() )

   end

Return ( self )



static FUNCTION GeneraFacturasClientes_clickOnCheckHeader( ) ; local Self AS CLASS GeneraFacturasClientes := QSelf() AS CLASS GeneraFacturasClientes

   local oItem

   if empty( ::oBrwAlbaranes:oTree )
      Return ( Self )
   end

   oItem       := ::oBrwAlbaranes:oTree:oFirst
   while oItem <> nil

      ::SetValueCheck( oItem, !hGet( oItem:Cargo, "seleccionado" ) )

      if !( oItem:lOpened ) .AND. !empty( oItem:oTree )
         oItem:oTree:Eval( {|oItem| ::SetValueCheck( oItem, !hGet( oItem:Cargo, "seleccionado" ) ) } )
      end

      oItem    := oItem:getNext()

   end

Return ( self )
