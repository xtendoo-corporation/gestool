#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 9 ".\.\Prg\ImpBellerin.prg"
_HB_CLASS TImpBellerin ; function TImpBellerin ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TImpBellerin", iif( .F., { }, { @HBObject() } ), @TImpBellerin() ) ) ;

   _HB_MEMBER { nLevel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nLevel"}, .F. )
   _HB_MEMBER { oDbfCli } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfCli"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @TImpBellerin_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Create(); oClass:AddInline( "Create", {|Self, oMenuItem, oWnd | ( ( Self ) ), ( if( ::New( oMenuItem, oWnd ) <> nil, ::Activate(), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lOpenFiles(); oClass:AddMethod( "lOpenFiles", @TImpBellerin_lOpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TImpBellerin_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate( oWnd); oClass:AddMethod( "Activate", @TImpBellerin_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TImpBellerin ;




static FUNCTION TImpBellerin_New( oMenuItem, oWnd ) ; local Self AS CLASS TImpBellerin := QSelf() AS CLASS TImpBellerin

   If( oMenuItem == nil, oMenuItem := "01102", ) ;

   ::nLevel             := Auth():Level( oMenuItem )

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return ( nil )
   end

   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

RETURN ( Self )




static FUNCTION TImpBellerin_lOpenFiles( ) ; local Self AS CLASS TImpBellerin := QSelf() AS CLASS TImpBellerin

   local lOpen    := .T.
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

   ::oDbfCli := DbfServer( "CLIENT.DBF", ):NewOpen( "CLIENT.DBF",, ( cLocalDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfCli:AddBag( "CLIENT.CDX" ) ; ::oDbfCli:AddBag( ) ; ::oDbfCli:AutoIndex()

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      ::CloseFiles()
      lOpen       := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )




static FUNCTION TImpBellerin_CloseFiles( ) ; local Self AS CLASS TImpBellerin := QSelf() AS CLASS TImpBellerin

   if !Empty ( ::oDbfCli )
      ::oDbfCli:End()
   end

   ::oDbfCli     := nil

RETURN ( Self )




static FUNCTION TImpBellerin_Activate( oWnd ) ; local Self AS CLASS TImpBellerin := QSelf() AS CLASS TImpBellerin

   local oError
   local oBlock
   local cDirectory  := Space( 255 )
   local aFiles
   local n           := 1
   local oOleExcel
   local cNombre
   local cDireccion
   local cPoblacion
   local cTelefono
   local cNif
   local cNewCodCli
   local cMovil      := Space( 20 )
   local nPos

   if ! ::lOpenFiles()
      Return ( Self )
   end

   MsgGet( "Seleccione un directorio", "Directorio: ", @cDirectory )

   aFiles                              := Directory( AllTrim( cDirectory ) + "*.*" )

   for n := 1 to Len( aFiles )

      msgwait( aFiles[ n, 1 ], "Fichero " + Str( n ), 0.5 )

      cNombre                          := Space(1)
      cDireccion                       := Space(1)
      cPoblacion                       := Space(1)
      cTelefono                        := Space(1)
      cNif                             := Space(1)

      oBlock                           := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      oOleExcel                        := TOleExcel():New( "Importando hoja de excel", "Conectando...", .F. )

      oOleExcel:oExcel:Visible         := .F.
      oOleExcel:oExcel:DisplayAlerts   := .F.

      if File( AllTrim( cDirectory ) + aFiles[ n, 1 ] )

         oOleExcel:oExcel:WorkBooks:Open( AllTrim( cDirectory ) + aFiles[ n, 1 ] )





         oOleExcel:oExcel:WorkSheets( 1 ):Activate()

         cNombre           := oOleExcel:oExcel:ActiveSheet:Range( "B6" ):Value

         cDireccion        := oOleExcel:oExcel:ActiveSheet:Range( "B7" ):Value

         cPoblacion        := oOleExcel:oExcel:ActiveSheet:Range( "B8" ):Value

         cTelefono         := oOleExcel:oExcel:ActiveSheet:Range( "D8" ):Value


         if !Empty( cTelefono ) .AND. ValType( cTelefono ) <> "C"

            cTelefono      := Str( cTelefono )

            if "." $ cTelefono
               cTelefono   := Left( cTelefono, ( At( ".", cTelefono ) - 1 ) )
            end

         end

         if oOleExcel:oExcel:WorkSheets:Count >= 4

            oOleExcel:oExcel:WorkSheets( 4 ):Activate()

            cNif              := oOleExcel:oExcel:ActiveSheet:Range( "E6" ):Value

            if ValType( cNif ) <> "C" .AND. cNif <> nil
               cNif           := Str( cNif )
            end

         end

         oOleExcel:oExcel:WorkBooks:Close()







         if !Empty( cTelefono )

            if "-" $ cTelefono
               nPos                    := At( "-", cTelefono )
               cMovil                  := Right( cTelefono, ( nPos - 1 ) )
               cTelefono               := Left( cTelefono, ( nPos - 1 ) )
            end

            if "/" $ cTelefono
               nPos                    := At( "/", cTelefono )
               cMovil                  := Right( cTelefono, ( nPos - 1 ) )
               cTelefono               := Left( cTelefono, ( nPos - 1 ) )
            end

         end





         if !::oDbfCli:SeekInOrd( Padr( cNombre, 80 ), "TITULO" )

            cNewCodCli              := RJust( NextVal( dbLast( ::oDbfCli, 1 ) ), "0", RetNumCodCliEmp() )

            ::oDbfCli:Append()

            ::oDbfCli:Cod           := cNewCodCli

            if !Empty( cNombre )
               ::oDbfCli:Titulo        := Padr( cNombre, 80 )
            end

            if !Empty( cNif )
               ::oDbfCli:Nif           := Padr( cNif, 15 )
            end

            if !Empty( cDireccion )
               ::oDbfCli:Domicilio     := Padr( cDireccion, 100 )
            end

            if !Empty( cPoblacion )
               ::oDbfCli:Poblacion     := Padr( cPoblacion, 35 )
            end

            if !Empty( cTelefono )
               ::oDbfCli:Telefono      := Padr( AllTrim( cTelefono ), 20 )
            end


            if !Empty( cMovil )
               ::oDbfCli:Movil         := Padr( AllTrim( cMovil ), 20 )
            end



            ::oDbfCli:lSndInt       := .T.
            ::oDbfCli:lModDat       := .F.
            ::oDbfCli:lChgPre       := .T.
            ::oDbfCli:CopiasF       := 1
            ::oDbfCli:nLabel        := 1
            ::oDbfCli:nTarifa       := 1
            ::oDbfCli:nTipCli       := 2
            ::oDbfCli:cDtoEsp       := Padr( "General", 50 )
            ::oDbfCli:cDpp          := Padr( "Pronto pago", 50 )
            ::oDbfCli:cDtoAtp       := Padr( "Atipico", 50 )
            ::oDbfCli:lReq          := .F.
            ::oDbfCli:lMayorista    := .F.
            ::oDbfCli:lBlqCli       := .F.
            ::oDbfCli:lMosCom       := .F.
            ::oDbfCli:nSbrAtp       := 1

            ::oDbfCli:Save()

         end

      end

      cMovil                        := Space( 20 )

      oOleExcel:oExcel:Quit()

      oOleExcel:oExcel:DisplayAlerts   := .T.

      oOleExcel:End()

      RECOVER USING oError

         msgWait( "Error :" + Chr(13)+Chr(10) + ErrorMessage( oError ), 0.1 )

      end
      ErrorBlock( oBlock )

   next

   ::CloseFiles()

RETURN ( Self )
