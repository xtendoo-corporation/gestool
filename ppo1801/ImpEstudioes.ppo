#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 9 ".\.\Prg\ImpEstudioes.prg"
_HB_CLASS TImpEstudio ; function TImpEstudio ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TImpEstudio", iif( .F., { }, { @HBObject() } ), @TImpEstudio() ) ) ;

   _HB_MEMBER { nLevel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nLevel"}, .F. )
   _HB_MEMBER { oDbfArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfArt"}, .F. )
   _HB_MEMBER { oDbfCodeBar } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfCodeBar"}, .F. )
   _HB_MEMBER { oDbfIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfIva"}, .F. )
   _HB_MEMBER { oDbfFam } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfFam"}, .F. )
   _HB_MEMBER { oGrpFam } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGrpFam"}, .F. )
   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )
   _HB_MEMBER { oFld } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFld"}, .F. )
   _HB_MEMBER { cDirOrigen } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cDirOrigen"}, .F. )
   _HB_MEMBER { oTree } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTree"}, .F. )
   _HB_MEMBER { oTreeFile } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTreeFile"}, .F. )
   _HB_MEMBER { oMtrProceso } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMtrProceso"}, .F. )
   _HB_MEMBER { nMtrProceso } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nMtrProceso"}, .F. )
   _HB_MEMBER { oBtnImprimir } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnImprimir"}, .F. )
   _HB_MEMBER { oBtnSiguiente } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnSiguiente"}, .F. )
   _HB_MEMBER { cFilTxt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFilTxt"}, .F. )
   _HB_MEMBER { oCmbTar } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCmbTar"}, .F. )
   _HB_MEMBER { cCmbTar } ; oClass:AddMultiData(, "Tarifa 1", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCmbTar"}, .F. )
   _HB_MEMBER { aCmbTar } ; oClass:AddMultiData(, { "Tarifa 1", "Tarifa 2", "Tarifa 3", "Tarifa 4", "Tarifa 5", "Tarifa 6" }, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aCmbTar"}, .F. )
   _HB_MEMBER { oColCodArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColCodArt"}, .F. )
   _HB_MEMBER { oColNomArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColNomArt"}, .F. )
   _HB_MEMBER { oColCodBar } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColCodBar"}, .F. )
   _HB_MEMBER { oColUniCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColUniCaj"}, .F. )
   _HB_MEMBER { oColpCosto } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColpCosto"}, .F. )
   _HB_MEMBER { oColpVenta } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColpVenta"}, .F. )
   _HB_MEMBER { oColGFamilia } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColGFamilia"}, .F. )
   _HB_MEMBER { oColFamilia } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColFamilia"}, .F. )
   _HB_MEMBER { oColTipoIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oColTipoIva"}, .F. )
   _HB_MEMBER { cColCodArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColCodArt"}, .F. )
   _HB_MEMBER { cColNomArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColNomArt"}, .F. )
   _HB_MEMBER { cColCodBar } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColCodBar"}, .F. )
   _HB_MEMBER { cColUniCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColUniCaj"}, .F. )
   _HB_MEMBER { cColpCosto } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColpCosto"}, .F. )
   _HB_MEMBER { cColpVenta } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColpVenta"}, .F. )
   _HB_MEMBER { lIvaInc } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lIvaInc"}, .F. )
   _HB_MEMBER { cColGFamilia } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColGFamilia"}, .F. )
   _HB_MEMBER { cColFamilia } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColFamilia"}, .F. )
   _HB_MEMBER { cColTipoIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cColTipoIva"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @TImpEstudio_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Create(); oClass:AddInline( "Create", {|Self, oMenuItem, oWnd | ( ( Self ) ), ( if( ::New( oMenuItem, oWnd ) <> nil, ::Activate(), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lOpenFiles(); oClass:AddMethod( "lOpenFiles", @TImpEstudio_lOpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TImpEstudio_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate( oWnd); oClass:AddMethod( "Activate", @TImpEstudio_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER BotonSiguiente(); oClass:AddMethod( "BotonSiguiente", @TImpEstudio_BotonSiguiente(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ImportaHoja(); oClass:AddMethod( "ImportaHoja", @TImpEstudio_ImportaHoja(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GuardarValoresIni(); oClass:AddMethod( "GuardarValoresIni", @TImpEstudio_GuardarValoresIni(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CargarValoresIni(); oClass:AddMethod( "CargarValoresIni", @TImpEstudio_CargarValoresIni(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TImpEstudio ;






static FUNCTION TImpEstudio_New( oMenuItem, oWnd ) ; local Self AS CLASS TImpEstudio := QSelf() AS CLASS TImpEstudio

   If( oMenuItem == nil, oMenuItem := "01102", ) ;

   ::nLevel             := Auth():Level( oMenuItem )

   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

RETURN ( Self )






static FUNCTION TImpEstudio_lOpenFiles( ) ; local Self AS CLASS TImpEstudio := QSelf() AS CLASS TImpEstudio

   local lOpen    := .T.
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

   ::oDbfArt := DbfServer( "ARTICULO.DBF", ):NewOpen( "ARTICULO.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfArt:AddBag( "ARTICULO.CDX" ) ; ::oDbfArt:AddBag( ) ; ::oDbfArt:AutoIndex()

   ::oDbfCodeBar := DbfServer( "ARTCODEBAR.DBF", ):NewOpen( "ARTCODEBAR.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfCodeBar:AddBag( "ARTCODEBAR.CDX" ) ; ::oDbfCodeBar:AddBag( ) ; ::oDbfCodeBar:AutoIndex()

   ::oDbfIva := DbfServer( "TIVA.DBF", ):NewOpen( "TIVA.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfIva:AddBag( "TIVA.CDX" ) ; ::oDbfIva:AddBag( ) ; ::oDbfIva:AutoIndex()

   ::oDbfFam := DbfServer( "FAMILIAS.DBF", ):NewOpen( "FAMILIAS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfFam:AddBag( "FAMILIAS.CDX" ) ; ::oDbfFam:AddBag( ) ; ::oDbfFam:AutoIndex()

   ::oGrpFam := DbfServer( "GRPFAM.DBF", ):NewOpen( "GRPFAM.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oGrpFam:AddBag( "GRPFAM.CDX" ) ; ::oGrpFam:AddBag( ) ; ::oGrpFam:AutoIndex()

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )

      ::CloseFiles()

      lOpen       := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )






static FUNCTION TImpEstudio_CloseFiles( ) ; local Self AS CLASS TImpEstudio := QSelf() AS CLASS TImpEstudio

   if !Empty ( ::oDbfArt )
      ::oDbfArt:End()
   end

   if !Empty ( ::oDbfCodeBar )
      ::oDbfCodeBar:End()
   end

   if !Empty ( ::oDbfIva )
      ::oDbfIva:End()
   end

   if !Empty ( ::oDbfFam )
      ::oDbfFam:End()
   end

   if !Empty( ::oGrpFam )
      ::oGrpFam:End()
   end


   ::oDbfArt     := nil
   ::oDbfCodeBar := nil
   ::oDbfIva     := nil
   ::oDbfFam     := nil
   ::oGrpFam     := nil

RETURN ( Self )






static FUNCTION TImpEstudio_Activate( oWnd ) ; local Self AS CLASS TImpEstudio := QSelf() AS CLASS TImpEstudio

   local oBmp
   local oDirOrigen

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return( Self )
   end

   if ! ::lOpenFiles()
      Return( Self )
   end

   ::CargarValoresIni()

   ::oDlg = TDialog():New(,,,,, "ASS_ESTUDIO",, .F.,,,,, oWnd(), .F.,,,,,, .F.,, "::oDlg", nil, )

      oBmp := TBitmap():ReDefine( 600, "gc_import_48",, ::oDlg,,, .F., .F.,,, .F.,,, .T. )




      ::oFld := TPages():Redefine( 100, ::oDlg, {"ASS_ESTUDIO01", "ASS_ESTUDIO02"},,,, )





      oDirOrigen := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::cDirOrigen, ::cDirOrigen:= u ) }, ::oFld:aDialogs[ 1 ],,,,,,,,, .F.,,, .F., .F.,,,,, {|Self|( oDirOrigen:cText( cGetFile( "*.xls", "Selección de fichero" ) ) )}, nil, "Folder",, )




      ::oCmbTar := TComboBox():ReDefine( 130, { | u | If( PCount()==0, ::cCmbTar, ::cCmbTar:= u ) }, ::aCmbTar, ::oFld:aDialogs[1],,,,,,, .F.,,,,,,, "::oCmbTar",,,,,,, )








      ::oColCodArt := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::cColCodArt, ::cColCodArt:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColCodArt == Space( 1 ) .OR. ( ::cColCodArt >= "A" .AND. ::cColCodArt <= "Z"  ) )},,,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColCodArt ) )}, {||  ( DwSerie( ::oColCodArt ) )},,,, nil,,, )









      ::oColNomArt := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::cColNomArt, ::cColNomArt:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColNomArt == Space( 1 ) .OR. ( ::cColNomArt >= "A" .AND. ::cColNomArt <= "Z"  ) )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColNomArt ) )}, {||  ( DwSerie( ::oColNomArt ) )},,,, nil,,, )









      ::oColCodBar := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::cColCodBar, ::cColCodBar:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColCodBar == Space( 1 ) .OR. ( ::cColCodBar >= "A" .AND. ::cColCodBar <= "Z"  ) )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColCodBar ) )}, {||  ( DwSerie( ::oColCodBar ) )},,,, nil,,, )









      ::oColUniCaj := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::cColUniCaj, ::cColUniCaj:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColUniCaj == Space( 1 ) .OR. ( ::cColUniCaj >= "A" .AND. ::cColUniCaj <= "Z"  ) )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColUniCaj ) )}, {||  ( DwSerie( ::oColUniCaj ) )},,,, nil,,, )









      ::oColpCosto := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::cColpCosto, ::cColpCosto:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColpCosto == Space( 1 ) .OR.  ( ::cColpCosto >= "A" .AND. ::cColpCosto <= "Z"  ) )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColpCosto ) )}, {||  ( DwSerie( ::oColpCosto ) )},,,, nil,,, )









      ::oColpVenta := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::cColpVenta, ::cColpVenta:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColpVenta == Space( 1 ) .OR. ( ::cColpVenta >= "A" .AND. ::cColpVenta <= "Z"  ) )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColpVenta ) )}, {||  ( DwSerie( ::oColpVenta ) )},,,, nil,,, )



      TCheckBox():ReDefine( 191, { | u | If( PCount()==0, ::lIvaInc, ::lIvaInc:= u ) }, ::oFld:aDialogs[1],,,,,,, .F.,, .F. )









      ::oColGFamilia := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::cColGFamilia, ::cColGFamilia:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColGFamilia == Space( 1 ) .OR. ( ::cColGFamilia >= "A" .AND. ::cColGFamilia <= "Z"  ) )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColGFamilia ) )}, {||  ( DwSerie( ::oColGFamilia ) )},,,, nil,,, )









      ::oColFamilia := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::cColFamilia, ::cColFamilia:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColFamilia == Space( 1 ) .OR. ( ::cColFamilia >= "A" .AND. ::cColFamilia <= "Z"  ) )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColFamilia ) )}, {||  ( DwSerie( ::oColFamilia ) )},,,, nil,,, )









      ::oColTipoIva := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::cColTipoIva, ::cColTipoIva:= u ) }, ::oFld:aDialogs[1],, "@!", {||    ( ::cColTipoIva == Space( 1 ) .OR. ( ::cColTipoIva >= "A" .AND. ::cColTipoIva <= "Z"  ) )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oColTipoIva ) )}, {||  ( DwSerie( ::oColTipoIva ) )},,,, nil,,, )

      ::oTree     := TTreeView():Redefine( 100, ::oFld:aDialogs[ 2 ] )






::oMtrProceso := TApoloMeter():ReDefine( 110, { | u | If( PCount()==0, ::nMtrProceso, ::nMtrProceso:= u ) }, 100, ::oFld:aDialogs[ 2 ], .F.,, "Procesando", .F.,,,, )








       ::oBtnSiguiente := TButton():ReDefine( 510, {||( ::BotonSiguiente() )}, ::oDlg,,, .F.,,,, .F. )




      ::oBtnImprimir := TButton():ReDefine( 520, {||( WinExec( "notepad.exe " + AllTrim( ::cFilTxt ) ) )}, ::oDlg,,, .F.,,,, .F. )

   ::oDlg:bStart  := {|| ::oBtnImprimir:Hide() }

   ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

   ::GuardarValoresIni()

   ::CloseFiles()

   oBmp:End()

RETURN ( Self )




static FUNCTION TImpEstudio_BotonSiguiente( ) ; local Self AS CLASS TImpEstudio := QSelf() AS CLASS TImpEstudio

   do case
      case ::oFld:nOption == 1

         if Empty( ::cDirOrigen )
            MsgStop( "El archivo origen no puede estar vacío" )
            Return .F.
         end

         ::oFld:GoNext()

         ::ImportaHoja()

      case ::oFld:nOption == 2

         ::oDlg:End()

   end

RETURN ( Self )



static FUNCTION TImpEstudio_ImportaHoja( ) ; local Self AS CLASS TImpEstudio := QSelf() AS CLASS TImpEstudio

   local n
   local nPos        := 0
   local nIva
   local nCosto
   local pVenta
   local oBlock
   local oError
   local cCodArt
   local cNomArt
   local cCodBar
   local cCodNew
   local hFilTxt
   local nUniCaja
   local oOleExcel
   local cCodGFamilia
   local cCodFamilia
   local cGrupoFamilia
   local cFamilia
   local nLinesBlank := 0
   local cNewFam     := Space( 8 )
   local cNewGrpFam  := Space( 3 )
   local nTipoIva
   local cCodIva





   SetWindowText( ::oBtnSiguiente:hWnd, "Procesando..." )

   ::oDlg:Disable()












   ::cFilTxt    := cGetNewFileName( cPatLog() + "IMP" + Dtos( Date() ) + StrTran( Time(), ":", "" ) ) + ".txt"
   hFilTxt      := fCreate( ::cFilTxt )

   if Empty( hFilTxt )
      hFilTxt        := fOpen( ::cFilTxt, 1 )
   endif

   if File( ::cDirOrigen )

      fWrite( hFilTxt, "Procesando " + ::cDirOrigen + Chr(13)+Chr(10) )

      ::oTreeFile    := ::oTree:Add( "Procesando " + ::cDirOrigen )
      ::oTreeFile:Expand()





      oOleExcel                        := TOleExcel():New( "Importando hoja de excel", "Conectando...", .F. )

      oOleExcel:oExcel:Visible         := .F.
      oOleExcel:oExcel:DisplayAlerts   := .F.
      oOleExcel:oExcel:WorkBooks:Open( ::cDirOrigen )

      oOleExcel:oExcel:WorkSheets( 1 ):Activate()





      ::oMtrProceso:SetTotal( 65536 )

      SysRefresh()

      for n := 2 to 65536

         if !Empty( ::cColCodArt )
            cCodArt     := Padr( oOleExcel:oExcel:ActiveSheet:Range( ::cColCodArt + lTrim( Str( n ) ) ):Value, 18 )

            nPos        := at( ".", cCodArt )
            if nPos <> 0
               cCodArt     := SubStr( cCodArt, 1, nPos - 1 )
            end

         end

         cCodArt        := Alltrim( cValToChar( cCodArt) )

         if !Empty( ::cColNomArt )
            cNomArt     := oOleExcel:oExcel:ActiveSheet:Range( ::cColNomArt + lTrim( Str( n ) ) ):Value
         end
         cNomArt        := AllTrim( cValToChar( cNomArt ) )





         if !Empty( ::cColCodBar )
            cCodBar     := oOleExcel:oExcel:ActiveSheet:Range( ::cColCodBar + lTrim( Str( n ) ) ):Value
         end

         if Valtype( cCodBar ) == "N"
            cCodBar     := Int( cCodBar )
         end

         cCodBar        := AllTrim( cValToChar( cCodBar ) )

         if !Empty( ::cColpVenta )
            pVenta      := oOleExcel:oExcel:ActiveSheet:Range( ::cColpVenta + lTrim( Str( n ) ) ):Value
         else
            pVenta      := 0
         end

         if Empty( pVenta )
            pVenta      := 0
         end

         if Valtype( pVenta ) == "C"
            pVenta      := Val( StrTran( pVenta, ",", "." ) )
         end

         if !Empty( ::cColpCosto )
            nCosto      := oOleExcel:oExcel:ActiveSheet:Range( ::cColpCosto + lTrim( Str( n ) ) ):Value
         end

         do case
            case Valtype( nCosto ) == "C"

               nCosto      := Val( StrTran( nCosto, ",", "." ) )

            case Valtype( nCosto ) <> "N"

               nCosto      := 0

         end

         if !Empty( ::cColUniCaj )
            nUniCaja    := oOleExcel:oExcel:ActiveSheet:Range( ::cColUniCaj + lTrim( Str( n ) ) ):Value
         end

         if Empty( nUniCaja )
            nUniCaja    := 0
         end

         if Valtype( nUniCaja ) == "C"
            nUniCaja    := Val( StrTran( nUniCaja, ",", "." ) )
         end

         if !Empty( ::cColGFamilia )
            cGrupoFamilia  := oOleExcel:oExcel:ActiveSheet:Range( ::cColGFamilia + lTrim( Str( n ) ) ):Value
         end

         cGrupoFamilia  := Alltrim( cValToChar( cGrupoFamilia ) )

         if !Empty( ::cColFamilia )
            cFamilia    := oOleExcel:oExcel:ActiveSheet:Range( ::cColFamilia + lTrim( Str( n ) ) ):Value
         end

         cFamilia       := Alltrim( cValToChar( cFamilia ) )

         if !Empty( ::cColTipoIva )
            nTipoIva    := oOleExcel:oExcel:ActiveSheet:Range( ::cColTipoIva + lTrim( Str( n ) ) ):Value
         else
            nTipoIva    := 21
         end

         if Valtype( nTipoIva ) == "N" .AND. nTipoIva <> 0
            nIva           := nTipoIva / 100
            cCodIva        := cCodigoIva( ::oDbfIva:cAlias, nTipoIva )
         else
            nIva           := nIva( ::oDbfIva, cDefIva() ) / 100
            cCodIva        := cDefIva()
         end

         if !Empty( cCodArt )

            nLinesBlank := 0





            if Empty( cFamilia )

               fWrite( hFilTxt, "El artículo " + AllTrim( cCodArt ) + " - " + AllTrim( cNomArt ) + "no tiene familia" + Chr(13)+Chr(10) )
               ::oTree:Select( ::oTreeFile:Add( "El artículo " + AllTrim( cCodArt ) + " - " + AllTrim( cNomArt ) + "no tiene familia" ) )

            else





               if !::oGrpFam:SeekInOrd( Upper( Padr( cGrupoFamilia, 30 ) ), "CNOMGRP" )

                  cNewGrpFam           := RJust( NextVal( dbLast( ::oGrpFam, 1 ) ), "0", 3 )

                  ::oGrpFam:Append()

                  ::oGrpFam:cCodGrp    := cNewGrpFam
                  ::oGrpFam:cNomGrp    := Upper( Padr( cGrupoFamilia, 30 ) )
                  ::oGrpFam:lPubInt    := .F.

                  ::oGrpFam:Save()

                  fWrite( hFilTxt, "Añadido grupo de familia " + AllTrim( cNewGrpFam ) + " - " + AllTrim( Upper( cGrupoFamilia ) ) + Chr(13)+Chr(10) )
                  ::oTree:Select( ::oTreeFile:Add( "Añadido grupo de familia " + AllTrim( cNewGrpFam ) + " - " + AllTrim( Upper( cGrupoFamilia ) ) ) )

               else

                  cNewGrpFam           := ::oGrpFam:cCodGrp

               end





               if !::oDbfFam:SeekInOrd( Upper( Padr( cFamilia, 40 ) ), "CNOMFAM" )

                  cNewFam              := RJust( NextVal( Rtrim( dbLast( ::oDbfFam, 1 ) ) ), "0", 8 )

                  ::oDbfFam:Append()

                  ::oDbfFam:cCodFam    := cNewFam
                  ::oDbfFam:cNomFam    := Upper( Padr( cFamilia, 40 ) )
                  ::oDbfFam:cCodGrp    := cNewGrpFam
                  ::oDbfFam:lIncTpv    := .F.
                  ::oDbfFam:lPubInt    := .F.

                  ::oDbfFam:Save()

                  fWrite( hFilTxt, "Añadida familia: " + AllTrim( cNewFam ) + " - " + AllTrim( Upper( cFamilia ) ) + Chr(13)+Chr(10) )
                  ::oTree:Select( ::oTreeFile:Add( "Añadida familia: " + AllTrim( cNewFam ) + " - " + AllTrim( Upper( cFamilia ) ) ) )

               else

                  cNewFam           := ::oDbfFam:cCodFam

               end


            end






























            if !::oDbfArt:Seek( cCodArt )





               ::oDbfArt:Append()

               ::oDbfArt:Codigo     := cCodArt
               ::oDbfArt:Nombre     := cNomArt

               ::oDbfArt:nLabel     := 1
               ::oDbfArt:nCtlStock  := 1
               ::oDbfArt:lLote      := .F.
               ::oDbfArt:TipoIva    := cCodIva

               if ValType( nUniCaja ) <> "N"
                  ::oDbfArt:nUniCaja   := Val( nUniCaja )
               else
                  ::oDbfArt:nUniCaja   := nUniCaja
               end

               ::oDbfArt:Familia    := cNewFam

               if !Empty( cCodBar )

                  cCodNew                    := cCodBar

                  while .T.

                     ::oDbfArt:CodeBar       := cCodNew
                     ::oDbfArt:nTipBar       := 1

                     ::oDbfCodeBar:Append()
                     ::oDbfCodeBar:cCodArt   := cCodArt
                     ::oDbfCodeBar:cCodBar   := cCodNew
                     ::oDbfCodeBar:nTipBar   := 1
                     ::oDbfCodeBar:lDefBar   := .T.
                     ::oDbfCodeBar:Save()

                     if SubStr( cCodNew, 1, 1 ) == "0"
                        cCodNew              := SubStr( cCodNew, 2 )
                     else
                        exit
                     end

                  end

               else

                  ::oDbfArt:CodeBar       := Space( 18 )
                  ::oDbfArt:nTipBar       := 1

               end



               ::oDbfArt:pCosto     := nCosto

               if pVenta <> 0

                  do case
                     case ::oCmbTar:nAt == 1

                           if nCosto <> 0
                              ::oDbfArt:Benef1  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end
                           ::oDbfArt:lBnf1      := .F.
                           ::oDbfArt:nBnfSbr1   := 1

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva1   := pVenta
                              ::oDbfArt:pVenta1    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta1    := pVenta
                              ::oDbfArt:pVtaIva1   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 2

                           if nCosto <> 0
                              ::oDbfArt:Benef2  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf2      := .F.
                           ::oDbfArt:nBnfSbr2   := 1

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva2   := pVenta
                              ::oDbfArt:pVenta2    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta2    := pVenta
                              ::oDbfArt:pVtaIva2   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 3

                           if nCosto <> 0
                              ::oDbfArt:Benef3  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf3      := .F.
                           ::oDbfArt:nBnfSbr3   := 1

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva3   := pVenta
                              ::oDbfArt:pVenta3    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta3    := pVenta
                              ::oDbfArt:pVtaIva3   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 4

                           if nCosto <> 0
                              ::oDbfArt:Benef4  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf4      := .F.
                           ::oDbfArt:nBnfSbr4   := 1

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva4   := pVenta
                              ::oDbfArt:pVenta4    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta4    := pVenta
                              ::oDbfArt:pVtaIva4   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 5

                           if nCosto <> 0
                              ::oDbfArt:Benef5  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf5      := .F.
                           ::oDbfArt:nBnfSbr5   := 1

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva5   := pVenta
                              ::oDbfArt:pVenta5    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta5    := pVenta
                              ::oDbfArt:pVtaIva5   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 6

                           if nCosto <> 0
                              ::oDbfArt:Benef6  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf6      := .F.
                           ::oDbfArt:nBnfSbr6   := 1

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva6   := pVenta
                              ::oDbfArt:pVenta6    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta6    := pVenta
                              ::oDbfArt:pVtaIva6   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                  end

               end

               ::oDbfArt:Save()

               fWrite( hFilTxt, "Añadido artículo " + AllTrim( cCodArt ) + " - " + AllTRim( cNomArt ) + Chr(13)+Chr(10) )
               ::oTree:Select( ::oTreeFile:Add( "Añadido artículo " + AllTrim( cCodArt ) + " - " + AllTRim( cNomArt ) ) )

            else





               ::oDbfArt:Load()

               if ValType( nUniCaja ) <> "N"
                  ::oDbfArt:nUniCaja   := Val( nUniCaja )
               else
                  ::oDbfArt:nUniCaja   := nUniCaja
               end
               ::oDbfArt:Familia       := cNewFam





               if !Empty( cCodBar ) .AND. Rtrim( ::oDbfArt:CodeBar ) <> Rtrim( cCodBar )

                  ::oDbfArt:CodeBar    := cCodBar
                  ::oDbfArt:nTipBar    := 1

                  if ::oDbfCodeBar:Seek( cCodArt )

                     while ::oDbfCodeBar:cCodArt == cCodArt .AND. !::oDbfCodeBar:Eof()

                        ::oDbfCodeBar:Load()
                        ::oDbfCodeBar:lDefBar   := .F.
                        ::oDbfCodeBar:Save()

                        ::oDbfCodeBar:Skip()

                     end

                  end

                  ::oDbfCodeBar:Append()

                  ::oDbfCodeBar:cCodArt   := cCodArt
                  ::oDbfCodeBar:cCodBar   := cCodBar
                  ::oDbfCodeBar:nTipBar   := 1
                  ::oDbfCodeBar:lDefBar   := .T.

                  ::oDbfCodeBar:Save()

               end





               ::oDbfArt:pCosto        := nCosto

               if pVenta <> 0

                  do case
                     case ::oCmbTar:nAt == 1

                           if nCosto <> 0
                              ::oDbfArt:Benef1  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf1      := .F.

                           if ::lIvaInc

                              ::oDbfArt:pVtaIva1   := pVenta
                              ::oDbfArt:pVenta1    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta1    := pVenta
                              ::oDbfArt:pVtaIva1   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 2

                           if nCosto <> 0
                              ::oDbfArt:Benef2  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf2      := .F.

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva2   := pVenta
                              ::oDbfArt:pVenta2    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta2    := pVenta
                              ::oDbfArt:pVtaIva2   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 3

                           if nCosto <> 0
                              ::oDbfArt:Benef3  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf3      := .F.

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva3   := pVenta
                              ::oDbfArt:pVenta3    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta3    := pVenta
                              ::oDbfArt:pVtaIva3   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 4

                           if nCosto <> 0
                              ::oDbfArt:Benef4  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf4      := .F.

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva4   := pVenta
                              ::oDbfArt:pVenta4    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta4    := pVenta
                              ::oDbfArt:pVtaIva4   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 5

                           if nCosto <> 0
                              ::oDbfArt:Benef5  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf5      := .F.

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva5   := pVenta
                              ::oDbfArt:pVenta5    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta5    := pVenta
                              ::oDbfArt:pVtaIva5   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                     case ::oCmbTar:nAt == 6

                           if nCosto <> 0
                              ::oDbfArt:Benef6  := ( Div( pVenta, nCosto ) - 1 ) * 100
                           end

                           ::oDbfArt:lBnf6      := .F.

                           if ::lIvaInc
                              ::oDbfArt:pVtaIva6   := pVenta
                              ::oDbfArt:pVenta6    := pVenta / ( 1 + nIva )
                           else
                              ::oDbfArt:pVenta6    := pVenta
                              ::oDbfArt:pVtaIva6   := Round( ( pVenta * nIva ) + pVenta, 0 )
                           end

                  end

               end

               ::oDbfArt:Save()

               fWrite( hFilTxt, "Reemplazado artículo " + AllTrim( cCodArt ) + " - " + AllTRim( cNomArt ) + Chr(13)+Chr(10) )
               ::oTree:Select( ::oTreeFile:Add( "Reemplazado artículo " + AllTrim( cCodArt ) + " - " + AllTRim( cNomArt ) ) )

            end

         else

            ++nLinesBlank

         end

         ::oMtrProceso:Set( n )

         SysRefresh()

         if nLinesBlank > 100
            exit
         end

      next

      ::oMtrProceso:Set( 65536 )





      oOleExcel:oExcel:WorkBooks:Close()

      oOleExcel:oExcel:Quit()

      oOleExcel:oExcel:DisplayAlerts := .T.

      oOleExcel:End()

   else

      fWrite( hFilTxt, "El fichero seleccionado para importar no es válido" )
      ::oTreeFile    := ::oTree:Add( "El fichero seleccionado para importar no es válido" )

   end





   fClose( hFilTxt )

















   ::oDlg:Enable()

   SetWindowText( ::oBtnSiguiente:hWnd, "&Cerrar" )

   ::oBtnImprimir:Show()

RETURN ( Self )






static FUNCTION TImpEstudio_GuardarValoresIni( ) ; local Self AS CLASS TImpEstudio := QSelf() AS CLASS TImpEstudio

   local oIniApp
   local cIniApp  := cIniEmpresa()

   oIniApp := TIni():New( cIniApp )

      oIniApp:Set( "Importacion", "Tarifa", ::cCmbTar )
      oIniApp:Set( "Importacion", "CodArt", ::cColCodArt )
      oIniApp:Set( "Importacion", "NomArt", ::cColNomArt )
      oIniApp:Set( "Importacion", "CodBar", ::cColCodBar )
      oIniApp:Set( "Importacion", "UniCaj", ::cColUniCaj )
      oIniApp:Set( "Importacion", "pCosto", ::cColpCosto )
      oIniApp:Set( "Importacion", "pVenta", ::cColpVenta )
      oIniApp:Set( "Importacion", "GFamilia", ::cColGFamilia )
      oIniApp:Set( "Importacion", "Familia", ::cColFamilia )
      oIniApp:Set( "Importacion", "TipoIva", ::cColTipoIva )



RETURN ( Self )






static FUNCTION TImpEstudio_CargarValoresIni( ) ; local Self AS CLASS TImpEstudio := QSelf() AS CLASS TImpEstudio

   local oIniApp
   local cIniApp  := cIniEmpresa()

   oIniApp := TIni():New( cIniApp )

      ::cCmbTar := oIniApp:Get( "Importacion", "Tarifa", "Tarifa 1", ::cCmbTar )
      ::cColCodArt := oIniApp:Get( "Importacion", "CodArt", "A", ::cColCodArt )
      ::cColNomArt := oIniApp:Get( "Importacion", "NomArt", "B", ::cColNomArt )
      ::cColCodBar := oIniApp:Get( "Importacion", "CodBar", "K", ::cColCodBar )
      ::cColUniCaj := oIniApp:Get( "Importacion", "UniCaj", "C", ::cColUniCaj )
      ::cColpCosto := oIniApp:Get( "Importacion", "pCosto", "H", ::cColpCosto )
      ::cColpVenta := oIniApp:Get( "Importacion", "pVenta", "D", ::cColpVenta )
      ::cColGFamilia := oIniApp:Get( "Importacion", "GFamilia", "O", ::cColGFamilia )
      ::cColFamilia := oIniApp:Get( "Importacion", "Familia", "P", ::cColFamilia )
      ::cColTipoIva := oIniApp:Get( "Importacion", "TipoIva", "Q", ::cColTipoIva )



   if Empty( ::cColCodArt   )
      ::cColCodArt   := Space( 1 )
   end

   if Empty( ::cColNomArt   )
      ::cColNomArt   := Space( 1 )
   end

   if Empty( ::cColCodBar   )
      ::cColCodBar   := Space( 1 )
   end

   if Empty( ::cColUniCaj   )
      ::cColUniCaj   := Space( 1 )
   end

   if Empty( ::cColpCosto   )
      ::cColpCosto   := Space( 1 )
   end

   if Empty( ::cColpVenta   )
      ::cColpVenta   := Space( 1 )
   end

   if Empty( ::cColGFamilia )
      ::cColGFamilia := Space( 1 )
   end

   if Empty( ::cColFamilia  )
      ::cColFamilia  := Space( 1 )
   end

   if Empty( ::cColTipoIva  )
      ::cColTipoIva  := Space( 1 )
   end

   ::lIvaInc         := .F.

RETURN ( Self )
