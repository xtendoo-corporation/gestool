#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 11 ".\.\Prg\ImportLatress.prg"
FUNCTION ImpLatress( oMenuItem, oWnd )

   local oImpLatress
   local nLevel   := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return ( nil )
   end

   oImpLatress       := ImportLatress():New():Resource()

RETURN nil







_HB_CLASS ImportLatress ; function ImportLatress ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "ImportLatress", iif( .F., { }, { @HBObject() } ), @ImportLatress() ) ) ;

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )
   _HB_MEMBER { nView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nView"}, .F. )

   _HB_MEMBER { oDireccion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDireccion"}, .F. )
   _HB_MEMBER { oUsuario } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oUsuario"}, .F. )
   _HB_MEMBER { oClave } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oClave"}, .F. )

   _HB_MEMBER { cDireccion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cDireccion"}, .F. )
   _HB_MEMBER { cUsuario } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cUsuario"}, .F. )
   _HB_MEMBER { cClave } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cClave"}, .F. )

   _HB_MEMBER { cWebImagen } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cWebImagen"}, .F. )

   _HB_MEMBER { oArticulos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oArticulos"}, .F. )
   _HB_MEMBER { cArticulos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cArticulos"}, .F. )

   _HB_MEMBER { oFamilias } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFamilias"}, .F. )
   _HB_MEMBER { cFamilias } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFamilias"}, .F. )

   _HB_MEMBER { oPropiedades } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPropiedades"}, .F. )
   _HB_MEMBER { cPropiedades } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPropiedades"}, .F. )

   _HB_MEMBER { oClientes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oClientes"}, .F. )
   _HB_MEMBER { cClientes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cClientes"}, .F. )

   _HB_MEMBER { oPedidos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPedidos"}, .F. )
   _HB_MEMBER { cPedidos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPedidos"}, .F. )

   _HB_MEMBER { oSayProcess } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayProcess"}, .F. )

   _HB_MEMBER { aProductos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aProductos"}, .F. )

   _HB_MEMBER { cSerie } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerie"}, .F. )
   _HB_MEMBER { nNumero } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumero"}, .F. )
   _HB_MEMBER { cSufijo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijo"}, .F. )
   _HB_MEMBER { cCodCli } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodCli"}, .F. )
   _HB_MEMBER { dFecPed } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFecPed"}, .F. )
   _HB_MEMBER { hProvincias } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"hProvincias"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @ImportLatress_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource(); oClass:AddMethod( "Resource", @ImportLatress_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setProcessText(); oClass:AddInline( "setProcessText", {|Self, cText | ( ( Self ) ), ( if( !Empty( ::oSayProcess ), ( ::oSayProcess:SetText( cText ), ::oSayProcess:Refresh(), sysrefresh() ), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Importar(); oClass:AddMethod( "Importar", @ImportLatress_Importar(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER addFamilias(); oClass:AddMethod( "addFamilias", @ImportLatress_addFamilias(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addFamilia(); oClass:AddMethod( "addFamilia", @ImportLatress_addFamilia(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER updateFamilia(); oClass:AddMethod( "updateFamilia", @ImportLatress_updateFamilia(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER addPropiedades(); oClass:AddMethod( "addPropiedades", @ImportLatress_addPropiedades(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addPropiedad( aPropiedad); oClass:AddMethod( "addPropiedad", @ImportLatress_addPropiedad(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER updatePropiedad( aPropiedad); oClass:AddMethod( "updatePropiedad", @ImportLatress_updatePropiedad(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addPropiedadLine( aPropiedadLine); oClass:AddMethod( "addPropiedadLine", @ImportLatress_addPropiedadLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER updatePropiedadLine( aPropiedadLine); oClass:AddMethod( "updatePropiedadLine", @ImportLatress_updatePropiedadLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER addArticulos(); oClass:AddMethod( "addArticulos", @ImportLatress_addArticulos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addArticulo(); oClass:AddMethod( "addArticulo", @ImportLatress_addArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER updateArticulo(); oClass:AddMethod( "updateArticulo", @ImportLatress_updateArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER addOneArticulo(); oClass:AddMethod( "addOneArticulo", @ImportLatress_addOneArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER addVariations(); oClass:AddMethod( "addVariations", @ImportLatress_addVariations(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER addClientes(); oClass:AddMethod( "addClientes", @ImportLatress_addClientes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addCliente( hCliente); oClass:AddMethod( "addCliente", @ImportLatress_addCliente(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addClienteNotReg( hCliente); oClass:AddMethod( "addClienteNotReg", @ImportLatress_addClienteNotReg(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER addPedidos(); oClass:AddMethod( "addPedidos", @ImportLatress_addPedidos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addPedido( hPedido); oClass:AddMethod( "addPedido", @ImportLatress_addPedido(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addLineaPedido( hLinea); oClass:AddMethod( "addLineaPedido", @ImportLatress_addLineaPedido(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ActualizaStock( hPropiedades); oClass:AddMethod( "ActualizaStock", @ImportLatress_ActualizaStock(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getProductosWp(); oClass:AddMethod( "getProductosWp", @ImportLatress_getProductosWp(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getidProductWp( cCodArt); oClass:AddMethod( "getidProductWp", @ImportLatress_getidProductWp(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER addFtpImage( cFile); oClass:AddMethod( "addFtpImage", @ImportLatress_addFtpImage(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cleanFtp(); oClass:AddMethod( "cleanFtp", @ImportLatress_cleanFtp(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GetProv( cProv); oClass:AddMethod( "GetProv", @ImportLatress_GetProv(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ActStockArticulo( cId, cCodArt); oClass:AddMethod( "ActStockArticulo", @ImportLatress_ActStockArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER activateArticulo( cId); oClass:AddMethod( "activateArticulo", @ImportLatress_activateArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER desactivateArticulo( cId); oClass:AddMethod( "desactivateArticulo", @ImportLatress_desactivateArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getArticulo( cId); oClass:AddMethod( "getArticulo", @ImportLatress_getArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER saveConfig(); oClass:AddMethod( "saveConfig", @ImportLatress_saveConfig(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Prueba(); oClass:AddMethod( "Prueba", @ImportLatress_Prueba(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS ImportLatress ;



static FUNCTION ImportLatress_New( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   ::cDireccion      := "https://perfectainvitada.es/"
   ::cUsuario        := "ck_66c156d66673cd6da0fead5d720cb3b06b1d771d"
   ::cClave          := "cs_4cb3ddb87d4b2c9da1b4e39066c30bb7ff61a33d"






   ::cArticulos      := padr( ConfiguracionesEmpresaModel():getValue( "articulosWP", "wp-json/wc/v3/products" ), 200 )
   ::cFamilias       := padr( ConfiguracionesEmpresaModel():getValue( "familiasWP", "wp-json/wc/v3/products/categories" ), 200 )
   ::cPropiedades    := padr( ConfiguracionesEmpresaModel():getValue( "propiedadesWP", "wp-json/wc/v3/products/attributes" ), 200 )
   ::cClientes       := padr( ConfiguracionesEmpresaModel():getValue( "clientesWP", "wp-json/wc/v3/customers" ), 200 )
   ::cPedidos        := padr( ConfiguracionesEmpresaModel():getValue( "pedidosWP", "wp-json/wc/v3/orders" ), 200 )
   ::cWebImagen      := padr( ConfiguracionesEmpresaModel():getValue( "imagenesWP", "https://gestool.es/imageneswp/" ), 200 )

   ::cSerie          := ""
   ::nNumero         := 0
   ::cSufijo         := ""
   ::cCodCli         := ""
   ::dFecPed         := Stod( "" )

   ::hProvincias     := {=>}
   hSet( ::hProvincias, "VI", "Álava" )
   hSet( ::hProvincias, "AB", "Albacete" )
   hSet( ::hProvincias, "A" , "Alicante" )
   hSet( ::hProvincias, "AL", "Almería" )
   hSet( ::hProvincias, "AV", "Ávila" )
   hSet( ::hProvincias, "BA", "Badajoz" )
   hSet( ::hProvincias, "B" , "Barcelona" )
   hSet( ::hProvincias, "BU", "Burgos" )
   hSet( ::hProvincias, "CC", "Cáceres" )
   hSet( ::hProvincias, "CA", "Cádiz" )
   hSet( ::hProvincias, "CS", "Castellón" )
   hSet( ::hProvincias, "CR", "Ciudad Real" )
   hSet( ::hProvincias, "CO", "Córdoba" )
   hSet( ::hProvincias, "C" , "La Coruña" )
   hSet( ::hProvincias, "CU", "Cuenca" )
   hSet( ::hProvincias, "GE", "Gerona" )
   hSet( ::hProvincias, "GR", "Granada" )
   hSet( ::hProvincias, "GU", "Guadalajara" )
   hSet( ::hProvincias, "SS", "Guipúzcoa" )
   hSet( ::hProvincias, "H" , "Huelva" )
   hSet( ::hProvincias, "HU", "Huesca" )
   hSet( ::hProvincias, "J" , "Jaén" )
   hSet( ::hProvincias, "LE", "León" )
   hSet( ::hProvincias, "L" , "Lérida" )
   hSet( ::hProvincias, "LO", "La Rioja" )
   hSet( ::hProvincias, "LU", "Lugo" )
   hSet( ::hProvincias, "M" , "Madrid" )
   hSet( ::hProvincias, "MA", "Málaga" )
   hSet( ::hProvincias, "MU", "Murcia" )
   hSet( ::hProvincias, "NA", "Navarra" )
   hSet( ::hProvincias, "OR", "Orense" )
   hSet( ::hProvincias, "O" , "Asturias" )
   hSet( ::hProvincias, "P" , "Palencia" )
   hSet( ::hProvincias, "GC", "Las Palmas" )
   hSet( ::hProvincias, "PO", "Pontevedra" )
   hSet( ::hProvincias, "SA", "Salamanca" )
   hSet( ::hProvincias, "TF", "Santa Cruz de Tenerife" )
   hSet( ::hProvincias, "S" , "Cantabria" )
   hSet( ::hProvincias, "SG", "Segovia" )
   hSet( ::hProvincias, "SE", "Sevilla" )
   hSet( ::hProvincias, "SO", "Soria" )
   hSet( ::hProvincias, "T" , "Tarragona" )
   hSet( ::hProvincias, "TE", "Teruel" )
   hSet( ::hProvincias, "TO", "Toledo" )
   hSet( ::hProvincias, "V" , "Valencia" )
   hSet( ::hProvincias, "VA", "Valladolid" )
   hSet( ::hProvincias, "BI", "Vizcaya" )
   hSet( ::hProvincias, "ZA", "Zamora" )
   hSet( ::hProvincias, "Z" , "Zaragoza" )
   hSet( ::hProvincias, "CE", "Ceuta" )
   hSet( ::hProvincias, "ML", "Melilla" )

   ::aProductos      := {}

   ::nView           := D():CreateView()

RETURN ( Self )



static FUNCTION ImportLatress_Resource( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oBmp

   if oWnd() <> nil
      oWnd():CloseAll()
   end

   ::oDlg = TDialog():New(,,,, "Conexión Web-Services con WordPress", "IMPWP",, .F.,,,,, oWnd(), .F.,,,,,, .F.,, "::oDlg", nil, )

      oBmp := TBitmap():ReDefine( 600, "WORDPRESS_48",, ::oDlg,,, .F., .F.,,, .F.,,, .T. )

      ::oDireccion := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::cDireccion, ::cDireccion:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )
      ::oUsuario := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cUsuario, ::cUsuario:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )
      ::oClave := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::cClave, ::cClave:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )

      ::oArticulos := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cArticulos, ::cArticulos:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )
      TBtnBmp():ReDefine( 131, "GC_IMPORT_16",,,,,{|| ::addArticulos() }, ::oDlg, .F., , .F.,  )

      ::oFamilias := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::cFamilias, ::cFamilias:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )
      TBtnBmp():ReDefine( 141, "GC_IMPORT_16",,,,,{|| ::addFamilias() }, ::oDlg, .F., , .F.,  )

      ::oPropiedades := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::cPropiedades, ::cPropiedades:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )
      TBtnBmp():ReDefine( 151, "GC_IMPORT_16",,,,,{|| ::addPropiedades() }, ::oDlg, .F., , .F.,  )

      ::oClientes := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::cClientes, ::cClientes:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )
      TBtnBmp():ReDefine( 161, "GC_IMPORT_16",,,,,{|| ::addClientes() }, ::oDlg, .F., , .F.,  )

      ::oPedidos := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::cPedidos, ::cPedidos:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )
      TBtnBmp():ReDefine( 171, "GC_IMPORT_16",,,,,{|| ::Prueba() }, ::oDlg, .F., , .F.,  )

      ::oSayProcess := TSay():ReDefine( 700,, ::oDlg,,,, .F.,, .F., .F., )

      TButton():ReDefine( 2, {||( ::oDlg:end() )}, ::oDlg,,, .F.,,,, .F. )

   ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

   D():DeleteView( ::nView )

   oBmp:End()

   ::saveConfig()

RETURN ( Self )



static FUNCTION ImportLatress_Prueba( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult           := {}
   local hJson             := {=>}
   local cJson

   Msginfo( "entro a probar" )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos ) + "/7608" )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "GET" )
   Msginfo( oWebService:cUrl, "cUrl" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   Msginfo( oWebService:cUrl, "cUrl" )
   oWebService:Send()

   Msginfo( oWebService:getStatus(), "getStatus" )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      Msginfo( "Conexión correcta: artículo creado" )
      MsgInfo( hResult, Valtype( hResult ) )
      MsgInfo( hb_valToExp( hResult ), "hResult" )
      logwrite( hb_valToExp( hResult ) )
   else
      Msginfo( "Fallo de comunicación." )
   end

   oWebService:End()

   Msginfo( "Salgo de la prueba" )

RETURN ( Self )



static FUNCTION ImportLatress_Importar( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local aJson
   local aPropiedades      := {}

   aPropiedades            := ArticulosPrecios():listWpCode()

   if Len( aPropiedades ) > 0
      aEval( aPropiedades, {|h| ::ActualizaStock( h ) } )
   end

   ::setProcessText( "Proceso terminado con éxito" )

RETURN ( Self )



static FUNCTION ImportLatress_addFamilias( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local aListFamilia := FamiliasModel():getListToWP()

   if Len( aListFamilia ) > 0
      aEval( aListFamilia, {|a| if( Empty( hGet( a, "CIDWP" ) ), ::addFamilia( a ), ::UpdateFamilia( a ) ) } )
   end

RETURN ( self )



static FUNCTION ImportLatress_addFamilia( aFamilia ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult           := {}
   local hJson             := {=>}
   local cJson

   ::setProcessText( "Añadiendo familia " + AllTrim( hGet( aFamilia, "CNOMFAM" ) ) + " - " + AllTrim( hGet( aFamilia, "CCODFAM" ) ) )

   hSet( hJson, "name", AllTrim( hGet( aFamilia, "CNOMFAM" ) ) )
   hSet( hJson, "slug", AllTrim( hGet( aFamilia, "CCODFAM" ) ) )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( Alltrim( ::cFamilias ) )
   oWebService:setUrl( Alltrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", Alltrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", Alltrim( ::cClave ) )
   oWebService:setMethod( "POST" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: familia creada" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   if hhaskey( hResult, "id" )
      FamiliasModel():updateWpId( AllTrim( Str( hGet( hResult, "id" ) ) ), AllTrim( hGet( aFamilia, "CCODFAM" ) ) )
   end

RETURN ( self )



static FUNCTION ImportLatress_updateFamilia( aFamilia ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult           := {}
   local hJson             := {=>}
   local cJson

   ::setProcessText( "Actualizando familia " + AllTrim( hGet( aFamilia, "CNOMFAM" ) ) + " - " + AllTrim( hGet( aFamilia, "CCODFAM" ) ) )

   hSet( hJson, "id", AllTrim( hGet( aFamilia, "CIDWP" ) ) )
   hSet( hJson, "name", AllTrim( hGet( aFamilia, "CNOMFAM" ) ) )
   hSet( hJson, "slug", AllTrim( hGet( aFamilia, "CCODFAM" ) ) )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cFamilias ) + "/" + AllTrim( hGet( aFamilia, "CIDWP" ) ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: Familia actualizada" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

RETURN ( self )



static FUNCTION ImportLatress_addPropiedades( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local aListPropiedades := PropiedadesModel():getListToWP()

   if Len( aListPropiedades ) > 0
      aEval( aListPropiedades, {|a| if( Empty( hGet( a, "CIDWP" ) ), ::addPropiedad( a ), ::updatePropiedad( a ) ) } )
   end

RETURN ( Self )



static FUNCTION ImportLatress_addPropiedad( aPropiedad ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult                 := {}
   local hJson                   := {=>}
   local cJson
   local aListPropiedadesLines

   ::setProcessText( "Añadiendo propiedad " + AllTrim( hGet( aPropiedad, "CCODPRO" ) ) + " - " + AllTrim( hGet( aPropiedad, "CDESPRO" ) ) )

   hSet( hJson, "name", AllTrim( hGet( aPropiedad, "CDESPRO" ) ) )
   hSet( hJson, "slug", AllTrim( hGet( aPropiedad, "CCODPRO" ) ) )
   hSet( hJson, "type", "select" )
   hSet( hJson, "order_by", "name" )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cPropiedades ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "POST" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: propiedad creada" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   if hb_ishash( hResult ) .AND. hhaskey( hResult, "id" )
      PropiedadesModel():updateWpId( AllTrim( Str( hGet( hResult, "id" ) ) ), AllTrim( hGet( aPropiedad, "CCODPRO" ) ) )
   end

   aListPropiedadesLines := PropiedadesLineasModel():getListToWP( hGet( aPropiedad, "CCODPRO" ) )

   if hb_ishash( hResult ) .AND. hhaskey( hResult, "id" )
      if Len( aListPropiedadesLines ) > 0
         aEval( aListPropiedadesLines, {|a| if( Empty( hGet( a, "CIDWP" ) ), ::addPropiedadLine( a, hGet( hResult, "id" ) ), ::updatePropiedadLine( a, hGet( hResult, "id" ) ) ) } )
      end
   end

RETURN ( self )



static FUNCTION ImportLatress_updatePropiedad( aPropiedad ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult           := {}
   local hJson             := {=>}
   local cJson
   local aListPropiedadesLines

   ::setProcessText( "Actualizando propiedad " + AllTrim( hGet( aPropiedad, "CCODPRO" ) ) + " - " + AllTrim( hGet( aPropiedad, "CDESPRO" ) ) )

   hSet( hJson, "name", AllTrim( hGet( aPropiedad, "CDESPRO" ) ) )
   hSet( hJson, "slug", AllTrim( hGet( aPropiedad, "CCODPRO" ) ) )
   hSet( hJson, "type", "select" )
   hSet( hJson, "order_by", "name" )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cPropiedades )+ "/" + AllTrim( hGet( aPropiedad, "CIDWP" ) ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: propiedad actualizado" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   aListPropiedadesLines := PropiedadesLineasModel():getListToWP( hGet( aPropiedad, "CCODPRO" ) )

   if Len( aListPropiedadesLines ) > 0
      aEval( aListPropiedadesLines, {|a| if( Empty( hGet( a, "CIDWP" ) ), ::addPropiedadLine( a, hGet( hResult, "id" ) ), ::updatePropiedadLine( a, hGet( hResult, "id" ) ) ) } )
   end

RETURN ( self )



static FUNCTION ImportLatress_addPropiedadLine( aPropiedadLine, cIdParent ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult                 := {}
   local hJson                   := {=>}
   local cJson
   local aListPropiedadesLines

   ::setProcessText( "Añadiendo propiedad " + AllTrim( hGet( aPropiedadLine, "CCODTBL" ) ) + " - " + AllTrim( hGet( aPropiedadLine, "CDESTBL" ) ) )

   hSet( hJson, "name", AllTrim( hGet( aPropiedadLine, "CDESTBL" ) ) )
   hSet( hJson, "slug", AllTrim( hGet( aPropiedadLine, "CCODTBL" ) ) )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cPropiedades ) + "/" + Alltrim( Str( cIdParent ) ) + "/terms" )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "POST" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: propiedad creada" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   if hhaskey( hResult, "id" )
      PropiedadesLineasModel():updateWpId( AllTrim( Str( hGet( hResult, "id" ) ) ), AllTrim( hGet( aPropiedadLine, "CCODPRO" ) ), AllTrim( hGet( aPropiedadLine, "CCODTBL" ) ) )
   end

RETURN ( self )



static FUNCTION ImportLatress_updatePropiedadLine( aPropiedadLine, cIdParent ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult           := {}
   local hJson             := {=>}
   local cJson
   local aListPropiedadesLines

   ::setProcessText( "Actualizando propiedad " + AllTrim( hGet( aPropiedadLine, "CCODTBL" ) ) + " - " + AllTrim( hGet( aPropiedadLine, "CDESTBL" ) ) )

   hSet( hJson, "name", AllTrim( hGet( aPropiedadLine, "CDESTBL" ) ) )
   hSet( hJson, "slug", AllTrim( hGet( aPropiedadLine, "CCODTBL" ) ) )
   hSet( hJson, "type", "select" )
   hSet( hJson, "order_by", "name" )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cPropiedades ) + "/" + Alltrim( Str( cIdParent ) ) + "/terms/" + AllTrim( hGet( aPropiedadLine, "CIDWP" ) ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: propiedad actualizada" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

RETURN ( self )



static FUNCTION ImportLatress_addVariations( aArticulo, hValue, cIdResult ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult           := {}
   local hJson             := {=>}
   local cJson
   local cId
   local aAtributes        := {}

   if !Empty( hGet( aArticulo, "CCODPRP1" ) )


      aAdd( aAtributes, { "id" => val( AllTrim( PropiedadesModel():getField( "cIdWP", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP1" ) ) ) ) ), "name"=> AllTrim( PropiedadesModel():getField( "cDesPro", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP1" ) ) ) ), "option"=> PropiedadesLineasModel():getNombre( hGet( hValue, "CCODPR1" ), hGet( hValue, "CVALPR1" ) )  } )
   end

   if !Empty( hGet( aArticulo, "CCODPRP2" ) )


      aAdd( aAtributes, { "id" => val( AllTrim( PropiedadesModel():getField( "cIdWP", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP2" ) ) ) ) ), "name"=> AllTrim( PropiedadesModel():getField( "cDesPro", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP2" ) ) ) ), "option" => PropiedadesLineasModel():getNombre( hGet( hValue, "CCODPR2" ), hGet( hValue, "CVALPR2" ) )  } )
   end

   hSet( hJson, "sku", AllTrim( hGet( aArticulo, "CODIGO" ) ) )
   hSet( hJson, "price", Trans( hGet( aArticulo, "NIMPINT1" ), "999999.99" ) )
   hSet( hJson, "regular_price", Trans( hGet( aArticulo, "NIMPINT1" ), "999999.99" ) )
   hSet( hJson, "status", "publish" )
   hSet( hJson, "manage_stock", .T. )
   hSet( hJson, "stock_quantity", 10 )
   hSet( hJson, "stock_status", "instock" )

   if !Empty( aAtributes )
      hSet( hJson, "attributes", aAtributes )
   end

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( Alltrim( ::cArticulos + "/" + cIdResult + "/variations" ) )
   oWebService:setUrl( Alltrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", Alltrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", Alltrim( ::cClave ) )
   oWebService:setMethod( "POST" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   WQout( { oWebService:getStatus() } )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
   end

   oWebService:End()

   msginfo( hb_valToExp( hResult ), "hResult" )

   if hhaskey( hResult, "id" )
      FamiliasModel():updateWpId( AllTrim( Str( hGet( hResult, "id" ) ) ), AllTrim( hGet( aArticulo, "CODIGO" ) ), AllTrim( hGet( aArticulo, "CCODPRP1" ) ), AllTrim( hGet( aArticulo, "CCODPRP2" ) ), AllTrim( hGet( hValue, "CVALPR1" ) ), AllTrim( hGet( hValue, "CVALPR2" ) ) )
      cId   := AllTrim( Str( hGet( hResult, "id" ) ) )
   end

RETURN ( cId )



static FUNCTION ImportLatress_addOneArticulo( hArticulo ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local nOrdAnt
   local hFamilia

   if Empty( hArticulo )
      RETURN ( Self )
   end





   nOrdAnt        := ( D():Familias( ::nView ) )->( OrdSetFocus( "cCodFam" ) )

   if ( D():Familias( ::nView ) )->( dbSeek( hget( hArticulo, "FAMILIA" ) ) )

      hFamilia    := dbHash( D():Familias( ::nView ) )

      if Empty( hGet( hFamilia, "CIDWP" ) )
         ::addFamilia( hFamilia )
      else
         ::updateFamilia( hFamilia )
      end

   end

   ( D():Familias( ::nView ) )->( OrdSetFocus( nOrdAnt ) )





   if Empty( hGet( hArticulo, "CIDWP" ) )
      ::addArticulo( hArticulo )
   else
      ::UpdateArticulo( hArticulo )
   end

RETURN ( Self )



static FUNCTION ImportLatress_addArticulos( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local aListArticulo := ArticulosModel():getListToWP()

   if Len( aListArticulo ) > 0
      aEval( aListArticulo, {|a| if( Empty( hGet( a, "CIDWP" ) ), ::addArticulo( a ), ::UpdateArticulo( a ) ) } )
   end

RETURN ( Self )



static FUNCTION ImportLatress_addArticulo( aArticulo ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult              := {}
   local hJson                := {=>}
   local cJson
   local nStock               := StocksModel():nStockArticulo( AllTrim( hGet( aArticulo, "CODIGO" ) ), Application():codigoAlmacen() )
   local aImages              := {}
   local hImage
   local aImagesWeb           := {}
   local aAtributes           := {}
   local hValuesCombinations  := {}
   local aListValuesPrp1      := {}
   local aListValuesPrp2      := {}
   local hValue
   local cNameValue           := ""
   local nIdVariation
   local aListIdVariation     := {}
   local nIdResult

   hValuesCombinations        := ArticulosPrecios():getHashProperties( AllTrim( hGet( aArticulo, "CODIGO" ) ) )

   if hHasKey( hValuesCombinations, "aValuesCombinations" )

      for each hValue in hGet( hValuesCombinations, "aValuesCombinations" )

         cNameValue           := PropiedadesLineasModel():getNombre( hGet( hValue, "CCODPR1" ), hGet( hValue, "CVALPR1" ) )

         if aScan( aListValuesPrp1, cNameValue ) == 0
            aAdd( aListValuesPrp1, cNameValue )
         end

         cNameValue           := PropiedadesLineasModel():getNombre( hGet( hValue, "CCODPR2" ), hGet( hValue, "CVALPR2" ) )

         if aScan( aListValuesPrp2, cNameValue ) == 0
            aAdd( aListValuesPrp2, cNameValue )
         end

      next

   end

   if !Empty( hGet( aArticulo, "CCODPRP1" ) )





      aAdd( aAtributes, { "id" => val( AllTrim( PropiedadesModel():getField( "cIdWP", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP1" ) ) ) ) ), "name"=> AllTrim( PropiedadesModel():getField( "cDesPro", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP1" ) ) ) ), "position" => 0 , "visible" => .T. , "variation" => .T. , "options"=> aListValuesPrp1 } )
   end

   if !Empty( hGet( aArticulo, "CCODPRP2" ) )





      aAdd( aAtributes, { "id" => val( AllTrim( PropiedadesModel():getField( "cIdWP", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP2" ) ) ) ) ), "name"=> AllTrim( PropiedadesModel():getField( "cDesPro", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP2" ) ) ) ), "position" => 1 , "visible" => .T. , "variation"=> .T. , "options" => aListValuesPrp2 } )
   end

   aImages        := ArticulosImagenesModel():getList( hGet( aArticulo, "CODIGO" ) )

   if Len( aImages ) > 0

      for each hImage in aImages

         ::addFtpImage( hGet( hImage, "CIMGART" ) )

         aAdd( aImagesWeb, { "src" => AllTrim( ::cWebImagen ) + cNoPath( hGet( hImage, "CIMGART" ) ) } )

      next

   end

   ::setProcessText( "Añadiendo artículo " + AllTrim( hGet( aArticulo, "CODIGO" ) ) + " - " + AllTrim( hGet( aArticulo, "NOMBRE" ) ) )

   hSet( hJson, "name", AllTrim( hGet( aArticulo, "NOMBRE" ) ) )
   hSet( hJson, "slug", Strtran( lower( AllTrim( hGet( aArticulo, "NOMBRE" ) ) ), " ", "-" ) )
   hSet( hJson, "sku", AllTrim( hGet( aArticulo, "CODIGO" ) ) )
   hSet( hJson, "type", "variable" )
   hSet( hJson, "status", "publish" )
   hSet( hJson, "price", Trans( hGet( aArticulo, "NIMPINT1" ), "999999.99" ) )
   hSet( hJson, "regular_price", Trans( hGet( aArticulo, "NIMPINT1" ), "999999.99" ) )
   hSet( hJson, "sale_price", Trans( hGet( aArticulo, "NIMPINT1" ), "999999.99" ) )
   hSet( hJson, "description", AllTrim( hGet( aArticulo, "MDESTEC" ) ) )
   hSet( hJson, "short_description", AllTrim( hGet( aArticulo, "NOMBRE" ) ) )
   hSet( hJson, "manage_stock", "true" )
   hSet( hJson, "stock_quantity", AllTrim( Str( int( nStock ) ) ) )
   hSet( hJson, "stock_status", if( nStock > 0, "instock", "outofstock" )  )
   hSet( hJson, "categories", { { "id" => val( AllTrim( FamiliasModel():getField( "cIdWP", "cCodFam", AllTrim( hGet( aArticulo, "FAMILIA" ) ) ) ) ) } } )

   if !Empty( aImagesWeb )
      hSet( hJson, "images", aImagesWeb )
   end

   if !Empty( aAtributes )
      hSet( hJson, "attributes", aAtributes )
   end







   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "POST" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: artículo creado" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   if isHash( hResult ) .AND. !Empty( hResult ) .AND. hhaskey( hResult, "id" )
      ArticulosModel():updateWpId( AllTrim( Str( hGet( hResult, "id" ) ) ), AllTrim( hGet( aArticulo, "CODIGO" ) ) )
      nIdResult      := AllTrim( Str( hGet( hResult, "id" ) ) )
   end



   hJson       := {=>}
   cJson       := ""

   if hHasKey( hValuesCombinations, "aValuesCombinations" )

      for each hValue in hGet( hValuesCombinations, "aValuesCombinations" )

         if Empty( hGet( hValue, "CCODWP" ) )
            nIdVariation         := ::AddVariations( aArticulo, hValue, nIdResult )
         else
            nIdVariation         := hGet( hValue, "CCODWP" )
         end

         if aScan( aListIdVariation, nIdVariation ) == 0
            aAdd( aListIdVariation, nIdVariation )
         end

      next

   end

   MsgInfo( hb_valToexp( aListIdVariation ), "aListIdVariation" )

   hSet( hJson, "id", nIdResult )
   if !Empty( aListIdVariation )
      hSet( hJson, "variations", aListIdVariation )
   end

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos )+ "/" + nIdResult )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: artículo actualizado" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   ::cleanFtp()

RETURN ( self )



static FUNCTION ImportLatress_updateArticulo( aArticulo ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local hResult              := {}
   local hJson                := {=>}
   local cJson
   local nStock               := StocksModel():nStockArticulo( AllTrim( hGet( aArticulo, "CODIGO" ) ), Application():codigoAlmacen() )
   local aImages              := {}
   local hImage
   local aImagesWeb           := {}
   local aAtributes           := {}
   local hValuesCombinations  := {}
   local aListValuesPrp1      := {}
   local aListValuesPrp2      := {}
   local hValue
   local cNameValue           := ""

   hValuesCombinations        := ArticulosPrecios():getHashProperties( AllTrim( hGet( aArticulo, "CODIGO" ) ) )

   if hHasKey( hValuesCombinations, "aValuesCombinations" )

      for each hValue in hGet( hValuesCombinations, "aValuesCombinations" )

         cNameValue           := PropiedadesLineasModel():getNombre( hGet( hValue, "CCODPR1" ), hGet( hValue, "CVALPR1" ) )

         if aScan( aListValuesPrp1, cNameValue ) == 0
            aAdd( aListValuesPrp1, cNameValue )
         end

         cNameValue           := PropiedadesLineasModel():getNombre( hGet( hValue, "CCODPR2" ), hGet( hValue, "CVALPR2" ) )

         if aScan( aListValuesPrp2, cNameValue ) == 0
            aAdd( aListValuesPrp2, cNameValue )
         end

      next

   end

   if !Empty( hGet( aArticulo, "CCODPRP1" ) )





      aAdd( aAtributes, { "id" => val( AllTrim( PropiedadesModel():getField( "cIdWP", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP1" ) ) ) ) ), "name"=> AllTrim( PropiedadesModel():getField( "cDesPro", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP1" ) ) ) ), "position" => 0 , "visible" => .T. , "variation" => .T. , "options"=> aListValuesPrp1 } )
   end

   if !Empty( hGet( aArticulo, "CCODPRP2" ) )





      aAdd( aAtributes, { "id" => val( AllTrim( PropiedadesModel():getField( "cIdWP", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP2" ) ) ) ) ), "name"=> AllTrim( PropiedadesModel():getField( "cDesPro", "cCodPro", AllTrim( hGet( aArticulo, "CCODPRP2" ) ) ) ), "position" => 1 , "visible" => .T. , "variation"=> .T. , "options" => aListValuesPrp2 } )
   end

   aImages        := ArticulosImagenesModel():getList( hGet( aArticulo, "CODIGO" ) )

   if Len( aImages ) > 0

      for each hImage in aImages

         ::addFtpImage( hGet( hImage, "CIMGART" ) )

         aAdd( aImagesWeb, { "src" => AllTrim( ::cWebImagen ) + cNoPath( hGet( hImage, "CIMGART" ) ) } )

      next

   end

   ::setProcessText( "Actualizando artículo " + AllTrim( hGet( aArticulo, "CODIGO" ) ) + " - " + AllTrim( hGet( aArticulo, "NOMBRE" ) ) )

   hSet( hJson, "name", AllTrim( hGet( aArticulo, "NOMBRE" ) ) )
   hSet( hJson, "slug", Strtran( lower( AllTrim( hGet( aArticulo, "NOMBRE" ) ) ), " ", "-" ) )
   hSet( hJson, "sku", AllTrim( hGet( aArticulo, "CODIGO" ) ) )
   hSet( hJson, "price", Trans( hGet( aArticulo, "NIMPINT1" ), "999999.99" ) )
   hSet( hJson, "regular_price", Trans( hGet( aArticulo, "NIMPINT1" ), "999999.99" ) )
   hSet( hJson, "sale_price", Trans( hGet( aArticulo, "NIMPINT1" ), "999999.99" ) )
   hSet( hJson, "description", AllTrim( hGet( aArticulo, "MDESTEC" ) ) )
   hSet( hJson, "short_description", AllTrim( hGet( aArticulo, "NOMBRE" ) ) )
   hSet( hJson, "manage_stock", "true" )
   hSet( hJson, "stock_quantity", AllTrim( Str( int( nStock ) ) ) )
   hSet( hJson, "stock_status", if( nStock > 0, "instock", "outofstock" )  )
   hSet( hJson, "categories", { { "id" => val( AllTrim( FamiliasModel():getField( "cIdWP", "cCodFam", AllTrim( hGet( aArticulo, "FAMILIA" ) ) ) ) ) } } )

   if !Empty( aImagesWeb )
      hSet( hJson, "images", aImagesWeb )
   end

   if !Empty( aAtributes )
      hSet( hJson, "attributes", aAtributes )
   end

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos )+ "/" + AllTrim( hGet( aArticulo, "CIDWP" ) ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201
      hb_jsonDecode( oWebService:getResponseText(), @hResult )
      ::setProcessText( "Conexión correcta: artículo actualizado" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   ::cleanFtp()

RETURN ( self )



static FUNCTION ImportLatress_addFtpImage( cFile ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

    local oFtp
    local ftpSit            := "ftp.cluster030.hosting.ovh.net"
    local ftpDir            := cNoPathLeft( Rtrim( ftpSit ) )
    local nbrUsr            := "gestooc"
    local accUsr            := "Xtend000"
    local pasInt            := .F.
    local nPuerto           := 21
    local cCarpeta          := "www/imageneswp/"

    if !file( cFile )
        Return ( Self )
    end

    oFtp               := TFtpCurl():New( nbrUsr, accUsr, ftpSit, nPuerto )
    oFtp:setPassive( pasInt )

    if oFtp:CreateConexion()

        ::setProcessText( "Conexión creada con el ftp." )

        if isFalse( oFtp:createFile( cFile, cCarpeta ) )
            ::setProcessText( "Error subiendo fichero " + cFile )
        else
            ::setProcessText( "Subido correctamente:  " + cFile )
        end

        oFtp:EndConexion()

        ::setProcessText( "Conexión cerrada con el ftp." )

    else

        msgStop( "Imposible conectar al sitio ftp" )

    end

RETURN ( self )



static FUNCTION ImportLatress_cleanFtp( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oFtp
   local ftpSit            := "ftp.cluster030.hosting.ovh.net"
   local ftpDir            := cNoPathLeft( Rtrim( ftpSit ) )
   local nbrUsr            := "gestooc"
   local accUsr            := "Xtend000"
   local pasInt            := .F.
   local nPuerto           := 21
   local cCarpeta          := "www/imageneswp/"
   local afiles

   oFtp               := TFTPCurl():New( nbrUsr, accUsr, ftpSit, nPuerto )
   oFtp:setPassive( pasInt )

   if oFtp:CreateConexion()

      ::setProcessText( "Conexión creada con el ftp." )

      aFiles         := ( oFTP:listFiles(), cCarpeta )

      oFtp:EndConexion()

      ::setProcessText( "Conexión cerrada con el ftp." )

   else

      msgStop( "Imposible conectar al sitio ftp" )

   end

RETURN ( self )



static FUNCTION ImportLatress_ActualizaStock( hPropiedades ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local aJson
   local hJson             := {=>}
   local cJson
   local cIdWP             := ::getidProductWp( hGet( hPropiedades, "CCODART" ) )
   local cCodWp            := AllTrim( hGet( hPropiedades, "CCODWP" ) )





   local nStock            := StocksModel():nStockArticulo( hGet( hPropiedades, "CCODART" ), Application():codigoAlmacen(), hGet( hPropiedades, "CCODPR1" ), hGet( hPropiedades, "CCODPR2" ), hGet( hPropiedades, "CVALPR1" ), hGet( hPropiedades, "CVALPR2" ) )

   hSet( hJson, "id", cCodWp )
   hSet( hJson, "manage_stock", "true" )
   hSet( hJson, "stock_quantity", AllTrim( Str( int( nStock ) ) ) )
   hSet( hJson, "stock_status", if( nStock > 0, "instock", "outofstock" )  )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos ) + "/" + cIdWP + "/variations/" + cCodWp )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201

      hb_jsonDecode( oWebService:getResponseText(), @aJson )

      ::setProcessText( "Conexión correcta: actualizado artículo y variantes" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

RETURN ( Self )



static FUNCTION ImportLatress_getProductosWp( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local aJson

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "GET" )
   oWebService:Open()
   oWebService:Send()

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201

      hb_jsonDecode( oWebService:getResponseText(), @aJson )

      ::setProcessText( "Conexión correcta" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

RETURN ( aJson )



static FUNCTION ImportLatress_getidProductWp( cCodArt ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local cIdProduct     := ""
   local hProduct
   local nPos

   nPos                 := aScan( ::aProductos, {|h| AllTrim( hGet( h, "sku" ) ) == AllTrim( cCodArt ) } )
   if nPos <> 0
      hProduct          := ::aProductos[nPos]
      cIdProduct        := AllTrim( Str( hGet( hProduct, "id" ) ) )
   end

RETURN ( cIdProduct )



static FUNCTION ImportLatress_addClientes( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local aJson
   local aClientes

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cClientes ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "GET" )
   oWebService:Open()
   oWebService:Send()

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201

      hb_jsonDecode( oWebService:getResponseText(), @aClientes )

      ::setProcessText( "Conexión correcta" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   if hb_isarray( aClientes ) .AND. len( aClientes ) > 0
      aeval( aClientes, {|h| ::addCliente( h ) } )
   end

   ::setProcessText( "Proceso terminado con éxito." )

RETURN ( self )



static FUNCTION ImportLatress_addCliente( hCliente ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local hDirFac
   local hDirEnv
   local cCodCli  := NextKey( cCodCli, ( D():Clientes( ::nView ) ), "0", RetNumCodCliEmp() )

   if ClientesModel():existInWP( AllTrim( Str( hGet( hCliente, "id" ) ) ) )
      ::setProcessText( "Cliente " + AllTrim( hGet( hCliente, "first_name" ) ) + Space( 1 ) + AllTrim( hGet( hCliente, "last_name" ) ) + " ya existe en el sistema." )
      Return ( self )
   end

   ::setProcessText( "Añadiendo cliente:  " + AllTrim( hGet( hCliente, "first_name" ) ) + Space( 1 ) + AllTrim( hGet( hCliente, "last_name" ) ) )

   ( D():Clientes( ::nView ) )->( dbAppend() )

   ( D():Clientes( ::nView ) )->cIdWP        := AllTrim( Str( hGet( hCliente, "id" ) ) )
   ( D():Clientes( ::nView ) )->Cod          := cCodCli
   ( D():Clientes( ::nView ) )->Titulo       := AllTrim( hGet( hCliente, "first_name" ) ) + Space( 1 ) + AllTrim( hGet( hCliente, "last_name" ) )
   ( D():Clientes( ::nView ) )->LSNDINT      := .T.
   ( D():Clientes( ::nView ) )->LMODDAT      := .T.
   ( D():Clientes( ::nView ) )->LCHGPRE      := .F.
   ( D():Clientes( ::nView ) )->COPIASF      := 0
   ( D():Clientes( ::nView ) )->NLABEL       := 1
   ( D():Clientes( ::nView ) )->NTARCMB      := 1
   ( D():Clientes( ::nView ) )->DLLACLI      := ctod( "" )
   ( D():Clientes( ::nView ) )->DALTA        := getSysDate()
   ( D():Clientes( ::nView ) )->cMeiInt      := AllTrim( hGet( hCliente, "email" ) )
   ( D():Clientes( ::nView ) )->NbrEst       := AllTrim( hGet( hCliente, "username" ) )

   hDirFac                                   := hGet( hCliente, "billing" )
   ( D():Clientes( ::nView ) )->Domicilio    := AllTrim( hGet( hDirFac, "address_1" ) ) + Space( 1 ) + AllTrim( hGet( hDirFac, "address_2" ) )
   ( D():Clientes( ::nView ) )->Poblacion    := AllTrim( hGet( hDirFac, "city" ) )
   ( D():Clientes( ::nView ) )->Provincia    := ::GetProv( AllTrim( hGet( hDirFac, "state" ) ) )
   ( D():Clientes( ::nView ) )->CodPostal    := AllTrim( hGet( hDirFac, "postcode" ) )
   ( D():Clientes( ::nView ) )->Telefono     := AllTrim( hGet( hDirFac, "phone" ) )

   hDirEnv                                   := hGet( hCliente, "shipping" )
   ( D():Clientes( ::nView ) )->cDomEnt      := AllTrim( hGet( hDirEnv, "address_1" ) ) + Space( 1 ) + AllTrim( hGet( hDirEnv, "address_2" ) )
   ( D():Clientes( ::nView ) )->cPobEnt      := AllTrim( hGet( hDirEnv, "city" ) )
   ( D():Clientes( ::nView ) )->cCPEnt       := AllTrim( hGet( hDirEnv, "postcode" ) )
   ( D():Clientes( ::nView ) )->cPrvEnt      := ::GetProv( AllTrim( hGet( hDirEnv, "state" ) ) )

   ( D():Clientes( ::nView ) )->( dbUnLock() )

   ::setProcessText( "Proceso terminado con éxito." )

RETURN ( self )



static FUNCTION ImportLatress_addPedidos( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local aPedidos

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cPedidos ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "GET" )
   oWebService:Open()
   oWebService:Send()

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201

      hb_jsonDecode( oWebService:getResponseText(), @aPedidos )

      ::setProcessText( "Conexión correcta" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

   if hb_isarray( aPedidos ) .AND. len( aPedidos ) > 0
      aeval( aPedidos, {|h| ::addPedido( h ) } )
   end

RETURN ( self )



static FUNCTION ImportLatress_addPedido( hPedido ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local hDirFac
   local aLineas

   if PedidosClientesModel():existInWP( AllTrim( Str( hGet( hPedido, "id" ) ) ) )
      ::setProcessText( "Pedido con " + AllTrim( Str( hGet( hPedido, "id" ) ) ) + " ya existe en el sistema." )
      Return ( self )
   end

   ::setProcessText( "Añadiendo pedido de cliente:  " + AllTrim( Str( hGet( hPedido, "id" ) ) ) )

   ::cSerie         := cNewSer( "nPedCli", D():Contadores( ::nView ) )
   ::nNumero        := nNewDoc( ::cSerie, D():PedidosClientes( ::nView ), "NPEDCLI", , D():Contadores( ::nView ) )
   ::cSufijo        := RetSufEmp()

   ::dFecPed         := ctod( SubStr( hGet( hPedido, "date_created" ), 9, 2 ) + "/" + SubStr( hGet( hPedido, "date_created" ), 6, 2 ) + "/" + SubStr( hGet( hPedido, "date_created" ), 1, 4 ) )

   ( D():PedidosClientes( ::nView ) )->( dbAppend() )

   ( D():PedidosClientes( ::nView ) )->cIdWP          := AllTrim( Str( hGet( hPedido, "id" ) ) )
   ( D():PedidosClientes( ::nView ) )->cSerPed        := ::cSerie
   ( D():PedidosClientes( ::nView ) )->nNumPed        := ::nNumero
   ( D():PedidosClientes( ::nView ) )->cSufPed        := ::cSufijo
   ( D():PedidosClientes( ::nView ) )->cTurPed        := cCurSesion()
   ( D():PedidosClientes( ::nView ) )->cCodAlm        := Application():codigoAlmacen()
   ( D():PedidosClientes( ::nView ) )->cCodCaj        := Application():CodigoCaja()
   ( D():PedidosClientes( ::nView ) )->cDivPed        := cDivEmp()
   ( D():PedidosClientes( ::nView ) )->cCodPgo        := cDefFpg()
   ( D():PedidosClientes( ::nView ) )->nVdvPed        := nChgDiv( cDivEmp(), D():Divisas( ::nView ) )
   ( D():PedidosClientes( ::nView ) )->nEstAdo        := 1
   ( D():PedidosClientes( ::nView ) )->cCodUsr        := Auth():Codigo()
   ( D():PedidosClientes( ::nView ) )->cCodDlg        := Application():CodigoDelegacion()
   ( D():PedidosClientes( ::nView ) )->lIvaInc        := uFieldEmpresa( "lIvaInc" )
   ( D():PedidosClientes( ::nView ) )->cManObr        := padr( getConfigTraslation( "Gastos" ), 250 )
   ( D():PedidosClientes( ::nView ) )->nIvaMan        := nIva( D():TiposIva( ::nView ), cDefIva() )
   ( D():PedidosClientes( ::nView ) )->dFecPed        := ::dFecPed

   ( D():PedidosClientes( ::nView ) )->cSuPed         := AllTrim( hGet( hPedido, "order_key" ) )

   if AllTrim( Str( hGet( hPedido, "customer_id" ) ) ) <> "0"

      ::cCodCli  := ClientesModel():getField( "Cod", "cIdWP", AllTrim( Str( hGet( hPedido, "customer_id" ) ) ) )
      ( D():PedidosClientes( ::nView ) )->cCodCli     := ::cCodCli
      ( D():PedidosClientes( ::nView ) )->cNomCli     := ClientesModel():getField( "Titulo", "Cod", ::cCodCli )
      ( D():PedidosClientes( ::nView ) )->cDirCli     := ClientesModel():getField( "Domicilio", "Cod", ::cCodCli )
      ( D():PedidosClientes( ::nView ) )->cPobCli     := ClientesModel():getField( "Poblacion", "Cod", ::cCodCli )
      ( D():PedidosClientes( ::nView ) )->cPrvCli     := ClientesModel():getField( "Provincia", "Cod", ::cCodCli )
      ( D():PedidosClientes( ::nView ) )->cPosCli     := ClientesModel():getField( "CodPostal", "Cod", ::cCodCli )
      ( D():PedidosClientes( ::nView ) )->cDniCli     := ClientesModel():getField( "Nif", "Cod", ::cCodCli )
      ( D():PedidosClientes( ::nView ) )->cTlfCli     := ClientesModel():getField( "Telefono", "Cod", ::cCodCli )

   else

      hDirFac                                         := hGet( hPedido, "billing" )

      ::cCodCli                                       := ::addClienteNotReg( hDirFac )

      ( D():PedidosClientes( ::nView ) )->cCodCli     := ::cCodCli
      ( D():PedidosClientes( ::nView ) )->cNomCli     := AllTrim( hGet( hDirFac, "first_name" ) ) + Space( 1 ) + AllTrim( hGet( hDirFac, "last_name" ) )
      ( D():PedidosClientes( ::nView ) )->cDirCli     := AllTrim( hGet( hDirFac, "address_1" ) ) + Space( 1 ) + AllTrim( hGet( hDirFac, "address_2" ) )
      ( D():PedidosClientes( ::nView ) )->cPobCli     := AllTrim( hGet( hDirFac, "city" ) )
      ( D():PedidosClientes( ::nView ) )->cPrvCli     := ::GetProv( AllTrim( hGet( hDirFac, "state" ) ) )
      ( D():PedidosClientes( ::nView ) )->cPosCli     := AllTrim( hGet( hDirFac, "postcode" ) )
      ( D():PedidosClientes( ::nView ) )->cTlfCli     := AllTrim( hGet( hDirFac, "phone" ) )

   end

   ( D():PedidosClientes( ::nView ) )->nTotNet        := Val( hGet( hPedido, "total" ) ) - Val( hGet( hPedido, "total_tax" ) )
   ( D():PedidosClientes( ::nView ) )->nTotIva        := Val( hGet( hPedido, "total_tax" ) )
   ( D():PedidosClientes( ::nView ) )->nTotPed        := Val( hGet( hPedido, "total" ) )

   ( D():PedidosClientes( ::nView ) )->( dbUnLock() )




   aLineas                                            := hGet( hPedido, "line_items" )

   if hb_isarray( aLineas ) .AND. len( aLineas ) > 0
      aeval( aLineas, {|h| ::addLineaPedido( h ) } )
   end

   ::setProcessText( "Proceso terminado con éxito." )

RETURN ( self )



static FUNCTION ImportLatress_addLineaPedido( hLinea ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   ::setProcessText( "Añadiendo lineas pedido de cliente." )

   ( D():PedidosClientesLineas( ::nView ) )->( dbAppend() )

   ( D():PedidosClientesLineas( ::nView ) )->cSerPed        := ::cSerie
   ( D():PedidosClientesLineas( ::nView ) )->nNumPed        := ::nNumero
   ( D():PedidosClientesLineas( ::nView ) )->cSufPed        := ::cSufijo

   ( D():PedidosClientesLineas( ::nView ) )->cRef           := ArticulosModel():getField( "Codigo", "cIdWP", AllTrim( Str( hGet( hLinea, "product_id" ) ) ) )
   ( D():PedidosClientesLineas( ::nView ) )->cDetalle       := AllTrim( hGet( hLinea, "name" ) )




   ( D():PedidosClientesLineas( ::nView ) )->nIva           := nIva( D():TiposIva( ::nView ), ArticulosModel():getField( "TipoIva", "cIdWP", AllTrim( Str( hGet( hLinea, "product_id" ) ) ) ) )
   ( D():PedidosClientesLineas( ::nView ) )->nUniCaja       := hGet( hLinea, "quantity" )
   ( D():PedidosClientesLineas( ::nView ) )->nPreDiv        := hGet( hLinea, "price" )
   ( D():PedidosClientesLineas( ::nView ) )->cAlmLin        := Application():codigoAlmacen()

   ( D():PedidosClientesLineas( ::nView ) )->( dbUnLock() )

RETURN ( self )



static FUNCTION ImportLatress_addClienteNotReg( hCliente ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local cCodCli  := NextKey( cCodCli, ( D():Clientes( ::nView ) ), "0", RetNumCodCliEmp() )

   ::setProcessText( "Añadiendo cliente:  " + AllTrim( hGet( hCliente, "first_name" ) ) + Space( 1 ) + AllTrim( hGet( hCliente, "last_name" ) ) )

   ( D():Clientes( ::nView ) )->( dbAppend() )

   ( D():Clientes( ::nView ) )->cIdWP        := "0"
   ( D():Clientes( ::nView ) )->Cod          := cCodCli
   ( D():Clientes( ::nView ) )->Titulo       := AllTrim( hGet( hCliente, "first_name" ) ) + Space( 1 ) + AllTrim( hGet( hCliente, "last_name" ) )
   ( D():Clientes( ::nView ) )->LSNDINT      := .T.
   ( D():Clientes( ::nView ) )->LMODDAT      := .T.
   ( D():Clientes( ::nView ) )->LCHGPRE      := .F.
   ( D():Clientes( ::nView ) )->COPIASF      := 0
   ( D():Clientes( ::nView ) )->NLABEL       := 1
   ( D():Clientes( ::nView ) )->NTARCMB      := 1
   ( D():Clientes( ::nView ) )->DLLACLI      := ctod( "" )
   ( D():Clientes( ::nView ) )->DALTA        := getSysDate()
   ( D():Clientes( ::nView ) )->cMeiInt      := AllTrim( hGet( hCliente, "email" ) )
   ( D():Clientes( ::nView ) )->Domicilio    := AllTrim( hGet( hCliente, "address_1" ) ) + Space( 1 ) + AllTrim( hGet( hCliente, "address_2" ) )
   ( D():Clientes( ::nView ) )->Poblacion    := AllTrim( hGet( hCliente, "city" ) )
   ( D():Clientes( ::nView ) )->Provincia    := ::GetProv( AllTrim( hGet( hCliente, "state" ) ) )
   ( D():Clientes( ::nView ) )->CodPostal    := AllTrim( hGet( hCliente, "postcode" ) )
   ( D():Clientes( ::nView ) )->Telefono     := AllTrim( hGet( hCliente, "phone" ) )

   ( D():Clientes( ::nView ) )->( dbUnLock() )

   ::setProcessText( "Proceso terminado con éxito." )

RETURN ( cCodCli )



static FUNCTION ImportLatress_GetProv( cProv ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local cDevuelve   := Space( 10 )

   if hHasKey( ::hProvincias, cProv )
      cDevuelve   := ::hProvincias[ cProv ]
   end

Return cDevuelve



static FUNCTION ImportLatress_desactivateArticulo( cId ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local aJson
   local hJson             := {=>}
   local cJson

   hSet( hJson, "id", val( cId ) )
   hSet( hJson, "status", "draft" )
   hSet( hJson, "catalog_visibility", "hidden" )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos ) + "/" + AllTrim( cId ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201

      hb_jsonDecode( oWebService:getResponseText(), @aJson )

      ::setProcessText( "Conexión correcta: actualizado artículo y variantes" )

   else

      ::setProcessText( "Fallo de comunicación." )

   end

   oWebService:End()

   MsgInfo( "Artículo desactivado en woocommerce" )

Return ( self )



static FUNCTION ImportLatress_activateArticulo( cId ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local aJson
   local hJson             := {=>}
   local cJson

   hSet( hJson, "id", val( cId ) )
   hSet( hJson, "status", "publish" )
   hSet( hJson, "catalog_visibility", "visible" )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos ) + "/" + AllTrim( cId ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201

      hb_jsonDecode( oWebService:getResponseText(), @aJson )

      ::setProcessText( "Conexión correcta: actualizado artículo y variantes" )

   else

      ::setProcessText( "Fallo de comunicación." )

   end

   oWebService:End()

   MsgInfo( "Artículo activado en woocommerce" )

Return ( self )



static FUNCTION ImportLatress_getArticulo( cId ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local aArt

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos ) + "/" + AllTrim( cId ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "GET" )
   oWebService:Open()
   oWebService:Send()

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201

      hb_jsonDecode( oWebService:getResponseText(), @aArt )

      ::setProcessText( "Conexión correcta" )
   else
      ::setProcessText( "Fallo de comunicación." )
   end

   oWebService:End()

Return ( self )



static FUNCTION ImportLatress_ActStockArticulo( cCodArt, cId ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   local oWebService
   local aJson
   local hJson             := {=>}
   local cJson
   local nStock            := StocksModel():nStockArticulo( cCodArt, Application():codigoAlmacen() )

   hSet( hJson, "id", val( cId ) )
   hSet( hJson, "manage_stock", "true" )
   hSet( hJson, "stock_quantity", AllTrim( Str( int( nStock ) ) ) )
   hSet( hJson, "stock_status", if( nStock > 0, "instock", "outofstock" )  )

   cJson          := hb_jsonencode( hJson, .T. )

   oWebService    := WebService():New()
   oWebService:setService( AllTrim( ::cArticulos ) + "/" + AllTrim( cId ) )
   oWebService:setUrl( AllTrim( ::cDireccion ) )
   oWebService:setParams( "consumer_key", AllTrim( ::cUsuario ) )
   oWebService:setParams( "consumer_secret", AllTrim( ::cClave ) )
   oWebService:setMethod( "PUT" )
   oWebService:Open()
   oWebService:SetRequestHeader( "Content-Type", "application/json" )
   oWebService:Send( cJson )

   if oWebService:getStatus() == 200 .OR. oWebService:getStatus() == 201

      hb_jsonDecode( oWebService:getResponseText(), @aJson )

      ::setProcessText( "Conexión correcta: actualizado artículo y variantes" )

   else

      ::setProcessText( "Fallo de comunicación." )

   end

   oWebService:End()

   MsgInfo( "Artículo actualizado en woocommerce" )

Return ( self )



static FUNCTION ImportLatress_saveConfig( ) ; local Self AS CLASS ImportLatress := QSelf() AS CLASS ImportLatress

   ConfiguracionesEmpresaModel():setValue( "direccionWP", AllTrim( ::cDireccion ) )
   ConfiguracionesEmpresaModel():setValue( "usuarioWP", AllTrim( ::cUsuario ) )
   ConfiguracionesEmpresaModel():setValue( "claveWP", AllTrim( ::cClave ) )
   ConfiguracionesEmpresaModel():setValue( "articulosWP", AllTrim( ::cArticulos ) )
   ConfiguracionesEmpresaModel():setValue( "familiasWP", AllTrim( ::cFamilias ) )
   ConfiguracionesEmpresaModel():setValue( "propiedadesWP", AllTrim( ::cPropiedades ) )
   ConfiguracionesEmpresaModel():setValue( "clientesWP", AllTrim( ::cClientes ) )
   ConfiguracionesEmpresaModel():setValue( "pedidosWP", AllTrim( ::cPedidos ) )
   ConfiguracionesEmpresaModel():setValue( "imagenesWP", AllTrim( ::cWebImagen ) )

Return ( self )
