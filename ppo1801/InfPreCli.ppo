#line 91 "\fwh1801\include\FiveWin.ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 8 ".\.\Prg\InfPreCli.prg"
_HB_CLASS InfPreCli ; function InfPreCli ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "InfPreCli", iif( .T., { @TNewInfGen() }, { @HBObject() } ), @InfPreCli() ) ) ;

   _HB_MEMBER { AS OBJECT oFacCliP } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliP"}, .F. )
   _HB_MEMBER { AS OBJECT oFacCliT } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliT"}, .F. )

   _HB_MEMBER Create(); oClass:AddMethod( "Create", @InfPreCli_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lResource( cFld); oClass:AddMethod( "lResource", @InfPreCli_lResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @InfPreCli_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @InfPreCli_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lGenerate(); oClass:AddMethod( "lGenerate", @InfPreCli_lGenerate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS InfPreCli ;



static FUNCTION InfPreCli_Create( ) ; local Self AS CLASS InfPreCli := QSelf() AS CLASS InfPreCli

   ::AddField( "cTipDoc",   "C", 20, 0, {|| "@!" },      "Tipo",              .F., "Tipo documento",                    15, .F. )
   ::AddField( "cNumDoc",   "C", 17, 0, {|| "@!" },      "N. Recibo",         .T., "Número recibo",                     15, .F. )
   ::AddField( "cCodGCli",  "C",  4, 0, {|| "@!" },      "Grp. cli.",         .F., "Cod. grupo cliente",                 9, .F. )
   ::AddField( "cNomGCli",  "C", 30, 0, {|| "@!" },      "Grupo",             .F., "Nombre grupo",                      35, .F. )
   ::AddField( "cCodCli",   "C", 12, 0, {|| "@!" },      "Cod. cli.",         .F., "Cod. cliente",                       9, .F. )
   ::AddField( "cNomCli",   "C", 50, 0, {|| "@!" },      "Cliente",           .F., "Nombre cliente",                    35, .F. )
   ::AddField( "cCodFpg",   "C",  2, 0, {|| "@!" },      "Cod. pago",         .F., "Cod. pago",                          9, .F. )
   ::AddField( "cNomFpg",   "C", 30, 0, {|| "@!" },      "Forma de pago",     .F., "Forma de pago",                     35, .F. )
   ::AddField( "dFecMov",   "D",  8, 0, {|| "@!" },      "F. Exped.",         .T., "Fecha expedición",                  12, .F. )
   ::AddField( "dFecPre",   "D",  8, 0, {|| "@!" },      "F. Vncto.",         .T., "Fecha de vencimiento",              12, .F. )
   ::AddField( "cDescrip",  "C",100, 0, {|| "@!" },      "Descrip.",          .T., "Concepto del pago",                 50, .F. )
   ::AddField( "nImporte",  "N", 16, 3, {|| ::cPicOut }, "Importe",           .T., "Importe",                           15, .F. )
   ::AddField( "cBanco",    "C", 50, 0, {|| "@!" },      "Banco cliente",     .F., "Nombre del banco del cliente",      20, .F. )
   ::AddField( "cCuenta",   "C", 30, 0, {|| "@!" },      "Cuenta cliente",    .F., "Cuenta bancaria del cliente",       35, .F. )
   ::AddField( "cBncEmp",   "C", 50, 0, {|| "@!" },      "Banco empresa",     .F., "Nombre del banco de la empresa",    20, .F. )
   ::AddField( "cCtaEmp",   "C", 30, 0, {|| "@!" },      "Cuenta empresa",    .F., "Cuenta bancaria de la empresa",     35, .F. )

   ::AddTmpIndex ( "cNumDoc", "cNumDoc" )
   ::AddTmpIndex ( "dFecMov", "dFecMov" )
   ::AddTmpIndex ( "dFecPre", "dFecPre" )

   ::lExcCero  := .F.

RETURN ( Self )



static FUNCTION InfPreCli_OpenFiles( ) ; local Self AS CLASS InfPreCli := QSelf() AS CLASS InfPreCli

   local lOpen    := .T.
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      ::oFacCliP := TDataCenter():oFacCliP()

      ::oFacCliT := TDataCenter():oFacCliT()

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      ::CloseFiles()
      lOpen          := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION InfPreCli_CloseFiles( ) ; local Self AS CLASS InfPreCli := QSelf() AS CLASS InfPreCli

   if !Empty( ::oFacCliP ) .AND. ::oFacCliP:Used()
      ::oFacCliP:End()
   end

   if !Empty( ::oFacCliT ) .AND. ::oFacCliT:Used()
      ::oFacCliT:End()
   end

   ::oFacCliP := nil
   ::oFacCliT := nil

RETURN ( Self )



static FUNCTION InfPreCli_lResource( cFld ) ; local Self AS CLASS InfPreCli := QSelf() AS CLASS InfPreCli

   ::dIniInf            := BoM( Month( Date() ) )
   ::lGrpFecInf         := .F.
   ::lNewInforme        := .T.
   ::lDefCondiciones    := .F.
   ::lDefEstadoUno      := .T.
   ::lDefEstadoDos      := .T.
   ::cEstadoUno         := "Ordenar por número"
   ::aEstadoUno         := { "Ordenar por número", "Ordenar por fecha exp.", "Ordenar por fecha prev." }
   ::cEstadoDos         := "Facturas"
   ::aEstadoDos         := { "Todas", "Facturas", "Rectificativas" }

   if !::NewResource( "INF_GEN_02" )
      return .F.
   end

   if !::lGrupoGrupoCliente( .F. )
      return .F.
   end

   if !::lGrupoCliente( .F. )
      return .F.
   end

   if !::lGrupoFPago( .F. )
      return .F.
   end

   ::oDefExcInf( 1515 )

   ::CreateFilter( aItmRecCli(), ::oFacCliP:cAlias )

   ::oMtrInf:SetTotal( ::oFacCliP:Lastrec() )

RETURN .T.






static FUNCTION InfPreCli_lGenerate( ) ; local Self AS CLASS InfPreCli := QSelf() AS CLASS InfPreCli

   local cCodGCli
   local cExpHead := ""

   ::oDlg:Disable()
   ::oDbf:Zap()


   ::aHeader      := {  {|| "Fecha    : " + Dtoc( Date() ) }, {|| "Periodo  : " + Dtoc( ::dIniInf ) + " > " + Dtoc( ::dFinInf ) } }

   if !::oGrupoGCliente:Cargo:Todos
      aAdd( ::aHeader, {|| Padr( "Grp. cliente", 13 ) + ": " + AllTrim( ::oGrupoGCliente:Cargo:Desde ) + " > " + AllTrim( ::oGrupoGCliente:Cargo:Hasta ) } )
   end

   if !::oGrupoCliente:Cargo:Todos
      aAdd( ::aHeader, {|| Padr( "Cliente", 13 ) + ": " + AllTrim( ::oGrupoCliente:Cargo:Desde ) + " > " + AllTrim( ::oGrupoCliente:Cargo:Hasta ) } )
   end

   if !::oGrupoFPago:Cargo:Todos
      aAdd( ::aHeader, {|| Padr( "Forma de pago", 13 ) + ": " + AllTrim( ::oGrupoFPago:Cargo:Desde ) + " > " + AllTrim( ::oGrupoFPago:Cargo:Hasta ) } )
   end

   ::oFacCliP:OrdSetFocus( "nNumFac" )

   if ::lExcCero
      cExpHead       := '!lCobrado .and. ( ( dFecVto >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. dFecVto <= Ctod( "' + Dtoc( ::dFinInf ) + '" ) ) .or. Empty( dFecVto ) )'
   else
      cExpHead       := '!lCobrado .and. ( ( dFecVto >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. dFecVto <= Ctod( "' + Dtoc( ::dFinInf ) + '" ) ) )'
   end

   if !::oGrupoCliente:Cargo:Todos
      cExpHead    += '.and. cCodCli >= "' + Rtrim( ::oGrupoCliente:Cargo:Desde ) + '" .and. cCodCli <= "' + Rtrim( ::oGrupoCliente:Cargo:Hasta ) + '"'
   end

   if !::oGrupoFPago:Cargo:Todos
      cExpHead    += '.and. cCodPgo >= "' + Rtrim( ::oGrupoFPago:Cargo:Desde ) + '" .and. cCodPgo <= "' + Rtrim( ::oGrupoFPago:Cargo:Hasta ) + '"'
   end

   if !Empty( ::oFilter:cExpresionFilter )
      cExpHead    += " .and. " + ::oFilter:cExpresionFilter
   end

   ::oFacCliP:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oFacCliP:cFile ), ::oFacCliP:OrdKey(), ( cExpHead ), , , , , , , , .T. )

   ::oMtrInf:SetTotal( ::oFacCliP:OrdKeyCount() )

   ::oFacCliP:GoTop()

   while !::oFacCliP:Eof()

      cCodGCli     := oRetFld( ::oFacCliP:cCodCli, ::oGrpCli:oDbf, "cCodGrp" )





      if ( ::oGrupoGCliente:Cargo:Todos .OR. ( cCodGCli >= ::oGrupoGCliente:Cargo:Desde .AND. cCodGCli <= ::oGrupoGCliente:Cargo:Hasta ) )    .AND. Empty( ::oFacCliP:dEntrada )                                                                                                         .AND. ( ::oEstadoDos:nAt == 1                                     .OR. ( ::oEstadoDos:nAt == 2 .AND. Empty( ::oFacCliP:cTipRec ) ) .OR. ( ::oEstadoDos:nAt == 3 .AND. !Empty( ::oFacCliP:cTipRec ) ) )

         ::oDbf:Append()

         ::oDbf:cTipDoc   := if( !Empty( ::oFacCliP:cTipRec ), "Rectificativa", "Factura" )
         ::oDbf:cNumDoc   := ::oFacCliP:cSerie + "/" + AllTrim( Str( ::oFacCliP:nNumFac ) ) + if( Empty( ::oFacCliP:cSufFac ), "" + "-" + AllTrim( Str( ::oFacCliP:nNumRec ) ), "/" + ::oFacCliP:cSufFac + "-" + AllTrim( Str( ::oFacCliP:nNumRec ) ) )
         ::oDbf:cCodGCli  := cCodGCli
         ::oDbf:cNomGCli  := oRetFld( cCodGCli, ::oGrpCli:oDbf )
         ::oDbf:cCodCli   := ::oFacCliP:cCodCli
         ::oDbf:cNomCli   := ::oFacCliP:cNomCli
         ::oDbf:cCodFpg   := ::oFacCliP:cCodPgo
         ::oDbf:cNomFpg   := oRetFld( ::oFacCliP:cCodPgo, ::oDbfFpg )
         ::oDbf:dFecMov   := ::oFacCliP:dPreCob
         ::oDbf:dFecPre   := ::oFacCliP:dFecVto
         ::oDbf:cDescrip  := ::oFacCliP:cDesCrip
         ::oDbf:nImporte  := ::oFacCliP:nImporte / ::oFacCliP:nVdvPgo
         ::oDbf:cBanco    := ::oFacCliP:cBncCli
         ::oDbf:cCuenta   := Trans( cClientCuenta( ::oFacCliP:cCodCli ), "@R ####-####-##-##########" )

         ::oDbf:cBncEmp   := ::oFacCliP:cBncEmp
         ::oDbf:cCtaEmp   := ::oFacCliP:cEntEmp + "-" + ::oFacCliP:cSucEmp + "-" + ::oFacCliP:cDigEmp + "-" + ::oFacCliP:cCtaEmp

         ::oDbf:Save()

      end

      ::oFacCliP:Skip()

      ::oMtrInf:AutoInc( ::oFacCliP:OrdKeyNo() )

   end

   ::oMtrInf:AutoInc( ::oFacCliP:LastRec() )

   ::oFacCliP:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oFacCliP:cFile ) )

   do case
      case ::oEstadoUno:nAt == 1
         ::oDbf:OrdSetFocus( "cNumDoc" )

      case ::oEstadoUno:nAt == 2
         ::oDbf:OrdSetFocus( "dFecMov" )

      case ::oEstadoUno:nAt == 3
         ::oDbf:OrdSetFocus( "dFecPre" )

   end

   ::oDlg:Enable()

RETURN ( ::oDbf:LastRec() > 0 )
