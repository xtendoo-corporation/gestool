#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 8 ".\.\Prg\Intitem.prg"
_HB_CLASS TSenderReciverItem ; function TSenderReciverItem ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TSenderReciverItem", iif( .F., { }, { @HBObject() } ), @TSenderReciverItem() ) ) ;

   _HB_MEMBER { cText } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cText"}, .F. )

   _HB_MEMBER { oSender } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSender"}, .F. )

   _HB_MEMBER { lSelectSend } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lSelectSend"}, .F. )
   _HB_MEMBER { lSelectRecive } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lSelectRecive"}, .F. )

   _HB_MEMBER { nNumberSend } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumberSend"}, .F. )
   _HB_MEMBER { nNumberRecive } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumberRecive"}, .F. )

   _HB_MEMBER { cIniFile } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cIniFile"}, .F. )

   _HB_MEMBER { cFileName } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileName"}, .F. )

   _HB_MEMBER { lSuccesfullSend } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lSuccesfullSend"}, .F. )

   _HB_MEMBER { cErrorRecepcion } ; oClass:AddMultiData(, "", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cErrorRecepcion"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @TSenderReciverItem_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CreateData() ; oClass:AddVirtual( "CreateData" )

   _HB_MEMBER RestoreData() ; oClass:AddVirtual( "RestoreData" )

   _HB_MEMBER SendData() ; oClass:AddVirtual( "SendData" )

   _HB_MEMBER ReciveData() ; oClass:AddVirtual( "ReciveData" )

   _HB_MEMBER Process() ; oClass:AddVirtual( "Process" )

   _HB_MEMBER Save(); oClass:AddMethod( "Save", @TSenderReciverItem_Save(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Load(); oClass:AddMethod( "Load", @TSenderReciverItem_Load(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nGetNumberToSend(); oClass:AddMethod( "nGetNumberToSend", @TSenderReciverItem_nGetNumberToSend(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SetNumberToSend(); oClass:AddInline( "SetNumberToSend", {|Self | ( ( Self ) ), WritePProString( "Numero", ::cText, cValToChar( ::nNumberSend ), ::cIniFile ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER IncNumberToSend(); oClass:AddInline( "IncNumberToSend", {|Self | ( ( Self ) ), WritePProString( "Numero", ::cText, cValToChar( ++::nNumberSend ), ::cIniFile ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GetFileNameToSend( cPrefixFile); oClass:AddMethod( "GetFileNameToSend", @TSenderReciverItem_GetFileNameToSend(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getTitle(); oClass:AddInline( "getTitle", {|Self | ( ( Self ) ), ( ::cText ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setSelectSend(); oClass:AddInline( "setSelectSend", {|Self, lSelect | ( ( Self ) ), ( ::lSelectSend := lSelect ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getSelectSend(); oClass:AddInline( "getSelectSend", {|Self, lSelect | ( ( Self ) ), ( ::lSelectSend ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setSelectRecive(); oClass:AddInline( "setSelectRecive", {|Self, lSelect | ( ( Self ) ), ( ::lSelectRecive := lSelect ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getSelectRecive(); oClass:AddInline( "getSelectRecive", {|Self, lSelect | ( ( Self ) ), ( ::lSelectRecive ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TSenderReciverItem ;



static FUNCTION TSenderReciverItem_New( cText, oSender ) ; local Self AS CLASS TSenderReciverItem := QSelf() AS CLASS TSenderReciverItem

   ::cText           := cText
   ::oSender         := oSender

   ::cIniFile        := cFullPathEmpresa() + "Empresa.Ini"

   ::lSuccesfullSend := .F.

RETURN ( Self )



static FUNCTION TSenderReciverItem_Save( ) ; local Self AS CLASS TSenderReciverItem := QSelf() AS CLASS TSenderReciverItem

   WritePProString( "Envio",     ::cText, cValToChar( ::lSelectSend ), ::cIniFile )
   WritePProString( "Recepcion", ::cText, cValToChar( ::lSelectRecive ), ::cIniFile )

RETURN ( Self )



static FUNCTION TSenderReciverItem_Load( ) ; local Self AS CLASS TSenderReciverItem := QSelf() AS CLASS TSenderReciverItem

   ::lSelectSend     := ( Upper( GetPvProfString( "Envio", ::cText, cValToChar( ::lSelectSend ), ::cIniFile ) ) == ".T." )
   ::lSelectRecive   := ( Upper( GetPvProfString( "Recepcion", ::cText, cValToChar( ::lSelectRecive ), ::cIniFile ) ) == ".T." )

RETURN ( Self )



static FUNCTION TSenderReciverItem_nGetNumberToSend( ) ; local Self AS CLASS TSenderReciverItem := QSelf() AS CLASS TSenderReciverItem

   ::nNumberSend     := GetPvProfInt( "Numero", ::cText, ::nNumberSend, ::cIniFile )

Return ( ::nNumberSend )



static FUNCTION TSenderReciverItem_GetFileNameToSend( cPrefixFile ) ; local Self AS CLASS TSenderReciverItem := QSelf() AS CLASS TSenderReciverItem

   local cFileName   := cPrefixFile + strzero( ::nGetNumberToSend(), 6 )

   if ::oSender:lServer
      cFileName      += ".All"
   else
      cFileName      += "." + retSufEmp()
   end

Return ( cFileName )



_HB_CLASS TClienteSenderReciver ; function TClienteSenderReciver ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TClienteSenderReciver", iif( .T., { @TSenderReciverItem() }, { @HBObject() } ), @TClienteSenderReciver() ) ) ;

   _HB_MEMBER { cFileName } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileName"}, .F. )

   _HB_MEMBER CreateData(); oClass:AddMethod( "CreateData", @TClienteSenderReciver_CreateData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RestoreData(); oClass:AddMethod( "RestoreData", @TClienteSenderReciver_RestoreData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SendData(); oClass:AddMethod( "SendData", @TClienteSenderReciver_SendData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ReciveData(); oClass:AddMethod( "ReciveData", @TClienteSenderReciver_ReciveData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Process(); oClass:AddMethod( "Process", @TClienteSenderReciver_Process(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CleanRelation( cCodCli); oClass:AddMethod( "CleanRelation", @TClienteSenderReciver_CleanRelation(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TClienteSenderReciver ;



static FUNCTION TClienteSenderReciver_CreateData( ) ; local Self AS CLASS TClienteSenderReciver := QSelf() AS CLASS TClienteSenderReciver

   local lSnd        := .F.
   local tmpCli
   local tmpAtp
   local tmpObr
   local tmpCon
   local dbfClient
   local dbfCliAtp
   local dbfObrasT
   local dbfContactos
   local oError
   local oBlock
   local oAtipicas

   if ::oSender:lServer
      ::cFileName      := "Cli" + win_uuidcreatestring() + ".All"
   else
      ::cFileName      := "Cli" + win_uuidcreatestring() + "." + RetSufEmp()
   end

   ::oSender:SetText( "Enviando clientes" )

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
   ( dbfClient )->( OrdSetFocus( "lSndInt" ) )

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliAtp.Dbf" ), ( cCheckArea( "CLIATP", @dbfCliAtp ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "CliAtp.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAST", @dbfObrasT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliCto.Dbf" ), ( cCheckArea( "CliCto", @dbfContactos ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "CliCto.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end





   mkClient( cPatSnd() )

   dbUseArea( .T., cLocalDriver(), cPatSnd() + "Client.Dbf", cCheckArea( "Client", @tmpCli ), .F. )
   ( tmpCli )->( ordListAdd( cPatSnd() + "Client.Cdx" ) )

   dbUseArea( .T., cLocalDriver(), cPatSnd() + "ObrasT.Dbf", cCheckArea( "ObrasT", @tmpObr ), .F. )
   ( tmpObr )->( ordListAdd( cPatSnd() + "ObrasT.Cdx" ) )

   dbUseArea( .T., cLocalDriver(), cPatSnd() + "CliCto.Dbf", cCheckArea( "CliCto", @tmpCon ), .F. )
   ( tmpCon )->( ordListAdd( cPatSnd() + "CliCto.Cdx" ) )





   oAtipicas   := TAtipicas():New( cPatSnd(), cLocalDriver() )
   oAtipicas:OpenFiles( .F., cPatSnd() )

   tmpAtp      := oAtipicas:oDbf:cAlias

   if !Empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( dbfClient )->( lastrec() )
   end

   ( dbfClient )->( dbGoTop() )
   while !( dbfClient )->( eof() )





      if ( dbfClient )->lSndInt .AND. ( dbfClient )->nTipCli <> 2

         lSnd  := .T.

         dbPass( dbfClient, tmpCli, .T. )
         ::oSender:SetText( AllTrim( ( dbfClient )->Cod ) + "; " + ( dbfClient )->Titulo )

         if ( dbfObrasT )->( dbSeek( ( dbfClient )->Cod ) )
            while ( dbfObrasT )->cCodCli == ( dbfClient )->Cod .AND. !( dbfObrasT )->( Eof() )
               dbPass( dbfObrasT, tmpObr, .T. )
               SysRefresh()
               ( dbfObrasT )->( dbSkip() )
            end
         end

         if ( dbfContactos )->( dbSeek( ( dbfClient )->Cod ) )
            while ( dbfContactos )->cCodCli == ( dbfClient )->Cod .AND. !( dbfContactos )->( Eof() )
               dbPass( dbfContactos, tmpCon, .T. )
               SysRefresh()
               ( dbfContactos )->( dbSkip() )
            end
         end

         if ( dbfCliAtp )->( dbSeek( ( dbfClient )->Cod ) )
            while ( dbfCliAtp )->cCodCli == ( dbfClient )->Cod .AND. !( dbfCliAtp )->( Eof() )
               Logwrite( ( dbfcliatp )->( OrdKeyNo() ) )
               dbPass( dbfCliAtp, tmpAtp, .T. )
               SysRefresh()
               ( dbfCliAtp )->( dbSkip() )
            end
         end

      end

      SysRefresh()

      ( dbfClient )->( dbSkip() )

      if !Empty( ::oSender:oMtr )
         ::oSender:oMtr:Set( ( dbfClient )->( OrdKeyNo() ) )
      end

   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos" )

   end
   ErrorBlock( oBlock )

   oAtipicas:CloseFiles()
   oAtipicas:End()

   ( tmpCli       )->( dbCloseArea() )
   ( tmpObr       )->( dbCloseArea() )
   ( tmpCon       )->( dbCloseArea() )
   ( dbfClient    )->( dbCloseArea() )
   ( dbfCliAtp    )->( dbCloseArea() )
   ( dbfObrasT    )->( dbCloseArea() )
   ( dbfContactos )->( dbCloseArea() )



   if lSnd

      ::oSender:SetText( "Comprimiendo clientes : " + ::cFileName )

      if ::oSender:lZipData( ::cFileName )
         ::oSender:SetText( "Ficheros comprimidos : " + ::cFileName )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay clientes para enviar" )

   end

Return ( Self )



static FUNCTION TClienteSenderReciver_RestoreData( ) ; local Self AS CLASS TClienteSenderReciver := QSelf() AS CLASS TClienteSenderReciver

   local oError
   local oBlock
   local dbfClient

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if ::lSuccesfullSend

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      while !( dbfClient )->( eof() )

         if ( dbfClient )->lSndInt .AND. dbLock( dbfClient )
            ( dbfClient )->lSndInt := .F.
            ( dbfClient )->( dbUnlock() )
         end

         ( dbfClient )->( dbSkip() )

      end

      ( dbfClient )->( dbCloseArea() )

   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos" )

   end
   ErrorBlock( oBlock )

Return ( Self )



static FUNCTION TClienteSenderReciver_SendData( ) ; local Self AS CLASS TClienteSenderReciver := QSelf() AS CLASS TClienteSenderReciver

   if file( cPatOut() + ::cFileName )

      if ::oSender:SendFiles( cPatOut() + ::cFileName, ::cFileName )
         ::lSuccesfullSend := .T.
         ::oSender:SetText( "Ficheros de clientes enviados " + ::cFileName )
      else
         ::oSender:SetText( "ERROR fichero de clientes no enviado" )
      end

   end

Return Self



static FUNCTION TClienteSenderReciver_ReciveData( ) ; local Self AS CLASS TClienteSenderReciver := QSelf() AS CLASS TClienteSenderReciver

   local n
   local aExt





   if ::oSender:lServer
      aExt              := aRetDlgEmp()
   else
      aExt              := { "All" }
   end

   ::oSender:SetText( "Recibiendo clientes" )

   for n := 1 to len( aExt )
      ::oSender:GetFiles( "Cli*." + aExt[ n ], cPatIn() )
   next

   ::oSender:SetText( "Clientes recibidos" )

Return Self



static FUNCTION TClienteSenderReciver_Process( ) ; local Self AS CLASS TClienteSenderReciver := QSelf() AS CLASS TClienteSenderReciver

   local m
   local tmpCli
   local tmpAtp
   local tmpObr
   local tmpCon
   local dbfClient
   local dbfCliAtp
   local dbfObrasT
   local dbfContactos
   local aFiles               := Directory( cPatIn() + "Cli*.*" )
   local oBlock
   local oError





   for m := 1 to len( aFiles )

      oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      if fSize( cPatIn() + aFiles[ m, 1 ] ) > 0





         if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )




            if lExistTable( cPatSnd() + "Client.Dbf", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "CliAtp.Dbf", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "ObrasT.Dbf", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "CliCto.Dbf", cLocalDriver() )

               dbUseArea( .T., cLocalDriver(), cPatSnd() + "Client.Dbf", cCheckArea( "Client", @tmpCli ), .F. )

               dbUseArea( .T., cLocalDriver(), cPatSnd() + "CliAtp.Dbf", cCheckArea( "CliAtp", @tmpAtp ), .F. )

               dbUseArea( .T., cLocalDriver(), cPatSnd() + "ObrasT.Dbf", cCheckArea( "ObrasT", @tmpObr ), .F. )

               dbUseArea( .T., cLocalDriver(), cPatSnd() + "CliCto.Dbf", cCheckArea( "CliConta", @tmpCon ), .F. )

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliAtp.Dbf" ), ( cCheckArea( "CLIATP", @dbfCliAtp ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "CliAtp.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end
               ordSetFocus( "cCliArt" )

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAST", @dbfObrasT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CliCto.Dbf" ), ( cCheckArea( "CLICONTA", @dbfContactos ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "CliCto.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

               if !Empty( ::oSender:oMtr )
                  ::oSender:oMtr:nTotal := ( tmpCli )->( lastrec() )
               end

               ( tmpCli )->( dbGoTop() )
               while !( tmpCli )->( eof() )

                  if ( dbfClient )->( dbSeek( ( tmpCli )->Cod ) )

                     if !::oSender:lServer

                        dbPass( tmpCli, dbfClient, .F. )

                        if dbLock( dbfClient )
                           ( dbfClient )->lSndInt := .F.
                           ( dbfClient )->( dbUnLock() )
                        end

                        ::oSender:SetText( "Reemplazado : " + alltrim( ( tmpCli )->Cod ) + "; " + ( tmpCli )->Titulo )

                        ::CleanRelation( ( tmpCli )->Cod, dbfCliAtp, dbfObrasT, dbfContactos )

                     else

                        ::oSender:SetText( "Desestimado : " + alltrim( ( tmpCli )->Cod ) + "; " + ( tmpCli )->Titulo )

                     end

                  else

                        dbPass( tmpCli, dbfClient, .T. )
                        if dbLock( dbfClient )
                           ( dbfClient )->lSndInt := .F.
                           ( dbfClient )->( dbUnLock() )
                        end
                        ::oSender:SetText( "Añadido : " + alltrim( ( tmpCli )->Cod ) + "; " + ( tmpCli )->Titulo )


                  end

                  ( tmpCli )->( dbSkip() )

                  if !Empty( ::oSender:oMtr )
                     ::oSender:oMtr:Set( ( tmpCli )->( recno() ) )
                  end

                  SysRefresh()

               end

               if !Empty( ::oSender:oMtr )
                  ::oSender:oMtr:nTotal      := ( tmpAtp )->( lastrec() )
               end

               ( tmpAtp )->( dbGoTop() )
               while !( tmpAtp )->( eof() )

                  if ( dbfCliAtp )->( dbSeek( ( tmpAtp )->cCodCli + ( tmpAtp )->cCodArt ) )
                     if !::oSender:lServer
                        dbPass( tmpAtp, dbfCliAtp, .F. )
                        ::oSender:SetText( "Reemplazado : " + alltrim( ( tmpAtp )->cCodCli ) + "; " + alltrim( ( tmpAtp )->cCodArt ) + "; " + alltrim( ( tmpAtp )->cCodFam ) )
                     else
                        ::oSender:SetText( "Desestimado : " + alltrim( ( tmpAtp )->cCodCli ) + "; " + alltrim( ( tmpAtp )->cCodArt ) + "; " + alltrim( ( tmpAtp )->cCodFam ) )
                     end
                  else
                        dbPass( tmpAtp, dbfCliAtp, .T. )
                        ::oSender:SetText( "Añadido : " + alltrim( ( tmpAtp )->cCodCli ) + "; " + alltrim( ( tmpAtp )->cCodArt ) + "; " + alltrim( ( tmpAtp )->cCodFam ) )
                  end

                  ( tmpAtp )->( dbSkip() )

                  if !Empty( ::oSender:oMtr )
                     ::oSender:oMtr:Set( ( tmpAtp )->( recno() ) )
                  end

                  SysRefresh()

               end

               ( tmpObr )->( dbGoTop() )
               while !( tmpObr )->( eof() )

                  if ( dbfObrasT )->( dbSeek( ( tmpObr )->cCodCli + ( tmpObr )->cCodObr ) )
                     if !::oSender:lServer
                        dbPass( tmpObr, dbfObrasT, .F. )
                     end
                  else
                        dbPass( tmpObr, dbfObrasT, .T. )
                  end

                  ( tmpObr )->( dbSkip() )

                  if !Empty( ::oSender:oMtr )
                     ::oSender:oMtr:Set( ( tmpObr )->( recno() ) )
                  end

                  SysRefresh()

               end

               ( tmpCon )->( dbGoTop() )
               while !( tmpCon )->( eof() )

                  if ( dbfObrasT )->( dbSeek( ( tmpCon )->cCodCli ) )
                     if !::oSender:lServer
                        dbPass( tmpCon, dbfContactos, .F. )
                     end
                  else
                        dbPass( tmpCon, dbfContactos, .T. )
                  end

                  ( tmpCon )->( dbSkip() )

                  if !Empty( ::oSender:oMtr )
                     ::oSender:oMtr:Set( ( tmpCon )->( recno() ) )
                  end

                  SysRefresh()

               end

               ( tmpCli    )->( dbCloseArea() )
               ( tmpAtp    )->( dbCloseArea() )
               ( tmpObr    )->( dbCloseArea() )
               ( tmpCon    )->( dbCloseArea() )
               ( dbfClient )->( dbCloseArea() )
               ( dbfCliAtp )->( dbCloseArea() )
               ( dbfObrasT )->( dbCloseArea() )
               ( dbfContactos )->( dbCloseArea() )

               ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

            else

               ::oSender:SetText( "Faltan ficheros" )

               if !lExistTable( cPatSnd() + "Client.Dbf", cLocalDriver() )
                  ::oSender:SetText( "Falta" + cPatSnd() + "Client.Dbf" )
               end

               if !lExistTable( cPatSnd() + "CliAtp.Dbf", cLocalDriver() )
                  ::oSender:SetText( "Falta" + cPatSnd() + "CliAtp.Dbf" )
               end

               if !lExistTable( cPatSnd() + "ObrasT.Dbf", cLocalDriver() )
                  ::oSender:SetText( "Falta" + cPatSnd() + "ObrasT.Dbf" )
               end

               if !lExistTable( cPatSnd() + "CliCto.Dbf", cLocalDriver() )
                  ::oSender:SetText( "Falta" + cPatSnd() + "CliCto.Dbf" )
               end

            end

         else

            ::oSender:SetText( "Error en ficheros comprimidos" )

         end

      else

         ::oSender:SetText( "Fichero vacio" )

      end

      RECOVER USING oError

         ( tmpCli       )->( dbCloseArea() )
         ( tmpAtp       )->( dbCloseArea() )
         ( tmpObr       )->( dbCloseArea() )
         ( tmpCon       )->( dbCloseArea() )
         ( dbfClient    )->( dbCloseArea() )
         ( dbfCliAtp    )->( dbCloseArea() )
         ( dbfObrasT    )->( dbCloseArea() )
         ( dbfContactos )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end
      ErrorBlock( oBlock )

   next

Return Self



static FUNCTION TClienteSenderReciver_CleanRelation( cCodCli, dbfCliAtp, dbfObrasT, dbfContactos ) ; local Self AS CLASS TClienteSenderReciver := QSelf() AS CLASS TClienteSenderReciver

   while ( dbfCliAtp )->( dbSeek( cCodCli ) )
      dbDel( dbfCliAtp )
   end

   SysRefresh()

   while ( dbfObrasT )->( dbSeek( cCodCli ) )
      dbDel( dbfObrasT )
   end

   SysRefresh()

   while ( dbfContactos )->( dbSeek( cCodCli ) )
      dbDel( dbfContactos )
   end

   SysRefresh()

Return Self
