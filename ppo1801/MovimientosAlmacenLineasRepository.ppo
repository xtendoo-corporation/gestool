#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 7 ".\Prg\Repositories\MovimientosAlmacenLineasRepository.prg"
_HB_CLASS MovimientosAlmacenLineasRepository ; function MovimientosAlmacenLineasRepository ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "MovimientosAlmacenLineasRepository", iif( .T., { @SQLBaseRepository() }, { @HBObject() } ), @MovimientosAlmacenLineasRepository() ) ) ;

   _HB_MEMBER getTableName(); oClass:AddInline( "getTableName", {|Self | ( ( Self ) ), ( SQLMovimientosAlmacenLineasModel():getTableName() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceFechaCaducidad( cCodigoArticulo, cValorPrimeraPropiedad, cValorSegundaPropiedad, cLote); oClass:AddMethod( "getSQLSentenceFechaCaducidad", @MovimientosAlmacenLineasRepository_getSQLSentenceFechaCaducidad(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceArticuloUuid( cCodigoArticulo, uuid); oClass:AddMethod( "getSQLSentenceArticuloUuid", @MovimientosAlmacenLineasRepository_getSQLSentenceArticuloUuid(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceWhereParentUuid( uuid); oClass:AddMethod( "getSQLSentenceWhereParentUuid", @MovimientosAlmacenLineasRepository_getSQLSentenceWhereParentUuid(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER getHashArticuloUuid(); oClass:AddInline( "getHashArticuloUuid", {|Self, cCodigoArticulo, uuid | ( ( Self ) ), ( getSQLDataBase():selectFetchHash( ::getSQLSentenceArticuloUuid( cCodigoArticulo, uuid ) ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSerializedColumnsSentenceToLabels(); oClass:AddMethod( "getSerializedColumnsSentenceToLabels", @MovimientosAlmacenLineasRepository_getSerializedColumnsSentenceToLabels(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceToLabels( initialId, finalId); oClass:AddMethod( "getSQLSentenceToLabels", @MovimientosAlmacenLineasRepository_getSQLSentenceToLabels(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceIdByUuid( uuid); oClass:AddMethod( "getSQLSentenceIdByUuid", @MovimientosAlmacenLineasRepository_getSQLSentenceIdByUuid(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getIdByUuid(); oClass:AddInline( "getIdByUuid", {|Self, nNumber | ( ( Self ) ), ( getSQLDataBase():getValue( ::getSqlSentenceIdByUuid( nNumber ) ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceTotalUnidades(); oClass:AddMethod( "getSQLSentenceTotalUnidades", @MovimientosAlmacenLineasRepository_getSQLSentenceTotalUnidades(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceFechaHoraConsolidacion(); oClass:AddMethod( "getSQLSentenceFechaHoraConsolidacion", @MovimientosAlmacenLineasRepository_getSQLSentenceFechaHoraConsolidacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getFechaHoraConsolidacion(); oClass:AddMethod( "getFechaHoraConsolidacion", @MovimientosAlmacenLineasRepository_getFechaHoraConsolidacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getHashFechaHoraConsolidacion(); oClass:AddMethod( "getHashFechaHoraConsolidacion", @MovimientosAlmacenLineasRepository_getHashFechaHoraConsolidacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getTotalUnidadesStock( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote); oClass:AddMethod( "getTotalUnidadesStock", @MovimientosAlmacenLineasRepository_getTotalUnidadesStock(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER getTotalUnidadesEntrada(); oClass:AddInline( "getTotalUnidadesEntrada", {|Self, tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote | ( ( Self ) ), ( ::getTotalUnidades( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote, .T. ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER getTotalUnidadesSalida(); oClass:AddInline( "getTotalUnidadesSalida", {|Self, tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote | ( ( Self ) ), ( ::getTotalUnidades( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote, .F. ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getTotalUnidades( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote, lEntrada); oClass:AddMethod( "getTotalUnidades", @MovimientosAlmacenLineasRepository_getTotalUnidades(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceMovimientosAlmacenForReport( oReporting); oClass:AddMethod( "getSQLSentenceMovimientosAlmacenForReport", @MovimientosAlmacenLineasRepository_getSQLSentenceMovimientosAlmacenForReport(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getRowSetMovimientosAlmacenForReport( oReporting); oClass:AddMethod( "getRowSetMovimientosAlmacenForReport", @MovimientosAlmacenLineasRepository_getRowSetMovimientosAlmacenForReport(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getRowSetMovimientosForArticulo(); oClass:AddMethod( "getRowSetMovimientosForArticulo", @MovimientosAlmacenLineasRepository_getRowSetMovimientosForArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSqlSentenceMovimientosForArticulo(); oClass:AddMethod( "getSqlSentenceMovimientosForArticulo", @MovimientosAlmacenLineasRepository_getSqlSentenceMovimientosForArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER getIdFromBuffer(); oClass:AddInline( "getIdFromBuffer", {|Self, hBuffer | ( ( Self ) ), ( getSQLDataBase():selectFetchHash( ::getSQLSentenceIdFromBuffer( hBuffer ) ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceIdFromBuffer( hBuffer); oClass:AddMethod( "getSQLSentenceIdFromBuffer", @MovimientosAlmacenLineasRepository_getSQLSentenceIdFromBuffer(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getPrimeraFechaCompra( cCodigoArticulo, cLote); oClass:AddMethod( "getPrimeraFechaCompra", @MovimientosAlmacenLineasRepository_getPrimeraFechaCompra(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getRowSetMovimientosForStock( hParams); oClass:AddMethod( "getRowSetMovimientosForStock", @MovimientosAlmacenLineasRepository_getRowSetMovimientosForStock(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSqlSentenceMovForStock(); oClass:AddMethod( "getSqlSentenceMovForStock", @MovimientosAlmacenLineasRepository_getSqlSentenceMovForStock(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS MovimientosAlmacenLineasRepository ;



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceFechaCaducidad( cCodigoArticulo, cValorPrimeraPropiedad, cValorSegundaPropiedad, cLote ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSql  := "SELECT "
      cSql     +=    "movimientos_almacen_lineas.fecha_caducidad "
      cSql     += "FROM " + ::getTableName() + " "
      cSql     +=    "INNER JOIN movimientos_almacen ON movimientos_almacen_lineas.parent_uuid = movimientos_almacen.uuid "
      cSql     += "WHERE movimientos_almacen.empresa = " + quoted( cCodEmp() ) + " "
      cSql     +=    "AND movimientos_almacen_lineas.codigo_articulo = " + quoted( cCodigoArticulo ) + " "
      cSql     +=    "AND movimientos_almacen_lineas.fecha_caducidad IS NOT NULL "

   if !empty(cValorPrimeraPropiedad)
      cSql     +=    "AND movimientos_almacen_lineas.valor_primera_propiedad = " + quoted( cValorPrimeraPropiedad ) + " "
   end

   if !empty(cValorSegundaPropiedad)
      cSql     +=    "AND movimientos_almacen_lineas.valor_segunda_propiedad = " + quoted( cValorSegundaPropiedad ) + " "
   end

   if !empty(cLote)
      cSql     +=    "AND movimientos_almacen_lineas.lote = " + quoted( cLote ) + " "
   end

RETURN ( cSql )



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceArticuloUuid( cCodigoArticulo, cParentUuid ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository




   local cSql  := "SELECT * "                                                    +  "FROM " + ::getTableName() + " "                               +  "WHERE codigo_articulo = " + quoted( cCodigoArticulo ) + " "   +  "AND parent_uuid = " + quoted( cParentUuid )

RETURN ( cSql )



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceWhereParentUuid( cParentUuid ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository



   local cSql  := "SELECT * FROM " + ::getTableName()                            + " " +   "WHERE parent_uuid = " + quoted( cParentUuid )              + " " +   "ORDER BY id"

RETURN ( cSql )



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceIdFromBuffer( hBuffer ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSql










   cSql  := "SELECT id FROM " + ::getTableName()                                                            + " " +  "WHERE codigo_articulo = "             + quoted( hget( hBuffer, "codigo_articulo" ) )           + " " +  "AND parent_uuid = "                + quoted( hget( hBuffer, "parent_uuid" ) )               + " " +  "AND codigo_primera_propiedad = "   + quoted( hget( hBuffer, "codigo_primera_propiedad" ) )  + " " +  "AND codigo_segunda_propiedad = "   + quoted( hget( hBuffer, "codigo_segunda_propiedad" ) )  + " " +  "AND valor_primera_propiedad = "    + quoted( hget( hBuffer, "valor_primera_propiedad" ) )   + " " +  "AND valor_segunda_propiedad = "    + quoted( hget( hBuffer, "valor_segunda_propiedad" ) )   + " " +  "AND lote = "                       + quoted( hget( hBuffer, "lote" ) )                      + " " +  "AND precio_articulo = "            + toSqlString( hget( hBuffer, "precio_articulo" ) )      + " " +  "LIMIT 1"

RETURN ( cSql )



static FUNCTION MovimientosAlmacenLineasRepository_getSerializedColumnsSentenceToLabels( ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository







   local cSerializedColumns   := "id;"                         +  "codigo_articulo;"            +  "nombre_articulo;"            +  "codigo_primera_propiedad;"   +  "codigo_segunda_propiedad;"   +  "valor_primera_propiedad;"    +  "valor_segunda_propiedad"

RETURN ( cSerializedColumns )



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceToLabels( aIds, nFixLabels, cOrderBy ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository








   local cSql  := "SELECT "                                                                              +  "movimientos_almacen_lineas.id AS id, "                                             +  "movimientos_almacen_lineas.codigo_articulo AS codigo_articulo, "                   +  "movimientos_almacen_lineas.nombre_articulo AS nombre_articulo, "                   +  "movimientos_almacen_lineas.codigo_primera_propiedad AS codigo_primera_propiedad, " +  "movimientos_almacen_lineas.codigo_segunda_propiedad AS codigo_segunda_propiedad, " +  "movimientos_almacen_lineas.valor_primera_propiedad AS valor_primera_propiedad, "   +  "movimientos_almacen_lineas.valor_segunda_propiedad AS valor_segunda_propiedad, "

   if empty( nFixLabels )
      cSql     +=    SQLMovimientosAlmacenLineasModel():getSQLSubSentenceTotalUnidadesLinea()
   else
      cSql     +=    toSqlString( nFixLabels ) + " AS total_unidades "
   end



   cSql        += "FROM movimientos_almacen_lineas "                                                     +  "INNER JOIN movimientos_almacen ON movimientos_almacen_lineas.parent_uuid = movimientos_almacen.uuid " +  "WHERE movimientos_almacen.id IN ( "

   aeval( aIds, {|nId| cSql += quoted( nId ) + "," } )

   cSql        := chgAtEnd( cSql, " ) ", 1 )

   if !empty( cOrderBy )
      cSql     += "ORDER BY " + ( cOrderBy )
   end

RETURN ( cSql )



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceFechaHoraConsolidacion( cCodigoArticulo, cCodigoAlmacen, cCodigoPrimeraPropiedad, cCodigoSegundaPropiedad, cValorPrimeraPropiedad, cValorSegundaPropiedad, cLote, dFechaFinLimite ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository







   local cSql  := "SELECT "                                                                              +  "cabecera.fecha_hora "                                                              +  "FROM movimientos_almacen_lineas lineas "                                              +  "INNER JOIN movimientos_almacen cabecera ON lineas.parent_uuid = cabecera.uuid "    +  "WHERE empresa_codigo = " + quoted( cCodEmp() ) + " "                                  +  "AND lineas.codigo_articulo = " + quoted( cCodigoArticulo ) + " "                   +  "AND cabecera.tipo_movimiento = 4 "

   if !empty( cCodigoAlmacen )
      cSql     +=    "AND cabecera.almacen_destino = " + quoted( cCodigoAlmacen ) + " "
   end

   cSql        +=    "AND lineas.codigo_primera_propiedad = " + quoted( cCodigoPrimeraPropiedad ) + " "
   cSql        +=    "AND lineas.codigo_segunda_propiedad = " + quoted( cCodigoSegundaPropiedad ) + " "
   cSql        +=    "AND lineas.valor_primera_propiedad = " + quoted( cValorPrimeraPropiedad ) + " "
   cSql        +=    "AND lineas.valor_segunda_propiedad = " + quoted( cValorSegundaPropiedad ) + " "
   cSql        +=    "AND lineas.lote = " + quoted( cLote, .T. ) + " "

   if !empty( dFechaFinLimite )

      cSql     +=    "AND cabecera.fecha_hora <= " + quoted( hb_dtoc( dFechaFinLimite, "yyyy-mm-dd" ) + " 23:59:59" ) + " "
   end


   cSql        += "ORDER BY cabecera.fecha_hora DESC " +  "LIMIT 1"

RETURN ( cSql )



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceIdByUuid( uuid ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSql        := "SELECT id "
   cSql              +=    "FROM " + ::getTableName() + " "
   cSql              +=    "WHERE uuid = " + quoted( uuid )

RETURN ( cSql )



static FUNCTION MovimientosAlmacenLineasRepository_getFechaHoraConsolidacion( cCodigoArticulo, cCodigoAlmacen, cCodigoPropiedad1, cCodigoPropiedad2, cValorPropiedad1, cValorPropiedad2, cLote, dFechaFinLimite ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSentence

   cSentence   := ::getSqlSentenceFechaHoraConsolidacion( cCodigoArticulo, cCodigoAlmacen, cCodigoPropiedad1, cCodigoPropiedad2, cValorPropiedad1, cValorPropiedad2, cLote, dFechaFinLimite )

RETURN ( ::getDatabase():getValue( cSentence ) )



static FUNCTION MovimientosAlmacenLineasRepository_getHashFechaHoraConsolidacion( cCodigoArticulo, cCodigoAlmacen, cCodigoPropiedad1, cCodigoPropiedad2, cValorPropiedad1, cValorPropiedad2, cLote ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local aBuffer
   local hResult     := {=>}
   local cSentence   := ::getSqlSentenceFechaHoraConsolidacion( cCodigoArticulo, cCodigoAlmacen, cCodigoPropiedad1, cCodigoPropiedad2, cValorPropiedad1, cValorPropiedad2, cLote )

   aBuffer           := ::getDatabase():selectFetchHash( cSentence )

   if hb_isarray( aBuffer ) .AND. len( aBuffer ) > 0


      hResult        := { "fecha"      => hb_ttod( hGet( atail( aBuffer ), "fecha_hora" ) ), "hora"       => substr( hb_tstostr( hGet( atail( aBuffer ), "fecha_hora" ) ), 12, 8 ), "fecha_hora" => hGet( atail( aBuffer ), "fecha_hora" ) }
   end

RETURN ( hResult )



static FUNCTION MovimientosAlmacenLineasRepository_getTotalUnidadesStock( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local nEntrada    := ::getTotalUnidadesEntrada( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote )
   local nSalida     := ::getTotalUnidadesSalida( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote )

RETURN ( nEntrada - nSalida )



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceTotalUnidades( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote, lEntrada ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSentence

   cSentence         := "SELECT movimientos_almacen.id, "
   cSentence         +=    "movimientos_almacen.fecha_hora, "
   cSentence         +=    "movimientos_almacen.almacen_destino, "
   cSentence         +=    "movimientos_almacen.almacen_origen, "
   cSentence         +=    "movimientos_almacen_lineas.parent_uuid, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.valor_primera_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.valor_segunda_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.lote, "
   cSentence         +=    "movimientos_almacen_lineas.cajas_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.unidades_articulo, "
   cSentence         +=    SQLMovimientosAlmacenLineasModel():getSQLSubSentenceSumatorioUnidadesLinea()
   cSentence         += "FROM movimientos_almacen "

   cSentence         += "INNER JOIN movimientos_almacen_lineas "
   cSentence         +=    "ON movimientos_almacen_lineas.parent_uuid = movimientos_almacen.uuid "

   cSentence         += "WHERE empresa = " + quoted( cCodEmp() ) + " "

   if lEntrada
      cSentence      +=    "AND movimientos_almacen.almacen_destino = " + quoted( cCodigoAlmacen ) + " "
   else
      cSentence      +=    "AND movimientos_almacen.almacen_origen = " + quoted( cCodigoAlmacen ) + " "
   end

   if !empty( tConsolidacion )
      cSentence      +=    "AND movimientos_almacen.fecha_hora >= " + quoted( hb_tstostr( tConsolidacion ) ) + " "
   end

   cSentence         +=    "AND movimientos_almacen_lineas.codigo_articulo = " + quoted( cCodigoArticulo ) + " "
   cSentence         +=    "AND movimientos_almacen_lineas.valor_primera_propiedad = " + quoted( cValorPropiedad1 ) + " "
   cSentence         +=    "AND movimientos_almacen_lineas.valor_segunda_propiedad = " + quoted( cValorPropiedad2 ) + " "
   cSentence         +=    "AND movimientos_almacen_lineas.lote = " + quoted( cLote ) + " "
   cSentence         += "LIMIT 1"

RETURN ( cSentence )



static FUNCTION MovimientosAlmacenLineasRepository_getTotalUnidades( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote, lEntrada ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local aBuffer
   local cSentence
   local nTotal      := 0

   cSentence         := ::getSqlSentenceTotalUnidades( tConsolidacion, cCodigoArticulo, cCodigoAlmacen, cValorPropiedad1, cValorPropiedad2, cLote, lEntrada )

   aBuffer           := ::getDatabase():selectFetchHash( cSentence )
   if !hb_isnil( aBuffer )
      nTotal         := hGet( atail( aBuffer ), "totalUnidadesStock" )
   end

RETURN ( nTotal )



static FUNCTION MovimientosAlmacenLineasRepository_getSQLSentenceMovimientosAlmacenForReport( oReporting ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSentence

   cSentence         := "SELECT movimientos_almacen.id, "
   cSentence         +=    "movimientos_almacen.numero, "
   cSentence         +=    "CAST( movimientos_almacen.fecha_hora AS date ) AS fecha, "
   cSentence         +=    "CAST( movimientos_almacen.fecha_hora AS time ) AS hora, "
   cSentence         +=    SQLMovimientosAlmacenModel():getColumnMovimiento( "movimientos_almacen" )
   cSentence         +=    "movimientos_almacen.almacen_destino, "
   cSentence         +=    "movimientos_almacen.almacen_origen, "
   cSentence         +=    "movimientos_almacen_lineas.uuid AS uuid, "
   cSentence         +=    "movimientos_almacen_lineas.parent_uuid, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_primera_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_segunda_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.valor_primera_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.valor_segunda_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.lote, "
   cSentence         +=    "movimientos_almacen_lineas.fecha_caducidad, "
   cSentence         +=    "movimientos_almacen_lineas.bultos_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.cajas_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.unidades_articulo, "
   cSentence         +=    SQLMovimientosAlmacenLineasModel():getSQLSubSentenceTotalUnidadesLinea( "movimientos_almacen_lineas", "total_unidades" ) + ", "
   cSentence         +=    "movimientos_almacen_lineas.precio_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.precio_venta "
   cSentence         += "FROM movimientos_almacen_lineas "
   cSentence         += "INNER JOIN movimientos_almacen "
   cSentence         +=    "ON movimientos_almacen.uuid = movimientos_almacen_lineas.parent_uuid "
   cSentence         += "WHERE movimientos_almacen.empresa_codigo = " + quoted( cCodEmp() ) + " "
   cSentence         += "AND ( CAST( movimientos_almacen.fecha_hora AS date ) >= " + AllTrim( dTos( oReporting:dIniInf ) ) + " "
   cSentence         += "AND CAST( movimientos_almacen.fecha_hora AS date ) <= " + AllTrim( dTos( oReporting:dFinInf ) ) + " )"

RETURN ( cSentence )



static FUNCTION MovimientosAlmacenLineasRepository_getRowSetMovimientosAlmacenForReport( oReporting ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

RETURN ( SQLRowSet():New():Build( ::getSqlSentenceMovimientosAlmacenForReport( oReporting ) ) )
















static FUNCTION MovimientosAlmacenLineasRepository_getSqlSentenceMovimientosForArticulo( hParams ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSentence

   if !hhaskey( hParams, "codigo_articulo" )
      msgStop( "El código de artículo es un parametro obligatorio", "getSQLSentenceMovimientosForArticulo" )
      RETURN ( "" )
   end

   cSentence         := "SELECT "
   cSentence         +=    "movimientos_almacen.id, "
   cSentence         +=    "movimientos_almacen.numero, "
   cSentence         +=    "CAST( movimientos_almacen.fecha_hora AS DATE ) AS fecha, "
   cSentence         +=    "CAST( movimientos_almacen.fecha_hora AS TIME ) AS hora, "
   cSentence         +=    SQLMovimientosAlmacenModel():getColumnMovimiento( "movimientos_almacen" )
   cSentence         +=    "movimientos_almacen.almacen_destino, "
   cSentence         +=    "movimientos_almacen.almacen_origen, "
   cSentence         +=    "movimientos_almacen_lineas.parent_uuid, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_primera_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_segunda_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.valor_primera_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.valor_segunda_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.lote, "
   cSentence         +=    "movimientos_almacen_lineas.bultos_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.cajas_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.unidades_articulo, "
   cSentence         +=    SQLMovimientosAlmacenLineasModel():getSQLSubSentenceTotalUnidadesLinea( "movimientos_almacen_lineas", "total_unidades" ) + ", "
   cSentence         +=    "movimientos_almacen_lineas.precio_articulo "

   cSentence         += "FROM movimientos_almacen_lineas "

   cSentence         += "INNER JOIN movimientos_almacen "
   cSentence         +=    "ON movimientos_almacen.uuid = movimientos_almacen_lineas.parent_uuid "

   cSentence         += "WHERE movimientos_almacen.empresa_codigo = " + quoted( hget( hParams, "empresa" ) ) + " "

   cSentence         +=    "AND movimientos_almacen_lineas.codigo_articulo = " + quoted( hget( hParams, "codigo_articulo" ) ) + " "

   if hhaskey( hParams, "year" ) .AND. !empty( hget( hParams, "year" ) )
      cSentence      +=    "AND DATE_FORMAT( CAST( movimientos_almacen.fecha_hora AS date ), '%Y' ) = " + Str( hget( hParams, "year" ) ) + " "
   end

   if hhaskey( hParams, "almacen" ) .AND. !empty( hget( hParams, "almacen" ) )
      cSentence      +=    "AND ( movimientos_almacen.almacen_destino = " + quoted( hget( hParams, "almacen" ) ) + " OR movimientos_almacen.almacen_origen = " + quoted( hget( hParams, "almacen" ) ) + " ) "
   end

   if hhaskey( hParams, "codigo_primera_propiedad" )
      cSentence      +=    "AND movimientos_almacen_lineas.codigo_primera_propiedad = " + quoted( hget( hParams, "codigo_primera_propiedad" ) )  + " "
   end

   if hhaskey( hParams, "codigo_segunda_propiedad" )
      cSentence      +=    "AND movimientos_almacen_lineas.codigo_segunda_propiedad = " + quoted( hget( hParams, "codigo_segunda_propiedad" ) )  + " "
   end

   if hhaskey( hParams, "valor_primera_propiedad" )
      cSentence      +=    "AND movimientos_almacen_lineas.valor_primera_propiedad = " + quoted( hget( hParams, "valor_primera_propiedad" ) )  + " "
   end

   if hhaskey( hParams, "valor_segunda_propiedad" )
      cSentence      +=    "AND movimientos_almacen_lineas.valor_segunda_propiedad = " + quoted( hget( hParams, "valor_segunda_propiedad" ) )  + " "
   end

   if hhaskey( hParams, "lote" )
      cSentence      +=    "AND movimientos_almacen_lineas.lote = " + quoted( hget( hParams, "lote" ) )
   end

RETURN ( cSentence )



static FUNCTION MovimientosAlmacenLineasRepository_getRowSetMovimientosForArticulo( hParams ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

RETURN ( SQLRowSet():New():Build( ::getSQLSentenceMovForStock( hParams ) ) )



static FUNCTION MovimientosAlmacenLineasRepository_getSqlSentenceMovForStock( hParams ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSentence

   if !hhaskey( hParams, "codigo_articulo" )
      msgStop( "El código de artículo es un parametro obligatorio", "getSQLSentenceMovimientosForArticulo" )
      RETURN ( "" )
   end

   cSentence         := "SELECT "
   cSentence         +=    "movimientos_almacen.id, "
   cSentence         +=    "movimientos_almacen.numero, "
   cSentence         +=    "CAST( movimientos_almacen.fecha_hora AS DATE ) AS fecha, "
   cSentence         +=    "CAST( movimientos_almacen.fecha_hora AS TIME ) AS hora, "
   cSentence         +=    SQLMovimientosAlmacenModel():getColumnMovimiento( "movimientos_almacen" )
   cSentence         +=    "movimientos_almacen.almacen_destino, "
   cSentence         +=    "movimientos_almacen.almacen_origen, "
   cSentence         +=    "movimientos_almacen_lineas.parent_uuid, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_primera_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.codigo_segunda_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.valor_primera_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.valor_segunda_propiedad, "
   cSentence         +=    "movimientos_almacen_lineas.lote, "
   cSentence         +=    "movimientos_almacen_lineas.bultos_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.cajas_articulo, "
   cSentence         +=    "movimientos_almacen_lineas.unidades_articulo, "
   cSentence         +=    SQLMovimientosAlmacenLineasModel():getSQLSubSentenceTotalUnidadesLinea( "movimientos_almacen_lineas", "total_unidades" ) + ", "
   cSentence         +=    "movimientos_almacen_lineas.precio_articulo "

   cSentence         += "FROM movimientos_almacen_lineas "

   cSentence         += "INNER JOIN movimientos_almacen "
   cSentence         +=    "ON movimientos_almacen.uuid = movimientos_almacen_lineas.parent_uuid "

   cSentence         += "WHERE movimientos_almacen.empresa_codigo = " + quoted( cCodEmp() ) + " "

   cSentence         +=    "AND movimientos_almacen_lineas.codigo_articulo = " + quoted( hget( hParams, "codigo_articulo" ) ) + " "

   if hhaskey( hParams, "year" ) .AND. !empty( hget( hParams, "year" ) )
      cSentence      +=    "AND DATE_FORMAT( CAST( movimientos_almacen.fecha_hora AS date ), '%Y' ) = " + Str( hget( hParams, "year" ) ) + " "
   end

   if hhaskey( hParams, "almacen" ) .AND. !empty( hget( hParams, "almacen" ) )
      cSentence      +=    "AND ( movimientos_almacen.almacen_destino = " + quoted( hget( hParams, "almacen" ) ) + " OR movimientos_almacen.almacen_origen = " + quoted( hget( hParams, "almacen" ) ) + " ) "
   end

   if hhaskey( hParams, "codigo_primera_propiedad" ) .AND. !Empty( hget( hParams, "codigo_primera_propiedad" ) )
      cSentence      +=    "AND movimientos_almacen_lineas.codigo_primera_propiedad = " + quoted( hget( hParams, "codigo_primera_propiedad" ) )  + " "
   end

   if hhaskey( hParams, "codigo_segunda_propiedad" ) .AND. !Empty( hget( hParams, "codigo_segunda_propiedad" ) )
      cSentence      +=    "AND movimientos_almacen_lineas.codigo_segunda_propiedad = " + quoted( hget( hParams, "codigo_segunda_propiedad" ) )  + " "
   end

   if hhaskey( hParams, "valor_primera_propiedad" ) .AND. !Empty( hget( hParams, "valor_primera_propiedad" ) )
      cSentence      +=    "AND movimientos_almacen_lineas.valor_primera_propiedad = " + quoted( hget( hParams, "valor_primera_propiedad" ) )  + " "
   end

   if hhaskey( hParams, "valor_segunda_propiedad" ) .AND. !Empty( hget( hParams, "valor_segunda_propiedad" ) )
      cSentence      +=    "AND movimientos_almacen_lineas.valor_segunda_propiedad = " + quoted( hget( hParams, "valor_segunda_propiedad" ) )  + " "
   end

   if hhaskey( hParams, "lote" ) .AND. !Empty( hget( hParams, "lote" ) )
      cSentence      +=    "AND movimientos_almacen_lineas.lote = " + quoted( hget( hParams, "lote" ) )
   end

   cSentence         += " AND if( ("






   cSentence         += "SELECT "                                                                              +  "cabecera.fecha_hora "                                                              +  "FROM movimientos_almacen_lineas lineas "                                              +  "INNER JOIN movimientos_almacen cabecera ON lineas.parent_uuid = cabecera.uuid "       +  "WHERE empresa_codigo = " + quoted( cCodEmp() ) + " "                                  +  "AND lineas.codigo_articulo = movimientos_almacen_lineas.codigo_articulo "          +  "AND cabecera.tipo_movimiento = 4 "
   if hhaskey( hParams, "almacen" ) .AND. !empty( hget( hParams, "almacen" ) )
   cSentence         +=    "AND cabecera.almacen_destino = " + quoted( hget( hParams, "almacen" ) )
   end
   cSentence         +=    "AND lineas.codigo_primera_propiedad = movimientos_almacen_lineas.codigo_primera_propiedad "
   cSentence         +=    "AND lineas.codigo_segunda_propiedad = movimientos_almacen_lineas.codigo_segunda_propiedad "
   cSentence         +=    "AND lineas.valor_primera_propiedad = movimientos_almacen_lineas.valor_primera_propiedad "
   cSentence         +=    "AND lineas.valor_segunda_propiedad = movimientos_almacen_lineas.valor_segunda_propiedad "
   cSentence         +=    "AND lineas.lote = movimientos_almacen_lineas.lote "
   cSentence         += "ORDER BY cabecera.fecha_hora DESC LIMIT 1 ) != NULL, "
   cSentence         += "( movimientos_almacen.fecha_hora >= ( "






   cSentence         += "SELECT "                                                                              +  "cabecera.fecha_hora "                                                              +  "FROM movimientos_almacen_lineas lineas "                                              +  "INNER JOIN movimientos_almacen cabecera ON lineas.parent_uuid = cabecera.uuid "       +  "WHERE empresa_codigo = " + quoted( cCodEmp() ) + " "                                  +  "AND lineas.codigo_articulo = movimientos_almacen_lineas.codigo_articulo "          +  "AND cabecera.tipo_movimiento = 4 "
   if hhaskey( hParams, "almacen" ) .AND. !empty( hget( hParams, "almacen" ) )
   cSentence         +=    "AND cabecera.almacen_destino = " + quoted( hget( hParams, "almacen" ) )
   end
   cSentence         +=    "AND lineas.codigo_primera_propiedad = movimientos_almacen_lineas.codigo_primera_propiedad "
   cSentence         +=    "AND lineas.codigo_segunda_propiedad = movimientos_almacen_lineas.codigo_segunda_propiedad "
   cSentence         +=    "AND lineas.valor_primera_propiedad = movimientos_almacen_lineas.valor_primera_propiedad "
   cSentence         +=    "AND lineas.valor_segunda_propiedad = movimientos_almacen_lineas.valor_segunda_propiedad "
   cSentence         +=    "AND lineas.lote = movimientos_almacen_lineas.lote "
   cSentence         += "ORDER BY cabecera.fecha_hora DESC LIMIT 1 ) ), true )"

RETURN ( cSentence )



static FUNCTION MovimientosAlmacenLineasRepository_getRowSetMovimientosForStock( hParams ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

RETURN ( SQLRowSet():New():Build( ::getSqlSentenceMovForStock( hParams ) ) )



static FUNCTION MovimientosAlmacenLineasRepository_getPrimeraFechaCompra( cCodigoArticulo, cLote ) ; local Self AS CLASS MovimientosAlmacenLineasRepository := QSelf() AS CLASS MovimientosAlmacenLineasRepository

   local cSentence










   cSentence   := "SELECT "                                                                                 +  "cabecera.fecha_hora "                                                              +  "FROM movimientos_almacen_lineas lineas "                                              +  "INNER JOIN movimientos_almacen cabecera ON lineas.parent_uuid = cabecera.uuid "    +  "WHERE empresa_codigo = " + quoted( cCodEmp() ) + " "                                  +  "AND lineas.codigo_articulo = " + quoted( cCodigoArticulo ) + " "                   +  "AND cabecera.tipo_movimiento = 4 "                                                 +  "AND lineas.lote = " + quoted( cLote, .T. ) + " "                                   +  "ORDER BY cabecera.fecha_hora DESC " +  "LIMIT 1"

RETURN ( ::getDatabase():getValue( cSentence ) )
