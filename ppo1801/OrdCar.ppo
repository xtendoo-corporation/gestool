#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 6 ".\.\Prg\OrdCar.prg"
static dbfAlbCliT
static dbfAlbCliL
static dbfFacCliT
static dbfFacCliL
static dbfOrdCarT
static dbfOrdCarL
static dbfTransport
static dbfArticulo
static dbfTmpEstado
static cTmpEstado
static oBrwEstado
static oPgrEstado
static oSayProgress
static cSayProgress   := "Procesando"



_HB_CLASS TOrdCarga ; function TOrdCarga ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TOrdCarga", iif( .T., { @TMasDet() }, { @HBObject() } ), @TOrdCarga() ) ) ;

   _HB_MEMBER { oCtaRem } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCtaRem"}, .F. )
   _HB_MEMBER { oDbfCnt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfCnt"}, .F. )
   _HB_MEMBER { oRecibos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oRecibos"}, .F. )
   _HB_MEMBER { oAlbCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliT"}, .F. )
   _HB_MEMBER { oAlbCliL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliL"}, .F. )
   _HB_MEMBER { oAlbCliP } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliP"}, .F. )
   _HB_MEMBER { oClientes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oClientes"}, .F. )
   _HB_MEMBER { oDbfIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfIva"}, .F. )
   _HB_MEMBER { oTrans } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTrans"}, .F. )
   _HB_MEMBER { oDbfAge } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfAge"}, .F. )
   _HB_MEMBER { oDbfArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfArt"}, .F. )
   _HB_MEMBER { oTblPro } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTblPro"}, .F. )
   _HB_MEMBER { oDbfPro } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfPro"}, .F. )
   _HB_MEMBER { oDbfFam } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfFam"}, .F. )
   _HB_MEMBER { cPatExp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPatExp"}, .F. )
   _HB_MEMBER { dFecIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFecIni"}, .F. )
   _HB_MEMBER { dFecFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFecFin"}, .F. )
   _HB_MEMBER { AS ARRAY aMsg } ; oClass:AddMultiData( "ARRAY", {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aMsg"}, .F. )
   _HB_MEMBER { oSer } ; oClass:AddMultiData(, Array( 26 ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSer"}, .F. )
   _HB_MEMBER { aSer } ; oClass:AddMultiData(, Afill( Array( 26 ), .T. ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aSer"}, .F. )
   _HB_MEMBER { oBmp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBmp"}, .F. )
   _HB_MEMBER { AS ARRAY aDbfVir } ; oClass:AddMultiData( "ARRAY", { { .F., "", 0, "", Ctod( "" ), "", "",  "", 0 } }, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aDbfVir"}, .F. )
   _HB_MEMBER { oBrwDet } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwDet"}, .F. )
   _HB_MEMBER { cMru } ; oClass:AddMultiData(, "gc_small_truck_user_16", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cMru"}, .F. )
   _HB_MEMBER { cBitmap } ; oClass:AddMultiData(, ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cBitmap"}, .F. )

   _HB_MEMBER { oFecAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFecAlb"}, .F. )
   _HB_MEMBER { oCodCli } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodCli"}, .F. )
   _HB_MEMBER { oNomCli } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oNomCli"}, .F. )
   _HB_MEMBER { oComent } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oComent"}, .F. )

   _HB_MEMBER { oPeso } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPeso"}, .F. )
   _HB_MEMBER { AS NUMERIC nPeso } ; oClass:AddMultiData( "NUMERIC", 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nPeso"}, .F. )

   _HB_MEMBER { oDiferencias } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDiferencias"}, .F. )
   _HB_MEMBER { AS NUMERIC nDiferencias } ; oClass:AddMultiData( "NUMERIC", 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDiferencias"}, .F. )

   _HB_MEMBER { oMenu } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMenu"}, .F. )

   _HB_MEMBER { oDetOrdCar } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDetOrdCar"}, .F. )
   _HB_MEMBER { AS ARRAY aAlbaranes } ; oClass:AddMultiData( "ARRAY", {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aAlbaranes"}, .F. )

   _HB_MEMBER New( cPath, oWndParent, oMenuItem); oClass:AddMethod( "New", @TOrdCarga_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TOrdCarga_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TOrdCarga_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TOrdCarga_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode); oClass:AddMethod( "Resource", @TOrdCarga_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @TOrdCarga_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Report(); oClass:AddInline( "Report", {|Self | ( ( Self ) ), ( TInfOrdCar():New( "Ordenes de carga", , , , , , { ::oDbf, ::oDetOrdCar:oDbf } ):Play() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EdtRotor( oDlg); oClass:AddMethod( "EdtRotor", @TOrdCarga_EdtRotor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ImpAlbCli(); oClass:AddMethod( "ImpAlbCli", @TOrdCarga_ImpAlbCli(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenError(); oClass:AddInline( "OpenError", {|Self | ( ( Self ) ), ( MsgStop( "Proceso en uso por otro usuario", "Abrir fichero" ), .F. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadTrans(); oClass:AddMethod( "LoadTrans", @TOrdCarga_LoadTrans(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CalculaDiferencias(); oClass:AddMethod( "CalculaDiferencias", @TOrdCarga_CalculaDiferencias(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lSave( nMode, oDlg); oClass:AddMethod( "lSave", @TOrdCarga_lSave(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GetNewCount(); oClass:AddMethod( "GetNewCount", @TOrdCarga_GetNewCount(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nPesOrdVir( lPic); oClass:AddMethod( "nPesOrdVir", @TOrdCarga_nPesOrdVir(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER StartImpAlbCli( oDlg); oClass:AddMethod( "StartImpAlbCli", @TOrdCarga_StartImpAlbCli(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RollBackAlbCli(); oClass:AddMethod( "RollBackAlbCli", @TOrdCarga_RollBackAlbCli(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TOrdCarga ;



static FUNCTION TOrdCarga_New( cPath, oMenuItem, oWndParent ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;

   ::nLevel                   := Auth():Level( oMenuItem )

   ::cPath                    := cPath
   ::oWndParent               := oWndParent
   ::oDbf                     := nil

   ::oTrans                   := TTrans():New( cPath )

   ::lCreateShell             := .F.

   ::oBmp                     := LoadBitmap( 0, 32760 )
   ::dFecIni                  := Ctod( "01/" + Str( Month( Date() ), 2 ) + "/" + Str( Year( Date() ), 4 ) )
   ::dFecFin                  := Date()

   ::cNumDocKey               := "nNumOrd"
   ::cSufDocKey               := "cSufOrd"

   ::bFirstKey                := {|| Str( ::oDbf:nNumOrd ) + ::oDbf:cSufOrd }

   ::bOnPreDelete             := {|| ::RollBackAlbCli()  }

   ::bOnPostAppendDetail      := {|| ::oBrwDet:Refresh(), ::nPesOrdVir() }
   ::bOnPostEditDetail        := {|| ::oBrwDet:Refresh(), ::nPesOrdVir() }
   ::bOnPostDeleteDetail      := {|| ::oBrwDet:Refresh(), ::nPesOrdVir() }

   ::oDetOrdCar               := TDetOrdCar():New( cPath, Self )

   ::AddDetail( ::oDetOrdCar )

RETURN ( Self )



static FUNCTION TOrdCarga_Activate( ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return .F.
   end





   if ::oWndParent <> nil
      ::oWndParent:CloseAll()
   end

   if !::OpenFiles()
      return nil
   end

   if !::lCreateShell
      ::CreateShell( ::nLevel )
   end

   ::oWndBrw:bDup    := nil

   ::oWndBrw:GralButtons( Self )

   ::oWndBrw:EndButtons( Self )

   ::oWndBrw:Activate(  nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, {|| ::CloseFiles() }, nil, nil )

RETURN ( Self )



static FUNCTION TOrdCarga_DefineFiles( cPath, cDriver ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   local oDbf

   If( cPath == nil, cPath := ::cPath, ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   oDbf := DbfServer( "ORDCARP.DBF", "ORDCARP" ):New( "ORDCARP.DBF", "ORDCARP", ( cDriver ), "Ordenes de carga", ( cPath ) )

   oDbf:AddField( "nNumOrd", "N", 9, 0, "999999999",,,, "Número", .T., 80, .F., {} )
   oDbf:AddField( "cSufOrd", "C", 2, 0, "@!",,,, "Sufijo", .F., 20, .F., {} )
   oDbf:AddField( "dFecOrd", "D", 8, 0,,,,, "Fecha", .F., 80, .F., {} )
   oDbf:AddField( "cCodTrn", "C", 9, 0, "@!",,,, "Código", .F., 60, .F., {} )
   oDbf:AddField( "cNomTrn", "B", 50, 0,,,, {|| ( if( !Empty( ::oTrans ), ::oTrans:cNombre( oDbf:cCodTrn ), "" ) )}, "Transportista", .F., 200, .F., {} )
   oDbf:AddField( "nKgsTrn", "N", 16, 6, MasUnd(),,,, "TARA", .T., 80, .F., {} )
   oDbf:AddField( "cRetPor", "C", 100, 0,,,,, "Retirado por", .F., 120, .F., {} )
   oDbf:AddField( "cRetMat", "C", 20, 0, "@!",,,, "Matrícula", .F., 100, .F., {} )
   oDbf:AddField( "nBultos", "N", 3, 0, "999",,,, "Bultos", .T., 50, .F., {} )
   oDbf:AddField( "cCodAge", "C", 3, 0, "@!",,,, "Cod. agente", .F., 50, .F., {} )
   oDbf:AddField( "lSndInt", "L", 1, 0,,,,, "", .F.,, .T., {} )
   oDbf:AddField( "lRegula", "L", 1, 0,,,,, "", .F.,, .T., {} )

   oDbf:AddIndex( "nNumOrd", "OrdCarP.Cdx", "Str( nNumOrd ) + cSufOrd",,, .F., .F., "Número",,, .T., .F. )
   oDbf:AddIndex( "dFecOrd", "OrdCarP.Cdx", "dFecOrd",,, .F., .F., "Fecha",,, .T., .F. )
   oDbf:AddIndex( "cCodTrn", "OrdCarP.Cdx", "cCodTrn",,, .F., .F., "Transportista",,, .T., .F. )



RETURN ( oDbf )



static FUNCTION TOrdCarga_OpenFiles( lExclusive ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   local lOpen          := .T.
   local oError
   local oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   If( lExclusive == nil, lExclusive := .F., ) ;

   BEGIN SEQUENCE

      ::oAlbCliT := DbfServer( "ALBCLIT.DBF", ):NewOpen( "ALBCLIT.DBF",, ( cDriver() ),, ( ::cPath ), .F., .T., .F., .F. ) ; ::oAlbCliT:AddBag( "ALBCLIT.CDX" ) ; ::oAlbCliT:AddBag( ) ; ::oAlbCliT:AutoIndex()

      ::oAlbCliL := DbfServer( "ALBCLIL.DBF", ):NewOpen( "ALBCLIL.DBF",, ( cDriver() ),, ( ::cPath ), .F., .T., .F., .F. ) ; ::oAlbCliL:AddBag( "ALBCLIL.CDX" ) ; ::oAlbCliL:AddBag( ) ; ::oAlbCliL:AutoIndex()

      ::oAlbCliP := DbfServer( "ALBCLIP.DBF", ):NewOpen( "ALBCLIP.DBF",, ( cDriver() ),, ( ::cPath ), .F., .T., .F., .F. ) ; ::oAlbCliP:AddBag( "ALBCLIP.CDX" ) ; ::oAlbCliP:AddBag( ) ; ::oAlbCliP:AutoIndex()

      ::oClientes := DbfServer( "CLIENT.DBF", ):NewOpen( "CLIENT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oClientes:AddBag( "CLIENT.CDX" ) ; ::oClientes:AddBag( ) ; ::oClientes:AutoIndex()

      ::oDbfIva := DbfServer( "TIVA.DBF", ):NewOpen( "TIVA.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfIva:AddBag( "TIVA.CDX" ) ; ::oDbfIva:AddBag( ) ; ::oDbfIva:AutoIndex()

      ::oDbfCnt := DbfServer( "NCOUNT.DBF", ):NewOpen( "NCOUNT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfCnt:AddBag( "NCOUNT.CDX" ) ; ::oDbfCnt:AddBag( ) ; ::oDbfCnt:AutoIndex()

      ::oDbfAge := DbfServer( "AGENTES.DBF", ):NewOpen( "AGENTES.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfAge:AddBag( "AGENTES.CDX" ) ; ::oDbfAge:AddBag( ) ; ::oDbfAge:AutoIndex()

      ::oDbfArt := DbfServer( "ARTICULO.DBF", ):NewOpen( "ARTICULO.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfArt:AddBag( "ARTICULO.CDX" ) ; ::oDbfArt:AddBag( ) ; ::oDbfArt:AutoIndex()

      ::oTblPro := DbfServer( "TBLPRO.DBF", ):NewOpen( "TBLPRO.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oTblPro:AddBag( "TBLPRO.CDX" ) ; ::oTblPro:AddBag( ) ; ::oTblPro:AutoIndex()

      ::oDbfPro := DbfServer( "PRO.DBF", ):NewOpen( "PRO.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfPro:AddBag( "PRO.CDX" ) ; ::oDbfPro:AddBag( ) ; ::oDbfPro:AutoIndex()

      ::oDbfFam := DbfServer( "FAMILIAS.DBF", ):NewOpen( "FAMILIAS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfFam:AddBag( "FAMILIAS.CDX" ) ; ::oDbfFam:AddBag( ) ; ::oDbfFam:AutoIndex()

      ::lLoadDivisa()

      ::oTrans:OpenFiles()

      if Empty( ::oDbf )
         ::oDbf         := ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ), .F., .F. )

      ::oDetOrdCar:Openfiles()

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos" )

      lOpen             := .F.

      ::CloseFiles()

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TOrdCarga_CloseFiles( ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   if !Empty( ::oDbf ) .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   if !Empty( ::oAlbCliT ) .AND. ::oAlbCliT:Used()
      ::oAlbCliT:End()
   end

   if !Empty( ::oAlbCliL ) .AND. ::oAlbCliL:Used()
      ::oAlbCliL:End()
   end

   if !Empty( ::oAlbCliP ) .AND. ::oAlbCliP:Used()
      ::oAlbCliP:End()
   end

   if !Empty( ::oDbfIva ) .AND. ::oDbfIva:Used()
      ::oDbfIva:End()
   end

   if !Empty( ::oClientes ) .AND. ::oClientes:Used()
      ::oClientes:End()
   end

   if !Empty( ::oDbfCnt ) .AND. ::oDbfCnt:Used()
      ::oDbfCnt:End()
   end

   if !Empty( ::oDbfAge ) .AND. ::oDbfAge:Used()
      ::oDbfAge:End()
   end

   if !Empty( ::oDbfArt ) .AND. ::oDbfArt:Used()
      ::oDbfArt:End()
   end

   if !Empty( ::oTblPro ) .AND. ::oTblPro:Used()
      ::oTblPro:End()
   end

   if !Empty( ::oDbfPro ) .AND. ::oDbfPro:Used()
      ::oDbfPro:End()
   end

   if !Empty( ::oDbfFam ) .AND. ::oDbfFam:Used()
      ::oDbfFam:End()
   end

   if !Empty( ::oTrans )
      ::oTrans:End()
   end

   if !Empty( ::oDetOrdCar )
      ::oDetOrdCar:End()
   end

   ::oAlbCliT                 := nil
   ::oAlbCliL                 := nil
   ::oAlbCliP                 := nil
   ::oDbfIva                  := nil
   ::oClientes                := nil
   ::oDbf                     := nil
   ::oDbfCnt                  := nil
   ::oTrans                   := nil
   ::oDbfAge                  := nil
   ::oDbfArt                  := nil
   ::oTblPro                  := nil
   ::oDbfPro                  := nil
   ::oDbfFam                  := nil
   ::oDetOrdCar               := nil

   DeleteObject( ::oBmp )

Return ( .T. )



static FUNCTION TOrdCarga_Resource( nMode ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   local oDlg
   local oGet
   local oSay
   local cSay           := ::oTrans:cNombre( ::oDbf:cCodTrn )
   local oGetKgs
   local oGetAge
   local oSayAge
   local cSayAge
   local oBmpGeneral

   ::aAlbaranes         := {}

   if nMode == 1
      ::oDbf:dFecOrd    := Date()
      ::oDbf:cSufOrd    := RetSufEmp()
      ::nDiferencias    := 0
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "ordenes de carga", "ORDCAR",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_small_truck_user_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::oDbf:nNumOrd, ::oDbf:nNumOrd:= u ) }, oDlg,, ::oDbf:FieldByName( "nNumOrd" ):cPict,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:cSufOrd, ::oDbf:cSufOrd:= u ) }, oDlg,, ::oDbf:FieldByName( "cSufOrd" ):cPict,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbf:dFecOrd, ::oDbf:dFecOrd:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      oGetAge := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, ::oDbf:cCodAge, ::oDbf:cCodAge:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      oGetAge:bValid := {|| cAgentes( oGetAge, ::oDbfAge:cAlias, oSayAge ) }
      oGetAge:bHelp  := {|| BrwAgentes( oGetAge, oSayAge ) }




      oSayAge := TGetHlp():ReDefine( 341, { | u | If( PCount()==0, cSayAge, cSayAge:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )







      oGet := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbf:cCodTrn, ::oDbf:cCodTrn:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      oGet:bValid := {|| ::oTrans:Existe( oGet, oSay, "cNomTrn" ), ::LoadTrans( oGet, oGetKgs ) }
      oGet:bHelp  := {|| ::oTrans:Buscar( oGet, "cCodTrn" ) }




      oSay := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, cSay, cSay:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oGetKgs := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::oDbf:nKgsTrn, ::oDbf:nKgsTrn:= u ) }, oDlg,, ( MasUnd() ),,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      ::oPeso := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::nPeso, ::nPeso:= u ) }, oDlg,, ( MasUnd() ),,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      ::oDiferencias := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::nDiferencias, ::nDiferencias:= u ) }, oDlg,, ( MasUnd() ),,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::oDbf:cRetPor, ::oDbf:cRetPor:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::oDbf:cRetMat, ::oDbf:cRetMat:= u ) }, oDlg,,,,,,,,, .T., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::oDbf:nBultos, ::oDbf:nBultos:= u ) }, oDlg,, "999",,,,,,, .T., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )









        TButton():ReDefine( 300, {||( ::oDetOrdCar:Append( ::oBrwDet ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 310, {||( ::oDetOrdCar:Edit( ::oBrwDet ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 320, {||( ::oDetOrdCar:Del( ::oBrwDet ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 330, {||( ::ImpAlbCli() )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )

      ::oBrwDet                     := IXBrowse():New( oDlg )

      ::oDetOrdCar:oDbfVir:SetBrowse( ::oBrwDet )

      ::oBrwDet:nMarqueeStyle       := 5
      ::oBrwDet:cName               := "Lineas de ordenes de carga"
      ::oBrwDet:lRecordSelector     := .F.
      ::oBrwDet:CreateFromResource( 150 )

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Código"
         :bStrData                  := {|| ::oDetOrdCAr:oDbfVir:cRef }
         :nWidth                    := 100
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Descripción"
         :bStrData                  := {|| ::oDetOrdCAr:oDbfVir:cDetalle }
         :nWidth                    := 540
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Prp. 1"
         :bStrData                  := {|| ::oDetOrdCAr:oDbfVir:cValPr1 }
         :nWidth                    := 30
         :lHide                     := .T.
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Prp. 2"
         :bStrData                  := {|| ::oDetOrdCAr:oDbfVir:cValPr2 }
         :nWidth                    := 30
         :lHide                     := .T.
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Lote"
         :bStrData                  := {|| ::oDetOrdCAr:oDbfVir:cLote }
         :nWidth                    := 40
         :lHide                     := .T.
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Cajas"
         :bEditValue                := {|| ::oDetOrdCAr:oDbfVir:nCajOrd }
         :nWidth                    := 50
         :cEditPicture              := MasUnd()
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
         :lHide                     := .T.
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Unidades"
         :bEditValue                := {|| ::oDetOrdCAr:oDbfVir:nUniOrd }
         :nWidth                    := 50
         :cEditPicture              := MasUnd()
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
         :lHide                     := .T.
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Total unidades"
         :bEditValue                := {|| ::oDetOrdCar:nTotUnidades( ::oDetOrdCAr:oDbfVir ) }
         :nWidth                    := 95
         :cEditPicture              := MasUnd()
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Peso"
         :bEditValue                := {|| ::oDetOrdCAr:oDbfVir:nPeso }
         :nWidth                    := 50
         :cEditPicture              := MasUnd()
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
         :lHide                     := .T.
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader                   := "Total peso"
         :bEditValue                := {|| ::oDetOrdCar:nTotPeso( ::oDetOrdCAr:oDbfVir ) }
         :nWidth                    := 95
         :cEditPicture              := MasUnd()
         :nDataStrAlign             := 1
         :nHeadStrAlign             := 1
      end

      if nMode <> 3
         ::oBrwDet:bLDblClick       := {|| ::oDetOrdCar:Edit( ::oBrwDet ) }
      end





      TButton():ReDefine( 500, {||( ::lSave( nMode, oDlg ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 550, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 113, {|| ::oDetOrdCar:Append( ::oBrwDet ) } )
      oDlg:AddFastKey( 114, {|| ::oDetOrdCar:Edit( ::oBrwDet ) } )
      oDlg:AddFastKey( 115, {|| ::oDetOrdCar:Del( ::oBrwDet ) } )
      oDlg:AddFastKey( 116, {|| ::lSave( nMode, oDlg ) } )
   end

   oDlg:bStart    := {|| if( nMode <> 1, ( oGet:lValid(), oGetAge:lValid() ), ), oGetAge:SetFocus(), ::EdtRotor( oDlg ), ::nPesOrdVir(), ::oBrwDet:Load() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   ::oMenu:End()
   oBmpGeneral:End()

RETURN ( oDlg:nResult == 1 )



static FUNCTION TOrdCarga_EdtRotor( oDlg ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   ::oMenu := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )





            MenuAddItem( "&1. Modificar agente", "Modificar la ficha del Agente", .F.,, {|oMenuItem|( if( !Empty( ::oDbf:cCodAge ), EdtAge( ::oDbf:cCodAge ), MsgStop( "Debe que seleccionar un agente" ) ) )},, "gc_businessman2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&2. Modificar transportista", "Modificar la ficha del transportista", .F.,, {|oMenuItem|( if( !Empty( ::oDbf:cCodTrn ), EdtTrans( ::oDbf:cCodTrn ), MsgStop( "Debe de seleccionar un transportista" ) ) )},, "gc_small_truck_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( ::oMenu )

RETURN ( ::oMenu )



static FUNCTION TOrdCarga_LoadTrans( oGet, oGetKgs ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   local nTara    := 0

   if ::oTrans:oDbf:SeekInOrd( oGet:VarGet(), "cCodTrn" )
      oGetKgs:cText( ::oTrans:oDbf:nKgsTrn )
   end

   ::CalculaDiferencias()

Return .T.



static FUNCTION TOrdCarga_CalculaDiferencias( ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   if ::oDbf:nKgsTrn <> 0
      ::oDiferencias:cText( ::oDbf:nKgsTrn - ::nPeso )
   else
      ::oDiferencias:cText( 0 )
   end

RETURN ( Self )



FUNCTION OrdCar( oMenuItem, oWnd )

   local oOrdCar
   local nLevel

   If( oMenuItem == nil, oMenuItem := "orden_de_carga", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;

   nLevel               := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return nil
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end





   AddMnuNext( "Ordenes de carga", ProcName() )

   oOrdCar  := TOrdCarga():New( cPatEmp() )
   oOrdCar:Activate( nLevel )

RETURN NIL



static FUNCTION TOrdCarga_lSave( nMode, oDlg ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   local cNumAlb

   if nMode == 1

      if Empty( ::oDbf:cCodAge )
         MsgStop( "El código de agente no puede estar vacío." )
         Return .F.
      end

      if Empty( ::oDbf:cCodTrn )
         MsgStop( "El código de transportista no puede estar vacío." )
         Return .F.
      end

      if ::oDetOrdCar:oDbfVir:Lastrec() == 0
         MsgStop( "No se puede almacenar un documento sin líneas." )
         Return .F.
      end

   end

   if ::nDiferencias < 0
      MsgStop( "La carga excede la capacidad del medio de transporte." )
   end





   for each cNumAlb in ::aAlbaranes

      if ::oAlbCliT:SeekInOrd( cNumAlb, "nNumAlb" )
         ::oAlbCliT:fieldPutByName( "lOrdCar", .T. )
      end

   next





   if !Empty( oDlg )
      oDlg:End( 1 )
   end

RETURN ( .T. )



static FUNCTION TOrdCarga_GetNewCount( ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   ::oDbf:nNumOrd    := nNewDoc( nil, ::oDbf:nArea, "NORDCAR", nil, ::oDbfCnt:nArea )

RETURN ( Self )



static FUNCTION TOrdCarga_nPesOrdVir( lPic ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   local nPeso  := 0

   If( lPic == nil, lPic := .F., ) ;

   ::oDetOrdCar:oDbfVir:GetStatus()

   ::oDetOrdCar:oDbfVir:GoTop()

   while !::oDetOrdCar:oDbfVir:Eof()

      nPeso     += ::oDetOrdCar:nTotPeso( ::oDetOrdCar:oDbfVir )

      ::oDetOrdCar:oDbfVir:Skip()

   end

   ::oDetOrdCar:oDbfVir:SetStatus()

   ::oPeso:cText( nPeso )

   ::oPeso:Refresh()

   ::CalculaDiferencias()

RETURN ( if( lPic, Trans( nPeso, MasUnd() ), nPeso ) )



static FUNCTION TOrdCarga_ImpAlbCli( ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

    local oDlg
   local oBrw
   local oGet1
   local cGet1
   local This        := Self
   local nOrd        := GetBrwOpt( "BrwAlbCli" )
   local oCbxOrd
   local aCbxOrd     := { "Número", "Fecha", "Cliente", "Nombre" }
   local cCbxOrd

   nOrd              := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd           := aCbxOrd[ nOrd ]

   oDlg = TDialog():New(,,,, "Albaranes de clientes", "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




        oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "FIND",, )

      oGet1:bChange  := {| nKey, nFlags, Self | AutoSeek( nKey, nFlags, Self, oBrw, This:oAlbCliT:cAlias ) }






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( This:oAlbCliT:OrdSetFocus( oCbxOrd:nAt ), oBrw:refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                    := IXBrowse():New( oDlg )

      ::oAlbCliT:SetBrowse( oBrw )

      oBrw:nMarqueeStyle      := 6
      oBrw:cName              := "Albaranes de clientes"
      oBrw:bClrSel            := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus       := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader             := "Or. Orden de carga"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ::oAlbCliT:lOrdCar }
         :nWidth              := 20
         :SetCheck( { "Cnt16", "Nil16" } )
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Número"
         :bStrData            := {|| ::oAlbCliT:cSerAlb + "/" + AllTrim( Str( ::oAlbCliT:nNumAlb ) ) + "/" + ::oAlbCliT:cSufAlb }
         :nWidth              := 70
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Fecha"
         :bStrData            := {|| DtoC( ::oAlbCliT:dFecAlb ) }
         :nWidth              := 70
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Cliente"
         :bStrData            := {|| ::oAlbCliT:cCodCli }
         :nWidth              := 70
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Nombre"
         :bStrData            := {|| ::oAlbCliT:cNomCli }
         :nWidth              := 275
      end

      oBrw:bLDblClick         := {|| ::StartImpAlbCli( oBrw:aSelected, oDlg ) }




        TButton():ReDefine( 500,, oDlg,,, .F., {||         .F.},,, .F. )




        TButton():ReDefine( 501,, oDlg,,, .F., {||         .F.},,, .F. )




        TButton():ReDefine( 1, {||( ::StartImpAlbCli( oBrw:aSelected, oDlg ) )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   SetBrwOpt( "BrwAlbCli", ::oAlbCliT:OrdNumber() )

   ::nPesOrdVir()

RETURN ( .T. )



static FUNCTION TOrdCarga_StartImpAlbCli( aSelected, oDlg ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   local nRec
   local nRecAlbCliT    := ::oAlbCliT:Recno()
   local nRecAlbCliL    := ::oAlbCliL:Recno()
   local nOrdAlbCliL    := ::oAlbCliL:OrdSetFocus( "nNumAlb" )
   local nPos

   for each nRec in aSelected

      ::oAlbCliT:GoTo( nRec )


      if ( nPos := aScan( ::aAlbaranes, ::oAlbCliT:cSerAlb + Str( ::oAlbCliT:nNumAlb ) + ::oAlbCliT:cSufAlb ) ) == 0 .AND. !::oAlbCliT:lOrdCar





         aAdd( ::aAlbaranes, ::oAlbCliT:cSerAlb + Str( ::oAlbCliT:nNumAlb ) + ::oAlbCliT:cSufAlb )





         if ::oAlbCliL:Seek( ::oAlbCliT:cSerAlb + Str( ::oAlbCliT:nNumAlb ) + ::oAlbCliT:cSufAlb )


            while ::oAlbCliT:cSerAlb + Str( ::oAlbCliT:nNumAlb ) + ::oAlbCliT:cSufAlb == ::oAlbCliL:cSerAlb + Str( ::oAlbCliL:nNumAlb ) + ::oAlbCliL:cSufAlb .AND. !::oAlbCliL:Eof()

                  ::oDetOrdCar:oDbfVir:Append()

                  ::oDetOrdCar:oDbfVir:nNumOrd     := ::oDbf:nNumOrd
                  ::oDetOrdCar:oDbfVir:cSufOrd     := ::oDbf:cSufOrd
                  ::oDetOrdCar:oDbfVir:cRef        := ::oAlbCliL:cRef
                  ::oDetOrdCar:oDbfVir:cDetalle    := ::oAlbCliL:cDetalle
                  ::oDetOrdCar:oDbfVir:cCodPr1     := ::oAlbCliL:cCodPr1
                  ::oDetOrdCar:oDbfVir:cCodPr2     := ::oAlbCliL:cCodPr2
                  ::oDetOrdCar:oDbfVir:cValPr1     := ::oAlbCliL:cValPr1
                  ::oDetOrdCar:oDbfVir:cValPr2     := ::oAlbCliL:cValPr2
                  ::oDetOrdCar:oDbfVir:lLote       := ::oAlbCliL:lLote
                  ::oDetOrdCar:oDbfVir:cLote       := ::oAlbCliL:cLote
                  ::oDetOrdCar:oDbfVir:nCajOrd     := ::oAlbCliL:nCanEnt
                  ::oDetOrdCar:oDbfVir:nUniOrd     := ::oAlbCliL:nUniCaja
                  ::oDetOrdCar:oDbfVir:nPeso       := ::oAlbCliL:nPesoKg
                  ::oDetOrdCar:oDbfVir:cUndPes     := ::oAlbCliL:cPesoKg
                  ::oDetOrdCar:oDbfVir:cNumAlb     := ::oAlbCliL:cSerAlb + Str( ::oAlbCliL:nNumAlb ) + ::oAlbCliL:cSufAlb

                  ::oDetOrdCar:oDbfVir:Save()

               ::oAlbCliL:Skip()

            end

         end

      else

         msgStop( "El albarán " + ::oAlbCliT:cSerAlb + "/" + AllTrim( Str( ::oAlbCliL:nNumAlb ) ) + "/" + ::oAlbCliL:cSufAlb + " ya ha sido insertado en un orden de carga." )

      end

   next





   ::oAlbCliL:OrdSetFocus( nOrdAlbCliL )

   ::oAlbCliL:GoTo( nRecAlbCliL )

   ::oAlbCliT:GoTo( nRecAlbCliT )





   ::oBrwDet:Refresh()

   oDlg:End( 1 )

RETURN ( oDlg:nResult == 1 )



static FUNCTION TOrdCarga_RollBackAlbCli( ) ; local Self AS CLASS TOrdCarga := QSelf() AS CLASS TOrdCarga

   local aAlbCliT    := {}
   local cNumAlb
   local nPos

   ::oDetOrdCar:oDbf:GoTop()

   while !::oDetOrdCar:oDbf:Eof()

      if ( nPos := aScan( aAlbCliT, ::oDetOrdCar:oDbf:cNumAlb ) ) == 0
         aAdd( aAlbCliT, ::oDetOrdCar:oDbf:cNumAlb )
      end

      ::oDetOrdCar:oDbf:Skip()

   end

   for each cNumAlb in aAlbCliT

      if ::oAlbCliT:SeekInOrd( cNumAlb, "nNumAlb" )

         ::oAlbCliT:fieldPutByName( "lOrdCar", .F. )

      end

   next

RETURN ( Self )



function SynOrdCar( cPath )

   local dbfOrdCarT
   local dbfOrdCarL
   local dbfAlbCliT
   local dbfAlbCliL
   local oError
   local oBlock      := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   If( cPath == nil, cPath := cPatEmp(), ) ;

   BEGIN SEQUENCE

   dbUseArea( .T., cDriver(), cPath + "ORDCARP.DBF", cCheckArea( "ORDCARP", @dbfOrdCarT ), .F. )
   if !lAIS(); ordListAdd( cPath + "ORDCARP.CDX" ); else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., cDriver(), cPath + "ORDCARL.DBF", cCheckArea( "ORDCARL", @dbfOrdCarL ), .F. )
   if !lAIS(); ordListAdd( cPath + "ORDCARL.CDX" ); else ; ordSetFocus( 0 ) ; end

   dbUseArea( .T., cDriver(), cPath + "ALBCLIT.DBF", cCheckArea( "ALBCLIT", @dbfAlbCliT ), .F. )
   if !lAIS(); ordListAdd( cPath + "ALBCLIT.CDX" ); else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., cDriver(), cPath + "ALBCLIL.DBF", cCheckArea( "ALBCLIL", @dbfAlbCliL ), .F. )
   if !lAIS(); ordListAdd( cPath + "ALBCLIL.CDX" ); else ; ordSetFocus( 1 ) ; end





   ( dbfOrdCarL )->( dbGoTop() )
   while !( dbfOrdCarL )->( eof() )
      if !( dbfOrdCarT )->( dbSeek( Str( ( dbfOrdCarL )->nNumOrd ) + ( dbfOrdCarL )->cSufOrd ) )
         ( dbfOrdCarL )->( dbDelete() )
      end
      ( dbfOrdCarL )->( dbSkip() )
   end





   ( dbfAlbCliT )->( dbGoTop() )

   while !( dbfAlbCliT )->( Eof() )

      if ( dbfAlbCliT )->nNumOrd <> 0

         if ( dbfOrdCarT )->( dbSeek( Str( ( dbfAlbCliT )->nNumOrd ) + ( dbfAlbCliT )->cSufOrd ) )

            if ( dbfAlbCliL )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) )


               while ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb == ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb .AND. !( dbfAlbCliL )->( Eof() )

                     ( dbfOrdCarL )->( dbAppend() )

                     ( dbfOrdCarL )->nNumOrd    := ( dbfAlbCliT )->nNumOrd
                     ( dbfOrdCarL )->cSufOrd    := ( dbfAlbCliT )->cSufOrd
                     ( dbfOrdCarL )->cRef       := ( dbfAlbCliL )->cRef
                     ( dbfOrdCarL )->cDetalle   := ( dbfAlbCliL )->cDetalle
                     ( dbfOrdCarL )->cCodPr1    := ( dbfAlbCliL )->cCodPr1
                     ( dbfOrdCarL )->cCodPr2    := ( dbfAlbCliL )->cCodPr2
                     ( dbfOrdCarL )->cValPr1    := ( dbfAlbCliL )->cValPr1
                     ( dbfOrdCarL )->cValPr2    := ( dbfAlbCliL )->cValPr2
                     ( dbfOrdCarL )->lLote      := ( dbfAlbCliL )->lLote
                     ( dbfOrdCarL )->cLote      := ( dbfAlbCliL )->cLote
                     ( dbfOrdCarL )->nCajOrd    := ( dbfAlbCliL )->nCanEnt
                     ( dbfOrdCarL )->nUniOrd    := ( dbfAlbCliL )->nUniCaja
                     ( dbfOrdCarL )->nPeso      := ( dbfAlbCliL )->nPesoKg
                     ( dbfOrdCarL )->cUndPes    := ( dbfAlbCliL )->cPesoKg
                     ( dbfOrdCarL )->cNumAlb    := ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb

                  ( dbfAlbCliL )->( dbSkip() )

               end

            end

            ( dbfAlbCliT )->lOrdCar                   := .T.

         else

            ( dbfAlbCliT )->lOrdCar                   := .F.

         end





      ( dbfAlbCliT )->nNumOrd                   := 0
      ( dbfAlbCliT )->cSufOrd                   := Space(1)

      end

      ( dbfAlbCliT )->( dbSkip() )

   end

   RECOVER USING oError

      msgStop( "Imposible sincronizar ordenes de carga" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !Empty( dbfOrdCarT ) .AND. ( dbfOrdCarT )->( Used() )
      ( dbfOrdCarT )->( dbCloseArea() )
   end

   if !Empty( dbfOrdCarL ) .AND. ( dbfOrdCarL )->( Used() )
      ( dbfOrdCarL )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliT ) .AND. ( dbfAlbCliT )->( Used() )
      ( dbfAlbCliT )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliL ) .AND. ( dbfAlbCliL )->( Used() )
      ( dbfAlbCliL )->( dbCloseArea() )
   end

return nil



function isOrdCar()

   with object ( TOrdCarga():Create() )

      :DefineFiles()

      if !lExistTable( :oDbf:cFile )

         :oDbf:Create()
         :oDbf:Activate( .F., .F. )
         :oDbf:IdxFCheck()

      endif

      :End()

   end

   with object ( TDetOrdCar():Create() )

      :OpenFiles()

      if !lExistTable( :oDbf:cFile )

         :oDbf:Create()
         :oDbf:Activate( .F., .F. )
         :oDbf:IdxFCheck()

      endif

      :End()

   end

return nil
