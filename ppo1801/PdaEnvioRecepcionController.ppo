#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 14 ".\.\Prg\PdaEnvioRecepcionController.prg"
_HB_CLASS PdaEnvioRecepcionController ; function PdaEnvioRecepcionController ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "PdaEnvioRecepcionController", iif( .F., { }, { @HBObject() } ), @PdaEnvioRecepcionController() ) ) ;

   _HB_MEMBER { oInstance } ; oClass:AddMultiClsData(,, nScope + iif( .F., 16, 0 ) + iif( .T., 32, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oInstance"}, .F. )

   _HB_MEMBER { nSeconds } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nSeconds"}, .F. )

   _HB_MEMBER { oTimer } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTimer"}, .F. )

   _HB_MEMBER { oMsgAlarm } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMsgAlarm"}, .F. )

   _HB_MEMBER { oDialogView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDialogView"}, .F. )

   _HB_MEMBER { aJson } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aJson"}, .F. )

   _HB_MEMBER { cPath } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPath"}, .F. )

   _HB_MEMBER { hTicketHeader } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"hTicketHeader"}, .F. )

   _HB_MEMBER { cSerieTicket } ; oClass:AddMultiData(, "A", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerieTicket"}, .F. )

   _HB_MEMBER { cNumeroTicket } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNumeroTicket"}, .F. )

   _HB_MEMBER { cSufijoTicket } ; oClass:AddMultiData(, retSufEmp(), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijoTicket"}, .F. )

   _HB_MEMBER { dFechaTicket } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFechaTicket"}, .F. )

   _HB_MEMBER { cHoraTicket } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cHoraTicket"}, .F. )

   _HB_MEMBER { nDescuentoTicket } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nDescuentoTicket"}, .F. )

   _HB_MEMBER { cFormaPago } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFormaPago"}, .F. )

   _HB_MEMBER { cAlmacenTicket } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cAlmacenTicket"}, .F. )

   _HB_MEMBER { lPrintTicket } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lPrintTicket"}, .F. )

   _HB_MEMBER { lProcesing } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lProcesing"}, .F. )

   _HB_MEMBER { nTotalTicket } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nTotalTicket"}, .F. )

   _HB_MEMBER { hTicketHeader } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"hTicketHeader"}, .F. )

   _HB_MEMBER { aTicketLines } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aTicketLines"}, .F. )

   _HB_MEMBER { hTicketPay } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"hTicketPay"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @PdaEnvioRecepcionController_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER End(); oClass:AddMethod( "End", @PdaEnvioRecepcionController_End(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER getInstance(); oClass:AddInline( "getInstance", {|Self | ( ( Self ) ), ( iif( empty( ::oInstance ), ::oInstance := ::New(), ), ::oInstance ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER rebuildInstance(); oClass:AddInline( "rebuildInstance", {|Self | ( ( Self ) ), ( iif( !empty( ::oInstance ), ( ::oInstance:end(), ::oInstance := nil ), ), ::getInstance() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER stopTimer(); oClass:AddMethod( "stopTimer", @PdaEnvioRecepcionController_stopTimer(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER activateTimer(); oClass:AddMethod( "activateTimer", @PdaEnvioRecepcionController_activateTimer(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @PdaEnvioRecepcionController_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER exportJson(); oClass:AddMethod( "exportJson", @PdaEnvioRecepcionController_exportJson(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER exportArticulosJson(); oClass:AddMethod( "exportArticulosJson", @PdaEnvioRecepcionController_exportArticulosJson(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER buildArticuloJson(); oClass:AddMethod( "buildArticuloJson", @PdaEnvioRecepcionController_buildArticuloJson(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

      _HB_MEMBER exportUsuariosJson(); oClass:AddMethod( "exportUsuariosJson", @PdaEnvioRecepcionController_exportUsuariosJson(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER buildUsuariosJson(); oClass:AddMethod( "buildUsuariosJson", @PdaEnvioRecepcionController_buildUsuariosJson(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

      _HB_MEMBER writeJsonFile( cFileName); oClass:AddMethod( "writeJsonFile", @PdaEnvioRecepcionController_writeJsonFile(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER writeArticulosJson(); oClass:AddInline( "writeArticulosJson", {|Self | ( ( Self ) ), ( ::writeJsonFile( "articulos.json" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER writeUsuariosJson(); oClass:AddInline( "writeUsuariosJson", {|Self | ( ( Self ) ), ( ::writeJsonFile( "usuarios.json" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER cFileIn(); oClass:AddInline( "cFileIn", {|Self, cFileName | ( ( Self ) ), ( cPath( ::cPath ) + "in\" + cFileName ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cFileOut(); oClass:AddInline( "cFileOut", {|Self, cFileName | ( ( Self ) ), ( cPath( ::cPath ) + "out\" + cFileName ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cFileProcessed(); oClass:AddInline( "cFileProcessed", {|Self, cFileName | ( ( Self ) ), ( cPath( ::cPath ) + "processed\" + cFileName ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER importJson(); oClass:AddMethod( "importJson", @PdaEnvioRecepcionController_importJson(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER importJsonFile( cFileName); oClass:AddMethod( "importJsonFile", @PdaEnvioRecepcionController_importJsonFile(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER isJsonProcessed( hJson); oClass:AddMethod( "isJsonProcessed", @PdaEnvioRecepcionController_isJsonProcessed(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER moveFileToProcessed( cFileName); oClass:AddMethod( "moveFileToProcessed", @PdaEnvioRecepcionController_moveFileToProcessed(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

      _HB_MEMBER getTicketCount(); oClass:AddMethod( "getTicketCount", @PdaEnvioRecepcionController_getTicketCount(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER setTicketCount(); oClass:AddMethod( "setTicketCount", @PdaEnvioRecepcionController_setTicketCount(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

      _HB_MEMBER buildTicketHeaderHash( hJson); oClass:AddMethod( "buildTicketHeaderHash", @PdaEnvioRecepcionController_buildTicketHeaderHash(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER buildTicketPayHash( hJson); oClass:AddMethod( "buildTicketPayHash", @PdaEnvioRecepcionController_buildTicketPayHash(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER buildTicketLinesHash( hJson); oClass:AddMethod( "buildTicketLinesHash", @PdaEnvioRecepcionController_buildTicketLinesHash(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
         _HB_MEMBER buildTicketLineHash( hLine); oClass:AddMethod( "buildTicketLineHash", @PdaEnvioRecepcionController_buildTicketLineHash(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

      _HB_MEMBER createTicket( hJson); oClass:AddMethod( "createTicket", @PdaEnvioRecepcionController_createTicket(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER createTicketLines(); oClass:AddMethod( "createTicketLines", @PdaEnvioRecepcionController_createTicketLines(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
         _HB_MEMBER createTicketLine( hLine); oClass:AddMethod( "createTicketLine", @PdaEnvioRecepcionController_createTicketLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER createTicketPay(); oClass:AddMethod( "createTicketPay", @PdaEnvioRecepcionController_createTicketPay(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

      _HB_MEMBER printTicket(); oClass:AddMethod( "printTicket", @PdaEnvioRecepcionController_printTicket(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER setTotalProgress(); oClass:AddInline( "setTotalProgress", {|Self, nTotal | ( ( Self ) ), ( iif(  !empty( ::oDialogView:oProgress ), ::oDialogView:oProgress:setTotal( nTotal ), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER autoIncProgress(); oClass:AddInline( "autoIncProgress", {|Self | ( ( Self ) ), ( iif(  !empty( ::oDialogView:oProgress ), ::oDialogView:oProgress:autoInc(), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER deleteTreeLog(); oClass:AddInline( "deleteTreeLog", {|Self, cText | ( ( Self ) ), ( iif(  !empty( ::oDialogView:oTreeLog ), ::oDialogView:oTreeLog:deleteAll(), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER addTreeLog(); oClass:AddInline( "addTreeLog", {|Self, cText | ( ( Self ) ), ( iif(  !empty( ::oDialogView:oTreeLog ), ::oDialogView:oTreeLog:Select( ::oDialogView:oTreeLog:Add( cText ) ), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER clearPath(); oClass:AddMethod( "clearPath", @PdaEnvioRecepcionController_clearPath(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setAlarmoMsgBar(); oClass:AddMethod( "setAlarmoMsgBar", @PdaEnvioRecepcionController_setAlarmoMsgBar(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CheckDirectories(); oClass:AddMethod( "CheckDirectories", @PdaEnvioRecepcionController_CheckDirectories(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nCalculateTotal(); oClass:AddMethod( "nCalculateTotal", @PdaEnvioRecepcionController_nCalculateTotal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS PdaEnvioRecepcionController ;



static FUNCTION PdaEnvioRecepcionController_New( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::cPath                 := ConfiguracionesEmpresaModel():getValue( "pda_ruta", "" )

   if !Empty( ::cPath )
      ::CheckDirectories()
   end

   ::nSeconds              := ConfiguracionesEmpresaModel():getNumeric( "pda_recoger_ventas", 0 )

   if !empty( ::nSeconds )

      ::oTimer             := TTimer():New( ::nSeconds * 1000, {|| ::importJson() }, )
      ::oTimer:hWndOwner   := GetActiveWindow()

      ::setAlarmoMsgBar()

   end

   ::oDialogView           := PdaEnvioRecepcionView():New( Self )

RETURN ( self )



static FUNCTION PdaEnvioRecepcionController_End( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   if !empty( ::oTimer )
      ::oTimer:end()
   end

   ::oTimer                := nil

RETURN ( nil )



static FUNCTION PdaEnvioRecepcionController_Activate( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::stopTimer()

   ::oDialogView:Activate()

   ::activateTimer()

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_exportJson( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::addTreeLog( "Iniciando el proceso de exportación" )

   ::exportArticulosJson()

   ::exportUsuariosJson()

   ::addTreeLog( "Proceso de exportación finalizado" )

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_exportArticulosJson( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local cArea    := "ArtJson"

   ::aJson        := {}

   ::addTreeLog( "Exportando articulos a json" )

   ArticulosModel():getArticulosToJson( @cArea )

   ::setTotalProgress( ( cArea )->( lastrec() ) )

   ( cArea )->( dbgotop() )

   while !( cArea )->( eof() )

      aadd( ::aJson, ::buildArticuloJson( cArea ) )

      ::autoIncProgress()

      ( cArea )->( dbskip() )

   end

   ( cArea )->( dbCloseArea() )

   ::writeArticulosJson()

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_buildArticuloJson( cArea ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local hJson    := {=>}
   local aCodebar := {}

   hset( hJson, "id",                           alltrim( ( cArea )->Codigo ) )
   hset( hJson, "nombre",                       alltrim( hb_oemtoansi( ( cArea )->Nombre ) ) )
   hset( hJson, "uuid",                         alltrim( ( cArea )->uuid ) )
   hset( hJson, "precio_venta",                 ( cArea )->pVenta1 )
   hset( hJson, "porcentaje_iva",               ( cArea )->tpIva )
   hset( hJson, "precio_impuestos_incluidos",   ( cArea )->pVtaIva1 )

   aadd( aCodebar, alltrim( ( cArea )->Codigo ) )

   if !empty( ( cArea )->cCodBar )
      aadd( aCodebar, alltrim( ( cArea )->cCodBar ) )
   end

   hset( hJson, "codigos_barras", aCodebar )

RETURN ( hJson )



static FUNCTION PdaEnvioRecepcionController_exportUsuariosJson( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local aUsuarios   := {}

   ::aJson           := {}

   ::addTreeLog( "Exportando usuarios a json" )

   aUsuarios         := UsuariosModel():getUsuariosToJson()

   ::setTotalProgress( len( aUsuarios ) )

   aeval( aUsuarios, {|a| aAdd( ::aJson, ::buildUsuariosJson( a ) ), ::autoIncProgress() } )

   ::writeUsuariosJson()

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_buildUsuariosJson( aUsuario ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local hJson    := {=>}

   hset( hJson, "id",      alltrim( aUsuario[1] ) )
   hset( hJson, "nombre",  alltrim( aUsuario[2] ) )

RETURN ( hJson )



static FUNCTION PdaEnvioRecepcionController_writeJsonFile( cFileName ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local cFile
   local cJson

   cJson          := hb_jsonencode( ::aJson, .T. )

   cFile          := cPath( ::cPath ) + "in\" + cFileName

   ::addTreeLog( "Exportando fichero json " + alltrim( cFile ) )

   if !( memowrit( cFile, cJson ) )
      msgStop( "Error al escribir el fichero " + alltrim( cFile ), "Error" )
   end

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_importJson( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local aDirectory

   if ::lProcesing
      RETURN ( nil )
   end

   ::lProcesing   := .T.

   aDirectory     := directory( cPath( ::cPath ) + "out\*.*" )

   ::setTotalProgress( len( aDirectory ) )

   ::deleteTreeLog()

   ::addTreeLog( "Inicio proceso importación" )

   if !empty( aDirectory )
      aeval( aDirectory, {|cFileName| ::importJsonFile( cFileName[ 1 ] ) } )
   end

   ::addTreeLog( "Proceso importación finalizado" )

   ::lProcesing   := .F.

RETURN ( nil )



static FUNCTION PdaEnvioRecepcionController_importJsonFile( cFileName ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local hJson

   if At( "inventory", cFileName ) <> 0
      ::addTreeLog( "Excluido : " + cFileName )
      RETURN ( Self )
   end

   ::addTreeLog( "Directorio de trabajo : " + cPath( ::cPath ) )

   ::autoIncProgress()

   ::addTreeLog( "Procesando : " + cFileName )

   hb_jsondecode( memoread( cPath( ::cPath ) + "out\" + cFileName ), @hJson )

   if ::isJsonProcessed( hJson )
      ::moveFileToProcessed( cFileName )
   end

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_isJsonProcessed( hJson ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   if !hb_ishash( hJson )
      RETURN ( .F. )
   end

   ::nTotalTicket          := 0

   ::hTicketHeader         := {=>}

   ::aTicketLines          := {}

   ::cNumeroTicket         := ::getTicketCount()

   ::dFechaTicket          := ctod( substr( hget( hJson, "fecha_hora" ), 1, 10 ) )

   ::cHoraTicket           := substr( hget( hJson, "fecha_hora" ), 12, 5 )

   if hhaskey( hJson, "descuento" )
      ::nDescuentoTicket   := Round( hget( hJson, "descuento" ), 2 )
   else
      ::nDescuentoTicket   := 0
   end

   if hhaskey( hJson, "fpago" )
      ::cFormaPago         := hget( hJson, "fpago" )
   else
      ::cFormaPago         := "00"
   end

   ::cAlmacenTicket  := Application():codigoAlmacen()

   ::buildTicketLinesHash( hJson )

   ::buildTicketHeaderHash( hJson )

   ::buildTicketPayHash( hJson )

   if ::createTicket()

      ::setTicketCount()

      ::createTicketLines()

      ::createTicketPay()

      ::printTicket()

      RETURN ( .T. )

   end

RETURN ( .F. )



static FUNCTION PdaEnvioRecepcionController_getTicketCount( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local nNumTik     := ContadoresModel():getNumeroTicket( ::cSerieTicket )

   while TicketsClientesModel():existId( ::cSerieTicket, nNumTik, ::cSufijoTicket )
      nNumTik++
   end

RETURN ( padl( str( nNumTik ), 10 ) )



static FUNCTION PdaEnvioRecepcionController_setTicketCount( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

RETURN ( ContadoresModel():setNumeroTicket( ::cSerieTicket, val( ::cNumeroTicket ) + 1 ) )



static FUNCTION PdaEnvioRecepcionController_nCalculateTotal( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local nTotal   := 0

   nTotal         := ::nTotalTicket

   nTotal         -= ( ( ::nTotalTicket * ::nDescuentoTicket ) / 100 )

RETURN nTotal



static FUNCTION PdaEnvioRecepcionController_buildTicketHeaderHash( hJson ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::addTreeLog( "Contruyendo cabecera de ticket" )

   hset( ::hTicketHeader, "cSerTik", ::cSerieTicket )
   hset( ::hTicketHeader, "cNumTik", ::cNumeroTicket )
   hset( ::hTicketHeader, "cSufTik", ::cSufijoTicket )

   hset( ::hTicketHeader, "cTurTik", cShortSesion() )
   hset( ::hTicketHeader, "cTipTik", "1" )

   hset( ::hTicketHeader, "dFecTik", ::dFechaTicket )
   hset( ::hTicketHeader, "cHorTik", ::cHoraTicket )
   hset( ::hTicketHeader, "cAlmTik", ::cAlmacenTicket )

   hset( ::hTicketHeader, "cCcjTik", hget( hJson, "usuario" ) )
   hset( ::hTicketHeader, "cNcjTik", Application():CodigoCaja() )

   hset( ::hTicketHeader, "cCliTik", cDefCli() )
   hset( ::hTicketHeader, "cNomTik", ClientesModel():getNombre( cDefCli() ) )
   hset( ::hTicketHeader, "nTarifa", max( uFieldEmpresa( "nPreVta" ), 1 ) )
   if Empty( ::cFormaPago )
      hset( ::hTicketHeader, "cFpgTik", cDefFpg() )
   else
      hset( ::hTicketHeader, "cFpgTik", ::cFormaPago )
   end
   hset( ::hTicketHeader, "cDivTik", cDivEmp() )
   hset( ::hTicketHeader, "nVdvTik", 1 )
   hset( ::hTicketHeader, "lPgdTik", .T. )
   hset( ::hTicketHeader, "lSndDoc", .T. )
   hset( ::hTicketHeader, "dFecCre", date() )
   hset( ::hTicketHeader, "cTimCre", substr( time(), 1, 5 ) )



   hset( ::hTicketHeader, "nTotTik", ::nCalculateTotal() )
   hset( ::hTicketHeader, "nCobTik", ::nCalculateTotal() )

   hset( ::hTicketHeader, "uuid",    hget( hJson, "uuid" ) )

   if hhaskey( hJson, "descuento" )
      hset( ::hTicketHeader, "cDtoEsp", "General" )
      hset( ::hTicketHeader, "nDtoEsp", ::nDescuentoTicket )
   end

   ::lPrintTicket       := hget( hJson, "imprimir" )

RETURN ( .T. )



static FUNCTION PdaEnvioRecepcionController_buildTicketLinesHash( hJson ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::addTreeLog( "Contruyendo líneas de ticket" )

RETURN ( aeval( hget( hJson, "lineas" ), {|hLine| ::buildTicketLineHash( hLine ) } ) )



static FUNCTION PdaEnvioRecepcionController_buildTicketLineHash( hLine ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local hArticulo
   local idArticulo
   local hTicketLine

   hTicketLine       := {=>}
   idArticulo        := cvaltochar( hget( hLine, "id_articulo" ) )
   hArticulo         := ArticulosModel():getHash( idArticulo )

   hset( hTicketLine, "cSerTil", ::cSerieTicket )
   hset( hTicketLine, "cNumTil", ::cNumeroTicket )
   hset( hTicketLine, "cSufTil", ::cSufijoTicket )

   hset( hTicketLine, "cTipTil", "1" )

   hset( hTicketLine, "dFecTik", ::dFechaTicket )
   hset( hTicketLine, "tFecTik", ::cHoraTicket )
   hset( hTicketLine, "cAlmLin", ::cAlmacenTicket )

   hset( hTicketLine, "cCbaTil", idArticulo )
   hset( hTicketLine, "nUntTil", hget( hLine, "unidades" ) )
   hset( hTicketLine, "nPvpTil", hget( hLine, "precio" ) / hget( hLine, "unidades" ) )
   hset( hTicketLine, "uuid",    hget( hLine, "uuid" ) )

   if !empty( hArticulo )
      hset( hTicketLine, "cNomTil", alltrim( hget( hArticulo, "nombre" ) ) )
      hset( hTicketLine, "cFamTil", alltrim( hget( hArticulo, "familia" ) ) )
      hset( hTicketLine, "nCosTil", hget( hArticulo, "pcosto" ) )
      hset( hTicketLine, "nCtlStk", hget( hArticulo, "nctlstock" ) )
      hset( hTicketLine, "nIvaTil", TiposIvaModel():getIva( hget( hArticulo, "tipoiva" ) ) )
      hset( hTicketLine, "cCodFam", alltrim( hget( hArticulo, "familia" ) ) )
      hset( hTicketLine, "cGrpFam", FamiliasModel():getGrupo( hget( hArticulo, "familia" ) ) )
   end

   aadd( ::aTicketLines, hTicketLine )

   ::nTotalTicket    += hget( hLine, "precio" )

RETURN ( .T. )



static FUNCTION PdaEnvioRecepcionController_buildTicketPayHash( hJson ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::hTicketPay      := {=>}

   hset( ::hTicketPay, "cSerTik", ::cSerieTicket )
   hset( ::hTicketPay, "cNumTik", ::cNumeroTicket )
   hset( ::hTicketPay, "cSufTik", ::cSufijoTicket )
   hset( ::hTicketPay, "cCodCaj", Application():CodigoCaja() )
   hset( ::hTicketPay, "dPgoTik", ctod( substr( hget( hJson, "fecha_hora" ), 1, 10 ) ) )
   hset( ::hTicketPay, "cTimTik", substr( hget( hJson, "fecha_hora" ), 12, 5 ) )
   if Empty( ::cFormaPago )
      hset( ::hTicketPay, "cFpgPgo", cDefFpg() )
   else
      hset( ::hTicketPay, "cFpgPgo", ::cFormaPago )
   end
   hset( ::hTicketPay, "nImpTik", ::nCalculateTotal() )
   hset( ::hTicketPay, "cDivPgo", cDivEmp() )
   hset( ::hTicketPay, "nVdvPgo", 1 )
   hset( ::hTicketPay, "lSndPgo", .T. )
   hset( ::hTicketPay, "cTurPgo", cShortSesion() )

RETURN ( .T. )



static FUNCTION PdaEnvioRecepcionController_createTicket( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::addTreeLog( "Creando ticket" )

   if TicketsClientesModel():existUuid( hget( ::hTicketHeader, "uuid" ) )
      ::addTreeLog( "Ticket ya importado : " + hget( ::hTicketHeader, "uuid" ) )
      RETURN ( .F. )
   end

   TicketsClientesModel():createFromHash( ::hTicketHeader )

   ::addTreeLog( "Ticket creado : " + hget( ::hTicketHeader, "cSerTik" ) + "/" + alltrim( hget( ::hTicketHeader, "cNumTik" ) ) + "/" + hget( ::hTicketHeader, "cSufTik" ) )

RETURN ( .T. )



static FUNCTION PdaEnvioRecepcionController_createTicketLines( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::addTreeLog( "Creando lineas de ticket" )

   aeval( ::aTicketLines, {| hLine | ::createTicketLine( hLine ) } )

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_createTicketLine( hLine ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   TicketsClientesLineasModel():createFromHash( hLine )

   ::addTreeLog( "Línea ticket creado : " + hget( hLine, "cCbaTil" ) + " - " + cvaltochar( hget( hLine, "nUntTil" ) ) + " - " + cvaltochar( hget( hLine, "nPvpTil" ) ) )

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_createTicketPay( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   TicketsClientesPagosModel():createFromHash( ::hTicketPay )

   ::addTreeLog( "Pago ticket creado : " + hget( ::hTicketPay, "cSerTik" ) + "/" + alltrim( hget( ::hTicketPay, "cNumTik" ) ) + "/" + hget( ::hTicketPay, "cSufTik" ) )

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_moveFileToProcessed( cFileName ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   if copyfile( ::cFileOut( cFileName ), ::cFileProcessed( cFileName ) )
      ferase( ::cFileOut( cFileName ) )
   end

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_printTicket( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   if ::lPrintTicket

      prnTikCli( ::cSerieTicket + ::cNumeroTicket + ::cSufijoTicket )

   end

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_activateTimer( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   ::stopTimer()

   if !empty( ::oTimer )
      ::oTimer:Activate()
   end

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_stopTimer( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   if !empty( ::oTimer )
      ::oTimer:deactivate()
   endif

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_clearPath( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   local aDirectory

   aDirectory        := directory( cPath( ::cPath ) + "*.*" )

   if !empty( aDirectory )
      aeval( aDirectory, {|cFileName| ferase( cPath( ::cPath ) + "\" + cFileName[ 1 ] ) } )
   end

   aDirectory        := directory( cPath( ::cPath ) + "out\*.*" )

   if !empty( aDirectory )
      aeval( aDirectory, {|cFileName| ferase( cPath( ::cPath ) + "out\" + cFileName[ 1 ] ) } )
   end

   aDirectory        := directory( cPath( ::cPath ) + "in\*.*" )

   if !empty( aDirectory )
      aeval( aDirectory, {|cFileName| ferase( cPath( ::cPath ) + "in\" + cFileName[ 1 ] ) } )
   end







RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_setAlarmoMsgBar( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   if Empty( ::oMsgAlarm )
      ::oMsgAlarm         := TMsgItem():New( oWnd():oMsgBar,,24,,,,.T.,,"gc_pda_16",, "Timmer pda activado" )
      ::oMsgAlarm:bAction := {|| nil }
   end

RETURN ( Self )



static FUNCTION PdaEnvioRecepcionController_CheckDirectories( ) ; local Self AS CLASS PdaEnvioRecepcionController := QSelf() AS CLASS PdaEnvioRecepcionController

   if !lIsDir( cPath( ::cPath ) + "in" )
      makedir( cNamePath( cPath( ::cPath ) + "in\" ) )
   end

   if !lIsDir( cPath( ::cPath ) + "out\" )
      makedir( cNamePath( cPath( ::cPath ) + "out\" ) )
   end

   if !lIsDir( cPath( ::cPath ) + "processed\" )
      makedir( cNamePath( cPath( ::cPath ) + "processed\" ) )
   end

Return ( nil )
