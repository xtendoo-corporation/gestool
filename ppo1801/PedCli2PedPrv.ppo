#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 10 ".\.\Prg\PedCli2PedPrv.prg"
_HB_CLASS PedCliente2PedProveedor ; function PedCliente2PedProveedor ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "PedCliente2PedProveedor", iif( .F., { }, { @HBObject() } ), @PedCliente2PedProveedor() ) ) ;

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )
   _HB_MEMBER { oPag } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPag"}, .F. )
   _HB_MEMBER { oBmp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBmp"}, .F. )
   _HB_MEMBER { oBrw } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrw"}, .F. )
   _HB_MEMBER { oBrwFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwFin"}, .F. )

   _HB_MEMBER { oBtnPrev } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnPrev"}, .F. )
   _HB_MEMBER { oBtnNext } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnNext"}, .F. )
   _HB_MEMBER { oBtnCancel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnCancel"}, .F. )

   _HB_MEMBER { nStockDisponible } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nStockDisponible"}, .F. )
   _HB_MEMBER { nStockFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nStockFin"}, .F. )

   _HB_MEMBER { oPeriodo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPeriodo"}, .F. )
   _HB_MEMBER { cPeriodo } ; oClass:AddMultiData(, "Todos", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPeriodo"}, .F. )

   _HB_MEMBER { oFecIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFecIni"}, .F. )
   _HB_MEMBER { oFecFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFecFin"}, .F. )

   _HB_MEMBER { dFecIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFecIni"}, .F. )
   _HB_MEMBER { dFecFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFecFin"}, .F. )

   _HB_MEMBER { nView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nView"}, .F. )

   _HB_MEMBER { oTipoArticulo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTipoArticulo"}, .F. )
   _HB_MEMBER { oFabricante } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFabricante"}, .F. )
   _HB_MEMBER { oStock } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oStock"}, .F. )

   _HB_MEMBER { oMtr } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMtr"}, .F. )
   _HB_MEMBER { nMtr } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nMtr"}, .F. )

   _HB_MEMBER { dbfTemporal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dbfTemporal"}, .F. )

   _HB_MEMBER { oBrwRangos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwRangos"}, .F. )

   _HB_MEMBER { aPedidos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aPedidos"}, .F. )

   _HB_MEMBER { oItemGroupArticulo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oItemGroupArticulo"}, .F. )
   _HB_MEMBER { oItemGroupFamilia } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oItemGroupFamilia"}, .F. )
   _HB_MEMBER { oItemGroupCategoria } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oItemGroupCategoria"}, .F. )
   _HB_MEMBER { oItemGroupTemporada } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oItemGroupTemporada"}, .F. )
   _HB_MEMBER { oItemGroupFabricante } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oItemGroupFabricante"}, .F. )
   _HB_MEMBER { oItemGroupTipoArticulo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oItemGroupTipoArticulo"}, .F. )

   _HB_MEMBER { lOnlyOrder } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lOnlyOrder"}, .F. )

   _HB_MEMBER { cSerieOrder } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerieOrder"}, .F. )
   _HB_MEMBER { nNumeroOrder } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumeroOrder"}, .F. )
   _HB_MEMBER { cSufijoOrder } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijoOrder"}, .F. )

   _HB_MEMBER New( nView, lOnlyOrder) AS CLASS PedCliente2PedProveedor; oClass:AddMethod( "New", @PedCliente2PedProveedor_New(), nScope + iif( .T., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource(); oClass:AddMethod( "Resource", @PedCliente2PedProveedor_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER Prev(); oClass:AddMethod( "Prev", @PedCliente2PedProveedor_Prev(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER Next(); oClass:AddMethod( "Next", @PedCliente2PedProveedor_Next(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CreateLines(); oClass:AddMethod( "CreateLines", @PedCliente2PedProveedor_CreateLines(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER DestroyLines(); oClass:AddMethod( "DestroyLines", @PedCliente2PedProveedor_DestroyLines(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER aCreaArrayPeriodos(); oClass:AddMethod( "aCreaArrayPeriodos", @PedCliente2PedProveedor_aCreaArrayPeriodos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lRecargaFecha(); oClass:AddMethod( "lRecargaFecha", @PedCliente2PedProveedor_lRecargaFecha(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER StartDialog(); oClass:AddMethod( "StartDialog", @PedCliente2PedProveedor_StartDialog(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadLineasPedidos(); oClass:AddMethod( "LoadLineasPedidos", @PedCliente2PedProveedor_LoadLineasPedidos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadLinesaOnlyOrder(); oClass:AddMethod( "LoadLinesaOnlyOrder", @PedCliente2PedProveedor_LoadLinesaOnlyOrder(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AddLineasPedidos( nStock, nReserva); oClass:AddMethod( "AddLineasPedidos", @PedCliente2PedProveedor_AddLineasPedidos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SelectAllArticulo( lSel); oClass:AddMethod( "SelectAllArticulo", @PedCliente2PedProveedor_SelectAllArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SelectArticulo(); oClass:AddMethod( "SelectArticulo", @PedCliente2PedProveedor_SelectArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ChangeUnidades( oCol, uNewValue, nKey); oClass:AddMethod( "ChangeUnidades", @PedCliente2PedProveedor_ChangeUnidades(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ChangeCajas( oCol, uNewValue, nKey); oClass:AddMethod( "ChangeCajas", @PedCliente2PedProveedor_ChangeCajas(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getCodigoProveerdor(); oClass:AddMethod( "getCodigoProveerdor", @PedCliente2PedProveedor_getCodigoProveerdor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER ChangeProveedor( x); oClass:AddMethod( "ChangeProveedor", @PedCliente2PedProveedor_ChangeProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GeneraPedidoProveedor(); oClass:AddMethod( "GeneraPedidoProveedor", @PedCliente2PedProveedor_GeneraPedidoProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER TotalPedidoProveedor(); oClass:AddMethod( "TotalPedidoProveedor", @PedCliente2PedProveedor_TotalPedidoProveedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Calculaunidades( nCantidad, nStockDis, nStockMinMax); oClass:AddMethod( "Calculaunidades", @PedCliente2PedProveedor_Calculaunidades(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lEstadoGenerado(); oClass:AddMethod( "lEstadoGenerado", @PedCliente2PedProveedor_lEstadoGenerado(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS PedCliente2PedProveedor ;



static FUNCTION PedCliente2PedProveedor_New( nView, oTipoArticulo, oFabricante, oStock, lOnlyOrder ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   If( lOnlyOrder == nil, lOnlyOrder := .F., ) ;

   if !lAIS()
      MsgStop( "Opción disponible sólo para versión ADS." )
      Return .T.
   end

   ::nView              := nView

   ::oTipoArticulo      := oTipoArticulo
   ::oFabricante        := oFabricante
   ::oStock             := oStock

   ::nStockDisponible   := 2
   ::nStockFin          := 3

   ::aPedidos           := {}

   ::lOnlyOrder         := lOnlyOrder

   ::cSerieOrder        := ( D():PedidosClientes( ::nView ) )->cSerPed
   ::nNumeroOrder       := ( D():PedidosClientes( ::nView ) )->nNumPed
   ::cSufijoOrder       := ( D():PedidosClientes( ::nView ) )->cSufPed

   if ::lOnlyOrder .AND. ( D():PedidosClientes( ::nView ) )->nGenerado > 1
      MsgStop( "El pedido ya ha sido pasado a proveedor." )
      Return ( self )
   end

   if ::CreateLines()
      ::Resource()
   end

RETURN ( Self )



static FUNCTION PedCliente2PedProveedor_CreateLines( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local oError
   local oBlock
   local cTmpLin
   local lErrors  := .F.

   CursorWait()

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   cTmpLin        := cGetNewFileName( cPatTmp() + "PTmpCliL" )

   dbCreate( cTmpLin, aSqlStruct( aColTmpLin() ), cLocalDriver() )

   dbUseArea( .T., cLocalDriver(), cTmpLin, cCheckArea( "PTmpCliL", @::dbfTemporal ), .F. )

   if !NetErr()

      ( ::dbfTemporal )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( ::dbfTemporal )->( ordCreate( cTmpLin, "cRefPrp", "cRef + cCodPr1 + cCodPr2 + cValPr1 + cValPr2 + cLote", {|| Field->cRef + Field->cCodPr1 + Field->cCodPr2 + Field->cValPr1 + Field->cValPr2 + Field->cLote } ) )

      ( ::dbfTemporal )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( ::dbfTemporal )->( ordCreate( cTmpLin, "cCodPrv", "cCodPrv", {|| Field->cCodPrv } ) )

      ( ::dbfTemporal )->( OrdSetFocus( "cRefPrp" ) )

   else

      lErrors     := .T.

   end

   RECOVER USING oError

      lErrors                             := .T.

      msgStop( "Imposible crear las bases de datos temporales" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   CursorWE()

Return ( !lErrors )



static FUNCTION PedCliente2PedProveedor_DestroyLines( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor





   if !Empty( ::dbfTemporal ) .AND. ( ::dbfTemporal )->( Used() )
      ( ::dbfTemporal )->( dbCloseArea() )
   end





   dbfErase( ::dbfTemporal )

   ::oDlg:end()

Return .T.



static FUNCTION PedCliente2PedProveedor_Resource( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   ::oDlg = TDialog():New(,,,,, "PEDCLI2PEDPROV",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )





      ::oBmp := TBitmap():ReDefine( 600, "gc_clipboard_empty_businessman_48",, ::oDlg,,, .F., .F.,,, .F.,,, .T. )






      ::oPag := TPages():Redefine( 100, ::oDlg, {"PEDCLI2PEDPROV_1", "PEDCLI2PEDPROV_2", "PEDCLI2PEDPROV_3"},,,, )










      ::oPeriodo := TComboBox():ReDefine( 100, { | u | If( PCount()==0, ::cPeriodo, ::cPeriodo:= u ) }, ::aCreaArrayPeriodos(), ::oPag:aDialogs[1],,,,,,, .F., {||        !::lOnlyOrder},,,,,, "::oPeriodo",,,,,,, )

         ::oPeriodo:bCHange   := {|| ::lRecargaFecha() }





      ::oFecIni := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::dFecIni, ::dFecIni:= u ) }, ::oPag:aDialogs[1],,,,,,,,, .F., {||        !::lOnlyOrder},, .F., .T.,,,,,, nil,,, )





      ::oFecFin := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::dFecFin, ::dFecFin:= u ) }, ::oPag:aDialogs[1],,,,,,,,, .F., {||        !::lOnlyOrder},, .F., .T.,,,,,, nil,,, )

      ::oBrwRangos               := BrowseRangos():New( 130, ::oPag:aDialogs[1] )

      ::oItemGroupArticulo       := TItemGroupArticulo():New( ::nView )
      ::oBrwRangos:AddGroup( ::oItemGroupArticulo )

      ::oItemGroupFamilia        := TItemGroupFamilia():New( ::nView )
      ::oBrwRangos:AddGroup( ::oItemGroupFamilia )

      ::oItemGroupTemporada      := TItemGroupTemporada():New( ::nView )
      ::oBrwRangos:AddGroup( ::oItemGroupTemporada )

      ::oItemGroupFabricante     := TItemGroupFabricante():New( ::nView, ::oFabricante )
      ::oBrwRangos:AddGroup( ::oItemGroupFabricante )

      ::oItemGroupTipoArticulo   := TItemGroupTipoArticulo():New( ::nView, ::oTipoArticulo )
      ::oBrwRangos:AddGroup( ::oItemGroupTipoArticulo )

      ::oBrwRangos:Resource()



      TRadMenu():Redefine( { | u | If( PCount()==0, ::nStockDisponible, ::nStockDisponible:= u ) }, ::oPag:aDialogs[1],, { 201, 202, 203, 204 },,,,, .F.,, )



      TRadMenu():Redefine( { | u | If( PCount()==0, ::nStockFin, ::nStockFin:= u ) }, ::oPag:aDialogs[1],, { 212, 213, 214 },,,,, .F.,, )

      ::oMtr               := TApoloMeter():ReDefine( 220, { | u | if( pCount() == 0, ::nMtr, ::nMtr := u ) }, 10, ::oPag:aDialogs[1], .F., , , .T., ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), , ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) ) )





      ::oBrw               := IXBrowse():New( ::oPag:aDialogs[2] )

      ::oBrw:bClrSel       := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrw:bClrSelFocus  := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oBrw:cAlias        := ::dbfTemporal

      ::oBrw:nMarqueeStyle := 6
      ::oBrw:cName         := "Generarpedprv"
      ::oBrw:lFooter       := .T.
      ::oBrw:MakeTotals()

      ::oBrw:bLDblClick    := {|| ::SelectArticulo() }

      ::oBrw:CreateFromResource( 100 )

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Se. Seleccionado"
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( ::dbfTemporal )->lSelArt }
         :nWidth           := 20
         :SetCheck( { "gc_check_16", "Nil16" } )
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Código"
         :bEditValue       := {|| ( ::dbfTemporal )->cCodPrv }
         :bOnPostEdit      := {|o,x| ::ChangeProveedor( x ) }
         :bEditValid       := {|oGet| cProvee( oGet, D():Proveedores( ::nView ) ) }
         :bEditBlock       := {|oGet| BrwProvee( oGet ) }
         :nWidth           := 80
         :nEditType        := 5
         :nBtnBmp          := 1
         :AddResource( "Lupa" )
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Proveedor"
         :bEditValue       := {|| RetProvee( ( ::dbfTemporal )->cCodPrv ) }
         :nWidth           := 200
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Artículo"
         :bEditValue       := {|| ( ::dbfTemporal )->cRef }
         :nWidth           := 70
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Referencia"
         :bEditValue       := {|| ( ::dbfTemporal )->cRefPrv }
         :nWidth           := 70
         :lHide            := .T.
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Nombre"
         :bEditValue       := {|| if( !Empty( ( ::dbfTemporal )->cRef ), ( ::dbfTemporal )->cDetalle, ( ::dbfTemporal )->mLngDes ) }
         :nWidth           := 155
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Propiedad 1"
         :bEditValue       := {|| AllTrim( ( ::dbfTemporal )->cValPr1 ) + if( !Empty( ( ::dbfTemporal )->cValPr1 ), " - " + retValProp( ( ::dbfTemporal )->cCodPr1 + ( ::dbfTemporal )->cValPr1, D():PropiedadesLineas( ::nView ) ) , "" ) }
         :nWidth           := 80
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Propiedad 2"
         :bEditValue       := {|| AllTrim( ( ::dbfTemporal )->cValPr2 ) + if( !Empty( ( ::dbfTemporal )->cValPr2 ), " - " + retValProp( ( ::dbfTemporal )->cCodPr2 + ( ::dbfTemporal )->cValPr2, D():PropiedadesLineas( ::nView ) ) , "" ) }
         :nWidth           := 80
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := cNombreCajas()
         :bEditValue       := {|| ( ::dbfTemporal )->nNumCaj }
         :cEditPicture     := MasUnd()
         :nWidth           := 50
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nEditType        := 1
         :nFooterType      := 1
         :bOnPostEdit      := {|o,x,n| ::ChangeCajas( o, x, n ) }
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := cNombreUnidades()
         :bEditValue       := {|| ( ::dbfTemporal )->nNumUni }
         :cEditPicture     := MasUnd()
         :nWidth           := 60
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nEditType        := 1
         :nFooterType      := 1
         :bOnPostEdit      := {|o,x,n| ::ChangeUnidades( o, x, n ) }
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Stk. físico"
         :bEditValue       := {|| ( ::dbfTemporal )->nStkFis }
         :cEditPicture     := MasUnd()
         :nWidth           := 60
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( ::oBrw:AddCol() )
         :cHeader          := "Stk. disponible"
         :bEditValue       := {|| ( ::dbfTemporal )->nStkDis }
         :cEditPicture     := MasUnd()
         :nWidth           := 90
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end




      TButton():ReDefine( 120, {||( ::SelectArticulo() )}, ::oPag:aDialogs[2],,, .F.,,,, .F. )




      TButton():ReDefine( 130, {||( ::SelectAllArticulo( .T. ) )}, ::oPag:aDialogs[2],,, .F.,,,, .F. )




      TButton():ReDefine( 140, {||( ::SelectAllArticulo( .F. ) )}, ::oPag:aDialogs[2],,, .F.,,,, .F. )





      ::oBrwFin                  := IXBrowse():New( ::oPag:aDialogs[3] )

      ::oBrwFin:bClrSel          := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwFin:bClrSelFocus     := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oBrwFin:SetArray( ::aPedidos, , , .F. )

      ::oBrwFin:nMarqueeStyle    := 6
      ::oBrwFin:lFooter          := .T.
      ::oBrwFin:MakeTotals()

      ::oBrwFin:cName            := "Generarpedprvfin"

      ::oBrwFin:CreateFromResource( 100 )

      with object ( ::oBrwFin:AddCol() )
         :cHeader                := "Documento"
         :bEditValue             := {|| AllTrim( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Serie" ) ) + "/" + AllTrim( Str( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Numero" ) ) ) + "/" + AllTrim( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Sufijo" ) ) }
         :nWidth                 := 120
      end

      with object ( ::oBrwFin:AddCol() )
         :cHeader                := "Fecha"
         :bEditValue             := {|| dtoc( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Fecha" ) ) }
         :nWidth                 := 120
      end

      with object ( ::oBrwFin:AddCol() )
         :cHeader                := "Proveedor"
         :bEditValue             := {|| AllTrim( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Proveedor" ) ) + " - " + AllTrim( Rtrim( RetProvee( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Proveedor" ) ) ) ) }
         :nWidth                 := 280
      end

      with object ( ::oBrwFin:AddCol() )
         :cHeader                := "Total"
         :bEditValue             := {|| nTotPedPrv( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Id" ), D():PedidosProveedores( ::nView ), D():PedidosProveedoresLineas( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ) ) }
         :cEditPicture           := cPirDiv()
         :nWidth                 := 80
         :nDataStrAlign          := 1
         :nHeadStrAlign          := 1
         :nFooterType            := 1
      end




      TButton():ReDefine( 110, {||( EdtPedPrv( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Id" ) ) )}, ::oPag:aDialogs[3],,, .F.,,,, .F. )




      TButton():ReDefine( 120, {||( ZooPedPrv( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Id" ) ) )}, ::oPag:aDialogs[3],,, .F.,,,, .F. )




      TButton():ReDefine( 140, {||( VisPedPrv( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Id" ) ) )}, ::oPag:aDialogs[3],,, .F.,,,, .F. )




      TButton():ReDefine( 150, {||( PrnPedPrv( hGet( ::aPedidos[ ::oBrwFin:nArrayAt ], "Id" ) ) )}, ::oPag:aDialogs[3],,, .F.,,,, .F. )




      ::oBtnPrev := TButton():ReDefine( 500, {||( ::Prev() )}, ::oDlg,,, .F.,,,, .F. )




      ::oBtnNext := TButton():ReDefine( 501, {||( ::Next() )}, ::oDlg,,, .F.,,,, .F. )




      ::oBtnCancel := TButton():ReDefine( 2, {||( ::DestroyLines() )}, ::oDlg,,, .F.,,,, .F. )

      ::oDlg:bStart  := {|| ::StartDialog() }

   ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

   if !Empty( ::oBmp )
      ::oBmp:End()
   end

Return ( ::oDlg:nResult == 1 )



static FUNCTION PedCliente2PedProveedor_Prev( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   do case
   case ::oPag:nOption == 2

      ::oPag:GoPrev()

      SetWindowText( ::oBtnNext:hWnd, "Siguien&te >" )

      ::oBtnPrev:Hide()

   case ::oPag:nOption == 3

      ::DestroyLines()

   end

Return ( .T. )



static FUNCTION PedCliente2PedProveedor_Next( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   do case
      case ::oPag:nOption == 1

         if !::lOnlyOrder
            ::LoadLineasPedidos()
         else
            ::LoadLinesaOnlyOrder()
         end

         ::oPag:GoNext()

         ::oBrw:MakeTotals()

         ::oBtnPrev:Show()

         SetWindowText( ::oBtnNext:hWnd, "&Procesar" )

      case ::oPag:nOption == 2

         ::GeneraPedidoProveedor()

         ::TotalPedidoProveedor()

         ::lEstadoGenerado()

         ::oPag:GoNext()

         ::oBtnPrev:Hide()
         ::oBtnNext:Hide()

         SetWindowText( ::oBtnCancel:hWnd, "&Terminar" )

         ::oBrwFin:Refresh()
         ::oBrwFin:MakeTotals()
         ::oBrwFin:RefreshFooters()

      case ::oPag:nOption == 3

         ::DestroyLines()

   end

Return .T.



static FUNCTION PedCliente2PedProveedor_StartDialog( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   ::oBtnPrev:Hide()

   ::oBrw:Load()

   ::oBrwFin:Load()

   ::oBrwRangos:ResizeColumns()

   ::lRecargaFecha()

Return .T.



static FUNCTION PedCliente2PedProveedor_aCreaArrayPeriodos( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local aPeriodo := {}

   aAdd( aPeriodo, "Hoy" )

   aAdd( aPeriodo, "Ayer" )

   aAdd( aPeriodo, "Mes en curso" )

   aAdd( aPeriodo, "Mes anterior" )

   do case
      case Month( GetSysDate() ) <= 3
         aAdd( aPeriodo, "Primer trimestre" )

      case Month( GetSysDate() ) > 3 .AND. Month( GetSysDate() ) <= 6
         aAdd( aPeriodo, "Primer trimestre" )
         aAdd( aPeriodo, "Segundo trimestre" )

      case Month( GetSysDate() ) > 6 .AND. Month( GetSysDate() ) <= 9
         aAdd( aPeriodo, "Primer trimestre" )
         aAdd( aPeriodo, "Segundo trimestre" )
         aAdd( aPeriodo, "Tercer trimestre" )

      case Month( GetSysDate() ) > 9 .AND. Month( GetSysDate() ) <= 12
         aAdd( aPeriodo, "Primer trimestre" )
         aAdd( aPeriodo, "Segundo trimestre" )
         aAdd( aPeriodo, "Tercer trimestre" )
         aAdd( aPeriodo, "Cuatro trimestre" )

   end

   aAdd( aPeriodo, "Doce últimos meses" )

   aAdd( aPeriodo, "Año en curso" )

   aAdd( aPeriodo, "Año anterior" )

   aAdd( aPeriodo, "Todos" )

Return ( aPeriodo )



static FUNCTION PedCliente2PedProveedor_lRecargaFecha( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   do case
      case ::cPeriodo == "Hoy"

         ::oFecIni:cText( GetSysDate() )
         ::oFecFin:cText( GetSysDate() )

      case ::cPeriodo == "Ayer"

         ::oFecIni:cText( GetSysDate() -1 )
         ::oFecFin:cText( GetSysDate() -1 )

      case ::cPeriodo == "Mes en curso"

         ::oFecIni:cText( CtoD( "01/" + Str( Month( GetSysDate() ) ) + "/" + Str( Year( GetSysDate() ) ) ) )
         ::oFecFin:cText( GetSysDate() )

      case ::cPeriodo == "Mes anterior"

         ::oFecIni:cText( BoM( AddMonth( GetSysDate(), -1 ) ) )
         ::oFecFin:cText( EoM( AddMonth( GetSysDate(), -1 ) ) )

      case ::cPeriodo == "Primer trimestre"

         ::oFecIni:cText( CtoD( "01/01/" + Str( Year( GetSysDate() ) ) ) )
         ::oFecFin:cText( CtoD( "31/03/" + Str( Year( GetSysDate() ) ) ) )

      case ::cPeriodo == "Segundo trimestre"

         ::oFecIni:cText( CtoD( "01/04/" + Str( Year( GetSysDate() ) ) ) )
         ::oFecFin:cText( CtoD( "30/06/" + Str( Year( GetSysDate() ) ) ) )

      case ::cPeriodo == "Tercer trimestre"

         ::oFecIni:cText( CtoD( "01/07/" + Str( Year( GetSysDate() ) ) ) )
         ::oFecFin:cText( CtoD( "30/09/" + Str( Year( GetSysDate() ) ) ) )

      case ::cPeriodo == "Cuatro trimestre"

         ::oFecIni:cText( CtoD( "01/10/" + Str( Year( GetSysDate() ) ) ) )
         ::oFecFin:cText( CtoD( "31/12/" + Str( Year( GetSysDate() ) ) ) )

      case ::cPeriodo == "Doce últimos meses"

         ::oFecIni:cText( CtoD( Str( Day( GetSysDate() ) ) + "/" + Str( Month( GetSysDate() ) ) + "/" + Str( Year( GetSysDate() ) -1 ) ) )
         ::oFecFin:cText( GetSysDate() )

      case ::cPeriodo == "Año en curso"

         ::oFecIni:cText( CtoD( "01/01/" + Str( Year( GetSysDate() ) ) ) )
         ::oFecFin:cText( CtoD( "31/12/" + Str( Year( GetSysDate() ) ) ) )

      case ::cPeriodo == "Año anterior"

         ::oFecIni:cText( CtoD( "01/01/" + Str( Year( GetSysDate() ) - 1 ) ) )
         ::oFecFin:cText( CtoD( "31/12/" + Str( Year( GetSysDate() ) - 1 ) ) )

      case ::cPeriodo == "Todos"

         ::oFecIni:cText( CtoD( "01/01/2000" ) )
         ::oFecFin:cText( CtoD( "31/12/3000" ) )

   end

   ::oFecIni:Refresh()
   ::oFecFin:Refresh()

RETURN ( .T. )



static FUNCTION PedCliente2PedProveedor_LoadLineasPedidos( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local cSentencia  := ""
   local cBusqueda   := ""
   local nStock      := 0
   local nReserva    := 0

   ( ::dbfTemporal )->( __dbZap() )

   cSentencia        := "SELECT lineaspedidos.cSerPed, "
   cSentencia        +=        "lineaspedidos.nNumPed, "
   cSentencia        +=        "lineaspedidos.cSufPed, "
   cSentencia        +=        "lineaspedidos.cRef, "
   cSentencia        +=        "lineaspedidos.cDetalle, "
   cSentencia        +=        "lineaspedidos.cCodPr1, "
   cSentencia        +=        "lineaspedidos.cCodPr2, "
   cSentencia        +=        "lineaspedidos.cValPr1, "
   cSentencia        +=        "lineaspedidos.cValPr2, "
   cSentencia        +=        "lineaspedidos.cLote, "
   cSentencia        +=        "lineaspedidos.nIva, "
   cSentencia        +=        "lineaspedidos.nCanPed, "
   cSentencia        +=        "lineaspedidos.nUniCaja, "
   cSentencia        +=        "lineaspedidos.nCosDiv, "
   cSentencia        +=        "lineaspedidos.cAlmLin, "
   cSentencia        +=        "lineaspedidos.cCodPrv, "
   cSentencia        +=        "lineaspedidos.nIva, "
   cSentencia        +=        "lineaspedidos.nReq, "
   cSentencia        +=        "lineaspedidos.cRefPrv, "
   cSentencia        +=        "lineaspedidos.lControl, "
   cSentencia        +=        "cabecerapedidos.cCodCli, "
   cSentencia        +=        "cabecerapedidos.cNomCli, "
   cSentencia        +=        "cabecerapedidos.dFecPed, "
   cSentencia        +=        "articulos.Familia, "
   cSentencia        +=        "articulos.cCodTip, "
   cSentencia        +=        "articulos.cCodCate, "
   cSentencia        +=        "articulos.cCodTemp, "
   cSentencia        +=        "articulos.cCodFab "
   cSentencia        += "FROM " + cPatEmp() + "PedCliL lineaspedidos "
   cSentencia        += "LEFT JOIN " + cPatEmp() + "PedCliT cabecerapedidos on lineaspedidos.cSerPed = cabecerapedidos.cSerPed AND lineaspedidos.nNumPed = cabecerapedidos.nNumPed AND lineaspedidos.cSufped = cabecerapedidos.cSufped "
   cSentencia        += "LEFT JOIN " + cPatEmp() + "Articulo articulos on lineaspedidos.cRef = articulos.codigo "
   cSentencia        += "WHERE lineaspedidos.cRef>='" + Padr( ::oItemGroupArticulo:GetDesde(), 18 ) + "' AND "
   cSentencia        +=       "lineaspedidos.cRef<='" + Padr( ::oItemGroupArticulo:GetHasta(), 18 ) + "' AND "
   cSentencia        +=       "lineaspedidos.cRef<>'' AND "
   cSentencia        +=       "lineaspedidos.nUniCaja<>0 AND "
   cSentencia        +=       "NOT( lineaspedidos.lControl ) AND "
   cSentencia        +=       "cabecerapedidos.dFecPed >='" + dToc( ::dFecIni ) + "' AND "
   cSentencia        +=       "cabecerapedidos.dFecPed <='" + dToc( ::dFecFin ) + "' AND "
   cSentencia        +=       "NOT(cabecerapedidos.lCancel) AND "
   cSentencia        +=       "articulos.Familia >='" + Padr( ::oItemGroupFamilia:GetDesde(), 16 ) + "' AND "
   cSentencia        +=       "articulos.Familia <='" + Padr( ::oItemGroupFamilia:GetHasta(), 16 ) + "' AND "
   cSentencia        +=       "articulos.cCodTip >='" + ::oItemGroupTipoArticulo:GetDesde() + "' AND "
   cSentencia        +=       "articulos.cCodTip <='" + ::oItemGroupTipoArticulo:GetHasta() + "' AND "
   cSentencia        +=       "articulos.cCodCate >='" + Padr( ::oItemGroupCategoria:GetDesde(), 3 ) + "' AND "
   cSentencia        +=       "articulos.cCodCate <='" + Padr( ::oItemGroupCategoria:GetHasta(), 3 ) + "' AND "
   cSentencia        +=       "articulos.cCodTemp >='" + Padr( ::oItemGroupTemporada:GetDesde(), 5 ) + "' AND "
   cSentencia        +=       "articulos.cCodTemp <='" + Padr( ::oItemGroupTemporada:GetHasta(), 5 ) + "' AND "
   cSentencia        +=       "articulos.cCodFab >='" + Padr( ::oItemGroupFabricante:GetDesde(), 3 ) + "' AND "
   cSentencia        +=       "articulos.cCodFab <='" + Padr( ::oItemGroupFabricante:GetHasta(), 3 ) + "' "
   cSentencia        += "ORDER BY lineaspedidos.cRef"

   if TDataCenter():ExecuteSqlStatement( cSentencia, "SelectLineasPedidos" )

      ::oMtr:SetTotal( ( "SelectLineasPedidos" )->( OrdKeyCount() ) )

      ( "SelectLineasPedidos" )->( dbGoTop() )
      while !( "SelectLineasPedidos" )->( Eof() )

         nStock                        := StocksModel():nStockArticulo( ( "SelectLineasPedidos" )->cRef )
         nReserva                      := nTotReserva( ( "SelectLineasPedidos" )->cRef )

         ::AddLineasPedidos( nStock, nReserva )

         ( "SelectLineasPedidos" )->( dbSkip() )

          ::oMtr:AutoInc()

      end

      ::oMtr:AutoInc( ( "SelectLineasPedidos" )->( LastRec() ) )

   end

   ( ::dbfTemporal )->( dbGoTop() )

   if !Empty( ::oBrw )
      ::oBrw:Refresh()
   end

Return .T.



static FUNCTION PedCliente2PedProveedor_AddLineasPedidos( nStock, nReserva ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local cBusqueda   := ""

   cBusqueda         := ( "SelectLineasPedidos" )->cRef
   cBusqueda         += ( "SelectLineasPedidos" )->cCodPr1
   cBusqueda         += ( "SelectLineasPedidos" )->cCodPr2
   cBusqueda         += ( "SelectLineasPedidos" )->cValPr1
   cBusqueda         += ( "SelectLineasPedidos" )->cValPr2
   cBusqueda         += ( "SelectLineasPedidos" )->cLote

   if ( ::dbfTemporal )->( dbSeek( cBusqueda ) )

      if dbLock( ::dbfTemporal )
         ( ::dbfTemporal )->nNumCaj    += ( "SelectLineasPedidos" )->nCanPed
         ( ::dbfTemporal )->nNumUni    += ( "SelectLineasPedidos" )->nUniCaja
         ( ::dbfTemporal )->( dbUnlock() )
      end

   else

      if dbAppe( ::dbfTemporal )
         ( ::dbfTemporal )->cRef       := ( "SelectLineasPedidos" )->cRef
         ( ::dbfTemporal )->cDetalle   := ( "SelectLineasPedidos" )->cDetalle
         ( ::dbfTemporal )->lSelArt    := .T.
         ( ::dbfTemporal )->cCodPrv    := ::getCodigoProveerdor( )
         ( ::dbfTemporal )->cCodPr1    := ( "SelectLineasPedidos" )->cCodPr1
         ( ::dbfTemporal )->cCodPr2    := ( "SelectLineasPedidos" )->cCodPr2
         ( ::dbfTemporal )->cValPr1    := ( "SelectLineasPedidos" )->cValPr1
         ( ::dbfTemporal )->cValPr2    := ( "SelectLineasPedidos" )->cValPr2
         ( ::dbfTemporal )->nNumUni    := ( "SelectLineasPedidos" )->nUniCaja
         ( ::dbfTemporal )->nNumCaj    := ( "SelectLineasPedidos" )->nCanPed
         ( ::dbfTemporal )->nStkFis    := nStock
         ( ::dbfTemporal )->nStkDis    := nStock - nReserva
         ( ::dbfTemporal )->nIva       := ( "SelectLineasPedidos" )->nIva
         ( ::dbfTemporal )->nReq       := ( "SelectLineasPedidos" )->nReq
         ( ::dbfTemporal )->nPreDiv    := ( "SelectLineasPedidos" )->nCosDiv
         ( ::dbfTemporal )->cLote      := ( "SelectLineasPedidos" )->cLote
         ( ::dbfTemporal )->cRefPrv    := ( "SelectLineasPedidos" )->cRefPrv
         ( ::dbfTemporal )->( dbUnlock() )
      end

   end

Return .T.



static FUNCTION PedCliente2PedProveedor_LoadLinesaOnlyOrder ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local cSentencia  := ""
   local cBusqueda   := ""
   local nStock      := 0
   local nReserva    := 0

   ( ::dbfTemporal )->( __dbZap() )

   cSentencia        := "SELECT lineaspedidos.cSerPed, "
   cSentencia        +=        "lineaspedidos.nNumPed, "
   cSentencia        +=        "lineaspedidos.cSufPed, "
   cSentencia        +=        "lineaspedidos.cRef, "
   cSentencia        +=        "lineaspedidos.cDetalle, "
   cSentencia        +=        "lineaspedidos.cCodPr1, "
   cSentencia        +=        "lineaspedidos.cCodPr2, "
   cSentencia        +=        "lineaspedidos.cValPr1, "
   cSentencia        +=        "lineaspedidos.cValPr2, "
   cSentencia        +=        "lineaspedidos.cLote, "
   cSentencia        +=        "lineaspedidos.nIva, "
   cSentencia        +=        "lineaspedidos.nCanPed, "
   cSentencia        +=        "lineaspedidos.nUniCaja, "
   cSentencia        +=        "lineaspedidos.nCosDiv, "
   cSentencia        +=        "lineaspedidos.cAlmLin, "
   cSentencia        +=        "lineaspedidos.cCodPrv, "
   cSentencia        +=        "lineaspedidos.nIva, "
   cSentencia        +=        "lineaspedidos.nReq, "
   cSentencia        +=        "lineaspedidos.cRefPrv, "
   cSentencia        +=        "lineaspedidos.lControl, "
   cSentencia        +=        "cabecerapedidos.cCodCli, "
   cSentencia        +=        "cabecerapedidos.cNomCli, "
   cSentencia        +=        "cabecerapedidos.dFecPed, "
   cSentencia        +=        "articulos.Familia, "
   cSentencia        +=        "articulos.cCodTip, "
   cSentencia        +=        "articulos.cCodCate, "
   cSentencia        +=        "articulos.cCodTemp, "
   cSentencia        +=        "articulos.cCodFab "
   cSentencia        += "FROM " + cPatEmp() + "PedCliL lineaspedidos "
   cSentencia        += "LEFT JOIN " + cPatEmp() + "PedCliT cabecerapedidos on lineaspedidos.cSerPed = cabecerapedidos.cSerPed AND lineaspedidos.nNumPed = cabecerapedidos.nNumPed AND lineaspedidos.cSufped = cabecerapedidos.cSufped "
   cSentencia        += "LEFT JOIN " + cPatEmp() + "Articulo articulos on lineaspedidos.cRef = articulos.codigo "
   cSentencia        += "WHERE lineaspedidos.cSerPed='" + ::cSerieOrder + "' AND "
   cSentencia        +=       "lineaspedidos.nNumPed=" + AllTrim( Str( ::nNumeroOrder ) ) + " AND "
   cSentencia        +=       "lineaspedidos.cSufPed='" + ::cSufijoOrder + "' AND "
   cSentencia        +=       "lineaspedidos.cRef>='" + Padr( ::oItemGroupArticulo:GetDesde(), 18 ) + "' AND "
   cSentencia        +=       "lineaspedidos.cRef<='" + Padr( ::oItemGroupArticulo:GetHasta(), 18 ) + "' AND "
   cSentencia        +=       "lineaspedidos.cRef<>'' AND "
   cSentencia        +=       "lineaspedidos.nUniCaja<>0 AND "
   cSentencia        +=       "NOT( lineaspedidos.lControl ) AND "
   cSentencia        +=       "cabecerapedidos.dFecPed >='" + dToc( ::dFecIni ) + "' AND "
   cSentencia        +=       "cabecerapedidos.dFecPed <='" + dToc( ::dFecFin ) + "' AND "
   cSentencia        +=       "NOT(cabecerapedidos.lCancel) AND "
   cSentencia        +=       "articulos.Familia >='" + Padr( ::oItemGroupFamilia:GetDesde(), 16 ) + "' AND "
   cSentencia        +=       "articulos.Familia <='" + Padr( ::oItemGroupFamilia:GetHasta(), 16 ) + "' AND "
   cSentencia        +=       "articulos.cCodTip >='" + ::oItemGroupTipoArticulo:GetDesde() + "' AND "
   cSentencia        +=       "articulos.cCodTip <='" + ::oItemGroupTipoArticulo:GetHasta() + "' AND "
   cSentencia        +=       "articulos.cCodCate >='" + Padr( ::oItemGroupCategoria:GetDesde(), 3 ) + "' AND "
   cSentencia        +=       "articulos.cCodCate <='" + Padr( ::oItemGroupCategoria:GetHasta(), 3 ) + "' AND "
   cSentencia        +=       "articulos.cCodTemp >='" + Padr( ::oItemGroupTemporada:GetDesde(), 5 ) + "' AND "
   cSentencia        +=       "articulos.cCodTemp <='" + Padr( ::oItemGroupTemporada:GetHasta(), 5 ) + "' AND "
   cSentencia        +=       "articulos.cCodFab >='" + Padr( ::oItemGroupFabricante:GetDesde(), 3 ) + "' AND "
   cSentencia        +=       "articulos.cCodFab <='" + Padr( ::oItemGroupFabricante:GetHasta(), 3 ) + "' "
   cSentencia        += "ORDER BY lineaspedidos.cRef"

   if TDataCenter():ExecuteSqlStatement( cSentencia, "SelectLineasPedidos" )

      ::oMtr:SetTotal( ( "SelectLineasPedidos" )->( OrdKeyCount() ) )

      ( "SelectLineasPedidos" )->( dbGoTop() )
      while !( "SelectLineasPedidos" )->( Eof() )

         nStock                        := StocksModel():nStockArticulo( ( "SelectLineasPedidos" )->cRef )
         nReserva                      := nTotReserva( ( "SelectLineasPedidos" )->cRef )

         if dbAppe( ::dbfTemporal )
            ( ::dbfTemporal )->cRef       := ( "SelectLineasPedidos" )->cRef
            ( ::dbfTemporal )->cDetalle   := ( "SelectLineasPedidos" )->cDetalle
            ( ::dbfTemporal )->lSelArt    := .T.
            ( ::dbfTemporal )->cCodPrv    := ::getCodigoProveerdor( )
            ( ::dbfTemporal )->cCodPr1    := ( "SelectLineasPedidos" )->cCodPr1
            ( ::dbfTemporal )->cCodPr2    := ( "SelectLineasPedidos" )->cCodPr2
            ( ::dbfTemporal )->cValPr1    := ( "SelectLineasPedidos" )->cValPr1
            ( ::dbfTemporal )->cValPr2    := ( "SelectLineasPedidos" )->cValPr2
            ( ::dbfTemporal )->nNumUni    := ( "SelectLineasPedidos" )->nUniCaja
            ( ::dbfTemporal )->nNumCaj    := ( "SelectLineasPedidos" )->nCanPed
            ( ::dbfTemporal )->nStkFis    := nStock
            ( ::dbfTemporal )->nStkDis    := nStock - nReserva
            ( ::dbfTemporal )->nIva       := ( "SelectLineasPedidos" )->nIva
            ( ::dbfTemporal )->nReq       := ( "SelectLineasPedidos" )->nReq
            ( ::dbfTemporal )->nPreDiv    := ( "SelectLineasPedidos" )->nCosDiv
            ( ::dbfTemporal )->cLote      := ( "SelectLineasPedidos" )->cLote
            ( ::dbfTemporal )->cRefPrv    := ( "SelectLineasPedidos" )->cRefPrv
            ( ::dbfTemporal )->( dbUnlock() )
         end

         ( "SelectLineasPedidos" )->( dbSkip() )

          ::oMtr:AutoInc()

      end

      ::oMtr:AutoInc( ( "SelectLineasPedidos" )->( LastRec() ) )

   end

   ( ::dbfTemporal )->( dbGoTop() )

   if !Empty( ::oBrw )
      ::oBrw:Refresh()
   end

Return .T.



static FUNCTION PedCliente2PedProveedor_SelectArticulo( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   if dbDialogLock( ::dbfTemporal )
      ( ::dbfTemporal )->lSelArt := !( ::dbfTemporal )->lSelArt
      ( ::dbfTemporal )->( dbUnlock() )
   end

   if !Empty( ::oBrw )
      ::oBrw:Refresh()
   end

return .T.



static FUNCTION PedCliente2PedProveedor_SelectAllArticulo( lSel ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local nRec  := ( ::dbfTemporal )->( Recno() )

   ( ::dbfTemporal )->( dbGoTop() )
   while !( ::dbfTemporal )->( eof() )

      if dbDialogLock( ::dbfTemporal )
         ( ::dbfTemporal )->lSelArt := lSel
         ( ::dbfTemporal )->( dbUnlock() )
      end

      ( ::dbfTemporal )->( dbSkip() )

   end

   ( ::dbfTemporal )->( dbGoTo( nRec ) )

   if !Empty( ::oBrw )
      ::oBrw:Refresh()
   end

return .T.



static FUNCTION PedCliente2PedProveedor_ChangeUnidades( oCol, uNewValue, nKey ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   if IsNum( nKey ) .AND. ( nKey <> 27 ) .AND. !IsNil( uNewValue )

      if dbDialogLock( ::dbfTemporal )
         ( ::dbfTemporal )->nNumUni := uNewValue
         ( ::dbfTemporal )->( dbUnlock() )
      end

   end

Return .T.



static FUNCTION PedCliente2PedProveedor_ChangeCajas( oCol, uNewValue, nKey ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   if IsNum( nKey ) .AND. ( nKey <> 27 ) .AND. !IsNil( uNewValue )

      if dbDialogLock( ::dbfTemporal )
         ( ::dbfTemporal )->nNumCaj := uNewValue
         ( ::dbfTemporal )->( dbUnlock() )
      end

   end

Return .T.



static FUNCTION PedCliente2PedProveedor_ChangeProveedor( x ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   if dbDialogLock( ::dbfTemporal )
      ( ::dbfTemporal )->cCodPrv := x
      ( ::dbfTemporal )->( dbUnlock() )
   end

Return .T.



static FUNCTION PedCliente2PedProveedor_GeneraPedidoProveedor( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local cSeriePedido
   local nNumeroPedido
   local cSufijoPedido
   local nNumeroLinea
   local cLastProveedor := ""

   ( ::dbfTemporal )->( OrdSetFocus( "cCodPrv" ) )
   ( ::dbfTemporal )->( dbGoTop() )

   while !( ::dbfTemporal )->( eof() )

      if !Empty( ( ::dbfTemporal )->cCodPrv )



         if cLastProveedor <> ( ::dbfTemporal )->cCodPrv

            cSeriePedido               := cNewSer( "nPedPrv", D():Contadores( ::nView ) )
            nNumeroPedido              := nNewDoc( cSeriePedido, D():PedidosProveedores( ::nView ), "nPedPrv", , D():Contadores( ::nView ) )
            cSufijoPedido              := RetSufEmp()
            cLastProveedor             := ( ::dbfTemporal )->cCodPrv
            nNumeroLinea               := 0

            ( D():PedidosProveedores( ::nView ) )->( dbAppend() )
            ( D():PedidosProveedores( ::nView ) )->cSerPed    := cSeriePedido
            ( D():PedidosProveedores( ::nView ) )->nNumPed    := nNumeroPedido
            ( D():PedidosProveedores( ::nView ) )->cSufPed    := cSufijoPedido
            ( D():PedidosProveedores( ::nView ) )->cTurPed    := cCurSesion()
            ( D():PedidosProveedores( ::nView ) )->dFecPed    := GetSysDate()
            ( D():PedidosProveedores( ::nView ) )->cCodPrv    := ( ::dbfTemporal )->cCodPrv
            ( D():PedidosProveedores( ::nView ) )->cCodAlm    := Application():codigoAlmacen()
            ( D():PedidosProveedores( ::nView ) )->cCodCaj    := Application():CodigoCaja()
            ( D():PedidosProveedores( ::nView ) )->nEstado    := 1
            ( D():PedidosProveedores( ::nView ) )->cDivPed    := cDivEmp()
            ( D():PedidosProveedores( ::nView ) )->lSndDoc    := .T.
            ( D():PedidosProveedores( ::nView ) )->cCodUsr    := Auth():Codigo()
            ( D():PedidosProveedores( ::nView ) )->cNumPedCli := ::cSerieOrder + Str( ::nNumeroOrder ) + ::cSufijoOrder

            if ( D():Proveedores( ::nView ) )->( dbSeek( ( ::dbfTemporal )->cCodPrv ) )
               ( D():PedidosProveedores( ::nView ) )->cNomPrv    := ( D():Proveedores( ::nView ) )->Titulo
               ( D():PedidosProveedores( ::nView ) )->cDirPrv    := ( D():Proveedores( ::nView ) )->Domicilio
               ( D():PedidosProveedores( ::nView ) )->cPobPrv    := ( D():Proveedores( ::nView ) )->Poblacion
               ( D():PedidosProveedores( ::nView ) )->cProPrv    := ( D():Proveedores( ::nView ) )->Provincia
               ( D():PedidosProveedores( ::nView ) )->cPosPrv    := ( D():Proveedores( ::nView ) )->cCodPai
               ( D():PedidosProveedores( ::nView ) )->cDniPrv    := ( D():Proveedores( ::nView ) )->Nif
               ( D():PedidosProveedores( ::nView ) )->dFecEnt    := GetSysDate() + ( D():Proveedores( ::nView ) )->nPlzEnt
               ( D():PedidosProveedores( ::nView ) )->lRecargo   := ( D():Proveedores( ::nView ) )->lReq
            end

            ( D():PedidosProveedores( ::nView ) )->( dbUnLock() )






            aAdd( ::aPedidos, {  "Serie" => cSeriePedido, "Numero" => nNumeroPedido, "Sufijo" => cSufijoPedido, "Id" => cSeriePedido + str( nNumeroPedido ) + cSufijoPedido, "Fecha" => GetSysDate(), "Proveedor" => cLastProveedor } )

         end





         ( D():PedidosProveedoresLineas( ::nView ) )->( dbAppend() )

         ( D():PedidosProveedoresLineas( ::nView ) )->cSerPed          := cSeriePedido
         ( D():PedidosProveedoresLineas( ::nView ) )->nNumPed          := nNumeroPedido
         ( D():PedidosProveedoresLineas( ::nView ) )->cSufPed          := cSufijoPedido
         ( D():PedidosProveedoresLineas( ::nView ) )->nNumLin          := ++nNumeroLinea
         ( D():PedidosProveedoresLineas( ::nView ) )->cAlmLin          := Application():codigoAlmacen()
         ( D():PedidosProveedoresLineas( ::nView ) )->cRef             := ( ::dbfTemporal )->cRef
         ( D():PedidosProveedoresLineas( ::nView ) )->cDetalle         := ( ::dbfTemporal )->cDetalle
         ( D():PedidosProveedoresLineas( ::nView ) )->mLngDes          := ( ::dbfTemporal )->mLngDes
         ( D():PedidosProveedoresLineas( ::nView ) )->nIva             := ( ::dbfTemporal )->nIva
         ( D():PedidosProveedoresLineas( ::nView ) )->nReq             := ( ::dbfTemporal )->nReq
         ( D():PedidosProveedoresLineas( ::nView ) )->nCanPed          := ( ::dbfTemporal )->nNumCaj
         ( D():PedidosProveedoresLineas( ::nView ) )->nPreDiv          := ( ::dbfTemporal )->nPreDiv
         ( D():PedidosProveedoresLineas( ::nView ) )->cUniDad          := ( ::dbfTemporal )->cUniDad
         ( D():PedidosProveedoresLineas( ::nView ) )->nDtoLin          := ( ::dbfTemporal )->nDto
         ( D():PedidosProveedoresLineas( ::nView ) )->nDtoPrm          := ( ::dbfTemporal )->nDtoPrm
         ( D():PedidosProveedoresLineas( ::nView ) )->cCodPr1          := ( ::dbfTemporal )->cCodPr1
         ( D():PedidosProveedoresLineas( ::nView ) )->cCodPr2          := ( ::dbfTemporal )->cCodPr2
         ( D():PedidosProveedoresLineas( ::nView ) )->cValPr1          := ( ::dbfTemporal )->cValPr1
         ( D():PedidosProveedoresLineas( ::nView ) )->cValPr2          := ( ::dbfTemporal )->cValPr2
         ( D():PedidosProveedoresLineas( ::nView ) )->lLote            := ( ::dbfTemporal )->lLote
         ( D():PedidosProveedoresLineas( ::nView ) )->nLote            := ( ::dbfTemporal )->nLote
         ( D():PedidosProveedoresLineas( ::nView ) )->cLote            := ( ::dbfTemporal )->cLote
         ( D():PedidosProveedoresLineas( ::nView ) )->mObsLin          := ( ::dbfTemporal )->mObsLin
         ( D():PedidosProveedoresLineas( ::nView ) )->cRefPrv          := ( ::dbfTemporal )->cRefPrv
         ( D():PedidosProveedoresLineas( ::nView ) )->nMedUno          := ( ::dbfTemporal )->nMedUno
         ( D():PedidosProveedoresLineas( ::nView ) )->nMedDos          := ( ::dbfTemporal )->nMedDos
         ( D():PedidosProveedoresLineas( ::nView ) )->nMedTre          := ( ::dbfTemporal )->nMedTre
         ( D():PedidosProveedoresLineas( ::nView ) )->cUnidad          := ( ::dbfTemporal )->cUnidad

         if ::lOnlyOrder
            ( D():PedidosProveedoresLineas( ::nView ) )->cPedCli       := ::cSerieOrder + Str( ::nNumeroOrder ) + ::cSufijoOrder
         end

         do case
            case ::nStockFin == 1

               ( D():PedidosProveedoresLineas( ::nView ) )->nUniCaja   := ::Calculaunidades( ( ::dbfTemporal  )->nNumUni, ( ::dbfTemporal  )->nStkDis, RetFld( ( ::dbfTemporal  )->cRef, D():Articulos( ::nView ), "nMinimo" ) )

            case ::nStockFin == 2

               ( D():PedidosProveedoresLineas( ::nView ) )->nUniCaja   := ::Calculaunidades( ( ::dbfTemporal  )->nNumUni, ( ::dbfTemporal  )->nStkDis, RetFld( ( ::dbfTemporal  )->cRef, D():Articulos( ::nView ), "nMaximo" ) )

            case ::nStockFin == 3

               ( D():PedidosProveedoresLineas( ::nView ) )->nUniCaja   := ( ::dbfTemporal  )->nNumUni

         end

         ( D():PedidosProveedoresLineas( ::nView ) )->( dbRUnLock() )

      end

      ( ::dbfTemporal )->( dbSkip() )

   end

Return .T.



static FUNCTION PedCliente2PedProveedor_TotalPedidoProveedor( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local hPedido
   local aPedido

   for each hPedido in ::aPedidos

      if D():gotoIdPedidosProveedores( hPedido[ "Id" ], ::nView )

         aPedido  := aTotPedPrv( hPedido[ "Id" ], D():PedidosProveedores( ::nView ), D():PedidosProveedoresLineas( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ), D():FormasPago( ::nView ), ( D():PedidosProveedores( ::nView ) )->cDivPed )

         if dbLock( D():PedidosProveedores( ::nView ) )
            ( D():PedidosProveedores( ::nView ) )->nTotNet := aPedido[ 1 ]
            ( D():PedidosProveedores( ::nView ) )->nTotIva := aPedido[ 2 ]
            ( D():PedidosProveedores( ::nView ) )->nTotReq := aPedido[ 3 ]
            ( D():PedidosProveedores( ::nView ) )->nTotPed := aPedido[ 4 ]
            ( D():PedidosProveedores( ::nView ) )->( dbUnLock() )
         end

      end

   next

Return .T.



static FUNCTION PedCliente2PedProveedor_Calculaunidades( nCantidad, nStockDis, nStockMinMax ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local nUnidades

   do case
      case nStockDis < 0
         nUnidades   := ( 0 - nStockDis ) + nCantidad + nStockMinMax
      case nStockDis == 0
         nUnidades   := nCantidad + nStockMinMax
      case nStockDis > 0
         nUnidades   := ( nCantidad - nStockDis ) + nStockMinMax
   end

   if nUnidades < 0
      nUnidades      := 0
   end

return nUnidades



static FUNCTION PedCliente2PedProveedor_getCodigoProveerdor( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local cCodigoProveedor  := ( "SelectLineasPedidos" )->cCodPrv

   if empty( cCodigoProveedor )
      cCodigoProveedor     := cProveedorDefecto( ( "SelectLineasPedidos" )->cRef, D():ProveedorArticulo( ::nView ) )
   end

Return ( cCodigoProveedor )



static FUNCTION PedCliente2PedProveedor_lEstadoGenerado( ) ; local Self AS CLASS PedCliente2PedProveedor := QSelf() AS CLASS PedCliente2PedProveedor

   local hPedido

   if !::lOnlyOrder
      Return .F.
   end

   ::oStock:SetGeneradoPedCli( ::cSerieOrder + Str( ::nNumeroOrder ) + ::cSufijoOrder )

Return ( .T. )
