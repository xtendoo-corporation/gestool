#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 198 ".\.\Prg\Precli.prg"
memvar cDbf
memvar cDbfCol
memvar cDetalle
memvar cCliente
memvar cDbfCli
memvar cDbfObr
memvar cDbfAge
memvar cAgente
memvar cDbfPgo
memvar cFPago
memvar cDbfIva
memvar cDbfUsr
memvar cIva
memvar cTarPreL
memvar cTarPreS
memvar cPromoL
memvar cDbfPromol
memvar cDbfRut
memvar cDbfTrn
memvar cDbfPro
memvar cDbfTblPro
memvar aTotIva
memvar aTotIvm
memvar cCtaCli
memvar nTotBrt
memvar nTotIva
memvar nTotReq
memvar nTotImp
memvar nTotPre
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotNet
memvar nTotPnt
memvar nTotCos
memvar nTotIvm
memvar nTotPes
memvar nTotAge
memvar nTotTrn
memvar nTotRnt
memvar nTotDif
memvar nTotAtp
memvar nPctRnt
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aIvmUno
memvar aIvmDos
memvar aIvmTre
memvar nTotUnd
memvar nTotPage
memvar aImpVto
memvar aDatVto
memvar cPicUndPre
memvar nVdvDivPre
memvar cPouDivPre
memvar cPorDivPre
memvar cPouChgPre
memvar nDouDivPre
memvar nRouDivPre
memvar nTotArt
memvar nTotCaj
memvar nPagina
memvar lEnd
memvar nTotalDto

memvar nNumArt
memvar nNumCaj

memvar oReport

static oWndBrw

static nView

static oBrwIva
static dbfUsr
static dbfRuta
static dbfPreCliT
static dbfPreCliI
static dbfPreCliD
static dbfClient
static dbfCliInc
static dbfArtPrv
static dbfDiv
static dbfCajT
static oBandera
static oNewImp
static dbfCodebar
static dbfTarPreL
static dbfTarPreS
static dbfPromoT
static dbfPromoL
static dbfPromoC
static dbfIva
static dbfTmpLin
static dbfTmpInc
static dbfTmpEst
static dbfTmpDoc
static dbfKit
static dbfFPago
static dbfObrasT
static dbfAlm
static dbfAgent
static dbfFamilia
static dbfProvee
static dbfOferta
static dbfTblPro
static dbfPro

static oImpuestos
static lImpuestos

static dbfArtDiv
static dbfDelega
static dbfAgeCom
static dbfCount
static dbfEmp
static dbfPedPrvL
static dbfAlbPrvL
static dbfFacPrvL
static dbfRctPrvL
static dbfPedCliL
static dbfAlbCliL
static dbfFacCliL
static dbfFacRecL
static dbfTikCliL
static dbfAlbCliT
static dbfFacCliP
static dbfAntCliT
static dbfTikCliT
static dbfProLin
static dbfProMat
static cTmpLin
static cTmpInc
static cTmpDoc
static cTmpEst
static oGetNet
static oGetTrn
static oGetIva
static oGetReq
static oGetAge
static oGetIvm
static oGetPnt
static oGetRnt
static oGetPes
static oGetDif
static oGetTotal
static oGetTarifa
static oFont
static oMenu
static cPouDiv
static cPorDiv
static cPicUnd
static nDouDiv
static nRouDiv
static cPpvDiv
static nDpvDiv
static nVdvDiv
static oStock
static oTipArt
static oGrpFam
static oFraPub
static bEdtRec          := { | aTmp, aGet, dbfPreCliT, oBrw, bWhen, bValid, nMode | EdtRec( aTmp, aGet, dbfPreCliT, oBrw, bWhen, bValid, nMode ) }
static bEdtDet          := { | aTmp, aGet, dbfPreCliL, oBrw, bWhen, bValid, nMode, aTmpPre | EdtDet( aTmp, aGet, dbfPreCliL, oBrw, bWhen, bValid, nMode, aTmpPre ) }
static bEdtInc          := { | aTmp, aGet, dbfPreCliL, oBrw, bWhen, bValid, nMode, aTmpPre | EdtInc( aTmp, aGet, dbfPreCliI, oBrw, bWhen, bValid, nMode, aTmpPre ) }
static bEdtDoc          := { | aTmp, aGet, dbfPreCliD, oBrw, bWhen, bValid, nMode, aTmpPre | EdtDoc( aTmp, aGet, dbfPreCliD, oBrw, bWhen, bValid, nMode, aTmpPre ) }
static bEdtEst          := { | aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpPre | EdtEst( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpPre ) }
static cOldCodCli       := ""
static cOldCodArt       := ""
static cOldPrpArt       := ""
static cOldLotArt       := ""
static cOldUndMed       := ""
static cOldSituacion    := ""
static lOpenFiles       := .F.
static lExternal        := .F.
static aTipPre          := { "Venta", "Alquiler" }
static oTipPre
static oUndMedicion
static cFiltroUsuario   := ""

static nTarifaPrecio    := 0
static oBtnPrecio

static oComisionLinea
static nComisionLinea   := 0

static oMailing

static oDetCamposExtra

static oBrwProperties

static oTipoCtrCoste
static cTipoCtrCoste
static aTipoCtrCoste       := { "Centro de coste", "Proveedor", "Agente", "Cliente" }
static oCentroCoste

static Counter
static oTrans

static oGetCelda
static cGetCelda





FUNCTION GenPreCli( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oInf
   local oDevice
   local nNumPre

   if ( D():PresupuestosClientes( nView ) )->( Lastrec() ) == 0
      return nil
   end

   nNumPre              := ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre

   If( nDevice == nil, nDevice := 1, ) ;
   If( cCaption == nil, cCaption := "Imprimiendo presupuesto", ) ;
   If( cCodDoc == nil, cCodDoc := cFormatoPresupuestosClientes(), ) ;

   if !lExisteDocumento( cCodDoc, D():Documentos( nView ) )
      return nil
   end



   if Empty( nCopies )
      nCopies           := retfld( ( D():PresupuestosClientes( nView ) )->cCodCli, D():Get( "Client", nView ), "CopiasF" )
   end

   if nCopies == 0
      nCopies           := nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", D():Get( "NCount", nView ) )
   end

   if nCopies == 0
      nCopies           := 1
   end





   if lVisualDocumento( cCodDoc, D():Documentos( nView ) )
      printReportPreCli( nDevice, nCopies, cPrinter, cCodDoc )
   else
      msgStop( "El formato ya no es soportado" )
   end

   lChgImpDoc( D():PresupuestosClientes( nView ) )

RETURN NIL



Static Function PreCliReportSkipper( dbf, dbfPreCliL )

   ( dbfPreCliL )->( dbSkip() )

   nTotPage              += nTotLPreCli( dbfPreCliL )

Return nil



Static Function ePage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
    private lEnd            := oInf:lFinish

   PrintItems( cCodDoc, oInf )

Return nil



STATIC FUNCTION OpenFiles( lExt )

   local oError
   local oBlock

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de presupuestos de clientes" )
      Return ( .F. )
   end

   If( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      DisableAcceso()

      lOpenFiles        := .T.

      nView             := D():CreateView()





      D():Atipicas( nView )

      D():Get( "CliInc", nView )

      D():PresupuestosClientes( nView )

      D():PresupuestosClientesLineas( nView )

      D():Clientes( nView )

      D():objectGruposClientes( nView )

      D():ArticuloStockAlmacenes( nView )

      D():Articulos( nView )

      D():Documentos( nView )
      ( D():Documentos( nView ) )->( ordSetFocus( "cTipo" ) )

      D():ArticuloLenguaje( nView )

      D():GetObject( "UnidadMedicion", nView )

      D():ImpuestosEspeciales( nView )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLII.DBF" ), ( cCheckArea( "PRECLII", @dbfPreCliI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLID.DBF" ), ( cCheckArea( "PRECLID", @dbfPreCliD ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliD.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROVART.DBF" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGENTES.DBF" ), ( cCheckArea( "AGENTES", @dbfAgent ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGENTES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TARPREL.DBF" ), ( cCheckArea( "TARPREL", @dbfTarPreL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TARPREL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TARPRES.DBF" ), ( cCheckArea( "TARPRES", @dbfTarPreS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TARPRES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOT.DBF" ), ( cCheckArea( "PROMOT", @dbfPromoT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOL.DBF" ), ( cCheckArea( "PROMOL", @dbfPromoL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOC.DBF" ), ( cCheckArea( "PROMOC", @dbfPromoC ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOC.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "OFERTA.DBF" ), ( cCheckArea( "OFERTA", @dbfOferta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "OFERTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfTblPro ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAS", @dbfObrasT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RUTA.DBF" ), ( cCheckArea( "RUTA", @dbfRuta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RUTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTDIV.DBF" ), ( cCheckArea( "ARTDIV", @dbfArtDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "Almacen.Dbf" ), ( cCheckArea( "ALMACEN", @dbfAlm ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "Almacen.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DELEGA.DBF" ), ( cCheckArea( "DELEGA", @dbfDelega ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DELEGA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGECOM.DBF" ), ( cCheckArea( "AGECOM", @dbfAgeCom ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGECOM.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "NCOUNT.DBF" ), ( cCheckArea( "NCOUNT", @dbfCount ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "NCOUNT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "EMPRESA.DBF" ), ( cCheckArea( "EMPRESA", @dbfEmp ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "EMPRESA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PedProvL.DBF" ), ( cCheckArea( "PedProvL", @dbfPedPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PedProvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVL.DBF" ), ( cCheckArea( "ALBPROVL", @dbfAlbPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PedCliL.DBF" ), ( cCheckArea( "PedCliL", @dbfPedCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PedCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIL.DBF" ), ( cCheckArea( "FACCLIL", @dbfFacCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @dbfFacRecL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @dbfTikCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CSTKFAST" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROLIN.DBF" ), ( cCheckArea( "PROLIN", @dbfProLin ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROLIN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMAT.DBF" ), ( cCheckArea( "PROMAT", @dbfProMat ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.Dbf" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "Provee.Dbf" ), ( cCheckArea( "Provee", @dbfProvee ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "Provee.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      if !TDataCenter():OpenAlbCliT( @dbfAlbCliT )
         lOpenFiles     := .F.
      end

      if !TDataCenter():OpenFacCliP( @dbfFacCliP )
         lOpenFiles     := .F.
      end

      oBandera          := TBandera():New()

      oStock            := TStock():Create( cPatEmp() )
      if !oStock:lOpenFiles()
         lOpenFiles     := .F.
      end

      oNewImp           := TNewImp():New( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

      oTrans            := TTrans():New( cPatEmp() )
      if !oTrans:OpenFiles()
         lOpenFiles     := .F.
      end

      oTipArt           := TTipArt():Create( cPatEmp() )
      if !oTipArt:OpenFiles()
         lOpenFiles     := .F.
      end

      oGrpFam           := TGrpFam():Create( cPatEmp() )
      if !oGrpFam:OpenFiles()
         lOpenFiles     := .F.
      end

      oFraPub           := TFrasesPublicitarias():Create( cPatEmp() )
      if !oFraPub:OpenFiles()
         lOpenFiles     := .F.
      end



      oUndMedicion            := UniMedicion():Create( cPatEmp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles           := .F.
      end

      oCentroCoste            := TCentroCoste():Create( cPatDat() )
      if !oCentroCoste:OpenFiles()
         lOpenFiles           := .F.
      end

      oMailing                := TGenmailingDatabasePresupuestosClientes():New( nView )

      Counter                 := TCounter():New( nView, "nPreCli" )

      CodigosPostales():GetInstance():OpenFiles()



      oFont             := TFont():New( "Arial", 8, 26, .F., .T. )



      public nTotPre    := 0
      public nTotDto    := 0
      public nTotDPP    := 0
      public nTotNet    := 0
      public nTotIvm    := 0
      public nTotIva    := 0
      public nTotReq    := 0
      public nTotAge    := 0
      public nTotUno    := 0
      public nTotDos    := 0
      public nTotPnt    := 0
      public nTotTrn    := 0
      public nTotCos    := 0
      public nTotAtp    := 0
      public nTotPes    := 0
      public nPctRnt    := 0
      public nTotRnt    := 0
      public nTotDif    := 0
      public nTotUnd    := 0










      public aTotIva := { {   "porcentajeiva" => 0, "logrecargo"   => .F., "porcentajere" => 0, "bruto"        => 0, "neto"         => 0, "impiva"    => 0, "impre"        => 0, "nivmh"        => 0, "ntransporte"  => 0, "npntver"      => 0 } }

      public aTotIvm    := { { 0,nil,0 }, { 0,nil,0 }, { 0,nil,0 }, }
      public aIvmUno    := aTotIvm[ 1 ]
      public aIvmDos    := aTotIvm[ 2 ]
      public aIvmTre    := aTotIvm[ 3 ]

      public aImpVto    := {}
      public aDatVto    := {}

      public nNumArt    := 0
      public nNumCaj    := 0





      if lAIS() .AND. !oUser():lAdministrador()

         cFiltroUsuario    := "Field->cSufPre == '" + Application():CodigoDelegacion() + "' .and. Field->cCodCaj == '" + Application():CodigoCaja() + "'"
         if RolesModel():getRolFiltrarVentas( Auth():rolUuid() )
            cFiltroUsuario += " .and. Field->cCodUsr == '" + Auth():Codigo()  + "'"
         end

         ( D():PresupuestosClientes( nView ) )->( AdsSetAOF( cFiltroUsuario ) )

      end

      EnableAcceso()





      oDetCamposExtra      := TDetCamposExtra():New()
      oDetCamposExtra:OpenFiles()
      oDetCamposExtra:SetTipoDocumento( "Presupuestos a clientes" )
      oDetCamposExtra:setbId( {|| D():PresupuestosClientesId( nView ) } )



   RECOVER USING oError

      lOpenFiles     := .F.

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      EnableAcceso()

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

RETURN ( lOpenFiles )



STATIC FUNCTION CloseFiles()

   DisableAcceso()

   DestroyFastFilter( D():PresupuestosClientes( nView ), .T., .T. )

   if !Empty( oFont )
      oFont:end()
   end

   if !Empty( dbfPreCliI   )
      ( dbfPreCliI   )->( dbCloseArea() )
   end

   if !Empty( dbfPreCliD   )
      ( dbfPreCliD   )->( dbCloseArea() )
   end

   if !Empty( dbfIva )
      ( dbfIva       )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreL )
      ( dbfTarPreL   )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreS )
      ( dbfTarPreS   )->( dbCloseArea() )
   end

   if !Empty( dbfPromoT )
      ( dbfPromoT    )->( dbCloseArea() )
   end

   if !Empty( dbfPromoL )
      ( dbfPromoL    )->( dbCloseArea() )
   end

   if !Empty( dbfPromoC )
      ( dbfPromoC    )->( dbCloseArea() )
   end

   if !Empty( dbfAgent )
      ( dbfAgent     )->( dbCloseArea() )
   end

   if !Empty( D():Articulos( nView ) )
      ( D():Articulos( nView )  )->( dbCloseArea() )
   end

   if dbfCodebar <> nil
      ( dbfCodebar )->( dbCloseArea() )
   end

   if !Empty( dbfFPago )
      ( dbfFPago     )->( dbCloseArea() )
   end

   if !Empty( dbfDiv )
      ( dbfDiv       )->( dbCloseArea() )
   end

   if !Empty( dbfFamilia )
      ( dbfFamilia   )->( dbCloseArea() )
   end

   if !Empty( dbfOferta )
      ( dbfOferta    )->( dbCloseArea() )
   end

   if !Empty( dbfKit )
      ( dbfKit       )->( dbCloseArea() )
   end

   if !Empty( dbfPro )
      ( dbfPro       )->( dbCloseArea() )
   end

   if !Empty( dbfTblPro )
      ( dbfTblPro    )->( dbCloseArea() )
   end

   if !Empty( dbfObrasT )
      ( dbfObrasT    )->( dbCloseArea() )
   end

   if !Empty( dbfRuta )
      ( dbfRuta      )->( dbCloseArea() )
   end

   if !Empty( dbfArtDiv )
      ( dbfArtDiv    )->( dbCloseArea() )
   end

   if !Empty( dbfCajT )
      ( dbfCajT )->( dbCloseArea() )
   end

   if !Empty( dbfAlm )
      ( dbfAlm )->( dbCloseArea() )
   end

   if dbfArtPrv <> nil
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if dbfDelega <> nil
      ( dbfDelega )->( dbCloseArea() )
   end

   if dbfAgeCom <> nil
      ( dbfAgeCom )->( dbCloseArea() )
   end

   if dbfCount <> nil
      ( dbfCount )->( dbCloseArea() )
   end

   if dbfEmp <> nil
      ( dbfEmp )->( dbCloseArea() )
   end

   if dbfPedPrvL <> nil
      ( dbfPedPrvL )->( dbCloseArea() )
   end

   if dbfAlbPrvL <> nil
      ( dbfAlbPrvL )->( dbCloseArea() )
   end

   if dbfFacPrvL <> nil
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if dbfRctPrvL <> nil
      ( dbfRctPrvL )->( dbCloseArea() )
   end

   if dbfPedCliL <> nil
      ( dbfPedCliL )->( dbCloseArea() )
   end

   if !Empty( dbfAlbCliT )
      ( dbfAlbCliT )->( dbCloseArea() )
   end

   if dbfAlbCliL <> nil
      ( dbfAlbCliL )->( dbCloseArea() )
   end

   if dbfFacCliL <> nil
      ( dbfFacCliL )->( dbCloseArea() )
   end

   if dbfFacRecL <> nil
      ( dbfFacRecL )->( dbCloseArea() )
   end

   if dbfTikCliT <> nil
      ( dbfTikCliT )->( dbCloseArea() )
   end

   if dbfTikCliL <> nil
      ( dbfTikCliL )->( dbCloseArea() )
   end

   if dbfProLin <> nil
      ( dbfProLin )->( dbCloseArea() )
   end

   if dbfProMat <> nil
      ( dbfProMat )->( dbCloseArea() )
   end

   if dbfCliInc <> nil
      ( dbfCliInc )->( dbCloseArea() )
   end

   if dbfFacCliP <> nil
      ( dbfFacCliP )->( dbCloseArea() )
   end

   if dbfAntCliT <> nil
      ( dbfAntCliT )->( dbCloseArea() )
   end

   if dbfProvee <> nil
      ( dbfProvee )->( dbCloseArea() )
   end

   if !Empty( oNewImp )
      oNewImp:End()
   end

   if !Empty( oTrans )
      oTrans:End()
   end

   if !Empty( oStock )
      oStock:end()
   end

   if !Empty( oTipArt )
      oTipArt:end()
   end

   if !Empty( oGrpFam )
      oGrpFam:end()
   end

   if !Empty( oUndMedicion )
      oUndMedicion:end()
   end

   if !Empty( oFraPub )
      oFraPub:end()
   end

   if !Empty( oDetCamposExtra )
      oDetCamposExtra:CloseFiles()
   end

   if !Empty( oCentroCoste )
      oCentroCoste:End()
   end

   if !empty(oMailing)
      oMailing:end()
   end

   D():DeleteView( nView )

   CodigosPostales():GetInstance():CloseFiles()

   dbfPreCliI     := nil
   dbfPreCliD     := nil
   dbfArtPrv      := nil
   dbfIva         := nil
   dbfTarPreL     := nil
   dbfTarPreS     := nil
   dbfPromoT      := nil
   dbfPromoL      := nil
   dbfPromoC      := nil
   dbfAgent       := nil
   dbfCodebar     := nil
   dbfFpago       := nil
   dbfDiv         := nil
   dbfFamilia     := nil
   dbfOferta      := nil
   dbfKit         := nil
   dbfPro         := nil
   dbfTblPro      := nil
   dbfObrasT      := nil
   dbfRuta        := nil
   dbfArtDiv      := nil
   dbfCajT        := nil
   dbfDelega      := nil
   dbfCount       := nil
   oBandera       := nil
   oNewImp        := nil
   oTrans         := nil
   oStock         := nil
   oTipArt        := nil
   oGrpFam        := nil
   dbfAgeCom      := nil
   dbfEmp         := nil

   dbfPedPrvL     := nil
   dbfAlbPrvL     := nil
   dbfFacPrvL     := nil
   dbfFacPrvL     := nil

   dbfPedCliL     := nil
   dbfAlbCliL     := nil
   dbfFacCliL     := nil
   dbfFacRecL     := nil
   dbfTikCliL     := nil

   dbfProLin      := nil
   dbfProMat      := nil
   dbfCliInc      := nil

   dbfProvee      := nil

   oCentroCoste   := nil

   lOpenFiles     := .F.

   oWndBrw        := nil

   EnableAcceso()

RETURN .T.



FUNCTION PreCli( oMenuItem, oWnd, cCodCli, cCodArt )

   local oSnd
   local oRpl
   local oImp
   local oPrv
   local oDel
   local oPdf
   local oMail
   local oDup
   local oBtnEur
   local nLevel
   local lEuro          := .F.
   local oRotor
   local oScript

   If( oMenuItem == nil, oMenuItem := "presupuestos_de_clientes", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;
   If( cCodCli == nil, cCodCli := "", ) ;
   If( cCodArt == nil, cCodArt := "", ) ;

   nLevel               := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      return .F.
   end





   DisableAcceso()























   oWndBrw := TShell():New( 0, 0, 22, 80, "Presupuestos a clientes",, oWnd,,, .F.,,, ( D():PresupuestosClientes( nView ) ),,,,, {"Número", "Fecha", "Código", "Nombre", "Código postal", "Población", "Provincia", "Dirección", "Agente", "Su pedido"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, D():PresupuestosClientes( nView ), cCodCli, cCodArt ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, D():PresupuestosClientes( nView ), cCodCli, cCodArt ) )}, {||( WinDelRec( oWndBrw:oBrw, D():PresupuestosClientes( nView ), {|| QuiPreCli() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, D():PresupuestosClientes( nView ), cCodCli, cCodArt ) )}, nil, nLevel, "gc_notebook_user_16", ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, D():PresupuestosClientes( nView ) ) )}, .T. )

      oWndBrw:lFechado     := .T.

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->lCloPre }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "gc_lock2_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Estado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->lEstado }
         :nWidth           := 20
         :SetCheck( { "gc_check_12", "gc_delete_12" } )
         :AddResource( "gc_trafficlight_on_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "gc_mail2_12", "Nil16" } )
         :AddResource( "gc_mail2_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_check_12" )
         :AddResource( "gc_document_information_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Imprimir"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "gc_printer2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Tipo"
         :bEditValue       := {|| aTipPre[ if( ( D():PresupuestosClientes( nView ) )->lAlquiler, 2, 1 ) ] }
         :nWidth           := 50
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumPre"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cSerPre + "/" + AllTrim( Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cSufPre }
         :nWidth           := 20
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| Trans( ( D():PresupuestosClientes( nView ) )->cTurPre, "######" ) }
         :nWidth           := 40
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dDesFec"
         :bEditValue       := {|| Dtoc( ( D():PresupuestosClientes( nView ) )->dFecPre ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Situación"
         :bEditValue       := {|| AllTrim( ( D():PresupuestosClientes( nView ) )->cSituac ) }
         :nWidth           := 80
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( D():PresupuestosClientes( nView ) )->cCodCli ) }
         :nWidth           := 70
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cNomCli }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código postal"
         :cSortOrder       := "CodPostal"
         :bEditValue       := {|| alltrim( ( D():PresupuestosClientes( nView ) )->cPosCli ) }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Población"
         :cSortOrder       := "Poblacion"
         :bEditValue       := {|| alltrim( ( D():PresupuestosClientes( nView ) )->cPobCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Provincia"
         :cSortOrder       := "Provincia"
         :bEditValue       := {|| alltrim( ( D():PresupuestosClientes( nView ) )->cPrvCli ) }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Agente"
         :cSortOrder       := "cCodAge"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cCodAge }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Ruta"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cCodRut }
         :nWidth           := 40
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Almacén"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cCodAlm }
         :nWidth           := 60
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Dirección"
         :cSortOrder       := "cCodObr"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cCodObr }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Des. dirección"
         :bEditValue       := {|| ClientesDireccionesModel():getName( ( D():PresupuestosClientes( nView ) )->cCodCli, ( D():PresupuestosClientes( nView ) )->cCodObr ) }
         :nWidth           := 150
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Su pedido"
         :cSortOrder       := "cSuPre"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->cSuPre }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->nTotNet }
         :cEditPicture     := cPorDiv( ( D():PresupuestosClientes( nView ) )->cDivPre, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->nTotIva }
         :cEditPicture     := cPorDiv( ( D():PresupuestosClientes( nView ) )->cDivPre, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->nTotReq }
         :cEditPicture     := cPorDiv( ( D():PresupuestosClientes( nView ) )->cDivPre, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( D():PresupuestosClientes( nView ) )->nTotPre }
         :cEditPicture     := cPorDiv( ( D():PresupuestosClientes( nView ) )->cDivPre, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( D():PresupuestosClientes( nView ) )->cDivPre ), dbfDiv ) }
         :nWidth           := 30
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

   oDetCamposExtra:addCamposExtra( oWndBrw )

   oWndBrw:cHtmlHelp    := "Presupuestos a clientes"

   oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()







   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oDup := oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",, {|This|This:Toggle()}, 2,, .F. )







      oWndBrw:NewAt( "Dup",,, {||( DupSerie( oWndBrw ) )}, "Series",,,, 2, oDup, .F. )






   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )






   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )







   oDel := oWndBrw:NewAt( "DEL",,, {||( oWndBrw:RecDel() )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )








   oPrv := oWndBrw:NewAt( "IMP",, "Imprimir pedidos", {||( GenPreCli( 1 ), oWndBrw:Refresh() )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenPreCli( oWndBrw:oBrw, oPrv, 1 )





   oWndBrw:NewAt( "GC_PRINTER2_",,, {||( ImprimirSeriesPresupuestosClientes() )}, "Imp(r)imir series", "R",,, 32,, .F. )








   oImp := oWndBrw:NewAt( "PREV1",, "Previsualizar pedidos", {||( GenPreCli( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenPreCli( oWndBrw:oBrw, oImp, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( GenPreCli( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenPreCli( oWndBrw:oBrw, oPdf, 3 )





   oMail := oWndBrw:NewAt( "GC_MAIL_EARTH_",,, {||( oMailing:documentsDialog( oWndBrw:oBrw:aSelected ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )






   oWndBrw:NewAt( "gc_portable_barcode_scanner_",,, {||( TLabelGeneratorPresupuestoClientes():New( nView ):Dialog() )}, "Eti(q)uetas", "Q",,, 32,, .F. )

   if RolesModel():getRolCambiarEstado( Auth():rolUuid() )






      oWndBrw:NewAt( "CHGSTATE",,, {||( ChgState( oWndBrw:oBrw ) )}, "Cambiar Es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "LBL",, "Seleccionar presupuestos para ser enviados", {||lSnd( oWndBrw, D():PresupuestosClientes( nView ) )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():PresupuestosClientes( nView ), "lSndDoc", .T., .T., .T. ) )}, "Todos",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():PresupuestosClientes( nView ), "lSndDoc", .F., .T., .T. ) )}, "Ninguno",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():PresupuestosClientes( nView ), "lSndDoc", .T., .F., .T. ) )}, "Abajo",,,, 4, oSnd, .F. )






   oBtnEur := oWndBrw:NewAt( "gc_currency_euro_",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )
   if RolesModel():getRolCambiarCampos( Auth():rolUuid() )






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():PresupuestosClientes( nView ), aItmPreCli() ) )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():PresupuestosClientesLineas( nView ), aColPreCli() ) )}, "Lineas",,,, 4, oRpl, .F. )

   end






   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "08", ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre ) )}, "I(n)forme documento", "N",,, 4,, .F. )




   oWndBrw:NewAt( "gc_document_text_pencil_",,, {||( Counter:OpenDialog() )}, "Establecer contadores",,,,,, .F. )





   oScript := oWndBrw:NewAt( "gc_folder_document_",,, {||( oScript:Expand() )}, "Scripts",,,,,, .F. )
      ImportScript( oWndBrw, oScript, "PresupuestosClientes" )






   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,, {|This|This:Toggle()},,, .F. )




      oWndBrw:NewAt( "GC_USER_",,, {||( EdtCli( ( D():PresupuestosClientes( nView ) )->cCodCli ) )}, "Modificar cliente",,,,, oRotor, .F. )




      oWndBrw:NewAt( "INFO",,, {||( InfCliente( ( D():PresupuestosClientes( nView ) )->cCodCli ) )}, "Informe de cliente",,,,, oRotor, .F. )




      oWndBrw:NewAt( "gc_clipboard_empty_user_",,, {||( if( !Empty( ( D():PresupuestosClientes( nView ) )->cCodObr ), EdtObras( ( D():PresupuestosClientes( nView ) )->cCodCli, ( D():PresupuestosClientes( nView ) )->cCodObr, dbfObrasT ), MsgStop( "No hay obra asociada al presupuesto" ) ) )}, "Modificar dirección",,,,, oRotor, .F. )





      oWndBrw:NewAt( "GC_CLIPBOARD_EMPTY_USER_",,, {||( if( !( D():PresupuestosClientes( nView ) )->lEstado, PedCli( nil, nil, nil, nil, ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre ), MsgStop( "El presupuesto ya ha sido aceptado" ) ) )}, "Generar pedido",,,,, oRotor, .T. )




      oWndBrw:NewAt( "GC_CLIPBOARD_EMPTY_USER_",,, {||( Pre2Ped( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre ) )}, "Modificar pedido",,,,, oRotor, .F. )





      oWndBrw:NewAt( "GC_DOCUMENT_EMPTY_",,, {||( if( !( D():PresupuestosClientes( nView ) )->lEstado, AlbCli( nil, nil, { "Presupuesto" => ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre } ), MsgStop( "El presupuesto ya ha sido aceptado" ) ) )}, "Generar albarán",,,,, oRotor, .T. )





      oWndBrw:NewAt( "GC_DOCUMENT_TEXT_USER_",,, {||( if( !( D():PresupuestosClientes( nView ) )->lEstado, FactCli( nil, nil, { "Presupuesto" => ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre } ), MsgStop( "El presupuesto ya ha sido aceptado" ) ) )}, "Generar factura",,,,, oRotor, .T. )





      oWndBrw:NewAt( "gc_note_",,, {||( PreCliNotas() )}, "Generar nota de agenda",,,,, oRotor, .T. )







      oWndBrw:NewAt( "GC_CASH_REGISTER_USER_",,, {||( if( !( D():PresupuestosClientes( nView ) )->lEstado .AND. empty( ( D():PresupuestosClientes( nView ) )->cNumTik ), generateTicketFromDocument( { "Presupuesto" => D():PresupuestosClientesId( nView ) } ), msgStop( "Presupuesto aceptado o convertido a ticket" ) ) )}, "Convertir a ticket",,,,, oRotor, .T. )




   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .F. )

   oWndBrw:oActiveFilter:SetFields( aItmPreCli() )
   oWndBrw:oActiveFilter:SetFilterType( "08" )

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp, .F. )

   enableAcceso()

   if uFieldempresa( "lFltYea" )
      oWndBrw:setYearCombobox()
   end

   if !empty( cCodCli ) .OR. !empty( cCodArt )
      oWndBrw:RecAdd()
      cCodCli  := nil
      cCodArt  := nil
   end

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbf, oBrw, cCodCli, cCodArt, nMode )

   local oDlg
   local oFld
   local nOrd
   local oBrwLin
   local oBrwInc
   local oBrwDoc
   local oBrwEst
   local oSay           := Array( 11 )
   local cSay           := Array( 11 )
   local oSayLabels     := Array( 10 )
   local oGetMasDiv
   local cGetMasDiv     := ""
   local oBmpEmp
   local oBmpDiv
   local oBtnKit
   local oRieCli
   local nRieCli
   local oTlfCli
   local cTlfCli
   local cSerie         := cNewSer( "nPreCli", dbfCount )
   local oAprovado
   local cAprovado
   local oSayGetRnt
   local cTipPre
   local oSayDias
   local oSayTxtDias
   local oBmpGeneral





   cOldCodCli           := aTmp[ 6 ]
   cOldSituacion        := aTmp[ 61 ]

   setOldPorcentajeAgente( aTmp[ 43 ] )

   do case
   case nMode == 1

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 17 ]  := Application():codigoAlmacen()
      aTmp[ 46 ]  := cDivEmp()
      aTmp[ 18 ]  := Application():CodigoCaja()
      aTmp[ 19 ]  := cDefFpg()
      aTmp[ 58 ]  := Auth():Codigo()
      aTmp[ 47 ]  := nChgDiv( aTmp[ 46 ], dbfDiv )
      aTmp[ 22 ]  := .F.
      aTmp[ 3 ]  := RetSufEmp()
      aTmp[ 62 ]  := nDiasValidez()
      aTmp[ 48 ]  := .T.
      aTmp[ 67 ]  := Application():CodigoDelegacion()
      aTmp[ 52 ]  := uFieldEmpresa( "lIvaInc" )
      aTmp[ 73 ]  := padr( getConfigTraslation( "Gastos" ), 250 )
      aTmp[ 53 ]  := nIva( dbfIva, cDefIva() )

      if !Empty( cCodCli )
         aTmp[ 6 ]  := cCodCli
      end

   case nMode == 2

      if aTmp[ 57 ] .AND. !oUser():lAdministrador()
         msgStop( "El presupuesto está cerrado." )
         Return .F.
      end

      lChangeRegIva( aTmp )

      aTmp[ 58 ]  := Auth():Codigo()

   case nMode == 4

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 5 ]   := GetSysDate()
      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 22 ]  := .F.
      aTmp[ 57 ]  := .F.
      aTmp[ 58 ]  := Auth():Codigo()

   end

   if Empty( Rtrim( aTmp[ 1 ] ) )
      aTmp[ 1 ]  := cSerie
   end

   if Empty( aTmp[ 28 ] )
      aTmp[ 28 ]  := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end

   if Empty( aTmp[ 29 ] )
      aTmp[ 29 ]  := Padr( "General", 50 )
   end

   if Empty( aTmp[ 31 ] )
      aTmp[ 31 ]     := Padr( "Pronto pago", 50 )
   end





   cTipPre              := aTipPre[ if( aTmp[ 72 ], 2, 1  ) ]
   cAprovado            := if( aTmp[ 22 ], "Aprobado", "" )

   if empty( aTmp[ 75 ] )
      aTmp[ 75 ] := RetFld( aTmp[ 6 ], D():Clientes( nView ), "Telefono" )
   end





   if BeginTrans( aTmp, nMode )
      Return .F.
   end





   nOrd                 := ( D():PresupuestosClientes( nView ) )->( ordSetFocus( 1 ) )

   cPicUnd              := MasUnd()
   cPouDiv              := cPouDiv( aTmp[ 46 ], dbfDiv )
   cPorDiv              := cPorDiv( aTmp[ 46 ], dbfDiv )
   nDouDiv              := nDouDiv( aTmp[ 46 ], dbfDiv )
   nRouDiv              := nRouDiv( aTmp[ 46 ], dbfDiv )





   cSay[ 2 ]            := RetFld( aTmp[ 16 ], dbfTarPreS )
   cSay[ 3 ]            := RetFld( aTmp[ 6 ] + aTmp[ 15 ], dbfObrasT, "cNomObr" )
   cSay[ 4 ]            := RetFld( aTmp[ 17 ], dbfAlm )
   cSay[ 5 ]            := RetFld( aTmp[ 19 ], dbfFPago )
   cSay[ 6 ]            := RetFld( aTmp[ 14 ], dbfAgent )
   cSay[ 7 ]            := RetFld( aTmp[ 20 ], dbfRuta )
   cSay[ 8 ]            := oTrans:cNombre( aTmp[ 55 ] )
   cSay[ 9 ]            := RetFld( aTmp[ 18 ], dbfCajT )
   cSay[10 ]            := UsuariosModel():getNombreWhereCodigo( aTmp[ 58 ] )
   cSay[11 ]            := RetFld( cCodEmp() + aTmp[ 67 ], dbfDelega, "cNomDlg" )

   cTlfCli              := RetFld( aTmp[ 6 ], D():Clientes( nView ), "Telefono" )

   nRieCli              := oStock:nRiesgo( aTmp[ 6 ] )



   InitTarifaCabecera( aTmp[ 28 ] )



   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "presupuestos a clientes", "PEDCLI",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )













      oFld := TFolder():ReDefine( 200, {"&Presupuesto", "Da&tos", "&Incidencias", "D&ocumentos", "&Situaciones"}, { "PRECLI_1","PRECLI_2","PEDCLI_3","PEDCLI_4","PEDCLI_5" }, oDlg,,,,, .F., )







      oBmpGeneral := TBitmap():ReDefine( 990, "gc_notebook_user_48",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_folders2_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_information_48",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_address_book_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_document_attachment_48",, oFld:aDialogs[5],,, .F., .F.,,, .F.,,, .T. )







        aGet[6] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[6], aTmp[6]:= u ) }, oFld:aDialogs[1],,, {||    ( LoaCli( aGet, aTmp, nMode, oRieCli ), RecalculaTotal( aTmp ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[6] ) )}, nil, "LUPA",, )




      aGet[7] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[12] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 8 ] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 8 ], Rtrim( aTmp[ 9 ] ) + Space( 1 ) + Rtrim( aTmp[ 10 ] ) )}, nil, "gc_earth_lupa_16",, )




      aGet[ 9 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 10 ] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





        aGet[ 11 ] := TGetHlp():ReDefine( 107, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,, {||    ( CodigosPostales():GetInstance():validCodigoPostal() )},,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )



      oGetTarifa  := comboTarifa():Build( { "idCombo" => 132, "uValue" => aTmp[ 28 ] } )
      oGetTarifa:Resource( oFld:aDialogs[1] )







      oBtnPrecio := TBtnBmp():ReDefine( 174, "gc_arrow_down_16",,,,, {|Self|( ChangeTarifaCabecera( oGetTarifa:getTarifa(), dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1], .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )}, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )







      oRieCli := TGetHlp():ReDefine( 133, { | u | If( PCount()==0, nRieCli, nRieCli:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[75] := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, aTmp[75], aTmp[75]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 58 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSay[ 10 ]:cText( UsuariosModel():getNombreWhereCodigo( aTmp[ 58 ] ) ), .T.  )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 10 ] := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, cSay[ 10 ], cSay[ 10 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










        aGet[16] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[16], aTmp[16]:= u ) }, oFld:aDialogs[1],,, {||    ( cTarifa( aGet[16], oSay[ 2 ] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. oUser():lAdministrador() )},, .F., .F.,,,,, {|Self|( BrwTarifa( aGet[16], oSay[ 2 ] ) )}, nil, "LUPA",, )




      oSay[ 2 ] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, cSay[ 2 ], cSay[ 2 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )










        aGet[15] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[15], oSay[ 3 ], aTmp[6], dbfObrasT ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwObras( aGet[15], oSay[ 3 ], aTmp[6], dbfObrasT ) )}, nil, "LUPA",, )




      oSay[ 3 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cSay[ 3 ], cSay[ 3 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 17 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[ 1 ],,, {||    ( cAlmacen( aGet[ 17 ], , oSay[ 4 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 17 ], oSay[ 4 ] ) )}, nil, "LUPA",, )






      oSay[ 4 ] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSay[ 4 ], cSay[ 4 ]:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ExpAlmacen( aTmp[ 17 ], dbfTmpLin, oBrwLin ) )}, nil, "Bot",, )










      aGet[ 19 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cFPago( aGet[ 19 ], dbfFPago, oSay[ 5 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ 19 ], oSay[ 5 ] ) )}, nil, "LUPA",, )




      oSay[ 5 ] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, cSay[ 5 ], cSay[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 14 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],,, {||    ( LoadAgente( aGet[ 14 ], dbfAgent, oSay[ 6 ], aGet[ 43 ], dbfAgeCom, dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 14 ], oSay[ 6 ] ) )}, nil, "LUPA",, )






      oSay[ 6 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, cSay[ 6 ], cSay[ 6 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( changeAgentPercentageInAllLines(aTmp[ 43 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, nil, "Bot",, )







      aGet[ 43 ] := TGetHlp():ReDefine( 182, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( validateAgentPercentage( aGet[ 43 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( !Empty( aTmp[ 14 ] ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      oGetAge := TGetHlp():ReDefine( 183, { | u | If( PCount()==0, nTotAge, nTotAge:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









      aGet[ 20 ] := TGetHlp():ReDefine( 185, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cRuta( aGet[ 20 ], dbfRuta, oSay[ 7 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[ 20 ], dbfRuta, oSay[ 7 ] ) )}, nil, "LUPA",, )




      oSay[ 7 ] := TGetHlp():ReDefine( 186, { | u | If( PCount()==0, cSay[ 7 ], cSay[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )











        aGet[ 46 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivOut( aGet[ 46 ], oBmpDiv, aGet[ 47 ], @cPouDiv, @nDouDiv, @cPorDiv, @nRouDiv, nil, nil, oGetMasDiv, dbfDiv, oBandera ) )}, "N/W*",,,,, .F., {||     ( nMode == 1 .AND. ( dbfTmpLin )->( LastRec() ) == 0 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 46 ], oBmpDiv, aGet[ 47 ], dbfDiv, oBandera )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 201, "BAN_EURO",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )






      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgPreCli.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )



      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      oBrwLin:bClrStd         := {|| { if( ( dbfTmpLin )->lKitChl, 8421504, 0 ), GetSysColor( 5 ) } }

      oBrwLin:cAlias          := dbfTmpLin

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:lFooter         := .T.
      oBrwLin:cName           := "Presupuesto a cliente.Detalle"

      oBrwLin:CreateFromResource( 210 )

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Oferta"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpLin )->lLinOfe }
         :nWidth              := 60
         :SetCheck( { "gc_star2_16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Número"
         :bEditValue          := {|| ( dbfTmpLin )->nNumLin }
         :cEditPicture        := "9999"
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Posición"
         :cSortOrder          := "nPosPrint"
         :bEditValue          := {|| ( dbfTmpLin )->nPosPrint }
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | if( !empty( oCol ), oCol:SetOrder(), ) }
         :cEditPicture        := "9999"
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código"
         :bEditValue          := {|| ( dbfTmpLin )->cRef }
         :nWidth              := 60
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "C. Barras"
         :bEditValue          := {|| cCodigoBarrasDefecto( ( dbfTmpLin )->cRef, dbfCodeBar ) }
         :nWidth              := 100
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| if( Empty( ( dbfTmpLin )->cRef ), ( dbfTmpLin )->mLngDes, ( dbfTmpLin )->cDetalle ) }
         :nWidth              := 300
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr1 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Valor prop. 1"
         :bEditValue          := {|| retValProp( ( dbfTmpLin )->cCodPr1 + ( dbfTmpLin )->cValPr1 )}
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr2 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Valor prop. 2"
         :bEditValue          := {|| retValProp( ( dbfTmpLin )->cCodPr2 + ( dbfTmpLin )->cValPr2 )}
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Lote"
         :bEditValue          := {|| ( dbfTmpLin )->cLote }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Bultos"
         :bEditValue          := {|| NotBulto( ( dbfTmpLin )->nBultos ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreCajas()
         :bEditValue          := {|| NotCaja( ( dbfTmpLin )->nCanPre ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| nTotNPreCli( dbfTmpLin ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "UM. Unidad de medición"
         :bEditValue          := {|| ( dbfTmpLin )->cUnidad }
         :nWidth              := 25
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Peso"
         :bEditValue          := {|| ( dbfTmpLin )->nPesokg }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "T. Peso"
         :bEditValue          := {|| ( nTotNPreCli( dbfTmpLin ) * ( dbfTmpLin )->nPesokg ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Alm."
         :bEditValue          := {|| ( dbfTmpLin )->cAlmLin }
         :nWidth              := 35
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| nImpUPreCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Dto."
         :bEditValue          := {|| ( dbfTmpLin )->nDto }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Dto. Lin."
         :bEditValue          := {|| nDtoUPreCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Prm."
         :bEditValue          := {|| ( dbfTmpLin )->nDtoPrm }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Age"
         :bEditValue          := {|| ( dbfTmpLin )->nComAge }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ( dbfTmpLin )->nIva }
         :cEditPicture        := "@E 99.9"
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Portes"
         :bEditValue          := {|| nTrnUPreCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "P. verde"
         :bEditValue          := {|| nPntUPreCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nTotLPreCli( dbfTmpLin, nDouDiv, nRouDiv, , , aTmp[ 80 ] ) }
         :cEditPicture        := cPorDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Familia"
         :bEditValue          := {|| ( dbfTmpLin )->cCodFam }
         :nWidth              := 35
         :lHide               := .T.
      end

      if nMode <> 3
         oBrwLin:bLDblClick  := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
      end






      aGet[ 29 ] := TGetHlp():ReDefine( 219, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 30 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      aGet[ 31 ] := TGetHlp():ReDefine( 229, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








        aGet[ 32 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






        aGet[ 33 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









        aGet[ 34 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 35 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 36 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )



      oBrwIva                        := IXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva, , , .F. )
      oBrwIva:lHscroll               := .F.

      oBrwIva:nMarqueeStyle          := 5
      oBrwIva:lRecordSelector        := .F.

      oBrwIva:CreateFromResource( 490 )

      with object ( oBrwIva:AddCol() )
         :cHeader          := "Base"
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "neto" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "neto" ) <> 0 ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "neto" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "%" + cImp()
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) <> nil ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ), "@E 999.99" ), "" ), "" ) }
         :bEditValue       := {|| hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) }
         :nWidth           := 44
         :cEditPicture     := "@E 999.99"
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFootStrAlign    := 1
         :nEditType        := 1
         :bEditWhen        := {|| !IsNil( hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ) ) }
         :bOnPostEdit      := {|o,x| EdtIva( o, x, hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajeiva" ), dbfTmpLin, dbfIva, oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := cImp()
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "impiva" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "impiva" ) <> nil ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "impiva" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "% R.E."
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ) <> nil .AND. aTmp[ 42 ] ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "porcentajere" ), cPicReq() ), "" ), "" ) }
         :nWidth           := 44
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "R.E."
         :bStrData         := {|| if( len( aTotIva ) > 0, if( ( hhaskey( aTotIva[ oBrwIva:nArrayAt ], "impre" ) .AND. hGet( aTotIva[ oBrwIva:nArrayAt ], "impre" ) <> nil .AND. aTmp[ 42 ] ), Trans( hGet( aTotIva[ oBrwIva:nArrayAt ], "impre" ), cPorDiv ), "" ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end






      aGet[ 73 ] := TGetHlp():ReDefine( 411, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 53 ] := TGetHlp():ReDefine( 412, { | u | If( PCount()==0, aTmp[ 53 ], aTmp[ 53 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 53 ] ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 53 ], dbfIva, , .T. ) )}, nil, "LUPA",, )







      aGet[ 54 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[1],, cPorDiv, {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )



      oGetNet := TSay():ReDefine( 401, {|| nTotNet}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetTrn := TSay():ReDefine( 402, {|| nTotTrn}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetIvm := TSay():ReDefine( 403, {|| nTotIvm}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      aGet[ 80 ] := TCheckBox():ReDefine( 409, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ), oBrwLin:Refresh() )},,,,, .F., {||         ( nMode <> 3 )}, .F. )



      oGetPnt := TSay():ReDefine( 404, {|| nTotPnt}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetIva := TSay():ReDefine( 405, {|| nTotIva}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      aGet[ 42 ] := TCheckBox():ReDefine( 406, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||         ( nMode <> 3 )}, .F. )




      oImpuestos := TCheckBox():ReDefine( 711, { | u | If( PCount()==0, lImpuestos, lImpuestos:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( .F. )}, .F. )



      oGetReq := TSay():ReDefine( 407, {|| nTotReq}, oFld:aDialogs[1],,,, .F.,, .F., .F., )

      oSayGetRnt := TSay():ReDefine( 709,, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetRnt := TGetHlp():ReDefine( 408, { | u | If( PCount()==0, nTotRnt, nTotRnt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




      oGetMasDiv := TSay():ReDefine( 410, {|| cGetMasDiv}, oFld:aDialogs[1],,,, .F., oFont, .F., .F., )




      oGetTotal := TSay():ReDefine( 420, {|| nTotPre}, oFld:aDialogs[1],,,, .F., oFont, .F., .F., )







        TButton():ReDefine( 515, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .T. ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( DelDeta( oBrwLin, aTmp ), oTipPre:Refresh() )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( EdtZoom( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





        TButton():ReDefine( 524, {||( LineUp( dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 525, {||( LineDown( dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||         ( nMode <> 3 )},,, .F. )




      oBtnKit := TButton():ReDefine( 526, {||( ShowKit( D():PresupuestosClientes( nView ), dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )




      TButton():ReDefine( 527, {||( importarArticulosScaner() )}, oFld:aDialogs[1],,, .F.,,,, .F. )










      aGet[1] := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, aTmp[1], aTmp[1]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[1] >= "A" .AND. aTmp[1] <= "Z"  )}, "N/W*",,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[1] ) )}, {||  ( DwSerie( aGet[1] ) )},,,, nil,,, )





        aGet[2] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )




        aGet[3] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )






        aGet[5] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 71 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 71 ], aTmp[ 71 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,, 114, )








      aGet[ 70 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 70 ], aTmp[ 70 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,, 115, )





      oSayDias := TSay():ReDefine( 113, {||      ( aTmp[ 70 ] - aTmp[ 71 ] )}, oFld:aDialogs[1], "9999",,, .F.,, .F., .F., )



      oSayTxtDias := TSay():ReDefine( 116,, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      oAprovado := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, cAprovado, cAprovado:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,, 121, )





      aGet[ 61 ] := TComboBox():ReDefine( 218, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, ( SituacionesModel():getArrayNombres() ), oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 61 ]",,,,,,, )






      oTipPre := TComboBox():ReDefine( 217, { | u | If( PCount()==0, cTipPre, cTipPre:= u ) }, aTipPre, oFld:aDialogs[1],,, {|Self|(SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt ) )},,,, .F., {||     ( ( dbfTmpLin )->( LastRec() ) == 0 )},,,,,, "oTipPre",,,,,,, )





        aGet[23] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[23], aTmp[23]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,, 123, )




      aGet[52] := TCheckBox():ReDefine( 129, { | u | If( PCount()==0, aTmp[52], aTmp[52]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 .AND. ( dbfTmpLin )->( ordkeycount() ) == 0 )}, .F. )






      aGet[ 67 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 11 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSay[ 11 ], cSay[ 11 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









      aGet[ 55 ] := TGetHlp():ReDefine( 235, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[2],,, {||    ( LoadTrans( aTmp, aGet[ 55 ], aGet[ 56 ], oSay[ 8 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oTrans:Buscar( aGet[ 55 ] ), .T. )}, nil, "LUPA",, )




      oSay[ 8 ] := TGetHlp():ReDefine( 236, { | u | If( PCount()==0, cSay[ 8 ], cSay[ 8 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      aGet[ 56 ] := TGetHlp():ReDefine( 237, { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      aGet[ 18 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[2],,, {||    cCajas( aGet[ 18 ], dbfCajT, oSay[ 9 ] )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 18 ], oSay[ 9 ] ) )}, nil, "LUPA",, )





      oSay[ 9 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cSay[ 9 ], cSay[ 9 ]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ 86 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 86 ], aTmp[ 86 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oCentroCoste:Existe( aGet[ 86 ], aGet[ 86 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 86 ] ) )}, nil, "LUPA",, 351 )







     aGet[44] := TGetHlp():ReDefine( 128, { | u | If( PCount()==0, aTmp[44], aTmp[44]:= u ) }, oFld:aDialogs[2],, "99999",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 62 ] := TGetHlp():ReDefine( 219, { | u | If( PCount()==0, aTmp[ 62 ], aTmp[ 62 ]:= u ) }, oFld:aDialogs[2],, "999",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[49] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[49], aTmp[49]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[50] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[50], aTmp[50]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[21] := TGetHlp():ReDefine( 127, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





        aGet[24] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[24], aTmp[24]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





        aGet[25] := TMultiGet():ReDefine( 250, { | u | If( PCount()==0, aTmp[25], aTmp[25]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, .F.,, )





        aGet[26] := TMultiGet():ReDefine( 240, { | u | If( PCount()==0, aTmp[26], aTmp[26]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, .F.,, )






      aGet[ 64 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 65 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 66 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      oGetPes := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, nTotPes, nTotPes:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oGetDif := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, nTotDif, nTotDif:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )



      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 6
      oBrwInc:cName           := "Presupuesto a cliente.Incidencias"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 70
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 500
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )



      oBrwDoc                 := IXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 6
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

      with object ( oBrwDoc:AddCol() )
         :cHeader             := "Documento"
         :bEditValue          := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
         :nWidth              := 960
      end

      if nMode <> 3
         oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
      end

      oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( WinDelRec( oBrwDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )



      oBrwEst                 := IXBrowse():New( oFld:aDialogs[ 5 ] )

      oBrwEst:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwEst:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwEst:cAlias          := dbfTmpEst

      oBrwEst:nMarqueeStyle   := 6
      oBrwEst:cName           := "Presupuesto de cliente.Situaciones"

         with object ( oBrwEst:AddCol() )
            :cHeader          := "Nombre"
            :bEditValue       := {|| ( dbfTmpEst )->cSitua }
            :nWidth           := 140
         end

         with object ( oBrwEst:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpEst )->dFecSit ) }
            :nWidth           := 90
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwEst:AddCol() )
            :cHeader          := "Hora"
            :bEditValue       := {|| trans( ( dbfTmpEst )->tFecSit, "@R 99:99:99" ) }
            :nWidth           := 90
         end

         if nMode <> 3
            oBrwEst:bLDblClick   := {|| WinEdtRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) }
         end

         oBrwEst:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) )}, oFld:aDialogs[ 5 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) )}, oFld:aDialogs[ 5 ],,, .F., {||     ( nMode <> 3 )},,, .F. )






      TButton():ReDefine( 502, {||( WinDelRec( oBrwEst, dbfTmpEst ) )}, oFld:aDialogs[ 5 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 503, {||( WinZooRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) )}, oFld:aDialogs[ 5 ],,, .F.,,,, .F. )







      TButton():ReDefine( 3, {||( RecPreCli( aTmp ), oBrwLin:Refresh( .T. ), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 4, {||( if( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ), GenPreCli( 1 ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 2, {||( if ( ExitNoSave( nMode, dbfTmpLin ), oDlg:end(), ) )}, oDlg,,, .F.,,,, .F. )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 3 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 4 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 5 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 6 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 7 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 9 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )

   if nMode <> 3

      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| DelDeta( oBrwLin, aTmp ), oTipPre:Refresh() } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| WinDelRec( oBrwInc, dbfTmpInc ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| WinDelRec( oBrwDoc, dbfTmpDoc ) } )

      oFld:aDialogs[5]:AddFastKey( 113, {|| WinAppRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) } )
      oFld:aDialogs[5]:AddFastKey( 114, {|| WinEdtRec( oBrwEst, bEdtEst, dbfTmpEst, nil, nil, aTmp ) } )
      oFld:aDialogs[5]:AddFastKey( 115, {|| WinDelRec( oBrwEst, dbfTmpEst ) } )

      oDlg:AddFastKey( 116, {|| EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ) } )
      oDlg:AddFastKey( 117, {|| if( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ), GenPreCli( 1 ), ) } )
      oDlg:AddFastKey( 120, {|| oDetCamposExtra:Play( space(1) ) } )

      oDlg:AddFastKey( 65,    {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )

   end

   CodigosPostales():GetInstance():setBinding( { "CodigoPostal" => aGet[ 11 ], "Poblacion" => aGet[ 9 ], "Provincia" => aGet[ 10 ] } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 58 ] ), , oDlg:End() ), aGet[ 55 ]:lValid() }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 58 ] ), AppDeta( oBrwLin, bEdtDet, aTmp, nil, cCodArt ), oDlg:End() ), aGet[ 55 ]:lValid() }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, nil, cCodArt ), aGet[ 55 ]:lValid() }

      otherwise
         oDlg:bStart := {|| ShowKit( D():PresupuestosClientes( nView ), dbfTmpLin, oBrwLin, .F., dbfTmpInc, cCodCli, D():Clientes( nView ), oGetRnt, aGet, oSayGetRnt ), aGet[ 55 ]:lValid() }

   end







    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|(  RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(  EdtRecMenu( aTmp, oDlg ) , SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt ) , oBrwLin:Load() , oBrwInc:Load() )}, oDlg:bRClicked,,, )

   oMenu:End()

   oBmpEmp:end()
   oBmpDiv:end()
   oBmpGeneral:End()

   ( D():PresupuestosClientes( nView ) )->( ordSetFocus( nOrd ) )

   KillTrans( oBrwLin )





   oBrwInc:CloseData()

RETURN ( oDlg:nResult == 1 )



Static Function EdtRecMenu( aTmp, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .T.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

            if !lExternal





            MenuAddItem( "&1. Campos extra [F9]", "Mostramos y rellenamos los campos extra para la familia", .F.,, {|oMenuItem|( oDetCamposExtra:Play( Space(1) ) )},, "gc_form_plus2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&2. Modificar cliente", "Modificar la ficha del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), EdtCli( aTmp[ 6 ] ), MsgStop( "Código cliente vacío" ) ) )},, "gc_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&3. Modificar cliente contactos", "Modifica la ficha del cliente en contactos", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), EdtCli( aTmp[ 6 ], , 5 ), MsgStop( "Código de cliente vacío" ) ) )},, "gc_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&4. Informe de cliente", "Abrir el informe del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), InfCliente( aTmp[ 6 ] ), MsgStop( "Código cliente vacío" ) ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )



            MenuAddItem( "&5. Modificar dirección", "Modificar ficha de la dirección", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 15 ] ), EdtObras( aTmp[ 6 ], aTmp[ 15 ], dbfObrasT ), MsgStop( "No hay obra asociada para el presupuesto" ) ) )},, "gc_worker2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

            MenuAddItem(,,,,,,,,,,,,,,,,,.T.,,,,,,,,,,,,,,,,,)

            end




            MenuAddItem( "&6. Informe del documento", "Abrir el informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "08", aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ] ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )






            MenuAddItem( "&7. Firmar documento", "Firmar documento", .F.,, {|oMenuItem|( if( empty( aTmp[ 85 ] ) .OR.  msgNoYes( "El documento ya esta firmado, ¿Desea voler a firmarlo?" ), aTmp[ 85 ] := signatureToMemo(), ) )},, "gc_sign_document_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

Return ( oMenu )






STATIC FUNCTION AppDeta( oBrwLin, bEdtDet, aTmp, lTot, cCodArt  )

   If( lTot == nil, lTot := .F., ) ;





   WinAppRec( oBrwLin, bEdtDet, dbfTmpLin, lTot, cCodArt, aTmp )

   if !Empty( oBrwLin )
      oBrwLin:Refresh()
   end

RETURN RecalculaTotal( aTmp )







STATIC FUNCTION EdtDeta( oBrwLin, bEdtDet, aTmp )

   WinEdtRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nil, aTmp )

RETURN RecalculaTotal( aTmp )







STATIC FUNCTION DelDeta( oBrwLin, aTmp )

   local lKitArt  := ( dbfTmpLin )->lKitArt
   local nNumLin  := ( dbfTmpLin )->nNumLin

   if lKitArt
      DbDelKit( oBrwLin, dbfTmpLin, nNumLin )
   end

   WinDelRec( oBrwLin, dbfTmpLin, , {|| if( lKitArt, DbDelKit( oBrwLin, dbfTmpLin, nNumLin ), ) } )

   RecalculaTotal( aTmp )

RETURN ( .T. )







STATIC FUNCTION EdtZoom( oBrwLin, bEdtDet, aTmp )

RETURN WinZooRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nil, aTmp )






STATIC FUNCTION EdtDet( aTmp, aGet, dbf, oBrw, lTotLin, cCodArtEnt, nMode, aTmpPre )

   local oDlg
   local oFld
   local oBtn
    local oTotal
   local nTotPreCli
   local cGet3
   local oGet3
   local oSayPr1
   local oSayPr2
   local cSayPr1           := ""
   local cSayPr2           := ""
   local oSayVp1
   local oSayVp2
   local cSayVp1           := ""
   local cSayVp2           := ""
   local oSayAlm
   local cSayAlm           := ""
   local bmpImage
   local oSayGrp
   local cSayGrp           := ""
   local oSayFam
   local cSayFam           := ""
   local oStkAct
   local nStkAct           := 0
   local cCodArt           := Padr( aTmp[ 4 ], 200 )
   local oRentLin
   local cRentLin
   local cCodDiv           := aTmpPre[ 46 ]
   local oSayDias

   If( lTotLin == nil, lTotLin := .F., ) ;

   cGetCelda               := Space(20)

   SysRefresh()

   cTipoCtrCoste           := AllTrim( aTmp[ 90 ] )

   do case
   case nMode == 1
      aTmp[ 1  ]    := aTmpPre[ 1 ]
      aTmp[ 2  ]    := aTmpPre[ 2 ]
      aTmp[ 3  ]    := aTmpPre[ 3 ]
      aTmp[ 8 ]    := 1
      aTmp[ 23  ]    := lTotLin
      aTmp[ 7  ]    := 1
      aTmp[ 37  ]    := aTmpPre[ 52 ]
      aTmp[ 36  ]    := aTmpPre[ 17 ]
      aTmp[ 73  ]    := oGetTarifa:getTarifa()
      aTmp[ 80  ]    := Ctod( "" )
      aTmp[ 66 ]    := aTmpPre[ 71 ]
      aTmp[ 65 ]    := aTmpPre[ 70 ]
      aTmp[ 68 ]  := !Empty( oTipPre ) .AND. ( oTipPre:nAt == 2 )
      aTmp[ 85 ]     := aTmpPre[ 15 ]

      if !Empty( cCodArtEnt )
         cCodArt           := Padr( cCodArtEnt, 200 )
      end

      cTipoCtrCoste        := "Centro de coste"

   case nMode == 2
      lTotLin              := aTmp[ 23 ]

   end





   cOldCodArt              := aTmp[ 4    ]
   cOldPrpArt              := aTmp[ 25 ] + aTmp[ 26 ] + aTmp[ 27 ] + aTmp[ 28 ]
   cOldLotArt              := aTmp[ 42 ]
   cOldUndMed              := aTmp[ 18 ]





   cSayGrp                 := RetFld( aTmp[ 52 ], oGrpFam:GetAlias() )
   cSayFam                 := RetFld( aTmp[ 51 ], dbfFamilia )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "líneas de presupuestos a clientes", "LFACCLI",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )











      oFld := TFolder():ReDefine( 400, {"&General", "Da&tos", "&Observaciones", "&Centro coste"}, { "LFACCLI_1","LALBCLI_2","LFACCLI_3","LCTRCOSTE" }, oDlg,,,,, .F., )







      aGet[ 4 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oFld:aDialogs[1],,, {||    ( LoaArt( cCodArt, aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage,  nMode ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[ 4 ], aGet[ 5 ], .F., .T., oBtn, aGet[ 42 ], aTmp[ 25 ], aTmp[ 26 ], aGet[ 27 ], aGet[ 28 ], aGet[ 80 ], if( uFieldEmpresa( "lStockAlm" ), aTmp[ 36 ], nil ) ) )}, nil, "LUPA",, )




      aGet[ 5 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 5 ] ) ) .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 22 ] := TMultiGet():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 22 ] ) ) .AND. nMode <> 3 )}, .F.,, )











      aGet[ 42 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 113, )

         aGet[ 42 ]:bValid   := {|| StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct ) }












      aGet[ 80 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 341, )



      oBrwProperties                       := IXBrowse():New( oFld:aDialogs[1] )

      oBrwProperties:nDataType             := 2

      oBrwProperties:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwProperties:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwProperties:lHScroll              := .T.
      oBrwProperties:lVScroll              := .T.

      oBrwProperties:nMarqueeStyle         := 3
      oBrwProperties:lRecordSelector       := .F.
      oBrwProperties:lFastEdit             := .T.
      oBrwProperties:nFreeze               := 1
      oBrwProperties:lFooter               := .T.

      oBrwProperties:SetArray( {}, .F., 0, .F. )

      oBrwProperties:MakeTotals()

      oBrwProperties:CreateFromResource( 500 )





      oGetCelda := TGetHlp():ReDefine( 183, { | u | If( PCount()==0, cGetCelda, cGetCelda:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,, 184, )

      oGetCelda:bValid              := {|| SearchProperty( oGetCelda, oBrwProperties ), .T. }










      aGet[ 27 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 27 ], aTmp[ 27 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[ 27 ], oSayVp1, aTmp[ 25 ], dbfTblPro ), LoaArt( cCodArt, aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage,  nMode, .F. ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 27 ], oSayVp1, aTmp[ 25 ] ) )}, nil, "LUPA",, )

         aGet[ 27 ]:bChange   := {|| aGet[ 27 ]:Assign(), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct ) }




      oSayPr1 := TSay():ReDefine( 271, {||      cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      oSayVp1 := TGetHlp():ReDefine( 272, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 28 ] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[28], oSayVp2, aTmp[26 ], dbfTblPro ), LoaArt( cCodArt, aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage,  nMode, .F. ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[28], oSayVp2, aTmp[26 ] ) )}, nil, "LUPA",, )

         aGet[ 28 ]:bChange   := {|| aGet[ 28 ]:Assign(), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct ) }




      oSayPr2 := TSay():ReDefine( 281, {||      cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      oSayVp2 := TGetHlp():ReDefine( 282, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 18 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oUndMedicion:Existe( aGet[ 18 ], aGet[ 18 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oUndMedicion:Buscar( aGet[ 18 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 171 )











      aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 520, { | u | If( PCount()==0, aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 521, )

         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 531, )

         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 541, )

         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ 6 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 6 ], @aTmp[ 53 ] ) )}, "N/W*",,,,, .F., {||     ( lModIva() .AND. nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 6 ], dbfIva, , .T. ) )}, nil, "LUPA",, )

      if aTmp[ 68 ]







      aGet[ 66 ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[1],,, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ), oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,,, )







      aGet[ 65 ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[1],,, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ), oSayDias:Refresh() ) }, .F., .T.,,,,,, nil,,, )





      oSayDias := TSay():ReDefine( 440, {||      ( aTmp[ 65 ] - aTmp[ 66 ] )}, oFld:aDialogs[1], "9999",,, .F.,, .F., .F., )

      else









      aGet[ 39 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,, {|Self|( oNewImp:nBrwImp( aGet[ 39 ] ) )}, nil,, 126, )

      end












      aGet[ 81 ] := TGetHlp():ReDefine( 450, { | u | If( PCount()==0, aTmp[ 81 ], aTmp[ 81 ]:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     ( uFieldEmpresa( "lUseBultos" ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,, 451, )









      aGet[ 7 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ),  LoaArt( cCodArt, aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage,  nMode, .F. ) )},,,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ),  LoaArt( cCodArt, aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage,  nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 131, )









      aGet[ 8 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ),  LoaArt( cCodArt, aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage,  nMode, .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. oUser():lModificaUnidades() )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ),  LoaArt( cCodArt, aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage,  nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 141, )









      aGet[ 11 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )












      aGet[ 73 ] := TGetHlp():ReDefine( 156, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 73 ] >= 1 .AND. aTmp[ 73 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )}, {|nKey,nFlags,Self| (  changeTarifa( aTmp, aGet, aTmpPre ), loadComisionAgente( aTmp, aGet, aTmpPre ), recalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,, {||      1}, {||      6},, nil,,, )





      if aTmp[ 68 ]









         aGet[ 67 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )

      end









      aGet[ 13 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 351, )









      aGet[12] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],, cPpvDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 152, )





      aGet[ 29 ] := TGetHlp():ReDefine( 295, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )





      aGet[ 19 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )




      aGet[ 20 ] := TGetHlp():ReDefine( 175, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )





      aGet[ 63 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 63 ], aTmp[ 63 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin)},, .F., .F.,,,,,, nil,,, )





      aGet[ 64 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )




      aGet[ 82 ] := TGetHlp():ReDefine( 460, { | u | If( PCount()==0, aTmp[ 82 ], aTmp[ 82 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[14] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[14], aTmp[14]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 15 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 16 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )

      if !aTmp[ 68 ]





      oComisionLinea := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, nComisionLinea, nComisionLinea:= u ) }, oFld:aDialogs[ 1 ],, cPorDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      end











      aGet[30] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[30], aTmp[30]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) .AND. aTmp[30] >= 0 )}, ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ),,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,, {||      0},,, nil,, 261, )





      oTotal := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nTotPre, nTotPre:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 50 ] := TGetHlp():ReDefine( 205, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oTipArt:Existe( aGet[ 50 ], oGet3 ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( oTipArt:Buscar( aGet[ 50 ] ) )}, nil, "LUPA",, )





      oGet3 := TGetHlp():ReDefine( 206, { | u | If( PCount()==0, cGet3, cGet3:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )












      aGet[36] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[36], aTmp[36]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[36], , oSayAlm ), if( !uFieldEmpresa( "lNStkAct" ), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct ), .T. ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[36], oSayAlm ) )}, nil, "LUPA",, )




      oSayAlm := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSayAlm, cSayAlm:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ 85 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 85 ], aTmp[ 85 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[ 85 ], aGet[ 85 ]:oHelpText, aTmpPre[ 6 ], dbfObrasT ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwObras( aGet[ 85 ], aGet[ 85 ]:oHelpText, aTmpPre[ 6 ], dbfObrasT ) )}, nil, "LUPA",, 331 )





      oStkAct := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, nStkAct, nStkAct:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 88 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 88 ], aTmp[ 88 ]:= u ) }, oFld:aDialogs[2],, "9999",, "N/W*",,,,, .F., {||     ( nMode == 1 )},, .F., .T.,,,,,, nil,,, )




      aGet[24] := TCheckBox():ReDefine( 110, { | u | If( PCount()==0, aTmp[24], aTmp[24]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[21] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[21], aTmp[21]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[9] := TCheckBox():ReDefine( 130, { | u | If( PCount()==0, aTmp[9], aTmp[9]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 34 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,, 321, )




      aGet[ 35 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[2],, cPouDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )







      aGet[ 57 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( ChgBmp( aGet[ 57 ], bmpImage ) ) }, .F., .F.,,,,, {|Self|( GetBmp( aGet[ 57 ], bmpImage ) )}, nil, "LUPA",, )











      aGet[ 52 ] := TGetHlp():ReDefine( ( 150 ), { | u | If( PCount()==0, aTmp[ 52 ], aTmp[ 52 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( oSayGrp:cText( RetFld( aTmp[ 52  ], oGrpFam:GetAlias() ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oGrpFam:Buscar( aGet[ 52 ] ) )}, nil, "LUPA",, )




      oSayGrp := TGetHlp():ReDefine( ( 151 ), { | u | If( PCount()==0, cSayGrp, cSayGrp:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ 51 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSayFam:cText( RetFld( aTmp[ 51  ], dbfFamilia ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFamilia( aGet[ 51 ], oSayFam ) )}, nil, "LUPA",, )




      oSayFam := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSayFam, cSayFam:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||         ( .F. )},, .F., .F.,,,,,, nil,,, )




      oRentLin := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, cRentLin, cRentLin:= u ) }, oFld:aDialogs[2],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,, 301, )








      aGet[ 55 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( cProvee( aGet[ 55 ], dbfProvee, aGet[ 55 ]:oHelpText ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProvee( aGet[ 55 ], aGet[ 55 ]:oHelpText ) )}, nil, "LUPA",, 201 )




      aGet[ 44 ] := TCheckBox():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 45 ] := TCheckBox():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 33 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )





      aGet[ 54 ] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      aGet[ 77 ] := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )












      aGet[ 89 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 89 ], aTmp[ 89 ]:= u ) }, oFld:aDialogs[4],,, {||    ( oCentroCoste:Existe( aGet[ 89 ], aGet[ 89 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 89 ] ) )}, nil, "LUPA",, 411 )






      oTipoCtrCoste := TComboBox():ReDefine( 140, { | u | If( PCount()==0, cTipoCtrCoste, cTipoCtrCoste:= u ) }, aTipoCtrCoste, oFld:aDialogs[4],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oTipoCtrCoste",,,,,,, )

         oTipoCtrCoste:bChange   := {|| clearGet( aGet[ 91 ] ), loadGet( aGet[ 91 ], cTipoCtrCoste ) }







      aGet[ 91 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 91 ], aTmp[ 91 ]:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 160 )





      bmpImage := TBitmap():ReDefine( 220,, ( cFileBitmap( cPatImg(), aTmp[ 57 ] ) ), oDlg,, { |nRow,nCol,nKeyFlags| ( bmpImage:lStretch := !bmpImage:lStretch, bmpImage:Refresh() ) }, .F., .F.,,, .F.,,, .F. )

         bmpImage:SetColor( , GetSysColor( 15 ) )









      oBtn := TButton():ReDefine( 1, {||( SaveDeta( cCodArt, aTmp, aTmpPre, aGet, oDlg, oBrw, bmpImage, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, oBtn, oFld ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( ChmHelp( "Añadir_v" ) )}, oDlg,,, .F.,,,, .F. )



      if nMode <> 3
         if uFieldEmpresa( "lGetLot")
            oDlg:AddFastKey( 13,   {|| if( !Empty( aGet[ 4 ] ), aGet[ 4 ]:lValid(), ), oBtn:SetFocus(), oBtn:Click() } )
         end
         oDlg:AddFastKey( 116,          {|| oBtn:SetFocus(), oBtn:Click() } )
      end

      oDlg:AddFastKey( 112, {|| ChmHelp( "Añadir_v" ) } )




      oDlg:bStart := {||   SetDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, aTmpPre, oRentLin, oFld ), if( !Empty( cCodArtEnt ), aGet[ 4 ]:lValid(), ), loadGet( aGet[ 91 ], cTipoCtrCoste ), aGet[ 91 ]:lValid(), aGet[ 18 ]:lValid(), aGet[ 55 ]:lValid(), aGet[ 85 ]:lValid() }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|( RecalculaLinea( aTmp, aTmpPre, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

RETURN ( oDlg:nResult == 1 )







STATIC FUNCTION SetDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, aTmpPre, oRentLin, oFld )

   local cCodArt        := Left( aGet[ 4 ]:VarGet(), 18 )

   if !uFieldEmpresa( "lUseBultos" )
      aGet[ 81 ]:Hide()
   else
      if !Empty( aGet[ 81 ] )
         aGet[ 81 ]:SetText( uFieldempresa( "cNbrBultos" ) )
      end
   end

   if aGet[ 7 ] <> nil
      if !lUseCaj()
         aGet[ 7 ]:hide()
      else
         aGet[ 7 ]:SetText( cNombreCajas() )
      end
   end

   if aGet[ 8 ] <> nil
      aGet[ 8 ]:SetText( cNombreUnidades() )
   end

   if aGet[ 39 ] <> nil
      if !uFieldEmpresa( "lUseImp" )
         aGet[ 39 ]:Hide()
      else
         if !uFieldEmpresa( "lModImp" )
            aGet[ 39 ]:Disable()
         end
      end
   end

   if aGet[ 13 ] <> nil
      if !uFieldEmpresa( "lUsePor" )
         aGet[ 13 ]:Hide()
      end
   end

   if aGet[ 12 ] <> nil
      if !uFieldEmpresa( "lUsePnt" ) .OR. !aTmpPre[ 80 ]
         aGet[ 12 ]:Hide()
      end
   end

   if aGet[ 30 ] <> nil
      if !uFieldEmpresa( "lDtoLin" )
         aGet[ 30 ]:Hide()
      end
   end

   if oRentLin <> nil .AND. RolesModel():getRolNoMostrarRentabilidad( Auth():rolUuid() )
      oRentLin:Hide()
   end

   if aTmp[ 68 ]
      aGet[ 11 ]:Hide()
      aGet[ 67 ]:Show()
   end

   do case
   case nMode == 1

      aGet[ 4    ]:cText( Space( 200 ) )

      aTmp[ 37 ]  := aTmpPre[ 52 ]
      aTmp[ 32 ]  := nLastNum( dbfTmpLin )

      if aGet[ 88 ] <> nil
         aGet[ 88 ]:cText( nLastNum( dbfTmpLin, "nPosPrint" ) )
      end

      aGet[ 7  ]:cText( 1 )
      aGet[ 8 ]:cText( 1 )
      aGet[ 36  ]:cText( aTmpPre[ 17 ] )
      aGet[ 5 ]:show()

      if aGet[ 22 ] <> nil
         aGet[ 22 ]:hide()
      end

      if aGet[ 42 ] <> nil
         aGet[ 42 ]:hide()
      end

      if !Empty( aGet[ 80 ] )
         aGet[ 80 ]:Hide()
      end

      if aTmpPre[ 51 ] <= 2
         if !empty( aGet[ 6 ] )
            aGet[ 6 ]:cText( nIva( dbfIva, cDefIva() ) )
         else
            aTmp[ 6 ]  := nIva( dbfIva, cDefIva() )
         end

         aTmp[ 53 ]     := nReq( dbfIva, cDefIva() )
      end

      if !empty( aGet[ 89 ] )
         aGet[ 89 ]:cText( aTmpPre[ 86 ] )
         aGet[ 89 ]:lValid()
      endif

      cTipoCtrCoste        := "Centro de coste"
      oTipoCtrCoste:Refresh()
      clearGet( aGet[ 91 ] )

   case nMode <> 1 .AND. Empty( cCodArt )

      aGet[ 4     ]:hide()
      aGet[ 5 ]:hide()

      if aGet[ 22 ] <> nil
         aGet[ 22 ]:show()
      end

      if aGet[ 42 ] <> nil
         aGet[ 42 ]:hide()
      end

      if !Empty( aGet[ 80 ] )
         aGet[ 80 ]:Hide()
      end

   case nMode <> 1 .AND. !Empty( cCodArt )

      aGet[ 4     ]:show()
      aGet[ 5 ]:show()
      aGet[ 22  ]:hide()

      if !Empty( aGet[ 42 ] )
         if aTmp[ 40 ]
            aGet[ 42 ]:Show()
         else
            aGet[ 42 ]:Hide()
        end
      end



      if ( !empty( aTmp[ 25 ] ) .OR. !empty( aTmp[ 26 ] ) ) .AND. ( uFieldEmpresa( "lUseTbl" ) )

         setPropertiesTable( cCodArt, aTmp[ 25 ], aTmp[ 26 ], 0, aGet[ 8 ], oBrwProperties, nView )

         setValuesPropertiesTable( dbfTmpLin, oBrwProperties )

      end

      if !empty( oStkAct )
         StocksModel():lPutStockActual( cCodArt, aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct )
      end

   end

   if !empty( aGet[ 89 ] )
      aGet[ 89 ]:lValid()
   endif

   if !Empty( oStkAct )

      if !uFieldEmpresa( "lNStkAct" )
         oStkAct:Show()
      else
         oStkAct:Hide()
      end

   end

   if !aTmp[ 68 ]

      if !Empty( aTmp[ 25 ] )

         if !Empty( aGet[27 ] )
            aGet[ 27 ]:Show()
            aGet[ 27 ]:lValid()
         end
         if !Empty( oSayPr1 )
            oSayPr1:Show()
            oSayPr1:SetText( retProp( aTmp[25], dbfPro ) )
         end
         if !Empty( oSayVp1 )
            oSayVp1:Show()
         end

      else

         if !Empty( aGet[27 ] )
            aGet[27 ]:hide()
         end
         if !Empty( oSayPr1 )
            oSayPr1:hide()
         end
         if !Empty( oSayVp1 )
            oSayVp1:hide()
         end

      end

      if !Empty( aTmp[ 26 ] )

         if !Empty( aGet[28 ] )
            aGet[ 28 ]:Show()
            aGet[ 28 ]:lValid()
         end

         if !Empty( oSayPr2 )
            oSayPr2:Show()
            oSayPr2:SetText( retProp(  aTmp[ 26 ], dbfPro ) )
         end

         if !Empty( oSayVp2 )
            oSayVp2:Show()
         end

      else

         if !Empty( aGet[ 28 ] )
            aGet[ 28 ]:hide()
         end

         if !Empty( oSayPr2 )
            oSayPr2:hide()
         end

         if !Empty( oSayVp2 )
            oSayVp2:hide()
         end

      end

   end





   if Empty( aTmp[ 73 ] )
      if !Empty( aGet[ 73 ] )
         aGet[ 73 ]:cText( oGetTarifa:getTarifa() )
      else
         aTmp[ 73 ]     := oGetTarifa:getTarifa()
      end
   end

   if !Empty( aGet[ 73 ] )
      if !uFieldEmpresa( "lPreLin" )
         aGet[ 73 ]:Hide()
      else
         aGet[ 73 ]:Show()
      end
   end





   if aGet[ 36 ] <> nil
      aGet[ 36 ]:lValid()
   end

   if RolesModel():getRolNoVerPreciosCosto( Auth():rolUuid() )

      if !Empty( aGet[ 34 ] )
         aGet[ 34 ]:Hide()
      end

   end





   if ( empty( aTmp[ 11 ] ) .OR. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) ) .AND. nMode <> 3

      aGet[ 11 ]:HardEnable()
      aGet[ 14    ]:HardEnable()
      aGet[ 15 ]:HardEnable()

      if aGet[ 13 ] <> nil
         aGet[ 13 ]:HardEnable()
      end

      if aGet[ 12 ] <> nil
         aGet[ 12 ]:HardEnable()
      end

      if aGet[ 30 ] <> nil
         aGet[ 30 ]:HardEnable()
      end

   else

      aGet[ 11 ]:HardDisable()
      aGet[ 14    ]:HardDisable()
      aGet[ 15 ]:HardDisable()

      if aGet[ 13 ] <> nil
         aGet[ 13 ]:HardDisable()
      end

      if aGet[ 12 ] <> nil
         aGet[ 12 ]:HardDisable()
      end

      if aGet[ 30 ] <> nil
         aGet[ 30 ]:HardDisable()
      end

   end



   if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
      aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
      aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
      aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
   end

   if oUndMedicion:oDbf:Seek(  aTmp[ 18 ] )

      if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end



   if !Empty( oFld )
      oFld:SetOption( 1 )
   end



   if !empty(oBrwProperties)
      oBrwProperties:Hide()
      oBrwProperties:Cargo    := nil
   end

   if !Empty( oGetCelda )
      oGetCelda:hide()
   end



   aGet[ 4 ]:SetFocus()

Return nil



STATIC FUNCTION SaveDeta( cCodArt, aTmp, aTmpPre, aGet, oDlg2, oBrw, bmpImage, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, oBtn, oFld )

   local n
   local i
   local aClo
   local nRec
   local aXbyStr              := { 0, 0 }
   local hAtipica
   local nPrecioPropiedades   := 0
   local nNumeroLinea         := 0
   local nPosicionLinea       := 0





   oBtn:SetFocus()

   if !aGet[ 4 ]:lValid()
      return nil
   end





   if !cAlmacen( aGet[ 36 ], dbfAlm )
      return nil
   end

   if Empty( aTmp[ 36 ] ) .AND. !Empty( aTmp[ 4 ] )
      msgStop( "Código de almacén no puede estar vacío", "Atención" )
      return nil
   end

   SysRefresh()



   if lPrecioMinimo( aTmp[ 4 ], aTmp[ 11 ], nMode, D():Articulos( nView ) )
      msgStop( "El precio de venta es inferior al precio mínimo.")
      return nil
   end



   nRec                          := ( dbfTmpLin )->( RecNo() )

   aTmp[ 90 ]              := cTipoCtrCoste
   aTmp[ 53 ]                 := nPReq( dbfIva, aTmp[ 6 ] )

   aClo                          := aClone( aTmp )

   if nMode == 1

      if aTmp[ 40 ]
         saveLoteActual( aTmp[ 4 ], aTmp[ 42 ], nView )
      end



      if !empty( oBrwProperties:Cargo )

         for n := 1 to len( oBrwProperties:Cargo )

            for i := 1 to len( oBrwProperties:Cargo[ n ] )

               if !Empty( oBrwProperties:Cargo[ n, i ] )

                  if isNum( oBrwProperties:Cargo[ n, i ]:Value ) .AND. oBrwProperties:Cargo[ n, i ]:Value <> 0

                     if empty(nNumeroLinea)
                        nNumeroLinea      := nLastNum( dbfTmpLin )
                     end

                     if empty(nPosicionLinea)
                        nPosicionLinea    := nLastNum( dbfTmpLin, "nPosPrint" )
                     end

                     aTmp[ 32 ]     := nNumeroLinea
                     aTmp[ 88 ]   := nPosicionLinea
                     aTmp[ 8]     := oBrwProperties:Cargo[ n, i ]:Value
                     aTmp[ 25 ]     := oBrwProperties:Cargo[ n, i ]:cCodigoPropiedad1
                     aTmp[ 26 ]     := oBrwProperties:Cargo[ n, i ]:cCodigoPropiedad2
                     aTmp[ 27 ]     := oBrwProperties:Cargo[ n, i ]:cValorPropiedad1
                     aTmp[ 28 ]     := oBrwProperties:Cargo[ n, i ]:cValorPropiedad2



                     nPrecioPropiedades   := nPrePro( aTmp[ 4 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ], aTmp[ 73 ], aTmpPre[ 52 ], dbfArtDiv, dbfTarPreL, aTmpPre[ 16 ] )
                     if !empty(nPrecioPropiedades)
                        aTmp[ 11 ]  := nPrecioPropiedades
                     end

                     saveDetail( aTmp, aClo, aGet, aTmpPre, dbfTmpLin, oBrw, nMode )

                  end

               end

            next

         next

      else

         saveDetail( aTmp, aClo, aGet, aTmpPre, dbfTmpLin, oBrw, nMode )

      end

   else

      WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

   end

   ( dbfTmpLin )->( dbGoTo( nRec ) )





   cOldCodArt                          := ""
   cOldUndMed                          := ""





   if bmpImage <> nil
      bmpImage:Hide()

      if !empty( bmpImage:hBitmap )
         PalBmpFree( bmpImage:hBitmap, bmpImage:hPalette )
      endif

   end

   if nMode == 1 .AND. lEntCon()

      nTotPreCli( nil, D():PresupuestosClientes( nView ), dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmpPre )

      aCopy( dbBlankRec( dbfTmpLin ), aTmp )
      aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      SetDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, aTmpPre, , oFld )

      SysRefresh()

   else

      oDlg2:end( 1 )

   end

RETURN NIL



Static Function saveDetail( aTmp, aClo, aGet, aTmpPre, dbfTmpLin, oBrw, nMode )

   local hAtipica
   local sOfertaArticulo
   local nCajasGratis         := 0
   local nUnidadesGratis      := 0



   hAtipica                   := hAtipica( hValue( aTmp, aTmpPre ) )
   if !empty( hAtipica )

      if hhaskey( hAtipica, "nCajasGratis" ) .AND. hget( hAtipica, "nCajasGratis" ) <> 0
         nCajasGratis         := hget( hAtipica, "nCajasGratis" )
      end
      if hhaskey( hAtipica, "nUnidadesGratis" ) .AND. hget( hAtipica, "nUnidadesGratis" ) <> 0
         nUnidadesGratis      := hget( hAtipica, "nUnidadesGratis" )
      end
   end



   if empty( nCajasGratis ) .AND. empty( nUnidadesGratis )

      sOfertaArticulo         := structOfertaArticulo( D():getHashArray( aTmpPre, "PreCliT", nView ), D():getHashArray( aTmp, "PreCliL", nView ), nTotLPreCli( aTmp ), nView )
      if !empty( sOfertaArticulo )
         nCajasGratis         := sOfertaArticulo:nCajasGratis
         nUnidadesGratis      := sOfertaArticulo:nUnidadesGratis
      end
   end



   if nCajasGratis <> 0
      aTmp[ 78 ]        := .T.
      aTmp[ 7 ]        -= nCajasGratis

      commitDetail( aTmp, aClo, nil, aTmpPre, dbfTmpLin, oBrw, nMode, .F. )

      aTmp[ 78 ]        := .T.
      aTmp[ 7 ]        := nCajasGratis
      aTmp[ 11 ]        := 0
      aTmp[ 14    ]        := 0
      aTmp[ 30 ]        := 0
      aTmp[ 15 ]        := 0
      aTmp[ 16 ]        := 0
   end



   if nUnidadesGratis <> 0
      aTmp[ 78 ]        := .T.
      aTmp[ 8]        -= nUnidadesGratis

      commitDetail( aTmp, aClo, nil, aTmpPre, dbfTmpLin, oBrw, nMode, .F. )

      aTmp[ 78 ]        := .T.
      aTmp[ 8]        := nUnidadesGratis
      aTmp[ 11 ]        := 0
      aTmp[ 14    ]        := 0
      aTmp[ 30 ]        := 0
      aTmp[ 15 ]        := 0
      aTmp[ 16 ]        := 0
   end

   commitDetail( aTmp, aClo, aGet, aTmpPre, dbfTmpLin, oBrw, nMode, .T. )

Return nil



Static Function commitDetail( aTmp, aClo, aGet, aTmpPre, dbfTmpLin, oBrw, nMode, lEmpty )

   winGather( aTmp, aGet, dbfTmpLin, oBrw, nMode, nil, .F. )

   appendAsociado( aClo, aTmpPre )

   if ( nMode == 1 ) .AND. ( aClo[ 43 ] )
      appendKit( aClo, aTmpPre )
   end

Return nil



STATIC FUNCTION appendAsociado( uTmpLin, aTmpPre )

   local cCodArt
   local cSerPre
   local nNumPre
   local cSufPre
   local nCanEnt
   local dFecPre
   local cTipMov
   local cAlmLin
   local nIvaLin
   local lIvaLin
   local nComAge
   local nUniCaj
   local nDtoGrl
   local nDtoPrm
   local nDtoDiv
   local cNumPed
   local nTarLin
   local nRecAct                       := ( ( D():Asociado( nView ) ) )->( RecNo() )
   local nRecLin                       := ( dbfTmpLin )->( RecNo() )
   local nNumLin                       := ( dbfTmpLin )->nNumLin
   local nPosPrint
   local nUnidades                     := 0
   local nStkActual                    := 0
   local nStockMinimo                  := 0
   local nOrdAnt                       := ( D():Asociado( nView ) )->( OrdSetFocus( "cCodArt" ) )

   if isArray( uTmpLin )
      cCodArt                          := uTmpLin[ 4    ]
      cSerPre                          := uTmpLin[ 1 ]
      nNumPre                          := uTmpLin[ 2 ]
      cSufPre                          := uTmpLin[ 3 ]
      nCanEnt                          := uTmpLin[ 17 ]
      dFecPre                          := uTmpLin[ 21  ]
      cTipMov                          := uTmpLin[ 31 ]
      cAlmLin                          := uTmpLin[ 36 ]
      nIvaLin                          := uTmpLin[ 6    ]
      lIvaLin                          := uTmpLin[ 37 ]
      nComAge                          := uTmpLin[ 16 ]
      nUniCaj                          := uTmpLin[ 8]
      nDtoGrl                          := uTmpLin[ 14    ]
      nDtoPrm                          := uTmpLin[ 15 ]
      nDtoDiv                          := uTmpLin[ 30 ]
      nNumLin                          := uTmpLin[ 32 ]
      nPosPrint                        := uTmpLin[ 88 ]
      nTarLin                          := uTmpLin[ 73 ]
   else
      cCodArt                          := ( uTmpLin )->cRef
      cSerPre                          := ( uTmpLin )->cSerPre
      nNumPre                          := ( uTmpLin )->nNumPre
      cSufPre                          := ( uTmpLin )->cSufPre
      nCanEnt                          := ( uTmpLin )->nCanEnt
      dFecPre                          := ( uTmpLin )->dFecha
      cTipMov                          := ( uTmpLin )->cTipMov
      cAlmLin                          := ( uTmpLin )->cAlmLin
      nIvaLin                          := ( uTmpLin )->nIva
      lIvaLin                          := ( uTmpLin )->lIvaLin
      nComAge                          := ( uTmpLin )->nComAge
      nUniCaj                          := ( uTmpLin )->nUniCaja
      nDtoGrl                          := ( uTmpLin )->nDto
      nDtoPrm                          := ( uTmpLin )->nDtoPrm
      nDtoDiv                          := ( uTmpLin )->nDtoDiv
      nNumLin                          := ( uTmpLin )->nNumLin
      nPosPrint                        := ( uTmpLin )->nPosPrint
      nTarLin                          := ( uTmpLin )->nTarLin
   end





   if ( D():Asociado( nView ) )->( dbSeek( cCodArt ) )

      while ( D():Asociado( nView ) )->cCodArt == cCodArt .AND. !( D():Asociado( nView ) )->( eof() )

         if ( D():Articulos( nView ) )->( dbSeek( ( D():Asociado( nView ) )->cRefAsc ) )

            ( dbfTmpLin )->( dbAppend() )

            ( dbfTmpLin )->nNumLin     := nNumLin
            ( dbfTmpLin )->nPosPrint   := nPosPrint

            ( dbfTmpLin )->cRef        := ( D():Asociado( nView ) )->cRefAsc
            ( dbfTmpLin )->cDetalle    := ( D():Articulos( nView ) )->Nombre
            ( dbfTmpLin )->nPntVer     := ( D():Articulos( nView ) )->nPntVer1
            ( dbfTmpLin )->nPesokg     := ( D():Articulos( nView ) )->nPesoKg
            ( dbfTmpLin )->cPesokg     := ( D():Articulos( nView ) )->cUndDim
            ( dbfTmpLin )->cUnidad     := ( D():Articulos( nView ) )->cUnidad
            ( dbfTmpLin )->nVolumen    := ( D():Articulos( nView ) )->nVolumen
            ( dbfTmpLin )->cVolumen    := ( D():Articulos( nView ) )->cVolumen
            ( dbfTmpLin )->nCtlStk     := ( D():Articulos( nView ) )->nCtlStock
            ( dbfTmpLin )->nPvpRec     := ( D():Articulos( nView ) )->PvpRec
            ( dbfTmpLin )->cCodImp     := ( D():Articulos( nView ) )->cCodImp
            ( dbfTmpLin )->lLote       := ( D():Articulos( nView ) )->lLote
            ( dbfTmpLin )->cLote       := ( D():Articulos( nView ) )->cLote

            ( dbfTmpLin )->nCosDiv     := nCosto( nil, D():Articulos( nView ), dbfKit, , , , aTmpPre[ 6 ] )





            ( dbfTmpLin )->cCodFam     := ( D():Articulos( nView ) )->Familia
            ( dbfTmpLin )->cGrpFam     := cGruFam( ( dbfTmpLin )->cCodFam, D():Familias( nView ) )





            ( dbfTmpLin )->cSerPre     := cSerPre
            ( dbfTmpLin )->nNumPre     := nNumPre
            ( dbfTmpLin )->cSufPre     := cSufPre
            ( dbfTmpLin )->nCanEnt     := nCanEnt
            ( dbfTmpLin )->dFecha      := dFecPre
            ( dbfTmpLin )->cTipMov     := cTipMov
            ( dbfTmpLin )->cAlmLin     := cAlmLin
            ( dbfTmpLin )->lIvaLin     := lIvaLin





            ( dbfTmpLin )->nUniCaja    := nUniCaj * ( D():Asociado( nView ) )->nUndAsc





            ( dbfTmpLin )->nIva     := nIva( D():Get( "TIva", nView ), ( D():Articulos( nView ) )->TipoIva )
            ( dbfTmpLin )->nReq     := nReq( D():Get( "TIva", nView ), ( D():Articulos( nView ) )->TipoIva )





            ( dbfTmpLin )->nPreDiv := nRetPreArt( nTarLin, aTmpPre[ 46 ], aTmpPre[ 52 ], D():Articulos( nView ), D():Get( "Divisas", nView ), dbfKit, D():Get( "TIva", nView ), , , oNewImp )





            ( dbfTmpLin )->nCtlStk  := ( D():Articulos( nView ) )->nCtlStock

         end

         ( D():Asociado( nView ) )->( dbSkip() )

      end

   end

   ( D():Asociado( nView ) )->( OrdSetFocus( nOrdAnt ) )
   ( D():Asociado( nView ) )->( dbGoTo( nRecAct ) )
   ( dbfTmpLin )->( dbGoTo( nRecLin ) )

RETURN NIL



Static Function EdtInc( aTmp, aGet, dbfPreCliI, oBrw, bWhen, bValid, nMode, aTmpPre )

   local oDlg

   if nMode == 1
      aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]  := .T.
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de presupuestos a clientes", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )



Static Function EdtEst( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpPre )

      local oDlg

      if nMode == 1

         aTmp[ ( D():PresupuestosClientesSituaciones( nView ) )->( fieldpos( "tFecSit" ) ) ]   := GetSysTime()

    end

      oDlg = TDialog():New(,,,, LblTitle( nMode ) + "Situación del documento del cliente", "SITUACION_ESTADO",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






         aGet[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("cSitua")) ] := TComboBox():ReDefine( 200, { | u | If( PCount()==0, aTmp[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("cSitua")) ], aTmp[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("cSitua")) ]:= u ) }, ( SituacionesModel():getArrayNombres() ), oDlg,,,,,,, .F., {||     ( nMode <> 3 )},,,,,, 'aGet[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("cSitua")) ]',,,,,,, )







         aGet[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("dFecSit")) ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("dFecSit")) ], aTmp[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("dFecSit")) ]:= u ) }, oDlg,,,,,,,,, .F., {||  ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("dFecSit")) ]:cText( Calendario( aTmp[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("dFecSit")) ] ) )}, nil,,, )









         aGet[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("tFecSit")) ] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("tFecSit")) ], aTmp[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("tFecSit")) ]:= u ) }, oDlg,, "@R 99:99:99", {||    ( iif( !validTime( aTmp[ (D():PresupuestosClientesSituaciones( nView ))->(fieldpos("tFecSit")) ] ), ( msgStop( "El formato de la hora no es correcto" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





         TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpEst, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





         TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpEst, oBrw, nMode ), oDlg:end( 1 ) } )
      end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( .T. )




Static Function EdtDoc( aTmp, aGet, dbfPreCliD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de presupuesto a cliente", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



STATIC FUNCTION PrnSerie()

    local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local cSerIni     := ( D():PresupuestosClientes( nView ) )->cSerPre
   local cSerFin     := ( D():PresupuestosClientes( nView ) )->cSerPre
   local nDocIni     := ( D():PresupuestosClientes( nView ) )->nNumPre
   local nDocFin     := ( D():PresupuestosClientes( nView ) )->nNumPre
   local cSufIni     := ( D():PresupuestosClientes( nView ) )->cSufPre
   local cSufFin     := ( D():PresupuestosClientes( nView ) )->cSufPre
   local oPrinter
   local cPrinter    := ImpresoraDefectoUsuario()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local dFecDesde   := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dFecHasta   := Date()
   local oRango
   local nRango      := 1
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( D():PresupuestosClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) )

   if Empty( cFmtDoc )
      cFmtDoc           := cSelPrimerDoc( "RC" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de presupuestos", "IMPSERIES",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



   oRango := TRadMenu():Redefine( { | u | If( PCount()==0, nRango, nRango:= u ) }, oDlg,, { 201, 202 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 210, { | u | If( PCount()==0, dFecDesde, dFecDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 220, { | u | If( PCount()==0, dFecHasta, dFecHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, D():Documentos( nView ) ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "RC" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "gc_document_text_pencil_12",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "gc_printer2_check_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, nil, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, nil, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) } )

   oDlg:bStart := { || oSerIni:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

    oWndBrw:oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta )

   local nCopyClient
   local nRecno
   local nOrdAnt

   oDlg:disable()

   if nRango == 1

      nRecno      := ( D():PresupuestosClientes( nView ) )->( recno() )
      nOrdAnt     := ( D():PresupuestosClientes( nView ) )->( OrdSetFocus( "nNumPre" ) )

      if ! lInvOrden

         if ( D():PresupuestosClientes( nView ) )->( dbSeek( cDocIni, .T. ) )



            while ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre >= cDocIni   .AND.  ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre <= cDocFin   .AND.  !( D():PresupuestosClientes( nView ) )->( Eof() )

                  lChgImpDoc( D():PresupuestosClientes( nView ) )

               if lCopiasPre

                  nCopyClient := if( nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( D():PresupuestosClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) )

                  GenPreCli( 1, "Imprimiendo documento : " + ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, cFmtDoc, cPrinter, nCopyClient )

               else

                  GenPreCli( 1, "Imprimiendo documento : " + ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, cFmtDoc, cPrinter, nNumCop )

               end

               ( D():PresupuestosClientes( nView ) )->( dbSkip() )

            end

         end

      else

         if ( D():PresupuestosClientes( nView ) )->( dbSeek( cDocFin ) )



            while ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre >= cDocIni   .AND. ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre <= cDocFin   .AND. !( D():PresupuestosClientes( nView ) )->( Bof() )

                  lChgImpDoc( D():PresupuestosClientes( nView ) )

               if lCopiasPre

                  nCopyClient := if( nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( D():PresupuestosClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) )

                  GenPreCli( 1, "Imprimiendo documento : " + ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, cFmtDoc, cPrinter, nCopyClient )

               else

                  GenPreCli( 1, "Imprimiendo documento : " + ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, cFmtDoc, cPrinter, nNumCop )

               end

               ( D():PresupuestosClientes( nView ) )->( dbSkip( -1 ) )

            end

         end

      end

   else

      nRecno      := ( D():PresupuestosClientes( nView ) )->( recno() )
      nOrdAnt     := ( D():PresupuestosClientes( nView ) )->( OrdSetFocus( "dFecPre" ) )

      if ! lInvOrden

         ( D():PresupuestosClientes( nView ) )->( dbGoTop() )

         while !( D():PresupuestosClientes( nView ) )->( Eof() )

            if ( D():PresupuestosClientes( nView ) )->dFecPre >= dFecDesde .AND. ( D():PresupuestosClientes( nView ) )->dFecPre <= dFecHasta

               lChgImpDoc( D():PresupuestosClientes( nView ) )

               if lCopiasPre

                  nCopyClient := if( nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( D():PresupuestosClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) )

                  GenPreCli( 1, "Imprimiendo documento : " + ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, cFmtDoc, cPrinter, nCopyClient )

               else

                  GenPreCli( 1, "Imprimiendo documento : " + ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, cFmtDoc, cPrinter, nNumCop )

               end

            end

            ( D():PresupuestosClientes( nView ) )->( dbSkip() )

         end

      else

         ( D():PresupuestosClientes( nView ) )->( dbGobottom() )

         while !( D():PresupuestosClientes( nView ) )->( Bof() )

            if ( D():PresupuestosClientes( nView ) )->dFecPre >= dFecDesde .AND. ( D():PresupuestosClientes( nView ) )->dFecPre <= dFecHasta

               lChgImpDoc( D():PresupuestosClientes( nView ) )

               if lCopiasPre

                  nCopyClient := if( nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) == 0, Max( Retfld( ( D():PresupuestosClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) )

                  GenPreCli( 1, "Imprimiendo documento : " + ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, cFmtDoc, cPrinter, nCopyClient )

               else

                  GenPreCli( 1, "Imprimiendo documento : " + ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, cFmtDoc, cPrinter, nNumCop )

               end

            end

            ( D():PresupuestosClientes( nView ) )->( dbSkip( -1 ) )

         end

      end

   end

   ( D():PresupuestosClientes( nView ) )->( dbGoTo( nRecNo ) )
   ( D():PresupuestosClientes( nView ) )->( ordSetFocus( nOrdAnt ) )

   oDlg:enable()

RETURN NIL



STATIC FUNCTION RecalculaTotal( aTmp )

   nTotPreCli( nil, D():PresupuestosClientes( nView ), dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmp )





   if oBrwIva  <> nil
      oBrwIva:SetArray( aTotIva, , , .F. )
      oBrwIva:Refresh()
   end





   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPorDiv ) )
   end

   if oGetIvm <> nil
      oGetIvm:SetText( Trans( nTotIvm, cPorDiv ) )
   end

   if oGetRnt <> nil
      oGetRnt:cText( AllTrim( Trans( nTotRnt, cPorDiv ) + Space( 1 ) + AllTrim( cSimDiv( aTmp[ 46 ], dbfDiv ) ) + " : " + AllTrim( Trans( nPctRnt, "999.99" ) ) + "%" ) )
   end

   IF oGetIva <> nil
      oGetIva:SetText( Trans( nTotIva, cPorDiv ) )
   end

   if oGetReq <> nil
      oGetReq:SetText( Trans( nTotReq, cPorDiv ) )
   end

   if oGetPnt <> nil
      oGetPnt:SetText( Trans( nTotPnt, cPorDiv ) )
   end

   if oGetTrn <> nil
      oGetTrn:SetText( Trans( nTotTrn, cPorDiv ) )
   end

   if oGetTotal <> nil
      oGetTotal:SetText( Trans( nTotPre, cPorDiv ) )
   end

   if oGetAge <> nil
      oGetAge:SetText( Trans( nTotAge, cPorDiv ) )
   end

   if oGetPes <> nil
      oGetPes:cText( nTotPes )
   end

   if oGetDif <> nil
      oGetDif:cText( nTotDif )
   end

Return .T.



STATIC FUNCTION LoaArt( cCodArt, aTmp, aGet, aTmpPre, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, nMode, lFocused )

   local hHas128
   local cLote
    local nDtoAge
   local nImpAtp
   local nImpOfe
   local nCosPro
   local cCodFam
   local cPrpArt
   local cLotArt
   local nPrePro              := 0
   local nPosComa
   local cProveedor
   local nTarOld              := aTmp[ 73 ]
   local lChgCodArt           := ( Empty( cOldCodArt ) .OR. Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) )
   local nNumDto              := 0
   local hAtipica
   local nDescuentoArticulo
   local sOfertaArticulo

   If( lFocused == nil, lFocused := .T., ) ;

   if Empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

      if Empty( aTmp[ 6 ] )
         aGet[ 6 ]:bWhen     := {|| .T. }
      end

      aGet[ 5 ]:Hide()

      if !Empty( aGet[ 22 ] )
          aGet[ 22 ]:Show()
      end

      if lFocused .AND. !Empty( aGet[ 22 ] )
        aGet[ 22 ]:SetFocus()
      end

      if !empty( oBrwProperties )
         oBrwProperties:Hide()
      end

      if !Empty( oGetCelda )
         oGetCelda:hide()
      end

   else

      if lModIva()
         aGet[ 6 ]:bWhen     := {|| .T. }
      else
         aGet[ 6 ]:bWhen     := {|| .F. }
      end

        aGet[ 5 ]:show()

      if aGet[ 22 ] <> nil
         aGet[ 22 ]:hide()
      end



      if len( alltrim( cCodArt ) ) > 18

         hHas128                 := ReadHashCodeGS128( cCodArt )
         if !empty( hHas128 )

            cCodArt              := uGetCodigo( hHas128, "00" )

            if Empty( cCodArt )
               cCodArt           := uGetCodigo( hHas128, "01" )
            end

         end

      end

      cCodArt                    := cSeekCodebar( cCodArt, dbfCodebar, D():Articulos( nView ) )



      if ( D():Articulos( nView ) )->( dbSeek( cCodArt ) ) .OR. ( D():Articulos( nView ) )->( dbSeek( Upper( cCodArt ) ) )

         if ( D():Articulos( nView ) )->lObs
            MsgStop( "Artículo catalogado como obsoleto" )
            return .F.
         end

         if ( lChgCodArt )

            cCodArt              := ( D():Articulos( nView ) )->Codigo

            aGet[ 4 ]:cText( Padr( cCodArt, 200 ) )
            aTmp[ 4 ]        := cCodArt



            aTmp[ 86 ]     := ( D():Articulos( nView ) )->cRefAux
            aTmp[ 87 ]    := ( D():Articulos( nView ) )->cRefAux2

            if ( D():Articulos( nView ) )->lMosCom .AND. !Empty( ( D():Articulos( nView ) )->mComent )
               MsgStop( Trim( ( D():Articulos( nView ) )->mComent ) )
            end



            if !empty( aGet[ 55 ] )
               aGet[ 55 ]:cText( ( D():Articulos( nView ) )->cPrvHab )
               aGet[ 55 ]:lValid()
            else
               aTmp[ 55 ]  := ( D():Articulos( nView ) )->cPrvHab
            end

            aTmp[ 62 ]     := Padr( cRefPrvArt( aTmp[ 4 ], ( D():Articulos( nView ) )->cPrvHab , dbfArtPrv ), 18 )



            if ( D():Articulos( nView ) )->lLote

               if empty( cLote )
                  cLote          := ( D():Articulos( nView ) )->cLote
               end

               aTmp[ 40 ]    := ( D():Articulos( nView ) )->lLote

               if !empty( aGet[ 42 ] )

                  aGet[ 42 ]:Show()

                  if empty( aGet[ 42 ]:VarGet() ) .AND. uFieldempresa( "lLoaUltLot" )
                     aGet[ 42 ]:cText( cLote )
                     aGet[ 42 ]:lValid()
                  end

               else

                  if empty( aTmp[ 42 ] ) .AND. uFieldempresa( "lLoaUltLot" )
                     aTmp[ 42 ] := cLote
                  else
                     aTmp[ 42 ] := Space( 64 )
                  end

               end

            else

               if !empty( aGet[ 42 ] )
                  aGet[ 42 ]:Hide()
               end

               if !empty( aGet[ 80 ] )
                  aGet[ 80 ]:Hide()
               end

            end





            aTmp[ 47 ]     := ( D():Articulos( nView ) )->lMsgVta
            aTmp[ 48 ]     := ( D():Articulos( nView ) )->lNotVta

            cCodFam              := ( D():Articulos( nView ) )->Familia

            if !Empty( cCodFam )

               if aGet[ 51 ] <> nil
                  aGet[ 51 ]:cText( cCodFam )
                  aGet[ 51 ]:lValid()
               else
                  aTmp[ 51 ]  := cCodFam
               end

               if aGet[ 52 ] <> nil
                  aGet[ 52 ]:cText( cGruFam( cCodFam, dbfFamilia ) )
                  aGet[ 52 ]:lValid()
               else
                  aTmp[ 52 ]  := cGruFam( cCodFam, dbfFamilia )
               end

            else

               if aGet[ 51 ] <> nil
                  aGet[ 51 ]:cText( Space( 8 ) )
                  aGet[ 51 ]:lValid()
               end

               if aGet[ 52 ] <> nil
                  aGet[ 52 ]:cText( Space( 3 ) )
                  aGet[ 52 ]:lValid()
               end

            end





            if !Empty( aGet[ 77 ] )
               aGet[ 77 ]:cText( ( D():Articulos( nView ) )->Descrip )
            else
               aTmp[ 77 ]     := ( D():Articulos( nView ) )->Descrip
            end





            if ( D():Articulos( nView ) )->nBulEnt <> 0
               if !empty( aGet )
                  aGet[ 81 ]:cText( ( D():Articulos( nView ) )->nBulEnt )
               else
                  aTmp[ 81 ]  := ( D():Articulos( nView ) )->nBulEnt
               end
            end

            if ( D():Articulos( nView ) )->nCajEnt <> 0
               if  aGet[ 7 ] <> nil
                   aGet[ 7 ]:cText( ( D():Articulos( nView ) )->nCajEnt )
               else
                   aTmp[ 7 ] := ( D():Articulos( nView ) )->nCajEnt

               end
            end

            if ( D():Articulos( nView ) )->nUniCaja <> 0
               if aGet[ 8 ] <> nil
                  aGet[ 8 ]:cText( ( D():Articulos( nView ) )->nUniCaja )
               else
                  aTmp[ 8 ] := ( D():Articulos( nView ) )->nUniCaja
               end
            end





            if aTmpPre[ 51 ] <= 2

               if aGet[ 6 ] <> nil
                  aGet[ 6 ]:cText( nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva ) )
               else
                  aTmp[ 6 ]  := nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva )
               end

               aTmp[ 53 ]     := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )

            end

            if aGet[ 5 ] <> nil
               aGet[ 5 ]:cText( ( D():Articulos( nView ) )->Nombre )
            else
               aTmp[ 5 ] := ( D():Articulos( nView ) )->Nombre
            end

            if aGet[ 22 ] <> nil
               aGet[ 22 ]:cText( ( D():Articulos( nView ) )->Descrip )
            else
               aTmp[ 22 ]  := ( D():Articulos( nView ) )->Descrip
            end





            if ( D():Articulos( nView ) )->lKitArt
               aTmp[ 43 ]        := .T.
               aTmp[ 24 ]        := lImprimirCompuesto( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
               aTmp[ 45 ]        := lPreciosCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )

               if lStockCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
                  if aGet[ 33 ] <> nil
                     aGet[ 33 ]:SetOption( ( D():Articulos( nView ) )->nCtlStock )
                  else
                     aTmp[ 33 ]  := ( D():Articulos( nView ) )->nCtlStock
                  end
               else
                  if aGet[ 33 ] <> nil
                     aGet[ 33 ]:SetOption( 3 )
                  else
                     aTmp[ 33 ]  := 3
                  end
               end

            else

               aTmp[ 24 ]        := .F.
               if aGet[ 33 ] <> nil
                  aGet[ 33 ]:SetOption( ( D():Articulos( nView ) )->nCtlStock )
               else
                  aTmp[ 33 ]     := ( D():Articulos( nView ) )->nCtlStock
               end

            end



            aTmp[ 38 ]        := ( D():Articulos( nView ) )->cCodImp
            oNewImp:setCodeAndValue( aTmp[ 38 ], aGet[ 39 ] )

            if !Empty( ( D():Articulos( nView ) )->cCodImp )
               aTmp[ 79 ]     := RetFld( ( D():Articulos( nView ) )->cCodImp, oNewImp:oDbf:cAlias, "lIvaVol" )
            end



            aTmp[ 25 ]         := ( D():Articulos( nView ) )->cCodPrp1
            aTmp[ 26 ]         := ( D():Articulos( nView ) )->cCodPrp2

            if ( !empty( aTmp[ 25 ] ) .OR. !empty( aTmp[ 26 ] ) ) .AND. ( uFieldEmpresa( "lUseTbl" ) ) .AND. ( nMode == 1 )

               aGet[ 7  ]:cText( 0 )
               aGet[ 8 ]:cText( 0 )

               setPropertiesTable( cCodArt, aTmp[ 25 ], aTmp[ 26 ], 0, aGet[ 8 ], oBrwProperties, nView )

               if !Empty( oGetCelda )
                  oGetCelda:Show()
               end

            else

               hidePropertiesTable( oBrwProperties )

               if !Empty( oGetCelda )
                  oGetCelda:hide()
               end

               if !Empty( aTmp[ 25 ] )

                  if aGet[ 27 ] <> nil
                     aGet[ 27 ]:Show()
                     if lFocused
                        aGet[ 27 ]:SetFocus()
                     end
                  end

                  if oSayPr1 <> nil
                     oSayPr1:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp1, dbfPro ) )
                     oSayPr1:show()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:SetText( "" )
                     oSayVp1:Show()
                  end

               else

                  if aGet[ 27 ] <>  nil
                     aGet[ 27 ]:cText( Space( 20 ) )
                     aGet[ 27 ]:hide()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:Hide()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Hide()
                  end

               end

               if !Empty( aTmp[ 26 ] )

                  if aGet[ 28 ] <> nil
                     aGet[ 28 ]:show()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp2, dbfPro ) )
                     oSayPr2:Show()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:SetText( "" )
                     oSayVp2:Show()
                  end

               else

                  if aGet[ 28 ] <> nil
                     aGet[ 28 ]:cText( Space( 20 ) )
                     aGet[ 28 ]:hide()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:hide()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:hide()
                  end

               end

            end



            loadComisionAgente( aTmp, aGet, aTmpPre )



            if !Empty( aGet[ 19 ] )
               aGet[ 19  ]:cText( ( D():Articulos( nView ) )->nPesoKg )
            else
               aGet[ 19  ] := ( D():Articulos( nView ) )->nPesoKg
            end

            if !Empty( aGet[ 20 ] )
                aGet[ 20 ]:cText( ( D():Articulos( nView ) )->cUndDim )
            else
                aGet[ 20 ] := ( D():Articulos( nView ) )->cUndDim
            end

            if !Empty( aGet[ 63 ] )
               aGet[ 63 ]:cText( ( D():Articulos( nView ) )->nVolumen )
            else
               aGet[ 63 ] := ( D():Articulos( nView ) )->nVolumen
            end

            if !Empty( aGet[ 18 ] )
               aGet[ 18 ]:cText( ( D():Articulos( nView ) )->cUnidad )
               aGet[ 18 ]:lValid()
            else
               aTmp[ 18 ] := ( D():Articulos( nView ) )->cUnidad
            end

            if !Empty( aGet[ 64 ] )
               aGet[ 64 ]:cText( ( D():Articulos( nView ) )->cVolumen )
            else
               aTmp[ 64 ]:= ( D():Articulos( nView ) )->cVolumen
            end





            if ( D():Articulos( nView ) )->lFacCnv
               aTmp[ 29 ]     := ( D():Articulos( nView ) )->nFacCnv
            end





            if oStkAct <> nil .AND. !uFieldEmpresa( "lNStkAct" ) .AND. aTmp[ 33 ] <= 1
               StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct )
            end





            if !Empty( aGet[ 57 ] )
               aGet[ 57 ]:cText( ( D():Articulos( nView ) )->cImagen )
            else
               aTmp[ 57 ]     := ( D():Articulos( nView ) )->cImagen
            end

            if !Empty( bmpImage )
               if !Empty( aTmp[ 57 ] )
                  bmpImage:Show()
                  bmpImage:LoadBmp( cFileBitmap( cPatImg(), aTmp[ 57 ] ) )
               else
                  bmpImage:Hide()
               end
            end





            if aGet[ 50 ] <> nil
               aGet[ 50 ]:cText( ( D():Articulos( nView ) )->cCodTip )
            else
               aTmp[ 50 ]  := ( D():Articulos( nView ) )->cCodTip
            end

         end






         cPrpArt                 := aTmp[ 25 ] + aTmp[ 26 ] + aTmp[ 27 ] + aTmp[ 28 ]
         cLotArt                 := aTmp[ 42 ]

         if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt ) .OR. ( cLotArt <> cOldLotArt )

            if oStkAct <> nil .AND. !uFieldEmpresa( "lNStkAct" ) .AND. aTmp[ 33 ] <= 1
               StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct )
            end





            if nMode == 1
               cCodFam        := RetFamArt( aTmp[ 4 ], D():Articulos( nView ) )
            else
               cCodFam        := aTmp[ 51 ]
            end



            if !Empty( aGet[ 14 ] )
               aGet[ 14 ]:cText( 0 )
            else
               aTmp[ 14 ] := 0
            end

            if !Empty( aGet[ 30 ] )
               aGet[ 30 ]:cText( 0 )
            else
               aTmp[ 30 ] := 0
            end

            if !Empty( aGet[ 15 ] )
               aGet[ 15 ]:cText( 0 )
            else
               aTmp[ 15 ]:= 0
            end

            aTmp[ 78  ] := .F.





            if aGet[ 12 ] <> nil
               aGet[ 12 ]:cText( ( D():Articulos( nView ) )->nPntVer1 )
            else
               aTmp[ 12 ]  := ( D():Articulos( nView ) )->nPntVer1
            end

            aTmp[ 35 ]     := ( D():Articulos( nView ) )->PvpRec




            do case
               case uFieldEmpresa( "nCosVta" ) < 2

                  nCosPro           := oStock:nCostoMedio( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ] )

                  if nCosPro == 0
                     nCosPro        := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ), aTmpPre[ 6 ] )
                  end

               case uFieldEmpresa( "nCosVta" ) == 2

                  nCosPro           := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ), aTmpPre[ 6 ] )

               case uFieldEmpresa( "nCosVta" ) == 3

                  nCosPro           := MaterialesProducidosLineasModel():getCosto(  aTmp[ 4 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ] )

                  if nCosPro == 0
                     nCosPro        := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ), aTmpPre[ 6 ] )
                  end

            end










            if aGet[ 34 ] <> nil
               aGet[ 34 ]:cText( nCosPro )
            else
               aTmp[ 34 ]  := nCosPro
            end





            if uFieldempresa( "lDtoCliLin" )

               if !empty( aGet ) .AND. !empty( aGet[ 14 ] )
                  aGet[ 14 ]:cText( retFld( aTmpPre[ 6 ], D():Clientes( nView ), "nDtoEsp" ) )
                  aTmp[ 14 ]     := retFld( aTmpPre[ 6 ], D():Clientes( nView ), "nDtoEsp" )
               else
                  aTmp[ 14 ]     := retFld( aTmpPre[ 6 ], D():Clientes( nView ), "nDtoEsp" )
               end

            end



            nDescuentoArticulo   := nDescuentoArticulo( cCodArt, aTmpPre[ 6 ], nView )
            if nDescuentoArticulo <> 0
               if !Empty( aGet[ 14 ] )
                  aGet[ 14 ]:cText( nDescuentoArticulo )
               else
                  aTmp[ 14 ]  := nDescuentoArticulo
               end
            end



            if aTmp[ 14 ] == 0
               if !Empty( aGet[ 14 ] )
                  aGet[ 14 ]:cText( nDescuentoFamilia( cCodFam, D():Familias( nView ) ) )
               else
                  aTmp[ 14 ]     := nDescuentoFamilia( cCodFam, D():Familias( nView ) )
               end
            end



            if aTmp[ 14 ] == 0
               if !Empty( aGet[ 14 ] )
                  aGet[ 14 ]:cText( nDescuentoFamilia( cCodFam, dbfFamilia ) )
               else
                  aTmp[ 14 ]  := nDescuentoFamilia( cCodFam, dbfFamilia )
               end
            end



            if !Empty( aGet[ 18 ] )
               aGet[ 18 ]:cText( ( D():Articulos( nView ) )->cUnidad )
            else
               aTmp[ 18 ]  := ( D():Articulos( nView ) )->cUnidad
            end



            nPrePro           := nPrePro( aTmp[ 4 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ], aTmp[ 73 ], aTmpPre[ 52 ], dbfArtDiv, dbfTarPreL, aTmpPre[16] )

            if nPrePro == 0
               aGet[ 11 ]:cText( nRetPreArt( aTmp[ 73 ], aTmpPre[ 46 ], aTmpPre[52], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp ) )
            else
               aGet[ 11 ]:cText( nPrePro )
            end





            if !Empty( aTmpPre[ 16 ] )



               nImpOfe     := RetPrcTar( aTmp[ 4 ], aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL, aTmp[ 73 ] )
               if nImpOfe  <> 0
                  aGet[ 11 ]:cText( nImpOfe )
               end

               nImpOfe     := RetPctTar( aTmp[ 4 ], cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[ 14 ]:cText( nImpOfe )
               end

               nImpOfe     := RetLinTar( aTmp[ 4 ], cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[ 30 ]:cText( nImpOfe )
               end

               nImpOfe     := RetComTar( aTmp[ 4 ], cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpPre[14], dbfTarPreL, dbfTarPreS )
               if nImpOfe  <> 0
                  aGet[ 16 ]:cText( nImpOfe )
               end



               nImpOfe     := RetDtoPrm( aTmp[ 4 ], cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpPre[5], dbfTarPreL )
               if nImpOfe  <> 0
                  aGet[ 15 ]:cText( nImpOfe )
               end



               nDtoAge     := RetDtoAge( aTmp[ 4 ], cCodFam, aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpPre[5], aTmpPre[14], dbfTarPreL, dbfTarPreS )
               if nDtoAge  <> 0
                  aGet[ 16 ]:cText( nDtoAge )
               end

            end



            hAtipica := hAtipica( hValue( aTmp, aTmpPre ) )

            if !Empty( hAtipica )

               if hhaskey( hAtipica, "nTarifaFamilia" ) .AND. hAtipica[ "nTarifaFamilia" ] > 0
                  aGet[ 11 ]:cText( nRetPreArt( hAtipica[ "nTarifaFamilia" ], aTmpPre[ 46 ], aTmpPre[52], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp ) )
               end

               if hhaskey( hAtipica, "nImporte" ) .AND. hAtipica[ "nImporte" ] <> 0
                  aGet[ 11 ]:cText( hAtipica[ "nImporte" ] )
               end

               if hhaskey( hAtipica, "nDescuentoPorcentual" )
                  aGet[ 14 ]:cText( hAtipica[ "nDescuentoPorcentual"] )
               end

               if hhaskey( hAtipica, "nDescuentoPromocional" )
                  aGet[ 15 ]:cText( hAtipica[ "nDescuentoPromocional" ] )
               end

               if hhaskey( hAtipica, "nComisionAgente" )
                  aGet[ 16 ]:cText( hAtipica[ "nComisionAgente" ] )
               end

               if hhaskey( hAtipica, "nDescuentoLineal" )
                  aGet[ 30 ]:cText( hAtipica[ "nDescuentoLineal" ] )
               end

            end



            sOfertaArticulo   := structOfertaArticulo( D():getHashArray( aTmpPre, "PreCliT", nView ), D():getHashArray( aTmp, "PreCliL", nView ), nTotLPreCli( aTmp ), nView )

            if !empty( sOfertaArticulo )

               if ( sOfertaArticulo:nPrecio <> 0 )
                  aGet[ 11 ]:cText( sOfertaArticulo:nPrecio )
               end

               if ( sOfertaArticulo:nDtoPorcentual <> 0 )
                  aGet[ 14 ]:cText( sOfertaArticulo:nDtoPorcentual )
               end

               if ( sOfertaArticulo:nDtoLineal <> 0 )
                  aGet[ 30 ]:cText( sOfertaArticulo:nDtoLineal )
               end

               aTmp[ 78 ] := .T.

            end



            ValidaMedicion( aTmp, aGet )

         end





         lBuscaOferta( aTmp[ 4 ], aGet, aTmp, aTmpPre, dbfOferta, D():Articulos( nView ), dbfDiv, dbfKit, dbfIva  )





         cOldPrpArt := cPrpArt
         cOldCodArt := cCodArt
         cOldLotArt := cLotArt





         if empty( aTmp[ 11 ] ) .OR. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) )
            aGet[ 11 ]:HardEnable()
            aGet[ 14    ]:HardEnable()
            aGet[ 15 ]:HardEnable()
            if aGet[ 13 ] <> nil
               aGet[ 13 ]:HardEnable()
            end
            if aGet[ 12 ] <> nil
               aGet[ 12 ]:HardEnable()
            end
            if aGet[ 30 ] <> nil
               aGet[ 30 ]:HardEnable()
            end
         else
            aGet[ 11 ]:HardDisable()
            aGet[ 14    ]:HardDisable()
            aGet[ 15 ]:HardDisable()
            if aGet[ 13 ] <> nil
               aGet[ 13 ]:HardDisable()
            end
            if aGet[ 12 ] <> nil
               aGet[ 12 ]:HardDisable()
            end
            if aGet[ 30 ] <> nil
               aGet[ 30 ]:HardDisable()
            end
         end

      else

         MsgStop( "Artículo no encontrado" )
         Return .F.

      end

   end

Return .T.



static function lBuscaOferta( cCodArt, aGet, aTmp, aTmpPre, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )

   local sOfeArt
   local nTotalLinea    := 0

   if ( dbfArticulo )->Codigo == cCodArt .OR. ( dbfArticulo )->( dbSeek( cCodArt ) )





      nTotalLinea       := RecalculaLinea( aTmp, aTmpPre, nDouDiv, , , aTmpPre[ 46 ], .T. )

      sOfeArt           := sOfertaArticulo( cCodArt, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmp[ 8 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], aTmpPre[ 52 ], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmp[ 46 ], aTmp[ 7 ], nTotalLinea )

      if !Empty( sOfeArt )
         if ( sOfeArt:nPrecio <> 0 )
            aGet[ 11 ]:cText( sOfeArt:nPrecio )
         end
         if ( sOfeArt:nDtoPorcentual <> 0 )
            aGet[ 14     ]:cText( sOfeArt:nDtoPorcentual )
         end
         if ( sOfeArt:nDtoLineal <> 0)
            aGet[ 30  ]:cText( sOfeArt:nDtoLineal )
         end
         aTmp[ 78  ] := .T.
      end

      if !aTmp[ 78 ]





         sOfeArt        := sOfertaFamilia( ( dbfArticulo )->Familia, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 14    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 78 ]  := .T.
         end

      end

      if !aTmp[ 78 ]





         sOfeArt           := sOfertaTipoArticulo( ( dbfArticulo )->cCodTip, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 14    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 78 ]  := .T.
         end

      end

      if !aTmp[ 78 ]





         sOfeArt           := sOfertaCategoria( ( dbfArticulo )->cCodCate, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 14    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 78 ]  := .T.
         end

      end

      if !aTmp[ 78 ]





         sOfeArt           := sOfertaTemporada( ( dbfArticulo )->cCodTemp, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 14    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 78 ]  := .T.
         end

      end

      if !aTmp[ 78 ]





         sOfeArt     := sOfertaFabricante( ( dbfArticulo )->cCodFab, aTmpPre[ 6 ], aTmpPre[ 63 ], aTmpPre[ 5 ], dbfOferta, aTmp[ 73 ], dbfArticulo, aTmp[ 8 ], aTmp[ 7 ], nTotalLinea )

         if !Empty( sOfeArt )
            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 14    ]:cText( sOfeArt:nDtoPorcentual )
            end
            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 30 ]:cText( sOfeArt:nDtoLineal )
            end
            aTmp[ 78 ]  := .T.
         end

      end

   end

return .T.







STATIC FUNCTION RecalculaLinea( aTmp, aTmpPre, nDec, oTotal, oMargen, cCodDiv, lTotal )

   local nCalculo
   local nUnidades
   local nMargen
   local nCosto
   local nRentabilidad
   local nBase    := 0

   If( lTotal == nil, lTotal := .F., ) ;

   nUnidades      := nTotNPreCli( aTmp )

   if aTmp[ 68 ]
      nCalculo    := aTmp[ 67  ]
   else
      nCalculo    := aTmp[ 11  ]
   end

   nCalculo       -= aTmp[ 30  ]





   if !aTmp[ 37 ]

      if aTmp[ 79 ]
         nCalculo += aTmp[ 39 ] * NotCero( aTmp[ 63 ] )
      else
         nCalculo += aTmp[ 39 ]
      end

   end

   nCalculo       *= nUnidades





   if aTmp[ 13 ] <> 0
      nCalculo    += aTmp[ 13 ] * nUnidades
   end





   IF aTmp[ 14    ] <> 0
      nCalculo    -= nCalculo * aTmp[ 14    ] / 100
    end

    IF aTmp[ 15 ] <> 0
      nCalculo    -= nCalculo * aTmp[ 15 ] / 100
    end





   nCosto            := nUnidades * aTmp[ 34 ]

   if aTmp[ 37 ] .AND. aTmp[ 6 ] <> 0
      nBase          := nCalculo - Round( nCalculo / ( 100 / aTmp[ 6 ] + 1 ), nRouDiv )
   else
      nBase          := nCalculo
   end

   nMargen           := nBase - nCosto

   if nCalculo == 0
      nRentabilidad  := 0
   else
      nRentabilidad  := nRentabilidad( nCalculo, 0, nCosto )
   end





   if aTmpPre[ 80 ] .AND. aTmp[ 12 ] <> 0
      nCalculo    += aTmp[ 12  ] * nUnidades
   end

   nCalculo       := Round( nCalculo, nDec )

   if !Empty( oTotal )
      oTotal:cText( nCalculo )
   end

   if oMargen <> nil
      oMargen:cText( AllTrim( Trans( nMargen, cPorDiv ) + Space( 1 ) + AllTrim( cSimDiv( cCodDiv, dbfDiv ) ) + " : " + AllTrim( Trans( nRentabilidad, "999.99" ) ) + "%" ) )
   end

   if !Empty( oComisionLinea )
      oComisionLinea:cText( Round( ( nBase * aTmp[ 16 ] / 100 ), nRouDiv ) )
   end

return if( !lTotal, .T., nCalculo )



STATIC FUNCTION nTotLAgePre( dbfDetalle )

   local nCalculo := ( dbfDetalle )->nPreDiv * (dbfDetalle)->nUniCaja

   IF lCalCaj()
      nCalculo    *= If( ( dbfDetalle )->nCanPre <> 0, ( dbfDetalle )->nCanPre, 1 )
    end

   nCalculo       := Round( nCalculo * ( dbfDetalle )->nComAge / 100, 0 )

RETURN ( nCalculo )







STATIC FUNCTION nTotLNumArt( dbfDetalle )

    local nCalculo := 0

   IF lCalCaj() .AND. (dbfDetalle)->NCANPRE <> 0 .AND. (dbfDetalle)->NPREDIV <> 0
        nCalculo := (dbfDetalle)->NCANPRE
    end

RETURN ( nCalculo )



STATIC FUNCTION BeginTrans( aTmp, nMode )

   local lErrors  := .F.
   local cDbfLin  := "PCliL"
   local cDbfInc  := "PCliI"
   local cDbfDoc  := "PCliD"
   local cDbfEst  := "PCliE"
   local cPre     := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]
   local oError
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

   cTmpLin        := cGetNewFileName( cPatTmp() + cDbfLin )
   cTmpInc        := cGetNewFileName( cPatTmp() + cDbfInc )
   cTmpDoc        := cGetNewFileName( cPatTmp() + cDbfDoc )
   cTmpEst        := cGetNewFileName( cPatTmp() + cDbfEst )





   dbCreate( cTmpInc, aSqlStruct( aIncPreCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )

   if !NetErr()
      ( dbfTmpInc )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
      ( dbfTmpInc )->( OrdCreate( cTmpInc, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
   else
      lErrors     := .T.
   end

   dbCreate( cTmpDoc, aSqlStruct( aPreCliDoc() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )

   if !NetErr()
      ( dbfTmpDoc )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
      ( dbfTmpDoc )->( OrdCreate( cTmpDoc, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
   else
      lErrors     := .T.
   end

   dbCreate( cTmpLin, aSqlStruct( aColPreCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpLin, cCheckArea( cDbfLin, @dbfTmpLin ), .F. )

   if !NetErr()
      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "nPosPrint", "Str( nPosPrint, 4 )", {|| Str( Field->nPosPrint ) } ) )
   else
      lErrors     := .T.
   end

   dbCreate( cTmpEst, aSqlStruct( aPreCliEst() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpEst, cCheckArea( cDbfEst, @dbfTmpEst ), .F. )

   if !NetErr()
      ( dbfTmpEst )->( ordCreate( cTmpEst, "nNumPre", "cSerPre + str( nNumPre ) + cSufPre + dtos( dFecSit )  + tFecSit", {|| Field->cSerPre + str( Field->nNumPre ) + Field->cSufPre + dtos( Field->dFecSit )  + Field->tFecSit } ) )
      ( dbfTmpEst )->( ordListAdd( cTmpEst ) )
   else
      lErrors     := .T.
   endif





   if ( D():PresupuestosClientesLineas( nView ) )->( dbSeek( cPre ) )

      while ( ( D():PresupuestosClientesLineas( nView ) )->cSerPre + Str( ( D():PresupuestosClientesLineas( nView ) )->NNUMPRE ) + ( D():PresupuestosClientesLineas( nView ) )->CSUFPRE == cPre .AND. !( D():PresupuestosClientesLineas( nView ) )->( eof() ) )

         dbPass( D():PresupuestosClientesLineas( nView ), dbfTmpLin, .T. )
         ( D():PresupuestosClientesLineas( nView ) )->( dbSkip() )

      end

   end

   ( dbfTmpLin )->( dbGoTop() )





   if ( nMode <> 4 ) .AND. ( dbfPreCliI )->( dbSeek( cPre ) )

      while ( ( dbfPreCliI )->cSerPre + Str( ( dbfPreCliI )->NNUMPRE ) + ( dbfPreCliI )->CSUFPRE == cPre .AND. !( dbfPreCliI )->( eof() ) )

         dbPass( dbfPreCliI, dbfTmpInc, .T. )
         ( dbfPreCliI )->( DbSkip() )

      end

   end

   ( dbfTmpInc )->( dbGoTop() )





   if ( nMode <> 4 ) .AND. ( dbfPreCliD )->( dbSeek( cPre ) )

      while ( ( dbfPreCliD )->cSerPre + Str( ( dbfPreCliD )->NNUMPRE ) + ( dbfPreCliD )->CSUFPRE == cPre .AND. !( dbfPreCliD )->( eof() ) )

         dbPass( dbfPreCliD, dbfTmpDoc, .T. )
         ( dbfPreCliD )->( dbSkip() )

      end

   end

   ( dbfTmpDoc )->( dbGoTop() )





   if ( nMode <> 4 ) .AND. ( D():PresupuestosClientesSituaciones( nView ) )->( dbSeek( cPre ) )

         while ( ( D():PresupuestosClientesSituaciones( nView ) )->cSerPre + Str( ( D():PresupuestosClientesSituaciones( nView ) )->nNumPre ) + ( D():PresupuestosClientesSituaciones( nView ) )->cSufPre == cPre ) .AND. ( D():PresupuestosClientesSituaciones( nView ) )->( !eof() )

         dbPass( D():PresupuestosClientesSituaciones( nView ), dbfTmpEst, .T. )
         ( D():PresupuestosClientesSituaciones( nView ) )->( dbSkip() )

      end

   end

   ( dbfTmpEst )->( dbGoTop() )

   oDetCamposExtra:SetTemporal( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "", nMode )

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

RETURN ( lErrors )



STATIC FUNCTION EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg, lActualizaWeb )

    local aTabla
   local oError
   local oBlock
   local cSerPre
   local nNumPre
   local cSufPre
   local cCodCli

   If( lActualizaWeb == nil, lActualizaWeb := .F., ) ;

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   cSerPre              := aTmp[ 1 ]
   nNumPre              := aTmp[ 2 ]
   cSufPre              := aTmp[ 3 ]
   cCodCli              := aTmp[ 6 ]





   if !lValidaOperacion( aTmp[ 5 ] )
      Return .F.
   end

   if !lValidaSerie( aTmp[ 1 ] )
      Return .F.
   end

   if Empty( aTmp[ 6 ] )
      msgStop( "Cliente no puede estar vacío." )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 17 ] )
      msgStop( "Almacén no puede estar vacío." )
      aGet[ 17 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 18 ] )
      msgStop( "Caja no puede estar vacía." )
      aGet[ 18 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 46 ] )
      MsgStop( "No puede almacenar documento sin código de divisa." )
      aGet[ 46 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 14 ] ) .AND. lRecogerAgentes()
      msgStop( "Agente no puede estar vacio." )
      aGet[ 14 ]:SetFocus()
      return .F.
   end

   if ( dbfTmpLin )->( eof() )
      MsgStop( "No puede almacenar un documento sin lineas." )
      return .F.
   end

   oDlg:Disable()

   oMsgText( "Archivando" )





   if ( cOldSituacion <> aTmp[ 61 ] )
      ( dbfTmpInc )->( dbAppend() )
      ( dbfTmpInc )->dFecInc     := GetSysDate()
      ( dbfTmpInc )->mDesInc     := "Cambio de estado de " + AllTrim( cOldSituacion ) + " a " + Alltrim( aTmp[ 61 ] ) + "."
   end





   ( dbfTmpLin )->( dbClearFilter() )





   aTmp[ 59 ]        := Date()
   aTmp[ 60 ]        := Time()
   aTmp[ 28 ]        := oGetTarifa:getTarifa()





   aTmp[ 72 ]      := !Empty( oTipPre ) .AND. ( oTipPre:nAt == 2 )

   do case
   case isAppendOrDuplicateMode( nMode )

      nNumPre              := nNewDoc( cSerPre, D():PresupuestosClientes( nView ), "nPreCli", , dbfCount )
      aTmp[ 2 ]     := nNumPre
      cSufPre              := retSufEmp()
      aTmp[ 3 ]     := cSufPre

   case isEditMode( nMode )

      if nNumPre <> 0 .AND. ( D():PresupuestosClientesLineas( nView ) )->( dbSeek( cSerPre + str( nNumPre ) + cSufPre ) )

         while ( ( D():PresupuestosClientesLineas( nView ) )->cSerPre + Str( ( D():PresupuestosClientesLineas( nView ) )->nNumPre ) + ( D():PresupuestosClientesLineas( nView ) )->cSufPre == cSerPre + str( nNumPre ) + cSufPre )

            if dbLock( D():PresupuestosClientesLineas( nView ) )
               ( D():PresupuestosClientesLineas( nView ) )->( dbDelete() )
               ( D():PresupuestosClientesLineas( nView ) )->( dbUnLock() )
            end

            ( D():PresupuestosClientesLineas( nView ) )->( dbSkip() )

         end

      end

      if nNumPre <> 0

         while ( dbfPreCliI )->( dbSeek( cSerPre + str( nNumPre ) + cSufPre ) )
            if dbLock( dbfPreCliI )
               ( dbfPreCliI )->( dbDelete() )
               ( dbfPreCliI )->( dbUnLock() )
            end
         end

         while ( dbfPreCliD )->( dbSeek( cSerPre + str( nNumPre ) + cSufPre ) )
            if dbLock( dbfPreCliD )
               ( dbfPreCliD )->( dbDelete() )
               ( dbfPreCliD )->( dbUnLock() )
            end
         end

         while ( D():PresupuestosClientesSituaciones( nView ) )->( dbSeek( cSerPre + str( nNumPre ) + cSufPre ) )
            if dbLock( D():PresupuestosClientesSituaciones( nView ) )
               ( D():PresupuestosClientesSituaciones( nView ) )->( dbDelete() )
               ( D():PresupuestosClientesSituaciones( nView ) )->( dbUnLock() )
            end
         end

      end

   end

   if !( "PDA" $ appParamsMain() )
      oMsgProgress()
      oMsgProgress():SetRange( 0, ( dbfTmpLin )->( LastRec() ) )
   end





   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( Eof() )

      ( dbfTmpLin )->nRegIva     := aTmp[ 51 ]

      dbPass( dbfTmpLin, D():PresupuestosClientesLineas( nView ), .T., cSerPre, nNumPre, cSufPre )
      ( dbfTmpLin )->( dbSkip() )

      if !( "PDA" $ appParamsMain() )
         oMsgProgress():Deltapos(1)
      end

   end





   ( dbfTmpInc )->( dbGoTop() )
   while !( dbfTmpInc )->( Eof() )

      dbPass( dbfTmpInc, dbfPreCliI, .T., cSerPre, nNumPre, cSufPre )
      ( dbfTmpInc )->( dbSkip() )

   end





   ( dbfTmpDoc )->( dbGoTop() )
   while !( dbfTmpDoc )->( Eof() )

      dbPass( dbfTmpDoc, dbfPreCliD, .T., cSerPre, nNumPre, cSufPre )
      ( dbfTmpDoc )->( dbSkip() )

   end





    ( dbfTmpEst )->( DbGoTop() )
      while ( dbfTmpEst )->( !eof() )
         dbPass( dbfTmpEst, D():PresupuestosClientesSituaciones( nView ), .T., cSerPre, nNumPre, cSufPre )
         ( dbfTmpEst )->( dbSkip() )
      end





   aTmp[ 76 ]     := nTotNet
   aTmp[ 77 ]     := nTotIva
   aTmp[ 78 ]     := nTotReq
   aTmp[ 79 ]     := nTotPre





   oDetCamposExtra:saveExtraField( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "" )

   WinGather( aTmp, , D():PresupuestosClientes( nView ), , nMode )





   if uFieldempresa( "lAddAtp" )

      ( dbfTmpLin )->( dbGoTop() )

      while !( dbfTmpLin )->( Eof() )

         if !Empty( ( dbfTmpLin )->cRef )




            AtipicasModel():AddArticulo( {   "cCodCli"   => cCodCli, "cCodArt"   => ( dbfTmpLin )->cRef, "cNomArt"   => ( dbfTmpLin )->cDetalle, "nPreUnit"  => ( dbfTmpLin )->nPreDiv } )

         end

         ( dbfTmpLin )->( dbSkip() )

      end

      ( dbfTmpLin )->( dbGoTop() )

   end










   if uFieldempresa( "lRealWeb" ) .AND. ( !empty( ( D():PresupuestosClientes( nView ) )->cCodWeb ) )
      with object ( TComercio():New() )
         :syncSituacionesPresupuestoPrestashop( ( D():PresupuestosClientes( nView ) )->cCodWeb, ( D():PresupuestosClientes( nView ) )->cSerPre, ( D():PresupuestosClientes( nView ) )->nNumPre, ( D():PresupuestosClientes( nView ) )->cSufPre )
      end
   end





   dbCommitAll()

   if !( "PDA" $ appParamsMain() )
      oMsgProgress()
      oMsgText()

      EndProgress()
   end

   oDlg:Enable()
   oDlg:End( 1 )

Return .T.



Static Function KillTrans( oBrwLin )





   if !Empty( dbfTmpLin ) .AND. ( dbfTmpLin )->( Used() )
      ( dbfTmpLin )->( dbCloseArea() )
   end

   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpEst ) .AND. ( dbfTmpEst )->( Used() )
      ( dbfTmpEst )->( dbCloseArea() )
   end

   dbfErase( cTmpLin )
   dbfErase( cTmpInc )
   dbfErase( cTmpDoc )
   dbfErase( cTmpEst )

Return .T.



STATIC FUNCTION LoaCli( aGet, aTmp, nMode, oRieCli, oTlfCli )

   local lValid      := .T.
   local cNewCodCli  := aGet[ 6 ]:VarGet()
   local lChgCodCli  := ( Empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if Empty( cNewCodCli )
      return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[6], "0", RetNumCodCliEmp() )
   else
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodCliEmp() )
   end

   if ( D():Clientes( nView ) )->( dbSeek( cNewCodCli ) )

      if !( isAviableClient( nView, nMode ) )
         return .F.
      end

      if oTlfCli <> nil
         oTlfCli:SetText( ( D():Clientes( nView ) )->Telefono )
      end





      aGet[ 6 ]:cText( ( D():Clientes( nView ) )->Cod )





      if ( D():Clientes( nView ) )->nColor <> 0
         aGet[ 7 ]:SetColor( , ( D():Clientes( nView ) )->nColor )
      end

      if Empty( aGet[ 7 ]:varGet() ) .OR. lChgCodCli
         aGet[ 7 ]:cText( ( D():Clientes( nView ) )->Titulo )
      end

      if Empty( aGet[ 75 ]:varGet() ) .OR. lChgCodCli
         aGet[ 75 ]:cText( ( D():Clientes( nView ) )->Telefono )
      end

      if !Empty( aGet[ 8 ] ) .AND. ( Empty( aGet[ 8 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 8 ]:cText( ( D():Clientes( nView ) )->Domicilio )
      end

      if !Empty( aGet[ 9 ] ) .AND. ( Empty( aGet[ 9 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 9 ]:cText( ( D():Clientes( nView ) )->Poblacion )
      end

      if !Empty( aGet[ 10 ] ) .AND. ( Empty( aGet[ 10 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 10 ]:cText( ( D():Clientes( nView ) )->Provincia )
      end

      if !Empty( aGet[ 11 ] ) .AND. ( Empty( aGet[ 11 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 11 ]:cText( ( D():Clientes( nView ) )->CodPostal )
      end

      if !Empty( aGet[12] ) .AND. ( Empty( aGet[ 12 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 12 ]:cText( ( D():Clientes( nView ) )->Nif )
      end

      if ( Empty( aTmp[63] ) .OR. lChgCodCli )
         aTmp[ 63 ]  := ( D():Clientes( nView ) )->cCodGrp
      end





      if ( lChgCodCli ) .AND. !Empty( aGet[ 15 ] )

         if dbSeekInOrd( cNewCodCli, "lDefObr", dbfObrasT )
            aGet[ 15 ]:cText( ( dbfObrasT )->cCodObr )
         else
            aGet[ 15 ]:cText( Space( 10 ) )
         end

         aGet[ 15 ]:lValid()

      end





      if ( lChgCodCli )

         if oRieCli <> nil
            oStock:SetRiesgo( cNewCodCli, oRieCli, ( D():Clientes( nView ) )->Riesgo )
         end

         aTmp[ 13 ]  := ( D():Clientes( nView ) )->lModDat

         aTmp[ 80 ]  := ( D():Clientes( nView ) )->lPntVer
      end

      if nMode == 1

         aTmp[ 51 ]   := ( D():Clientes( nView ) )->nRegIva

         lChangeRegIva( aTmp )





         if Empty( aTmp[ 1 ] )

            if !Empty( ( D():Clientes( nView ) )->Serie )
               aGet[ 1 ]:cText( ( D():Clientes( nView ) )->Serie )
            end

         else

            if !Empty( ( D():Clientes( nView ) )->Serie ) .AND. aTmp[ 1 ] <> ( D():Clientes( nView ) )->Serie .AND. ApoloMsgNoYes( "La serie del cliente seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( D():Clientes( nView ) )->Serie )
            end

         end

         if !Empty( aGet[ 17 ] )
            if ( Empty( aGet[ 17 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cCodAlm )
               aGet[ 17 ]:cText( ( D():Clientes( nView ) )->cCodAlm )
               aGet[ 17 ]:lValid()
            end
         end

         if aGet[ 16 ] <> nil
            if !Empty( aGet[ 16 ] ) .AND. ( Empty( aGet[ 16 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cCodTar )
               aGet[ 16 ]:cText( ( D():Clientes( nView ) )->cCodTar )
               aGet[ 16 ]:lValid()
            end
         end

         if ( Empty( aGet[ 19 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->CodPago )
            aGet[ 19 ]:cText( (D():Clientes( nView ) )->CodPago )
            aGet[ 19 ]:lValid()
         end

         if aGet[14] <> nil
            if ( Empty( aGet[ 14 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cAgente )
               aGet[ 14 ]:cText( ( D():Clientes( nView ) )->cAgente )
               aGet[ 14 ]:lValid()
            end
         end

         if ( Empty( aGet[ 20 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cCodRut )
            aGet[ 20 ]:cText( ( D():Clientes( nView ) )->cCodRut )
            aGet[ 20 ]:lValid()
         end

         if !empty( oGetTarifa )
            if ( Empty( oGetTarifa:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->nTarifa )
               oGetTarifa:setTarifa( ( D():Clientes( nView ) )->nTarifa )
            end
        else
             aTmp[ 28 ]    := ( D():Clientes( nView ) )->nTarifa
         end

         if ( Empty( aTmp[ 81 ] ) .OR. lChgCodCli )
             aTmp[ 81 ]    := ( D():Clientes( nView ) )->nDtoArt
         end

         if !Empty( aGet[ 55 ] ) .AND. ( Empty( aGet[ 55 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cCodTrn )
            aGet[ 55 ]:cText( ( D():Clientes( nView ) )->cCodTrn )
            aGet[ 55 ]:lValid()
         end

         if lChgCodCli

            aGet[ 42 ]:Click( ( D():Clientes( nView ) )->lReq ):Refresh()

            aGet[ 80 ]:Click( ( D():Clientes( nView ) )->lPntVer ):Refresh()

            if ( D():Clientes( nView ) )->lMosCom .AND. !Empty( ( D():Clientes( nView ) )->mComent ) .AND. lChgCodCli
               MsgStop( Trim( ( D():Clientes( nView ) )->mComent ) )
            end





            if !uFieldempresa( "lDtoCliLin" )
               aGet[ 29 ]:cText( ( D():Clientes( nView ) )->cDtoEsp )
               aGet[ 30 ]:cText( ( D():Clientes( nView ) )->nDtoEsp )
            end

            aGet[ 31    ]:cText( ( D():Clientes( nView ) )->cDpp )

            aGet[ 32    ]:cText( ( D():Clientes( nView ) )->nDpp )

            aGet[ 33 ]:cText( ( D():Clientes( nView ) )->cDtoUno )

            aGet[ 34 ]:cText( ( D():Clientes( nView ) )->nDtoCnt )

            aGet[ 35 ]:cText( ( D():Clientes( nView ) )->cDtoDos )

            aGet[ 36 ]:cText( ( D():Clientes( nView ) )->nDtoRap )

            aTmp[ 68 ]  := ( D():Clientes( nView ) )->nDtoAtp

            aTmp[ 69 ]  := ( D():Clientes( nView ) )->nSbrAtp

            ShowIncidenciaCliente( ( D():Clientes( nView ) )->Cod, nView )

         end

      end

      cOldCodCli  := ( D():Clientes( nView ) )->Cod

      lValid      := .T.

    ELSE

        msgStop( "Cliente no encontrado", "Cadena buscada : " + cNewCodCli )
      lValid      := .T.

    end

RETURN lValid



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "PreCliT.Dbf", cLocalDriver() )
      dbCreate( cPath + "PreCliT.Dbf", aSqlStruct( aItmPreCli() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "PreCliL.Dbf", cLocalDriver() )
      dbCreate( cPath + "PreCliL.Dbf", aSqlStruct( aColPreCli() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "PreCliI.Dbf", cLocalDriver() )
      dbCreate( cPath + "PreCliI.Dbf", aSqlStruct( aIncPreCli() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "PreCliD.Dbf", cLocalDriver() )
      dbCreate( cPath + "PreCliD.Dbf", aSqlStruct( aPreCliDoc() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "PreCliE.Dbf", cLocalDriver() )
      dbCreate( cPath + "PreCliE.Dbf", aSqlStruct( aPreCliEst() ), cLocalDriver() )
   end

RETURN NIL



STATIC FUNCTION ChgState( oBrw )

   local nRec

   for each nRec in ( oBrw:aSelected )

      ( D():PresupuestosClientes( nView ) )->( dbGoTo( nRec ) )

      if dbLock( D():PresupuestosClientes( nView ) )
         ( D():PresupuestosClientes( nView ) )->lEstado := !( D():PresupuestosClientes( nView ) )->lEstado
         ( D():PresupuestosClientes( nView ) )->( dbRUnlock() )
      end

   next

   oBrw:Refresh()
   oBrw:SetFocus()

RETURN NIL






STATIC FUNCTION lMoreIva( nCodIva )















RETURN .F.



static function lGenPreCli( oBrw, oBtn, nDevice )

   local bAction

   If( nDevice == nil, nDevice := 1, ) ;

   if Empty( oBtn )
      return nil
   end

   IF !( D():Documentos( nView ) )->( dbSeek( "RC" ) )








         oWndBrw:NewAt( "GC_DOCUMENT_WHITE_",,, {||( msgStop( "No hay presupuestos de proveedores predefinidos" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   ELSE

      WHILE ( D():Documentos( nView ) )->cTipo == "RC" .AND. !( D():Documentos( nView ) )->( eof() )

         bAction  := bGenPreCli( nDevice, "Imprimiendo presupuestos a clientes", ( D():Documentos( nView ) )->CODIGO )

         oWndBrw:NewAt( "gc_document_white_", , , bAction, Rtrim( ( D():Documentos( nView ) )->cDescrip ) , , , , , oBtn )

         ( D():Documentos( nView ) )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenPreCli( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle )
   local cCod  := by( cCodDoc )

   if nDev == 1
      bGen     := {|| nGenPreCli( nDev, cTit, cCod ) }
   else
      bGen     := {|| GenPreCli( nDev, cTit, cCod ) }
   end

return ( bGen )



static function nGenPreCli( nDevice, cTitle, cCodDoc, cPrinter, nCopy )

   local nImpYet     := 1
   local nCopyClient := Retfld( ( D():PresupuestosClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" )

   If( nDevice == nil, nDevice := 1, ) ;
   If( nCopy == nil, nCopy := Max( nCopyClient, nCopiasDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", dbfCount ) ), ) ;

   nCopy             := Max( nCopy, 1 )

   while nImpYet <= nCopy
      GenPreCli( nDevice, cTitle, cCodDoc, cPrinter )
      nImpYet++
   end


   lChgImpDoc( D():PresupuestosClientes( nView ) )

return nil



STATIC FUNCTION nClrPane( dbfTmpLin )

   local cClr

   if ( dbfTmpLin )->lControl .OR. ( dbfTmpLin )->lTotLin
      cClr     := 14197607
   else
      cClr     := 16777215
   end

return cClr



STATIC FUNCTION nClrText( dbfTmpLin )

   local cClr

   if ( dbfTmpLin )->lKitChl
      cClr     := 8421504
   else
      cClr     := 0
   end

return cClr



Static Function nEstadoIncidencia( cNumPre )

   local nEstado  := 0

   if ( dbfPreCliI )->( dbSeek( cNumPre ) )

      while ( dbfPreCliI )->cSerPre + Str( ( dbfPreCliI )->nNumPre ) + ( dbfPreCliI )->cSufPre == cNumPre .AND. !( dbfPreCliI )->( Eof() )

         if ( dbfPreCliI )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( dbfPreCliI )->( dbSkip() )

      end

   end

Return ( nEstado )



Static Function DesgPnt( cCodArt, aTmp, nTarifa, oPreDiv, oCosDiv, nMode )

   local oDlg
   local oPuntos
   local oValorPunto
   local oDtoPnt
   local oIncPnt
   local oImporte
   local nPuntos     := 0
   local nValorPunto := 0
   local nDtoPnt     := 0
   local nIncPnt     := 0



   if Empty( cCodArt )
      MsgInfo( "Debe seleccinar un artículo", "Código vacío" )
      return .F.
   end



   nPuntos           := aTmp[ 58 ]
   nValorPunto       := aTmp[ 59 ]
   nDtoPnt           := aTmp[ 60 ]
   nIncPnt           := aTmp[ 61 ]

   oDlg = TDialog():New(,,,, "Desglose de puntos", "DESGPUNTOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







   oPuntos := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, nPuntos, nPuntos:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )







   oValorPunto := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nValorPunto, nValorPunto:= u ) }, oDlg,, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,,,,, nil,,, )









   oDtoPnt := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nDtoPnt, nDtoPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )









   oIncPnt := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, nIncPnt, nIncPnt:= u ) }, oDlg,, "999.99",,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( oImporte:Refresh() ) }, .F., .T.,,, {||      0}, {||      100},, nil,,, )





   oImporte := TSay():ReDefine( 240, {|| nCalculoPuntos( nPuntos, nValorPunto, nDtoPnt, nIncPnt )}, oDlg, cPouDiv, "N/W*",, .F.,, .F., .F., )





   TButton():ReDefine( 500, {||( EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, D():Articulos( nView ), nDouDiv ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




   TButton():ReDefine( 550, {||( oDlg:end() )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, D():Articulos( nView ), nDouDiv ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      aTmp[ 58 ]     := nPuntos
      aTmp[ 59 ]     := nValorPunto
      aTmp[ 60 ]     := nDtoPnt
      aTmp[ 61 ]     := nIncPnt
      oCosDiv:cText( oImporte:VarGet() )
      oCosDiv:Refresh()

   end

Return ( .T. )






Static Function PreCliNotas()

   local cObserv  := ""
   local aData    := {}

   aAdd( aData, "Presupuesto " + ( D():PresupuestosClientes( nView ) )->cSerPre + "/" + AllTrim( Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) ) + "/" + Alltrim( ( D():PresupuestosClientes( nView ) )->cSufPre ) + " de " + Rtrim( ( D():PresupuestosClientes( nView ) )->cNomCli ) )
   aAdd( aData, "08" )
   aAdd( aData, ( D():PresupuestosClientes( nView ) )->cCodCli )
   aAdd( aData, ( D():PresupuestosClientes( nView ) )->cNomCli )
   aAdd( aData, ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre )

   if !Empty( ( D():PresupuestosClientes( nView ) )->cRetPor )
      cObserv     += Rtrim( ( D():PresupuestosClientes( nView ) )->cRetPor ) + Space( 1 )
   end

   if !Empty( ( D():PresupuestosClientes( nView ) )->cRetMat )
      cObserv     += Rtrim( ( D():PresupuestosClientes( nView ) )->cRetMat ) + Space( 1 )
   end



















   aAdd( aData, cObserv )

   GenerarNotas( aData )

Return ( nil )



Static Function AppendKit( uTmpLin, aTmpPre )

   local cCodArt
   local cSerPre
   local nNumPre
   local cSufPre
   local nCanPre
   local dFecPre
   local cAlmLin
   local nIvaLin
   local lIvaLin
   local nComAge
   local nUniCaj
   local nDtoGrl
   local nDtoPrm
   local nDtoDiv
   local nNumLin
   local nPosPrint
   local nTarLin
   local nRecAct                       := ( dbfKit )->( Recno() )
   local nUnidades                     := 0
   local nStkActual                    := 0
   local nStockMinimo                  := 0

   if ValType( uTmpLin ) == "A"
      cCodArt                          := uTmpLin[ 4    ]
      cSerPre                          := uTmpLin[ 1 ]
      nNumPre                          := uTmpLin[ 2 ]
      cSufPre                          := uTmpLin[ 3 ]
      nCanPre                          := uTmpLin[ 7 ]
      dFecPre                          := uTmpLin[ 21  ]
      cAlmLin                          := uTmpLin[ 36 ]
      nIvaLin                          := uTmpLin[ 6    ]
      lIvaLin                          := uTmpLin[ 37 ]
      nComAge                          := uTmpLin[ 16 ]
      nUniCaj                          := uTmpLin[ 8]
      nDtoGrl                          := uTmpLin[ 14    ]
      nDtoPrm                          := uTmpLin[ 15 ]
      nDtoDiv                          := uTmpLin[ 30 ]
      nNumLin                          := uTmpLin[ 32 ]
      nPosPrint                        := uTmpLin[ 88 ]
      nTarLin                          := uTmpLin[ 73 ]
   else
      cCodArt                          := ( uTmpLin )->cRef
      cSerPre                          := ( uTmpLin )->cSerPre
      nNumPre                          := ( uTmpLin )->nNumPre
      cSufPre                          := ( uTmpLin )->cSufPre
      nCanPre                          := ( uTmpLin )->nCanPre
      dFecPre                          := ( uTmpLin )->dFecha
      cAlmLin                          := ( uTmpLin )->cAlmLin
      nIvaLin                          := ( uTmpLin )->nIva
      lIvaLin                          := ( uTmpLin )->lIvaLin
      nComAge                          := ( uTmpLin )->nComAge
      nUniCaj                          := ( uTmpLin )->nUniCaja
      nDtoGrl                          := ( uTmpLin )->nDto
      nDtoPrm                          := ( uTmpLin )->nDtoPrm
      nDtoDiv                          := ( uTmpLin )->nDtoDiv
      nNumLin                          := ( uTmpLin )->nNumLin
      nPosPrint                        := ( uTmpLin )->nPosPrint
      nTarLin                          := ( uTmpLin )->nTarLin
   end

   if ( dbfKit )->( dbSeek( cCodArt ) )

      while ( dbfKit )->cCodKit == cCodArt .AND. !( dbfKit )->( eof() )

         if ( D():Articulos( nView ) )->( dbSeek( ( dbfKit )->cRefKit ) )

            ( dbfTmpLin )->( dbAppend() )

            ( dbfTmpLin )->nNumLin     := nNumLin
            ( dbfTmpLin )->nPosPrint   := nPosPrint
            ( dbfTmpLin )->lKitChl     := .T.

            ( dbfTmpLin )->cRef        := ( dbfkit      )->cRefKit
            ( dbfTmpLin )->cDetalle    := ( D():Articulos( nView ) )->Nombre
            ( dbfTmpLin )->nPntVer     := ( D():Articulos( nView ) )->nPntVer1
            ( dbfTmpLin )->cUnidad     := ( D():Articulos( nView ) )->cUnidad
            ( dbfTmpLin )->nPesokg     := ( D():Articulos( nView ) )->nPesoKg
            ( dbfTmpLin )->cPesokg     := ( D():Articulos( nView ) )->cUndDim
            ( dbfTmpLin )->nVolumen    := ( D():Articulos( nView ) )->nVolumen
            ( dbfTmpLin )->cVolumen    := ( D():Articulos( nView ) )->cVolumen

            ( dbfTmpLin )->nPvpRec     := ( D():Articulos( nView ) )->PvpRec
            ( dbfTmpLin )->cCodImp     := ( D():Articulos( nView ) )->cCodImp
            ( dbfTmpLin )->lLote       := ( D():Articulos( nView ) )->lLote
            ( dbfTmpLin )->nLote       := ( D():Articulos( nView ) )->nLote
            ( dbfTmpLin )->cLote       := ( D():Articulos( nView ) )->cLote

            ( dbfTmpLin )->nValImp     := oNewImp:nValImp( ( D():Articulos( nView ) )->cCodImp )
            ( dbfTmpLin )->nCosDiv     := nCosto( nil, D():Articulos( nView ), dbfKit, , , , aTmpPre[ 6 ] )

            if ( D():Articulos( nView ) )->lFacCnv
               ( dbfTmpLin )->nFacCnv  := ( D():Articulos( nView ) )->nFacCnv
            end





            ( dbfTmpLin )->cCodFam     := ( D():Articulos( nView ) )->Familia
            ( dbfTmpLin )->cGrpFam     := cGruFam( ( dbfTmpLin )->cCodFam, dbfFamilia )





            ( dbfTmpLin )->cSerPre     := cSerPre
            ( dbfTmpLin )->nNumPre     := nNumPre
            ( dbfTmpLin )->cSufPre     := cSufPre
            ( dbfTmpLin )->nCanPre     := nCanPre
            ( dbfTmpLin )->dFecha      := dFecPre
            ( dbfTmpLin )->cAlmLin     := cAlmLin
            ( dbfTmpLin )->lIvaLin     := lIvaLin
            ( dbfTmpLin )->nComAge     := nComAge





            ( dbfTmpLin )->lImpLin     := lImprimirComponente( cCodArt, D():Articulos( nView ) )
            ( dbfTmpLin )->lKitPrc     := lPreciosComponentes( cCodArt, D():Articulos( nView ) )





            ( dbfTmpLin )->nUniCaja    := nUniCaj * ( dbfKit )->nUndKit

            if ( dbfTmpLin )->lKitPrc
               ( dbfTmpLin )->nPreDiv  := nRetPreArt( nTarLin, aTmpPre[ 46 ], aTmpPre[ 52 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
            end





            if !Empty( nIvaLin )
               ( dbfTmpLin )->nIva     := nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva )
               ( dbfTmpLin )->nReq     := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )
            else
               ( dbfTmpLin )->nIva     := 0
               ( dbfTmpLin )->nReq     := 0
            end

            if lStockComponentes( cCodArt, D():Articulos( nView ) )
               ( dbfTmpLin )->nCtlStk  := ( D():Articulos( nView ) )->nCtlStock
            else
               ( dbfTmpLin )->nCtlstk  := 3
            end





            if ( dbfKit )->lAplDto
               ( dbfTmpLin )->nDto     := nDtoGrl
               ( dbfTmpLin )->nDtoPrm  := nDtoPrm
               ( dbfTmpLin )->nDtoDiv  := nDtoDiv
            end

            if ( D():Articulos( nView ) )->lKitArt
               AppendKit( dbfTmpLin, aTmpPre )
            end





            nStockMinimo      := nStockMinimo( ( dbfKit )->cRefKit, cAlmLin, nView )

            if ( D():Articulos( nView ) )->lMsgVta .AND. !uFieldEmpresa( "lNStkAct" ) .AND. nStockMinimo > 0

               nStkActual     := StocksModel():nStockArticulo( ( dbfKit )->cRefKit, cAlmLin )
               nUnidades      := nUniCaj * ( dbfKit )->nUndKit

               do case
                  case nStkActual - nUnidades < 0



                        MsgStop( "No hay stock suficiente para realizar la venta" + Chr(13)+Chr(10) +  "del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( D():Articulos( nView ) )->Nombre ), "¡Atención!" )

                  case nStkActual - nUnidades < nStockMinimo






                        MsgStop( "El stock del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( D():Articulos( nView ) )->Nombre ) + Chr(13)+Chr(10) +  "está bajo minimo." + Chr(13)+Chr(10) +  "Unidades a vender : " + AllTrim( Trans( nUnidades, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock minimo : " + AllTrim( Trans( nStockMinimo, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock actual : " + AllTrim( Trans( nStkActual, MasUnd() ) ), "¡Atención!" )

               end

            end

         end

         ( dbfKit )->( dbSkip() )

      end

   end

   ( dbfKit )->( dbGoTo( nRecAct ) )

Return ( nil )



STATIC FUNCTION DupSerie( oWndBrw )

   local oDlg
   local oSerIni
   local oSerFin
   local oTxtDup
   local nTxtDup     := 0
   local nRecno      := ( D():PresupuestosClientes( nView ) )->( Recno() )
   local nOrdAnt     := ( D():PresupuestosClientes( nView ) )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( D():PresupuestosClientes( nView ) )->cSerPre, ( D():PresupuestosClientes( nView ) )->nNumPre, ( D():PresupuestosClientes( nView ) )->cSufPre, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel
   local oFecDoc
   local cFecDoc     := GetSysDate()




   oDlg = TDialog():New(,,,, "Duplicar series de presupuestos", "DUPSERDOC",, .F.,,,,, oWndBrw, .F.,,,,,, .F.,, "oDlg", nil, )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )




   oFecDoc := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cFecDoc, cFecDoc:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )





 oTxtDup := TApoloMeter():ReDefine( 160, { | u | If( PCount()==0, nTxtDup, nTxtDup:= u ) }, ( D():PresupuestosClientes( nView ) )->( OrdKeyCount() ), oDlg, .F.,,, .T.,,,, )

      oDlg:AddFastKey( 116, {|| DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( D():PresupuestosClientes( nView ) )->( dbGoTo( nRecNo ) )
   ( D():PresupuestosClientes( nView ) )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



STATIC FUNCTION DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, lCancel, cFecDoc )

   local nOrd
   local nDuplicados    := 0
   local nProcesed      := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction   := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd              := ( D():PresupuestosClientes( nView ) )->( OrdSetFocus( "nNumPre" ) )

      ( D():PresupuestosClientes( nView ) )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )

      while !lCancel .AND. ( D():PresupuestosClientes( nView ) )->( !eof() )






         if ( D():PresupuestosClientes( nView ) )->cSerPre >= oDesde:cSerieInicio  .AND. ( D():PresupuestosClientes( nView ) )->cSerPre <= oDesde:cSerieFin     .AND. ( D():PresupuestosClientes( nView ) )->nNumPre >= oDesde:nNumeroInicio .AND. ( D():PresupuestosClientes( nView ) )->nNumPre <= oDesde:nNumeroFin    .AND. ( D():PresupuestosClientes( nView ) )->cSufPre >= oDesde:cSufijoInicio .AND. ( D():PresupuestosClientes( nView ) )->cSufPre <= oDesde:cSufijoFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( D():PresupuestosClientes( nView ) )->cSerPre + "/" + Alltrim( Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) ) + "/" + ( D():PresupuestosClientes( nView ) )->cSufPre

            DupPresupuesto( cFecDoc )

         end

         ( D():PresupuestosClientes( nView ) )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( D():PresupuestosClientes( nView ) )->( OrdSetFocus( nOrd ) )

   else

      nOrd              := ( D():PresupuestosClientes( nView ) )->( OrdSetFocus( "dFecPre" ) )

      ( D():PresupuestosClientes( nView ) )->( dbSeek( oDesde:dFechaInicio, .T. ) )

      while !lCancel .AND. ( D():PresupuestosClientes( nView ) )->( !eof() )


         if ( D():PresupuestosClientes( nView ) )->dFecPre >= oDesde:dFechaInicio  .AND. ( D():PresupuestosClientes( nView ) )->dFecPre <= oDesde:dFechaFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( D():PresupuestosClientes( nView ) )->cSerPre + "/" + Alltrim( Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) ) + "/" + ( D():PresupuestosClientes( nView ) )->cSufPre

            DupPresupuesto( cFecDoc )

         end

         ( D():PresupuestosClientes( nView ) )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( D():PresupuestosClientes( nView ) )->( OrdSetFocus( nOrd ) )

   end

   lCancel              := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



STATIC FUNCTION PreRecDup( cDbf, xField1, xField2, xField3, lCab, cFecDoc )

   local nRec           := ( cDbf )->( Recno() )
   local aTabla         := {}
   local nOrdAnt

   If( lCab == nil, lCab := .F., ) ;

   aTabla               := DBScatter( cDbf )
   aTabla[ 1 ]   := xField1
   aTabla[ 2 ]   := xField2
   aTabla[ 3 ]   := xField3

   if lCab

      aTabla[ 4     ]  := cCurSesion()
      if !Empty( cFecDoc )
         aTabla[ 5  ]  := cFecDoc
      end
      aTabla[ 18     ]  := Application():CodigoCaja()
      aTabla[ 21     ]  := Ctod("")
      aTabla[ 45     ]  := Space( 12 )
      aTabla[ 48     ]  := .T.
      aTabla[ 57     ]  := .F.
      aTabla[ 58     ]  := Auth():Codigo()
      aTabla[ 59     ]  := GetSysDate()
      aTabla[ 60     ]  := Time()
      aTabla[ 64  ]  := .F.
      aTabla[ 65     ]  := Ctod("")
      aTabla[ 66     ]  := Space( 5 )
      aTabla[ 67     ]  := Application():CodigoDelegacion()
      aTabla[ 22     ]  := .F.

      nOrdAnt                 := ( cDbf )->( OrdSetFocus( "NNUMPRE" ) )

   end

   if dbDialogLock( cDbf, .T. )
      aEval( aTabla, { | uTmp, n | ( cDbf )->( fieldPut( n, uTmp ) ) } )
      ( cDbf )->( dbUnLock() )
   end

   if lCab
      ( cDbf )->( OrdSetFocus( nOrdAnt ) )
   end

   ( cDbf )->( dbGoTo( nRec ) )

RETURN ( .T. )



STATIC FUNCTION DupPresupuesto( cFecDoc )

   local nNewNumPre  := 0



   nNewNumPre  := nNewDoc( ( D():PresupuestosClientes( nView ) )->cSerPre, D():PresupuestosClientes( nView ), "NPRECLI" )



   PreRecDup( D():PresupuestosClientes( nView ), ( D():PresupuestosClientes( nView ) )->cSerPre, nNewNumPre, ( D():PresupuestosClientes( nView ) )->cSufPre, .T., cFecDoc )



   if ( D():PresupuestosClientesLineas( nView ) )->( dbSeek( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre ) )


      while ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre == ( D():PresupuestosClientesLineas( nView ) )->cSerPre + Str( ( D():PresupuestosClientesLineas( nView ) )->nNumPre ) + ( D():PresupuestosClientesLineas( nView ) )->cSufPre .AND.  !( D():PresupuestosClientesLineas( nView ) )->( Eof() )

         PreRecDup( D():PresupuestosClientesLineas( nView ), ( D():PresupuestosClientes( nView ) )->cSerPre, nNewNumPre, ( D():PresupuestosClientes( nView ) )->cSufPre, .F. )

         ( D():PresupuestosClientesLineas( nView ) )->( dbSkip() )

      end

   end



   if ( dbfPreCliD )->( dbSeek( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre ) )


      while ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre == ( dbfPreCliD )->cSerPre + Str( ( dbfPreCliD )->nNumPre ) + ( dbfPreCliD )->cSufPre .AND.  !( dbfPreCliD )->( Eof() )

         PreRecDup( dbfPreCliD, ( D():PresupuestosClientes( nView ) )->cSerPre, nNewNumPre, ( D():PresupuestosClientes( nView ) )->cSufPre, .F. )

         ( dbfPreCliD )->( dbSkip() )

      end

   end

RETURN ( .T. )



STATIC FUNCTION SetDialog( aGet, oSayDias, oSayTxtDias, oSayGetRnt, oGetRnt )

   if oTipPre:nAt == 2

      aGet[ 70 ]:Show()
      aGet[ 71  ]:Show()
      aGet[ 23   ]:Hide()

      oSayDias:Show()
      oSayTxtDias:Show()

   else

      aGet[ 70 ]:Hide()
      aGet[ 71  ]:Hide()
      aGet[ 23   ]:Show()

      oSayDias:Hide()
      oSayTxtDias:Hide()

   end

   aGet[ 70 ]:Refresh()
   aGet[ 71  ]:Refresh()
   aGet[ 23   ]:Refresh()

   oSayDias:Refresh()
   oSayTxtDias:Refresh()

   if RolesModel():getRolNoMostrarRentabilidad( Auth():rolUuid() )

      if !Empty( oSayGetRnt )
         oSayGetRnt:Hide()
      end

      if !Empty( oGetRnt )
         oGetRnt:Hide()
      end

   end

Return nil



STATIC FUNCTION ChangeTarifa( aTmp, aGet, aTmpPre )

   local nPrePro  := 0

   nPrePro        := nPrePro( aTmp[ 4 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ], aTmp[ 73 ], aTmpPre[ 52 ], dbfArtDiv, dbfTarPreL, aTmpPre[ 16 ] )

   if nPrePro == 0
      nPrePro     := nRetPreArt( aTmp[ 73 ], aTmpPre[ 46 ], aTmpPre[ 52 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
   end

   if !Empty( aTmpPre[ 16 ] )
      nPrePro     := RetPrcTar( aTmp[ 4 ], aTmpPre[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL, aTmp[ 73 ] )
   end

   if nPrePro <> 0
      aGet[ 11 ]:cText( nPrePro )
   end

return .T.



Static Function ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 18 ]:VarGet





   if ( Empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if oUndMedicion:oDbf:Seek( aTmp[ 18 ] )

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
            if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( ( D():Articulos( nView ) )->nLngArt )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := ( D():Articulos( nView ) )->nLngArt
            end
         else
            if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
            if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( ( D():Articulos( nView ) )->nAltArt )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := ( D():Articulos( nView ) )->nAltArt
            end

         else
            if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
               aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
            if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( ( D():Articulos( nView ) ) ->nAncArt )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := ( D():Articulos( nView ) )->nAncArt
            end
         else
            if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( D():PresupuestosClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

Return .T.



Static Function loadComisionAgente( aTmp, aGet, aTmpPre )

   local nComisionAgenteTarifa

   nComisionAgenteTarifa      := nComisionAgenteTarifa( aTmpPre[ 14 ], aTmp[ 73 ], nView )
   if nComisionAgenteTarifa == 0
      nComisionAgenteTarifa   := aTmpPre[ 43 ]
   end

   if !empty( aGet[ 16 ] )
      aGet[ 16 ]:cText( nComisionAgenteTarifa )
   else
      aTmp[ 16 ]        := nComisionAgenteTarifa
   end

return .T.
#line 8248 ".\.\Prg\Precli.prg"
Static Function DataReport( oFr )

   local np





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Presupuestos", ( D():PresupuestosClientes( nView ) )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Presupuestos", cItemsToReport( aItmPreCli() ) )

   oFr:SetWorkArea(     "Lineas de presupuestos", ( D():PresupuestosClientesLineas( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de presupuestos", cItemsToReport( aColPreCli() ) )

   oFr:SetWorkArea(     "Incidencias de presupuestos", ( dbfPreCliI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de presupuestos", cItemsToReport( aIncPreCli() ) )

   oFr:SetWorkArea(     "Documentos de presupuestos", ( dbfPreCliD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de presupuestos", cItemsToReport( aPreCliDoc() ) )

   oFr:SetWorkArea(     "Situaciones de presupuesto", ( D():PresupuestosClientesSituaciones( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Situaciones de presupuesto", cItemsToReport( aPreCliEst() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Clientes", ( D():Clientes( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Clientes", cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Obras", ( dbfObrasT )->( Select() ) )
   oFr:SetFieldAliases( "Obras",  cItemsToReport( aItmObr() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Rutas", ( dbfRuta )->( Select() ) )
   oFr:SetFieldAliases( "Rutas", cItemsToReport( aItmRut() ) )

   oFr:SetWorkArea(     "Agentes", ( dbfAgent )->( Select() ) )
   oFr:SetFieldAliases( "Agentes", cItemsToReport( aItmAge() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( D():Articulos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Ofertas", ( dbfOferta )->( Select() ) )
   oFr:SetFieldAliases( "Ofertas", cItemsToReport( aItmOfe() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetWorkArea(     "Impuestos especiales",  oNewImp:Select() )
   oFr:SetFieldAliases( "Impuestos especiales",  cObjectsToReport( oNewImp:oDbf ) )

   oFr:SetWorkArea(     "Familias", ( dbfFamilia )->( Select() ) )
   oFr:SetFieldAliases( "Familias", cItemsToReport( aItmFam() ) )

   oFr:SetWorkArea(     "Transportistas", oTrans:Select() )
   oFr:SetFieldAliases( "Transportistas", cObjectsToReport( oTrans:oDbf ) )







   oFr:setUserDataSet( "Impuestos presupuesto", "porcentajeiva;logrecargo;porcentajere;bruto;neto;impiva;impre;nivmh;ntransporte;npntver", {||np := 1}, {||np := np + 1}, {||np := np - 1}, {||np > Len( aTotIva )}, {|key| hGet( aTotIva[np], key ) } )

   oFr:SetMasterDetail( "Presupuestos", "Lineas de presupuestos",          {|| ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre } )
   oFr:SetMasterDetail( "Presupuestos", "Incidencias de presupuestos",     {|| ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre } )
   oFr:SetMasterDetail( "Presupuestos", "Documentos de presupuestos",      {|| ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre } )
   oFr:SetMasterDetail( "Presupuestos", "Empresa",                         {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Presupuestos", "Clientes",                        {|| ( D():PresupuestosClientes( nView ) )->cCodCli } )
   oFr:SetMasterDetail( "Presupuestos", "Obras",                           {|| ( D():PresupuestosClientes( nView ) )->cCodCli + ( D():PresupuestosClientes( nView ) )->cCodObr } )
   oFr:SetMasterDetail( "Presupuestos", "Almacen",                         {|| ( D():PresupuestosClientes( nView ) )->cCodAlm } )
   oFr:SetMasterDetail( "Presupuestos", "Rutas",                           {|| ( D():PresupuestosClientes( nView ) )->cCodRut } )
   oFr:SetMasterDetail( "Presupuestos", "Agentes",                         {|| ( D():PresupuestosClientes( nView ) )->cCodAge } )
   oFr:SetMasterDetail( "Presupuestos", "Formas de pago",                  {|| ( D():PresupuestosClientes( nView ) )->cCodPgo } )
   oFr:SetMasterDetail( "Presupuestos", "Transportistas",                  {|| ( D():PresupuestosClientes( nView ) )->cCodTrn } )

   oFr:SetMasterDetail( "Lineas de presupuestos", "Artículos",             {|| ( D():PresupuestosClientesLineas( nView ) )->cRef } )
   oFr:SetMasterDetail( "Lineas de presupuestos", "Ofertas",               {|| ( D():PresupuestosClientesLineas( nView ) )->cRef } )
   oFr:SetMasterDetail( "Lineas de presupuestos", "Unidades de medición",  {|| ( D():PresupuestosClientesLineas( nView ) )->cUnidad } )
   oFr:SetMasterDetail( "Lineas de presupuestos", "Impuestos especiales",  {|| ( D():PresupuestosClientesLineas( nView ) )->cCodImp } )
   oFr:SetMasterDetail( "Lineas de presupuestos", "Familias",               {|| ( D():PresupuestosClientesLineas( nView ) )->cCodFam } )

   oFr:SetResyncPair(   "Presupuestos", "Lineas de presupuestos" )
   oFr:SetResyncPair(   "Presupuestos", "Incidencias de presupuestos" )
   oFr:SetResyncPair(   "Presupuestos", "Documentos de presupuestos" )
   oFr:SetResyncPair(   "Presupuestos", "Empresa" )
   oFr:SetResyncPair(   "Presupuestos", "Clientes" )
   oFr:SetResyncPair(   "Presupuestos", "Obras" )
   oFr:SetResyncPair(   "Presupuestos", "Almacenes" )
   oFr:SetResyncPair(   "Presupuestos", "Rutas" )
   oFr:SetResyncPair(   "Presupuestos", "Agentes" )
   oFr:SetResyncPair(   "Presupuestos", "Formas de pago" )
   oFr:SetResyncPair(   "Presupuestos", "Transportistas" )

   oFr:SetResyncPair(   "Lineas de presupuestos", "Artículos" )
   oFr:SetResyncPair(   "Lineas de presupuestos", "Ofertas" )
   oFr:SetResyncPair(   "Lineas de presupuestos", "Unidades de medición" )
   oFr:SetResyncPair(   "Lineas de presupuestos", "Impuestos especiales" )
   oFr:SetResyncPair(   "Lineas de presupuestos", "Familias" )

Return nil



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Presupuestos" )
   oFr:DeleteCategory(  "Lineas de presupuestos" )





   oFr:AddVariable(     "Presupuestos",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Presupuestos",             "Total presupuesto",                   "GetHbVar('nTotPre')" )
   oFr:AddVariable(     "Presupuestos",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Presupuestos",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Presupuestos",             "Total descuentos",                    "GetHbVar('nTotalDto')" )
   oFr:AddVariable(     "Presupuestos",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Presupuestos",             "Total primer descuento definible",    "GetHbVar('nTotUno')" )
   oFr:AddVariable(     "Presupuestos",             "Total segundo descuento definible",   "GetHbVar('nTotDos')" )
   oFr:AddVariable(     "Presupuestos",             "Total " + cImp(),                     "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Presupuestos",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Presupuestos",             "Total página",                        "GetHbVar('nTotPag')" )
   oFr:AddVariable(     "Presupuestos",             "Total retención",                     "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Presupuestos",             "Total peso",                          "GetHbVar('nTotPes')" )
   oFr:AddVariable(     "Presupuestos",             "Total costo",                         "GetHbVar('nTotCos')" )
   oFr:AddVariable(     "Presupuestos",             "Total anticipado",                    "GetHbVar('nTotAnt')" )
   oFr:AddVariable(     "Presupuestos",             "Total cobrado",                       "GetHbVar('nTotCob')" )
   oFr:AddVariable(     "Presupuestos",             "Total artículos",                     "GetHbVar('nTotArt')" )
   oFr:AddVariable(     "Presupuestos",             "Total cajas",                         "GetHbVar('nTotCaj')" )
   oFr:AddVariable(     "Presupuestos",             "Cuenta por defecto del cliente",      "GetHbVar('cCtaCli')" )

   oFr:AddVariable(     "Presupuestos",             "Total unidades primer tipo de impuestos especiales",            "GetHbArrayVar('aIvmUno',1 )" )
   oFr:AddVariable(     "Presupuestos",             "Total unidades segundo tipo de impuestos especiales",           "GetHbArrayVar('aIvmDos',1 )" )
   oFr:AddVariable(     "Presupuestos",             "Total unidades tercer tipo de impuestos especiales",            "GetHbArrayVar('aIvmTre',1 )" )
   oFr:AddVariable(     "Presupuestos",             "Importe del primer tipo de impuestos especiales",               "GetHbArrayVar('aIvmUno',2 )" )
   oFr:AddVariable(     "Presupuestos",             "Importe del segundo tipo de impuestos especiales",              "GetHbArrayVar('aIvmDos',2 )" )
   oFr:AddVariable(     "Presupuestos",             "Importe del tercer tipo de impuestos especiales",               "GetHbArrayVar('aIvmTre',2 )" )
   oFr:AddVariable(     "Presupuestos",             "Total importe primer tipo de impuestos especiales",             "GetHbArrayVar('aIvmUno',3 )" )
   oFr:AddVariable(     "Presupuestos",             "Total importe segundo tipo de impuestos especiales",            "GetHbArrayVar('aIvmDos',3 )" )
   oFr:AddVariable(     "Presupuestos",             "Total importe tercer tipo de impuestos especiales",             "GetHbArrayVar('aIvmTre',3 )" )

      oFr:AddVariable(     "Lineas de presupuestos",   "Detalle del artículo",                "CallHbFunc('cDesPreCli' )" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Detalle del artículo otro lenguaje",  "CallHbFunc('cDesPreCliLeng')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Total unidades artículo",             "CallHbFunc('nTotNPreCli')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Precio unitario del artículo",        "CallHbFunc('nTotUPreCli')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Total línea de presupuesto",          "CallHbFunc('nTotLPreCli')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Total peso por línea",                "CallHbFunc('nPesLPreCli')" )
   oFr:AddVariable(     "Lineas de presupuestos",   "Total final línea del presupuesto",   "CallHbFunc('nTotFPreCli')" )

Return nil



Static Function YearComboBoxChange()

   if ( oWndBrw:oWndBar:cYearComboBox() <> "[Todos]" )
      oWndBrw:oWndBar:setYearComboBoxExpression( "Year( Field->dFecPre ) == " + oWndBrw:oWndBar:cYearComboBox() )
   else
      oWndBrw:oWndBar:setYearComboBoxExpression( "" )
   end

   oWndBrw:chgFilter()

Return nil



Static Function hValue( aTmp, aTmpPre )

   local hValue                  := {=>}

   do case
      case ValType( aTmp ) == "A"

         hValue[ "cCodigoArticulo"   ] := aTmp[ 4 ]
         hValue[ "cCodigoPropiedad1" ] := aTmp[ 25 ]
         hValue[ "cCodigoPropiedad2" ] := aTmp[ 26 ]
         hValue[ "cValorPropiedad1"  ] := aTmp[ 27 ]
         hValue[ "cValorPropiedad2"  ] := aTmp[ 28 ]
         hValue[ "cCodigoFamilia"    ] := aTmp[ 51 ]
         hValue[ "nTarifaPrecio"     ] := aTmp[ 73 ]
         hValue[ "nCajas"            ] := aTmp[ 7 ]
         hValue[ "nUnidades"         ] := aTmp[ 8 ]

      case ValType( aTmp ) == "C"

         hValue[ "cCodigoArticulo"   ] := ( aTmp )->cRef
         hValue[ "cCodigoPropiedad1" ] := ( aTmp )->cCodPr1
         hValue[ "cCodigoPropiedad2" ] := ( aTmp )->cCodPr2
         hValue[ "cValorPropiedad1"  ] := ( aTmp )->cValPr1
         hValue[ "cValorPropiedad2"  ] := ( aTmp )->cValPr2
         hValue[ "cCodigoFamilia"    ] := ( aTmp )->cCodFam
         hValue[ "nTarifaPrecio"     ] := ( aTmp )->nTarLin
         hValue[ "nCajas"            ] := ( aTmp )->nCanPre
         hValue[ "nUnidades"         ] := ( aTmp )->nUniCaja

   end

   do case
      case ValType( aTmpPre ) == "A"

         hValue[ "cCodigoCliente"    ] := aTmpPre[ 6 ]
         hValue[ "cCodigoGrupo"      ] := aTmpPre[ 63 ]
         hValue[ "lIvaIncluido"      ] := aTmpPre[ 52 ]
         hValue[ "dFecha"            ] := aTmpPre[ 5 ]
         hValue[ "nDescuentoTarifa"  ] := aTmpPre[ 81 ]

      case ValType( aTmpPre ) == "C"

         hValue[ "cCodigoCliente"    ] := ( aTmpPre )->cCodCli
         hValue[ "cCodigoGrupo"      ] := ( aTmpPre )->cCodGrp
         hValue[ "lIvaIncluido"      ] := ( aTmpPre )->lIvaInc
         hValue[ "dFecha"            ] := ( aTmpPre )->dFecPre
         hValue[ "nDescuentoTarifa"  ] := ( aTmpPre )->nDtoTarifa
   end

   hValue[ "nTipoDocumento"         ] := "08"
   hValue[ "nView"                  ] := nView

Return ( hValue )



Static Function ImprimirSeriesPresupuestosClientes( nDevice, lExt )

   local aStatus
   local oPrinter
   local cFormato

   If( nDevice == nil, nDevice := 1, ) ;
   If( lExt == nil, lExt := .F., ) ;



   oPrinter          := PrintSeries():New( nView ):SetVentas()



   oPrinter:Serie(      ( D():PresupuestosClientes( nView ) )->cSerPre )
   oPrinter:Documento(  ( D():PresupuestosClientes( nView ) )->nNumPre )
   oPrinter:Sufijo(     ( D():PresupuestosClientes( nView ) )->cSufPre )

   if lExt

      oPrinter:oFechaInicio:cText( ( D():PresupuestosClientes( nView ) )->dFecPre )
      oPrinter:oFechaFin:cText( ( D():PresupuestosClientes( nView ) )->dFecPre )

   end

   oPrinter:oFormatoDocumento:TypeDocumento( "RC" )



   cFormato          := cFormatoDocumento( ( D():PresupuestosClientes( nView ) )->cSerPre, "nPreCli", D():Contadores( nView ) )
   if empty( cFormato )
      cFormato       := cFirstDoc( "RC", D():Documentos( nView ) )
   end
   oPrinter:oFormatoDocumento:cText( cFormato )



   aStatus           := D():GetInitStatus( "PreCliT", nView )

   oPrinter:bInit    := {||   ( D():PresupuestosClientes( nView ) )->( dbSeek( oPrinter:DocumentoInicio(), .T. ) ) }


   oPrinter:bWhile   := {||   oPrinter:InRangeDocumento( D():PresupuestosClientesId( nView ) )                  .AND.  ( D():PresupuestosClientes( nView ) )->( !eof() ) }




   oPrinter:bFor     := {||   oPrinter:InRangeFecha( ( D():PresupuestosClientes( nView ) )->dFecPre )           .AND.  oPrinter:InRangeCliente( ( D():PresupuestosClientes( nView ) )->cCodCli )         .AND.  oPrinter:InRangeAgente( ( D():PresupuestosClientes( nView ) )->cCodAge )         .AND.  oPrinter:InRangeGrupoCliente( retGrpCli( ( D():PresupuestosClientes( nView ) )->cCodCli, D():Clientes( nView ) ) ) }

   oPrinter:bSkip    := {||   ( D():PresupuestosClientes( nView ) )->( dbSkip() ) }





   oPrinter:bAction  := {||   GenPreCli(  nDevice, "Imprimiendo documento : " + D():PresupuestosClientesId( nView ), oPrinter:oFormatoDocumento:uGetValue, oPrinter:oImpresora:uGetValue, if( !oPrinter:oCopias:lCopiasPredeterminadas, oPrinter:oCopias:uGetValue, ) ) }

   oPrinter:bStart   := {||   if( lExt, oPrinter:DisableRange(), ) }



   oPrinter:Resource():End()



   D():SetStatus( "PreCliT", nView, aStatus )

   if !Empty( oWndBrw )
      oWndBrw:Refresh()
   end

Return .T.








FUNCTION nTotPreCli( cPresupuesto, cPreCliT, cPreCliL, cIva, cDiv, cFPago, aTmp, cDivRet, lPic )

   local n
   local nRecno
   local cCodDiv
   local bCondition
   local nTotalArt
   local nDtoEsp
   local nDtoPP
   local nDtoUno
   local nDtoDos
   local nDtoAtp
   local nSbrAtp
   local dFecFac
   local lIvaInc
   local nIvaMan
   local nKgsTrn
   local lPntVer           := .F.
   local nManObr           := 0
   local nTotalLin         := 0
   local nTotalUnd         := 0
   local aTotalDto         := { 0, 0, 0 }
   local aTotalDPP         := { 0, 0, 0 }
   local aTotalUno         := { 0, 0, 0 }
   local aTotalDos         := { 0, 0, 0 }
   local aTotalAtp         := { 0, 0, 0 }
   local lRecargo
   local nTotAcu           := 0
   local nDescuentosLineas := 0
   local nRegIva
   local nBaseGasto
   local nIvaGasto

   local oTotalDoc         := nTotalDocumento():new( nView )

   If( cPreCliT == nil, cPreCliT := D():PresupuestosClientes( nView ), ) ;
   If( cPreCliL == nil, cPreCliL := D():PresupuestosClientesLineas( nView ), ) ;
   If( cIva == nil, cIva := dbfIva, ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( cFPago == nil, cFPago := dbfFPago, ) ;
   If( cPresupuesto == nil, cPresupuesto := ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, ) ;
   If( lPic == nil, lPic := .F., ) ;

   if Empty( Select( cPreCliT ) )
      Return ( 0 )
   end

   if Empty( Select( cPreCliL ) )
      Return ( 0 )
   end

   if Empty( Select( cIva ) )
      Return ( 0 )
   end

   if Empty( Select( cDiv ) )
      Return ( 0 )
   end

   public nTotBrt    := 0
   public nTotPre    := 0
   public nTotDto    := 0
   public nTotDPP    := 0
   public nTotNet    := 0
   public nTotIvm    := 0
   public nTotIva    := 0
   public nTotReq    := 0
   public nTotAge    := 0
   public nTotUno    := 0
   public nTotDos    := 0
   public nTotPnt    := 0
   public nTotTrn    := 0
   public nTotCos    := 0
   public nTotRnt    := 0
   public nTotAtp    := 0
   public nTotPes    := 0
   public nPctRnt    := 0
   public nTotDif    := 0
   public nTotUnd    := 0










   public aTotIva  := {{   "porcentajeiva" => nil, "logrecargo"   => .F., "porcentajere" => nil, "bruto"        => nil, "neto"         => nil, "impiva"    => nil, "impre"        => nil, "nivmh"        => nil, "ntransporte"  => nil, "npntver"      => nil } }

   public aIvaUno    := {}
   public aIvaDos    := {}
   public aIvaTre    := {}

   public aTotIvm    := { { 0,nil,0 }, { 0,nil,0 }, { 0,nil,0 }, }
   public aIvmUno    := aTotIvm[ 1 ]
   public aIvmDos    := aTotIvm[ 2 ]
   public aIvmTre    := aTotIvm[ 3 ]

   public aImpVto    := {}
   public aDatVto    := {}

   public nNumArt    := 0
   public nNumCaj    := 0

   public nTotalDto  := 0

   public cCtaCli    := cClientCuenta( ( cPreCliT )->cCodCli )

   nRecno            := ( cPreCliL )->( RecNo() )

   if aTmp <> nil
      lRecargo       := aTmp[ 42]
      nDtoEsp        := aTmp[ 30 ]
      nDtoPP         := aTmp[ 32    ]
      nDtoUno        := aTmp[ 34 ]
      nDtoDos        := aTmp[ 36 ]
      cCodDiv        := aTmp[ 46 ]
      nVdvDiv        := aTmp[ 47 ]
      dFecFac        := aTmp[ 5 ]
      lIvaInc        := aTmp[ 52 ]
      nIvaMan        := aTmp[ 53 ]
      nManObr        := aTmp[ 54 ]
      nDtoAtp        := aTmp[ 68 ]
      nSbrAtp        := aTmp[ 69 ]
      nKgsTrn        := aTmp[ 56 ]
      lPntVer        := aTmp[ 80 ]
      nRegIva        := aTmp[ 51 ]
      bCondition     := {|| !( cPreCliL )->( eof() ) }
      ( cPreCliL )->( dbGoTop() )
   else
      lRecargo       := ( cPreCliT )->lRecargo
      nDtoEsp        := ( cPreCliT )->nDtoEsp
      nDtoPP         := ( cPreCliT )->nDpp
      nDtoUno        := ( cPreCliT )->nDtoUno
      nDtoDos        := ( cPreCliT )->nDtoDos
      cCodDiv        := ( cPreCliT )->cDivPre
      nVdvDiv        := ( cPreCliT )->nVdvPre
      dFecFac        := ( cPreCliT )->dFecPre
      nIvaMan        := ( cPreCliT )->nIvaMan
      lIvaInc        := ( cPreCliT )->lIvaInc
      nManObr        := ( cPreCliT )->nManObr
      nDtoAtp        := ( cPreCliT )->nDtoAtp
      nSbrAtp        := ( cPreCliT )->nSbrAtp
      nKgsTrn        := ( cPreCliT )->nKgsTrn
      lPntVer        := ( cPreCliT )->lOperPV
      nRegIva        := ( cPreCliT )->nRegIva
      bCondition     := {|| ( cPreCliL )->cSerPre + Str( ( cPreCliL )->nNumPre ) + ( cPreCliL )->cSufPre == cPresupuesto .AND. !( cPreCliL )->( eof() ) }
      ( cPreCliL )->( dbSeek( cPresupuesto ) )
   end





   cPouDiv           := cPouDiv( cCodDiv, cDiv )
   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   cPpvDiv           := cPpvDiv( cCodDiv, cDiv )
   nDouDiv           := nDouDiv( cCodDiv, cDiv )
   nRouDiv           := nRouDiv( cCodDiv, cDiv )
   nDpvDiv           := nDpvDiv( cCodDiv, cDiv )

   WHILE Eval( bCondition )

      if lValLine( cPreCliL )

         if ( cPreCliL )->lTotLin





            if ( cPreCliL )->nPreDiv <> nTotalLin .OR. ( cPreCliL )->nUniCaja <> nTotalUnd

               if ( cPreCliL )->( dbRLock() )
                  ( cPreCliL )->nPreDiv    := nTotalLin
                  ( cPreCliL )->nUniCaja   := nTotalUnd
                  ( cPreCliL )->( dbUnLock() )
               end

            end





            nTotalLin         := 0
            nTotalUnd         := 0

         else

            nTotArt           := nTotLPreCli( cPreCliL, nDouDiv, nRouDiv, , , .F., .F. )
            nTotPnt           := if( lPntVer, nPntLPreCli( cPreCliL, nDpvDiv ), 0 )
            nTotTrn           := nTrnLPreCli( cPreCliL, nDouDiv )
            nTotIvm           := nTotIPreCli( cPreCliL, nDouDiv, nRouDiv )
            nTotCos           += nTotCPreCli( cPreCliL, nDouDiv, nRouDiv )
            nTotPes           += nPesLPreCli( cPreCliL )
            nDescuentosLineas += nTotDtoLPreCli( cPreCliL, nDouDiv )

            if aTmp <> nil
               nTotAge        += nComLPreCli( aTmp, cPreCliL, nDouDiv, nRouDiv )
            else
               nTotAge        += nComLPreCli( cPreCliT, cPreCliL, nDouDiv, nRouDiv )
            end

            nNumArt           += nTotNPreCli( cPreCliL )
            nNumCaj           += ( cPreCliL )->nCanPre





            nTotUnd           += nTotNPreCli( cPreCliL )





            oTotalDoc:setArrayImpuesto( ( cPreCliL )->nIva, lRecargo, ( cPreCliL )->nReq, nTotArt, nTotIvm, nTotTrn, nTotPnt )




            if ( cPreCliL )->nValImp <> 0

               do case
                  case aTotIvm[ 1, 2 ] == nil .OR. aTotIvm[ 1, 2 ] == ( cPreCliL )->nValImp
                     aTotIvm[ 1, 1 ]      += nTotNPreCli( cPreCliL ) * if( ( cPreCliL )->lVolImp, NotCero( ( cPreCliL )->nVolumen ), 1 )
                     aTotIvm[ 1, 2 ]      := ( cPreCliL )->nValImp
                     aTotIvm[ 1, 3 ]      := aTotIvm[ 1, 1 ] * aTotIvm[ 1, 2 ]

                  case aTotIvm[ 2, 2 ] == nil .OR. aTotIvm[ 2, 2 ] == ( cPreCliL )->nValImp
                     aTotIvm[ 2, 1 ]      += nTotNPreCli( cPreCliL ) * if( ( cPreCliL )->lVolImp, NotCero( ( cPreCliL )->nVolumen ), 1 )
                     aTotIvm[ 2, 2 ]      := ( cPreCliL )->nValImp
                     aTotIvm[ 2, 3 ]      := aTotIvm[ 2, 1 ] * aTotIvm[ 2, 2 ]

                  case aTotIvm[ 3, 2 ] == nil .OR. aTotIvm[ 3, 2 ] == ( cPreCliL )->nValImp
                     aTotIvm[ 3, 1 ]      += nTotNPreCli( cPreCliL ) * if( ( cPreCliL )->lVolImp, NotCero( ( cPreCliL )->nVolumen ), 1 )
                     aTotIvm[ 3, 2 ]      := ( cPreCliL )->nValImp
                     aTotIvm[ 3, 3 ]      := aTotIvm[ 3, 1 ] * aTotIvm[ 3, 2 ]

               end

            end

         end

      end

      ( cPreCliL )->( dbSkip() )

   end

   ( cPreCliL )->( dbGoto( nRecno ) )





   aTotIva      := oTotalDoc:getArrayImpuesto()
   aTotIva          := aSort( aTotIva,,, {|x,y| hGet( x, "porcentajeiva" ) > hGet( y, "porcentajeiva" ) } )

   nTotBrt         := oTotalDoc:getTotalBruto()

   if nDtoEsp <> 0
         nTotDto := oTotalDoc:setDescuentoEspecial( nDtoEsp )
      end
      if nDtoPP <> 0
         nTotDPP := oTotalDoc:setDescuentoProntoPago( nDtoPP )
      end
      if nDtoUno <> 0
         nTotUno := oTotalDoc:setDescuentoUno( nDtoUno )
      end
      if nDtoDos <> 0
         nTotDos := oTotalDoc:setDescuentoDos( nDtoDos )
      end































































































































































































































































   oTotalDoc:setImportesImpuesto( lIvaInc, nRegIva, nRouDiv )

   if lRecargo .AND. lIvaInc
      nTotBrt         := oTotalDoc:getTotalBruto()
   end



   if nManObr <> 0

      if lIvaInc
         nIvaGasto   := Round( nManObr / ( 100 / nIvaMan + 1 ), nRouDiv )
         nBaseGasto  := nManObr - nIvaGasto
      else
         nBaseGasto  := nManObr
         nIvaGasto   := Round( nManObr * nIvaMan / 100, nRouDiv )
      end

      oTotalDoc:setGastos( nIvaMan, nBaseGasto, nIvaGasto )



















   end






   nTotNet           := oTotalDoc:getTotalNeto()





   if nKgsTrn <> 0
      nTotDif        := nKgsTrn - nTotPes
   else
      nTotDif        := 0
   end






   nTotIvm           := oTotalDoc:getTotalIvmh()






   nTotTrn           := oTotalDoc:getTotalTrn()






   nTotPnt           := oTotalDoc:getTotalPntVer()






   nTotIva           := oTotalDoc:getTotalIva()






   nTotReq           := oTotalDoc:getTotalRE()





   nTotImp           := Round( nTotIva + nTotReq + nTotIvm, nRouDiv )





   nTotRnt           := Round(  nTotNet - nManObr - nTotAge - nTotPnt - nTotAtp - nTotCos, nRouDiv )

   nPctRnt           := nRentabilidad( nTotNet - nManObr - nTotAge - nTotPnt, nTotAtp, nTotCos )





   nTotPre           := nTotNet + nTotImp





   nTotalDto         := nDescuentosLineas + nTotDto + nTotDpp + nTotUno + nTotDos + nTotAtp

   ( cPreCliL )->( dbGoTo( nRecno) )





   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet     := nCnv2Div( nTotNet, cCodDiv, cDivRet )
      nTotIvm     := nCnv2Div( nTotIvm, cCodDiv, cDivRet )
      nTotIva     := nCnv2Div( nTotIva, cCodDiv, cDivRet )
      nTotReq     := nCnv2Div( nTotReq, cCodDiv, cDivRet )
      nTotPre     := nCnv2Div( nTotPre, cCodDiv, cDivRet )
      nTotPnt     := nCnv2Div( nTotPnt, cCodDiv, cDivRet )
      nTotTrn     := nCnv2Div( nTotTrn, cCodDiv, cDivRet )
      cPorDiv     := cPorDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( nTotPre, cPorDiv ), nTotPre ) )



FUNCTION aTotPreCli( cPre, dbfMaster, dbfLine, dbfIva, dbfDiv, dbfFPago, cDivRet )

   nTotPreCli( cPre, dbfMaster, dbfLine, dbfIva, dbfDiv, dbfFPago, nil, cDivRet )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotPre, nTotPnt, nTotTrn, nTotAge, nTotCos } )



FUNCTION BrwPreCli( oGet, cPreCliT, dbfPreCliL, dbfIva, dbfDiv, dbfFPago, oIva )

   local oDlg
   local oBrw
   local oGet1
   local cGet1
   local nOrd     := GetBrwOpt( "BrwPreCli" )
   local lIva     := oIva:VarGet()
   local oCbxOrd
   local aCbxOrd  := { "Número", "Fecha", "Cliente", "Nombre" }
   local cCbxOrd
   local nOrdAnt
   local nRecAnt

   nOrd           := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd        := aCbxOrd[ nOrd ]
   nOrdAnt        := ( cPreCliT )->( OrdSetFocus( nOrd ) )
   nRecAnt        := ( cPreCliT )->( Recno() )

   ( cPreCliT )->( dbSetFilter( {|| !Field->lEstado .AND. Field->lIvaInc == lIva }, "!lEstado .and. lIvaInc == lIva" ) )
   ( cPreCliT )->( dbGoTop() )

   oDlg = TDialog():New(,,,, if( lIva, "Presupuestos de clientes con " + cImp() + " incluido", "Presupuestos de clientes con " + cImp() + " desglosado" ), "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, cPreCliT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, cPreCliT, .T., nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( cPreCliT )->( ordSetFocus( oCbxOrd:nAt ) ), oBrw:Refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := cPreCliT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "Presupuesto a cliente.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Tipo"
         :bEditValue       := {|| aTipPre[ if( ( cPreCliT )->lAlquiler, 2, 1  ) ] }
         :nWidth           := 50
         :lHide            := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumPre"
         :bEditValue       := {|| ( cPreCliT )->cSerPre + "/" + AllTrim( Str( ( cPreCliT )->nNumPre ) ) + "/" + ( cPreCliT )->cSufPre }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecPre"
         :bEditValue       := {|| dtoc( ( cPreCliT )->dFecPre ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( cPreCliT )->cCodCli ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| AllTrim( ( cPreCliT )->cNomCli ) }
         :nWidth           := 300
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| ( cPreCliT )->nTotPre }
         :cEditPicture     := cPorDiv()
         :nWidth           := 100
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 500,, oDlg,,, .F., {||     .F.},,, .F. )




      TButton():ReDefine( 501,, oDlg,,, .F., {||     .F.},,, .F. )

   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   DestroyFastFilter( cPreCliT )

   SetBrwOpt( "BrwPreCli", ( cPreCliT )->( OrdNumber() ) )

   if oDlg:nResult == 1
      oGet:cText( ( cPreCliT )->cSerPre + Str( ( cPreCliT )->nNumPre ) + ( cPreCliT )->cSufPre )
      oGet:lValid()
   end

   ( cPreCliT )->( dbClearFilter() )
   ( cPreCliT )->( ordSetFocus( nOrdAnt ) )
   ( cPreCliT )->( dbGoTo( nRecAnt ) )

RETURN ( oDlg:nResult == 1 )



FUNCTION ChgPreCli( cPre, nMode, cPreCliT )

   local oBlock
   local oError
   local lExito := .T.
   local lClose := .F.

   IF nMode <> 1 .OR. Empty( cPre )
      RETURN NIL
   end

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   IF cPreCliT == NIL

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLI.DBF" ), ( cCheckArea( "PRECLI", @cPreCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose := .T.

   end

   IF (cPreCliT)->( dbSeek( cPre ) )
      if dbDialogLock( cPreCliT )
         (cPreCliT)->lEstado   := .T.
         (cPreCliT)->( dbUnLock() )
      end
   ELSE
      lExito := .F.
   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   IF lClose
      (cPreCliT)->( dbCloseArea() )
   end

RETURN lExito



FUNCTION nTotUPreCli( uTmpLin, nDec, nVdv )

   local nCalculo       := 0

   If( uTmpLin == nil, uTmpLin := D():PresupuestosClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   do case
      case Valtype( uTmpLin ) == "C"

         if ( uTmpLin )->lAlquiler
            nCalculo    := ( uTmpLin )->nPreAlq
         else
            nCalculo    := ( uTmpLin )->nPreDiv
         end

      case Valtype( uTmpLin ) == "O"

         if uTmpLin:lAlquiler
            nCalculo    := uTmpLin:nPreAlq
         else
            nCalculo    := uTmpLin:nPreDiv
         end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nImpUPreCli( uTmpLin, nDec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( nDec == nil, nDec := 2, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ValType( uTmpLin ) == "C"

      if ( uTmpLin )->lAlquiler
         nCalculo    := ( uTmpLin )->nPreAlq
      else
         nCalculo    := ( uTmpLin )->nPreDiv
      end

      if ( uTmpLin )->lIvaLin

         if ( uTmpLin )->nIva <> 0
            nCalculo -= nCalculo / ( 100 / ( uTmpLin )->nIva + 1 )
         end

         if ( uTmpLin )->nValImp <> 0
            nCalculo -= ( uTmpLin )->nValImp
         end

      end

   else

      if uTmpLin:lAlquiler
         nCalculo    := uTmpLin:nPreAlq
      else
         nCalculo    := uTmpLin:nPreDiv
      end

      if uTmpLin:lIvaLin

         if uTmpLin:nIva <> 0
            nCalculo -= nCalculo / ( 100 / uTmpLin:nIva + 1 )
         end

         if uTmpLin:nValImp <> 0
            nCalculo -= uTmpLin:nValImp
         end

      end

   end

   nCalculo          := Round( nCalculo / nVdv, nDec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nBrtLPreCli( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( nDec == nil, nDec := 2, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nImpUPreCli( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo          *= nTotNPreCli( uTmpLin )

   nCalculo          := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nIvaUPreCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUPreCli( dbfTmpLin, nDec, nVdv )
   nCalculo       := nCalculo * ( dbfTmpLin )->nIva / 100

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






FUNCTION nTotFPreCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo    := 0

   If( dbfLin == nil, dbfLin := D():PresupuestosClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .T., ) ;
   If( lImpTrn == nil, lImpTrn := .T., ) ;

   nCalculo          += nTotLPreCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )
   nCalculo          += nIvaLPreCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )


return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION cDesPreCli( cPreCliL )

   If( cPreCliL == nil, cPreCliL := D():PresupuestosClientesLineas( nView ), ) ;

RETURN ( Descrip( cPreCliL ) )



FUNCTION cDesPreCliLeng( cPreCliL, cArtLeng )

   If( cPreCliL == nil, cPreCliL := D():PresupuestosClientesLineas( nView ), ) ;
   If( cArtLeng == nil, cArtLeng := D():ArticuloLenguaje( nView ), ) ;

RETURN ( DescripLeng( cPreCliL, , cArtLeng ) )



Function isLineaTotalPreCli( uPreCliL )

   if isArray( uPreCliL )
      Return ( uPreCliL[ 23 ] )
   end

Return ( ( uPreCliL )->lTotLin )



Function nDescuentoLinealPreCli( uPreCliL, nDec, nVdv )

   local nDescuentoLineal

   if isArray( uPreCliL )
      nDescuentoLineal  := uPreCliL[ 30 ]
   else
      nDescuentoLineal  := ( uPreCliL )->nDtoDiv
   end

Return ( Round( nDescuentoLineal / nVdv, nDec ) )



Function nDescuentoPorcentualPreCli( uPreCliL )

   local nDescuentoPorcentual

   if isArray( uPreCliL )
      nDescuentoPorcentual  := uPreCliL[ 14 ]
   else
      nDescuentoPorcentual  := ( uPreCliL )->nDto
   end

Return ( nDescuentoPorcentual )



Function nDescuentoPromocionPreCli( uPreCliL )

   local nDescuentoPromocion

   if isArray( uPreCliL )
      nDescuentoPromocion  := uPreCliL[ 15 ]
   else
      nDescuentoPromocion  := ( uPreCliL )->nDtoPrm
   end

Return ( nDescuentoPromocion )



Function nPuntoVerdePreCli( uPreCliL )

   local nPuntoVerde

   if isArray( uPreCliL )
      nPuntoVerde  := uPreCliL[ 12 ]
   else
      nPuntoVerde  := ( uPreCliL )->nPntVer
   end

Return ( nPuntoVerde )



Function nTransportePreCli( uPreCliL )

   local nTransporte

   if isArray( uPreCliL )
      nTransporte  := uPreCliL[ 13 ]
   else
      nTransporte  := ( uPreCliL )->nImpTrn
   end

Return ( nTransporte )



FUNCTION nTotLPreCli( uPreCliL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo
   local nUnidades

   if empty( uPreCliL ) .AND. !empty( nView )
      uPreCliL       := D():PresupuestosClientesLineas( nView )
   end

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .T., ) ;
   If( lImpTrn == nil, lImpTrn := .T., ) ;

   if isLineaTotalPreCli( uPreCliL )

      nCalculo       := nTotUPreCli( uPreCliL, nDec, nVdv )

   else

      nUnidades      := nTotNPreCli( uPreCliL )
      nCalculo       := nTotUPreCli( uPreCliL, nDec, nVdv ) * nUnidades





      nCalculo       -= nDescuentoLinealPreCli( uPreCliL, nDec, nVdv ) * nUnidades

      if lDto .AND. nDescuentoPorcentualPreCli( uPreCliL ) <> 0
         nCalculo    -= nCalculo * nDescuentoPorcentualPreCli( uPreCliL ) / 100
      end

      if lDto .AND. nDescuentoPromocionPreCli( uPreCliL ) <> 0
         nCalculo    -= nCalculo * nDescuentoPromocionPreCli( uPreCliL ) / 100
      end





      if lPntVer .AND. nPuntoVerdePreCli( uPreCliL ) <> 0
         nCalculo    += nPuntoVerdePreCli( uPreCliL ) * nUnidades
      end





      if lImpTrn .AND. nTransportePreCli( uPreCliL ) <> 0
         nCalculo    += nTransportePreCli( uPreCliL ) * nUnidades
      end

   end

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

   if nRou <> nil
      nCalculo       := Round( Div( nCalculo, nVdv ), nRou )
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )






FUNCTION nDtoLPreCli( cPreCliL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cPreCliL == nil, cPreCliL := D():PresupuestosClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cPreCliL )->nDto <> 0 .AND. !( cPreCliL )->lTotLin

      nCalculo          := nTotUPreCli( cPreCliL, nDec ) * nTotNPreCli( cPreCliL )





      nCalculo          -= Round( ( cPreCliL )->nDtoDiv / nVdv , nDec )

      nCalculo          := nCalculo * ( cPreCliL )->nDto / 100


      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )






FUNCTION nPrmLPreCli( cPreCliL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cPreCliL == nil, cPreCliL := D():PresupuestosClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cPreCliL )->nDtoPrm <> 0 .AND. !( cPreCliL )->lTotLin

      nCalculo          := nTotUPreCli( cPreCliL, nDec ) * nTotNPreCli( cPreCliL )





      nCalculo          -= Round( ( cPreCliL )->nDtoDiv / nVdv , nDec )

      if ( cPreCliL )->nDto <> 0
         nCalculo       -= nCalculo * ( cPreCliL )->nDto / 100
      end

      nCalculo          := nCalculo * ( cPreCliL )->nDtoPrm / 100

      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )



FUNCTION nTotCPreCli( dbfLine, nDec, nRec, nVdv, cPouDiv )

   local nCalculo       := 0

   If( nDec == nil, nDec := 0, ) ;
   If( nRec == nil, nRec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLine )->lKitChl
      nCalculo          := nTotNPreCli( dbfLine )
      nCalculo          *= ( dbfLine )->nCosDiv
   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   nCalculo             := Round( nCalculo, nRec )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nPesLPreCli( cPreCliL )

   local nCalculo    := 0

   If( cPreCliL == nil, cPreCliL := D():PresupuestosClientesLineas( nView ), ) ;

   if !( cPreCliL )->lTotLin .AND. !( cPreCliL )->lControl
      nCalculo       := Abs( nTotNPreCli( cPreCliL ) ) * ( cPreCliL )->nPesoKg
   end

RETURN ( nCalculo )



FUNCTION nVolLPreCli( dbfLine )

   local nCalculo    := 0

   if !( dbfLine )->lTotLin .AND. !( dbfLine )->lControl
      nCalculo       := nTotNPreCli( dbfLine ) * ( dbfLine )->nVolumen
   end

RETURN ( nCalculo )



FUNCTION nIvaLPreCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo    := 0

   if ( dbfLin )->nRegIva <= 1

      nCalculo          := nTotLPreCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

      if !( dbfLin )->lIvaLin
         nCalculo       := nCalculo * ( dbfLin )->nIva / 100
      else
         nCalculo       -= nCalculo / ( 1 + ( dbfLin )->nIva / 100 )
      end

   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



Function nPntUPreCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nPntVer

   IF nVdv <> 0
      nCalculo    := ( dbfTmpLin )->nPntVer / nVdv
   end

RETURN ( round( nCalculo, nDec ) )



FUNCTION nPntLPreCli( dbfLin, nDec, nVdv )

   local nPntVer

   If( dbfLin == nil, dbfLin := D():PresupuestosClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := 2, ) ;
   If( nVdv == nil, nVdv := 1, ) ;





   nPntVer           := nPntUPreCli( dbfLin, nDec, nVdv )
   nPntVer           *= nTotNPreCli( dbfLin )

RETURN ( Round( nPntVer, nDec ) )



FUNCTION nTrnUPreCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nImpTrn

   IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nTrnLPreCli( dbfLin, nDec, nRou, nVdv )

   local nImpTrn

   If( dbfLin == nil, dbfLin := D():PresupuestosClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := 2, ) ;
   If( nRou == nil, nRou := 2, ) ;
   If( nVdv == nil, nVdv := 1, ) ;





   nImpTrn           := nTrnUPreCli( dbfLin, nDec ) * nTotNPreCli( dbfLin )

   IF nVdv <> 0
      nImpTrn        := nImpTrn / nVdv
   end

RETURN ( Round( nImpTrn, nRou ) )



FUNCTION nDtoUPreCli( dbfTmpLin, nDec, nVdv )

   local nCalculo := ( dbfTmpLin )->nDtoDiv

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if nVdv <> 0
      nCalculo    /= nVdv
   end

RETURN ( round( nCalculo, nDec ) )



FUNCTION mkPreCli( cPath, lAppend, cPathOld, oMeter, bFor )

   local dbfPreCliT
   local dbfPreCliL
   local dbfPreCliI
   local dbfPreCliD
   local oldPreCliT
   local oldPreCliL
   local oldPreCliI
   local oldPreCliD

   if oMeter <> NIL
      oMeter:cText   := "Generando Bases"
      sysrefresh()
   end

   If( lAppend == nil, lAppend := .F., ) ;
   If( bFor == nil, bFor := {|| .T. }, ) ;

   createFiles( cPath )

   rxPreCli( cPath, cLocalDriver() )

   If lAppend .AND. lIsDir( cPathOld )

      dbUseArea( .T., cDriver(), cPath + "PRECLIT.DBF", cCheckArea( "PRECLIT", @dbfPreCliT ), .F. )
      if !( dbfPreCliT )->( neterr() )
         ( dbfPreCliT )->( ordListAdd( cPath + "PreCliT.Cdx" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "PreCliL.DBF", cCheckArea( "PreCliL", @dbfPreCliL ), .F. )
      if !( dbfPreCliL )->( neterr() )
         ( dbfPreCliL )->( ordListAdd( cPath + "PreCliL.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "PreCliI.Dbf", cCheckArea( "PreCliI", @dbfPreCliI ), .F. )
      if !( dbfPreCliI )->( neterr() )
         ( dbfPreCliI )->( ordListAdd( cPath + "PreCliI.Cdx" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "PreCliD.Dbf", cCheckArea( "PreCliD", @dbfPreCliD ), .F. )
      if !( dbfPreCliD )->( neterr() )
         ( dbfPreCliD )->( ordListAdd( cPath + "PreCliD.Cdx" ) )
      end





      dbUseArea( .T., cDriver(), cPathOld + "PreCliT.DBF", cCheckArea( "PreCliT", @oldPreCliT ), .F. )
      if !( dbfPreCliT )->( neterr() )
         ( oldPreCliT )->( ordListAdd( cPathOld + "PreCliT.Cdx" ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "PreCliL.DBF", cCheckArea( "PreCliL", @oldPreCliL ), .F. )
      if !( oldPreCliL )->( neterr() )
         ( oldPreCliL )->( ordListAdd( cPathOld + "PreCliL.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "PreCliI.DBF", cCheckArea( "PreCliI", @oldPreCliI ), .F. )
      if !( oldPreCliI )->( neterr() )
         ( oldPreCliI )->( ordListAdd( cPathOld + "PreCliI.CDX"  ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "PreCliD.DBF", cCheckArea( "PreCliD", @oldPreCliD ), .F. )
      if !( oldPreCliD )->( neterr() )
         ( oldPreCliD )->( ordListAdd( cPathOld + "PreCliD.Cdx"  ) )
      end





      while !( oldPreCliT )->( eof() )

         if eval( bFor, oldPreCliT )

            dbCopy( oldPreCliT, dbfPreCliT, .T. )

            if ( oldPreCliL )->( dbSeek( ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre ) )
               while ( oldPreCliL )->cSerPre + Str( ( oldPreCliL )->nNumPre ) + ( oldPreCliL )->cSufPre == ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre .AND. !( oldPreCliL )->( eof() )
                  dbCopy( oldPreCliL, dbfPreCliL, .T. )
                  ( oldPreCliL )->( dbSkip() )
               end
            end

            if ( oldPreCliI )->( dbSeek( ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre ) )
               while ( oldPreCliI )->cSerPre + Str( ( oldPreCliI )->nNumPre ) + ( oldPreCliI )->cSufPre == ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre .AND. !( oldPreCliI )->( eof() )
                  dbCopy( oldPreCliI, dbfPreCliI, .T. )
                  ( oldPreCliI )->( dbSkip() )
               end
            end

            if ( oldPreCliD )->( dbSeek( ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre ) )
               while ( oldPreCliD )->cSerPre + Str( ( oldPreCliD )->nNumPre ) + ( oldPreCliD )->cSufPre == ( oldPreCliT )->cSerPre + Str( ( oldPreCliT )->nNumPre ) + ( oldPreCliT )->cSufPre .AND. !( oldPreCliI )->( eof() )
                  dbCopy( oldPreCliD, dbfPreCliD, .T. )
                  ( oldPreCliD )->( dbSkip() )
               end
            end

         end

         ( oldPreCliT )->( dbSkip() )

      end

      ( dbfPreCliT )->( dbCloseArea() )
      ( dbfPreCliL )->( dbCloseArea() )
      ( dbfPreCliI )->( dbCloseArea() )
      ( dbfPreCliD )->( dbCloseArea() )

      ( oldPreCliT )->( dbCloseArea() )
      ( oldPreCliL )->( dbCloseArea() )
      ( oldPreCliI )->( dbCloseArea() )
      ( oldPreCliD )->( dbCloseArea() )

   end

Return Nil



FUNCTION rxPreCli( cPath, cDriver )

   local dbfPreCliT

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;





   if !lExistTable( cPath + "PRECLIT.DBF", cDriver ) .OR.  !lExistTable( cPath + "PRECLIL.DBF", cDriver ) .OR.  !lExistTable( cPath + "PRECLII.DBF", cDriver ) .OR.  !lExistTable( cPath + "PRECLID.DBF", cDriver ) .OR.  !lExistTable( cPath + "PRECLIE.DBF", cDriver )

      CreateFiles( cPath )

   end

   fEraseIndex( cPath + "PreCliT.Cdx", cDriver )
   fEraseIndex( cPath + "PRECLIL.CDX", cDriver )
   fEraseIndex( cPath + "PRECLII.CDX", cDriver )
   fEraseIndex( cPath + "PreCliD.Cdx", cDriver )
   fEraseIndex( cPath + "PRECLIE.CDX", cDriver )

   dbUseArea( .T., cDriver, cPath + "PRECLIT.DBF", cCheckArea( "PRECLIT", @dbfPreCliT ), .F. )
   if !( dbfPreCliT )->( neterr() )
      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR(Field->NNUMPRE) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "DFECPRE", "DFECPRE", {|| Field->DFECPRE } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "CCODCLI", "CCODCLI + Dtos( dFecPre )", {|| Field->CCODCLI + Dtos( Field->dFecPre ) } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "CNOMCLI", "cNomCli + Dtos( dFecPre )", {|| Field->cNomCli + Dtos( Field->dFecPre ) } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "cCodObr", "cCodObr", {|| Field->cCodObr } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "cCodAge", "cCodAge", {|| Field->cCodAge } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "CTURPRE", "CTURPRE + CSUFPRE + cCodCaj", {|| Field->CTURPRE + Field->CSUFPRE + Field->cCodCaj } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "lSndDoc", "lSndDoc", {|| Field->lSndDoc } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "cCodUsr", "cCodUsr + Dtos( dFecCre ) + cTimCre", {|| Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "iNumPre", "'08' + cSerPre + Str( nNumPre ) + Space( 1 ) + cSufPre", {|| "08" + Field->cSerPre + Str( Field->nNumPre ) + Space( 1 ) + Field->cSufPre } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "cCodWeb", "Str( Field->cCodWeb )", {|| Str( Field->cCodWeb ) } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "Poblacion", "UPPER( Field->cPobCli )", {|| UPPER( Field->cPobCli ) } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "Provincia", "UPPER( Field->cPrvCli )", {|| UPPER( Field->cPrvCli ) } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "CodPostal", "Field->cPosCli", {|| Field->cPosCli } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}, , , , , , , , , .T. ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "dDesFec", "dFecPre", {|| Field->dFecPre } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliT.Cdx", "cSuPre", "Field->cSuPre", {|| Field->cSuPre } ) )

      ( dbfPreCliT )->( dbCloseArea() )

   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "PRECLIL.DBF", cCheckArea( "PRECLIL", @dbfPreCliT ), .F. )
   if !( dbfPreCliT )->( neterr() )
      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR( Field->NNUMPRE ) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "CREF", "CREF", {|| Field->CREF }, ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "Lote", "cLote", {|| Field->cLote }, ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "iNumPre", "'08' + cSerPre + Str( nNumPre ) + Space( 1 ) + cSufPre + Str( nNumLin )", {|| "08" + Field->cSerPre + Str( Field->nNumPre ) + Space( 1 ) + Field->cSufPre + Str( Field->nNumLin ) } ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "nNumLin", "Str( NNUMPRE ) + Str( nNumLin )", {|| Str( Field->nNumPre ) + Str( Field->nNumLin ) }, ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "cCodFam", "CSERPRE + STR( NNUMPRE ) + CSUFPRE + ccodFam", {|| Field->CSERPRE + STR( Field->NNUMPRE ) + Field->CSUFPRE + Field->cCodFam }, ) )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliL.Cdx", "nPosPrint", "cSerPre + Str( nNumPre ) + cSufPre + Str( nPosPrint )", {|| Field->cSerPre + Str( Field->nNumPre ) + Field->cSufPre + Str( Field->nPosPrint )}, ) )

      ( dbfPreCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "PRECLII.DBF", cCheckArea( "PRECLII", @dbfPreCliT ), .F. )
   if !( dbfPreCliT )->( neterr() )
      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliI.Cdx", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR(Field->NNUMPRE) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliI.Cdx", "iNumPre", "'08' + cSerPre + Str( nNumPre ) + Space( 1 ) + cSufPre", {|| "08" + Field->cSerPre + Str( Field->nNumPre ) + Space( 1 ) + Field->cSufPre } ) )

      ( dbfPreCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "PRECLID.DBF", cCheckArea( "PRECLID", @dbfPreCliT ), .F. )
   if !( dbfPreCliT )->( neterr() )
      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliD.Cdx", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR(Field->NNUMPRE) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliD.Cdx", "iNumPre", "'08' + cSerPre + Str( nNumPre ) + Space( 1 ) + cSufPre", {|| "08" + Field->cSerPre + Str( Field->nNumPre ) + Space( 1 ) + Field->cSufPre } ) )

      ( dbfPreCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "PreCliE.DBF", cCheckArea( "PreCliE", @dbfPreCliT ), .F. )

   if !( dbfPreCliT )->( neterr() )

      ( dbfPreCliT )->( __dbPack() )

      ( dbfPreCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliE.CDX", "NNUMPRE", "CSERPRE + STR( NNUMPRE ) + CSUFPRE", {|| Field->CSERPRE + STR( Field->NNUMPRE ) + Field->CSUFPRE } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliE.Cdx", "cSitua", "cSitua", {|| Field->cSitua } ) )

      ( dbfPreCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfPreCliT )->( ordCreate( cPath + "PreCliE.Cdx", "idPs", "str( idPs )", {|| str( Field->idPs ) } ) )

      ( dbfPreCliT )->( dbCloseArea() )

   else

      msgStop( "Imposible abrir en modo exclusivo la tabla de presupuestos de clientes" )

   end

RETURN NIL



FUNCTION nTotNPreCli( uDbf )

   local nTotUnd

   If( uDbf == nil, uDbf := D():PresupuestosClientesLineas( nView ), ) ;

   do case
   case ValType( uDbf ) == "A"

      nTotUnd  := NotBulto( uDbf[ 81 ] )
      nTotUnd  *= NotCaja( uDbf[ 7 ] )
      nTotUnd  *= uDbf[ 8 ]
      nTotUnd  *= NotCero( uDbf[ 10 ] )
      nTotUnd  *= NotCero( uDbf[ 70 ] )
      nTotUnd  *= NotCero( uDbf[ 71 ] )
      nTotUnd  *= NotCero( uDbf[ 72 ] )

   case ValType( uDbf ) == "O"

      nTotUnd  := NotBulto( uDbf:nBultos )
      nTotUnd  *= NotCaja( uDbf:nCanPre )
      nTotUnd  *= uDbf:nUniCaja
      nTotUnd  *= NotCero( uDbf:nUndKit )
      nTotUnd  *= NotCero( uDbf:nMedUno )
      nTotUnd  *= NotCero( uDbf:nMedDos )
      nTotUnd  *= NotCero( uDbf:nMedTre )

   otherwise

      nTotUnd  := NotBulto( ( uDbf )->nBultos )
      nTotUnd  *= NotCaja( ( uDbf )->nCanPre )
      nTotUnd  *= ( uDbf )->nUniCaja
      nTotUnd  *= NotCero( ( uDbf )->nUndKit )
      nTotUnd  *= NotCero( ( uDbf )->nMedUno )
      nTotUnd  *= NotCero( ( uDbf )->nMedDos )
      nTotUnd  *= NotCero( ( uDbf )->nMedTre )

   end

RETURN ( nTotUnd )



FUNCTION nTotIPreCli( dbfLin, nDec, nRouDec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( dbfLin == nil, dbfLin := D():PresupuestosClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := 0, ) ;
   If( nRouDec == nil, nRouDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   IF !( dbfLin )->LTOTLIN





      nCalculo       := Round( ( dbfLin )->nValImp, nDec )





      nCalculo       *= nTotNPreCli( dbfLin )

         if ( dbfLin )->LVOLIMP
            nCalculo *= NotCero( ( dbfLin )->nVolumen )
         end

      nCalculo       := Round( nCalculo / nVdv, nRouDec )

   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nImpLPreCli( uPreCliT, uPreCliL, nDec, nRou, nVdv, lIva, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo
   local lIvaInc

   If( nDec == nil, nDec := 0, ) ;
   If( nRou == nil, nRou := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lIva == nil, lIva := .F., ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .F., ) ;
   If( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo          := nTotLPreCli( uPreCliL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if ValType( uPreCliT ) == "A"
      nCalculo       -= Round( nCalculo * uPreCliT[ 30 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uPreCliT[ 32    ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uPreCliT[ 34 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uPreCliT[ 36 ]  / 100, nRou )
      lIvaInc        := uPreCliT[ 52 ]
   else
      nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoEsp / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uPreCliT )->nDpp    / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoUno / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoDos / 100, nRou )
      lIvaInc        := ( uPreCliT )->lIvaInc
   end

   if ( uPreCliL )->nIva <> 0
      if lIva
         if !lIvaInc
            nCalculo += Round( nCalculo * ( uPreCliL )->nIva / 100, nRou )
         end
      else
         if lIvaInc
            nCalculo -= Round( nCalculo / ( 100 / ( uPreCliL )->nIva  + 1 ), nRou )
         end
      end
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nDtoAtpPreCli( uPreCliT, uPreCliL, nDec, nRou, nVdv, lPntVer, lImpTrn )

   local nCalculo    := 0
   local nDtoAtp     := 0

   If( nDec == nil, nDec := 0, ) ;
   If( nRou == nil, nRou := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lPntVer == nil, lPntVer := .F., ) ;
   If( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo          := nTotLPreCli( uPreCliL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if ( uPreCliT )->nSbrAtp <= 1 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoEsp / 100, nRou )

   if ( uPreCliT )->nSbrAtp == 2 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uPreCliT )->nDpp    / 100, nRou )

   if ( uPreCliT )->nSbrAtp == 3 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoUno / 100, nRou )

   if ( uPreCliT )->nSbrAtp == 4 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uPreCliT )->nDtoDos / 100, nRou )

   if ( uPreCliT )->nSbrAtp == 5 .AND. ( uPreCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uPreCliT )->nDtoAtp / 100, nRou )
   end

RETURN ( nDtoAtp )



FUNCTION nComLPreCli( cPreCliT, uPreCliL, nDecOut, nDerOut )

   local nImp        := nImpLPreCli( cPreCliT, uPreCliL, nDecOut, nDerOut )

RETURN ( nImp * ( uPreCliL )->nComAge / 100 )



FUNCTION dFecPreCli( cPreCli, cPreCliT )

   local dFecPre  := CtoD("")

   IF ( cPreCliT )->( dbSeek( cPreCli ) )
      dFecPre  := ( cPreCliT )->dFecPre
   end

RETURN ( dFecPre )



FUNCTION lEstPreCli( cPreCli, cPreCliT )

   local lEstPre  := .F.

   IF ( cPreCliT )->( dbSeek( cPreCli ) )
      lEstPre     := ( cPreCliT )->lEstado
   end

RETURN ( lEstPre )



FUNCTION cNbrPreCli( cPreCli, cPreCliT )

   local cNomCli  := ""

   IF ( cPreCliT )->( dbSeek( cPreCli ) )
      cNomCli  := ( cPreCliT )->CNOMCLI
   end

RETURN ( cNomCli )






function nTotDPreCli( cCodArt, dbfPreCliL )

   local nTotVta  := 0
   local nRecno   := ( dbfPreCliL )->( Recno() )

   if ( dbfPreCliL )->( dbSeek( cCodArt ) )

      while ( dbfPreCliL )->CREF == cCodArt .AND. !( dbfPreCliL )->( eof() )

         If !( dbfPreCliL )->LTOTLIN
            nTotVta += nTotNPreCli( dbfPreCliL )
         end

         ( dbfPreCliL )->( dbSkip() )

      end

   end

   ( dbfPreCliL )->( dbGoTo( nRecno ) )

return ( nTotVta )



function nVtaPreCli( cCodCli, dDesde, dHasta, cPreCliT, cPreCliL, dbfIva, dbfDiv )

   local nCon     := 0
   local nRec     := ( cPreCliT )->( Recno() )





   if ( cPreCliT )->( dbSeek( cCodCli ) )

      while ( cPreCliT )->cCodCli == cCodCli .AND. !( cPreCliT )->( Eof() )


         if ( dDesde == nil .OR. ( cPreCliT )->dFecPre >= dDesde )    .AND. ( dHasta == nil .OR. ( cPreCliT )->dFecPre <= dHasta )

            nCon  += nTotPreCli( ( cPreCliT )->cSerPre + Str( ( cPreCliT )->nNumPre ) + ( cPreCliT )->cSufPre, cPreCliT, cPreCliL, dbfIva, dbfDiv, nil, nil, cDivEmp(), .F. )

         end

         ( cPreCliT )->( dbSkip() )

      end

   end

   ( cPreCliT )->( dbGoTo( nRec ) )

return nCon



FUNCTION aDocPreCli()

   local aDoc  := {}





   aAdd( aDoc, { "Empresa",         "EM" } )
   aAdd( aDoc, { "Presupuesto",     "RC" } )
   aAdd( aDoc, { "Cliente",         "CL" } )
   aAdd( aDoc, { "Almacen",         "AL" } )
   aAdd( aDoc, { "Obras",           "OB" } )
   aAdd( aDoc, { "Rutas",           "RT" } )
   aAdd( aDoc, { "Agentes",         "AG" } )
   aAdd( aDoc, { "Divisas",         "DV" } )
   aAdd( aDoc, { "Formas de pago",  "PG" } )
   aAdd( aDoc, { "Transportistas",  "TR" } )

RETURN ( aDoc )



function aItmPreCli()

   local aItmPreCli :=  {}

   aAdd( aItmPreCli, { "CSERPRE",   "C",  1,  0, "Serie de presupuesto" ,                             "Serie",                         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NNUMPRE",   "N",  9,  0, "Número de presupuesto" ,                            "Numero",                        "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CSUFPRE",   "C",  2,  0, "Sufijo de presupuesto" ,                            "Sufijo",                        "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CTURPRE",   "C",  6,  0, "Sesión del presupuesto",                            "Turno",                         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "DFECPRE",   "D",  8,  0, "Fecha del presupuesto",                             "Fecha",                         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCODCLI",   "C", 12,  0, "Código del cliente",                                "Cliente",                       "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CNOMCLI",   "C", 80,  0, "Nombre del cliente",                                "NombreCliente",                 "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CDIRCLI",   "C",200,  0, "Domicilio del cliente",                             "DomicilioCliente",              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CPOBCLI",   "C",200,  0, "Población del cliente",                             "PoblacionCliente",              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CPRVCLI",   "C",100,  0, "Provincia del cliente",                             "ProvinciaCliente",              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CPOSCLI",   "C", 15,  0, "Código postal del cliente",                         "CodigoPostalCliente",           "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CDNICLI",   "C", 30,  0, "DNI del cliente",                                   "DniCliente",                    "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "LMODCLI",   "L",  1,  0, "Modificar datos del cliente",                       "ModificarDatosCliente",         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCODAGE",   "C",  3,  0, "Código del agente",                                 "Agente",                        "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCODOBR",   "C", 10,  0, "Código de dirección",                               "Direccion",                     "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCODTAR",   "C",  5,  0, "Código de tarifa",                                  "Tarifa",                        "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCODALM",   "C", 16,  0, "Código del almacen",                                "Almacen",                       "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCODCAJ",   "C",  3,  0, "Código de caja",                                    "Caja",                          "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCODPGO",   "C",  2,  0, "Código de pago",                                    "Pago",                          "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCODRUT",   "C",  4,  0, "Código de la ruta",                                 "Ruta",                          "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "DFECENT",   "D",  8,  0, "Fecha de entrada",                                  "FechaSalida",                   "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "LESTADO",   "L",  1,  0, "Estado del presupuesto",                            "Estado",                        "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CSUPRE",    "C", 10,  0, "Su presupuesto",                                    "DocumentoOrigen",               "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CCONDENT",  "C",100,  0, "Condiciones del presupuesto",                       "Condiciones",                   "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "MCOMENT",   "M", 10,  0, "Comentarios",                                       "Comentarios",                   "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "MOBSERV",   "M", 10,  0, "Observaciones",                                     "Observaciones",                 "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "LMAYOR",    "L",  1,  0, "" ,                                                 "",                              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NTARIFA",   "N",  1,  0, "Tarifa de precio aplicada" ,                        "NumeroTarifa",                  "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CDTOESP",   "C", 50,  0, "Descripción del descuento",                         "DescripcionDescuento1",         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDTOESP",   "N",  5,  2, "Porcentaje de descuento",                           "PorcentajeDescuento1",          "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CDPP",      "C", 50,  0, "Descripción del descuento por pronto pago",         "DescripcionDescuento2",         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDPP",      "N",  5,  2, "Pct. de dto. por pronto pago",                      "PorcentajeDescuento2",          "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CDTOUNO",   "C", 50,  0, "Desc. del primer descuento pers.",                  "DescripcionDescuento3",         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDTOUNO",   "N",  5,  2, "Pct. del primer descuento pers.",                   "PorcentajeDescuento3",          "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CDTODOS",   "C", 50,  0, "Desc. del segundo descuento pers.",                 "DescripcionDescuento4",         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDTODOS",   "N",  5,  2, "Pct. del segundo descuento pers.",                  "PorcentajeDescuento4",          "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDTOCNT",   "N",  5,  2, "Pct. de dto. por pago contado",                     "",                              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDTORAP",   "N",  5,  2, "Pct. de dto. por rappel",                           "",                              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDTOPUB",   "N",  5,  2, "Pct. de dto. por publicidad",                       "",                              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDTOPGO",   "N",  5,  2, "Pct. de dto. por pago centralizado",                "",                              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NDTOPTF",   "N",  7,  2, "",                                                  "",                              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "LRECARGO",  "L",  1,  0, "Aplicar recargo de equivalencia",                   "RecargoEquivalencia",           "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NPCTCOMAGE","N",  5,  2, "Pct. de comisión del agente",                       "ComisionAgente",                "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NBULTOS",   "N",  5,  0, "Numero de bultos",                                  "Bultos",                        "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CNUMALB",   "C", 10,  0, "" ,                                                 "NumeroAlbaran",                 "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CDIVPRE",   "C",  3,  0, "Código de divisa",                                  "Divisa",                        "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NVDVPRE",   "N", 10,  4, "Valor del cambio de la divisa",                     "ValorDivisa",                   "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "LSNDDOC",   "L",  1,  0, "Valor lógico documento enviado",                    "Envio",                         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CRETPOR",   "C",150,  0, "Retirado por" ,                                     "RetiradoPor",                   "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "CRETMAT",   "C",150,  0, "Matrícula" ,                                        "Matricula",                     "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NREGIVA",   "N",  1,  0, "Regimen de " + cImp() ,                             "TipoImpuesto",                  "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "LIVAINC",   "L",  1,  0, "Lógico de " + cImp() + " incluido" ,                "ImpuestosIncluidos",            "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NIVAMAN",   "N",  6,  2, "Porcentaje de " + cImp() + " del gasto" ,           "ImpuestoGastos",                "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "NMANOBR",   "N", 16,  6, "Gastos" ,                                           "Gastos",                        "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cCodTrn",   "C",  9,  0, "Código de transportista" ,                          "Transportista",                 "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nKgsTrn"   ,"N", 16,  6, "TARA del transportista" ,                           "TaraTransportista",             "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "lCloPre",   "L",  1,  0, "Lógico de presupuesto cerrado" ,                    "DocumentoCerrado",              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cCodUsr",   "C",  3,  0, "Código de usuario",                                 "Usuario",                       "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "dFecCre",   "D",  8,  0, "Fecha de creación del documento",                   "FechaCreacion",                 "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cTimCre",   "C",  5,  0, "Hora de creación del documento",                    "HoraCreacion",                  "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cSituac",   "C", 20,  0, "Situación del documento",                           "Situacion",                     "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nDiaVal",   "N",  3,  0, "Dias de validez",                                   "DiasValidez",                   "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cCodGrp",   "C",  4,  0, "Código de grupo de cliente",                        "GrupoCliente",                  "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "lImprimido","L",  1,  0, "Lógico de imprimido del documento",                 "Imprimido",                     "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "dFecImp",   "D",  8,  0, "Última fecha de impresión del documento",           "FechaImpresion",                "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cHorImp",   "C",  5,  0, "Hora de la última impresión del documento",         "HoraImpresion",                 "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cCodDlg",   "C",  2,  0, "Código delegación" ,                                "Delegacion",                    "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nDtoAtp",   "N",  6,  2, "Porcentaje de descuento atípico",                   "DescuentoAtipico",              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nSbrAtp",   "N",  1,  0, "Lugar donde aplicar dto atípico",                   "LugarAplicarDescuentoAtipico",  "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "dFecEntr",  "D",  8,  0, "Fecha de entrada de alquiler",                      "EntradaAlquiler",               "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "dFecSal",   "D",  8,  0, "Fecha de salidad de alquiler",                      "SalidaAlquiler",                "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "lAlquiler", "L",  1,  0, "Lógico de alquiler",                                "Alquiler",                      "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cManObr",   "C",250,  0, "Literal de gastos" ,                                "LiteralGastos",                 "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cNumTik",   "C", 13,  0, "Número del ticket generado" ,                       "NumeroTicket",                  "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cTlfCli",   "C", 20,  0, "Teléfono del cliente" ,                             "TelefonoCliente",               "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nTotNet",   "N", 16,  6, "Total neto" ,                                       "TotalNeto",                     "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nTotIva",   "N", 16,  6, "Total " + cImp() ,                                  "TotalImpuesto",                 "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nTotReq",   "N", 16,  6, "Total recargo" ,                                    "TotalRecargo",                  "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nTotPre",   "N", 16,  6, "Total presupuesto" ,                                "TotalDocumento",                "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "lOperPV",   "L",  1,  0, "Lógico para operar con punto verde" ,               "OperarPuntoVerde",              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "nDtoTarifa","N",  6,  2, "Descuento de tarifa de cliente",                    "DescuentoTarifa",               "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cCodWeb",   "N", 11,  0, "Codigo del presupuesto en la web" ,                 "CodigoWeb",                     "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "lWeb",      "L",  1,  0, "Lógico de recibido por web" ,                       "",                              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "lInternet", "L",  1,  0, "Pedido desde internet" ,                            "",                              "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "mFirma",    "M", 10,  2, "Firma",                                             "Firma",                         "", "( cDbf )", nil } )
   aAdd( aItmPreCli, { "cCtrCoste", "C",  9,  0, "Código del centro de coste" ,                       "CentroCoste",                   "", "( cDbf )", nil } )

return ( aItmPreCli )



function aCalPreCli()












































   local aCalPreCli  := {  { "nTotArt",                                                   "N", 16,  6, "Total artículos",             "cPicUndPre",  "" }, { "nTotCaj",                                                   "N", 16,  6, "Total cajas",                 "cPicUndPre",  "" }, { "aTotIva[1,1]",                                              "N", 16,  6, "Bruto primer tipo de " + cImp(),    "cPorDivPre",  "aTotIva[1,1] != 0" }, { "aTotIva[2,1]",                                              "N", 16,  6, "Bruto segundo tipo de " + cImp(),   "cPorDivPre",  "aTotIva[2,1] != 0" }, { "aTotIva[3,1]",                                              "N", 16,  6, "Bruto tercer tipo de " + cImp(),    "cPorDivPre",  "aTotIva[3,1] != 0" }, { "aTotIva[1,2]",                                              "N", 16,  6, "Base primer tipo de " + cImp(),     "cPorDivPre",  "aTotIva[1,2] != 0" }, { "aTotIva[2,2]",                                              "N", 16,  6, "Base segundo tipo de " + cImp(),    "cPorDivPre",  "aTotIva[2,2] != 0" }, { "aTotIva[3,2]",                                              "N", 16,  6, "Base tercer tipo de " + cImp(),     "cPorDivPre",  "aTotIva[3,2] != 0" }, { "aTotIva[1,3]",                                              "N",  5,  2, "Porcentaje primer tipo " + cImp(),  "'@R 99.99%'", "aTotIva[1,3] != 0" }, { "aTotIva[2,3]",                                              "N",  5,  2, "Porcentaje segundo tipo " + cImp(), "'@R 99.99%'", "aTotIva[2,3] != 0" }, { "aTotIva[3,3]",                                              "N",  5,  2, "Porcentaje tercer tipo " + cImp(),  "'@R 99.99%'", "aTotIva[3,3] != 0" }, { "aTotIva[1,4]",                                              "N",  5,  2, "Porcentaje primer tipo RE",   "'@R 99.99%'", "aTotIva[1,4] != 0" }, { "aTotIva[2,4]",                                              "N",  5,  2, "Porcentaje segundo tipo RE",  "'@R 99.99%'", "aTotIva[2,4] != 0" }, { "aTotIva[3,4]",                                              "N",  5,  2, "Porcentaje tercer tipo RE",   "'@R 99.99%'", "aTotIva[3,4] != 0" }, { "round( aTotIva[1,2] * aTotIva[1,3] / 100, nDouDivPre )",    "N", 16,  6, "Importe primer tipo " + cImp(),     "cPorDivPre",  "aTotIva[1,2] != 0" }, { "round( aTotIva[2,2] * aTotIva[2,3] / 100, nDouDivPre )",    "N", 16,  6, "Importe segundo tipo " + cImp(),    "cPorDivPre",  "aTotIva[2,2] != 0" }, { "round( aTotIva[3,2] * aTotIva[3,3] / 100, nDouDivPre )",    "N", 16,  6, "Importe tercer tipo " + cImp(),     "cPorDivPre",  "aTotIva[3,2] != 0" }, { "round( aTotIva[1,2] * aTotIva[1,4] / 100, nDouDivPre )",    "N", 16,  6, "Importe primer RE",           "cPorDivPre",  "aTotIva[1,2] != 0" }, { "round( aTotIva[2,2] * aTotIva[2,4] / 100, nDouDivPre )",    "N", 16,  6, "Importe segundo RE",          "cPorDivPre",  "aTotIva[2,2] != 0" }, { "round( aTotIva[3,2] * aTotIva[3,4] / 100, nDouDivPre )",    "N", 16,  6, "Importe tercer RE",           "cPorDivPre",  "aTotIva[3,2] != 0" }, { "aTotIvm[1,1]",                                              "N", 16,  6, "Total unidades primer tipo de impuestos especiales",    "cPorDivPre",  "aTotIvm[1,1] != 0" }, { "aTotIvm[2,1]",                                              "N", 16,  6, "Total unidades segundo tipo de impuestos especiales",   "cPorDivPre",  "aTotIvm[2,1] != 0" }, { "aTotIvm[3,1]",                                              "N", 16,  6, "Total unidades tercer tipo de impuestos especiales",    "cPorDivPre",  "aTotIvm[3,1] != 0" }, { "aTotIva[1,2]",                                              "N", 16,  6, "Importe del primer tipo de impuestos especiales",       "cPorDivPre",  "aTotIvm[1,2] != 0" }, { "aTotIva[2,2]",                                              "N", 16,  6, "Importe del segundo tipo de impuestos especiales",      "cPorDivPre",  "aTotIvm[2,2] != 0" }, { "aTotIva[3,2]",                                              "N", 16,  6, "Importe del tercer tipo de impuestos especiales",       "cPorDivPre",  "aTotIvm[3,2] != 0" }, { "aTotIvm[1,3]",                                              "N", 16,  6, "Total importe primer tipo de impuestos especiales",     "cPorDivPre",  "aTotIvm[1,3] != 0" }, { "aTotIvm[2,3]",                                              "N", 16,  6, "Total importe segundo tipo de impuestos especiales",    "cPorDivPre",  "aTotIvm[2,3] != 0" }, { "aTotIvm[3,3]",                                              "N", 16,  6, "Total importe tercer tipo de impuestos especiales",     "cPorDivPre",  "aTotIvm[3,3] != 0" }, { "nTotBrt",                                                   "N", 16,  6, "Total bruto",                 "cPorDivPre",  "lEnd" }, { "nTotDto",                                                   "N", 16,  6, "Total descuento",             "cPorDivPre",  "lEnd" }, { "nTotDpp",                                                   "N", 16,  6, "Total descuento pronto pago", "cPorDivPre",  "lEnd" }, { "nTotNet",                                                   "N", 16,  6, "Total neto",                  "cPorDivPre",  "lEnd" }, { "nTotIva",                                                   "N", 16,  6, "Total " + cImp(),             "cPorDivPre",  "lEnd" }, { "nTotIvm",                                                   "N", 16,  6, "Total IVMH",                  "cPorDivPre",  "lEnd" }, { "nTotReq",                                                   "N", 16,  6, "Total RE",                    "cPorDivPre",  "lEnd" }, { "nTotPre",                                                   "N", 16,  6, "Total presupuesto",           "cPorDivPre",  "lEnd" }, { "nTotPes",                                                   "N", 16,  6, "Total peso",                  "'@E 99,999.99'","lEnd" }, { "nTotCos",                                                   "N", 16,  6, "Total costo",                 "cPorDivPre",  "lEnd" }, { "nTotPage",                                                  "N", 16,  6, "Total página",                "cPorDivPre",  "!lEnd" }, { "nImpEuros( nTotPre, (cDbf)->cDivPre, cDbfDiv )",            "N", 16,  6, "Total Presupuesto (Euros)",   "",            "lEnd" }, { "nImpPesetas( nTotPre, (cDbf)->cDivPre, cDbfDiv )",          "N", 16,  6, "Total Presupuesto (Pesetas)", "",            "lEnd" }, { "nPagina",                                                   "N",  2,  0, "Numero de página",            "'99'",        "" }, { "lEnd",                                                      "L",  1,  0, "Fin del documento",           "",            "" } }

return ( aCalPreCli )



function aColPreCli()

   local aColPreCli  := {}

   aAdd( aColPreCli, { "cSerPre", "C",    1,  0, "Serie de presupuesto" ,                    "Serie",                         "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nNumPre", "N",    9,  0, "Numero de presupuesto" ,                   "Numero",                        "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cSufPre", "C",    2,  0, "Sufijo de presupuesto" ,                   "Sufijo",                        "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cRef",    "C",   18,  0, "Referencia del producto" ,                 "Articulo",                      "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cDetalle","C",  250,  0, "Descripción de artículo" ,                 "DescripcionArticulo",           "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nIva"    ,"N",    6,  2, "Importe del " + cImp() ,                   "PorcentajeImpuesto",            "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nCanPre" ,"N",   16,  6, cNombreCajas(),                             "Cajas",                         "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nUniCaja","N",   16,  6, cNombreUnidades(),                          "Unidades",                      "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lControl","L",    1,  0, "" ,                                        "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nUndKit", "N",   16,  6, "Unidades tipo kit" ,                       "UnidadesKit",                   "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nPreDiv" ,"N",   16,  6, "Importe del producto" ,                    "PrecioVenta",                   "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nPntVer", "N",   16,  6, "Importe punto verde" ,                     "PuntoVerde",                    "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nImpTrn", "N",   16,  6, "Importe del transporte",                   "Portes",                        "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nDto",    "N",    6,  2, "Descuento del producto" ,                  "DescuentoPorcentual",           "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nDtoPrm", "N",    6,  2, "Descuento de la promoción" ,               "DescuentoPromocion",            "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nComAge", "N",    6,  2, "Comisión del agente" ,                     "ComisionAgente",                "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nCanEnt", "N",   16,  6, "Unidades de entrada" ,                     "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cUnidad", "C",    2,  0, "Unidad de venta" ,                         "UnidadMedicion",                "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nPesokg", "N",   16,  6, "Peso del producto" ,                       "Peso",                          "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cPesokg", "C",    2,  0, "Unidad de peso del producto" ,             "UnidadMedicionPeso",            "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "dFecha",  "D",    8,  0, "Fecha de entrega",                         "FechaEntrega",                  "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "mLngDes", "M",   10,  0, "Descripción de artículo sin codificar",    "DescripcionAmpliada",           "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lTotLin", "L",    1,  0, "Linea de total" ,                          "LineaTotal",                    "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lImpLin", "L",    1,  0, "Linea no imprimible" ,                     "LineaNoImprimible",             "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cCodPr1", "C",   20,  0, "Código de la primera propiedad",           "CodigoPropiedad1",              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cCodPr2", "C",   20,  0, "Código de la segunda propiedad",           "CodigoPropiedad2",              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cValPr1", "C",   20,  0, "Valor de la primera propiedad",            "ValorPropiedad1",               "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cValPr2", "C",   20,  0, "Valor de la segunda propiedad",            "ValorPropiedad2",               "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nFacCnv", "N",   16,  6, "Factor de conversión de la compra",        "FactorConversion",              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nDtoDiv", "N",   16,  6, "Descuento lineal de la compra",            "DescuentoLineal",               "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cTipMov", "C",    2,  0, "Tipo de movimiento",                       "Tipo",                          "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nNumLin", "N",    4,  0, "Numero de la línea",                       "NumeroLinea",                   "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nCtlStk", "N",    1,  0, "Tipo de stock de la línea",                "TipoStock",                     "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nCosDiv", "N",   16,  6, "Costo del producto" ,                      "PrecioCosto",                   "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nPvpRec", "N",   16,  6, "Precio de venta recomendado" ,             "PrecioVentaRecomendado",        "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cAlmLin", "C",   16,  0, "Código de almacén" ,                       "Almacen",                       "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lIvaLin", "L",    1,  0, "Línea con " + cImp() + " incluido",        "LineaImpuestoIncluido",         "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cCodImp", "C",    3,  0, "Código del impuesto especial",             "ImpuestoEspecial",              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nValImp", "N",   16,  6, "Importe de impuesto",                      "ImporteImpuestoEspecial",       "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lLote",   "L",    1,  0, "",                                         "LogicoLote",                    "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nLote",   "N",    9,  0, "",                                         "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cLote",   "C",   64,  0, "Número de Lote",                           "Lote",                          "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lKitArt", "L",    1,  0, "Línea con escandallo",                     "LineaEscandallo" ,              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lKitChl", "L",    1,  0, "Línea pertenciente a escandallo",          "LineaPerteneceEscandallo" ,     "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lKitPrc", "L",    1,  0, "Línea de escandallos con precio",          "LineaEscandalloPrecio" ,        "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nMesGrt", "N",    2,  0, "Meses de garantía",                        "MesesGarantia",                 "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lMsgVta", "L",    1,  0, "Avisar en venta sin stocks",               "AvisarSinStock",                "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lNotVta", "L",    1,  0, "No permitir venta sin stocks",             "NoPermitirSinStock",            "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "mNumSer", "M",   10,  0, "" ,                                        "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cCodTip", "C",    4,  0, "Código del tipo de artículo",              "TipoArticulo",                  "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cCodFam", "C",   16,  0, "Código de familia",                        "Familia",                       "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cGrpFam", "C",    3,  0, "Código del grupo de familia",              "GrupoFamilia",                  "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nReq",    "N",   16,  6, "Recargo de equivalencia",                  "RecargoEquivalencia",           "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "mObsLin", "M",   10,  0, "Observacion de línea",                     "Observaciones",                 "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cCodPrv", "C",   12,  0, "Código del proveedor",                     "Proveedor",                     "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cNomPrv", "C",   30,  0, "Nombre del proveedor",                     "NombreProveedor",               "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cImagen", "C",  250,  0, "Fichero de imagen" ,                       "Imagen",                        "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nPuntos", "N",   15,  6, "Puntos del artículo",                      "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nValPnt", "N",   16,  6, "Valor del punto",                          "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nDtoPnt", "N",    5,  2, "Descuento puntos",                         "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nIncPnt", "N",    5,  2, "Incremento porcentual",                    "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cRefPrv", "C",   18,  0, "Referencia artículo proveedor",            "ReferenciaProveedor",           "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nVolumen","N",   16,  6, "Volumen del producto" ,                    "Volumen",                       "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cVolumen","C",    2,  0, "Unidad del volumen" ,                      "UnidadMedicionVolumen",         "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "dFecEnt" ,"D",    8,  0, "Fecha de entrada del alquiler",            "FechaEntradaAlquiler",          "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "dFecSal" ,"D",    8,  0, "Fecha de salida del alquiler",             "FechaSalidaAlquiler",           "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nPreAlq" ,"N",   16,  6, "Precio de alquiler",                       "PrecioAlquiler",                "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lAlquiler","L",   1,  0, "Lógico de alquiler",                       "Alquiler",                      "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nNumMed"  ,"N",   1,  0, "Número de mediciones",                     "NumeroMedidiones",              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nMedUno"  ,"N",  16,  6, "Primera unidad de medición",               "Medicion1",                     "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nMedDos"  ,"N",  16,  6, "Segunda unidad de medición",               "Medicion2",                     "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nMedTre"  ,"N",  16,  6, "Tercera unidad de medición",               "Medicion3",                     "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nTarLin"  ,"N",   1,  0, "Tarifa de precio aplicada" ,               "NumeroTarifa",                  "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lImpFra"  ,"L",   1,  0, "Lógico de imprimir frase publicitaria",    "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cCodFra"  ,"C",   3,  0, "Código de frase publicitaria",             "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cTxtFra"  ,"C", 250,  0, "",                                         "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "Descrip"  ,"M",  10,  0, "Descripción larga",                        "DescripcionTecnica",            "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lLinOfe"  ,"L",   1,  0, "Línea con oferta",                         "LineaOferta",                   "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lVolImp"  ,"L",   1,  0, "Lógico aplicar volumen con IpusEsp",       "VolumenImpuestosEspeciales",    "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "dFecCad"  ,"D",   8,  0, "Fecha de caducidad",                       "FechaCaducidad",                "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nBultos"  ,"N",  16,  6, "Numero de bultos en líneas",               "Bultos",                        "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cFormato" ,"C", 100,  0, "Formato de venta",                         "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "lLabel"   ,"L",   1,  0, "Lógico para marca de etiqueta",            "LogicoEtiqueta",                "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nLabel"   ,"N",   6,  0, "Unidades de etiquetas a imprimir",         "NumeroEtiqueta",                "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cObrLin"  ,"C",  10,  0, "Dirección de la linea",                    "Direccion",                     "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cRefAux"  ,"C",  18,  0, "Referencia auxiliar",                      "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cRefAux2" ,"C",  18,  0, "Segunda referencia auxiliar",              "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nPosPrint","N",   4,  0, "Posición de impresión",                    "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cCtrCoste","C",   9,  0, "Código del centro de coste",               "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cTipCtr",  "C",  20,  0, "Tipo tercero centro de coste",             "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "cTerCtr",  "C",  20,  0, "Tercero centro de coste",                  "",                              "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "id_tipo_v","N",  16,  0, "Identificador tipo de venta",              "IdentificadorTipoVenta",        "", "( cDbfCol )", nil } )
   aAdd( aColPreCli, { "nRegIva",  "N",   1,  0, "Régimen de " + cImp(),                     "TipoImpuesto",                  "", "( cDbfCol )", nil } )

return ( aColPreCli )



function aCocPreCli()

   local aCocPreCli :=  {}

   aAdd( aCocPreCli, { "Descrip( cDbfCol )",                                         "C", 50, 0, "Detalle del artículo",       "",            "Descripción", "" } )
   aAdd( aCocPreCli, { "nTotNPreCli( cDbfCol )",                                     "N", 16, 6, "Total articulos",            "MasUnd()",    "Unidades",    "" } )
   aAdd( aCocPreCli, { "nTotUPreCli( cDbfCol, nDouDivPre, nVdvDivPre )",             "N", 16, 6, "Precio unitario",            "cPouDivPre",  "Precio",      "" } )
   aAdd( aCocPreCli, { "nTotLPreCli( cDbfCol, nDouDivPre, nRouDivPre, nVdvDivPre )", "N", 16, 6, "Total línea de presupuesto", "cPorDivPre",  "Total",       "" } )

return ( aCocPreCli )



function aIncPreCli()

   local aColPreCli  := {}

   aAdd( aColPreCli, { "cSerPre", "C",    1,  0, "Serie de presupuesto" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "nNumPre", "N",    9,  0, "Numero de presupuesto" ,           "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "cSufPre", "C",    2,  0, "Sufijo de presupuesto" ,           "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,          "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,    "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "lListo",  "L",    1,  0, "Lógico de listo" ,                 "",                   "", "( cDbfCol )" } )
   aAdd( aColPreCli, { "lAviso",  "L",    1,  0, "Lógico de aviso" ,                 "",                   "", "( cDbfCol )" } )

return ( aColPreCli )



function aPreCliEst()

   local aPreCliEst  := {}

   aAdd( aPreCliEst, { "cSerPre", "C",    1,  0, "Serie de presupuesto" ,            "",                   "", "( cDbfCol )", nil } )
   aAdd( aPreCliEst, { "nNumPre", "N",    9,  0, "Numero de presupuesto" ,           "'999999999'",        "", "( cDbfCol )", nil } )
   aAdd( aPreCliEst, { "cSufPre", "C",    2,  0, "Sufijo de presupuesto" ,           "",                   "", "( cDbfCol )", nil } )
   aAdd( aPreCliEst, { "cSitua",  "C",  140,  0, "Situación" ,                       "",                   "", "( cDbfCol )", nil } )
   aAdd( aPreCliEst, { "dFecSit", "D",    8,  0, "Fecha de la situación" ,           "",                   "", "( cDbfCol )", nil } )
   aAdd( aPreCliEst, { "tFecSit", "C",    6,  0, "Hora de la situación" ,            "",                   "", "( cDbfCol )", nil } )
   aAdd( aPreCliEst, { "idPs",    "N",   11,  0, "Id prestashop" ,                   "",                   "", "( cDbfCol )", nil } )

return ( aPreCliEst )




function aPreCliDoc()

   local aPreCliDoc  := {}

   aAdd( aPreCliDoc, { "cSerPre", "C",    1,  0, "Serie de presupuesto" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "nNumPre", "N",    9,  0, "Numero de presupuesto" ,           "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "cSufPre", "C",    2,  0, "Sufijo de presupuesto" ,           "",                   "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aPreCliDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

return ( aPreCliDoc )



STATIC FUNCTION RecPreCli( aTmpPre )

   local nDtoAge
   local nImpAtp  := 0
   local nImpOfe  := 0
   local nRecno
   local cCodFam
   local hAtipica




   if !ApoloMsgNoYes(   "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿Desea proceder?" )
      return nil
   end

   nRecno         := ( dbfTmpLin )->( RecNo() )

   ( dbfTmpLin )->( dbGotop() )
   ( D():Articulos( nView ) )->( ordSetFocus( "Codigo" ) )

   while !( dbfTmpLin )->( eof() )





      if ( D():Articulos( nView ) )->( dbSeek( ( dbfTmpLin )->cRef ) )

         if aTmpPre[ 51 ] <= 2
            ( dbfTmpLin )->nIva     := nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva )
            ( dbfTmpLin )->nReq     := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )
         end





         if !Empty( ( D():Articulos( nView ) )->cCodImp )
            ( dbfTmpLin )->cCodImp  := ( D():Articulos( nView ) )->cCodImp
            ( dbfTmpLin )->nValImp  := oNewImp:nValImp( ( D():Articulos( nView ) )->cCodImp, aTmpPre[ 52 ], ( dbfTmpLin )->nIva )
         end





         ( dbfTmpLin )->nPreDiv  := nRetPreArt( ( dbfTmpLin )->nTarLin, aTmpPre[ 46 ], aTmpPre[ 52 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )





         ( dbfTmpLin )->nCtlStk  := ( D():Articulos( nView ) )->nCtlStock
         ( dbfTmpLin )->nPvpRec  := ( D():Articulos( nView ) )->PvpRec
         ( dbfTmpLin )->nCosDiv  := nCosto( nil, D():Articulos( nView ), dbfKit, , , , aTmpPre[ 6 ] )





         ( dbfTmpLin )->nPntVer  := ( D():Articulos( nView ) )->nPntVer1





         do case





         case !Empty( aTmpPre[ 16 ] )

            cCodFam  := ( dbfTmpLin )->cCodFam

            nImpOfe  := RetPrcTar( ( dbfTmpLin )->cRef, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL, ( dbfTmpLin )->nTarLin )
            if nImpOfe <> 0
               ( dbfTmpLin )->nPreDiv  := nImpOfe
            end

            nImpOfe  := RetPctTar( ( dbfTmpLin )->cRef, cCodFam, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL )
            if nImpOfe <> 0
               ( dbfTmpLin )->nDto     := nImpOfe
            end

            nImpOfe  := RetComTar( ( dbfTmpLin )->cRef, cCodFam, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpPre[ 14 ], dbfTarPreL, dbfTarPreS )
            if nImpOfe <> 0
               ( dbfTmpLin )->nComAge  := nImpOfe
            end





            nImpOfe  := RetDtoPrm( ( dbfTmpLin )->cRef, cCodFam, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpPre[ 5 ], dbfTarPreL )
            if nImpOfe <> 0
               ( dbfTmpLin )->nDtoPrm  := nImpOfe
            end





            nDtoAge  := RetDtoAge( ( dbfTmpLin )->cRef, cCodFam, aTmpPre[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpPre[ 5 ], aTmpPre[ 14 ], dbfTarPreL, dbfTarPreS )
            if nDtoAge <> 0
               ( dbfTmpLin )->nComAge  := nDtoAge
            end

         end





         hAtipica := hAtipica( hValue( dbfTmpLin, aTmpPre ) )

         if !Empty( hAtipica )

            if hhaskey( hAtipica, "nTarifaFamilia" ) .AND. hAtipica[ "nTarifaFamilia" ] > 0
               ( dbfTmpLin )->nPreDiv  := nRetPreArt( hAtipica[ "nTarifaFamilia" ], aTmpPre[ 46 ], aTmpPre[ 52 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
            end

            if hhaskey( hAtipica, "nImporte" )
               if hAtipica[ "nImporte" ] <> 0
                  ( dbfTmpLin )->nPreDiv := hAtipica[ "nImporte" ]
               end
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" )
               if hAtipica[ "nDescuentoPorcentual" ] <> 0
                  ( dbfTmpLin )->nDto     := hAtipica[ "nDescuentoPorcentual" ]
               end
            end

            if hhaskey( hAtipica, "nDescuentoPromocional" )
               if hAtipica[ "nDescuentoPromocional" ] <> 0
                  ( dbfTmpLin )->nDtoPrm  := hAtipica[ "nDescuentoPromocional" ]
               end
            end

            if hhaskey( hAtipica, "nDescuentoLineal" )
               if hAtipica[ "nDescuentoLineal" ] <> 0
                  ( dbfTmpLin )->nDtoDiv  := hAtipica[ "nDescuentoLineal" ]
               end
            end

            if hhaskey( hAtipica, "nComisionAgente" )
               if hAtipica[ "nComisionAgente" ] <> 0
                  ( dbfTmpLin )->nComAge  := hAtipica[ "nComisionAgente" ]
               end
            end

         end





         nImpOfe     := nImpOferta( ( dbfTmpLin )->cRef, aTmpPre[ 6 ], aTmpPre[ 63 ], ( dbfTmpLin )->nUniCaja, aTmpPre[ 5 ], dbfOferta, ( dbfTmpLin )->nTarLin, nil, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nPreDiv     := nCnv2Div( nImpOfe, cDivEmp(), aTmpPre[ 46 ], dbfDiv )
         end





         nImpOfe     := nDtoOferta( ( dbfTmpLin )->cRef, aTmpPre[ 6 ], aTmpPre[ 63 ], ( dbfTmpLin )->nUniCaja, aTmpPre[ 5 ], dbfOferta, ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2 )
         if nImpOfe  <> 0
            ( dbfTmpLin )->nDtoPrm  := nImpOfe
         end

      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRecno ) )

return nil



Function SynPreCli( cPath )

   local oError
   local oBlock
   local nOrdAnt
   local aTotPre
   local dbfPreCliT
   local dbfPreCliL
   local dbfPreCliI
   local dbfClient
   local dbfArticulo
   local dbfFamilia
   local dbfFPago
   local dbfIva
   local dbfDiv

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIT.DBF" ), ( cCheckArea( "PRECLIT", @dbfPreCliT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIL.DBF" ), ( cCheckArea( "PRECLIL", @dbfPreCliL ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLII.DBF" ), ( cCheckArea( "PRECLII", @dbfPreCliI ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   ( dbfPreCliT )->( ordSetFocus( 0 ) )
   ( dbfPreCliT )->( dbGoTop() )

      while !( dbfPreCliT )->( eof() )

         if Empty( ( dbfPreCliT )->cSufPre )
            ( dbfPreCliT )->cSufPre := "00"
         end

         if !Empty( ( dbfPreCliT )->cNumTik ) .AND. Len( AllTrim( ( dbfPreCliT )->cNumTik ) ) <> 13
            ( dbfPreCliT )->cNumTik := AllTrim( ( dbfPreCliT )->cNumTik ) + "00"
         end

         if Empty( ( dbfPreCliT )->cCodCaj )
            ( dbfPreCliT )->cCodCaj := "000"
         end

         if Empty( ( dbfPreCliT )->cCodGrp )
            ( dbfPreCliT )->cCodGrp := RetGrpCli( ( dbfPreCliT )->cCodCli, dbfClient )
         end





         if ( dbfPreCliT )->nTotPre == 0 .AND. dbLock( dbfPreCliT )

            aTotPre                 := aTotPreCli( ( dbfPreCliT )->cSerPre + Str( ( dbfPreCliT )->nNumPre ) + ( dbfPreCliT )->cSufPre, dbfPreCliT, dbfPreCliL, dbfIva, dbfDiv, dbfFPago, ( dbfPreCliT )->cDivPre )

            ( dbfPreCliT )->nTotNet := aTotPre[1]
            ( dbfPreCliT )->nTotIva := aTotPre[2]
            ( dbfPreCliT )->nTotReq := aTotPre[3]
            ( dbfPreCliT )->nTotPre := aTotPre[4]

            ( dbfPreCliT )->( dbUnLock() )

         end

         ( dbfPreCliT )->( dbSkip() )

      end

   ( dbfPreCliT )->( ordSetFocus( 1 ) )



   ( dbfPreCliL )->( ordSetFocus( 0 ) )
   ( dbfPreCliL )->( dbGoTop() )

   while !( dbfPreCliL )->( eof() )

      if Empty( ( dbfPreCliL )->cSufPre )
         ( dbfPreCliL )->cSufPre := "00"
      end

      if Empty( ( dbfPreCliL )->cLote ) .AND. !Empty( ( dbfPreCliL )->nLote )
         ( dbfPreCliL )->cLote   := AllTrim( Str( ( dbfPreCliL )->nLote ) )
      end

      if ( dbfPreCliL )->lIvaLin       <> RetFld( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre, dbfPreCliT, "lIvaInc" )
         ( dbfPreCliL )->lIvaLin       := RetFld( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre, dbfPreCliT, "lIvaInc" )
      end

      if !Empty( ( dbfPreCliL )->cRef ) .AND. Empty( ( dbfPreCliL )->cCodFam )
         ( dbfPreCliL )->cCodFam       := RetFamArt( ( dbfPreCliL )->cRef, dbfArticulo )
      end

      if Empty( ( dbfPreCliL )->cAlmLin )
         ( dbfPreCliL )->cAlmLin       := RetFld( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre, dbfPreCliT, "cCodAlm" )
      end

      if Empty( ( dbfPreCliL )->nReq )
         ( dbfPreCliL )->nReq          := nPReq( dbfIva, ( dbfPreCliL )->nIva )
      end

      if Empty( ( dbfPreCliL )->nPosPrint )
         ( dbfPreCliL )->nPosPrint     := ( dbfPreCliL )->nNumLin
      end

      if ( dbfPreCliL )->nRegIva <> RetFld( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre, dbfPreCliT, "nRegIva" )
         if dbLock( dbfPreCliL )
            ( dbfPreCliL )->nRegIva := RetFld( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre, dbfPreCliT, "nRegIva" )
            ( dbfPreCliL )->( dbUnlock() )
         end
      end

      ( dbfPreCliL )->( dbSkip() )

      SysRefresh()

   end

   ( dbfPreCliL )->( ordSetFocus( 1 ) )



   ( dbfPreCliI )->( ordSetFocus( 0 ) )
   ( dbfPreCliI )->( dbGoTop() )

      while !( dbfPreCliI )->( eof() )

         if Empty( ( dbfPreCliI )->cSufPre )
            ( dbfPreCliI )->cSufPre := "00"
         end

         ( dbfPreCliI )->( dbSkip() )

         SysRefresh()

      end

   ( dbfPreCliI )->( ordSetFocus( 1 ) )

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfPreCliT )->( dbCloseArea() )
   ( dbfPreCliL )->( dbCloseArea() )
   ( dbfPreCliI )->( dbCloseArea() )
   ( dbfArticulo)->( dbCloseArea() )
   ( dbfFamilia )->( dbCloseArea() )
   ( dbfIva     )->( dbCloseArea() )
   ( dbfDiv     )->( dbCloseArea() )
   ( dbfFPago   )->( dbCloseArea() )
   ( dbfClient  )->( dbCloseArea() )

return nil



Function EdtIva( oColumn, uVal, nIvaAnt, dbfTmpLin, dbfIva, oBrw )

   local nRec        := ( dbfTmpLin )->( Recno() )

   if Valtype( uVal ) <> "N"
      uVal           := Val( uVal )
   end

   if uVal <> nIvaAnt

      if lTiva( dbfIva, uVal )





         if !lShwKit()
            ( dbfTmpLin )->( dbClearFilter() )
         end

         ( dbfTmpLin )->( dbGoTop() )

         while !( dbfTmpLin )->( eof() )

            if ( dbfTmpLin )->nIva == nIvaAnt
               ( dbfTmpLin )->nIva := uVal
               ( dbfTmpLin )->nReq := nPorcentajeRE( dbfIva, uVal )
            end

            ( dbfTmpLin )->( dbSkip() )

         end





         if !lShwKit()
            ( dbfTmpLin )->( dbSetFilter( {|| ! Field->lKitChl }, "!lKitChl" ) )
         end

         ( dbfTmpLin )->( dbGoTo( nRec ) )

      end

      oBrw:Refresh()

   end

return .T.









_HB_CLASS TPresupuestosClientesSenderReciver ; function TPresupuestosClientesSenderReciver ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TPresupuestosClientesSenderReciver", iif( .T., { @TSenderReciverItem() }, { @HBObject() } ), @TPresupuestosClientesSenderReciver() ) ) ;

   _HB_MEMBER { cFileName } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileName"}, .F. )

   _HB_MEMBER CreateData(); oClass:AddMethod( "CreateData", @TPresupuestosClientesSenderReciver_CreateData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RestoreData(); oClass:AddMethod( "RestoreData", @TPresupuestosClientesSenderReciver_RestoreData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SendData(); oClass:AddMethod( "SendData", @TPresupuestosClientesSenderReciver_SendData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ReciveData(); oClass:AddMethod( "ReciveData", @TPresupuestosClientesSenderReciver_ReciveData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Process(); oClass:AddMethod( "Process", @TPresupuestosClientesSenderReciver_Process(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TPresupuestosClientesSenderReciver ;



static FUNCTION TPresupuestosClientesSenderReciver_CreateData( ) ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local oBlock
   local oError
   local lSnd        := .F.
   local cPreCliT
   local dbfPreCliL
   local dbfPreCliI
   local tmpPreCliT
   local tmpPreCliL
   local tmpPreCliI

   if ::oSender:lServer
      ::cFileName         := "PreCli" + win_uuidcreatestring() + ".All"
   else
      ::cFileName         := "PreCli" + win_uuidcreatestring() + "." + RetSufEmp()
   end

   ::oSender:SetText( "Enviando presupuestos de clientes" )

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @cPreCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliL.DBF" ), ( cCheckArea( "PreCliL", @dbfPreCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliI.DBF" ), ( cCheckArea( "PreCliI", @dbfPreCliI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end



   mkPreCli( cPatSnd() )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @tmpPreCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "PreCliT.Cdx" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "PreCliL.DBF" ), ( cCheckArea( "PreCliL", @tmpPreCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "PreCliL.CDX" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "PreCliI.DBF" ), ( cCheckArea( "PreCliI", @tmpPreCliI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "PreCliI.CDX" ) )

   if !empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( cPreCliT )->( LastRec() )
   end

   while !( cPreCliT )->( eof() )

      if ( cPreCliT )->lSndDoc

         lSnd  := .T.

         dbPass( cPreCliT, tmpPreCliT, .T. )
         ::oSender:SetText( ( cPreCliT )->cSerPre + "/" + AllTrim( Str( ( cPreCliT )->nNumPre ) ) + "/" + AllTrim( ( cPreCliT )->cSufPre ) + "; " + Dtoc( ( cPreCliT )->dFecPre ) + "; " + AllTrim( ( cPreCliT )->cCodCli ) + "; " + ( cPreCliT )->cNomCli )

         if ( dbfPreCliL )->( dbSeek( ( cPreCliT )->CSERPre + Str( ( cPreCliT )->NNUMPre ) + ( cPreCliT )->CSUFPre ) )
            while ( ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->NNUMPre ) + ( dbfPreCliL )->CSUFPre ) == ( ( cPreCliT )->CSERPre + Str( ( cPreCliT )->NNUMPre ) + ( cPreCliT )->CSUFPre ) .AND. !( dbfPreCliL )->( eof() )
               dbPass( dbfPreCliL, tmpPreCliL, .T. )
               ( dbfPreCliL )->( dbSkip() )
            end
         end

         if ( dbfPreCliI )->( dbSeek( ( cPreCliT )->cSerPre + Str( ( cPreCliT )->nNumPre ) + ( cPreCliT )->cSufPre ) )
            while ( ( dbfPreCliI )->cSerPre + Str( ( dbfPreCliI )->nNumPre ) + ( dbfPreCliI )->cSufPre ) == ( ( cPreCliT )->cSerPre + Str( ( cPreCliT )->nNumPre ) + ( cPreCliT )->cSufPre ) .AND. !( dbfPreCliI )->( eof() )
               dbPass( dbfPreCliI, tmpPreCliI, .T. )
               ( dbfPreCliI )->( dbSkip() )
            end
         end

      end

      ( cPreCliT )->( dbSkip() )

      if !Empty( ::oSender:oMtr )
         ::oSender:oMtr:Set( ( cPreCliT )->( OrdKeyNo() ) )
      end

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( cPreCliT )->( dbCloseArea() )
   ( dbfPreCliL )->( dbCloseArea() )
   ( dbfPreCliI )->( dbCloseArea() )
   ( tmpPreCliT )->( dbCloseArea() )
   ( tmpPreCliL )->( dbCloseArea() )
   ( tmpPreCliI )->( dbCloseArea() )

   if lSnd





      ::oSender:SetText( "Comprimiendo presupuestos a clientes" )

      if ::oSender:lZipData( ::cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay presupuestos a clientes para enviar" )

   end

Return ( Self )



static FUNCTION TPresupuestosClientesSenderReciver_RestoreData( ) ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local oBlock
   local oError
   local cPreCliT

   if ::lSuccesfullSend





      oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @cPreCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      ( cPreCliT )->( OrdSetFocus( "lSndDoc" ) )

      while ( cPreCliT )->( dbSeek( .T. ) ) .AND. !( cPreCliT )->( eof() )
         if ( cPreCliT )->( dbRLock() )
            ( cPreCliT )->lSndDoc := .F.
            ( cPreCliT )->( dbRUnlock() )
         end
      end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

      ( cPreCliT )->( dbCloseArea() )

   end

Return ( Self )



static FUNCTION TPresupuestosClientesSenderReciver_SendData( ) ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   if File( cPatOut() + ::cFileName )





      if ::oSender:SendFiles( cPatOut() + ::cFileName, ::cFileName )
         ::lSuccesfullSend := .T.
         ::oSender:SetText( "Fichero enviado " + ::cFileName )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



static FUNCTION TPresupuestosClientesSenderReciver_ReciveData( ) ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local n
   local aExt

   aExt     := ::oSender:aExtensions()





   ::oSender:SetText( "Recibiendo presupuestos de clientes" )

   for n := 1 to len( aExt )
      ::oSender:GetFiles( "PreCli*." + aExt[ n ], cPatIn() )
   next

   ::oSender:SetText( "Presupuestos de clientes recibidos" )

Return Self



static FUNCTION TPresupuestosClientesSenderReciver_Process( ) ; local Self AS CLASS TPresupuestosClientesSenderReciver := QSelf() AS CLASS TPresupuestosClientesSenderReciver

   local m
   local oBlock
   local oError
   local cPreCliT
   local dbfPreCliL
   local dbfPreCliI
   local dbfPreClid
   local tmpPreCliT
   local tmpPreCliL
   local tmpPreCliI
   local tmpPreCliD
   local aFiles      := Directory( cPatIn() + "PreCli*.*" )

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

         if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )







            if lExistTable( cPatSnd() + "PreCliT.DBF", cLocalDriver() )   .AND. lExistTable( cPatSnd() + "PreCliL.DBF", cLocalDriver() )   .AND. lExistTable( cPatSnd() + "PreCliI.DBF", cLocalDriver() )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @tmpPreCliT ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "PreCliT.Cdx" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "PreCliL.DBF" ), ( cCheckArea( "PreCliL", @tmpPreCliL ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "PreCliL.CDX" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "PreCliI.DBF" ), ( cCheckArea( "PreCliI", @tmpPreCliI ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "PreCliI.CDX" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "PreCliD.DBF" ), ( cCheckArea( "PreCliD", @tmpPreCliD ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "PreCliD.Cdx" ) )

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliT.DBF" ), ( cCheckArea( "PreCliT", @cPreCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliL.DBF" ), ( cCheckArea( "PreCliL", @dbfPreCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliI.DBF" ), ( cCheckArea( "PreCliI", @dbfPreCliI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCliD.DBF" ), ( cCheckArea( "PreCliD", @dbfPreCliD ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCliD.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

               while !( tmpPreCliT )->( eof() )


                  if lValidaOperacion( ( tmpPreCliT )->dFecPre, .F. ) .AND.  !( cPreCliT )->( dbSeek( ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre ) )

                     dbPass( tmpPreCliT, cPreCliT, .T. )

                     if dbLock( cPreCliT )
                        ( cPreCliT )->lSndDoc := .F.
                        ( cPreCliT )->( dbUnLock() )
                     end

                     ::oSender:SetText( "Añadido : " + ( tmpPreCliL )->cSerPre + "/" + AllTrim( Str( ( tmpPreCliL )->nNumPre ) ) + "/" + AllTrim( ( tmpPreCliL )->cSufPre ) + "; " + Dtoc( ( tmpPreCliT )->dFecPre ) + "; " + AllTrim( ( tmpPreCliT )->cCodCli ) + "; " + ( tmpPreCliT )->cNomCli )

                     if ( tmpPreCliL )->( dbSeek( ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre ) )
                        while ( tmpPreCliL )->cSerPre + Str( ( tmpPreCliL )->nNumPre ) + ( tmpPreCliL )->cSufPre == ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre .AND. !( tmpPreCliL )->( eof() )
                           dbPass( tmpPreCliL, dbfPreCliL, .T. )
                           ( tmpPreCliL )->( dbSkip() )
                        end
                     end

                     if ( tmpPreCliI )->( dbSeek( ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre ) )
                        while ( tmpPreCliI )->cSerPre + Str( ( tmpPreCliI )->nNumPre ) + ( tmpPreCliI )->cSufPre == ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre .AND. !( tmpPreCliI )->( eof() )
                           dbPass( tmpPreCliI, dbfPreCliI, .T. )
                           ( tmpPreCliI )->( dbSkip() )
                        end
                     end

                     if ( tmpPreCliD )->( dbSeek( ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre ) )
                        while ( tmpPreCliD )->cSerPre + Str( ( tmpPreCliD )->nNumPre ) + ( tmpPreCliD )->cSufPre == ( tmpPreCliT )->cSerPre + Str( ( tmpPreCliT )->nNumPre ) + ( tmpPreCliT )->cSufPre .AND. !( tmpPreCliD )->( eof() )
                           dbPass( tmpPreCliD, dbfPreCliD, .T. )
                           ( tmpPreCliD )->( dbSkip() )
                        end
                     end

                  else

                     ::oSender:SetText( "Desestimado : " + ( tmpPreCliL )->cSerPre + "/" + AllTrim( Str( ( tmpPreCliL )->nNumPre ) ) + "/" + AllTrim( ( tmpPreCliL )->cSufPre ) + "; " + Dtoc( ( tmpPreCliT )->dFecPre ) + "; " + AllTrim( ( tmpPreCliT )->cCodCli ) + "; " + ( tmpPreCliT )->cNomCli )

                  end

                  ( tmpPreCliT )->( dbSkip() )

               end

               ( cPreCliT )->( dbCloseArea() )
               ( dbfPreCliL )->( dbCloseArea() )
               ( dbfPreCliI )->( dbCloseArea() )
               ( tmpPreCliT )->( dbCloseArea() )
               ( tmpPreCliL )->( dbCloseArea() )
               ( tmpPreCliI )->( dbCloseArea() )

               ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

            else

               ::oSender:SetText( "Faltan ficheros" )

               if !lExistTable( cPatSnd() + "PreCliT.DBF", cLocalDriver() )
                  ::oSender:SetText( "Falta " + cPatSnd() + "PreCliT.DBF" )
               end

               if !lExistTable( cPatSnd() + "PreCliL.DBF", cLocalDriver() )
                  ::oSender:SetText( "Falta " + cPatSnd() + "PreCliL.DBF" )
               end

               if !lExistTable( cPatSnd() + "PreCliI.DBF", cLocalDriver() )
                  ::oSender:SetText( "Falta " + cPatSnd() + "PreCliL.DBF" )
               end

               if !lExistTable( cPatSnd() + "PreCliD.DBF", cLocalDriver() )
                  ::oSender:SetText( "Falta " + cPatSnd() + "PreCliD.DBF" )
               end

            end

            fErase( cPatSnd() + "PreCliT.DBF" )
            fErase( cPatSnd() + "PreCliL.DBF" )
            fErase( cPatSnd() + "PreCliI.DBF" )
            fErase( cPatSnd() + "PreCliD.DBF" )

         else

            ::oSender:SetText( "Error al descomprimir los ficheros" )

         end

      RECOVER USING oError

         ( cPreCliT )->( dbCloseArea() )
         ( dbfPreCliL )->( dbCloseArea() )
         ( dbfPreCliI )->( dbCloseArea() )
         ( dbfPreCliD )->( dbCloseArea() )
         ( tmpPreCliT )->( dbCloseArea() )
         ( tmpPreCliL )->( dbCloseArea() )
         ( tmpPreCliI )->( dbCloseArea() )
         ( tmpPreCliD )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self



Function AppPreCli( cCodCli, cCodArt, lOpenBrowse )

   local nLevel         := Auth():Level( "presupuestos_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli( nil, nil, cCodCli, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         WinAppRec( nil, bEdtRec, D():PresupuestosClientes( nView ), cCodCli, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



FUNCTION EdtPreCli( cNumPre, lOpenBrowse )

   local nLevel         := Auth():Level( "presupuestos_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            WinEdtRec( nil, bEdtRec, D():PresupuestosClientes( nView ) )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION ZooPreCli( cNumPre, lOpenBrowse, lPda )

   local nLevel         := Auth():Level( "presupuestos_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;
   If( lPda == nil, lPda := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            WinZooRec( nil, bEdtRec, D():PresupuestosClientes( nView ) )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION DelPreCli( cNumPre, lOpenBrowse )

   local nLevel         := Auth():Level( "presupuestos_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 16 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            WinDelRec( nil, D():PresupuestosClientes( nView ), {|| QuiPreCli() } )
         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            WinDelRec( nil, D():PresupuestosClientes( nView ), {|| QuiPreCli() } )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION PrnPreCli( cNumPre, lOpenBrowse )

   local nLevel         := Auth():Level( "presupuestos_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            ImprimirSeriesPresupuestosClientes( 1, .T. )

         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            ImprimirSeriesPresupuestosClientes( 1, .T. )

         else
            MsgStop( "No se encuentra presupuesto" )
         end
         CloseFiles()
      end

   end

Return .T.



FUNCTION VisPreCli( cNumPre, lOpenBrowse )

   local nLevel         := Auth():Level( "presupuestos_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if PreCli()
         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            ImprimirSeriesPresupuestosClientes( 2, .T. )

         else
            MsgStop( "No se encuentra presupuesto" )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumPre, "nNumPre", D():PresupuestosClientes( nView ) )
            ImprimirSeriesPresupuestosClientes( 2, .T. )

         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION QuiPreCli()

   local nOrdDet
   local nOrdInc
   local nOrdDoc
   local nOrdEst

   if ( D():PresupuestosClientes( nView ) )->lCloPre .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar presupuestos cerrados los administradores." )
      Return .F.
   end

   nOrdDet        := ( D():PresupuestosClientesLineas( nView ) )->( OrdSetFocus( "nNumPre" ) )
   nOrdInc        := ( dbfPreCliI )->( OrdSetFocus( "nNumPre" ) )
   nOrdDoc        := ( dbfPreCliD )->( OrdSetFocus( "nNumPre" ) )
   nOrdEst        := ( D():PresupuestosClientesSituaciones( nView ) )->( OrdSetFocus( "nNumPre" ) )






   while ( D():PresupuestosClientesLineas( nView ) )->( dbSeek( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView )  )->cSufPre ) ) .AND. !( D():PresupuestosClientesLineas( nView ) )->( eof() )
      if dbLock( D():PresupuestosClientesLineas( nView ) )
         ( D():PresupuestosClientesLineas( nView ) )->( dbDelete() )
         ( D():PresupuestosClientesLineas( nView ) )->( dbUnLock() )
      end
   end





   while ( dbfPreCliI )->( dbSeek( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView )  )->cSufPre ) ) .AND. !( dbfPreCliI )->( eof() )
      if dbLock( dbfPreCliI )
         ( dbfPreCliI )->( dbDelete() )
         ( dbfPreCliI )->( dbUnLock() )
      end
   end





   while ( dbfPreCliD )->( dbSeek( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView )  )->cSufPre ) ) .AND. !( dbfPreCliD )->( eof() )
      if dbLock( dbfPreCliD )
         ( dbfPreCliD )->( dbDelete() )
         ( dbfPreCliD )->( dbUnLock() )
      end
   end





   while ( D():PresupuestosClientesSituaciones( nView ) )->( dbSeek( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView )  )->cSufPre ) ) .AND. !( D():PresupuestosClientesSituaciones( nView ) )->( eof() )
      if dbLock( D():PresupuestosClientesSituaciones( nView ) )
         ( D():PresupuestosClientesSituaciones( nView ) )->( dbDelete() )
         ( D():PresupuestosClientesSituaciones( nView ) )->( dbUnLock() )
      end
   end



   ( D():PresupuestosClientesLineas( nView ) )->( OrdSetFocus( nOrdDet ) )
   ( dbfPreCliI )->( OrdSetFocus( nOrdInc ) )
   ( dbfPreCliD )->( OrdSetFocus( nOrdDoc ) )
   ( D():PresupuestosClientesSituaciones( nView ) )->( OrdSetFocus( nOrdEst ) )


Return .T.



Function EndDesgPnt( cCodArt, nTarifa, oPreDiv, oImporte, dbfArticulo, nDouDiv )

   local nCosto   := oImporte:VarGet()
   local nRec     := ( D():Articulos( nView ) )->( RecNo() )
   local nNewPre

   if ( dbfArticulo )->( dbSeek( cCodArt ) )

      do case
         case nTarifa == 1
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr1 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef1, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 2
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr2 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef2, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 3
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr3 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef3, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 4
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr4 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef4, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 5
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr5 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef5, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
         case nTarifa == 6
            nNewPre := CalPre( if( ( dbfArticulo )->nBnfSbr6 <= 1, .T., .F. ), nCosto, .T., ( dbfArticulo )->Benef6, ( dbfArticulo )->TipoIva, nil, nil, nDouDiv, ( dbfArticulo )->cCodImp, nil )
      end

   end

   oPreDiv:cText( nNewPre )

   oPreDiv:Refresh()

   ( dbfArticulo )->( dbGoTo( nRec ) )

Return ( .T. )



Function ExpAlmacen( cCodAlm, dbfTmpLin, oBrw )

   local nRec  := ( dbfTmpLin )->( Recno() )

   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( eof() )

      if ( dbfTmpLin )->cAlmLin <> cCodAlm
         ( dbfTmpLin )->cAlmLin := cCodAlm
      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRec ) )

   oBrw:Refresh()

Return nil



Function changeAgentPercentageInAllLines( nComAge, dbfTmpLin, oBrw )

   local nRec  := ( dbfTmpLin )->( Recno() )

   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( eof() )

      if ( dbfTmpLin )->nComAge <> nComAge
         ( dbfTmpLin )->nComAge := nComAge
      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRec ) )

   oBrw:Refresh()

Return nil



Function ChangeTarifaCabecera( nNumTar, dbfTmpLin, oBrw )

   local nRec

   if ( nNumTar >= 1 .AND. nNumTar <= 6 )

      if ( nNumTar <> nTarifaPrecio .AND. ( dbfTmpLin )->( LastRec() ) > 0 )

         CursorWait()

         nRec           := ( dbfTmpLin )->( Recno() )

         ( dbfTmpLin )->( dbGoTop() )
         while !( dbfTmpLin )->( eof() )

            if ( dbfTmpLin )->nTarLin <> nNumTar
               ( dbfTmpLin )->nTarLin := nNumTar
            end

            ( dbfTmpLin )->( dbSkip() )

         end

         ( dbfTmpLin )->( dbGoTo( nRec ) )

         oBrw:Refresh()

         nTarifaPrecio  := nNumTar

         CursorWE()

      end

   end

Return .T.



Function InitTarifaCabecera( nNumTar )

   nTarifaPrecio  := nNumTar

Return .T.



Function cFrasePublicitaria( cDbfCol )

   local cTxtFra  := ""

Return ( cTxtFra )



FUNCTION IsPreCli( cPath )

   If( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "PreCliT.Dbf" )
      dbCreate( cPath + "PreCliT.Dbf", aSqlStruct( aItmPreCli() ), cDriver() )
   end

   if !lExistTable( cPath + "PreCliL.Dbf" )
      dbCreate( cPath + "PreCliL.Dbf", aSqlStruct( aColPreCli() ), cDriver() )
   end

   if !lExistTable( cPath + "PreCliI.Dbf" )
      dbCreate( cPath + "PreCliI.Dbf", aSqlStruct( aIncPreCli() ), cDriver() )
   end

   if !lExistTable( cPath + "PreCliD.Dbf" )
      dbCreate( cPath + "PreCliD.Dbf", aSqlStruct( aPreCliDoc() ), cDriver() )
   end

   if !lExistTable( cPath + "PreCliE.Dbf" )
      dbCreate( cPath + "PreCliE.Dbf", aSqlStruct( aPreCliEst() ), cDriver() )
   end





   if !lExistIndex( cPath + "PreCliT.Cdx" ) .OR.  !lExistIndex( cPath + "PreCliL.Cdx" ) .OR.  !lExistIndex( cPath + "PreCliI.Cdx" ) .OR.  !lExistTable( cPath + "PreCliD.Cdx" ) .OR.  !lExistTable( cPath + "PreCliE.Cdx" )

      rxPreCli( cPath )

   end

Return ( nil )



Function DesignReportPreCli( oFr, dbfDoc )

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "   CallHbFunc('nTotPreCli');"                              + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "MasterData",  "MainPage", 6 )
         oFr:SetProperty(     "MasterData",  "Top", 200 )
         oFr:SetProperty(     "MasterData",  "Height", 0 )
         oFr:SetProperty(     "MasterData",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "MasterData",  "DataSet", "Presupuestos" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de presupuestos" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function mailReportPreCli( cCodigoDocumento )

Return ( printReportPreCli( 6, 1, ImpresoraDefectoUsuario(), cCodigoDocumento ) )



Static Function printReportPreCli( nDevice, nCopies, cPrinter, cCodigoDocumento )

   local oFr

   local cFilePdf              := cPatOut() + "PresupuestoCliente" + StrTran( ( D():PresupuestosClientes( nView ) )->cSerPre + Str( ( D():PresupuestosClientes( nView ) )->nNumPre ) + ( D():PresupuestosClientes( nView ) )->cSufPre, " ", "" ) + ".Pdf"
   local nOrd

   If( nDevice == nil, nDevice := 2, ) ;
   If( nCopies == nil, nCopies := 1, ) ;
   If( cCodigoDocumento == nil, cCodigoDocumento := cFormatoPresupuestosClientes(), ) ;

   if empty( cCodigoDocumento )
      msgStop( "El código del documento esta vacio" )
      Return ( nil )
   end

   if Empty( cPrinter )
      cPrinter                := ImpresoraDefectoUsuario()
   end

   SysRefresh()

   nOrd                 := ( D():PresupuestosClientesLineas( nView ) )->( ordSetFocus( "nPosPrint" ) )

   oFr                  := frReportManager():New()

   oFr:LoadLangRes( "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle( "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( D():Documentos( nView ) )->( Select() ), "mReport" ) } )





   DataReport( oFr )





   if lMemoDocumento( cCodigoDocumento, D():Documentos( nView ) )

      oFr:LoadFromBlob( ( D():Documentos( nView ) )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2

            oFr:ShowPreparedReport()

         case nDevice == 1

            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

      end

   end





   oFr:DestroyFr()

   ( D():PresupuestosClientesLineas( nView ) )->( ordSetFocus( nOrd ) )

Return ( cFilePdf )







FUNCTION nRentabilidad( nImporte, nDtoAtipico, nCosto )

   if nCosto == 0
      Return ( 100 )
   end

RETURN( ( ( ( nImporte - nDtoAtipico ) / nCosto ) - 1 ) * 100  )



FUNCTION nRentabilidadVentas( nImporte, nDtoAtipico, nCosto )

   if nImporte == 0
      Return ( 100 )
   end

RETURN( ( 1 - Div( nCosto, ( nImporte - nDtoAtipico ) ) ) * 100  )



Function lValLine( dbfLine )

   local lVal  := .T.

   if ( dbfLine )->lControl
      Return .F.
   end

   if ( dbfLine )->lKitArt .OR. ( dbfLine )->lKitChl
      lVal     := ( dbfLine )->lKitPrc
   end

Return ( lVal )



FUNCTION UpSerie( oGet )

   local nAsc
   local cChr
   local cSer  := oGet:VarGet()

   if Empty( cSer ) .OR. cSer < "A"
      cSer     := "A"
      nAsc     := Asc( cSer )
   else
      nAsc     := Asc( cSer ) + 1
   end

   cChr        := Chr( nAsc )

   if cChr <= "Z"
      oGet:cText( cChr )
   end

return nil



FUNCTION DwSerie( oGet )

   local nAsc
   local cChr
   local cSer  := oGet:VarGet()

   nAsc        := Asc( cSer ) - 1
   cChr        := Chr( nAsc )

   if cChr >= "A"
      oGet:cText( cChr )
   end

return nil



Function nLastNum( uTmpLin, cFieldName )

   local nRec
   local nNum           := 0

   If( cFieldName == nil, cFieldName := "nNumLin", ) ;

   do case
   case IsChar( uTmpLin )

      nRec              := ( uTmpLin )->( RecNo() )
      ( uTmpLin )->( dbGoTop() )

      while !( uTmpLin )->( eof() )
         nNum           := Max( nNum, ( uTmpLin )->( FieldGet( FieldPos( cFieldName ) ) ) )
         ( uTmpLin )->( dbSkip() )
      end

      ( uTmpLin )->( dbGoTo( nRec ) )

   case IsObject( uTmpLin )

      nRec              := uTmpLin:RecNo()
      uTmpLin:GoTop()

      while !( uTmpLin:eof() )
         nNum           := Max( nNum, uTmpLin:FieldGetByName( cFieldName ) )
         uTmpLin:Skip()
      end

      uTmpLin:GoTo( nRec )

   end

Return ( ++nNum )



Function nCalculoPuntos( nPuntos, nValorPunto, nDtoPnt, nIncPnt )

   local nTotal   := 0

   nTotal         := nPuntos * nValorPunto
   nTotal         -= ( nTotal * nDtoPnt ) / 100

   if nIncPnt <> 0
      nTotal      := nTotal + ( ( nIncPnt * nTotal ) / 100 )
   end

Return ( nTotal )



Function cRefPrvArt( cCodArt, cCodPrv, dbfArtPrv )

   local cReferencia := ""
   local nRec        := ( dbfArtPrv )->( RecNo() )
   local nOrdAnt     := ( dbfArtPrv )->( OrdSetFocus( "cCodPrv" ) )

   if ( dbfArtPrv )->( dbSeek( cCodPrv + cCodArt ) )
      cReferencia    := AllTrim( ( dbfArtPrv )->cRefPrv )
   end

   ( dbfArtPrv )->( OrdSetFocus( nOrdAnt ) )
   ( dbfArtPrv )->( dbGoTo( nRec ) )

Return cReferencia






Function nTotDtoLPreCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo

   If( dbfLin == nil, dbfLin := D():PresupuestosClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nDtoLPreCli( dbfLin, nDec, nVdv ) * nTotNPreCli( dbfLin )

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

   nCalculo          := Round( nCalculo, nDec )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



Function sTotPreCli( cPresupuesto, dbfMaster, dbfLine, dbfIva, dbfDiv, cDivRet, lExcCnt )

   local sTotal

   nTotPreCli( cPresupuesto, dbfMaster, dbfLine, dbfIva, dbfDiv, nil, nil, cDivRet, .F., lExcCnt )

   sTotal                                 := sTotal()
   sTotal:nTotalBruto                     := nTotBrt
   sTotal:nTotalNeto                      := nTotNet
   sTotal:nTotalIva                       := nTotIva
   sTotal:aTotalIva                       := aTotIva
   sTotal:nTotalRecargoEquivalencia       := nTotReq
   sTotal:nTotalDocumento                 := nTotPre
   sTotal:nTotalPuntoVerde                := nTotPnt
   sTotal:nTotalTransporte                := nTotTrn
   sTotal:nTotalAgente                    := nTotAge
   sTotal:nTotalCosto                     := nTotCos
   sTotal:nTotalImpuestoHidrocarburos     := nTotIvm
   sTotal:nTotalRentabilidad              := nTotRnt
   sTotal:nTotalDescuentoGeneral          := nTotDto
   sTotal:nTotalDescuentoProntoPago       := nTotDpp
   sTotal:nTotalDescuentoUno              := nTotUno
   sTotal:nTotalDescuentoDos              := nTotDos

Return ( sTotal )



Static Function cFormatoPresupuestosClientes( cSerie )

   local cFormato

   If( cSerie == nil, cSerie := ( D():PresupuestosClientes( nView ) )->cSerPre, ) ;

   cFormato          := cFormatoDocumento( cSerie, "nPreCli", D():Contadores( nView ) )

   if Empty( cFormato )
      cFormato       := cFirstDoc( "RC", D():Documentos( nView ) )
   end

Return ( cFormato )



Function DesignLabelPresupuestoClientes( oFr, cDoc )

   local oLabel
   local lOpenFiles  := empty( nView )

   if lOpenFiles .AND. !Openfiles()
      Return .F.
   endif

   oLabel            := TLabelGeneratorPresupuestoClientes():New( nView )



   oLabel:createTempLabelReport()
   oLabel:loadTempLabelReport()
   oLabel:dataLabel( oFr )



   if !Empty( ( cDoc )->mReport )
      oFr:LoadFromBlob( ( cDoc )->( Select() ), "mReport")
   else
      oFr:AddPage(         "MainPage" )
      oFr:AddBand(         "MasterData",  "MainPage",       6 )
      oFr:SetProperty(     "MasterData",  "Top",            200 )
      oFr:SetProperty(     "MasterData",  "Height",         100 )
      oFr:SetObjProperty(  "MasterData",  "DataSet",        "Lineas de presupuestos" )
   end

   oFr:DesignReport()
   oFr:DestroyFr()

   oLabel:DestroyTempReport()
   oLabel:End()

   if lOpenFiles
      closeFiles()
   end

Return .T.



Static Function lChangeRegIva( aTmp )

   lImpuestos     := ( aTmp[ 51 ] <= 1 )

   if !Empty( oImpuestos )
      oImpuestos:Refresh()
   end

return ( .T. )



Static Function importarArticulosScaner()

   local memoArticulos

   memoArticulos  := dialogArticulosScaner()

   if memoArticulos <> nil
      msgStop( memoArticulos, "procesar")
   end

Return nil



Static Function LoadTrans( aTmp, oGetCod, oGetKgs, oSayTrn )

   local uValor   := oGetCod:VarGet()

   if Empty( uValor )

      oSayTrn:cText( "" )
      oGetKgs:cText( 0 )

   else

      if oTrans:oDbf:SeekInOrd( uValor, "cCodTrn" )
         oGetCod:cText( uValor )
         oSayTrn:cText( oTrans:oDbf:cNomTrn )
         oGetKgs:cText( oTrans:oDbf:nKgsTrn )
      else
         msgStop( "Código de transportista no encontrado." )
         Return .F.
      end

   end

   RecalculaTotal( aTmp )

Return .T.
