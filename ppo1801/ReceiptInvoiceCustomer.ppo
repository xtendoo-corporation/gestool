#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 5 ".\Prg\tablet\presenter\documentos\ventas\ReceiptInvoiceCustomer.prg"
_HB_CLASS ReceiptInvoiceCustomer ; function ReceiptInvoiceCustomer ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "ReceiptInvoiceCustomer", iif( .T., { @DocumentsSales() }, { @HBObject() } ), @ReceiptInvoiceCustomer() ) ) ;

   _HB_MEMBER { cNumeroFactura } ; oClass:AddMultiData(, "", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNumeroFactura"}, .F. )
   _HB_MEMBER { nImporteAnterior } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nImporteAnterior"}, .F. )
   _HB_MEMBER { lShowFilterCobrado } ; oClass:AddMultiData(, .T., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lShowFilterCobrado"}, .F. )
   _HB_MEMBER { lCloseFiles } ; oClass:AddMultiData(, .T., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lCloseFiles"}, .F. )

   _HB_MEMBER { lAceptarImprimir } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lAceptarImprimir"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @ReceiptInvoiceCustomer_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Play(); oClass:AddMethod( "Play", @ReceiptInvoiceCustomer_Play(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getEditDocumento(); oClass:AddMethod( "getEditDocumento", @ReceiptInvoiceCustomer_getEditDocumento(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER onPreEnd(); oClass:AddMethod( "onPreEnd", @ReceiptInvoiceCustomer_onPreEnd(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER onPostGetDocumento(); oClass:AddMethod( "onPostGetDocumento", @ReceiptInvoiceCustomer_onPostGetDocumento(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER onViewSave(); oClass:AddMethod( "onViewSave", @ReceiptInvoiceCustomer_onViewSave(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER onPreSaveEdit(); oClass:AddMethod( "onPreSaveEdit", @ReceiptInvoiceCustomer_onPreSaveEdit(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER deleteLinesDocument(); oClass:AddInline( "deleteLinesDocument", {|Self | ( ( Self ) ), ( .T. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER assignLinesDocument(); oClass:AddInline( "assignLinesDocument", {|Self | ( ( Self ) ), ( .T. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setLinesDocument(); oClass:AddInline( "setLinesDocument", {|Self | ( ( Self ) ), ( .T. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER onPreEditDocumento(); oClass:AddMethod( "onPreEditDocumento", @ReceiptInvoiceCustomer_onPreEditDocumento(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER addReciboDiferencia(); oClass:AddMethod( "addReciboDiferencia", @ReceiptInvoiceCustomer_addReciboDiferencia(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER FilterTable(); oClass:AddMethod( "FilterTable", @ReceiptInvoiceCustomer_FilterTable(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER onPreRunNavigator(); oClass:AddMethod( "onPreRunNavigator", @ReceiptInvoiceCustomer_onPreRunNavigator(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER onPostSaveEdit(); oClass:AddMethod( "onPostSaveEdit", @ReceiptInvoiceCustomer_onPostSaveEdit(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER printReceipt(); oClass:AddInline( "printReceipt", {|Self | ( ( Self ) ), ( PrnRecCli( ( ::getDataTable() )->cSerie + Str( ( ::getDataTable() )->nNumFac ) + ( ::getDataTable() )->cSufFac + Str( ( ::getDataTable() )->nNumRec ) ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setTrueAceptarImprimir(); oClass:AddInline( "setTrueAceptarImprimir", {|Self | ( ( Self ) ), ( ::lAceptarImprimir  := .T. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER setFalseAceptarImprimir(); oClass:AddInline( "setFalseAceptarImprimir", {|Self | ( ( Self ) ), ( ::lAceptarImprimir  := .T. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS ReceiptInvoiceCustomer ;



static FUNCTION ReceiptInvoiceCustomer_New( oInvoice ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   ::super:oSender         := self

   if Empty( oInvoice )

      if !::openFiles()
         return ( self )
      end

   else

      ::lCloseFiles              := .F.
      ::nView                    := oInvoice:nView
      ::cNumeroFactura           := oInvoice:GetId()
      ::lShowFilterCobrado       := Empty( oInvoice:GetId() )

   end

   ::oViewSearchNavigator  := ReceiptDocumentSalesViewSearchNavigator():New( self )
   ::oViewSearchNavigator:setTitleDocumento( "Recibos de clientes" )

   ::oViewEdit             := ReceiptDocumentSalesViewEdit():New( self )
   ::oViewEdit:setTitleDocumento( "Recibo cliente" )

   ::setTypePrintDocuments( "RF" )

   ::setCounterDocuments( "NRECCLI" )



   ::setDataTable( "FacCliP" )

Return ( self )



static FUNCTION ReceiptInvoiceCustomer_Play( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   if ::onPreRunNavigator()
      ::runNavigator()
   end

   if ::lCloseFiles
      ::closeFiles()
   end

return ( self )



static FUNCTION ReceiptInvoiceCustomer_getEditDocumento( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   local id                := D():FacturasClientesCobrosId( ::nView )

   if Empty( id )
      Return .F.
   end

   ::hDictionaryMaster     := D():getFacturaClienteCobros( ::nView )

   if empty( ::hDictionaryMaster )
      Return .F.
   end

Return ( .T. )



static FUNCTION ReceiptInvoiceCustomer_onViewSave( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   ::oViewEdit:oDlg:end( 1 )

Return ( self )



static FUNCTION ReceiptInvoiceCustomer_onPreSaveEdit( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   local nNuevoImporte        := 0
   local nImporteReciboNuevo  := 0





   hSet( ::oSender:hDictionaryMaster, "LogicoCobrado", ( ::oViewEdit:cCbxEstado == "Cobrado" ) )
   hSet( ::oSender:hDictionaryMaster, "FechaCobro", if( ::oViewEdit:cCbxEstado == "Cobrado", Date(), cToD( "" ) ) )

   hSet( ::oSender:hDictionaryMaster, "FechaCreacion", Date() )
   hSet( ::oSender:hDictionaryMaster, "HoraCreacion", Time() )





   nNuevoImporte  := hGet( ::oSender:hDictionaryMaster, "TotalDocumento" )

   if nNuevoImporte <> ::nImporteAnterior

      nImporteReciboNuevo     := ( ::nImporteAnterior - nNuevoImporte ) * if( ::nImporteAnterior < 0, - 1 , 1 )

      ::addReciboDiferencia( nImporteReciboNuevo )

   end

Return ( .T. )



static FUNCTION ReceiptInvoiceCustomer_onPostSaveEdit( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   local nRec     := ( D():FacturasClientes( ::nView ) )->( Recno() )
   local nOrdAnt  := ( D():FacturasClientes( ::nView ) )->( OrdSetFocus( "NNUMFAC" ) )

   if ::lAceptarImprimir
      ::printReceipt()
      ::setFalseAceptarImprimir()
   end

   if ( D():FacturasClientes( ::nView ) )->( dbSeek( ( ::getDataTable() )->cSerie + Str( ( ::getDataTable() )->nNumFac ) + ( ::getDataTable() )->cSufFac ) )

      if dbLock( D():FacturasClientes( ::nView ) )
         ( D():FacturasClientes( ::nView ) )->lSndDoc    := .T.
         ( D():FacturasClientes( ::nView ) )->dFecCre    := date()
         ( D():FacturasClientes( ::nView ) )->cTimCre    := time()
         ( D():FacturasClientes( ::nView ) )->( dbUnLock() )
      end

      ChkLqdFacCli( nil, D():FacturasClientes( ::nView ), D():FacturasClientesLineas( ::nView ), D():FacturasClientesCobros( ::nView ), D():AnticiposClientes( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ), .F. )

   end

   ( D():FacturasClientes( ::nView ) )->( OrdSetFocus( nOrdAnt ) )
   ( D():FacturasClientes( ::nView ) )->( dbGoTo( nRec ) )

   ::oViewSearchNavigator:changeComboboxSearch()

   ::FilterTable( ::oViewSearchNavigator:cComboboxFilter )

Return ( .T. )



static FUNCTION ReceiptInvoiceCustomer_onPostGetDocumento( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   ::oldSerie           := ::getSerie()

   ::nImporteAnterior   := hGet( ::oSender:hDictionaryMaster, "TotalDocumento" )

Return ( .T. )



static FUNCTION ReceiptInvoiceCustomer_onPreEditDocumento( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   ::nOrdenAnterior     := ( ::getDataTable() )->( OrdSetFocus() )

Return ( .T. )



static FUNCTION ReceiptInvoiceCustomer_onPreEnd( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   local cNumeroFactura    := ( ::getDataTable() )->cSerie + Str( ( ::getDataTable() )->nNumFac ) + ( ::getDataTable() )->cSufFac





   if ( D():FacturasClientes( ::nView ) )->( dbSeek( cNumeroFactura ) )
      ChkLqdFacCli( nil, D():FacturasClientes( ::nView ), D():FacturasClientesLineas( ::nView ), D():FacturasClientesCobros( ::nView ), D():AnticiposClientes( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ), .F. )
   end

   ( ::getDataTable() )->( OrdSetFocus( ::nOrdenAnterior ) )

Return ( .T. )



static FUNCTION ReceiptInvoiceCustomer_addReciboDiferencia( nImporteRecibo ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   local nRec        := ( ::getDataTable() )->( Recno() )
   local aTabla
   local nCount
   local cNumRec     := ""

   aTabla            := dbScatter( ::getDataTable() )

   cNumRec           += aTabla[ ( ::getDataTable() )->( fieldpos( "cSerie" ) ) ]
   cNumRec           += Str( aTabla[ ( ::getDataTable() )->( fieldpos( "nNumFac" ) ) ] )
   cNumRec           += aTabla[ ( ::getDataTable() )->( fieldpos( "cSufFac" ) ) ]

   ( ::getDataTable() )->( dbClearFilter() )

   nCount            := nNewReciboCliente( cNumRec, aTabla[ ( ::getDataTable() )->( fieldpos( "cTipRec" ) ) ], ::getDataTable() )





   ( ::getDataTable() )->( dbAppend() )

   ( ::getDataTable() )->cTurRec    := cCurSesion()
   ( ::getDataTable() )->cTipRec    := aTabla[ ( ::getDataTable() )->( fieldpos( "cTipRec" ) ) ]
   ( ::getDataTable() )->cSerie     := aTabla[ ( ::getDataTable() )->( fieldpos( "cSerie" ) ) ]
   ( ::getDataTable() )->nNumFac    := aTabla[ ( ::getDataTable() )->( fieldpos( "nNumFac" ) ) ]
   ( ::getDataTable() )->cSufFac    := aTabla[ ( ::getDataTable() )->( fieldpos( "cSufFac" ) ) ]
   ( ::getDataTable() )->nNumRec    := nCount
   ( ::getDataTable() )->cCodCaj    := aTabla[ ( ::getDataTable() )->( fieldpos( "cCodCaj" ) ) ]
   ( ::getDataTable() )->cCodCli    := aTabla[ ( ::getDataTable() )->( fieldpos( "cCodCli" ) ) ]
   ( ::getDataTable() )->cNomCli    := aTabla[ ( ::getDataTable() )->( fieldpos( "cNomCli" ) ) ]
   ( ::getDataTable() )->cCodAge    := aTabla[ ( ::getDataTable() )->( fieldpos( "cCodAge" ) ) ]
   ( ::getDataTable() )->nImporte   := nImporteRecibo
   ( ::getDataTable() )->nImpCob    := nImporteRecibo
   ( ::getDataTable() )->cDescrip   := "Recibo nº" + AllTrim( str( nCount ) ) + " de factura " + if( !empty( aTabla[ ( ::getDataTable() )->( fieldpos( "cTipRec" ) ) ] ), "rectificativa ", "" ) + aTabla[ ( ::getDataTable() )->( fieldpos( "cSerie" ) ) ] + "/" + AllTrim( str( aTabla[ ( ::getDataTable() )->( fieldpos( "nNumFac" ) ) ] ) ) + "/" + aTabla[ ( ::getDataTable() )->( fieldpos( "cSufFac" ) ) ]
   ( ::getDataTable() )->dPreCob    := dFecFacCli( cNumRec, D():FacturasClientes( ::nView ) )
   ( ::getDataTable() )->cPgdoPor   := ""
   ( ::getDataTable() )->lCobrado   := .F.
   ( ::getDataTable() )->cDivPgo    := aTabla[ ( ::getDataTable() )->( fieldpos( "cDivPgo" ) ) ]
   ( ::getDataTable() )->nVdvPgo    := aTabla[ ( ::getDataTable() )->( fieldpos( "nVdvPgo" ) ) ]
   ( ::getDataTable() )->cCodPgo    := aTabla[ ( ::getDataTable() )->( fieldpos( "cCodPgo" ) ) ]
   ( ::getDataTable() )->lConPgo    := .F.
   ( ::getDataTable() )->dFecCre    := GetSysDate()
   ( ::getDataTable() )->cHorCre    := Substr( Time(), 1, 5 )

   ( ::getDataTable() )->( dbUnLock() )

   ( ::getDataTable() )->( dbGoTo( nRec ) )

Return ( .T. )



static FUNCTION ReceiptInvoiceCustomer_FilterTable( cTextFilter ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   do case
      case cTextFilter == "Todos delegación"

         ( ::getDataTable() )->( adsSetAOF( "Field->cSufFac == '" + Application():CodigoDelegacion() + "'" ) )

      case cTextFilter == "Pendientes delegación"

         ( ::getDataTable() )->( adsSetAOF( "!Field->lCobrado .and. Field->cSufFac == '" + Application():CodigoDelegacion() + "'" ) )

      case cTextFilter == "Cobrados delegación"

         ( ::getDataTable() )->( adsSetAOF( "Field->lCobrado .and. Field->cSufFac = '" + Application():CodigoDelegacion() + "'" ) )

      case cTextFilter == "Pendientes"

         ( ::getDataTable() )->( adsSetAOF( "!Field->lCobrado" ) )

      case cTextFilter == "Cobrados"

         ( ::getDataTable() )->( adsSetAOF( "Field->lCobrado" ) )

      case cTextFilter == "Todos"

         ( ::getDataTable() )->( adsClearAOF() )

   end

   ( ::getDataTable() )->( dbgotop() )

   ::oViewSearchNavigator:oBrowse:SelectCurrent()
   ::oViewSearchNavigator:oBrowse:Refresh()

return ( .T. )



static FUNCTION ReceiptInvoiceCustomer_onPreRunNavigator( ) ; local Self AS CLASS ReceiptInvoiceCustomer := QSelf() AS CLASS ReceiptInvoiceCustomer

   if empty( ::getWorkArea() )
      Return .T.
   end

   if !Empty( ::cNumeroFactura )

      if !( D():FacturasClientes( ::nView ) )->( dbSeek( ::cNumeroFactura ) )
         Return ( .F. )
      end

   end

   ( ::getWorkArea() )->( ordsetfocus( "dFecDes" ) )
   ( ::getWorkArea() )->( dbgotop() )

   if !Empty( ::cNumeroFactura )

      ( ::getWorkArea() )->( adsSetAOF( "Field->cSerie + Str( Field->nNumFac ) + Field->cSufFac == '" + ::cNumeroFactura + "'" ) )
      ( ::getWorkArea() )->( dbgotop() )

   else

      if ( accessCode():lFilterByAgent ) .AND. !empty( accessCode():cAgente )

         ( ::getWorkArea() )->( adsSetAOF( "Field->cCodAge == '" + accessCode():cAgente + "'" ) )
         ( ::getWorkArea() )->( dbgotop() )

         ( D():Clientes( ::nView ) )->( adsSetAOF( "Field->cCodAge == '" + accessCode():cAgente + "'" ) )
         ( D():Clientes( ::nView ) )->( dbgotop() )

      end

   end

Return ( .T. )
