#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 203 ".\.\Prg\RectificativaProveedores.prg"
memvar cDbf
memvar cDbfCol
memvar cDbfRec
memvar cDbfAlm
memvar cDbfPrv
memvar cDbfPgo
memvar cDbfIva
memvar cDbfDiv
memvar cDbfArt
memvar cDbfKit
memvar cDbfPro
memvar cDbfTblPro
memvar aTotIva
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aDatVcto
memvar aImpVcto
memvar nTotBrt
memvar nTotNet
memvar nTotSup
memvar nTotIva
memvar nTotReq
memvar nTotRet
memvar nTotFac
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotImp
memvar nTotUnd
memvar nTotIvm
memvar nPagFac
memvar nTipRet
memvar nTotPage
memvar cPinDivFac
memvar cPirDivFac
memvar cPicEurFac
memvar nDinDivFac
memvar nDirDivFac
memvar nVdvDivFac
memvar nPagina
memvar lEnd
memvar aImpVto
memvar aDatVto





static oWndBrw
static oBrwIva
static oInf

static dbfRctPrvT
static dbfRctPrvL
static dbfRctPrvS
static filRctPrvL
static tmpRctPrvT
static tmpRctPrvP
static tmpRctPrvL
static tmpRctPrvI
static dbfRctPrvP
static dbfRctPrvI
static dbfRctPrvD

static dbfIva
static dbfPrv
static dbfFPago
static dbfTmp
static dbfArticulo
static dbfFamilia
static dbfCajT
static dbfDiv

static oBandera

static oStock
static TComercio

static oNewImp
static cNewFile
static cPicEur
static cPicUnd
static cPinDiv
static cPouDiv
static cPorDiv
static cTmpInc
static cTmpDoc
static cTmpPgo
static cTmpSer

static dbfTmpInc
static dbfTmpDoc
static dbfTmpPgo
static dbfTmpSer

static cPirDiv
static nDinDiv
static nRinDiv

static oGetTotal
static oGetTotPg
static oGetRet
static oGetNet
static oGetIva
static oGetReq
static oGetPgd
static oGetPdt
static oGetIvm
static oUsr
static cUsr
static oFntTot

static nView

static oMnuPgo
static oMnuRec

static aNumAlb          := {}
static nGetNeto         := 0
static nGetIva          := 0
static nGetReq          := 0
static nGetPgd          := 0

static oDetCamposExtra
static oCentroCoste

static oMailing

static cOldCodCli       := ""
static cOldCodArt       := ""
static cOldPrpArt       := ""
static cOldUndMed       := ""
static lOpenFiles       := .F.
static lExternal        := .F.
static nLabels          := 1
static cFiltroUsuario   := ""
static bEdtRec          := { |aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, cNumFac | EdtRec( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, cNumFac ) }
static bEdtDet          := { |aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aFac    | EdtDet( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode ) }
static bEdtInc          := { |aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpLin | EdtInc( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtDoc          := { |aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpLin | EdtDoc( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpLin ) }
static bEdtPgo          := { |aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpFac | EdtPgo( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpFac ) }

static Counter
static oTipoCtrCoste
static cTipoCtrCoste
static aTipoCtrCoste    := { "Centro de coste", "Proveedor", "Agente", "Cliente" }



Static Function initPublics()

   public nTotBrt    := 0
   public nTotNet    := 0
   public nTotSup    := 0
   public nTotIva    := 0
   public nTotReq    := 0
   public nTotRet    := 0
   public nTotFac    := 0
   public nTotDto    := 0
   public nTotDpp    := 0
   public nTotUno    := 0
   public nTotDos    := 0
   public nTotImp    := 0
   public nTotUnd    := 0
   public nPagFac    := 0
   public nTipRet    := 0
   public nTotIvm    := 0
   public aTotIva    := { { 0,0,nil,0,0,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0,0,0 } }
   public aIvaUno    := aTotIva[ 1 ]
   public aIvaDos    := aTotIva[ 2 ]
   public aIvaTre    := aTotIva[ 3 ]

Return ( nil )





STATIC FUNCTION OpenFiles( lExt )

   local oBlock

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de facturas rectificativas a proveedores" )
      Return ( .F. )
   end

   If( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      DisableAcceso()

      lOpenFiles        := .T.

      nView             := D():CreateView()

      D():FacturasRectificativasProveedores( nView )

      D():Proveedores( nView )

      D():GruposProveedores( nView )

      D():FacturasRectificativasProveedoresLineas( nView )

      D():FacturasRectificativasProveedoresIncidencias( nView )

      D():FacturasRectificativasProveedoresDocumentos( nView )

      D():FacturasRectificativasProveedoresSeries( nView )

      D():FacturasProveedoresPagos( nView )
      ( D():FacturasProveedoresPagos( nView ) )->( ordSetFocus( "rNumFac" ) )

      D():TiposIva( nView )

      D():ProveedorArticulo( nView )

      D():Articulos( nView )

      D():ArticulosCodigosBarras( nView )

      D():Familias( nView )

      D():Kit( nView )

      D():FormasPago( nView )

      D():ArticuloPrecioPropiedades( nView )

      D():Divisas( nView )

      D():Cajas( nView )



      D():AlbaranesProveedores( nView )

      D():AlbaranesProveedoresLineas( nView )

      D():FacturasProveedores( nView )

      D():FacturasProveedoresLineas( nView )

      D():Propiedades( nView )

      D():PropiedadesLineas( nView )

      D():Almacen( nView )

      D():Documentos( nView )
      ( D():Documentos( nView ) )->( ordSetFocus( "cTipo" ) )

      D():UbicacionLineas( nView )

      D():Delegaciones( nView )

      D():Contadores( nView )

      D():Empresa( nView )

      D():BancosProveedores( nView )

      D():GetObject( "UnidadMedicion", nView )

      D():GetObject( "Bancos", nView )

      D():ArticuloLenguaje( nView )

      oStock            := TStock():Create( cPatEmp() )
      if !oStock:lOpenFiles()
         lOpenFiles     := .F.
      end

      oNewImp           := TNewImp():Create( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

      oBandera          := TBandera():New()

      CodigosPostales():GetInstance():OpenFiles()

      TComercio         := TComercio():New( nView, oStock )

      oFntTot           := TFont():New( "Arial", 8, 26, .F., .T. )

      oMailing          := TGenmailingDatabaseFacturaRectificativaProveedor():New( nView )

      Counter           := TCounter():New( nView, "nRctPrv" )

      initPublics()





      if RolesModel():getRolFiltrarVentas( Auth():rolUuid() )
         cFiltroUsuario := "Field->cCodUsr == '" + Auth():Codigo()  + "' .and. Field->cCodCaj == '" + Application():CodigoCaja() + "'"
      end





      oDetCamposExtra      := TDetCamposExtra():New()
      oDetCamposExtra:OpenFiles()
      oDetCamposExtra:SetTipoDocumento( "Facturas rectificativa a proveedores" )
      oDetCamposExtra:setbId( {|| D():FacturasRectificativasProveedoresId( nView ) } )






      oCentroCoste            := TCentroCoste():Create( cPatDat() )
      if !oCentroCoste:OpenFiles()
         lOpenFiles     := .F.
      end

      EnableAcceso()

   RECOVER

      lOpenFiles        := .F.

      EnableAcceso()

      msgStop( "Imposible abrir ficheros de facturas rectificativas a proveedores" )

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end


Return ( lOpenFiles )



Static Function CloseFiles()

   DisableAcceso()

   DestroyFastFilter( D():FacturasRectificativasProveedores( nView ), .T., .T. )

   if oStock <> nil
      oStock:end()
   end

   if !empty( oDetCamposExtra )
      oDetCamposExtra:CloseFiles()
   end

   if !empty( oCentroCoste )
      oCentroCoste:CloseFiles()
   end

   if !empty( oNewImp )
      oNewImp:end()
   end

   if !empty(oMailing)
      oMailing:end()
   end

   D():DeleteView( nView )

   CodigosPostales():GetInstance():CloseFiles()

   oBandera    := nil
   oStock      := nil
   oNewImp     := nil

   lOpenFiles  := .F.

   TComercio:end()

   EnableAcceso()

RETURN ( !lOpenFiles )



FUNCTION RctPrv( oMenuItem, oWnd, cCodPrv, cCodArt, cNumFac )

   local oSnd
   local oRpl
   local oImp
   local oRotor
   local oDel
   local oPrv
   local oPdf
   local oMail
   local oBtnEur
   local nLevel
   local lEuro          := .F.
   local oLiq

   If( oMenuItem == nil, oMenuItem := "rectificativas_de_proveedores", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;
   If( cCodPrv == nil, cCodPrv := "", ) ;
   If( cCodArt == nil, cCodArt := "", ) ;
   If( cNumFac == nil, cNumFac := "", ) ;





   nLevel            := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      return .F.
   end





   DisableAcceso()



















   oWndBrw := TShell():New( 0, 0, 22, 80, "Facturas rectificativa de proveedores",, oWnd,,, .F.,,, ( D():FacturasRectificativasProveedores( nView ) ),,,,, {"Número", "Fecha", "Código", "Proveedor", "Número documento", "Pago"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, D():FacturasRectificativasProveedores( nView ), cCodPrv, cCodArt, cNumFac ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, D():FacturasRectificativasProveedores( nView ), cCodPrv, cCodArt, cNumFac ) )}, {||( WinDelRec( oWndBrw:oBrw, D():FacturasRectificativasProveedores( nView ), {|| QuiRctPrv() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, D():FacturasRectificativasProveedores( nView ), cCodPrv, cCodArt, cNumFac ) )}, nil, nLevel, "gc_document_text_delete2_16", ( 0 + ( 114 * 256 ) + ( 198 * 65536 ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, D():FacturasRectificativasProveedores( nView ) ) )}, .T. )

     oWndBrw:lFechado      := .T.

     oWndBrw:bChgIndex     := {|| if( RolesModel():getRolFiltrarVentas( Auth():rolUuid() ), CreateFastFilter( cFiltroUsuario, D():FacturasRectificativasProveedores( nView ), .F., , cFiltroUsuario ), CreateFastFilter( "", D():FacturasRectificativasProveedores( nView ), .F. ) ) }

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->lCloFac }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "gc_lock2_12", "Nil16" } )
         :AddResource( "gc_lock2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "gc_mail2_12", "Nil16" } )
         :AddResource( "gc_mail2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pagado"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| ChkPagRctPrv( D():FacturasRectificativasProveedores( nView ), D():FacturasProveedoresPagos( nView ) ) }
         :nWidth           := 20
         :AddResource( "gc_check_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_money2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Contabilizado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->lContab }
         :nWidth           := 20
         :SetCheck( { "gc_folder2_12", "Nil16" } )
         :AddResource( "gc_folder2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_check_12" )
         :AddResource( "gc_document_information_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Impreso"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "gc_printer2_12", "Nil16" } )
         :AddResource( "gc_printer2_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumFac"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + "/" + Alltrim( Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cSufFac }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| Trans( ( D():FacturasRectificativasProveedores( nView ) )->cTurFac, "######" ) }
         :nWidth           := 60
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Numero documento"
         :cSortOrder       := "cNumDoc"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc }
         :nWidth           := 80
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dDesFec"
         :bEditValue       := {|| Dtoc( ( D():FacturasRectificativasProveedores( nView ) )->dFecFac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Hora"
         :bEditValue       := {|| trans( ( D():FacturasRectificativasProveedores( nView ) )->tFecFac, "@R 99:99:99") }
         :nWidth           := 60
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodPrv"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomPrv"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cNomPrv }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Pago"
         :cSortOrder       := "cCodPago"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cCodPago }
         :nWidth           := 40
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->nTotNet }
         :cEditPicture     := cPirDiv( ( D():FacturasRectificativasProveedores( nView ) )->cDivFac, D():Divisas( nView ) )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->nTotIva }
         :cEditPicture     := cPirDiv( ( D():FacturasRectificativasProveedores( nView ) )->cDivFac, D():Divisas( nView ) )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->nTotReq }
         :cEditPicture     := cPirDiv( ( D():FacturasRectificativasProveedores( nView ) )->cDivFac, D():Divisas( nView ) )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->nTotFac }
         :cEditPicture     := cPirDiv( ( D():FacturasRectificativasProveedores( nView ) )->cDivFac, D():Divisas( nView ) )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( D():FacturasRectificativasProveedores( nView ) )->cDivFac ), D():Divisas( nView ) ) }
         :nWidth           := 30
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Centro de coste"
         :bEditValue       := {|| ( D():FacturasRectificativasProveedores( nView ) )->cCtrCoste }
         :nWidth           := 30
         :lHide            := .T.
      end

      oWndBrw:lAutoSeek    := .F.

      oDetCamposExtra:addCamposExtra( oWndBrw )

      oWndBrw:cHtmlHelp    := "Factura rectificativa de proveedor"

      oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()








   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )







   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )







   oDel := oWndBrw:NewAt( "DEL",,, {||( oWndBrw:RecDel() )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )







   oImp := oWndBrw:NewAt( "IMP",,, {||( nGenRctPrv( 1 ) )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oImp, 1 )





   oWndBrw:NewAt( "GC_PRINTER2_",,, {||( ImprimirSeriesFacturasRectificativasProveedores() )}, "Imp(r)imir series", "R",,, 32,, .F. )







   oPrv := oWndBrw:NewAt( "PREV1",,, {||( nGenRctPrv( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oPrv, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( nGenRctPrv( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenFac( oWndBrw:oBrw, oPdf, 3 )





   oMail := oWndBrw:NewAt( "GC_MAIL_EARTH_",,, {||( oMailing:documentsDialog( oWndBrw:oBrw:aSelected ) )}, "Correo electrónico",,, {|This|This:Toggle()}, 32,, .F. )






   oWndBrw:NewAt( "gc_portable_barcode_scanner_",,, {||( TLabelGeneratorFacturaRectificativaProveedores():New( nView ):Dialog() )}, "E(t)iquetas", "T",,, 32,, .F. )





   oLiq := oWndBrw:NewAt( "gc_money2_",,, {||( lLiquida( oWndBrw:oBrw ) )}, "Pagar",,,, 4,, .F. )







   oWndBrw:NewAt( "gc_money2_",,, {||( aGetSelRec( oWndBrw, {|| lLiquida( oWndBrw:oBrw, ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac ) }, "Liquidar series de facturas", .T., nil, .T., nil ) )}, "Pagar series",,,, 4, oLiq, .F. )






   oWndBrw:NewAt( "BmpConta",,, {||( aGetSelRec( oWndBrw, {|lChk1, lChk2, oTree | CntRctPrv( lChk1, lChk2, .T., oTree, nil, nil, D():FacturasRectificativasProveedores( nView ), D():FacturasRectificativasProveedoresLineas( nView ), D():FacturasProveedoresPagos( nView ), D():Proveedores( nView ), D():Divisas( nView ), D():Articulos( nView ), D():FormasPago( nView ), D():TiposIva( nView ) ) }, "Contabilizar facturas rectificativas", .F., "Simular resultados", .F., "Contabilizar pagos" ) )}, "(C)ontabilizar", "C",,, 4,, .F. )

   if RolesModel():getRolCambiarEstado( Auth():rolUuid() )






      oWndBrw:NewAt( "ChgState",,, {||( aGetSelRec( oWndBrw, {|lChk1| lCntRctPrv( lChk1, D():FacturasRectificativasProveedores( nView ) ) }, "Cambiar estado", .F., "Contabilizado", .T., nil ) )}, "Cambiar Es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "Lbl",, "Seleccionar facturas para ser enviados", {||lSnd( oWndBrw, D():FacturasRectificativasProveedores( nView ) )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )





   oBtnEur := oWndBrw:NewAt( "gc_currency_euro_",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )






   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "04", ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac ) )}, "I(n)forme documento", "N",,, 4,, .F. )




   oWndBrw:NewAt( "gc_document_text_pencil_",,, {||( Counter:OpenDialog() )}, "Establecer contadores",,,,,, .F. )

   if RolesModel():getRolCambiarCampos( Auth():rolUuid() )






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():FacturasRectificativasProveedores( nView ), aItmRctPrv() ) )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







      oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():FacturasRectificativasProveedoresLineas( nView ), aColRctPrv() ) )}, "Lineas",,,, 4, oRpl, .F. )

   end




   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,,, 4,, .F. )





      oWndBrw:NewAt( "gc_businessman_",,, {||( EdtPrv( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv ) )}, "Modificar proveedor",,,, 4, oRotor, .F. )





      oWndBrw:NewAt( "INFO",,, {||( InfProveedor( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv ) )}, "Informe proveedor",,,, 4, oRotor, .F. )





      oWndBrw:NewAt( "gc_document_empty_businessman_",,, {||( if( !empty( ( D():FacturasRectificativasProveedores( nView ) )->cNumFac ), ZooFacPrv( ( D():FacturasRectificativasProveedores( nView ) )->cNumFac ), MsgStop( "La factura no proviene de un albarán" ) ) )}, "Visualizar factura",,,, 4, oRotor, .F. )






      oWndBrw:NewAt( "GC_BRIEFCASE2_BUSINESSMAN_",,, {||( RecPrv( , , { ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac } ) )}, "Modificar recibo",,,, 4, oRotor, .T. )





   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .T. )

   oWndBrw:oActiveFilter:SetFields( aItmRctPrv() )
   oWndBrw:oActiveFilter:SetFilterType( "03" )

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp, .F. )

   enableAcceso()

   if !empty( oWndBrw )

      if uFieldempresa( "lFltYea" )
         oWndBrw:setYearCombobox()
      end

      if !empty( cCodPrv ) .OR. !empty( cCodArt ) .OR. !empty( cNumFac )
         oWndBrw:RecAdd()
      end

      cCodPrv  := nil
      cCodArt  := nil
      cNumFac  := nil

   end

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, cRctPrvT, oBrw, cCodPrv, cCodArt, nMode, cNumFac )

   local n
   local oDlg
    local oFld
   local oBtnOk
   local oBrwLin
   local oBrwPgo
   local oBrwInc
   local oBrwDoc
   local cGetRet
   local oGet        := Array( 7 )
   local cGet        := Array( 7 )
   local oSayLabels  := Array( 7 )
   local cTlfPrv
   local oTlfPrv
   local oBmpDiv
   local oBmpEmp
   local nOrd        := ( D():FacturasRectificativasProveedores( nView ) )->( ordSetFocus( 1 ) )
   local aControl    := Array( 6 )
   local oSayGas     := Array( 16 )
   local oBmpGeneral

   cTlfPrv           := RetFld( aTmp[ 6 ], D():Proveedores( nView ), "Telefono" )
   cUsr              := UsuariosModel():getNombreWhereCodigo( aTmp[ 46 ] )

   do case
   case nMode == 1

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 1 ]  := cNewSer( "nRctPrv", D():Contadores( nView ) )
      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 35 ]  := cDivEmp()
      aTmp[ 7 ]  := Application():codigoAlmacen()
      aTmp[ 8 ]  := Application():CodigoCaja()
      aTmp[ 36 ]  := nChgDiv( aTmp[ 35 ], D():Divisas( nView ) )
      aTmp[ 3 ]  := RetSufEmp()
      aTmp[ 37 ]  := .T.
      aTmp[ 42 ]  := cProCnt()
      aTmp[ 17 ]  := Ctod( "" )
      aTmp[ 46 ]  := Auth():Codigo()
      aTmp[ 54 ]  := Application():CodigoDelegacion()
      aTmp[ 48 ]  := Ctod( "" )
      aTmp[ 81 ]  := getSysTime()

      if !empty( cCodPrv )
         aTmp[ 6 ]  := cCodPrv
      end

      if !empty( cNumFac )
         aTmp[ 26 ]  := cNumFac
      end

   case nMode == 4

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 8 ]  := Application():CodigoCaja()
      aTmp[ 37 ]  := .T.
      aTmp[ 17 ]  := Ctod( "" )
      aTmp[ 48 ]  := Ctod( "" )
      aTmp[ 44 ]  := .F.
      aTmp[ 16 ]  := .F.

   case nMode == 2

      if aTmp[ 16 ] .AND. !ApoloMsgNoYes( "La modificación de esta factura rectificativa puede provocar descuadres contables." + Chr(13)+Chr(10) + "¿ Desea continuar ?", "Factura ya contabilizada" )
         return .F.
      end

      if aTmp[ 43 ]
         MsgStop( "El documento ha sido recibido por internet", "Imposible modificar" )
         return .F.
      end

      if aTmp[ 44 ] .AND. !oUser():lAdministrador()
         msgStop( "Solo puede modificar los facturas rectificativas cerradas los administradores." )
         return .F.
      end

   end

   if empty( aTmp[ 28 ] )
      aTmp[ 28 ]  := Padr( "General", 50 )
   end

   if empty( aTmp[ 30 ] )
      aTmp[ 30 ]     := Padr( "Pronto pago", 50 )
   end





   if BeginTrans( aTmp, nMode )
      Return .F.
   end





   cOldCodCli  := aTmp[ 6 ]

   cPicUnd     := MasUnd()
   cPinDiv     := cPinDiv( aTmp[ 35 ], D():Divisas( nView ) )
   cPirDiv     := cPirDiv( aTmp[ 35 ], D():Divisas( nView ) )
   nDinDiv     := nDinDiv( aTmp[ 35 ], D():Divisas( nView ) )
   nRinDiv     := nRinDiv( aTmp[ 35 ], D():Divisas( nView ) )
   cPouDiv     := cPouDiv( aTmp[ 35 ], D():Divisas( nView ) )
   cPorDiv     := cPorDiv( aTmp[ 35 ], D():Divisas( nView ) )





   cGet[ 1 ]   := RetFld( aTmp[ 7 ], D():Almacen( nView ) )
   cGet[ 2 ]   := RetFld( aTmp[ 6 ], D():Proveedores( nView ) )
   cGet[ 3 ]   := RetFld( aTmp[ 23], D():FormasPago( nView ) )
   cGet[ 5 ]   := RetFld( aTmp[ 8 ], D():Cajas( nView ) )
   cGet[ 6 ]   := RetFld( cCodEmp() + aTmp[ 54 ], D():Delegaciones( nView ), "cNomDlg" )
   cGet[ 7 ]   := RetFld( aTmp[ 83 ], D():Almacen( nView ) )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "facturas rectificativas de proveedores", "RECTPRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oFld := TFolder():ReDefine( 400, {"&Factura",    "Da&tos",      "&Incidencias",   "D&ocumentos"}, { "RCTPRV_1","RCTPRV_2","PEDCLI_3","PEDCLI_4" }, oDlg,,,,, .F., )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_document_text_blue_48",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_folders2_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_information_48",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_address_book_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )





      aGet[ 46 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oUsr:cText( UsuariosModel():getNombreWhereCodigo( aTmp[ 46 ] ) ), .T.  )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oUsr := TGetHlp():ReDefine( 126, { | u | If( PCount()==0, cUsr, cUsr:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )













        aGet[ 6 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, ( RetPicCodPrvEmp() ), {||    ( loaPrv( aGet, aTmp, D():Proveedores( nView ), nMode, oGet[ 2 ], oTlfPrv ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProvee( aGet[ 6 ], oGet[ 2 ] ) )}, nil, "LUPA",, )





      aGet[ 9 ] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 14 ] := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oTlfPrv := TGetHlp():ReDefine( 107, { | u | If( PCount()==0, cTlfPrv, cTlfPrv:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ 10 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 10 ], Rtrim( aTmp[ 11 ] ) + Space( 1 ) + Rtrim( aTmp[ 12 ] ) )}, nil, "gc_earth_lupa_16",, )





      aGet[ 11 ] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 12 ] := TGetHlp():ReDefine( 108, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 13 ] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],,, {||    ( CodigosPostales():GetInstance():validCodigoPostal() )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ 7 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],,, {||    cAlmacen( aGet[7], , oGet[ 1 ] )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|brwAlmacen( aGet[ 7 ], oGet[ 1 ] )}, nil, "LUPA",, )






      oGet[1] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cGet[1], cGet[1]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ExpAlmacen( aTmp[ 7 ], dbfTmp, oBrwLin ) )}, nil, "Bot",, )









      aGet[ 83 ] := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 83 ], aTmp[ 83 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[ 83 ], , oGet[ 7 ] ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 83 ], oGet[ 7 ] ) )}, nil, "LUPA", 342, )




      oGet[ 7 ] := TGetHlp():ReDefine( 341, { | u | If( PCount()==0, cGet[ 7 ], cGet[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









        aGet[23] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[23], aTmp[23]:= u ) }, oFld:aDialogs[1],, "@!", {||    cFPago( aGet[23], D():FormasPago( nView ), oGet[3] )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,, {|Self|BrwFPago( aGet[23 ], oGet[3] )}, nil, "LUPA",, )





      oGet[3] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cGet[3], cGet[3]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ 74 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 74 ], aTmp[ 74 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,, {|Self|( BrwBncPrv( aGet[ 74 ], aGet[ 75 ], aGet[ 76 ], aGet[ 77 ], aGet[ 78 ], aGet[ 79 ], aGet[ 80 ], aTmp[ 6 ] ) )}, nil, "LUPA",, )






      aGet[ 75 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, aTmp[ 75 ], aTmp[ 75 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( lIbanDigit( aTmp[ 75 ], aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aGet[ 76 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 76 ] := TGetHlp():ReDefine( 302, { | u | If( PCount()==0, aTmp[ 76 ], aTmp[ 76 ]:= u ) }, oFld:aDialogs[1],,, {||    ( lIbanDigit( aTmp[ 75 ], aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aGet[ 76 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 77 ] := TGetHlp():ReDefine( 303, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aGet[ 79 ], aTmp[ 75 ] ), aGet[ 75 ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 78 ] := TGetHlp():ReDefine( 304, { | u | If( PCount()==0, aTmp[ 78 ], aTmp[ 78 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aGet[ 79 ], aTmp[ 75 ] ), aGet[ 75 ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 79 ] := TGetHlp():ReDefine( 305, { | u | If( PCount()==0, aTmp[ 79 ], aTmp[ 79 ]:= u ) }, oFld:aDialogs[1],,, {||    (  lCalcDC( aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aGet[ 79 ], aTmp[ 75 ] ), aGet[ 75 ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 80 ] := TGetHlp():ReDefine( 306, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[1],, "9999999999", {||    (  lCalcDC( aTmp[ 77 ], aTmp[ 78 ], aTmp[ 79 ], aTmp[ 80 ], aGet[ 79 ], aTmp[ 75 ] ), aGet[ 75 ]:lValid() )},,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )












      aGet[ 8 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,, {||    cCajas( aGet[ 8 ], D():Cajas( nView ), oGet[ 5 ] )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 8 ], oGet[ 5 ] ) )}, nil, "LUPA",, )





      oGet[ 5 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cGet[ 5 ], cGet[ 5 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )












        aGet[ 35 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivIn( aGet[ 35 ], oBmpDiv, aGet[ 36 ], @cPinDiv, @nDinDiv, @cPirDiv, @nRinDiv, nil, D():Divisas( nView ), oBandera ) )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 35 ], oBmpDiv, aGet[ 36 ], D():Divisas( nView ), oBandera )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 171, "BAN_EURO",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )





        aGet[ 36 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.9999",,,,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )








      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgFacPrv.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )









      aControl[1] := TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      aControl[2] := TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo )  )},,, .F. )





      aControl[3] := TButton():ReDefine( 502, {||( WinDelRec( oBrwLin, dbfTmp, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )




      aControl[4] := TButton():ReDefine( 503, {||( if( !( dbfTmp )->lControl, WinZooRec( oBrwLin, bEdtDet, dbfTmp, aTmp ), ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )













      aControl[5] := TButton():ReDefine( 524, {||( DbSwapUp( dbfTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      aControl[6] := TButton():ReDefine( 525, {||( DbSwapDown( dbfTmp, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},,, .F. )





      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwLin:cAlias          := dbfTmp

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:lFooter         := .T.
      oBrwLin:cName           := "Lineas de facturas a proveedor"

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Número"
            :bEditValue       := {|| if( ( dbfTmp )->lKitChl, "", Trans( ( dbfTmp )->nNumLin, "9999" ) ) }
            :nWidth           := 65
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Código"
            :bEditValue       := {|| ( dbfTmp )->cRef }
            :nWidth           := 80
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "C. Barras"
            :bEditValue       := {|| cCodigoBarrasDefecto( ( dbfTmp )->cRef, D():ArticulosCodigosBarras( nView ) ) }
            :nWidth           := 100
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Código proveedor"
            :bEditValue       := {|| ( dbfTmp )->cRefPrv }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| if( empty( ( dbfTmp )->cRef ) .AND. !( dbfTmp )->lControl, ( dbfTmp )->mLngDes, ( dbfTmp )->cDetalle ) }
            :nWidth           := 292
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Prop. 1"
            :bEditValue       := {|| ( dbfTmp )->cValPr1 }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Valor prop. 1"
            :bEditValue       := {|| nombrePropiedad( ( dbfTmp )->cCodPr1, ( dbfTmp )->cValPr1, nView ) }
            :nWidth           := 40
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Prop. 2"
            :bEditValue       := {|| ( dbfTmp )->cValPr2 }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Valor prop. 2"
            :bEditValue       := {|| nombrePropiedad( ( dbfTmp )->cCodPr2, ( dbfTmp )->cValPr2, nView ) }
            :nWidth           := 40
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Lote"
            :bEditValue       := {|| ( dbfTmp )->cLote }
            :nWidth           := 80
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Caducidad"
            :bEditValue       := {|| Dtoc( ( dbfTmp )->dFecCad ) }
            :nWidth           := 60
            :lHide            := .T.
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Bultos"
            :bEditValue       := {|| ( dbfTmp )->nBultos }
            :cEditPicture     := cPicUnd
            :nWidth           := 60
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nFooterType      := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := cNombreCajas()
            :bEditValue       := {|| ( dbfTmp )->nCanEnt }
            :cEditPicture     := cPicUnd
            :nWidth           := 60
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nFooterType      := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := cNombreUnidades()
            :bEditValue       := {|| nTotNRctPrv( dbfTmp ) }
            :cEditPicture     := cPicUnd
            :nWidth           := 60
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nFooterType      := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "UM. Unidad de medición"
            :bEditValue       := {|| ( dbfTmp )->cUnidad }
            :nWidth           := 25
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Almacen"
            :bEditValue       := {|| ( dbfTmp )->cAlmLin }
            :nWidth           := 65
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| nTotURctPrv( dbfTmp, nDinDiv ) }
            :cEditPicture     := cPinDiv
            :nWidth           := 90
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% Dto."
            :bEditValue       := {|| ( dbfTmp )->nDtoLin }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% Prm."
            :bEditValue       := {|| ( dbfTmp )->nDtoPrm }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 40
            :lHide            := .T.
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "% " + cImp()
            :bEditValue       := {|| ( dbfTmp )->nIva }
            :cEditPicture     := "@E 999.99"
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwLin:AddCol() )
            :cHeader          := "Total"
            :bEditValue       := {|| nTotLRctPrv( dbfTmp, nDinDiv, nRinDiv ) }
            :cEditPicture     := cPirDiv
            :nWidth           := 90
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
            :nFooterType      := 1
         end

         with object ( oBrwLin:AddCol() )
         :cHeader          := "Centro de coste"
         :bEditValue       := {|| ( dbfTmp )->cCtrCoste }
         :nWidth           := 20
         :lHide            := .T.
      end

         if nMode <> 3
            oBrwLin:bLDblClick   := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
         end

      oBrwLin:CreateFromResource( 190 )









      aGet[ 57 ] := TMultiGet():ReDefine( 290, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oFld:aDialogs[1],, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, .F.,, )











       aGet[ 58 ] := TGetHlp():ReDefine( 600, { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








       aGet[ 61 ] := TGetHlp():ReDefine( 601, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[11] := TSay():ReDefine( 602, {|| Trans( aTmp[ 58 ] * aTmp[ 61 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )








      aGet[ 64 ] := TGetHlp():ReDefine( 603, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[11]:Refresh(), oSayGas[12]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 32 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[12] := TSay():ReDefine( 604, {|| Trans( aTmp[ 58 ] * aTmp[ 64 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )











      aGet[ 59 ] := TGetHlp():ReDefine( 610, { | u | If( PCount()==0, aTmp[ 59 ], aTmp[ 59 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 62 ] := TGetHlp():ReDefine( 611, { | u | If( PCount()==0, aTmp[ 62 ], aTmp[ 62 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[13] := TSay():ReDefine( 612, {|| Trans( aTmp[ 59 ] * aTmp[ 62 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )








      aGet[ 65 ] := TGetHlp():ReDefine( 613, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[13]:Refresh(), oSayGas[14]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 32 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[14] := TSay():ReDefine( 614, {|| Trans( aTmp[ 59 ] * aTmp[ 65 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )











      aGet[ 60 ] := TGetHlp():ReDefine( 620, { | u | If( PCount()==0, aTmp[ 60 ], aTmp[ 60 ]:= u ) }, oFld:aDialogs[1],, cPirDiv, {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )








      aGet[ 63 ] := TGetHlp():ReDefine( 621, { | u | If( PCount()==0, aTmp[ 63 ], aTmp[ 63 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[15] := TSay():ReDefine( 622, {|| Trans( aTmp[ 60 ] * aTmp[ 63 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )








      aGet[ 66 ] := TGetHlp():ReDefine( 623, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[1],, "@ER 99.99%", {||    ( oSayGas[15]:Refresh(), oSayGas[16]:Refresh(), .T. )},,,,,, .F., {||     ( nMode <> 3 .AND. aTmp[ 32 ] )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      oSayGas[16] := TSay():ReDefine( 624, {|| Trans( aTmp[ 60 ] * aTmp[ 66 ] / 100, cPirDiv )}, oFld:aDialogs[1],, "N/W*",, .F.,, .F., .F., )









      aGet[ 28 ] := TGetHlp():ReDefine( 199, { | u | If( PCount()==0, aTmp[ 28 ], aTmp[ 28 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )







      aGet[ 29 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 30 ] := TGetHlp():ReDefine( 209, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )







        aGet[ 31 ] := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 38 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 38 ], aTmp[ 38 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 39 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      aGet[ 40 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 40 ], aTmp[ 40 ]:= u ) }, oFld:aDialogs[1],, "@!",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )},, .F., .F.,,,,,, nil,,, )







      aGet[ 41 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 41 ], aTmp[ 41 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",,,,,,, .F., {||     ( nMode <> 3 .AND. !lRecibosPagadosTmp( dbfTmpPgo ) )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oBrwIva                        := IXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva )

      oBrwIva:lHScroll               := .F.
      oBrwIva:lVScroll               := .F.
      oBrwIva:nMarqueeStyle          := 5
      oBrwIva:lRecordSelector        := .F.

      oBrwIva:CreateFromResource( 490 )

      with object ( oBrwIva:aCols[ 1 ] )
         :cHeader       := "Bruto"
         :bStrData      := {|| if( !empty( aTotIva[ oBrwIva:nArrayAt, 1 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPirDiv ), "" ) }
         :nWidth        := 80
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 2 ] )
         :cHeader       := "Base"
         :bStrData      := {|| if( !empty( aTotIva[ oBrwIva:nArrayAt, 2 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPirDiv ), "" ) }
         :nWidth        := 80
         :cEditPicture  := cPirDiv
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 3 ] )
         :cHeader       := "%" + cImp()
         :bStrData      := {|| if( !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ), aTotIva[ oBrwIva:nArrayAt, 3 ], "" ) }
         :bEditValue    := {|| aTotIva[ oBrwIva:nArrayAt, 3 ] }
         :nWidth        := 45
         :cEditPicture  := "@E 999.99"
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
         :nEditType     := 1
         :bEditWhen     := {|| !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ) }
         :bOnPostEdit   := {|o,x| EdtIva( o, x, aTotIva[ oBrwIva:nArrayAt, 3 ], dbfTmp, D():TiposIva( nView ), oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:aCols[ 4 ] )
         :cHeader       := "%R.E."
         :bStrData      := {|| if( !empty( aTotIva[ oBrwIva:nArrayAt, 4 ] ) .AND. aTmp[ 32 ], Trans( aTotIva[ oBrwIva:nArrayAt, 4 ], "@E 99.9" ), "" ) }
         :nWidth        := 45
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 5 ] )
         :cHeader       := cImp()
         :bStrData      := {|| if( !empty( aTotIva[ oBrwIva:nArrayAt, 5 ] ), Trans( aTotIva[ oBrwIva:nArrayAt, 5 ], cPirDiv ), "" ) }
         :nWidth        := 80
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
      end

      with object ( oBrwIva:aCols[ 6 ] )
         :cHeader       := "R.E."
         :bStrData      := {|| if( !empty( aTotIva[ oBrwIva:nArrayAt, 6 ] ) .AND. aTmp[ 32 ], Trans( aTotIva[ oBrwIva:nArrayAt, 6 ], cPirDiv ), "" ) }
         :nWidth        := 80
         :cEditPicture  := cPirDiv
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end








        oGetNet := TSay():ReDefine( 370, {|| nGetNeto}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



        oGetIva := TSay():ReDefine( 380, {|| nGetIva}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



        oGetReq := TSay():ReDefine( 390, {|| nGetReq}, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )



      oGetIvm := TSay():ReDefine( 403, {|| nTotIvm}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      aGet[ 32 ] := TCheckBox():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[ 1 ],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||         ( nMode <> 3 )}, .F. )




      oGetTotal := TSay():ReDefine( 410, {|| nTotFac}, oFld:aDialogs[ 1 ],,,, .F., oFntTot, .F., .F., )










      aGet[1] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[1], aTmp[1]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[1] >= "A" .AND. aTmp[1] <= "Z"  )}, "N/W*",,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[1] ) )}, {||  ( DwSerie( aGet[1] ) )},,,, nil,,, )

         aGet[ 1 ]:bLostFocus := {|| aGet[ 42 ]:cText( cProCnt( aTmp[ 1 ] ) ) }





        aGet[2] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )




        aGet[3] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )






        aGet[5] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[5], aTmp[5]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 81 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 81 ], aTmp[ 81 ]:= u ) }, oFld:aDialogs[1],, "@R 99:99:99", {||    ( iif(   !validTime( aTmp[ 81 ] ), ( msgStop( "El formato de la hora no es correcto" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





        aGet[18] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[18], aTmp[18]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ 26 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cFacPrv( aGet, oBrwLin, nMode, aTmp ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode == 1 )},, .F., .F.,,,,, {|Self|( brwFacPrv( aGet[ 26 ], nView ) )}, nil, "LUPA",, )







      aGet[ 56 ] := TCheckBox():ReDefine( 550, { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[1],, {||( ShowKitRctPrv( D():FacturasRectificativasProveedores( nView ), oBrwLin, cCodPrv, nil, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva ), RecalculaTotal( aTmp ), .T. )},,,,, .F., {||     ( nMode == 1 )}, .F. )







      aGet[ 50 ] := TComboBox():ReDefine( 440, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, { "Ret. S/Base", "Ret. S/Total" }, oFld:aDialogs[ 1 ],, {||    ( RecalculaTotal( aTmp ) )}, {|Self|( RecalculaTotal( aTmp ) )},,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 50 ]",,,,,,, )








      aGet[ 51 ] := TGetHlp():ReDefine( 450, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[ 1 ],, "@E 99.9", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )



      oGetRet := TSay():ReDefine( 491, {|| cGetRet}, oFld:aDialogs[1],,,, .F.,, .F., .F., )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 701,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 3 ] := TSay():ReDefine( 702,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 4 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 5 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 6 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 7 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )

      oSayGas[ 1 ] := TSay():ReDefine( 707,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 2 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 3 ] := TSay():ReDefine( 709,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 4 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 5 ] := TSay():ReDefine( 711,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 6 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 7 ] := TSay():ReDefine( 713,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 8 ] := TSay():ReDefine( 714,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 9 ] := TSay():ReDefine( 715,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayGas[ 10] := TSay():ReDefine( 716,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )










      aGet[ 67 ] := TComboBox():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, {       "01. Número factura", "02. Serie factura", "03. Fecha expedición", "04. Nombre y apellidos / Razón social del emisor", "05. Nombre y apellidos / Razón social del receptor", "06. Identificación fiscal del emisor obligatoria", "07. Identificación fiscal del receptor", "08. Domicilio emisor obligatorio", "09. Domicilio receptor", "10. Detalle operación", "11. Porcentaje impositivo a aplicar", "12. Cuota tributaria a aplicar", "13. Fecha / Periodo a aplicar", "14. Clase de factura", "15. Literales legales", "16. Base imponible", "80. Cálculo de cuotas repercutidas", "81. Cálculo de cuotas retenidas", "82. Base imponible modificada por devolución de envases / embalajes", "83. Base imponible modificada por descuentos y bonificaciones", "84. Base imponible modificada por resolución firme, judicial o administrativa", "85. Base imponible modificada cuotas repercutidas no satisfechas. Auto de declaración de concurso" }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 67 ]",,,,,,, )





      aGet[ 68 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 68 ], aTmp[ 68 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      aGet[ 17 ] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 45 ] := TGetHlp():ReDefine( 142, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 55 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[2],, { 270, 271, 272, 273 },,,,, .F., {||     ( .F. )}, )




      aGet[ 54 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oGet[ 6 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cGet[ 6 ], cGet[ 6 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[ 82 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 82 ], aTmp[ 82 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oCentroCoste:Existe( aGet[ 82 ], aGet[ 82 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 82 ] ) )}, nil, "LUPA",, 351 )










      aGet[ 42 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[2],, "@R ###.######", {||    ( ChkProyecto( aTmp[ 42 ], oGet[ 4 ] ), .T. )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProyecto( aGet[ 42 ], oGet[ 4 ] ) )}, nil, "LUPA",, )





      oGet[ 4 ] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, cGet[ 4 ], cGet[ 4 ]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )






      aGet[ 24 ] := TGetHlp():ReDefine( 132, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[2],, "999999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )










      aGet[20] := TMultiGet():ReDefine( 210, { | u | If( PCount()==0, aTmp[20], aTmp[20]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, .F.,, )





      oBrwPgo                 := IXBrowse():New( oFld:aDialogs[2] )

      oBrwPgo:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwPgo:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwPgo:cAlias          := dbfTmpPgo

      oBrwPgo:nMarqueeStyle   := 5
      oBrwPgo:cName           := "Pagos de facturas rectifiactivas de proveedor"

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Pg. Pagado"
            :bStrData         := {|| "" }
            :bBmpData         := {|| nEstadoReciboProveedor( dbfTmpPgo ) }
            :nWidth           := 22
            :AddResource( "Cnt16" )
            :AddResource( "Sel16" )
            :AddResource( "gc_undo_16" )
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Cn. Contabilizado"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpPgo )->lConPgo }
            :nWidth           := 22
            :SetCheck( { "Sel16", "Nil16" } )
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Sesión"
            :bEditValue       := {|| Trans( ( dbfTmpPgo )->cTurRec, "######" ) }
            :nWidth           := 40
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dPreCob ) }
            :nWidth           := 75
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Vencimiento"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dFecVto ) }
            :lHide            := .T.
            :nWidth           := 70
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Cobro"
            :bEditValue       := {|| Dtoc( ( dbfTmpPgo )->dEntrada ) }
            :nWidth           := 75
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpPgo )->cDescrip }
            :nWidth           := 175
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| nTotRecPrv( dbfTmpPgo, D():Divisas( nView ), nil, .T. ) }
            :nWidth           := 85
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Divisa"
            :bEditValue       := {|| cSimDiv( ( dbfTmpPgo )->cDivPgo, D():Divisas( nView ) ) }
            :nWidth           := 60
         end

         if nMode <> 3
            oBrwPgo:bLDblClick   := {|| ExtEdtRecPrv( dbfTmpPgo, nView, , oCentroCoste ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) }
         end

      oBrwPgo:CreateFromResource( 220 )





      TButton():ReDefine( 501, {||( ExtEdtRecPrv( dbfTmpPgo, nView, , oCentroCoste ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||         ( nMode == 2 )},,, .F. )





        TButton():ReDefine( 502, {||( ExtDelRecPrv( dbfTmpPgo ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) )}, oFld:aDialogs[2],,, .F., {||         ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 505, {||( PrnRecPrv( ( dbfTmpPgo )->cSerFac + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ), .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )





      TButton():ReDefine( 506, {||( VisRecPrv( ( dbfTmpPgo )->cSerFac + Str( ( dbfTmpPgo )->nNumFac ) + ( dbfTmpPgo )->cSufFac + Str( ( dbfTmpPgo )->nNumRec ), .F. ) )}, oFld:aDialogs[2],,, .F., {||     ( nMode == 2 )},,, .F. )



      oGetTotPg := TSay():ReDefine( 405, {|| nTotFac}, oFld:aDialogs[2],,,, .F.,, .F., .F., )



        oGetPgd := TSay():ReDefine( 400, {|| nGetPgd}, oFld:aDialogs[2],,,, .F.,, .F., .F., )



      oGetPdt := TSay():ReDefine( 410, {|| ( nTotFac - nGetPgd )}, oFld:aDialogs[2],,,, .F.,, .F., .F., )






      aGet[ 47 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 48 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 49 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 49 ], aTmp[ 49 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 5
      oBrwInc:cName           := "Incidencias de facturas rectificativas de proveedor"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 60
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 425
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) )}, oFld:aDialogs[ 3 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )





      oBrwDoc                 := IXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 5
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

         with object ( oBrwDoc:AddCol() )
            :cHeader          := "Documento"
            :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
            :nWidth           := 885
         end

         if nMode <> 3
            oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
         end

         oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .F. ) )}, oFld:aDialogs[ 4 ],,, .F., {||         ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )





     TButton():ReDefine( 10, {||( RecalculaFacturaRectificativas( aTmp, oDlg ), ( oBrwLin:Refresh() ), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      oBtnOk := TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg, oFld ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 3, {||( if( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg, oFld ), GenRctPrv( 1 ), ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( If( ExitNoSave( nMode, dbfTmp ), ( oDlg:end() ), ) )}, oDlg,,, .F.,,,, .T. )

   CodigosPostales():GetInstance():setBinding( { "CodigoPostal" => aGet[ 13 ], "Poblacion" => aGet[ 11 ], "Provincia" => aGet[ 12 ] } )

   if nMode <> 3
      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| WinDelRec( oBrwLin, dbfTmp, {|| delDeta() }, {|| RecalculaTotal( aTmp ) } ) } )

      oFld:aDialogs[2]:AddFastKey( 114, {|| ExtEdtRecPrv( dbfTmpPgo, nView ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) } )
      oFld:aDialogs[2]:AddFastKey( 115, {|| ExtDelRecPrv( dbfTmpPgo ), oBrwPgo:Refresh(), RecalculaTotal( aTmp ) } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| DbDelRec( oBrwInc, dbfTmpInc, nil, nil, .T. ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| DbDelRec( oBrwDoc, dbfTmpDoc, nil, nil, .F. ) } )

      oDlg:AddFastKey( 116,             {|| EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg, oFld ) } )
      oDlg:AddFastKey( 117,             {|| if( EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDinDiv, oDlg, oFld ), GenRctPrv( 1 ), ) } )
      oDlg:AddFastKey( 120,             {|| oDetCamposExtra:Play( space(1) ) } )
      oDlg:AddFastKey( 65,                {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )
   end

   oDlg:AddFastKey ( 112, {|| GoHelp() } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 46 ] ), , oDlg:end() ) }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 46 ] ), AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt ), oDlg:end() ) }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !empty( cCodArt )
         oDlg:bStart := {|| AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt ) }

      otherwise
         oDlg:bStart := {|| StartEdtRec( aGet, oGet, nMode ) }

   end




    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|(  RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(  initEdtRec( cNumFac, aGet, aTmp, oDlg, oBrwLin, oBrwPgo, oBrwInc, cCodPrv, dbfTmpInc, aControl, oSayGas, oSayLabels, oBrwIva ) )}, oDlg:bRClicked,,, )

   oBmpEmp:End()
   oBmpGeneral:End()

   ( D():FacturasRectificativasProveedores( nView ) )->( OrdSetFocus( nOrd ) )





   ChkLqdRctPrv( nil, D():FacturasRectificativasProveedores( nView ), D():FacturasRectificativasProveedoresLineas( nView ), D():FacturasProveedoresPagos( nView ), D():TiposIva( nView ), D():Divisas( nView ) )





   KillTrans( oBrwLin )

RETURN ( oDlg:nResult == 1 )



Static Function StartEdtRec( aGet, oGet, nMode )

   if uFieldEmpresa( "lShowOrg" )
      aGet[ 83 ]:Show()
      oGet[7]:Show()
   else
      aGet[ 83 ]:Hide()
      oGet[7]:Hide()
   end

   if nMode <> 1

      if !empty( aGet[ 82 ] )
         aGet[ 82 ]:lValid()
      endif

   end

Return ( nil )



Static Function initEdtRec( cNumFac, aGet, aTmp, oDlg, oBrwLin, oBrwPgo, oBrwInc, cCodPrv, dbfTmpInc, aControl, oSayGas, oSayLabels, oBrwIva )

   if !empty( cNumFac )
      aGet[ 26 ]:lValid()
   endif

   EdtRecMenu( aTmp, oDlg )
   ShowKitRctPrv( D():FacturasRectificativasProveedores( nView ), oBrwLin, cCodPrv, dbfTmpInc, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva )

   oBrwLin:MakeTotals()

   oBrwLin:Load()
   oBrwPgo:Load()
   oBrwInc:Load()

return( .T. )



Static Function RecalculaFacturaRectificativas( aTmp, oDlg )

   local nRecNum
   local nPreCom




   if !ApoloMsgNoYes( "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿ Desea proceder ?" )
      return nil
   end

   oDlg:Disable()

   ( D():Articulos( nView ) )->( ordSetFocus( "Codigo" ) )

   nRecNum                          := ( dbfTmp )->( RecNo() )

   ( dbfTmp )->( dbGotop() )
   while !( dbfTmp )->( eof() )





      nPreCom                       := nComPro( ( dbfTmp )->cRef, ( dbfTmp )->cCodPr1, ( dbfTmp )->cValPr1, ( dbfTmp )->cCodPr2, ( dbfTmp )->cValPr2, D():ArticuloPrecioPropiedades( nView ) )

      if nPrecom  <> 0

         ( dbfTmp )->nPreUnit       := nPreCom

      else

         if uFieldEmpresa( "lCosPrv", .F. )
            nPreCom                 := nPrecioReferenciaProveedor( aTmp[ 6 ], ( dbfTmp )->cRef, D():ProveedorArticulo( nView ) )
         end

         if nPreCom <> 0
            ( dbfTmp )->nPreUnit    := nPreCom
         else

            ( dbfTmp )->nPreUnit    := nCosto( ( dbfTmp )->cRef, D():Articulos( nView ), D():Kit( nView ), .F., aTmp[ 35 ], D():Divisas( nView ) )
         end

      end

      ( dbfTmp )->( dbSkip() )

   end

   ( dbfTmp )->( dbGoTo( nRecNum ) )

   oDlg:Enable()

return nil



Static Function EdtPgo( aTmp, aGet, dbfTmpPgo, oBrw, cDiv, oBandera, nMode, aTmpFac )

    local oDlg
   local oGetPrv
   local cGetPrv        := RetProvee( aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODPRV" ) ) ], D():Proveedores( nView ) )
   local oSay
   local cSay           := Num2Text( aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ] )
   local oBmpDiv
   local oGetSubCta
   local cGetSubCta
   local cPirDiv        := cPirDiv( aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ], D():Divisas( nView ) )
   local nDinDiv        := nRinDiv( aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ], D():Divisas( nView ) )
   local nImpOld        := Abs( aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ] )

   if empty( aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ] )
      aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODCAJ" ) ) ]   := Application():CodigoCaja()
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "recibos de proveedores", "PGO_PRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ]:cText( Calendario( aTmp[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ] ) )}, nil,,, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ]:cText( Calendario( aTmp[ ( dbfTmpPgo )->( FieldPos( "DFECVTO" ) ) ] ) )}, nil,,, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ]:cText( Calendario( aTmp[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ] ) )}, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "CCODPRV" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODPRV" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODPRV" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oGetPrv := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, cGetPrv, cGetPrv:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )










      aGet[ ( dbfTmpPgo )->( FieldPos( "CCODPGO" ) ) ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODPGO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODPGO" ) ) ]:= u ) }, oDlg,, "@!", {||    ( cFPago( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODPGO" ) ) ], D():FormasPago( nView ), aGet[ ( dbfTmpPgo )->( FieldPos( "CCODPGO" ) ) ]:oHelpText ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODPGO" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CCODPGO" ) ) ]:oHelpText ) )}, nil, "LUPA",, 311 )









      aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ]:= u ) }, oDlg,,, {||    ( D():GetObject( "Bancos", nView ):Existe( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ], aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ]:oHelpText, "cNomBnc", .T., .T., "0" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( D():GetObject( "Bancos", nView ):Buscar( aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ] ) )}, nil, "LUPA",, 321 )






      aGet[ ( dbfTmpPgo )->( FieldPos( "CDESCRIP" ) ) ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CDESCRIP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDESCRIP" ) ) ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      aGet[ ( dbfTmpPgo )->( FieldPos( "CPGDOPOR" ) ) ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CPGDOPOR" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CPGDOPOR" ) ) ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ]:= u ) }, oDlg,, ( cPirDiv ), {||    ( oSay:SetText( Num2Text( aTmp[ ( dbfTmpPgo )->( FieldPos( "NIMPORTE" ) ) ] ) ), .T. )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ ( dbfTmpPgo )->( FieldPos( "LRECIMP" ) ) ] := TCheckBox():ReDefine( 160, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "LRECIMP" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "LRECIMP" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )










      aGet[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ]:= u ) }, oDlg,, "@!", {||    ( cDivOut( aGet[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ], oBmpDiv, aGet[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ], @cPirDiv, @nDinDiv, nil, nil, nil, nil, nil, D():Divisas( nView ), oBandera ) )}, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ], oBmpDiv, aGet[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ], D():Divisas( nView ), oBandera )}, nil, "LUPA",, )



        oBmpDiv := TBitmap():ReDefine( 171,,, oDlg,,, .F., .F.,,, .F.,,, .F. )








      aGet[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ] := TGetHlp():ReDefine( 172, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ]:= u ) }, oDlg,, "@E 999,999.9999", {||    ( aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ] > 0 )}, "N/W*",,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ ( dbfTmpPgo )->( FieldPos( "LCOBRADO" ) ) ] := TCheckBox():ReDefine( 220, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "LCOBRADO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "LCOBRADO" ) ) ]:= u ) }, oDlg,, {||( aGet[ ( dbfTmpPgo )->( FieldPos( "DENTRADA" ) ) ]:cText( if( aTmp[ ( dbfTmpPgo )->( FieldPos( "LCOBRADO" ) ) ], date(), ctod("") ) ) )},,,,, .F., {||         ( nMode <> 3 )}, .F. )





      aGet[ ( dbfTmpPgo )->( FieldPos( "LNOTARQUEO" ) ) ] := TCheckBox():ReDefine( 330, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "LNOTARQUEO" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "LNOTARQUEO" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )




      oSay := TSay():ReDefine( 190, {|| cSay}, oDlg,, "N/W*",, .F.,, .F., .F., )










      aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ], aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ]:= u ) }, oDlg,, ( Replicate( "X", nLenSubcuentaContaplus() ) ), {||    ( MkSubcuenta( aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ], { aTmp[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ] }, oGetSubCta ) )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkSubcuenta( aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ], oGetSubCta ) )}, nil, "LUPA",, )





        oGetSubCta := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cGetSubCta, cGetSubCta:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )









      TButton():ReDefine( 1, {||( EndPgo( nImpOld, aTmp, aGet, dbfTmpPgo, oBrw, nMode, oDlg ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 998, {||( GoHelp() )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| EndPgo( nImpOld, aTmp, aGet, dbfTmpPgo, oBrw, nMode, oDlg ) } )
   end

   oDlg:AddFastKey( 112, {|| GoHelp() } )




   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( EdtRecPgoMenu( aTmp, aGet, oDlg ), aGet[ ( dbfTmpPgo )->( FieldPos( "CCODBNC" ) ) ]:lValid(), aGet[ ( dbfTmpPgo )->( FieldPos( "CCODPGO" ) ) ]:lValid() )}, oDlg:bRClicked,,, )

   oMnuPgo:End()
   oBmpDiv:End()

RETURN ( oDlg:nResult == 1 )



Static Function EdtRecPgoMenu( aTmp, aGet, oDlg )

   local cCodPrv  := aTmp[ ( dbfTmpPgo )->( FieldPos( "CCODPRV" ) ) ]

   oMnuPgo := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )




            MenuAddItem( "&1. Modificar proveedor", "Modifica el proveedor de la factura rectificativa", .F.,, {|oMenuItem|( EdtPrv( cCodPrv ) )},, "gc_businessman_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&2. Informe proveedor", "Informe del proveedor de la factura", .F.,, {|oMenuItem|( InfProveedor( cCodPrv ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMnuPgo )

   aGet[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ]:lValid()
   aGet[ ( dbfTmpPgo )->( FieldPos( "CCTAREC" ) ) ]:lValid()

   aGet[ ( dbfTmpPgo )->( FieldPos( "DPRECOB" ) ) ]:SetFocus()

Return ( oMnuPgo )



Static Function EndPgo( nImpOld, aTmp, aGet, dbfTmpPgo, oBrw, nMode, oDlg )

   local nCon
   local nImp
   local nRec        := ( dbfTmpPgo )->( Recno() )
   local lImpNeg     := aTmp[ ( dbfTmpPgo )->( FieldPos( "nImporte" ) ) ] < 0
   local nImpAct     := Abs( aTmp[ ( dbfTmpPgo )->( FieldPos( "nImporte" ) ) ] )










   aTmp[ ( dbfTmpPgo )->( FieldPos( "DFECCHG" ) ) ]  := GetSysDate()
   aTmp[ ( dbfTmpPgo )->( FieldPos( "CTIMCHG" ) ) ]  := Time()





   if nImpAct <> nImpOld





      nImp                       := ( nImpOld - nImpAct ) * if( lImpNeg, - 1 , 1 )





      ( dbfTmpPgo )->( dbAppend() )

      nCon                       := ( dbfTmpPgo )->( LastRec() )

      ( dbfTmpPgo )->cTurRec     := cCurSesion()

      ( dbfTmpPgo )->cSerFac     := aTmp[ ( dbfTmpPgo )->( FieldPos( "cSerFac"  ) ) ]
      ( dbfTmpPgo )->nNumFac     := aTmp[ ( dbfTmpPgo )->( FieldPos( "nNumFac" ) ) ]
      ( dbfTmpPgo )->cSufFac     := aTmp[ ( dbfTmpPgo )->( FieldPos( "cSufFac" ) ) ]
      ( dbfTmpPgo )->nNumRec     := nCon
      ( dbfTmpPgo )->cTipRec     := "R"
      ( dbfTmpPgo )->cCodCaj     := aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodCaj" ) ) ]
      ( dbfTmpPgo )->cCodPrv     := aTmp[ ( dbfTmpPgo )->( FieldPos( "cCodPrv" ) ) ]
      ( dbfTmpPgo )->dEntrada    := Ctod( "" )
      ( dbfTmpPgo )->nImporte    := nImp
      ( dbfTmpPgo )->cDescrip    := "Recibo nº" + AllTrim( Str( nCon ) ) + " de factura rectificativa " + aTmp[ ( dbfTmpPgo )->( FieldPos( "cSerFac" ) ) ] + "/" + AllTrim( Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "nNumFac" ) ) ] ) ) + "/" + aTmp[ ( dbfTmpPgo )->( FieldPos( "cSufFac" ) ) ]
      ( dbfTmpPgo )->dPreCob     := dFecRctPrv( aTmp[ ( dbfTmpPgo )->( FieldPos( "cSerFac" ) ) ] + Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "nNumFac" ) ) ] ) + aTmp[ ( dbfTmpPgo )->( FieldPos( "cSufFac" ) ) ], D():FacturasRectificativasProveedores( nView ) )
      ( dbfTmpPgo )->dFecVto     := dFecRctPrv( aTmp[ ( dbfTmpPgo )->( FieldPos( "cSerFac" ) ) ] + Str( aTmp[ ( dbfTmpPgo )->( FieldPos( "nNumFac" ) ) ] ) + aTmp[ ( dbfTmpPgo )->( FieldPos( "cSufFac" ) ) ], D():FacturasRectificativasProveedores( nView ) )
      ( dbfTmpPgo )->cPgdoPor    := ""
      ( dbfTmpPgo )->lCobrado    := .F.
      ( dbfTmpPgo )->cDivPgo     := aTmp[ ( dbfTmpPgo )->( FieldPos( "CDIVPGO" ) ) ]
      ( dbfTmpPgo )->nVdvPgo     := aTmp[ ( dbfTmpPgo )->( FieldPos( "NVDVPGO" ) ) ]
      ( dbfTmpPgo )->lConPgo     := .F.

      ( dbfTmpPgo )->( dbUnLock() )

   end

   ( dbfTmpPgo )->( dbGoTo( nRec ) )

   WinGather( aTmp, aGet, dbfTmpPgo, oBrw, nMode )

   oDlg:End( 1 )

Return nil



Static Function DelCobPrv( oBrw, cRctPrvP )

   if ( D():FacturasProveedoresPagos( nView ) )->lCobrado .AND. !oUser():lAdministrador()
      msgStop( "Este recibo está cobrado.", "Imposible eliminar" )
      return .F.
   end

   if RolesModel():getRolNoConfirmacionEliminacion( Auth():rolUuid() ) .OR. ApoloMsgNoYes("¿ Desea eliminar definitivamente este registro ?", "Confirme supersión" )
      DelRecno( D():FacturasProveedoresPagos( nView ), oBrw, .F. )
   end

return .T.



Static Function EdtRecMenu( aTmp, oDlg )

   oMnuRec := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

            if !lExternal




            MenuAddItem( "&1. Campos extra [F9]", "Mostramos y rellenamos los campos extra para la familia", .F.,, {|oMenuItem|( oDetCamposExtra:Play( space(1) ) )},, "gc_form_plus2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&2. Visualizar albarán", "Visualiza la factura del la que proviene", .F.,, {|oMenuItem|( if( !empty( ( D():FacturasRectificativasProveedores( nView ) )->cNumFac ), ZooFacPrv( ( D():FacturasRectificativasProveedores( nView ) )->cNumFac ), MsgStop( "La factura rectificativa no proviene de una factura" ) ))},, "gc_document_empty_businessman_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

            MenuAddItem(,,,,,,,,,,,,,,,,,.T.,,,,,,,,,,,,,,,,,)




            MenuAddItem( "&3. Modificar proveedor", "Modificar la ficha del proveedor", .F.,, {|oMenuItem|( EdtPrv( aTmp[ 6 ] ) )},, "gc_businessman_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&4. Informe de proveedor", "Abrir el informe del proveedor", .F.,, {|oMenuItem|( InfProveedor( aTmp[ 6 ] ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )
            MenuAddItem(,,,,,,,,,,,,,,,,,.T.,,,,,,,,,,,,,,,,,)

            end




            MenuAddItem( "&5. Informe del documento", "Abrir el informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "03", ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMnuRec )

Return ( oMnuRec )



Static Function EdtInc( aTmp, aGet, dbf, oBrw, bWhen, bValid, nMode, aTmpFac )

   local oDlg

   if nMode == 1
      aTmp[ 1  ] := aTmpFac[ 1  ]
      aTmp[ 2  ] := aTmpFac[ 2 ]
      aTmp[ 3  ] := aTmpFac[ 3 ]
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de facturas rectificativas de proveedores", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||         ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



Static Function EdtDoc( aTmp, aGet, dbfAlbPrvD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de facturas a proveedor", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )






STATIC FUNCTION EdtDet( aTmp, aGet, dbf, oBrw, aTmpFac, cCodArtEnt, nMode )

    local oDlg
    local oFld
   local oBtn
    local oTotal
   local cSay2
   local oSay2
   local oBmp
   local oBrwPrp
   local oSayPr1
   local oSayPr2
   local oSayVp1
   local oSayVp2
   local cSayVp1           := ""
   local cSayVp2           := ""
   local cSayPr1           := ""
   local cSayPr2           := ""
   local nTotal            := 0
   local oBtnSer
   local cCodArt           := Padr( aTmp[ 4 ], 200 )






   cOldCodArt              := aTmp[ 4    ]
   cOldPrpArt              := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]
   cOldUndMed              := aTmp[ 12 ]
   cTipoCtrCoste           := AllTrim( aTmp[ 99 ] )

   do case
   case nMode == 1

      aTmp[ 13 ]    := 1
      aTmp[ 57  ]    := aTmpFac[ 7 ]
      aTmp[ 63  ]    := nLastNum( dbfTmp )
      aTmp[ 62  ]    := Ctod( "" )

      if !empty( cCodArtEnt )
         cCodArt           := cCodArtEnt
      end

      cTipoCtrCoste        := "Centro de coste"

   case nMode == 2

      if !empty( aTmp[ 4 ] )
         ( D():Articulos( nView ) )->( dbSeek( Alltrim( aTmp[ 4 ] ) ) )
      end

   end





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "lineas a facturas de proveedores", "LALBPRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )











      oFld := TFolder():ReDefine( 400, {"&General", "&Stock", "&Observaciones", "&Centro coste"}, { "LFACPRV_7","LALBPRV_3","LFACPRV_5","LCTRCOSTE" }, oDlg,,,,, .F., )







      aGet[ 4 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oFld:aDialogs[1],,, {||    ( LoaArt( cCodArt, aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oDlg, oTotal ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[ 4 ], aGet[ 6 ], .F., .T., oBtn, aGet[ 61 ], aTmp[ 52 ], aTmp[ 53 ], aGet[ 54 ], aGet[ 55 ], aGet[ 62 ], if( uFieldEmpresa( "lStockAlm" ), aTmp[ 57 ], nil ) ) )}, nil, "LUPA",, )










      aGet[ 61 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,, 111, )







      aGet[ 62 ] := TGetHlp():ReDefine( 113, { | u | If( PCount()==0, aTmp[ 62 ], aTmp[ 62 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 114, )





        aGet[6] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[6], aTmp[6]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( ( lModDes() .OR. empty( aTmp[ 6 ] ) ) .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






        aGet[15] := TMultiGet():ReDefine( 121, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[1],, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, .F.,, )









      aGet[ 9 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( D():TiposIva( nView ), aTmp[ 9 ], @aTmp[ 81 ] ) )},,,,,, .F., {||     ( lModIva() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 9 ], D():TiposIva( nView ), , .T. ) )}, nil, "LUPA",, )










      aGet[ 93 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 93 ], aTmp[ 93 ]:= u ) }, oFld:aDialogs[1],, cPinDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 126, )















      aGet[54] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[54], aTmp[54]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 54 ], oSayVp1, aTmp[52 ], D():PropiedadesLineas( nView ) ), LoaArt( cCodArt, aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oDlg, oTotal ), .F. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 54 ], oSayVp1, aTmp[ 52 ] ) )}, nil, "LUPA",, )

         aGet[ 54 ]:bChange   := {|| aGet[ 54 ]:Assign() }



      oSayPr1 := TSay():ReDefine( 221, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      oSayVp1 := TGetHlp():ReDefine( 222, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 55 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aGet[ 55 ], oSayVp2, aTmp[ 53 ], D():PropiedadesLineas( nView ) ), LoaArt( cCodArt, aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oDlg, oTotal ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[ 55 ], oSayVp2, aTmp[ 53 ] ) )}, nil, "LUPA",, )

         aGet[ 55 ]:bChange   := {|| aGet[ 55 ]:Assign() }



      oSayPr2 := TSay():ReDefine( 231, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      oSayVp2 := TGetHlp():ReDefine( 232, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      oBrwPrp                       := IXBrowse():New( oFld:aDialogs[1] )

      oBrwPrp:nDataType             := 2

      oBrwPrp:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwPrp:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwPrp:lHScroll              := .T.
      oBrwPrp:lVScroll              := .T.

      oBrwPrp:nMarqueeStyle         := 3
      oBrwPrp:nFreeze               := 1

      oBrwPrp:lRecordSelector       := .F.
      oBrwPrp:lFastEdit             := .T.
      oBrwPrp:lFooter               := .T.

      oBrwPrp:SetArray( {}, .F., 0, .F. )

      oBrwPrp:MakeTotals()

      oBrwPrp:CreateFromResource( 100 )













      aGet[ 90 ] := TGetHlp():ReDefine( 470, { | u | If( PCount()==0, aTmp[ 90 ], aTmp[ 90 ]:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     ( uFieldEmpresa( "lUseBultos" ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,, 471, )








      aGet[12] := TGetHlp():ReDefine( 152, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],,, {||    ( D():GetObject( "UnidadMedicion", nView ):Existe( aGet[ 12 ], aGet[ 12 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( D():GetObject( "UnidadMedicion", nView ):Buscar( aGet[ 12 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 153 )











      aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 420, { | u | If( PCount()==0, aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 421, )

      aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 430, { | u | If( PCount()==0, aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 431, )

      aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 440, { | u | If( PCount()==0, aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 441, )

      aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )









        aGet[10] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[10], aTmp[10]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )},,,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 141, )









        aGet[13] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[13], aTmp[13]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )},,,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,, 151, )









        aGet[7] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],, cPinDiv, {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )









      aGet[16] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[16], aTmp[16]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )









      aGet[17] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[17], aTmp[17]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )}, {|nKey,nFlags,Self| ( lCalcDeta( aTmp, aTmpFac, aGet, oTotal ) ) }, .F., .T.,,,,,, nil,,, )







      aGet[18] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[18], aTmp[18]:= u ) }, oFld:aDialogs[1],, "@E 99.99",, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[ 88 ] := TCheckBox():ReDefine( 460, { | u | If( PCount()==0, aTmp[ 88 ], aTmp[ 88 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )

      aGet[ 88 ]:bChange   := {|| if( aTmp[ 88 ], ( aGet[ 9 ]:cText( 0 ), aGet[ 9 ]:HardDisable() ), ( aGet[ 9 ]:HardEnable() ) ) }




      aGet[ 91 ] := TGetHlp():ReDefine( 480, { | u | If( PCount()==0, aTmp[ 91 ], aTmp[ 91 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 5 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





        oTotal := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, nTotal, nTotal:= u ) }, oFld:aDialogs[1],, cPirDiv,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 96 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 96 ], aTmp[ 96 ]:= u ) }, oFld:aDialogs[1],,, {||    (  cAlmacen( aGet[ 96 ], , aGet[ 96 ]:oHelpText ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 96 ], aGet[ 96 ]:oHelpText ) )}, nil, "LUPA", 332, 331 )








      aGet[57] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[57], aTmp[57]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[57], , oSay2 ) )}, "N/W*",,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( Self, oSay2 ) )}, nil, "LUPA",, )




        oSay2 := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, cSay2, cSay2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 58 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )





      aGet[ 89 ] := TGetHlp():ReDefine( 360, { | u | If( PCount()==0, aTmp[ 89 ], aTmp[ 89 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 94 ] := TGetHlp():ReDefine( 361, { | u | If( PCount()==0, aTmp[ 94 ], aTmp[ 94 ]:= u ) }, oFld:aDialogs[2],, "@R 99:99:99", {||    ( iif(   !validTime( aTmp[ 94 ] ), ( msgStop( "El formato de la hora no es correcto" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[82] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[82], aTmp[82]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )












      aGet[ 95 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 95 ], aTmp[ 95 ]:= u ) }, oFld:aDialogs[ 4 ],,, {||    ( oCentroCoste:Existe( aGet[ 95 ], aGet[ 95 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 95 ] ) )}, nil, "LUPA",, 411 )






      oTipoCtrCoste := TComboBox():ReDefine( 140, { | u | If( PCount()==0, cTipoCtrCoste, cTipoCtrCoste:= u ) }, aTipoCtrCoste, oFld:aDialogs[4],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oTipoCtrCoste",,,,,,, )

         oTipoCtrCoste:bChange   := {|| clearGet( aGet[ 100 ] ), loadGet( aGet[ 100 ], cTipoCtrCoste ) }







      aGet[ 100 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 100 ], aTmp[ 100 ]:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 160 )





      oBtn := TButton():ReDefine( 1, {||( SaveDeta( aTmp, aGet, oBrw, oDlg, nMode, oTotal, oFld, aTmpFac, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBrwPrp, oBtn, oBtnSer ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( GoHelp() )}, oDlg,,, .F.,,,, .F. )




      oBtnSer := TButton():ReDefine( 552, {||( EditarNumeroSerie( aTmp, nMode ) )}, oDlg,,, .F.,,,, .F. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| oBtn:SetFocus(), oBtn:Click() } )
   end

   oDlg:AddFastKey( 117, {|| oBtnSer:Click() } )
   oDlg:AddFastKey( 112, {|| GoHelp() } )



   oDlg:bStart    := {|| SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, oBrwPrp ), loadGet( aGet[ 100 ], cTipoCtrCoste ), aGet[ 100 ]:lValid(), aGet[ 12 ]:lValid() }



    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

RETURN ( oDlg:nResult == 1 )



STATIC FUNCTION SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, oBrwPrp )

   local cCodArt        := Left( aGet[ 4 ]:VarGet(), 18 )

   if !uFieldEmpresa( "lUseBultos" )
      aGet[ 90 ]:Hide()
   else
      if !empty( aGet[ 90 ] )
         aGet[ 90 ]:SetText( uFieldempresa( "cNbrBultos" ) )
      end
   end

   if !lUseCaj()
      aGet[ 10 ]:Hide()
   else
      aGet[ 10 ]:SetText( cNombreCajas() )
   end

   aGet[ 13 ]:SetText( cNombreUnidades() )

   if empty( aTmp[ 96 ] )
      aTmp[ 96 ]  := aTmpFac[ 83 ]
   end

   if uFieldEmpresa( "lShowOrg" )
      aGet[ 96 ]:Show()
   else
      aGet[ 96 ]:Hide()
   end

   oBrwPrp:Hide()

   oSayPr1:SetText( "" )
   oSayVp1:SetText( "" )

   oSayPr2:SetText( "" )
   oSayVp2:SetText( "" )





   oFld:aEnable   := { .T., !empty( aTmp[ 4 ] ), .T., .T. }
   oFld:SetOption( 1 )

   do case
   case nMode == 1

      aGet[ 4    ]:Show()
      aGet[ 4    ]:cText( Space( 200 ) )

      aGet[ 6]:show()

      aGet[ 15 ]:hide()
      aGet[ 61   ]:hide()
      aGet[ 62 ]:hide()
      aGet[ 10 ]:cText( 1 )
      aGet[ 13]:cText( 1 )
      aGet[ 96 ]:cText( aTmpFac[ 83 ] )
      aGet[ 57 ]:cText( aTmpFac[ 7 ] )
      aGet[ 9    ]:cText( nIva( D():TiposIva( nView ), cDefIva() ) )

      aGet[ 95 ]:cText( aTmpFac[ 82 ] )

      if !empty( aGet[ 95 ] )
         aGet[ 95 ]:lValid()
      endif

      cTipoCtrCoste        := "Centro de coste"
      oTipoCtrCoste:Refresh()
      clearGet( aGet[ 100 ] )

   case nMode <> 1 .AND. empty( cCodArt )

      aGet[ 4    ]:hide()
        aGet[ 6]:hide()
        aGet[ 15 ]:show()
      aGet[ 61   ]:hide()
      aGet[ 62 ]:hide()

      if !empty( aGet[ 95 ] )
         aGet[ 95 ]:lValid()
      endif

   case nMode <> 1 .AND. !empty( cCodArt )

      aGet[ 4    ]:show()
        aGet[ 6]:show()
        aGet[ 15 ]:hide()

      if aTmp[ 59   ]
         aGet[ 61   ]:Show()
         aGet[ 5 ]:Show()
      else
         aGet[ 61   ]:Hide()
         aGet[ 62 ]:Hide()
      end

      if !empty( aGet[ 95 ] )
         aGet[ 95 ]:lValid()
      endif

   end

   lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

   if !empty( aTmp[ 52 ] )
      aGet[ 54 ]:Show()
      aGet[ 54 ]:lValid()
      oSayPr1:Show()
      oSayVp1:Show()
      oSayPr1:SetText( retProp( aTmp[52], D():Propiedades( nView ) ) )
   else
      aGet[ 54 ]:hide()
      oSayPr1:Hide()
      oSayVp1:Hide()
   end

   if !empty( aTmp[53 ] )
      aGet[ 55 ]:Show()
      aGet[ 55 ]:lValid()
      oSayPr2:Show()
      oSayVp2:Show()
      oSayPr2:SetText( retProp(  aTmp[53], D():Propiedades( nView ) ) )
   else
      aGet[ 55 ]:hide()
      oSayPr2:hide()
      oSayVp2:hide()
   end





   aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
   aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
   aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()




















   aGet[ 57 ]     :lValid()
   aGet[ 96 ] :lValid()
   aGet[ 12 ]     :lValid()

   aGet[ 4    ]     :SetFocus()

Return Nil



STATIC FUNCTION SaveDeta( aTmp, aGet, oBrw, oDlg2, nMode, oTotal, oFld, aTmpFac, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBrwPrp, oBtn, oBtnSer )

   local n
   local i

   oBtn:SetFocus()

   if empty( aTmp[ 4 ] ) .AND. lRetCodArt()
      MsgStop( "No se pueden añadir lineas sin codificar" )
      return .F.
   end

   if !lMoreIva( aTmp[9] )
      return nil
   end

   if empty( aTmp[ 57 ] )
      MsgStop( "Código de almacen no puede estar vacio" )
      aGet[ 57 ]:SetFocus()
      Return nil
   end

   if !cAlmacen( aGet[ 57 ] )
      MsgStop( "Código de almacen no encontrado" )
      Return nil
   end

   if ( aTmp[ 57 ] == aTmp[ 96 ] )
      MsgStop( "El almacén de origen debe ser distinto al almacén de destino" )
      aGet[ 96 ]:SetFocus()
      Return nil
   end





   if nMode == 1 .AND. RetFld( aTmp[ 4 ], D():Articulos( nView ), "lNumSer" ) .AND. !( dbfTmpSer )->( dbSeek( Str( aTmp[ 63 ], 4 ) + aTmp[ 4 ] ) )

      MsgStop( "Tiene que introducir números de serie para este artículo." )

      oBtnSer:Click()

      Return .F.

   end





   cOldCodArt        := ""
   cOldUndMed        := ""
   aTmp[ 99 ]  := cTipoCtrCoste

   if nMode == 1

      if aTmp[ 59 ]
         saveLoteActual( aTmp[ 4 ], aTmp[ 61 ], nView )
      end

      if !empty( oBrwPrp:Cargo )

         for n := 1 to len( oBrwPrp:Cargo )

            for i := 1 to len( oBrwPrp:Cargo[ n ] )

               if !Empty( oBrwPrp:Cargo[ n, i ] )

                  if IsNum( oBrwPrp:Cargo[ n, i ]:Value ) .AND. oBrwPrp:Cargo[ n, i ]:Value <> 0

                     aTmp[ 63 ]     := nLastNum( dbfTmp )
                     aTmp[ 13]     := oBrwPrp:Cargo[ n, i ]:Value
                     aTmp[ 52 ]     := oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad1
                     aTmp[ 54 ]     := oBrwPrp:Cargo[ n, i ]:cValorPropiedad1
                     aTmp[ 53 ]     := oBrwPrp:Cargo[ n, i ]:cCodigoPropiedad2

                     aTmp[ 55 ]     := oBrwPrp:Cargo[ n, i ]:cValorPropiedad2

                     if oBrwPrp:Cargo[ n, i ]:nPrecioCompra <> 0
                        aTmp[ 7]  := oBrwPrp:Cargo[ n, i ]:nPrecioCompra
                     end

                     WinGather( aTmp, aGet, dbfTmp, oBrw, nMode, nil, .F. )

                  end

               end

            next

         next

         aCopy( dbBlankRec( dbfTmp ), aTmp )

         aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      else

         WinGather( aTmp, aGet, dbfTmp, oBrw, nMode )

      end

      if lEntCon()
         RecalculaTotal( aTmpFac )
         SetDlgMode( aGet, aTmp, oFld, aTmpFac, nMode, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, oBrwPrp, )
      else
         oDlg2:End( 1 )
      end

   else

      WinGather( aTmp, aGet, dbfTmp, oBrw, nMode )

      oDlg2:end( 1 )

   end

   if !empty( aGet[ 12 ] )
      aGet[ 12 ]:lValid()
   end

   if !empty( oBrwPrp )
      oBrwPrp:Cargo  := nil
   end

RETURN NIL







STATIC FUNCTION AppDeta( oBrwLin, bEdtDet, aTmp, cCodArt )









   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden modificar registros de una factura con pagos" )
      return .F.
   end

   WinAppRec( oBrwLin, bEdtDet, dbfTmp, aTmp, cCodArt )

RETURN ( RecalculaTotal( aTmp ) )







STATIC FUNCTION EdtDeta( oBrwLin, bEdtDet, aTmp, cLoop )

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden modificar registros de una factura con pagos" )
      return .F.
   end

   if !( dbfTmp )->lControl
      WinEdtRec( oBrwLin, bEdtDet, dbfTmp, aTmp )
   end

RETURN ( RecalculaTotal( aTmp ) )






STATIC FUNCTION DelDeta()

   if lRecibosPagadosTmp( dbfTmpPgo )
      MsgStop( "No se pueden eliminar registros de una factura con pagos" )
      return .F.
   end

   CursorWait()

   while ( dbfTmpSer )->( dbSeek( Str( ( dbfTmp )->nNumLin, 4 ) ) )
      ( dbfTmpSer )->( dbDelete() )
   end

   if ( dbfTmp )->lKitArt
      dbDelKit( , dbfTmp, ( dbfTmp )->nNumLin )
   end

   CursorWE()

RETURN ( .T. )



STATIC FUNCTION PrnSerie( oBrw )

    local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local cSerIni     := ( D():FacturasRectificativasProveedores( nView ) )->cSerFac
   local cSerFin     := ( D():FacturasRectificativasProveedores( nView ) )->cSerFac
   local nDocIni     := ( D():FacturasRectificativasProveedores( nView ) )->nNumFac
   local nDocFin     := ( D():FacturasRectificativasProveedores( nView ) )->nNumFac
   local cSufIni     := ( D():FacturasRectificativasProveedores( nView ) )->cSufFac
   local cSufFin     := ( D():FacturasRectificativasProveedores( nView ) )->cSufFac
   local oPrinter
   local cPrinter    := ImpresoraDefectoUsuario()
   local lCopiasPre  := .T.
   local lInvOrden   := .F.
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) )
   local oRango
   local nRango      := 1
   local dFecDesde   := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dFecHasta   := Date()

   if empty( cFmtDoc )
      cFmtDoc        := cSelPrimerDoc( "TP" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de facturas", "IMPSERIES",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



   oRango := TRadMenu():Redefine( { | u | If( PCount()==0, nRango, nRango:= u ) }, oDlg,, { 201, 202 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 210, { | u | If( PCount()==0, dFecDesde, dFecDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 220, { | u | If( PCount()==0, dFecHasta, dFecHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasPre, lCopiasPre:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasPre},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, D():Documentos( nView ) ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "TP" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "gc_document_text_pencil_12",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "gc_printer2_check_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) } )

   oDlg:bStart := { || oSerIni:SetFocus() }

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

    oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasPre, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta )

   local nCopyProvee
   local nRecno
   local nOrdAnt

   oDlg:disable()

   if nRango == 1

      nRecno      := ( D():FacturasRectificativasProveedores( nView ) )->( Recno() )
      nOrdAnt     := ( D():FacturasRectificativasProveedores( nView ) )->( OrdSetFocus( "NNUMFAC" ) )

      if !lInvOrden

         ( D():FacturasRectificativasProveedores( nView ) )->( dbSeek( cDocIni, .T. ) )


         while ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac >= cDocIni .AND.  ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac <= cDocFin

               lChgImpDoc( D():FacturasRectificativasProveedores( nView ) )

            if lCopiasPre

               nCopyProvee    := if( nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) )

               GenRctPrv( 1, "Imprimiendo documento : " + ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

            else

               GenRctPrv( 1, "Imprimiendo documento : " + ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nNumCop )

            end

         (D():FacturasRectificativasProveedores( nView ))->( dbSkip() )

         end

      else

         ( D():FacturasRectificativasProveedores( nView ) )->( dbSeek( cDocFin ) )



         while ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac >= cDocIni .AND.  ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac <= cDocFin .AND. !( D():FacturasRectificativasProveedores( nView ) )->( Bof() )

               lChgImpDoc( D():FacturasRectificativasProveedores( nView ) )

            if lCopiasPre

               nCopyProvee    := if( nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) )

               GenRctPrv( 1, "Imprimiendo documento : " + ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

            else

               GenRctPrv( 1, "Imprimiendo documento : " + ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nNumCop )

            end

         ( D():FacturasRectificativasProveedores( nView ) )->( dbSkip( -1 ) )

         end

      end

   else

      nRecno      := ( D():FacturasRectificativasProveedores( nView ) )->( Recno() )
      nOrdAnt     := ( D():FacturasRectificativasProveedores( nView ) )->( OrdSetFocus( "DFECFAC" ) )

      if !lInvOrden

         ( D():FacturasRectificativasProveedores( nView ) )->( dbGoTop() )

         while !( D():FacturasRectificativasProveedores( nView ) )->( Eof() )

            if ( D():FacturasRectificativasProveedores( nView ) )->dFecFac >= dFecDesde .AND. ( D():FacturasRectificativasProveedores( nView ) )->dFecFac <= dFecHasta

               lChgImpDoc( D():FacturasRectificativasProveedores( nView ) )

               if lCopiasPre

                  nCopyProvee    := if( nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) )

                  GenRctPrv( 1, "Imprimiendo documento : " + ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

               else

                  GenRctPrv( 1, "Imprimiendo documento : " + ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nNumCop )

               end

            end

         (D():FacturasRectificativasProveedores( nView ))->( dbSkip() )

         end

      else

         ( D():FacturasRectificativasProveedores( nView ) )->( dbSeek( cDocFin ) )

         while !( D():FacturasRectificativasProveedores( nView ) )->( Bof() )

            if ( D():FacturasRectificativasProveedores( nView ) )->dFecFac >= dFecDesde .AND. ( D():FacturasRectificativasProveedores( nView ) )->dFecFac <= dFecHasta

               lChgImpDoc( D():FacturasRectificativasProveedores( nView ) )

               if lCopiasPre

                  nCopyProvee    := if( nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) )

                  GenRctPrv( 1, "Imprimiendo documento : " + ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nCopyProvee )

               else

                  GenRctPrv( 1, "Imprimiendo documento : " + ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + (D():FacturasRectificativasProveedores( nView ))->cSufFac, cFmtDoc, cPrinter, nNumCop )

               end

            end

         ( D():FacturasRectificativasProveedores( nView ) )->( dbSkip( -1 ) )

         end

      end

   end

   ( D():FacturasRectificativasProveedores( nView ) )->( ordSetFocus( nOrdAnt ) )
   ( D():FacturasRectificativasProveedores( nView ) )->( dbGoTo( nRecNo ) )

   oDlg:Enable()

RETURN NIL







STATIC FUNCTION lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

   oTotal:cText( nTotLRctPrv( aTmp, nDinDiv, nRinDiv ) )

RETURN .T.



Static Function RecalculaTotal( aTmp )

   nTotRctPrv( nil, D():FacturasRectificativasProveedores( nView ), dbfTmp, D():TiposIva( nView ), D():Divisas( nView ), dbfTmpPgo, aTmp )

   if oBrwIva <> nil
      oBrwIva:refresh()
   end

   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPirDiv ) )
   end

   if oGetIva <> nil
      oGetIva:SetText( Trans( nTotIva, cPirDiv ) )
   end

   if oGetReq <> nil
      oGetReq:SetText( Trans( nTotReq, cPirDiv ) )
   end

   if oGetTotal <> nil
      oGetTotal:SetText( Trans( nTotFac, cPirDiv ) )
   end

   if oGetRet <> nil
      oGetRet:SetText( Trans( nTotRet, cPirDiv ) )
   end

   if oGetTotPg <> nil
      oGetTotPg:SetText( Trans( nTotFac, cPirDiv ) )
   end

   if oGetPgd <> nil
      oGetPgd:SetText( Trans( nPagFac, cPirDiv ) )
   end

   if oGetPdt <> nil
      oGetPdt:SetText( Trans( nTotFac - nPagFac, cPirDiv ) )
   end

   if oGetIvm <> nil
      oGetIvm:SetText( Trans( nTotIvm, cPirDiv ) )
   end

Return .T.



Static Function nGenRctPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local nFac

   CursorWait()

   for each nFac in ( oWndBrw:oBrw:aSelected )

      ( D():FacturasRectificativasProveedores( nView ) )->( dbGoTo( nFac ) )

      GenRctPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   next

   CursorWE()

Return ( nil )



Static Function GenRctPrv( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oDevice
   local nFactura

   if ( D():FacturasRectificativasProveedores( nView ) )->( Lastrec() ) == 0
      Return nil
   end

   nFactura             := ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac

   If( nDevice == nil, nDevice := 1, ) ;
   If( cCaption == nil, cCaption := "Imprimiendo facturas rectificativas de proveedores", ) ;
   If( cCodDoc == nil, cCodDoc := cFormatoDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ), ) ;
   If( nCopies == nil, nCopies := if( nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) == 0, Max( Retfld( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "nCopiasF" ), 1 ), nCopiasDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) ) ), ) ;

   if empty( cCodDoc )
      cCodDoc           := cFirstDoc( "TP", D():Documentos( nView ) )
   end

   if !lExisteDocumento( cCodDoc, D():Documentos( nView ) )
      return nil
   end





   if lVisualDocumento( cCodDoc, D():Documentos( nView ) )
      PrintReportRctPrv( nDevice, nCopies, cPrinter, D():Documentos( nView ) )
   else
      msgStop( "El formato ya no es soportado" )
   end

   lChgImpDoc( D():FacturasRectificativasProveedores( nView ) )

RETURN NIL



Static Function FacPrvReportSkipper()

   ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbSkip() )

   nTotPage              += nTotLRctPrv( D():FacturasRectificativasProveedoresLineas( nView ) )

Return nil



STATIC FUNCTION lMoreIva( nCodIva )





    IF aTotIva[ 1, 3 ] == NIL .OR. aTotIva[ 2, 3 ] == NIL .OR. aTotIva[ 3, 3 ] == NIL
        RETURN .T.
    end

    IF aTotIva[ 1, 3 ] == nCodIva .OR. aTotIva[ 2, 3 ] == nCodIva .OR. aTotIva[ 3, 3 ] == nCodIva
        RETURN .T.
    end

   MsgStop( "Factura con mas de 3 tipos de " + cImp(), "Imposible añadir" )

RETURN .F.



STATIC FUNCTION ChgFactu( cRctPrvT, oBrw )

   if dbLock( D():FacturasRectificativasProveedores( nView ) )
      ( D():FacturasRectificativasProveedores( nView ) )->lLiquidada := !( D():FacturasRectificativasProveedores( nView ) )->lLiquidada
      ( D():FacturasRectificativasProveedores( nView ) )->( dbUnLock() )
   end

    oBrw:refresh()

RETURN NIL



STATIC FUNCTION loaPrv( aGet, aTmp, cPrv, nMode, oSay, oTlfPrv )

   local lValid      := .F.
   local cNewCodCli  := aGet[ 6 ]:VarGet()
   local lChgCodCli  := ( empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if empty( cNewCodCli )
      Return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli := PntReplace( aGet[6], "0", RetNumCodPrvEmp() )
   else
      cNewCodCli := Rjust( cNewCodCli, "0", RetNumCodPrvEmp() )
   end

   if ( D():Proveedores( nView ) )->( dbSeek( cNewCodCli ) )

      if ( D():Proveedores( nView ) )->lBlqPrv
         msgStop( "Proveedor bloqueado, no se pueden realizar operaciones de compra" )
         return .F.
      end

      aGet[6 ]:cText( ( D():Proveedores( nView ) )->Cod )

      if empty( aGet[9]:varGet() ) .OR. lChgCodCli
         aGet[9]:cText( ( D():Proveedores( nView ) )->Titulo )
      end

      if oTlfPrv <> nil
         oTlfPrv:SetText( ( D():Proveedores( nView ) )->Telefono )
      end

      if empty( aGet[10]:varGet() ) .OR. lChgCodCli
         aGet[10]:cText( ( D():Proveedores( nView ) )->Domicilio )
      endif

      if empty( aGet[11]:varGet() ) .OR. lChgCodCli
         aGet[11]:cText( (D():Proveedores( nView ))->POBLACION )
      endif

      if empty( aGet[12]:varGet() ) .OR. lChgCodCli
         aGet[12]:cText( (D():Proveedores( nView ))->PROVINCIA )
      endif

      if empty( aGet[13]:varGet() ) .OR. lChgCodCli
         aGet[13]:cText( (D():Proveedores( nView ))->CODPOSTAL )
      endif

      if empty( aGet[14]:varGet() ) .OR. lChgCodCli
         aGet[14]:cText( (D():Proveedores( nView ))->NIF )
      endif

      if lChgCodCli
         aGet[ 28 ]:cText( ( D():Proveedores( nView ) )->cDtoEsp )
         aGet[ 29 ]:cText( ( D():Proveedores( nView ) )->nDtoEsp )
         aGet[ 30    ]:cText( ( D():Proveedores( nView ) )->cDtoPP )
         aGet[ 31    ]:cText( ( D():Proveedores( nView ) )->DtoPP )
      end

      if empty( aGet[ 23 ]:VarGet() ) .OR. lChgCodCli

         aGet[ 23 ]:cText( ( D():Proveedores( nView ) )->fPago )
         aGet[ 23 ]:lValid()





         if RetFld( aTmp[ 23 ], D():FormasPago( nView ), "lUtlBnc" )

            if dbSeekInOrd( ( D():Proveedores( nView ) )->Cod, "cCodDef", D():BancosProveedores( nView ) )

               if !empty( aGet[ 74 ] )
                  aGet[ 74 ]:cText( ( D():BancosProveedores( nView ) )->cCodBnc )
                  aGet[ 74 ]:lValid()
               end

               if !empty( aGet[ 75 ] )
                  aGet[ 75 ]:cText( ( D():BancosProveedores( nView ) )->cPaisIBAN )
                  aGet[ 75 ]:lValid()
               end

               if !empty( aGet[ 76 ] )
                  aGet[ 76 ]:cText( ( D():BancosProveedores( nView ) )->cCtrlIBAN )
                  aGet[ 76 ]:lValid()
               end

               if !empty( aGet[ 77 ] )
                  aGet[ 77 ]:cText( ( D():BancosProveedores( nView ) )->cEntBnc )
                  aGet[ 77 ]:lValid()
               end

               if !empty( aGet[ 78 ] )
                  aGet[ 78 ]:cText( ( D():BancosProveedores( nView ) )->cSucBnc )
                  aGet[ 78 ]:lValid()
               end

               if !empty( aGet[ 79 ] )
                  aGet[ 79 ]:cText( ( D():BancosProveedores( nView ) )->cDigBnc )
                  aGet[ 79 ]:lValid()
               end

               if !empty( aGet[ 80 ] )
                  aGet[ 80 ]:cText( ( D():BancosProveedores( nView ) )->cCtaBnc )
                  aGet[ 80 ]:lValid()
               end

            end

         end

      end

      if empty( aGet[ 50 ]:VarGet() ) .OR. lChgCodCli
         aGet[ 50 ]:oGet:cText(  ( D():Proveedores( nView ) )->nTipRet )
         aGet[ 50 ]:Select(      ( D():Proveedores( nView ) )->nTipRet )
      end

      if empty( aGet[ 51 ]:VarGet() ) .OR. lChgCodCli
         aGet[ 51 ]:cText( ( D():Proveedores( nView ) )->nPctRet )
      end

      if nMode == 1
         aGet[ 55 ]:nOption( Max( ( D():Proveedores( nView ) )->nRegIva, 1 ) )
         aGet[ 55 ]:Refresh()

         if empty( aTmp[ 1 ] )

            if !empty( ( D():Proveedores( nView ) )->Serie )
               aGet[ 1 ]:cText( ( D():Proveedores( nView ) )->Serie )
            end

         else

            if !empty( ( D():Proveedores( nView ) )->Serie ) .AND. aTmp[ 1 ] <> ( D():Proveedores( nView ) )->Serie .AND. ApoloMsgNoYes( "La serie del proveedor seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( D():Proveedores( nView ) )->Serie )
            end

         end

      end

      if lChgCodCli
         aTmp[ 32 ] := ( D():Proveedores( nView ) )->lReq
         aGet[ 32 ]:Refresh()
      end

      if ( D():Proveedores( nView ) )->lMosCom .AND. !empty( ( D():Proveedores( nView ) )->mComent ) .AND. lChgCodCli
         MsgStop( AllTrim( ( D():Proveedores( nView ) )->mComent ) )
      end

      cOldCodCli  := ( D():Proveedores( nView ) )->Cod
      lValid      := .T.

    ELSE

        msgStop( "Proveedor no encontrado" )

    end

RETURN lValid







STATIC FUNCTION LoaArt( cCodArt, aGet, aTmp, aTmpFac, oFld, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oBmp, oBrwPrp, oDlg, oTotal )

   local hHas128
   local cLote       := Space( 64 )
   local dFechaCaducidad
   local nIva
   local nOrdAnt
   local nPreUnt
   local nPreCom
   local cCodFam
   local cPrpArt
   local cCodPrv
   local lChgCodArt
   local lSeek       := .F.

   nIva              := 0
   cCodPrv           := aTmpFac[ 6 ]
   cPrpArt           := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]
   lChgCodArt        := ( Rtrim( cOldCodArt ) <> Rtrim( cCodArt ) .OR. Rtrim( cOldPrpArt ) <> Rtrim( cPrpArt ) )

   if empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

        aGet[ 9    ]:bWhen    := {|| .T. }

      aGet[ 6]:Hide()

      aGet[ 15 ]:Show()
      aGet[ 15 ]:SetFocus()

      if !empty( oBrwPrp )
         oBrwPrp:Hide()
      end

   else

      if lModIva()
            aGet[ 9 ]:bWhen    := {|| .T. }
      else
            aGet[ 9 ]:bWhen    := {|| .F. }
      end

        aGet[ 4    ]:show()
        aGet[ 6]:show()
        aGet[ 15 ]:hide()





      if Len( Alltrim( cCodArt ) ) > 18

         hHas128              := GetHashGs128( cCodArt )
         if !empty( hHas128 )
            cCodArt           := uGetCodigo( hHas128, "01" )
            cLote             := uGetCodigo( hHas128, "10" )
            dFechaCaducidad   := uGetCodigo( hHas128, "15" )
            if Empty( dFechaCaducidad )
               dFechaCaducidad   := uGetCodigo( hHas128, "17" )
            end
         end

      end





      if lIntelliArtciculoSearch( cCodArt, cCodPrv, D():Articulos( nView ), D():ProveedorArticulo( nView ), D():ArticulosCodigosBarras( nView ) )

         if ( lChgCodArt )

            if ( D():Articulos( nView ) )->lObs
               MsgStop( "Artículo catalogado como obsoleto" )
               return .F.
            end

            cCodArt              := ( D():Articulos( nView ) )->Codigo

            aGet[ 4 ]:cText( Padr( cCodArt, 200 ) )
            aTmp[ 4 ]        := cCodArt



            aTmp[ 97 ]     := ( D():Articulos( nView ) )->cRefAux
            aTmp[ 98 ]    := ( D():Articulos( nView ) )->cRefAux2

            if ( D():Articulos( nView ) )->lLote

               if empty( cLote )
                  cLote          := Space( 64 )
               end

               aGet[ 61   ]:Show()
               aGet[ 61   ]:cText( cLote )





               if empty( dFechaCaducidad )
                  dFechaCaducidad   := StocksModel():getFechaCaducidad( cCodArt, aTmp[ 52 ], aTmp[ 53 ], aTmp[ 54 ], aTmp[ 55 ], aTmp[ 61 ] )
               end

               aGet[ 62 ]:Show()

               if empty( aTmp[ 62 ] )
                  aGet[ 62 ]:cText( dFechaCaducidad )
               end

            else

               aGet[ 61   ]:Hide()
               aGet[ 62 ]:Hide()

            end





            cCodFam                 := ( D():Articulos( nView ) )->Familia
            if !empty( cCodFam )
               aTmp[ 79 ]     := cCodFam
               aTmp[ 80 ]     := cGruFam( cCodFam, D():Familias( nView ) )
            end





            if ( D():Articulos( nView ) )->lKitArt
               aTmp[ 65 ]     := ( D():Articulos( nView ) )->lKitArt
               aTmp[ 68 ]     := lImprimirCompuesto( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
               aTmp[ 67 ]     := lPreciosCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
               if lStockCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
                  aTmp[ 58 ]  := ( D():Articulos( nView ) )->nCtlStock
               else
                  aTmp[ 58 ]  := 3
               end
            else
               aTmp[ 68 ]     := .F.
               aTmp[ 58 ]     := ( D():Articulos( nView ) )->nCtlStock
            end



            nPreUnt                 := aGet[ 7 ]:VarGet()



            oFld:aEnable := { .T., .T., .T., .T. }
            oFld:refresh()

            aGet[ 4     ]:cText( ( D():Articulos( nView ) )->Codigo )
            aGet[ 6 ]:cText( ( D():Articulos( nView ) )->Nombre )





            if aTmpFac[ 55 ] <= 1

               nIva           := nIva( D():TiposIva( nView ), ( D():Articulos( nView ) )->TipoIva )
               aGet[ 9    ]:cText( nIva )

               aTmp[ 81 ]  := nReq( D():TiposIva( nView ), ( D():Articulos( nView ) )->TipoIva )

            end

            if ( D():Articulos( nView ) )->nCajEnt <> 0
               aGet[ 10 ]:cText( ( D():Articulos( nView ) )->nCajEnt )
            end

            if ( D():Articulos( nView ) )->nUniCaja <> 0
               aGet[ 13 ]:cText( ( D():Articulos( nView ) )->nUniCaja )
            end



            aTmp[ 92 ]  := ( D():Articulos( nView ) )->cCodImp

            oNewImp:setCodeAndValue( aTmp[ 92 ], aGet[ 93 ] )



            if ( D():Articulos( nView ) )->lMosCom .AND. !empty( ( D():Articulos( nView ) )->mComent )
               MsgStop( Trim( ( D():Articulos( nView ) )->mComent ) )
            end



            nOrdAnt                 := ( D():ProveedorArticulo( nView ) )->( OrdSetFocus( "cCodPrv" ) )

            if ( D():ProveedorArticulo( nView ) )->( dbSeek( cCodPrv + cCodArt ) )

               if !empty( aGet[ 5 ] )
                  aGet[ 5 ]:cText( ( D():ProveedorArticulo( nView ) )->cRefPrv )
               end

            else

               if !empty( aGet[ 5 ] )
                  aGet[ 5 ]:cText( Space( 20 ) )
               end

            end

            ( D():ProveedorArticulo( nView ) )->( ordSetFocus( nOrdAnt ) )





            aTmp[ 83 ]     := ( D():Articulos( nView ) )->PvpRec





            aTmp[ 52 ]     := ( D():Articulos( nView ) )->cCodPrp1
            aTmp[ 53 ]     := ( D():Articulos( nView ) )->cCodPrp2

            if ( !empty( aTmp[ 52 ] ) .OR. !empty( aTmp[ 53 ] ) ) .AND. uFieldEmpresa( "lUseTbl" )

               nPreCom           := nCosto( nil, D():Articulos( nView ), D():Kit( nView ), .F., aTmpFac[ 35 ], D():Divisas( nView ) )

               setPropertiesTable( cCodArt, aTmp[ 52 ], aTmp[ 53 ], nPreCom, aGet[ 13 ], oBrwPrp, nView )

            else

               oBrwPrp:Hide()

               if !empty( aTmp[ 52 ] )

                  if aGet[ 54 ] <> nil
                     aGet[ 54 ]:Show()
                     aGet[ 54 ]:SetFocus()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp1, D():Propiedades( nView ) ) )
                     oSayPr1:Show()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Show()
                  end

               else

                  if aGet[ 54 ] <>  nil
                     aGet[ 54 ]:Hide()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:Hide()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Hide()
                  end

               end

               if !empty( aTmp[53 ] )

                  if aGet[ 55 ] <> nil
                     aGet[ 55 ]:Show()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp2, D():Propiedades( nView ) ) )
                     oSayPr2:Show()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:Show()
                  end

               else

                  if aGet[ 55 ] <> nil
                     aGet[ 55 ]:Hide()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:Hide()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:Hide()
                  end

               end

            end





            if !empty( aGet[ 12 ] )
               aGet[ 12 ]:cText( ( D():Articulos( nView ) )->cUnidad )
               aGet[ 12 ]:lValid()
            else
               aTmp[ 12 ]  := ( D():Articulos( nView ) )->cUnidad
            end

            ValidaMedicion( aTmp, aGet)

         end

         cPrpArt                 := aTmp[ 52 ] + aTmp[ 53 ] + aTmp[ 54 ] + aTmp[ 55 ]

         if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt )





            nPreCom              := nComPro( aTmp[ 4 ], aTmp[ 52 ], aTmp[ 54 ], aTmp[ 53 ], aTmp[ 55 ], D():ArticuloPrecioPropiedades( nView ) )
            if nPrecom  <> 0

               aGet[ 7 ]:cText( nPreCom )

            else

               if uFieldEmpresa( "lCosPrv", .F. )
                  nPreCom     := nPrecioReferenciaProveedor( cCodPrv, cCodArt, D():ProveedorArticulo( nView ) )
               end

               if nPreCom <> 0
                  aGet[ 7 ]:cText( nPreCom )
               else
                  aGet[ 7 ]:cText( nCosto( nil, D():Articulos( nView ), D():Kit( nView ), .F., aTmpFac[ 35 ], D():Divisas( nView ) ) )
               end

            end

         end





         lCalcDeta( aTmp, aTmpFac, aGet, oTotal )

      else

         MsgStop( "Artículo no encontrado" )
         Return .F.

      end

   end

   cOldCodArt                    := cCodArt
   cOldPrpArt                    := cPrpArt

Return .T.



STATIC FUNCTION LoadPreCosto( aGet, oGet )

    local xValor   := aGet[4]:varGet()

    IF empty( xValor )
        RETURN .F.
    end

   if oGet == nil
      return .F.
   end

   IF ( D():Articulos( nView ) )->( dbSeek( xValor ) )
      oGet:cText( ( D():Articulos( nView ) )->pCosto )
    end

    aGet[4]:bWhen := {|| .F. }

RETURN .F.



STATIC FUNCTION LoadArtPed( aGet )

   local lValid               := .F.
   local xValor               := aGet[4]:varGet()

    IF empty( xValor )

        aGet[9]:cText( 0 )
      aGet[9]:bWhen       := {|| .T. }

        aGet[6]:cText( Space( 50 ) )
      aGet[6]:bWhen   := {|| .T. }

        RETURN .T.

    end

   if ( D():Articulos( nView ) )->( dbSeek( xValor ) )

      aGet[4    ]:cText( ( D():Articulos( nView ) )->Codigo )
      aGet[4    ]:bWhen   := {|| .T. }

      aGet[6]:cText( ( D():Articulos( nView ) )->Nombre )
      aGet[7]:cText( ( D():Articulos( nView ) )->pCosto )

      lValid                  := .T.

   else

      MsgStop( "Artículo no encontrado" )

   end

RETURN lValid



STATIC FUNCTION GetArtPrv( cRefPrv, cCodPrv, aGet )

    local nOrdAnt

   if empty( cRefPrv )

      return .T.

   else

        nOrdAnt  := ( D():ProveedorArticulo( nView ) )->( ordSetFocus( 3 ) )

      if ( D():ProveedorArticulo( nView ) )->( dbSeek( cCodPrv + cRefPrv ) )

         aGet[ 4 ]:cText( ( D():ProveedorArticulo( nView ) )->cCodArt )
            aGet[ 4 ]:lValid()

      else

         msgStop( "Referencia de proveedor no encontrada" )

      end

        ( D():ProveedorArticulo( nView ) )->( ordSetFocus( nOrdAnt ) )

   end

return .T.



STATIC FUNCTION SearchFact( oBrw )

    local oDlg
    local xToSearch
    local nNumFac    := 0
   local cCodCli  := (D():FacturasRectificativasProveedores( nView ))->CCODPRV
    local dFactura    := date()
   local nIndex   := (D():FacturasRectificativasProveedores( nView ))->(OrdNumber())

    oDlg = TDialog():New(,,,,, "FINFACPRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







        TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nNumFac, nNumFac:= u ) }, oDlg,, "999999999", {||     ( xToSearch := nNumFac, .T. )}, "N/W*",,,,, .F., {||         ( nIndex == 1 )},, .F., .F.,,,,,, nil,,, )






        TGetHlp():ReDefine( 140, { | u | If( PCount()==0, dFactura, dFactura:= u ) }, oDlg,,, {||     ( xToSearch := dFactura, .T. )}, "N/W*",,,,, .F., {||         ( nIndex == 2 )},, .F., .F.,,,,,, nil,,, )






        TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cCodCli, cCodCli:= u ) }, oDlg,,, {||    ( xToSearch := cCodCli, .T. )}, "N/W*",,,,, .F., {||         ( nIndex == 3 )},, .F., .F.,,,,,, nil,,, )




        TButton():ReDefine( 504, {||( (D():FacturasRectificativasProveedores( nView ))->( dbSeek( xToSearch ) ), oBrw:Refresh() )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 510, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN NIL



STATIC FUNCTION EPage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
    private lEnd            := oInf:lFinish





   PrintItems( cCodDoc, oInf )

RETURN NIL



STATIC FUNCTION aGetSelRec( oBrw, bAction, cTitle, lHide1, cTitle1, lHide2, cTitle2, bPreAction, bPostAction )

   local oDlg
   local oRad
   local nRad        := 1
   local aRet        := {}
   local oTree
   local oChk1
   local oChk2
   local lChk1       := .T.
   local lChk2       := .T.
   local nRecno      := ( D():FacturasRectificativasProveedores( nView ) )->( Recno() )
   local nOrdAnt     := ( D():FacturasRectificativasProveedores( nView ) )->( OrdSetFocus( 1 ) )
   local oSerIni
   local oSerFin
   local cSerIni     := ( D():FacturasRectificativasProveedores( nView ) )->cSerFac
   local cSerFin     := ( D():FacturasRectificativasProveedores( nView ) )->cSerFac
   local oDocIni
   local oDocFin
   local nDocIni     := ( D():FacturasRectificativasProveedores( nView ) )->nNumFac
   local nDocFin     := ( D():FacturasRectificativasProveedores( nView ) )->nNumFac
   local oSufIni
   local oSufFin
   local cSufIni     := ( D():FacturasRectificativasProveedores( nView ) )->cSufFac
   local cSufFin     := ( D():FacturasRectificativasProveedores( nView ) )->cSufFac
   local oMtrInf
   local nMtrInf
   local lFechas     := .T.
   local dDesde      := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dHasta      := Date()
   local oImageList
   local oBtnCancel

   If( cTitle == nil, cTitle := "", ) ;
   If( lHide1 == nil, lHide1 := .F., ) ;
   If( cTitle1 == nil, cTitle1 := "", ) ;
   If( lHide2 == nil, lHide2 := .F., ) ;
   If( cTitle2 == nil, cTitle2 := "", ) ;

   oImageList        := TImageList():New( 16, 16 )
   oImageList:AddMasked( TBitmap():Define( "gc_delete_12" ),    ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   oImageList:AddMasked( TBitmap():Define( "gc_check_12" ),  ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )

   oDlg = TDialog():New(,,,, cTitle, "SelectRango",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



   oRad := TRadMenu():Redefine( { | u | If( PCount()==0, nRad, nRad:= u ) }, oDlg,, { 80, 81 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 101, "Up16",,,,, {|Self|( dbFirst( D():FacturasRectificativasProveedores( nView ), "nNumFac", oDocIni, cSerIni, "nNumFac" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z" )},,,,,, .T., {||     ( oRad:nOption == 2 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TBtnBmp():ReDefine( 111, "Down16",,,,, {|Self|( dbLast( D():FacturasRectificativasProveedores( nView ), "nNumFac", oDocFin, cSerFin, "nNumFAc" ) )}, oDlg, .F.,, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )






   oDocIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )






   oDocFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRad == 2 )},, .F., .T.,,,,,, nil,,, )





   oSufIni := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )





   oSufFin := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRad == 2 )},, .F., .F.,,,,,, nil,,, )



   oChk1 := TCheckBox():ReDefine( 160, { | u | If( PCount()==0, lChk1, lChk1:= u ) }, oDlg,,,,,,, .F.,, .F. )



   oChk2 := TCheckBox():ReDefine( 180, { | u | If( PCount()==0, lChk2, lChk2:= u ) }, oDlg,,,,,,, .F.,, .F. )







   TCheckBox():ReDefine( 300, { | u | If( PCount()==0, lFechas, lFechas:= u ) }, oDlg,,,,,,, .F.,, .F. )





   TGetHlp():ReDefine( 310, { | u | If( PCount()==0, dDesde, dDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





    TGetHlp():ReDefine( 320, { | u | If( PCount()==0, dHasta, dHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( !lFechas )},, .F., .T.,,,,,, nil,,, )





   oTree             := TTreeView():Redefine( 170, oDlg )
   oTree:bLDblClick  := {|| TreeChanged( oTree ) }





   oMtrInf := TApoloMeter():ReDefine( 200, { | u | If( PCount()==0, nMtrInf, nMtrInf:= u ) },, oDlg, .F.,,, .T.,,,, )

   oMtrInf:SetTotal( ( D():FacturasRectificativasProveedores( nView ) )->( OrdKeyCount() ) )




   TButton():ReDefine( 1, {||( MakSelRec( bAction, bPreAction, bPostAction, cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oTree, oBrw, oMtrInf, oBtnCancel ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart := {|| StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 ) }

   oDlg:AddFastKey( 116, {|| MakSelRec( bAction, bPreAction, bPostAction, cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oTree, oBrw, oMtrInf, oBtnCancel ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oTree:SetImageList( oImageList ) )}, oDlg:bRClicked,,, )

   ( D():FacturasRectificativasProveedores( nView ) )->( ordSetFocus( nOrdAnt ) )
   ( D():FacturasRectificativasProveedores( nView ) )->( dbGoTo( nRecNo ) )

   oImageList:End()

   oTree:Destroy()

   oBrw:SetFocus()
   oBrw:Refresh()

RETURN ( aRet )



Static Function StartGetSelRec( oBrw, oRad, oChk1, oChk2, oSerIni, oSerFin, oDocIni, oDocFin, oSufIni, oSufFin, lHide1, lHide2, cTitle1, cTitle2 )

   if !empty( oBrw ) .AND. ( len( oBrw:oBrw:aSelected ) > 1 )

      oRad:SetOption( 1 )

   else

      oRad:SetOption( 2 )

      oSerIni:Enable()
      oSerFin:Enable()
      oDocIni:Enable()
      oDocFin:Enable()
      oSufIni:Enable()
      oSufFin:Enable()

   end

   if lHide1
      oChk1:Hide()
   else
      SetWindowText( oChk1:hWnd, cTitle1 )
      oChk1:Refresh()
   end

   if lHide2
      oChk2:Hide()
   else
      SetWindowText( oChk2:hWnd, cTitle2 )
      oChk2:Refresh()
   end

Return ( nil )



Static Function TreeChanged( oTree )

   local oItemTree   := oTree:GetItem()

   if !empty( oItemTree ) .AND. !empty( oItemTree:bAction )
      Eval( oItemTree:bAction )
   end

RETURN NIL



Static Function MakSelRec( bAction, bPreAction, bPostAction, cDocIni, cDocFin, nRad, lChk1, lChk2, lFechas, dDesde, dHasta, oDlg, oTree, oBrw, oMtrInf, oBtnCancel )

   local n        := 0
   local nPos     := 0
   local nRec     := ( D():FacturasRectificativasProveedores( nView ) )->( Recno() )
   local aPos
   local lRet
   local lPre
   local lWhile   := .T.





   if lChk1
      aPos        := { 0, 0 }
      ClientToScreen( oDlg:hWnd, aPos )
      oDlg:Move( aPos[ 1 ] - 26, aPos[ 2 ] - 510 )
   end





   oDlg:Disable()

   oTree:Enable()
   oTree:DeleteAll()

   oBtnCancel:bAction   := {|| lWhile := .F. }
   oBtnCancel:Enable()

   if !empty( bPreAction )
      lPre              := Eval( bPreAction )
   end

   if !IsLogic( lPre ) .OR. lPre

      if nRad == 1

         for each nPos in ( oBrw:oBrw:aSelected )

            ( D():FacturasRectificativasProveedores( nView ) )->( dbGoTo( nPos ) )

            if lFechas .OR.( ( D():FacturasRectificativasProveedores( nView ) )->dFecFac >= dDesde .AND. ( D():FacturasRectificativasProveedores( nView ) )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, D():FacturasRectificativasProveedores( nView ), D():FacturasRectificativasProveedoresLineas( nView ) )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ++n )

            SysRefresh()

            if !lWhile
               exit
            end

         next

      else

         ( D():FacturasRectificativasProveedores( nView ) )->( dbSeek( cDocIni, .T. ) )




         while ( lWhile )                                                                                      .AND.  ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac, 9 ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac >= cDocIni .AND.  ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac, 9 ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac <= cDocFin .AND.  !( D():FacturasRectificativasProveedores( nView ) )->( eof() )

            if lFechas .OR.( ( D():FacturasRectificativasProveedores( nView ) )->dFecFac >= dDesde .AND. ( D():FacturasRectificativasProveedores( nView ) )->dFecFac <= dHasta )

               lRet  := Eval( bAction, lChk1, lChk2, oTree, D():FacturasRectificativasProveedores( nView ), D():FacturasRectificativasProveedoresLineas( nView ) )

               if IsFalse( lRet )
                  exit
               end

            end

            oMtrInf:Set( ++n )

            ( D():FacturasRectificativasProveedores( nView ) )->( dbSkip() )

            SysRefresh()

         end

      end

      if !empty( bPostAction )
         Eval( bPostAction )
      end

   end

   oMtrInf:Set( ( D():FacturasRectificativasProveedores( nView ) )->( OrdKeyCount() ) )

   ( D():FacturasRectificativasProveedores( nView ) )->( dbGoTo( nRec ) )

   if lChk1
      WndCenter( oDlg:hWnd )
   end

   oBtnCancel:bAction   := {|| oDlg:End() }

   oDlg:Enable()

   if oBrw <> nil
      oBrw:Refresh()
   end

RETURN ( nil )






STATIC FUNCTION ContabilizaRectificativa( lSimula, lPago, oTree )

    local n
   local nAsiento    := 0
    local cCtaVent
    local nPosicion
    local nPosIva
    local dFecha
   local aTotFac
   local nTotFac
   local nTotRet
    local cConcepto
   local cConCompr
    local cSubCtaIva
    local cSubCtaReq
   local cRuta
   local cCodEmp
   local nImpDeta
   local nDinDiv     := nDinDiv( ( D():FacturasRectificativasProveedores( nView ) )->cDivFac, D():Divisas( nView ) )
   local nRinDiv     := nRinDiv( ( D():FacturasRectificativasProveedores( nView ) )->cDivFac, D():Divisas( nView ) )
    local aSimula        := {}
    local aIva            := {}
    local aVentas        := {}
   local cCodDiv     := ( D():FacturasRectificativasProveedores( nView ) )->cDivFac
   local cCtaPrv     := cPrvCta( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ) )
   local cCtaPrvVta  := cPrvCtaVta( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ) )
   local nFactura    := ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac
   local cFactura    := ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + "/" + Ltrim( Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) ) + "/" + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac
   local nNumFac     := ( D():FacturasRectificativasProveedores( nView ) )->nNumFac
   local cCodPro     := Left( ( D():FacturasRectificativasProveedores( nView ) )->cCodPro, 3 )
   local cClave      := Right( ( D():FacturasRectificativasProveedores( nView ) )->cCodPro, 6 )
   local lErrorFound := .F.
   local cTerNif     := ( D():FacturasRectificativasProveedores( nView ) )->cDniPrv
   local cTerNom     := ( D():FacturasRectificativasProveedores( nView ) )->cNomPrv
   local lReturn





   IF ( D():FacturasRectificativasProveedores( nView ) )->lContab
      oTree:Add( "Factura rectificativa : " + Rtrim( cFactura ) + " ya contabilizada.", 0 )
      lErrorFound    := .T.
   end

   IF !ChkRuta( cRutCnt() )
      oTree:Add( "Factura rectificativa : " + rtrim( cFactura ) + " ruta no valida.", 0 )
      lErrorFound    := .T.
   end





   cRuta             := cRutCnt()
   cCodEmp           := cCodEmpCnt( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac )

   if empty( cCtaPrvVta )
      cCtaPrvVta     := cCtaPrv()
   end

   if !ChkSubcuenta( cRutCnt(), cCodEmp, cCtaPrv, , .F., .F. )
      oTree:Add( "Factura rectificativa : " + rtrim( cFactura ) + " subcuenta " + cCtaPrv + " no encontada.", 0 )
      lErrorFound    := .T.
   end





   aTotFac           := aTotRctPrv( nFactura, D():FacturasRectificativasProveedores( nView ), D():FacturasRectificativasProveedoresLineas( nView ), D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos( nView ) )
   nTotFac           := aTotFac[ 4 ]
   nTotRet           := aTotFac[ 6 ]





   if ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbSeek( nFactura ) )

      while ( ( D():FacturasRectificativasProveedoresLineas( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedoresLineas( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedoresLineas( nView ) )->cSufFac == nFactura .AND. !( D():FacturasRectificativasProveedoresLineas( nView ) )->( eof() ) )

         nImpDeta    := nTotLRctPrv( D():FacturasRectificativasProveedoresLineas( nView ), nDinDiv, nRinDiv, ( D():FacturasRectificativasProveedores( nView ) )->nVdvFac )

         if nImpDeta <> 0

            cCtaVent    := RetCtaCom( ( D():FacturasRectificativasProveedoresLineas( nView ) )->cRef, ( nImpDeta < 0 ), D():Articulos( nView ) )
            if empty( cCtaVent )
               cCtaVent := cCtaPrvVta + RetGrpVta( ( D():FacturasRectificativasProveedoresLineas( nView ) )->cRef, cRuta, cCodEmp, ( D():FacturasRectificativasProveedoresLineas( nView ) )->nIva )
            end

            nPosicion   := aScan( aVentas, {|x| x[1] == cCtaVent } )
            if nPosicion == 0
               aadd( aVentas, { cCtaVent, nImpDeta } )
            else
               aVentas[ nPosicion, 2 ] += nImpDeta
            end





            if ( D():FacturasRectificativasProveedores( nView ) )->nRegIva == 2
               cSubCtaIva  := uFieldEmpresa( "cCtaCeeRpt" )
               cSubCtaReq  := uFieldEmpresa( "cCtaCeeSpt" )
            else
               cSubCtaIva  := cSubCuentaIva( ( D():FacturasRectificativasProveedoresLineas( nView ) )->nIva, ( D():FacturasRectificativasProveedores( nView ) )->lRecargo, cRuta, cCodEmp, D():TiposIva( nView ), .F. )
               cSubCtaReq  := cSubCuentaRecargo( ( D():FacturasRectificativasProveedoresLineas( nView ) )->nIva, ( D():FacturasRectificativasProveedores( nView ) )->lRecargo, cRuta, cCodEmp, D():TiposIva( nView ) )
            end

            nPosIva     := aScan( aIva, {|x| x[1] == ( D():FacturasRectificativasProveedoresLineas( nView ) )->nIva } )
            if nPosIva == 0
               aadd( aIva, { ( D():FacturasRectificativasProveedoresLineas( nView ) )->nIva, cSubCtaIva, cSubCtaReq, nImpDeta } )
            else
               aIva[ nPosIva, 4 ]   += nImpDeta
            end

         end

         ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbSkip() )

      end

   else

      oTree:Add( "Factura rectificativa : " + rtrim( cFactura ) + " factura sin artículos.", 0 )
      lErrorFound    := .T.

   end





   for n := 1 TO Len( aVentas )

      if ( D():FacturasRectificativasProveedores( nView ) )->nDtoEsp <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( D():FacturasRectificativasProveedores( nView ) )->nDtoEsp / 100, nRinDiv )
      end

      if ( D():FacturasRectificativasProveedores( nView ) )->nDpp <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( D():FacturasRectificativasProveedores( nView ) )->nDpp / 100, nRinDiv )
      end

      if ( D():FacturasRectificativasProveedores( nView ) )->nDtoUno <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( D():FacturasRectificativasProveedores( nView ) )->nDtoUno / 100, nRinDiv )
      end

      if ( D():FacturasRectificativasProveedores( nView ) )->nDtoDos <> 0
         aVentas[ n, 2 ] -= Round( aVentas[ n, 2 ] * ( D():FacturasRectificativasProveedores( nView ) )->nDtoDos / 100, nRinDiv )
      end

   next





   for n := 1 TO Len( aIva )

      if ( D():FacturasRectificativasProveedores( nView ) )->nDtoEsp <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( D():FacturasRectificativasProveedores( nView ) )->nDtoEsp / 100, nRinDiv )
      end

      if ( D():FacturasRectificativasProveedores( nView ) )->nDpp <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( D():FacturasRectificativasProveedores( nView ) )->nDpp / 100, nRinDiv )
      end

      if ( D():FacturasRectificativasProveedores( nView ) )->nDtoUno <> 0
         aIva[ n, 4 ] -= Round( aIva[ n, 4 ] * ( D():FacturasRectificativasProveedores( nView ) )->nDtoUno / 100, nRinDiv )
      end

      if ( D():FacturasRectificativasProveedores( nView ) )->nDtoDos <> 0
         aIva[ n, 2 ] -= Round( aIva[ n, 4 ] * ( D():FacturasRectificativasProveedores( nView ) )->nDtoDos / 100, nRinDiv )
      end

   next





   for n := 1 TO len( aVentas )

      if !ChkSubcuenta( cRutCnt(), cCodEmp, aVentas[ n, 1 ], , .F., .F. )

         oTree:Add( "Factura rectificativa : " + rtrim( cFactura ) + " subcuenta " + aVentas[ n, 1 ] + " no encontada.", 0 )
         lErrorFound    := .T.

      end

   next





   for n := 1 to len( aIva )

      if !ChkSubcuenta( cRuta, cCodEmp, aIva[ n, 2 ], , .F., .F. )
         oTree:Add( "Factura rectificativa : " + Rtrim( cFactura ) + " subcuenta " + aIva[ n, 2 ] + " no encontada.", 0 )
         lErrorFound    := .T.
      end

      if !ChkSubcuenta( cRuta, cCodEmp, aIva[ n, 3 ], , .F., .F. )
         oTree:Add( "Factura rectificativa : " + Rtrim( cFactura ) + " subcuenta " + aIva[ n, 3 ] + " no encontada.", 0 )
         lErrorFound    := .T.
      end

   next

   if nTotRet <> 0

      if !ChkSubcuenta( cRuta, cCodEmp, cCtaRet(), , .F., .F. )
         oTree:Add( "Factura rectificativa : " + Rtrim( cFactura ) + " subcuenta " + cCtaRet() + " no encontada.", 0 )
         lErrorFound    := .T.
      end

   end





   if !ChkFecha( , , ( D():FacturasRectificativasProveedores( nView ) )->dFecFac, .F., oTree )
      lErrorFound    := .T.
   end





   if lSimula .OR. !lErrorFound

      if empty( ( D():FacturasRectificativasProveedores( nView ) )->dFecEnt )
         dFecha      := ( D():FacturasRectificativasProveedores( nView ) )->dFecFac
      else
         dFecha      := ( D():FacturasRectificativasProveedores( nView ) )->dFecEnt
      end

      cConCompr      := "S/Rect."
      if !empty( ( D():FacturasRectificativasProveedores( nView ) )->cSuPed )
         nNumFac     := Val( ( D():FacturasRectificativasProveedores( nView ) )->cSuPed )
         cConCompr   += " N." + Rtrim( ( D():FacturasRectificativasProveedores( nView ) )->cSuPed )
      elseif !empty( ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc )
         cConCompr   += " Doc. " + Rtrim( ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc )
      else
         cConCompr   += " N." + Rtrim( cFactura )
      end
      cConcepto      := cConCompr + Space( 1 ) + DtoC( ( D():FacturasRectificativasProveedores( nView ) )->dFecFac )
      cConCompr      += Space( 1 ) + Rtrim( ( D():FacturasRectificativasProveedores( nView ) )->cNomPrv )





      if OpenDiario( , cCodEmp )
         nAsiento := contaplusUltimoAsiento()
      else
         oTree:Add( "Factura rectificativa : " + Rtrim( cFactura ) + " imposible abrir ficheros de contaplus.", 0 )
         return .F.
      end

























      aAdd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, cCtaPrv, , , cConcepto, nTotFac, nNumFac, , , , ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )





      for n := 1 TO len( aVentas )





















         aAdd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, aVentas[ n, 1 ], , aVentas[ n, 2 ], cConCompr, , nNumFac, , , , ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

      next

      if ( D():FacturasRectificativasProveedores( nView ) )->nRegIva == 2

      for n := 1 to len( aIva )





















         aadd( aSimula, MkAsiento(  nAsiento,  cCodDiv, dFecha,  aIva[ n, 3 ], aIva[ n, 2 ], Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), nNumFac, aIva[ n, 4 ], aIva[ n, 1 ], If( ( D():FacturasRectificativasProveedores( nView ) )->lRecargo, nPReq( D():TiposIva( nView ), aIva[ n, 1 ] ), 0 ), ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

      next

      else





      for n := 1 TO len( aIva )





















         aadd( aSimula, MkAsiento(  nAsiento,  cCodDiv, dFecha,  aIva[ n, 2 ], cCtaPrv, Round( aIva[ n, 1 ] * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, , nNumFac, aIva[ n, 4 ], aIva[ n, 1 ], If( ( D():FacturasRectificativasProveedores( nView ) )->lRecargo, nPReq( D():TiposIva( nView ), aIva[ n, 1 ] ), 0 ), ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

      next





      if ( D():FacturasRectificativasProveedores( nView ) )->lRecargo

         for n := 1 TO len( aIva )





















            aadd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, aIva[ n, 3 ], , Round( nPReq( D():TiposIva( nView ), aIva[ n, 1 ] ) * aIva[ n, 4 ] / 100, nRinDiv ), cConCompr, , nNumFac, , , , ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

         next

      end

      end





      if nTotRet <> 0





















         aadd( aSimula, MkAsiento(  nAsiento, cCodDiv, dFecha, cCtaRet(), , , cConCompr, nTotRet, nNumFac, , , , ( D():FacturasRectificativasProveedores( nView ) )->cNumDoc, cCodPro, cClave, , , , lSimula, cTerNif, cTerNom ) )

      end






      if lPago .AND. ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( nFactura ) )


         while ( ( D():FacturasProveedoresPagos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresPagos( nView ) )->nNumFac ) + ( D():FacturasProveedoresPagos( nView ) )->cSufFac == nFactura ) .AND. !( D():FacturasProveedoresPagos( nView ) )->( eof() )

            lReturn  := CntRecPrv( lSimula, oTree, nAsiento, aSimula, .T., D():FacturasRectificativasProveedores( nView ), D():FacturasProveedoresPagos( nView ), D():Proveedores( nView ), D():FormasPago( nView ), D():Divisas( nView ) )

            if IsFalse( lReturn )
               exit
            end

            ( D():FacturasProveedoresPagos( nView ) )->( dbSkip() )

         end

      end





      if !lSimula .AND. !lErrorFound

         lReturn  := ChgContabilizado( .T., cFactura, nAsiento, oTree )

      else

         lReturn  := msgTblCon( aSimula, cCodDiv, D():Divisas( nView ), !lErrorFound, cFactura, {|| aWriteAsiento( aSimula, cCodDiv, .T., oTree, cFactura, nAsiento ), ChgContabilizado( .T., cFactura, nAsiento, oTree ) } )

      end

      CloseDiario()

   end

Return ( lReturn )






STATIC FUNCTION cFacPrv( aGet, oBrw, nMode, aTmp )

   local lValid   := .F.
   local cFactura := aGet[ 26 ]:varGet()
   local nOption  := 0

   if nMode <> 1 .OR. empty( cFactura )
      return .T.
   end

   if ( D():FacturasProveedores( nView ) )->( dbSeek( cFactura ) )

      if empty( aTmp[ 6 ] )
         aGet[ 6 ]:cText( ( D():FacturasProveedores( nView ) )->cCodPrv )
         aGet[ 6 ]:lValid()
      end

      aGet[ 7 ]:cText( ( D():FacturasProveedores( nView ) )->cCodAlm )
      aGet[ 7 ]:lValid()

      aGet[ 83 ]:cText( ( D():FacturasProveedores( nView ) )->cAlmOrigen )
      aGet[ 83 ]:lValid()

      if empty( aTmp[ 8 ] )
         aGet[ 8 ]:cText( ( D():FacturasProveedores( nView ) )->cCodCaj )
         aGet[ 8 ]:lValid()
      end

      if empty( aTmp[ 23 ] )
         aGet[ 23 ]:cText( ( D():FacturasProveedores( nView ) )->cCodPago )
         aGet[ 23 ]:lValid()
      end

      if empty( aTmp[ 28 ] )
         aGet[ 28 ]:cText( ( D():FacturasProveedores( nView ) )->cDtoEsp )
      end

      if empty( aTmp[ 29 ] )
         aGet[ 29 ]:cText( ( D():FacturasProveedores( nView ) )->nDtoEsp )
      end

      if empty( aTmp[ 30 ] )
         aGet[ 30    ]:cText( ( D():FacturasProveedores( nView ) )->cDpp )
      end

      if empty( aTmp[ 31 ] )
         aGet[ 31    ]:cText( ( D():FacturasProveedores( nView ) )->nDpp )
      end

      if empty( aTmp[ 38 ] )
         aGet[ 38 ]:cText( ( D():FacturasProveedores( nView ) )->cDtoUno )
      end

      if empty( aTmp[ 39 ] )
         aGet[ 39 ]:cText( ( D():FacturasProveedores( nView ) )->nDtoUno )
      end

      if empty( aTmp[ 40 ] )
         aGet[ 40 ]:cText( ( D():FacturasProveedores( nView ) )->cDtoDos )
      end

      if empty( aTmp[ 41 ] )
         aGet[ 41 ]:cText( ( D():FacturasProveedores( nView ) )->nDtoDos )
      end

      if empty( aTmp[ 20 ] )
         aGet[ 20 ]:cText( ( D():FacturasProveedores( nView ) )->cObserv )
      end

      aGet[ 55 ]:nOption( Max( ( D():Proveedores( nView ) )->nRegIva, 1 ) )
      aGet[ 55 ]:Refresh()


      if !empty( nTipRet )
         aGet[ 50 ]:Select( ( D():FacturasProveedores( nView ) )->nTipRet )
         aGet[ 50 ]:Refresh()
      end

      if empty( aTmp[ 20 ] )
         aGet[ 51 ]:cText( ( D():FacturasProveedores( nView ) )->nPctRet )
      end

      if !empty ( ( D():FacturasProveedores( nView ) )->cCtrCoste )

         aGet[ 82 ]:cText( ( D():FacturasProveedores( nView ) )->cCtrCoste )
         aGet[ 82 ]:lValid()

     endif





      nOption           := nImportaLineas()


      if nOption >= 1                              .AND. ( D():FacturasProveedoresLineas( nView ) )->( dbSeek( cFactura ) )

         while ( ( D():FacturasProveedoresLineas( nView ) )->cSerFac + Str( ( D():FacturasProveedoresLineas( nView ) )->nNumFac ) + ( D():FacturasProveedoresLineas( nView ) )->cSufFac == cFactura )

            ( dbfTmp )->( dbAppend() )

            ( dbfTmp )->cRef        := ( D():FacturasProveedoresLineas( nView ) )->cRef
            ( dbfTmp )->cDetalle    := ( D():FacturasProveedoresLineas( nView ) )->cDetalle
            ( dbfTmp )->mLngDes     := ( D():FacturasProveedoresLineas( nView ) )->mLngDes
            ( dbfTmp )->lControl    := ( D():FacturasProveedoresLineas( nView ) )->lControl
            ( dbfTmp )->mNumSer     := ( D():FacturasProveedoresLineas( nView ) )->mNumSer
            ( dbfTmp )->nIva        := ( D():FacturasProveedoresLineas( nView ) )->nIva
            ( dbfTmp )->nReq        := ( D():FacturasProveedoresLineas( nView ) )->nReq
            ( dbfTmp )->nPreUnit    := ( D():FacturasProveedoresLineas( nView ) )->nPreUnit
            ( dbfTmp )->nUniCaja    := if( nOption == 2, ( ( D():FacturasProveedoresLineas( nView ) )->nUniCaja * -1 ), ( D():FacturasProveedoresLineas( nView ) )->nUniCaja )
            ( dbfTmp )->nCanEnt     := ( D():FacturasProveedoresLineas( nView ) )->nCanEnt
            ( dbfTmp )->nDtoLin     := ( D():FacturasProveedoresLineas( nView ) )->nDtoLin
            ( dbfTmp )->nDtoPrm     := ( D():FacturasProveedoresLineas( nView ) )->nDtoPrm
            ( dbfTmp )->nDtoRap     := ( D():FacturasProveedoresLineas( nView ) )->nDtoRap
            ( dbfTmp )->cAlmLin     := ( D():FacturasProveedoresLineas( nView ) )->cAlmLin
            ( dbfTmp )->cAlmOrigen  := ( D():FacturasProveedoresLineas( nView ) )->cAlmOrigen
            ( dbfTmp )->nNumLin     := ( D():FacturasProveedoresLineas( nView ) )->nNumLin
            ( dbfTmp )->nUndKit     := ( D():FacturasProveedoresLineas( nView ) )->nUndKit
            ( dbfTmp )->lKitChl     := ( D():FacturasProveedoresLineas( nView ) )->lKitChl
            ( dbfTmp )->lKitArt     := ( D():FacturasProveedoresLineas( nView ) )->lKitArt
            ( dbfTmp )->lKitPrc     := ( D():FacturasProveedoresLineas( nView ) )->lKitPrc
            ( dbfTmp )->cCodPr1     := ( D():FacturasProveedoresLineas( nView ) )->cCodPr1
            ( dbfTmp )->cCodPr2     := ( D():FacturasProveedoresLineas( nView ) )->cCodPr2
            ( dbfTmp )->cValPr1     := ( D():FacturasProveedoresLineas( nView ) )->cValPr1
            ( dbfTmp )->cValPr2     := ( D():FacturasProveedoresLineas( nView ) )->cValPr2
            ( dbfTmp )->lLote       := ( D():FacturasProveedoresLineas( nView ) )->lLote
            ( dbfTmp )->nLote       := ( D():FacturasProveedoresLineas( nView ) )->nLote
            ( dbfTmp )->cLote       := ( D():FacturasProveedoresLineas( nView ) )->cLote
            ( dbfTmp )->mObsLin     := ( D():FacturasProveedoresLineas( nView ) )->mObsLin
            ( dbfTmp )->cRefPrv     := ( D():FacturasProveedoresLineas( nView ) )->cRefPrv
            ( dbfTmp )->cUnidad     := ( D():FacturasProveedoresLineas( nView ) )->cUnidad
            ( dbfTmp )->nNumMed     := ( D():FacturasProveedoresLineas( nView ) )->nNumMed
            ( dbfTmp )->nMedUno     := ( D():FacturasProveedoresLineas( nView ) )->nMedUno
            ( dbfTmp )->nMedDos     := ( D():FacturasProveedoresLineas( nView ) )->nMedDos
            ( dbfTmp )->nMedTre     := ( D():FacturasProveedoresLineas( nView ) )->nMedTre
            ( dbfTmp )->dFecCad     := ( D():FacturasProveedoresLineas( nView ) )->dFecCad
            ( dbfTmp )->lGasSup     := ( D():FacturasProveedoresLineas( nView ) )->lGasSup
            ( dbfTmp )->nBultos     := ( D():FacturasProveedoresLineas( nView ) )->nBultos
            ( dbfTmp )->cFormato    := ( D():FacturasProveedoresLineas( nView ) )->cFormato
            ( dbfTmp )->cCodImp     := ( D():FacturasProveedoresLineas( nView ) )->cCodImp
            ( dbfTmp )->nValImp     := ( D():FacturasProveedoresLineas( nView ) )->nValImp
            ( dbfTmp )->dFecFac     := ( D():FacturasProveedoresLineas( nView ) )->dFecFac
            ( dbfTmp )->tFecFac     := ( D():FacturasProveedoresLineas( nView ) )->tFecFac
            ( dbfTmp )->cCtrCoste   := ( D():FacturasProveedoresLineas( nView ) )->cCtrCoste
            ( dbfTmp )->cCodFam     := ( D():FacturasProveedoresLineas( nView ) )->cCodFam
            ( dbfTmp )->cRefAux     := ( D():FacturasProveedoresLineas( nView ) )->cRefAux
            ( dbfTmp )->cRefAux2    := ( D():FacturasProveedoresLineas( nView ) )->cRefAux2
            ( dbfTmp )->cCtrCoste   := ( D():FacturasProveedoresLineas( nView ) )->cCtrCoste
            ( dbfTmp )->cTipCtr     := ( D():FacturasProveedoresLineas( nView ) )->cTipCtr
            ( dbfTmp )->cTerCtr     := ( D():FacturasProveedoresLineas( nView ) )->cTerCtr

            ( D():FacturasProveedoresLineas( nView ) )->( dbSkip() )

         end

         ( dbfTmp )->( dbGoTop() )

         oBrw:Refresh()

      end

      aGet[ 26 ]:bWhen     := {|| .F. }

   end

   nTotRctPrv( nil, D():FacturasRectificativasProveedores( nView ), dbfTmp, D():TiposIva( nView ), D():Divisas( nView ), D():FacturasProveedoresPagos( nView ), aTmp )

RETURN ( .T. )



STATIC FUNCTION BeginTrans( aTmp, nMode )

   local oError
   local oBlock
   local lErrors     := .F.
   local cDbf        := "FPrvL"
   local cDbfInc     := "FPrvI"
   local cDbfDoc     := "FPrvD"
   local cDbfPgo     := "FPrvP"
   local cDbfSer     := "FPrvS"
   local nFactura    := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      aNumAlb        := {}

      cNewFile       := cGetNewFileName( cPatTmp() + cDbf )
      cTmpInc        := cGetNewFileName( cPatTmp() + cDbfInc )
      cTmpDoc        := cGetNewFileName( cPatTmp() + cDbfDoc )
      cTmpPgo        := cGetNewFileName( cPatTmp() + cDbfPgo )
      cTmpSer        := cGetNewFileName( cPatTmp() + cDbfSer )





      dbCreate( cNewFile, aSqlStruct( aColRctPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFile, cCheckArea( cDbf, @dbfTmp ), .F. )

      if !( dbfTmp )->( neterr() )

         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

         ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmp )->( OrdCreate( cNewFile, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )

      end





      if ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbSeek( nFactura ) )

         while ( ( D():FacturasRectificativasProveedoresLineas( nView ) )->CSERFAC + Str( ( D():FacturasRectificativasProveedoresLineas( nView ) )->NNUMFAC ) + ( D():FacturasRectificativasProveedoresLineas( nView ) )->CSUFFAC == nFactura .AND. !( D():FacturasRectificativasProveedoresLineas( nView ) )->( eof() ) )

            dbPass( D():FacturasRectificativasProveedoresLineas( nView ), dbfTmp, .T. )
            ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbSkip() )

         end

      end

      ( dbfTmp )->( dbGoTop() )





      dbCreate( cTmpInc, aSqlStruct( aIncRctPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )
      if !( dbfTmpInc )->( neterr() )
         ( dbfTmpInc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpInc )->( ordCreate( cTmpInc, "Recno", "Recno()", {|| Recno() } ) )
      end





      if ( nMode <> 4 ) .AND. ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( dbSeek( nFactura ) )

         while ( ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->cSufFac == nFactura ) .AND. ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( !eof() )

            dbPass( D():FacturasRectificativasProveedoresIncidencias( nView ), dbfTmpInc, .T. )
            ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( dbSkip() )

         end

      end

      ( dbfTmpInc )->( dbGoTop() )





      dbCreate( cTmpDoc, aSqlStruct( aFacPrvDoc() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )
      if !( dbfTmpDoc )->( neterr() )
         ( dbfTmpDoc )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpDoc )->( ordCreate( cTmpDoc, "Recno", "Recno()", {|| Recno() } ) )
      end





      if ( nMode <> 4 ) .AND. ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( dbSeek( nFactura ) )
         while ( ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->cSufFac == nFactura ) .AND. ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( !eof() )
            dbPass( D():FacturasRectificativasProveedoresDocumentos( nView ), dbfTmpDoc, .T. )
            ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpDoc )->( dbGoTop() )





      dbCreate( cTmpSer, aSqlStruct( aSerRctPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpSer, cCheckArea( cDbf, @dbfTmpSer ), .F. )

      if !( dbfTmpSer )->( neterr() )
         ( dbfTmpSer )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpSer )->( OrdCreate( cTmpSer, "nNumLin", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin, 4 ) + Field->cRef } ) )
      end





      if ( nMode <> 4 ) .AND. ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( dbSeek( nFactura ) )
         while ( ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->cSufFac == nFactura .AND. !( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( eof() ) )
            dbPass( D():FacturasRectificativasProveedoresDocumentos( nView ), dbfTmpSer, .T. )
            ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( dbSkip() )
         end
      end

      ( dbfTmpSer )->( dbGoTop() )





      dbCreate( cTmpPgo, aSqlStruct( aItmRecPrv() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cTmpPgo, cCheckArea( cDbfPgo, @dbfTmpPgo ), .F. )
      if !( dbfTmpPgo )->( neterr() )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted() .and. !empty( cTipRec )", {|| !Deleted() .AND. !empty( Field->cTipRec ) } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "rNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumRec )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumRec ) }, ) )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "cRecDev", "CRECDEV", {|| Field->CRECDEV } ) )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumRec )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumRec ) }, ) )

         ( dbfTmpPgo )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpPgo )->( ordCreate( cTmpPgo, "Recno", "Recno()", {|| Recno() } ) )

      end





      if ( nMode <> 4 ) .AND. ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( nFactura ) ) .AND. nMode <> 4

         while ( ( D():FacturasProveedoresPagos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresPagos( nView ) )->nNumFac ) + ( D():FacturasProveedoresPagos( nView ) )->cSufFac == nFactura ) .AND. ( D():FacturasProveedoresPagos( nView ) )->( !eof() )

            dbPass( D():FacturasProveedoresPagos( nView ), dbfTmpPgo, .T. )

            ( D():FacturasProveedoresPagos( nView ) )->( dbSkip() )

         end

      end

      ( dbfTmpPgo )->( dbGoTop() )

   oDetCamposExtra:SetTemporal( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "", nMode )

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

RETURN ( lErrors )



STATIC FUNCTION EndTrans( aTmp, aGet, oBrw, oBrwLin, nMode, nDec, oDlg, oFld )

   local aTbl
   local nItem
   local nNumLin
   local cSerFac
   local nNumFac
   local cSufFac
   local oError
   local oBlock

   if empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   nNumLin              := 1
   cSerFac              := aTmp[ 1 ]
   nNumFac              := aTmp[ 2 ]
   cSufFac              := aTmp[ 3 ]

   if !lValidaOperacion( aTmp[ 5 ] )
      Return .F.
   end

   if !lValidaSerie( aTmp[ 1 ] )
      Return .F.
   end

   if empty( aTmp[ 6 ] )
      msgStop( "Proveedor no puede estar vacío." )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 7 ] )
      msgStop( "Almacen no puede estar vacío." )
      aGet[ 7 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 8 ] )
      msgStop( "Caja no puede estar vacía." )
      aGet[ 8 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 23 ] )
      msgStop( "Forma de pago no puede estar vacía." )
      aGet[ 23 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 26 ] )
      msgStop( "Número de factura no puede estar vacia." )
      aGet[ 26 ]:SetFocus()
      return .F.
   end

   if !aTmp[ 56 ] .AND. ( dbfTmp )->( lastrec() ) == 0
      MsgStop( "No puede almacenar un documento sin líneas." )
      return .F.
   end

   if empty( aTmp[ 67 ] )
      MsgStop( "Debe indicar un motivo para la factura rectificativa." )
      oFld:SetOption( 2 )
      aGet[ 67 ]:SetFocus()
      return .F.
   end

   if empty( aTmp[ 68 ] )
      MsgStop( "Debe indicar una causa por la que se emite la factura rectificativa." )
      oFld:SetOption( 2 )
      aGet[ 68 ]:SetFocus()
      return .F.
   end





   CursorWait()

   oDlg:Disable()

   oMsgText( "Archivando" )

   TComercio:resetProductsToUpdateStocks()

   oBlock      := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   aTmp[ 52 ]  := GetSysDate()
   aTmp[ 53 ]  := Time()

   do case
   case isAppendOrDuplicateMode( nMode )



      nNumFac           := nNewDoc( cSerFac, D():FacturasRectificativasProveedores( nView ), "nRctPrv", , D():Contadores( nView ) )
      aTmp[ 2 ]  := nNumFac
      cSufFac           := retSufEmp()
      aTmp[ 3 ]  := cSufFac

   case isEditMode( nMode )

      while ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) .AND. !( D():FacturasRectificativasProveedoresLineas( nView ) )->( eof() ) )

         TComercio:appendProductsToUpadateStocks( ( D():FacturasRectificativasProveedoresLineas( nView ) )->cRef, nView )

         if dbLock( D():FacturasRectificativasProveedoresLineas( nView ) )
            ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbDelete() )
            ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbUnLock() )
         end

      end

      while ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) .AND. !( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( eof() ) )
         if dbLock( D():FacturasRectificativasProveedoresIncidencias( nView ) )
            ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( dbDelete() )
            ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( dbUnLock() )
         end
      end

      while ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) .AND. !( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( eof() ) )
         if dbLock( D():FacturasRectificativasProveedoresDocumentos( nView ) )
            ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( dbDelete() )
            ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( dbUnLock() )
         end
      end

      while ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( cSerFac + str( nNumFac ) + cSufFac ) .AND. !( D():FacturasProveedoresPagos( nView ) )->( eof() ) )
         if dbLock( D():FacturasProveedoresPagos( nView ) )
            ( D():FacturasProveedoresPagos( nView ) )->( dbDelete() )
            ( D():FacturasProveedoresPagos( nView ) )->( dbUnLock() )
         end
      end

      while ( D():FacturasRectificativasProveedoresSeries( nView ) )->( dbSeek( cSerFac + Str( nNumFac ) + cSufFac ) )
         if dbLock( D():FacturasRectificativasProveedoresSeries( nView ) )
            ( D():FacturasRectificativasProveedoresSeries( nView ) )->( dbDelete() )
            ( D():FacturasRectificativasProveedoresSeries( nView ) )->( dbUnLock() )
         end
      end

   end





   ( dbfTmp )->( dbClearFilter() )

   oMsgProgress()
   oMsgProgress():SetRange( 0, ( dbfTmp )->( LastRec() ) )





   ( dbfTmp )->( dbGoTop() )
   while !( dbfTmp )->( eof() )

      aTbl               := dbScatter( dbfTmp )
      aTbl[ 1 ]   := cSerFac
      aTbl[ 2 ]   := nNumFac
      aTbl[ 3 ]   := cSufFac
      aTbl[ 89 ]  := aTmp[ 5 ]
      aTbl[ 94 ]  := aTmp[ 81 ]

      dbGather( aTbl, D():FacturasRectificativasProveedoresLineas( nView ), .T. )

      TComercio:appendProductsToUpadateStocks( ( dbfTmp )->cRef, nView )

      ( dbfTmp )->( dbSkip() )

      oMsgProgress():Deltapos( 1 )

   end





   ( dbfTmpInc )->( dbGoTop() )
   while ( dbfTmpInc )->( !eof() )
      dbPass( dbfTmpInc, D():FacturasRectificativasProveedoresIncidencias( nView ), .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpInc )->( dbSkip() )
   end





   ( dbfTmpDoc )->( dbGoTop() )
   while ( dbfTmpDoc )->( !eof() )
      dbPass( dbfTmpDoc, D():FacturasRectificativasProveedoresDocumentos( nView ), .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpDoc )->( dbSkip() )
   end





   ( dbfTmpSer )->( dbGoTop() )
   while ( dbfTmpSer )->( !eof() )
      dbPass( dbfTmpSer, D():FacturasRectificativasProveedoresSeries( nView ), .T., cSerFac, nNumFac, cSufFac )
      ( dbfTmpSer )->( dbSkip() )
   end





   ( dbfTmpPgo )->( dbGoTop() )

   while ( dbfTmpPgo )->( !eof() )

      if ( dbfTmpPgo )->cCodPrv <> aTmp[ 6 ]
         ( dbfTmpPgo )->cCodPrv := aTmp[ 6 ]
      end

      if ( dbfTmpPgo )->cNomPrv <> aTmp[ 9 ]
         ( dbfTmpPgo )->cNomPrv := aTmp[ 9 ]
      end

      ( dbfTmpPgo )->( dbSkip() )

   end





   ( dbfTmpPgo )->( dbGoTop() )
   while ( dbfTmpPgo )->( !eof() )

      if !empty( aTmp[ 82 ] )
         ( dbfTmpPgo )->cCtrCoste := aTmp[ 82 ]
      endif

      dbPass( dbfTmpPgo, D():FacturasProveedoresPagos( nView ), .T., cSerFac, nNumFac, cSufFac )

      ( dbfTmpPgo )->( dbSkip() )

   end





   aTmp[ 69 ]   := nTotNet
   aTmp[ 73 ]   := nTotSup
   aTmp[ 70 ]   := nTotIva
   aTmp[ 71 ]   := nTotReq
   aTmp[ 72 ]   := nTotFac





   oDetCamposExtra:saveExtraField( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "" )





   WinGather( aTmp, , D():FacturasRectificativasProveedores( nView ), , nMode )





   GenPgoRctPrv( cSerFac + Str( nNumFac ) + cSufFac, D():FacturasRectificativasProveedores( nView ), D():FacturasRectificativasProveedoresLineas( nView ), D():FacturasProveedoresPagos( nView ), D():Proveedores( nView ),D():TiposIva( nView ), D():FormasPago( nView ), D():Divisas( nView ) )





   dbCommitAll()



   RECOVER USING oError

      RollBackTransaction()
      msgStop( "Imposible almacenar documentos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   oMsgText()
   EndProgress()



   TComercio:updateWebProductStocks()

   oDlg:Enable()
   oDlg:End( 1 )

   CursorWE()

RETURN .T.



STATIC FUNCTION KillTrans( oBrwLin )





   if !empty( dbfTmp ) .AND. ( dbfTmp )->( Used() )
      ( dbfTmp )->( dbCloseArea() )
   end

   if !empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !empty( dbfTmpPgo ) .AND. ( dbfTmpPgo )->( Used() )
      ( dbfTmpPgo )->( dbCloseArea() )
   end

   if !empty( dbfTmpSer ) .AND. ( dbfTmpSer )->( Used() )
      ( dbfTmpSer )->( dbCloseArea() )
   end

   dbfTmp            := nil
   dbfTmpInc         := nil
   dbfTmpDoc         := nil
   dbfTmpPgo         := nil
   dbfTmpSer         := nil

   dbfErase( cNewFile )
   dbfErase( cTmpInc  )
   dbfErase( cTmpDoc  )
   dbfErase( cTmpPgo  )
   dbfErase( cTmpSer  )

   if !empty( oMnuRec )
      oMnuRec:End()
   end

   memory( -1 )

   if oBrwLin <> nil
      oBrwLin:CloseData()
   end

RETURN NIL



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "RctPrvT.DBF", cLocalDriver() )
      dbCreate( cPath + "RctPrvT.DBF", aSqlStruct( aItmRctPrv() ), cLocalDriver() )
   end
   if !lExistTable( cPath + "RctPrvL.DBF", cLocalDriver() )
      dbCreate( cPath + "RctPrvL.DBF", aSqlStruct( aColRctPrv() ), cLocalDriver() )
   end
   if !lExistTable( cPath + "RctPrvI.DBF", cLocalDriver() )
      dbCreate( cPath + "RctPrvI.DBF", aSqlStruct( aIncRctPrv() ), cLocalDriver() )
   end
   if !lExistTable( cPath + "RctPrvD.DBF", cLocalDriver() )
      dbCreate( cPath + "RctPrvD.DBF", aSqlStruct( aFacPrvDoc() ), cLocalDriver() )
   end
   if !lExistTable( cPath + "RctPrvS.Dbf", cLocalDriver() )
      dbCreate( cPath + "RctPrvS.Dbf", aSqlStruct( aSerRctPrv() ), cLocalDriver() )
   end

RETURN NIL







STATIC FUNCTION ChgContabilizado( lContabilizado, cFactura, nAsiento, oTree )

   if dbDialogLock( D():FacturasRectificativasProveedores( nView ) )
      ( D():FacturasRectificativasProveedores( nView ) )->lContab := lContabilizado
      ( D():FacturasRectificativasProveedores( nView ) )->( dbUnlock() )
   end

   if !empty( oTree )
      oTree:Add( "Factura rectificativa : " + Rtrim( cFactura ) + " asiento generado num. " + Alltrim( Str( nAsiento ) ), 1 )
   end

RETURN NIL



STATIC FUNCTION ImpFactura( oBrw, aGet, aTmp )

    local oDlg
    local oBrwFac
    local oGetDes
    local cGetDes
    local cSelFac    := ""
    local aLinFac    := {}

    local nChgDiv    := aTmp[ 36 ]

    IF empty( aGet[ 6 ]:varGet() )
        msgStop( "Es necesario codificar un proveedor" )
        RETURN .T.
    end

    oDlg = TDialog():New(,,,,, "IMPFACPRV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )







        oGetDes := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cGetDes, cGetDes:= u ) }, oDlg,,, {||        ( loadFac( cGetDes, oBrwFac, @aLinFac ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( oGetDes:cText( cGetFile( "*.dat", "Seleccione el fichero de la factura" ) ) )}, nil, "LUPA",, )





        oBrwFac := TListBox():ReDefine( 120, { | u | If( PCount()==0, cSelFac, cSelFac:= u ) }, {},, oDlg,,,,,,,,, .F.,, )





        TButton():ReDefine( 1, {||(  appdFac( aGet, cSelFac, oBrwFac:aItems, aLinFac, nChgDiv ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

        oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN NIL







STATIC FUNCTION loadFac( cGetDes, oBrwFac, aLinFac )

    local    a1
    local a2
   local cIni
    local cSep
    local oText
    local nCont        := 0

    IF empty( cGetDes )
        RETURN .T.
    end

    CursorWait()

    IF    file( cGetDes )

        oText             := TTxtFile():New( cGetDes )
        oText:Open()





        aLinFac            := {}
        oBrwFac:reset()





        WHILE !oText:lEof()

            a1    := oText:cGetStr( 6 )
                    oText:cGetStr( 1 )
            a2    := oText:cGetStr( 6 )
                    oText:cGetStr( 1 )

            ++nCont
            aadd( aLinFac, {} )

            oBrwFac:Add( a1 + space( 1 ) + substr( a2, 1, 2 ) + "/" + substr( a2, 3, 2 ) + "/" + substr( a2, 5, 2 ) )

            WHILE !oText:lEof()





                cIni    := oText:cGetStr( 1 )

                IF cIni == chr( 255 )
                    EXIT
                end











                aadd( aLinFac[ nCont ], {  cIni + oText:cGetStr( 5 ), oText:cGetStr( 13 ),    oText:cGetStr( 30 ),    oText:cGetStr(  7 ),    oText:cGetStr(  7 ), oText:cGetStr(  1 ) } )





                cSep    := oText:cGetStr( 1 )

                IF cSep == chr( 254 )
                    LOOP
                end

            end

        end

      oText:Close()

    ELSE

        msgStop( "Fichero no encontrado" )

    end

    oBrwFac:setFocus()

    CursorWe()

RETURN .T.







STATIC FUNCTION appdFac( aGet, cSelFac, aSelFac, aLinFac, nChgDiv )

   local n
    local nIva


    local nSelFac := AScan( aSelFac, { | cItem | Upper( AllTrim( cItem ) ) ==  Upper( AllTrim( cSelFac ) ) } )

    IF nSelFac    <> 0

        aGet[18]:cText( substr( cSelFac, 1, 6 ) )

        FOR n := 1 TO len( aLinFac[ nSelFac ] )

            (dbfTmp)->( dbAppend() )

            (dbfTmp)->CREF            := aLinFac[ nSelFac, n, 1 ]
            (dbfTmp)->CDETALLE     := aLinFac[ nSelFac, n, 3 ]
            (dbfTmp)->NUNICAJA    := val( aLinFac[ nSelFac, n, 4 ] ) / 100
            (dbfTmp)->NPREUNIT     := val( aLinFac[ nSelFac, n, 5 ] ) / 100





            DO CASE
            CASE aLinFac[ nSelFac, n, 6 ] == "1"
                nIva    := 7
            CASE aLinFac[ nSelFac, n, 6 ] == "2"
                nIva    := 16
            CASE aLinFac[ nSelFac, n, 6 ] == "3"
                nIva    := 4
            end

            (dbfTmp)->NIVA            := nIva

        NEXT

        (dbfTmp)->( dbGoTop() )

    end

RETURN NIL



static function lNotOpen()

   if NetErr()
      msgStop( "Imposible abrir ficheros." )
      CloseFiles()
      return .T.
   end

return .F.







Static Function lRecibosPagados( uFacPrv, cRctPrvP )

   local cNumFac
   local nRecAct
   local nOrdAct
   local lRecPgd      := .F.

   If( cRctPrvP == nil, cRctPrvP := D():FacturasProveedoresPagos( nView ), ) ;

   nRecAct              := ( cRctPrvP )->( Recno() )
   nOrdAct              := ( cRctPrvP )->( OrdSetFocus( "NNUMFAC" ) )

   if ValType( uFacPrv ) == "A"
      cNumFac         := uFacPrv[ 1 ] + Str( uFacPrv[ 2 ], 9 ) + uFacPrv[ 3 ]
   else
      cNumFac         := ( uFacPrv )->CSERFAC + Str( ( uFacPrv )->NNUMFAC ) + ( uFacPrv )->CSUFFAC
   end

   if ( cRctPrvP )->( dbSeek( cNumFac ) )
      while cNumFac == ( cRctPrvP )->cSerFac + Str( ( cRctPrvP )->nNumFac ) + ( cRctPrvP )->cSufFac .AND. !( cRctPrvP )->( eof() )
         if ( cRctPrvP )->lCobrado .AND. !( cRctPrvP )->lDevuelto
            lRecPgd  := .T.
            exit
         end
         ( cRctPrvP )->( dbSkip() )
      end
   end

   ( cRctPrvP )->( OrdSetFocus( nOrdAct ) )
   ( cRctPrvP )->( dbGoTo( nRecAct) )

return ( lRecPgd )



static function lGenFac( oBrw, oBtn, nDevice )

   local bAction

   If( nDevice == nil, nDevice := 1, ) ;

   if empty( oBtn )
      return nil
   end

   IF !( D():Documentos( nView ) )->( dbSeek( "TP" ) )








         oWndBrw:NewAt( "GC_DOCUMENT_WHITE_",,, {||( msgStop( "No hay facturas de proveedores predefinidos" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   ELSE

      WHILE ( D():Documentos( nView ) )->cTipo == "TP" .AND. !( D():Documentos( nView ) )->( eof() )

         bAction  := bGenFac( nDevice, "Imprimiendo facturas de proveedores", ( D():Documentos( nView ) )->CODIGO )

         oWndBrw:NewAt( "gc_document_white_", , , bAction, Rtrim( ( D():Documentos( nView ) )->cDescrip ) , , , , , oBtn )

         ( D():Documentos( nView ) )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenFac( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle  )
   local cCod  := by( cCodDoc )

   if nDev == 1
      bGen     := {|| nGenRctPrv( nDevice, cTit, cCod ) }
   else
      bGen     := {|| nGenRctPrv( nDevice, cTit, cCod ) }
   end

return bGen



static function QuiRctPrv()

   if ( D():FacturasRectificativasProveedores( nView ) )->lCloFac .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar facturas cerradas los administradores." )
      Return .F.
   end

   CursorWait()

   DeleteRelacionRectificativasProveedores()

   if uFieldEmpresa( "lRecNumFac" )
      nPutDoc( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, ( D():FacturasRectificativasProveedores( nView ) )->nNumFac, ( D():FacturasRectificativasProveedores( nView ) )->cSufFac, D():FacturasRectificativasProveedores( nView ), "nRctPrv", , D():Contadores( nView ) )
   end

   CursorWE()

Return .T.



STATIC FUNCTION DeleteRelacionRectificativasProveedores( cFactura )

   local nOrdAnt

   If( cFactura == nil, cFactura := D():FacturasRectificativasProveedoresId( nView ), ) ;

   CursorWait()





   TComercio:resetProductsToUpdateStocks()

   while ( D():FacturasRectificativasProveedoresLineas( nView ) )->( dbSeek( cFactura ) ) .AND. !( D():FacturasRectificativasProveedoresLineas( nView ) )->( eof() )

      TComercio:appendProductsToUpadateStocks( ( D():FacturasRectificativasProveedoresLineas( nView ) )->cRef, nView )

      dbLockDelete( D():FacturasRectificativasProveedoresLineas( nView ) )

   end





   while ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( cFactura ) ) .AND. !( D():FacturasProveedoresPagos( nView ) )->( eof() )
      dbLockDelete( D():FacturasProveedoresPagos( nView ) )
   end

   while ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( dbSeek( cFactura ) .AND. !( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( eof() ) )
      dbLockDelete( D():FacturasRectificativasProveedoresIncidencias( nView ) )
   end

   while ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( dbSeek( cFactura ) .AND. !( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( eof() ) )
      dbLockDelete( D():FacturasRectificativasProveedoresDocumentos( nView ) )
   end

   while ( D():FacturasRectificativasProveedoresSeries( nView ) )->( dbSeek( cFactura ) .AND. !( D():FacturasRectificativasProveedoresSeries( nView ) )->( eof() ) )
      dbLockDelete( D():FacturasRectificativasProveedoresSeries( nView ) )
   end



   TComercio:updateWebProductStocks()

   CursorWe()

Return .T.



Static Function lLiquida( oBrw, cFactura, cDivFac )

   If( cFactura == nil, cFactura := D():FacturasRectificativasProveedoresId( nView ), ) ;
   If( cDivFac == nil, cDivFac := ( D():FacturasRectificativasProveedores( nView ) )->cDivFac, ) ;

   if ( D():FacturasRectificativasProveedores( nView ) )->lLiquidada
      MsgStop( "Factura ya pagada" )
      return .F.
   end





   ( D():FacturasProveedoresPagos( nView ) )->( dbGoTop() )

   if ( D():FacturasProveedoresPagos( nView ) )->( dbSeek( cFactura ) )

      while ( D():FacturasProveedoresPagos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresPagos( nView ) )->nNumFac ) + ( D():FacturasProveedoresPagos( nView ) )->cSufFac == cFactura .AND. !( D():FacturasProveedoresPagos( nView ) )->( eof() )

         if !empty( ( D():FacturasProveedoresPagos( nView ) )->cTipRec ) .AND. !( D():FacturasProveedoresPagos( nView ) )->lCobrado

            EdtRecPrv( ( D():FacturasProveedoresPagos( nView ) )->cSerFac + Str( ( D():FacturasProveedoresPagos( nView ) )->nNumFac ) + ( D():FacturasProveedoresPagos( nView ) )->cSufFac, .F. )

            exit

         end

         ( D():FacturasProveedoresPagos( nView ) )->( dbSkip() )

      end





      ChkLqdRctPrv( nil, D():FacturasRectificativasProveedores( nView ), D():FacturasRectificativasProveedoresLineas( nView ), D():FacturasProveedoresPagos( nView ), D():TiposIva( nView ), D():Divisas( nView ) )

   end

   oBrw:Refresh()
   oBrw:SetFocus()

Return .T.



Static Function nEstadoIncidencia( cNumFac )

   local nEstado  := 0

   if ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( dbSeek( cNumFac ) )

      while ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->cSufFac == cNumFac .AND. !( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( Eof() )

         if ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( dbSkip() )

      end

   end

Return ( nEstado )



Static Function lRecibosPagadosTmp( dbfTmpPgo )

   local lRecPgd  := .F.
   local nRecAct  := ( dbfTmpPgo )->( Recno() )

   while !( dbfTmpPgo )->( eof() )
      if ( dbfTmpPgo )->lCobrado .AND. !( dbfTmpPgo )->lDevuelto
         lRecPgd  := .T.
         exit
      end
      ( dbfTmpPgo )->( dbSkip() )
   end

   ( dbfTmpPgo )->( dbGoTo( nRecAct) )

return ( lRecPgd )



static function ShowKitRctPrv( dbfMaster, oBrw, cCodPrv, dbfTmpInc, aGet, aTmp, aControl, oSayGas, oSayLabels, oBrwIva )

   if !empty( aGet )

      if ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) )
         aGet[ ( dbfMaster )->( FieldPos( "lRecargo" ) ) ]:HardEnable()
      else
         aGet[ ( dbfMaster )->( FieldPos( "lRecargo" ) ) ]:HardDisable()
      end

      if !empty( cCodPrv )
         aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:cText( cCodPrv )
         aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:lValid()
      end

      aGet[ ( dbfMaster )->( FieldPos( "cCodPrv" ) ) ]:SetFocus()

      if !empty( aTmp ) .AND. aTmp[ 56 ]

         oBrw:Hide()
         oBrwIva:Hide()
         aEval( aControl, {| o | o:Hide() } )
         oSayLabels[1]:Hide()
         oSayLabels[2]:Hide()
         oSayLabels[3]:Hide()
         oSayLabels[4]:Hide()
         oSayLabels[5]:Hide()
         aGet[ 28 ]:Hide()
         aGet[ 30    ]:Hide()
         aGet[ 29 ]:Hide()
         aGet[ 31    ]:Hide()
         aGet[ 38 ]:Hide()
         aGet[ 39 ]:Hide()
         aGet[ 40 ]:Hide()
         aGet[ 41 ]:Hide()

         aEval( oSayGas, {| o | o:Show() } )
         aGet[ 57  ]:Show()
         aGet[ 58 ]:Show()
         aGet[ 59 ]:Show()
         aGet[ 60 ]:Show()
         aGet[ 61 ]:Show()
         aGet[ 62 ]:Show()
         aGet[ 63 ]:Show()
         aGet[ 64  ]:Show()
         aGet[ 65  ]:Show()
         aGet[ 66  ]:Show()

      else

         oBrw:Show()
         oBrwIva:Show()
         aEval( aControl, {| o | o:Show() } )
         oSayLabels[1]:Show()
         oSayLabels[2]:Show()
         oSayLabels[3]:Show()
         oSayLabels[4]:Show()
         oSayLabels[5]:Show()
         aGet[ 28 ]:Show()
         aGet[ 30    ]:Show()
         aGet[ 29 ]:Show()
         aGet[ 31    ]:Show()
         aGet[ 38 ]:Show()
         aGet[ 39 ]:Show()
         aGet[ 40 ]:Show()
         aGet[ 41 ]:Show()

         aEval( oSayGas, {| o | o:Hide() } )
         aGet[ 57  ]:Hide()
         aGet[ 57  ]:Hide()
         aGet[ 58 ]:Hide()
         aGet[ 59 ]:Hide()
         aGet[ 60 ]:Hide()
         aGet[ 61 ]:Hide()
         aGet[ 62 ]:Hide()
         aGet[ 63 ]:Hide()
         aGet[ 64  ]:Hide()
         aGet[ 65  ]:Hide()
         aGet[ 66  ]:Hide()

      end

   end





   if !empty( dbfTmpInc )

      while !( dbfTmpInc )->( Eof() )
         if ( dbfTmpInc )->lAviso .AND. !( dbfTmpInc )->lListo
            MsgInfo( Trim( ( dbfTmpInc )->mDesInc ), "¡Incidencia!" )
         end
         ( dbfTmpInc )->( dbSkip() )
      end

      ( dbfTmpInc )->( dbGoTop() )

   end

   oBrw:Refresh()

return nil



STATIC FUNCTION ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 12 ]:VarGet





   if ( empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if D():GetObject( "UnidadMedicion", nView ):oDbf:Seek( aTmp[ 12 ] )

         if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 1 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim1 )
            if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim1 )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( ( D():Articulos( nView ) )->nLngArt )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := ( D():Articulos( nView ) )->nLngArt
            end
         else
            if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 1 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim2 )
            if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim2 )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( ( D():Articulos( nView ) )->nAltArt )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := ( D():Articulos( nView ) )->nAltArt
            end

         else
            if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
                 aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if D():GetObject( "UnidadMedicion", nView ):oDbf:nDimension >= 1 .AND. !empty( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim3 )
            if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( D():GetObject( "UnidadMedicion", nView ):oDbf:cTextoDim3 )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( ( D():Articulos( nView ) ) ->nAncArt )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := ( D():Articulos( nView ) )->nAncArt
            end
         else
            if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !empty( aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

RETURN .T.



Static Function DataReport( oFr )





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Facturas rectificativas", ( D():FacturasRectificativasProveedores( nView ) )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "Facturas rectificativas", cItemsToReport( aItmRctPrv() ) )

   oFr:SetWorkArea(     "Lineas de facturas rectificativas", ( D():FacturasRectificativasProveedoresLineas( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de facturas rectificativas", cItemsToReport( aColRctPrv() ) )

   oFr:SetWorkArea(     "Incidencias de facturas rectificativas", ( D():FacturasRectificativasProveedoresIncidencias( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de facturas rectificativas", cItemsToReport( aIncRctPrv() ) )

   oFr:SetWorkArea(     "Documentos de facturas rectificativas", ( D():FacturasRectificativasProveedoresDocumentos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de facturas rectificativas", cItemsToReport( aFacPrvDoc() ) )

   oFr:SetWorkArea(     "Series de facturas rectificativas", ( D():FacturasRectificativasProveedoresSeries( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Series de facturas rectificativas", cItemsToReport( aSerRctPrv() ) )

   oFr:SetWorkArea(     "Empresa", ( D():Empresa( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Proveedores", ( D():Proveedores( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Proveedores", cItemsToReport( aItmPrv() ) )

   oFr:SetWorkArea(     "Almacenes", ( D():Almacen( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Formas de pago", ( D():FormasPago( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Unidades de medición",  D():GetObject( "UnidadMedicion", nView ):Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( D():GetObject( "UnidadMedicion", nView ):oDbf ) )

   oFr:SetWorkArea(     "Bancos", ( D():BancosProveedores( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Bancos", cItemsToReport( aPrvBnc() ) )

   oFr:SetWorkArea(     "Impuestos especiales",  oNewImp:Select() )
   oFr:SetFieldAliases( "Impuestos especiales",  cObjectsToReport( oNewImp:oDbf ) )

   oFr:SetWorkArea(     "Centro de coste",  D():CentroCoste( nView ):Select() )
   oFr:SetFieldAliases( "Centro de coste",  cObjectsToReport( D():CentroCoste( nView ):oDbf ) )

   oFr:SetMasterDetail( "Facturas rectificativas", "Lineas de facturas rectificativas",      {|| ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Incidencias de facturas rectificativas", {|| ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Documentos de facturas rectificativas",  {|| ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Series de facturas rectificativas",      {|| ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Proveedores",                            {|| ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Almacenes",                              {|| ( D():FacturasRectificativasProveedores( nView ) )->cCodAlm } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Formas de pago",                         {|| ( D():FacturasRectificativasProveedores( nView ) )->cCodPago} )
   oFr:SetMasterDetail( "Facturas rectificativas", "Empresa",                                {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Bancos",                                 {|| ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv } )
   oFr:SetMasterDetail( "Facturas rectificativas", "Centro de coste",                        {|| ( D():FacturasRectificativasProveedores( nView ) )->cCtrCoste } )

   oFr:SetMasterDetail( "Lineas de facturas rectificativas", "Unidades de medición",         {|| ( D():FacturasRectificativasProveedoresLineas( nView ) )->cUnidad } )
   oFr:SetMasterDetail( "Lineas de facturas rectificativas", "Impuestos especiales",         {|| ( D():FacturasRectificativasProveedoresLineas( nView ) )->cCodImp } )

   oFr:SetResyncPair(   "Facturas rectificativas", "Lineas de facturas rectificativas" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Incidencias de facturas rectificativas" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Documentos de facturas rectificativas" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Series de facturas rectificativas" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Proveedores" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Almacenes" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Formas de pago" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Bancos" )
   oFr:SetResyncPair(   "Facturas rectificativas", "Centro de coste" )

   oFr:SetResyncPair(   "Lineas de facturas rectificativas", "Unidades de medición" )
   oFr:SetResyncPair(   "Lineas de facturas rectificativas", "Impuestos especiales" )

Return nil



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "Facturas rectificativas" )
   oFr:DeleteCategory(  "Lineas de facturas rectificativas" )





   oFr:AddVariable(     "Facturas rectificativas",             "Total bruto",                         "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total factura",                       "GetHbVar('nTotFac')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total descuento",                     "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total descuento pronto pago",         "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total primer descuento definible",    "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total segundo descuento definible",   "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total neto",                          "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total " + cImp(),                     "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total RE",                            "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total retenciones por IRPF",          "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total impuestos",                     "GetHbVar('nTotImp')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total unidades",                      "GetHbVar('nTotUnd')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Total impuestos especiales",          "GetHbVar('nTotIvm')" )
   oFr:AddVariable(     "Facturas rectificativas",             "Bruto primer tipo de " + cImp(),      "GetHbArrayVar('aIvaUno',1)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Bruto segundo tipo de " + cImp(),     "GetHbArrayVar('aIvaDos',1)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Bruto tercer tipo de " + cImp(),      "GetHbArrayVar('aIvaTre',1)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Base primer tipo de " + cImp(),       "GetHbArrayVar('aIvaUno',2)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Base segundo tipo de " + cImp(),      "GetHbArrayVar('aIvaDos',2)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Base tercer tipo de " + cImp(),       "GetHbArrayVar('aIvaTre',2)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Porcentaje primer tipo " + cImp(),    "GetHbArrayVar('aIvaUno',3)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Porcentaje segundo tipo " + cImp(),   "GetHbArrayVar('aIvaDos',3)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Porcentaje tercer tipo " + cImp(),    "GetHbArrayVar('aIvaTre',3)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Porcentaje primer tipo RE",           "GetHbArrayVar('aIvaUno',4)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Porcentaje segundo tipo RE",          "GetHbArrayVar('aIvaDos',4)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Porcentaje tercer tipo RE",           "GetHbArrayVar('aIvaTre',4)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe primer tipo " + cImp(),       "GetHbArrayVar('aIvaUno',5)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe segundo tipo " + cImp(),      "GetHbArrayVar('aIvaDos',5)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe tercer tipo " + cImp(),       "GetHbArrayVar('aIvaTre',5)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe primer RE",                   "GetHbArrayVar('aIvaUno',6)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe segundo RE",                  "GetHbArrayVar('aIvaDos',6)" )
   oFr:AddVariable(     "Facturas rectificativas",             "Importe tercer RE",                   "GetHbArrayVar('aIvaTre',6)" )

   oFr:AddVariable(     "Facturas rectificativas",             "Cuenta bancaria proveedor",           "CallHbFunc('cCtaRctPrv')" )

   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Código del artículo con propiedades", "CallHbFunc('cPrpRctPrv')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Detalle del artículo",                "CallHbFunc('cDesRctPrv')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Detalle del artículo otro lenguaje",  "CallHbFunc('cDesRctPrvLeng')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Total unidades artículo",             "CallHbFunc('nTotNRctPrv')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Precio unitario de factura",          "CallHbFunc('nTotURctPrv')" )
   oFr:AddVariable(     "Lineas de facturas rectificativas",   "Total línea de factura",              "CallHbFunc('nTotLRctPrv')" )

Return nil



Static Function YearComboBoxChange()

   if ( oWndBrw:oWndBar:cYearComboBox() <> "[Todos]" )
      oWndBrw:oWndBar:setYearComboBoxExpression( "Year( Field->dFecFac ) == " + oWndBrw:oWndBar:cYearComboBox() )
   else
      oWndBrw:oWndBar:setYearComboBoxExpression( "" )
   end

   oWndBrw:chgFilter()

Return nil



Static Function EditarNumeroSerie( aTmp, nMode )

   with object ( TNumerosSerie() )

      :lCompras         := .T.
      :nMode            := nMode

      :cCodArt          := aTmp[ 4    ]
      :cCodAlm          := aTmp[ 57 ]
      :nNumLin          := aTmp[ 63 ]

      :nTotalUnidades   := nTotNRctPrv( aTmp )

      :oStock           := oStock

      :uTmpSer          := dbfTmpSer

      :Resource()

   end

Return ( nil )



Static Function OldEditarNumeroSerie( aTmp, nMode )

   local n        := 1
   local oDlg
   local oBrwSer
   local oProSer
   local nProSer
   local aNumSer
   local cPreFix  := Space( 18 )
   local oSerIni
   local nSerIni  := 0
   local oSerFin
   local nSerFin  := 0
   local oNumGen
   local nNumGen  := 0
   local nTotUnd

   If( nMode == nil, nMode := 1, ) ;

   nTotUnd        := Abs( nTotNRctPrv( aTmp ) )

   if nTotUnd == 0
      MsgStop( "No hay unidades para asignar números de serie." )
      Return ( nil )
   end

   aNumSer        := Afill( Array( nTotUnd ), Space( 40 ) )

   if ( dbfTmpSer )->( dbSeek( Str( aTmp[ 63 ], 4 ) + aTmp[ 4 ] ) )
      while ( Str( ( dbfTmpSer )->nNumLin, 4 ) + ( dbfTmpSer )->cRef == Str( aTmp[ 63 ], 4 ) + aTmp[ 4 ] ) .AND. !( dbfTmpSer )->( Eof() )
         if ( n <= nTotUnd )
            aNumSer[ n ]   := ( dbfTmpSer )->cNumSer
         end
         ( dbfTmpSer )->( dbSkip() )
         n++
      end
   end

   oDlg = TDialog():New(,,,,, "VtaNumSer",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, nTotUnd, nTotUnd:= u ) }, oDlg,, MasUnd(),,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cPreFix, cPreFix:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      oSerIni := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nSerIni, nSerIni:= u ) }, oDlg,, "99999999999999999999", {||    ( oSerFin:cText( nSerIni + nTotUnd ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      oSerFin := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nSerFin, nSerFin:= u ) }, oDlg,, "99999999999999999999",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )






      oNumGen := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, nNumGen, nNumGen:= u ) }, oDlg,, "99999999999999999999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TButton():ReDefine( 500, {||( GenNumSer( cPreFix, aNumSer, nSerIni, nNumGen, oBrwSer ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )

      oBrwSer                 := IXBrowse():New( oDlg )

      oBrwSer:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwSer:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwSer:lHScroll        := .F.
      oBrwSer:lRecordSelector := .T.
      oBrwSer:lFastEdit       := .T.

      oBrwSer:nMarqueeStyle   := 3

      oBrwSer:SetArray( aNumSer, , , .F. )

      oBrwSer:nColSel         := 2

      with object ( oBrwSer:addCol() )
         :cHeader       := "N."
         :bStrData      := {|| Trans( oBrwSer:nArrayAt, "999999999" ) }
         :nWidth        := 60
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
      end

      with object ( oBrwSer:addCol() )
         :cHeader       := "Serie"
         :bEditValue    := {|| aNumSer[ oBrwSer:nArrayAt ] }
         :nWidth        := 240
         :nEditType     := 1
         :bOnPostEdit   := {|o,x| aNumSer[ oBrwSer:nArrayAt ] := x }
      end

      oBrwSer:CreateFromResource( 150 )

      oProSer     := TApoloMeter():ReDefine( 240, { | u | if( pCount() == 0, nProSer, nProSer := u ) }, 10, oDlg, .F., , , .T., ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), , ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) ) )





      TButton():ReDefine( 510, {||( SalvarNumeroSerie( aNumSer, aTmp, oProSer, nMode ), oDlg:End() )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 520, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F. )

      oDlg:AddFastKey( 116, {|| SalvarNumeroSerie( aNumSer, aTmp, oProSer, nMode ), oDlg:End() } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( aNumSer )



Static Function SalvarNumeroSerie( aNumSer, aTmp, oProSer, nMode )

   local cNumSer
   local nTotUnd              := len( aNumSer )

   while ( ( dbfTmpSer )->( dbSeek( Str( aTmp[ 63 ], 4 ) + aTmp[ 4 ] ) ) ) .AND. !( dbfTmpSer )->( Eof() )
      ( dbfTmpSer )->( dbDelete() )
   end

   if !empty( oProSer )
      oProSer:SetTotal( nTotUnd )
   end

   for each cNumSer in aNumSer

      ( dbfTmpSer )->( dbAppend() )
      ( dbfTmpSer )->cRef     := aTmp[ 4    ]
      ( dbfTmpSer )->nNumLin  := aTmp[ 63 ]
      ( dbfTmpSer )->cAlmLin  := aTmp[ 57 ]
      ( dbfTmpSer )->cNumSer  := cNumSer

      if !empty( oProSer ) .AND. ( Mod( hb_enumindex(), int( nTotUnd / 100 ) ) == 0 )
         oProSer:Set( hb_enumindex() )
      end

   next

Return ( nil )



Static Function ImprimirSeriesFacturasRectificativasProveedores( nDevice, lExt )

   local aStatus
   local oPrinter
   local cFormato

   If( nDevice == nil, nDevice := 1, ) ;
   If( lExt == nil, lExt := .F., ) ;



   oPrinter          := PrintSeries():New( nView ):SetCompras()



   oPrinter:Serie(      ( D():FacturasRectificativasProveedores( nView ) )->cSerFac )
   oPrinter:Documento(  ( D():FacturasRectificativasProveedores( nView ) )->nNumFac )
   oPrinter:Sufijo(     ( D():FacturasRectificativasProveedores( nView ) )->cSufFac )

   if lExt

      oPrinter:oFechaInicio:cText( ( D():FacturasRectificativasProveedores( nView ) )->dFecFac )
      oPrinter:oFechaFin:cText( ( D():FacturasRectificativasProveedores( nView ) )->dFecFac )

   end

   oPrinter:oFormatoDocumento:TypeDocumento( "TP" )



   cFormato          := cFormatoDocumento( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac, "nRctPrv", D():Contadores( nView ) )
   if empty( cFormato )
      cFormato       := cFirstDoc( "TP", D():Documentos( nView ) )
   end
   oPrinter:oFormatoDocumento:cText( cFormato )



   aStatus           := D():GetInitStatus( "RctPrvT", nView )

   oPrinter:bInit    := {||   ( D():FacturasRectificativasProveedores( nView ) )->( dbSeek( oPrinter:DocumentoInicio(), .T. ) ) }


   oPrinter:bWhile   := {||   oPrinter:InRangeDocumento( D():FacturasRectificativasProveedoresId( nView ) )                  .AND.  ( D():FacturasRectificativasProveedores( nView ) )->( !eof() ) }



   oPrinter:bFor     := {||   oPrinter:InRangeFecha( ( D():FacturasRectificativasProveedores( nView ) )->dFecFac )           .AND.  oPrinter:InRangeProveedor( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv )         .AND.  oPrinter:InRangeGrupoProveedor( RetFld( ( D():FacturasRectificativasProveedores( nView ) )->cCodPrv, D():Proveedores( nView ), "cCodGrp" ) ) }

   oPrinter:bSkip    := {||   ( D():FacturasRectificativasProveedores( nView ) )->( dbSkip() ) }

   oPrinter:bAction  := {||   GenRctPrv( nDevice, "Imprimiendo documento : " + D():FacturasRectificativasProveedoresId( nView ), oPrinter:oFormatoDocumento:uGetValue, oPrinter:oImpresora:uGetValue, oPrinter:oCopias:uGetValue ) }

   oPrinter:bStart   := {||   if( lExt, oPrinter:DisableRange(), ) }



   oPrinter:Resource():End()



   D():SetStatus( "RctPrvT", nView, aStatus )

   if !empty( oWndBrw )
      oWndBrw:Refresh()
   end

Return .T.







FUNCTION nPagRctPrv( cFactura, cFacPrvP, cDivRet, cDiv, lOnlyCob, aTmp )

   local nRec
   local nOrd
   local nRinDiv
   local cCodDiv
   local nTotalPagado   := 0

   If( cFacPrvP == nil, cFacPrvP := D():FacturasProveedoresPagos( nView ), ) ;
   If( cDivRet == nil, cDivRet := cDivEmp(), ) ;
   If( lOnlyCob == nil, lOnlyCob := .T., ) ;

   nRinDiv              := nRinDiv( cDivRet, cDiv )





   nRec                    := ( cFacPrvP )->( Recno() )

   if !empty( aTmp )

      cCodDiv              := ( cFacPrvP )->cDivPgo

      ( cFacPrvP )->( dbGoTop() )
      while !( cFacPrvP )->( Eof() )

         if ( lOnlyCob .AND. ( cFacPrvP )->lCobrado .AND. !( cFacPrvP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( cFacPrvP )->lDevuelto )

            nTotalPagado   += ( cFacPrvP )->nImporte

         end

         ( cFacPrvP )->( dbSkip() )

      end

      ( cFacPrvP )->( dbGoTo( nRec ) )

   else

      nOrd                 := ( cFacPrvP )->( OrdSetFocus( "rNumFac" ) )

      if ( cFacPrvP )->( dbSeek( cFactura, .T. ) )

         cCodDiv           := ( cFacPrvP )->cDivPgo

         while ( ( cFacPrvP )->cSerFac + Str( ( cFacPrvP )->nNumFac ) + ( cFacPrvP )->cSufFac = cFactura )

            if ( lOnlyCob .AND. ( cFacPrvP )->lCobrado .AND. !( cFacPrvP )->lDevuelto ) .OR. ( !lOnlyCob .AND. !( cFacPrvP )->lDevuelto )

               nTotalPagado   += ( cFacPrvP )->nImporte

            end

            ( cFacPrvP )->( dbSkip() )

         end

      end

      ( cFacPrvP )->( OrdSetFocus( nOrd ) )

   end

   ( cFacPrvP )->( dbGoTo( nRec ) )

   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      nTotalPagado   := nCnv2Div( nTotalPagado, cCodDiv, cDivRet )
   else
      nTotalPagado   := Round( nTotalPagado, nRinDiv )
   end

RETURN ( nTotalPagado )



FUNCTION ChkPagRctPrv( cRctPrvT, cRctPrvP )

   local nBitmap

   do case
   case ( cRctPrvT )->lLiquidada
      nBitmap  := 1
   case lRecibosPagados( cRctPrvT, cRctPrvP )
      nBitmap  := 2
   otherwise
      nBitmap  := 3
   end

RETURN nBitmap






FUNCTION ChkLqdRctPrv( aTmp, cRctPrvT, cRctPrvL, cRctPrvP, cIva, cDiv )

   local cFactura
   local nPagFacPrv
   local nTotal
   local cDivFac

   IF aTmp <> NIL
      cFactura := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]
      cDivFac  := aTmp[ 35 ]
   ELSE
      cFactura := (cRctPrvT)->CSERFAC + Str( (cRctPrvT)->NNUMFAC ) + (cRctPrvT)->CSUFFAC
      cDivFac  := (cRctPrvT)->CDIVFAC
   end

   nPagFacPrv  := abs( nPagRctPrv( cFactura, cRctPrvP, cDivFac, cDiv ) )
   nTotal      := abs( nTotRctPrv( cFactura, cRctPrvT, cRctPrvL, cIva, cDiv, cRctPrvP, nil, nil, .F. ) )

   if aTmp <> NIL

      if nPagFacPrv == nTotal
         aTmp[ 15 ] := .T.
      elseif nPagFacPrv > nTotal

         aTmp[ 15 ] := .T.
      else
         aTmp[ 15 ] := .F.
      end

   else

      if dbLock( cRctPrvT )
         if nPagFacPrv == nTotal
            ( cRctPrvT )->lLiquidada := .T.
         elseif  nPagFacPrv > nTotal

            ( cRctPrvT )->lLiquidada := .T.
         else
            ( cRctPrvT )->lliquidada := .F.
         end
         ( cRctPrvT )->( dbRUnLock() )
      end

   end

RETURN NIL



FUNCTION nNetURctPrv( uFacPrvL, uFacPrvT, nDec, nRec, nVdv, cPinDiv )

   local nDtoEsp
   local nDtoPP
   local nDtoUno
   local nDtoDos
   local nCalculo
   local nDtoLin
   local nDtoPrm
   local nPorte

   If( nDec == nil, nDec := 0, ) ;
   If( nRec == nil, nRec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotURctPrv( uFacPrvL, nDec, nVdv )

   if ValType( uFacPrvL ) == "A"
      nDtoLin     := uFacPrvL[ 16 ]
      nDtoPrm     := uFacPrvL[ 17 ]
   else
      nDtoLin     := ( uFacPrvL )->nDtoLin
      nDtoPrm     := ( uFacPrvL )->nDtoPrm
   end

   if nDtoLin <> 0
      nCalculo    -= nCalculo * nDtoLin / 100
   end

   if nDtoPrm <> 0
      nCalculo    -= nCalculo * nDtoPrm / 100
   end





   if ValType( uFacPrvT ) == "A"
      nDtoEsp     := uFacPrvT[ 29 ]
      nDtoPP      := uFacPrvT[ 31    ]
      nDtoUno     := uFacPrvT[ 39 ]
      nDtoDos     := uFacPrvT[ 41 ]
      nPorte      := uFacPrvT[ 25 ]
   else
      nDtoEsp     := (uFacPrvT)->NDTOESP
      nDtoPP      := (uFacPrvT)->NDPP
      nDtoUno     := (uFacPrvT)->NDTOUNO
      nDtoDos     := (uFacPrvT)->NDTODOS
      nPorte      := (uFacPrvT)->NPORTES
   end

   if nDtoEsp <> 0
      nCalculo    -= Round( nCalculo * nDtoEsp / 100, nDec )
   end

   if nDtoPP <> 0
      nCalculo    -= Round( nCalculo * nDtoPP  / 100, nDec )
   end

   if nDtoUno <> 0
      nCalculo    -= Round( nCalculo * nDtoUno / 100, nDec )
   end

   if nDtoDos <> 0
      nCalculo    -= Round( nCalculo * nDtoDos / 100, nDec )
   end

   nCalculo       := Round( nCalculo, nDec )

RETURN ( if( cPinDiv <> NIL, Trans( nCalculo, cPinDiv ), nCalculo ) )



FUNCTION nImpURctPrv( uFacPrvT, cRctPrvL, nDec, nVdv, lIva, cPouDiv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lIva == nil, lIva := .F., ) ;

   nCalculo       := nTotURctPrv( cRctPrvL, nDec, nVdv )

   if ValType( uFacPrvT ) == "A"
      nCalculo    -= Round( nCalculo * uFacPrvT[ 29 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 31    ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 39 ]  / 100, nDec )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 41 ]  / 100, nDec )
   else
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoEsp / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDpp    / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoUno / 100, nDec )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoDos / 100, nDec )
   end

   if lIva .AND. ( cRctPrvL )->nIva <> 0
      nCalculo    += nCalculo * ( cRctPrvL )->nIva / 100
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nImpLRctPrv( uFacPrvT, cRctPrvL, nDec, nRou, nVdv, lIva, cPouDiv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nRou == nil, nRou := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lIva == nil, lIva := .F., ) ;

   nCalculo       := nTotLRctPrv( cRctPrvL, nDec, nRou, nVdv )

   if ValType( uFacPrvT ) == "A"
      nCalculo    -= Round( nCalculo * uFacPrvT[ 29 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 31    ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 39 ]  / 100, nRou )
      nCalculo    -= Round( nCalculo * uFacPrvT[ 41 ]  / 100, nRou )
   else
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoEsp / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDpp    / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoUno / 100, nRou )
      nCalculo    -= Round( nCalculo * ( uFacPrvT )->nDtoDos / 100, nRou )
   end

   if lIva .AND. ( cRctPrvL )->nIva <> 0
      nCalculo    += nCalculo * ( cRctPrvL )->nIva / 100
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nTotFRctPrv( cRctPrvL, nDec, nRou, nVdv, cPorDiv )

   local nCalculo := 0

   nCalculo       += nTotLRctPrv( cRctPrvL, nDec, nRou, nVdv )
   nCalculo       += nIvaLRctPrv( cRctPrvL, nDec, nRou, nVdv )

return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nTotRctPrv( cFactura, cFacPrvT, cFacPrvL, cIva, cDiv, cFacPrvP, aTmp, cDivRet, lPic )

   local bCondition
   local nTotalArt
   local lRecargo
   local dFecFac
   local nDtoEsp
   local nDtoPP
   local nDtoUno
   local nDtoDos
   local nPorte
   local nPctRet
   local nRecno
   local cCodDiv
   local cCodPgo
   local nRegIva
   local lFacGas     := .F.
   local aTotalUno   := { 0, 0, 0 }
   local aTotalDos   := { 0, 0, 0 }
   local aTotalDto   := { 0, 0, 0 }
   local aTotalDPP   := { 0, 0, 0 }
   local aNetGas     := { 0, 0, 0 }
   local aPIvGas     := { 0, 0, 0 }
   local aPReGas     := { 0, 0, 0 }
   local nImpuestoEspecial

   If( cFacPrvT == nil, cFacPrvT := D():FacturasRectificativasProveedores( nView ), ) ;
   If( cFacPrvL == nil, cFacPrvL := D():FacturasRectificativasProveedoresLineas( nView ), ) ;
   If( cFacPrvP == nil, cFacPrvP := D():FacturasProveedoresPagos( nView ), ) ;
   If( cIva == nil, cIva := D():TiposIva( nView ), ) ;
   If( cDiv == nil, cDiv := D():Divisas( nView ), ) ;
   If( cFactura == nil, cFactura := ( cFacPrvT )->cSerFac + Str( ( cFacPrvT )->nNumFac ) + ( cFacPrvT )->cSufFac, ) ;
   If( lPic == nil, lPic := .F., ) ;

   initPublics()

   nRecno            := ( cFacPrvL )->( recno() )

   if aTmp <> nil
      dFecFac        := aTmp[ 5 ]
      lRecargo       := aTmp[ 32]
      nDtoEsp        := aTmp[ 29 ]
      nDtoPP         := aTmp[ 31    ]
      nDtoUno        := aTmp[ 39 ]
      nDtoDos        := aTmp[ 41 ]
      nPorte         := aTmp[ 25 ]
      cCodDiv        := aTmp[ 35 ]
      cCodPgo        := aTmp[ 23]
      nTipRet        := aTmp[ 50 ]
      nPctRet        := aTmp[ 51 ]
      nRegIva        := aTmp[ 55 ]
      lFacGas        := aTmp[ 56 ]
      aNetGas        := { aTmp[ 58 ], aTmp[ 59 ], aTmp[ 60 ] }
      aPIvGas        := { aTmp[ 61 ], aTmp[ 62 ], aTmp[ 63 ] }
      aPReGas        := { aTmp[ 64  ], aTmp[ 65  ], aTmp[ 66  ] }
      bCondition     := {|| ( cFacPrvL )->( !eof() ) }
      ( cFacPrvL )->( dbGoTop() )
   else
      dFecFac        := ( cFacPrvT )->dFecFac
      lRecargo       := ( cFacPrvT )->lRecargo
      nDtoEsp        := ( cFacPrvT )->nDtoEsp
      nDtoPP         := ( cFacPrvT )->nDpp
      nDtoUno        := ( cFacPrvT )->nDtoUno
      nDtoDos        := ( cFacPrvT )->nDtoDos
      nPorte         := ( cFacPrvT )->nPortes
      cCodDiv        := ( cFacPrvT )->cDivFac
      cCodPgo        := ( cFacPrvT )->cCodPago
      nTipRet        := ( cFacPrvT )->nTipRet
      nPctRet        := ( cFacPrvT )->nPctRet
      nRegIva        := ( cFacPrvT )->nRegIva
      lFacGas        := ( cFacPrvT )->lFacGas
      aNetGas        := { ( cFacPrvT )->nNetGas1, ( cFacPrvT )->nNetGas2, ( cFacPrvT )->nNetGas3 }
      aPIvGas        := { ( cFacPrvT )->nIvaGas1, ( cFacPrvT )->nIvaGas2, ( cFacPrvT )->nIvaGas3 }
      aPReGas        := { ( cFacPrvT )->nReGas1,  ( cFacPrvT )->nReGas2,  ( cFacPrvT )->nReGas3  }
      bCondition     := {|| ( cFacPrvL )->cSerFac + Str( ( cFacPrvL )->nNumFac ) + ( cFacPrvL )->cSufFac == cFactura .AND. ( cFacPrvL )->( !eof() ) }
      ( cFacPrvL )->( dbSeek( cFactura ) )
   end





   cPinDiv           := cPinDiv( cCodDiv, cDiv )
   cPirDiv           := cPirDiv( cCodDiv, cDiv )
   nDinDiv           := nDinDiv( cCodDiv, cDiv )
   nRinDiv           := nRinDiv( cCodDiv, cDiv )

   if !lFacGas

      while Eval( bCondition )

         if lValLine( cFacPrvL )

            nTotalArt            := nTotLRctPrv( cFacPrvL, nDinDiv, nRinDiv )
            nImpuestoEspecial    := nTotIFacPrv( cFacPrvL, nDinDiv, nRinDiv )

            if nTotalArt <> 0

               if ( cFacPrvL )->lGasSup
                  nTotSup        += nTotalArt
               end





               do case
               case aTotIva[ 1, 3 ] == NIL .OR. aTotIva[ 1, 3 ] == ( cFacPrvL )->NIVA
                  aTotIva[ 1, 3 ]   := (cFacPrvL)->nIva
                  aTotIva[ 1, 4 ]   := (cFacPrvL)->nReq
                  aTotIva[ 1, 1 ]   += nTotalArt
                  aTotIva[ 1, 6 ]   += nImpuestoEspecial

               case aTotIva[ 2, 3 ] == NIL .OR. aTotIva[ 2, 3 ] == ( cFacPrvL )->NIVA
                  aTotIva[ 2, 3 ]   := (cFacPrvL)->nIva
                  aTotIva[ 2, 4 ]   := (cFacPrvL)->nReq
                  aTotIva[ 2, 1 ]   += nTotalArt
                  aTotIva[ 2, 6 ]   += nImpuestoEspecial

               case aTotIva[ 3, 3 ] == NIL .OR. aTotIva[ 3, 3 ] == ( cFacPrvL )->NIVA
                  aTotIva[ 3, 3 ]   := (cFacPrvL)->nIva
                  aTotIva[ 3, 4 ]   := (cFacPrvL)->nReq
                  aTotIva[ 3, 1 ]   += nTotalArt
                  aTotIva[ 3, 6 ]   += nImpuestoEspecial

               end

            end

            nTotUnd           += nTotNRctPrv( cFacPrvL )

         end

         ( cFacPrvL )->( dbSkip() )

      end

      ( cFacPrvL )->( dbGoto( nRecno ) )

   else

      aTotIva[ 1, 1 ]   := aNetGas[1]
      aTotIva[ 1, 3 ]   := aPIvGas[1]
      aTotIva[ 1, 4 ]   := aPReGas[1]

      aTotIva[ 2, 1 ]   := aNetGas[2]
      aTotIva[ 2, 3 ]   := aPIvGas[2]
      aTotIva[ 2, 4 ]   := aPReGas[2]

      aTotIva[ 3, 1 ]   := aNetGas[3]
      aTotIva[ 3, 3 ]   := aPIvGas[3]
      aTotIva[ 3, 4 ]   := aPReGas[3]

   end





   aTotIva              := aSort( aTotIva,,, {|x,y| abs( x[1] ) > abs( y[1] ) } )

   aTotIva[ 1, 2 ]            := Round( aTotIva[ 1, 1 ], nRinDiv )
   aTotIva[ 2, 2 ]            := Round( aTotIva[ 2, 1 ], nRinDiv )
   aTotIva[ 3, 2 ]            := Round( aTotIva[ 3, 1 ], nRinDiv )

   nTotBrt              := aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ] + aTotIva[ 3, 2 ]





   nTotBrt              += nPorte





   if !lFacGas

      IF nDtoEsp <> 0

         aTotalDto[1]   := Round( aTotIva[ 1, 2 ] * nDtoEsp / 100, nRinDiv )
         aTotalDto[2]   := Round( aTotIva[ 2, 2 ] * nDtoEsp / 100, nRinDiv )
         aTotalDto[3]   := Round( aTotIva[ 3, 2 ] * nDtoEsp / 100, nRinDiv )

         nTotDto      := aTotalDto[1] + aTotalDto[2] + aTotalDto[3]

         aTotIva[ 1, 2 ]      -= aTotalDto[1]
         aTotIva[ 2, 2 ]      -= aTotalDto[2]
         aTotIva[ 3, 2 ]      -= aTotalDto[3]

      end

      IF nDtoPP <> 0

         aTotalDPP[1]   := Round( aTotIva[ 1, 2 ] * nDtoPP / 100, nRinDiv )
         aTotalDPP[2]   := Round( aTotIva[ 2, 2 ] * nDtoPP / 100, nRinDiv )
         aTotalDPP[3]   := Round( aTotIva[ 3, 2 ] * nDtoPP / 100, nRinDiv )

         nTotDPP      := aTotalDPP[1] + aTotalDPP[2] + aTotalDPP[3]

         aTotIva[ 1, 2 ]      -= aTotalDPP[1]
         aTotIva[ 2, 2 ]      -= aTotalDPP[2]
         aTotIva[ 3, 2 ]      -= aTotalDPP[3]

      end

      IF nDtoUno <> 0

         aTotalUno[1]   := Round( aTotIva[ 1, 2 ] * nDtoUno / 100, nRinDiv )
         aTotalUno[2]   := Round( aTotIva[ 2, 2 ] * nDtoUno / 100, nRinDiv )
         aTotalUno[3]   := Round( aTotIva[ 3, 2 ] * nDtoUno / 100, nRinDiv )

         nTotUno        := aTotalUno[1] + aTotalUno[2] + aTotalUno[3]

         aTotIva[ 1, 2 ]      -= aTotalUno[1]
         aTotIva[ 2, 2 ]      -= aTotalUno[2]
         aTotIva[ 3, 2 ]      -= aTotalUno[3]

      end

      IF nDtoDos <> 0

         aTotalDos[1]   := Round( aTotIva[ 1, 2 ] * nDtoDos / 100, nRinDiv )
         aTotalDos[2]   := Round( aTotIva[ 2, 2 ] * nDtoDos / 100, nRinDiv )
         aTotalDos[3]   := Round( aTotIva[ 3, 2 ] * nDtoDos / 100, nRinDiv )

         nTotDos        := aTotalDos[1] + aTotalDos[2] + aTotalDos[3]

         aTotIva[ 1, 2 ]      -= aTotalDos[1]
         aTotIva[ 2, 2 ]      -= aTotalDos[2]
         aTotIva[ 3, 2 ]      -= aTotalDos[3]

      end

   end

   if uFieldEmpresa( "lIvaImpEsp" )
      aTotIva[ 1, 2 ]      += aTotIva[ 1, 6 ]
      aTotIva[ 2, 2 ]      += aTotIva[ 2, 6 ]
      aTotIva[ 3, 2 ]      += aTotIva[ 3, 6 ]
   end



   nTotNet           := Round( aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ] + aTotIva[ 3, 2 ], nRinDiv )





   if nRegIva <= 1

      aTotIva[ 1, 8 ]         := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 3 ] / 100, nRinDiv ), 0 )
      aTotIva[ 2, 8 ]         := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 3 ] / 100, nRinDiv ), 0 )
      aTotIva[ 3, 8 ]         := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 3 ] / 100, nRinDiv ), 0 )





      if lRecargo
         aTotIva[ 1, 9 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 4 ] / 100, nRinDiv ), 0 )
         aTotIva[ 2, 9 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 4 ] / 100, nRinDiv ), 0 )
         aTotIva[ 3, 9 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 4 ] / 100, nRinDiv ), 0 )
      end

   end



   nTotIva           := Round( aTotIva[ 1, 8 ] + aTotIva[ 2, 8 ] + aTotIva[ 3, 8 ], nRinDiv )



   nTotReq           := Round( aTotIva[ 1, 9 ] + aTotIva[ 2, 9 ] + aTotIva[ 3, 9 ], nRinDiv )



   nTotIvm           := Round( aTotIva[ 1, 6 ] + aTotIva[ 2, 6 ] + aTotIva[ 3, 6 ], nRinDiv )



   nTotImp           := Round( nTotIva + nTotReq , nRinDiv )
   if !uFieldEmpresa( "lIvaImpEsp" )
      nTotImp        += Round( nTotIvm , nRinDiv )
   end



   if isNum( nTipRet )
      if nTipRet <= 1
         nTotRet     := Round( ( nTotNet - nTotSup ) * nPctRet / 100, nRinDiv )
      else
         nTotRet     := Round( ( nTotNet - nTotSup + nTotIva ) * nPctRet / 100, nRinDiv )
      end
   end



   nTotFac           := Round( nTotNet + nTotImp - nTotRet, nRinDiv )



   if cFacPrvP <> nil
      nPagFac        := nPagRctPrv( cFactura, cFacPrvP, cCodDiv, cDiv, .T., aTmp )
   end

   aTotIva           := aSort( aTotIva,,, {|x,y| abs( x[1] ) > abs( y[1] ) } )



   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet     := nCnv2Div( nTotNet, cCodDiv, cDivRet )
      nTotIva     := nCnv2Div( nTotIva, cCodDiv, cDivRet )
      nTotReq     := nCnv2Div( nTotReq, cCodDiv, cDivRet )
      nTotFac     := nCnv2Div( nTotFac, cCodDiv, cDivRet )
      cPirDiv     := cPirDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( nTotFac, cPirDiv ), nTotFac ) )



function nVtaRctPrv( cCodPrv, dDesde, dHasta, cRctPrvT, cRctPrvL, cIva, cDiv, nYear )

   local nCon     := 0
   local nRec     := ( cRctPrvT )->( Recno() )





   if ( cRctPrvT )->( dbSeek( cCodPrv ) )

      while ( cRctPrvT )->cCodPrv == cCodPrv .AND. !( cRctPrvT )->( Eof() )



         if ( dDesde == nil .OR. ( cRctPrvT )->dFecFac >= dDesde )    .AND. ( dHasta == nil .OR. ( cRctPrvT )->dFecFac <= dHasta )    .AND. ( nYear == nil .OR. Year( ( cRctPrvT )->dFecFac ) == nYear )

            nCon  += nTotRctPrv( ( cRctPrvT )->cSerFac + Str( (cRctPrvT)->nNumFac ) + (cRctPrvT)->cSufFac, cRctPrvT, cRctPrvL, cIva, cDiv, nil, nil, cDivEmp(), .F. )

         end

         ( cRctPrvT )->( dbSkip() )

      end

   end

   ( cRctPrvT )->( dbGoTo( nRec ) )

return nCon






function nCobRctPrv( cCodPrv, dDesde, dHasta, cRctPrvT, cRctPrvP, cIva, cDiv, lOnlyCob, nYear )

   local nCob        := 0
   local nOrd        := ( cRctPrvT )->( OrdSetFocus( "cCodPrv" ) )
   local nRec        := ( cRctPrvT )->( Recno() )

   If( lOnlyCob == nil, lOnlyCob := .T., ) ;





   if ( cRctPrvT )->( dbSeek( cCodPrv ) )

      while ( cRctPrvT )->cCodPrv = cCodPrv .AND. !( cRctPrvT )->( Eof() )



         if ( dDesde == nil .OR. ( cRctPrvT )->DFECFAC >= dDesde ) .AND. ( dHasta == nil .OR. ( cRctPrvT )->DFECFAC <= dHasta ) .AND. ( nYear == nil .OR. Year( ( cRctPrvT )->dFecFac ) == nYear )

            nCob  += nPagRctPrv( ( cRctPrvT )->cSerFac + Str( (cRctPrvT)->nNumFac ) + (cRctPrvT)->cSufFac, cRctPrvP, cDivEmp(), cDiv, lOnlyCob )

         end

         ( cRctPrvT )->( dbSkip() )

      end

   end

   ( cRctPrvT )->( OrdSetFocus( nOrd ) )
   ( cRctPrvT )->( dbGoTo( nRec ) )

return nCob



FUNCTION mkRctPrv( cPath, oMeter, cDriver )

   if oMeter <> nil
      oMeter:cText   := "Generando Bases"
      sysrefresh()
   end

   CreateFiles( cPath )

   rxRctPrv( cPath, oMeter, cDriver )

RETURN NIL



FUNCTION rxRctPrv( cPath, oMeter, cDriver )

   local cRctPrvT
   local cRctPrvL

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;





   if !lExistTable( cPath + "RctPrvT.Dbf" ) .OR.  !lExistTable( cPath + "RctPrvL.Dbf" ) .OR.  !lExistTable( cPath + "RctPrvI.Dbf" ) .OR.  !lExistTable( cPath + "RctPrvD.Dbf" ) .OR.  !lExistTable( cPath + "RctPrvS.Dbf" )
      CreateFiles( cPath )
   end





   fErase( cPath + "RctPrvT.Cdx" )
   fErase( cPath + "RctPrvL.Cdx" )
   fErase( cPath + "RctPrvI.Cdx" )
   fErase( cPath + "RctPrvD.Cdx" )
   fErase( cPath + "RctPrvS.Cdx" )

   dbUseArea( .T., cDriver, cPath + "RctPrvT.DBF", cCheckArea( "RctPrvT", @cRctPrvT ), .F. )

   if !( cRctPrvT )->( neterr() )

      ( cRctPrvT )->( __dbPack() )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "NNUMFAC", "CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "DFECFAC", "DFECFAC", {|| Field->DFECFAC } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "CCODPRV", "CCODPRV", {|| Field->CCODPRV } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "CNOMPRV", "Upper( CNOMPRV )", {|| Upper( Field->CNOMPRV ) } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "cNumDoc", "Upper( cNumDoc )", {|| Upper( Field->cNumDoc ) } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "cTurFac", "cTurFac + cSufFac + cCodCaj", {|| Field->CTURFAC + Field->CSUFFAC + Field->cCodCaj } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.Cdx", "cCodUsr", "Field->cCodUsr + Dtos( Field->dFecChg ) + Field->cTimChg", {|| Field->cCodUsr + Dtos( Field->dFecChg ) + Field->cTimChg } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.Cdx", "cCodPago", "cCodPago", {|| Field->cCodPago } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.Cdx", "cNumFac", "cNumFac", {|| Field->cNumFac } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "iNumRct", "'04' + CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| "04" + Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "DDESFEC", "DFECFAC", {|| Field->DFECFAC } ) )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvT.CDX", "lSndDoc", "lSndDoc", {|| Field->lSndDoc } ) )

      ( cRctPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas rectificativas de proveedores" )
   end





   dbUseArea( .T., cDriver, cPath + "RctPrvL.DBF", cCheckArea( "RctPrvL", @dbfRctPrvL ), .F. )
   if !( dbfRctPrvL )->( neterr() )
      ( dbfRctPrvL )->( __dbPack() )

      ( dbfRctPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfRctPrvL )->( ordCreate( cPath + "RctPrvL.Cdx", "NNUMFAC", "CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( dbfRctPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfRctPrvL )->( ordCreate( cPath + "RctPrvL.Cdx", "cRef", "cRef + cValPr1 + cValPr2", {|| Field->cRef + Field->cValPr1 + Field->cValPr2 }, ) )

      ( dbfRctPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfRctPrvL )->( ordCreate( cPath + "RctPrvL.Cdx", "Lote", "cLote", {|| Field->cLote }, ) )

      ( dbfRctPrvL )->( ordCondSet( "!lValidado .and. !lControl .and. nCtlStk < 2 .and. !Deleted()", {|| !Field->lValidado .AND. !Field->lControl .AND. Field->nCtlStk < 2 .AND. !Deleted()}, , , , , , , , , .T. ) )
      ( dbfRctPrvL )->( ordCreate( cPath + "RctPrvL.Cdx", "cStkFast", "cRef + cAlmLin + dtos( dFecFac ) + tFecFac", {|| Field->cRef + Field->cAlmLin + dtos( Field->dFecFac ) + Field->tFecFac } ) )

      ( dbfRctPrvL )->( ordCondSet( "nCtlStk < 2 .and. !Deleted()", {|| Field->nCtlStk < 2 .AND. !Deleted()}, , , , , , , , , .T. ) )
      ( dbfRctPrvL )->( ordCreate( cPath + "RctPrvL.Cdx", "cStkFastOu", "cRef + cAlmOrigen + dtos( dFecFac ) + tFecFac", {|| Field->cRef + Field->cAlmOrigen + dtos( Field->dFecFac ) + Field->tFecFac } ) )

      ( dbfRctPrvL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfRctPrvL )->( ordCreate( cPath + "RctPrvL.Cdx", "iNumRct", "'04' + CSERFAC + STR( NNUMFAC ) + CSUFFAC", {|| "04" + Field->CSERFAC + STR( Field->NNUMFAC ) + Field->CSUFFAC } ) )

      ( dbfRctPrvL )->( dbCloseArea() )

   else

      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas rectificativas de proveedores" )

   end

   dbUseArea( .T., cDriver, cPath + "RctPrvI.DBF", cCheckArea( "RctPrvI", @cRctPrvT ), .F. )
   if !( cRctPrvT )->( neterr() )
      ( cRctPrvT )->( __dbPack() )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvI.CDX", "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac", {|| Field->cSerFac + STR( Field->nNumFac ) + Field->cSufFac } ) )

      ( cRctPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas rectificativas de proveedores" )
   end

   dbUseArea( .T., cDriver, cPath + "RctPrvD.DBF", cCheckArea( "FacPrvD", @cRctPrvT ), .F. )
   if !( cRctPrvT )->( neterr() )
      ( cRctPrvT )->( __dbPack() )

      ( cRctPrvT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvD.CDX", "nNumFac", "cSerFac + STR( nNumFac ) + cSufFac", {|| Field->cSerFac + STR( Field->nNumFac ) + Field->cSufFac } ) )

      ( cRctPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de facturas rectificativas de proveedores" )
   end

   dbUseArea( .T., cDriver, cPath + "RctPrvS.DBF", cCheckArea( "RctPrvS", @cRctPrvT ), .F. )
   if !( cRctPrvT )->( neterr() )
      ( cRctPrvT )->( __dbPack() )

      ( cRctPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvS.CDX", "nNumFac", "cSerFac + Str( nNumFac ) + cSufFac + Str( nNumLin )", {|| Field->cSerFac + Str( Field->nNumFac ) + Field->cSufFac + Str( Field->nNumLin ) } ) )

      ( cRctPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvS.CDX", "cRefSer", "cRef + cAlmLin + cNumSer", {|| Field->cRef + Field->cAlmLin + Field->cNumSer } ) )

      ( cRctPrvT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cRctPrvT )->( ordCreate( cPath + "RctPrvS.CDX", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( cRctPrvT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de numeros de series de facturas rectificativas de proveedores" )
   end

RETURN NIL



Function aIncRctPrv()

   local aIncFacPrv  := {}

   aAdd( aIncFacPrv, { "cSerFac", "C",    1,  0, "Serie de factura" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "nNumFac", "N",    9,  0, "Número de factura" ,             "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "cSufFac", "C",    2,  0, "Sufijo de factura" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,        "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,  "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "lListo",  "L",    1,  0, "Lógico de listo" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aIncFacPrv, { "lAviso",  "L",    1,  0, "Lógico de aviso" ,               "",                   "", "( cDbfCol )" } )

Return ( aIncFacPrv )



Function aRctPrvDoc()

   local aFacPrvDoc  := {}

   aAdd( aFacPrvDoc, { "cSerFac", "C",    1,  0, "Serie de facturas" ,               "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "nNumFac", "N",    9,  0, "Número de facturas" ,              "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cSufFac", "C",    2,  0, "Sufijo de facturas" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,            "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,              "",                   "", "( cDbfCol )" } )
   aAdd( aFacPrvDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,     "",                   "", "( cDbfCol )" } )

Return ( aFacPrvDoc )



Function aSerRctPrv()

   local aColFacPrv  := {}

   aAdd( aColFacPrv,  { "cSerFac", "C",  1,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "nNumFac", "N",  9,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cSufFac", "C",  2,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "nNumLin", "N",  4,   0, "Número de la línea",               "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cRef",    "C", 18,   0, "Referencia del artículo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cAlmLin", "C", 16,   0, "Código de almacen",                "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "lUndNeg", "L",  1,   0, "Lógico de unidades en negativo",   "",                  "", "( cDbfCol )" } )
   aAdd( aColFacPrv,  { "cNumSer", "C", 30,   0, "Numero de serie",                  "",                  "", "( cDbfCol )" } )

Return ( aColFacPrv )







FUNCTION dFecRctPrv( cFacPrv, cRctPrvT )

   local dFecFac  := Ctod("")

   IF (cRctPrvT)->( dbSeek( cFacPrv ) )
      dFecFac  := (cRctPrvT)->DFECFAC
   end

RETURN ( dFecFac )







FUNCTION tFecRctPrv( cFacPrv, cRctPrvT )

   local tFecFac  := Replicate( "0", 6 )

   IF (cRctPrvT)->( dbSeek( cFacPrv ) )
      tFecFac  := (cRctPrvT)->TFECFAC
   end

RETURN ( tFecFac )






FUNCTION cPrvRctPrv( cFacPrv, cRctPrvT )

   local cCodPrv  := ""

   IF (cRctPrvT)->( dbSeek( cFacPrv ) )
      cCodPrv  := (cRctPrvT)->CCODPRV
   end

RETURN ( cCodPrv )






FUNCTION cNbrRctPrv( cFacPrv, cRctPrvT )

   local cNomPrv  := ""

   IF (cRctPrvT)->( dbSeek( cFacPrv ) )
      cNomPrv  := (cRctPrvT)->CNOMPRV
   end

RETURN ( cNomPrv )



FUNCTION nEstRctPrv( cFacPrv, cRctPrvT, cRctPrvP )

   local nBitmap  := 3

   if ( cRctPrvT )->( dbSeek( cFacPrv ) )
      nBitmap     := ChkPagRctPrv( cRctPrvT, cRctPrvP )
   end

RETURN nBitmap







FUNCTION GenPgoRctPrv( cNumFac, cRctPrvT, cRctPrvL, cRctPrvP, cPrv, cIva, cFPago, cDiv, aTmp )

   local nCobro
   local cCodPgo
   local cSerFac
   local nNumFac
   local cSufFac
   local cDivFac
   local nVdvFac
   local dFecFac
   local cCodPrv
   local cNomPrv
   local cCodUsr
   local cCodCaj
   local nTotal
   local nTotCob
   local nDec
   local nInc        := 0
   local n           := 0
   local nTotAcu     := 0
   local nPlazos     := 0
   local cBanco
   local cPaisIBAN
   local cCtrlIBAN
   local cEntidad
   local cSucursal
   local cControl
   local cCuenta

   if aTmp <> nil
      cSerFac        := aTmp[ 1    ]
      nNumFac        := aTmp[ 2    ]
      cSufFac        := aTmp[ 3    ]
      cDivFac        := aTmp[ 35    ]
      nVdvFac        := aTmp[ 36    ]
      dFecFac        := aTmp[ 5    ]
      cCodPgo        := aTmp[ 23   ]
      cCodPrv        := aTmp[ 6    ]
      cNomPrv        := aTmp[ 9    ]
      cCodUsr        := aTmp[ 46    ]
      cCodCaj        := aTmp[ 8    ]
      cBanco         := aTmp[ 74     ]
      cPaisIBAN      := aTmp[ 75  ]
      cCtrlIBAN      := aTmp[ 76  ]
      cEntidad       := aTmp[ 77    ]
      cSucursal      := aTmp[ 78    ]
      cControl       := aTmp[ 79    ]
      cCuenta        := aTmp[ 80    ]
   else
      cSerFac        := ( cRctPrvT )->cSerFac
      nNumFac        := ( cRctPrvT )->nNumFac
      cSufFac        := ( cRctPrvT )->cSufFac
      cDivFac        := ( cRctPrvT )->cDivFac
      nVdvFac        := ( cRctPrvT )->nVdvFac
      dFecFac        := ( cRctPrvT )->dFecFac
      cCodPgo        := ( cRctPrvT )->cCodPago
      cCodPrv        := ( cRctPrvT )->cCodPrv
      cNomPrv        := ( cRctPrvT )->cNomPrv
      cCodUsr        := ( cRctPrvT )->cCodUsr
      cCodCaj        := ( cRctPrvT )->cCodCaj
      cBanco         := ( cRctPrvT )->cBanco
      cPaisIBAN      := ( cRctPrvT )->cPaisIBAN
      cCtrlIBAN      := ( cRctPrvT )->cCtrlIBAN
      cEntidad       := ( cRctPrvT )->cEntBnc
      cSucursal      := ( cRctPrvT )->cSucBnc
      cControl       := ( cRctPrvT )->cDigBnc
      cCuenta        := ( cRctPrvT )->cCtaBnc
   end





   nTotal            := nTotRctPrv( cNumFac, cRctPrvT, cRctPrvL, cIva, cDiv, cRctPrvP, nil, nil, .F. )
   nTotCob           := nPagRctPrv( cNumFac, cRctPrvP, nil, cDiv, .F. )
   nDec              := nRouDiv( cDivFac, cDiv )

   if nTotal <> nTotCob





      if ( cRctPrvP )->( dbSeek( cNumFac ) )

         while cNumFac == ( cRctPrvP )->cSerFac + Str( ( cRctPrvP )->nNumFac ) + ( cRctPrvP )->cSufFac .AND. !( cRctPrvP )->( eof() )

            if !( cRctPrvP )->lCobrado .AND. dbLock( cRctPrvP )
               ( cRctPrvP )->( dbDelete() )
               ( cRctPrvP )->( dbUnLock() )
            end

            ( cRctPrvP )->( dbSkip() )

         end

      end

      nTotal            -= nPagRctPrv( cNumFac, cRctPrvP, nil, cDiv, .F. )





      if ( cFPago )->( dbSeek( cCodPgo ) )

         nTotAcu        := nTotal
         nPlazos        := Max( ( cFPago )->nPlazos, 1 )

         for n := 1 to nPlazos

            if n <> nPlazos
               nTotAcu  -= Round( nTotal / nPlazos, nDec )
            end

            nInc        := nNewReciboProveedor( cSerFac + Str( nNumFac ) + cSufFac, "R", cRctPrvP )

            ( cRctPrvP )->( dbAppend() )

            ( cRctPrvP )->cSerFac       := cSerFac
            ( cRctPrvP )->nNumFac       := nNumFac
            ( cRctPrvP )->cSufFac       := cSufFac
            ( cRctPrvP )->cCodPrv       := cCodPrv
            ( cRctPrvP )->cNomPrv       := cNomPrv
            ( cRctPrvP )->nNumRec       := nInc
            ( cRctPrvP )->cTipRec       := "R"
            ( cRctPrvP )->nImporte      := if( n <> nPlazos, Round( nTotal / nPlazos, nDec ), Round( nTotAcu, nDec ) )
            ( cRctPrvP )->cTurRec       := cCurSesion()
            ( cRctPrvP )->cDescrip      := "Recibo nº" + AllTrim( Str( nInc ) ) + " de factura rectificativa " + cSerFac  + "/" + allTrim( Str( nNumFac ) ) + "/" + cSufFac
            ( cRctPrvP )->cDivPgo       := cDivFac
            ( cRctPrvP )->nVdvPgo       := nVdvFac
            ( cRctPrvP )->lCobRado      := ( ( cFPago )->nCobRec == 1 )
            ( cRctPrvP )->dPreCob       := dFecFac
            ( cRctPrvP )->dFecVto       := dNexDay( dFecFac + ( cFPago )->nPlaUno + ( ( cFPago )->nDiaPla * ( n - 1 ) ), cPrv )
            ( cRctPrvP )->cCtaRec       := ( cFPago )->cCtaCobro
            ( cRctPrvP )->dFecChg       := GetSysDate()
            ( cRctPrvP )->cTimChg       := Time()
            ( cRctPrvP )->cCodPgo       := cCodPgo
            ( cRctPrvP )->lNotArqueo    := .F.
            ( cRctPrvP )->cCodCaj       := cCodCaj
            ( cRctPrvP )->cCodUsr       := cCodUsr

            if !empty( ( cRctPrvT )->cCtrCoste )
               ( cRctPrvP )->cCtrCoste  := ( cRctPrvT )->cCtrCoste
            endif

            if ( cFPago )->lUtlBnc
               ( cRctPrvP )->cEPaisIBAN := ( cFPago )->cPaisIBAN
               ( cRctPrvP )->cECtrlIBAN := ( cFPago )->cCtrlIBAN
               ( cRctPrvP )->cBncEmp    := ( cFPago )->cBanco
               ( cRctPrvP )->cEntEmp    := ( cFPago )->cEntBnc
               ( cRctPrvP )->cSucEmp    := ( cFPago )->cSucBnc
               ( cRctPrvP )->cDigEmp    := ( cFPago )->cDigBnc
               ( cRctPrvP )->cCtaEmp    := ( cFPago )->cCtaBnc
            end

            ( cRctPrvP )->cPaisIBAN     := cPaisIBAN
            ( cRctPrvP )->cCtrlIBAN     := cCtrlIBAN
            ( cRctPrvP )->cBncPrv       := cBanco
            ( cRctPrvP )->cEntPrv       := cEntidad
            ( cRctPrvP )->cSucPrv       := cSucursal
            ( cRctPrvP )->cDigPrv       := cControl
            ( cRctPrvP )->cCtaPrv       := cCuenta

            if ( cFPago )->nCobRec == 1
               ( cRctPrvP )->dEntrada   := dNexDay( dFecFac + ( cFPago )->nPlaUno + ( ( cFPago )->nDiaPla * ( n - 1 ) ), cPrv )
            end

            ( cRctPrvP )->( dbUnLock() )

         next

      end

   end

RETURN NIL






function nTotVRctPrv( cCodArt, cRctPrvL, nDinDiv, nDirDiv )

   local nTotVta  := 0
   local nRecno   := ( cRctPrvL )->( Recno() )

   if ( cRctPrvL )->( dbSeek( cCodArt ) )

      while ( cRctPrvL )->cRef == cCodArt .AND. !( cRctPrvL )->( eof() )

         nTotVta  += nTotLRctPrv( cRctPrvL, nDinDiv, nDirDiv )

         ( cRctPrvL )->( dbSkip() )

      end

   end

   ( cRctPrvL )->( dbGoTo( nRecno ) )

return ( nTotVta )






function nTotDRctPrv( cCodArt, cRctPrvL, cCodAlm )

   local nTotVta  := 0
   local nRecno   := ( cRctPrvL )->( Recno() )

   if ( cRctPrvL )->( dbSeek( cCodArt ) )

      while ( cRctPrvL )->CREF == cCodArt .AND. !( cRctPrvL )->( eof() )

         if cCodAlm <> nil
            if cCodAlm == ( cRctPrvL )->cAlmLin
               nTotVta  += nTotNRctPrv( cRctPrvL )
            end
         else
            nTotVta     += nTotNRctPrv( cRctPrvL )
         end

         ( cRctPrvL )->( dbSkip() )

      end

   end

   ( cRctPrvL )->( dbGoTo( nRecno ) )

return ( nTotVta )







FUNCTION lConRctPrv( cFacPrv, cRctPrvT )

   local lConFac  := .F.

   IF ( cRctPrvT )->( dbSeek( cFacPrv ) )
      lConFac     := ( cRctPrvT )->LCONTAB
   end

RETURN ( lConFac )







FUNCTION dPrvRctPrv( cFacPrv, cRctPrvT )

   local cCodPrv  := ""

   IF ( cRctPrvT )->( dbSeek( cFacPrv ) )
      cCodPrv     := (cRctPrvT)->cCodPrv
   end

RETURN ( cCodPrv )







FUNCTION cPgoRctPrv( cFacPrv, cRctPrvT )

   local cCodPgo  := ""

   IF ( cRctPrvT )->( dbSeek( cFacPrv ) )
      cCodPgo     := ( cRctPrvT )->cCodPago
   end

RETURN ( cCodPgo )



FUNCTION cNomRctPrv( cFacPrv, cRctPrvT )

   local cNomPrv := ""

   IF ( cRctPrvT )->( dbSeek( cFacPrv ) )
      cNomPrv  := ( cRctPrvT )->cNomPrv
   end

RETURN ( cNomPrv )



FUNCTION cCodRctPrv( cFacPrv, uFacPrvT )

   local cCodPrv := ""

   if ValType( uFacPrvT ) == "O"

      if uFacPrvT:Seek( cFacPrv )
         cCodPrv  := uFacPrvT:cCodPrv
      end

   else

      if ( uFacPrvT )->( dbSeek( cFacPrv ) )
         cCodPrv  := ( uFacPrvT )->cCodPrv
      end

   end

RETURN ( cCodPrv )



function dFecVtoRct( nVto )

   local dVto     := Ctod( "  /  /  " )

   If( nVto == nil, nVto := 1, ) ;

   if nVto <= len( aDatVcto )
      dVto        := aDatVcto[ nVto ]
   end

return ( dVto )



function nImpVtoRct( nVto )

   local nImp     := 0

   If( nVto == nil, nVto := 1, ) ;

   if nVto <= len( aImpVcto )
      nImp        := aImpVcto[ nVto ]
   end

return ( nImp )







FUNCTION nNetLFacRct( uFacPrvL, uFacPrvT, nDec, nRec, nVdv, cPirDiv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nRec == nil, nRec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nNetURctPrv( uFacPrvL, nDec, nRec, nVdv )

   nCalculo       *= nTotNRctPrv( uFacPrvL )





   if ValType( uFacPrvL ) == "A"

      if uFacPrvL[ 8 ]<> 0
         nCalculo    -= nCalculo * uFacPrvL[ 8 ] / 100
      end

   else

      if ( uFacPrvL )->nDto <> 0
         nCalculo    -= nCalculo * ( uFacPrvL )->nDto / 100
      end

   end

   nCalculo          := Round( nCalculo, nRec )

RETURN ( if( cPirDiv <> NIL, Trans( nCalculo, cPirDiv ), nCalculo ) )



FUNCTION nBrtLRctPrv( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo := 0

   If( nDec == nil, nDec := 2, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotURctPrv( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo       *= nTotNRctPrv( uTmpLin )

   nCalculo       := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION cProFacRct( cFacPro, cRctPrvT )

   local cCodPro := ""

   IF ( cRctPrvT )->( dbSeek( cFacPro ) )
      cCodPro  := ( cRctPrvT )->CCODPRO
   end

RETURN ( cCodPro )



FUNCTION nTotNRctPrv( uDbf )

   local nTotUnd

   If( uDbf == nil, uDbf := D():FacturasRectificativasProveedoresLineas( nView ), ) ;

   do case
      case ValType( uDbf ) == "A"
         nTotUnd  := uDbf[ 13 ]
         nTotUnd  *= NotBulto( uDbf[ 90 ] )
         nTotUnd  *= NotCaja( uDbf[ 10 ] )
         nTotUnd  *= NotCero( uDbf[ 64 ] )
         nTotUnd  *= NotCero( uDbf[ 85 ] )
         nTotUnd  *= NotCero( uDbf[ 86 ] )
         nTotUnd  *= NotCero( uDbf[ 87 ] )

      case ValType( uDbf ) == "O"
         nTotUnd  := uDbf:nUniCaja
         nTotUnd  *= NotBulto( uDbf:nBultos )
         nTotUnd  *= NotCaja( uDbf:nCanEnt )
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )

      otherwise
         nTotUnd  := ( uDbf )->nUniCaja
         nTotUnd  *= NotBulto( ( uDbf )->nBultos )
         nTotUnd  *= NotCaja( ( uDbf )->nCanEnt )
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )

   end

RETURN ( nTotUnd )



FUNCTION nIvaURctPrv( dbfTmp, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotURctPrv( dbfTmp, nDec, nVdv )

   if !( dbfTmp )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmp )->nIva / 100
   end

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nIvaLRctPrv( dbfLin, nDec, nRou, nVdv, cPorDiv )

   local nCalculo

   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRou == nil, nRou := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotLRctPrv( dbfLin, nDec, nRou, nVdv )

   if !( dbfLin )->lIvaLin
      nCalculo    := nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )







FUNCTION aTotRctPrv( cFactura, cRctPrvT, cRctPrvL, cIva, cDiv, cRctPrvP, cDivRet )

   nTotRctPrv( cFactura, cRctPrvT, cRctPrvL, cIva, cDiv, cRctPrvP, nil, cDivRet )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotFac, aTotIva, nTotRet } )



Function sTotRctPrv( cFactura, cRctPrvT, cRctPrvL, cIva, cDiv, cRctPrvP, cDivRet )

   local sTotal

   nTotRctPrv( cFactura, cRctPrvT, cRctPrvL, cIva, cDiv, cRctPrvP, nil, cDivRet )

   sTotal                                 := sTotal()
   sTotal:nTotalBruto                     := nTotBrt
   sTotal:nTotalNeto                      := nTotNet
   sTotal:nTotalIva                       := nTotIva
   sTotal:aTotalIva                       := aTotIva
   sTotal:nTotalRecargoEquivalencia       := nTotReq
   sTotal:nTotalDocumento                 := nTotFac
   sTotal:nTotalDescuentoGeneral          := nTotDto
   sTotal:nTotalDescuentoProntoPago       := nTotDpp
   sTotal:nTotalDescuentoUno              := nTotUno
   sTotal:nTotalDescuentoDos              := nTotDos

Return ( sTotal )



function aItmRctPrv()

   local aItmFacPrv  := {}

   aAdd( aItmFacPrv, { "CSERFAC"    ,"C",  1, 0, "Serie de factura"                         ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NNUMFAC"    ,"N",  9, 0, "Número de factura"                        ,            "'999999999'",        "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CSUFFAC"    ,"C",  2, 0, "Sufijo de factura"                        ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CTURFAC"    ,"C",  6, 0, "Sesión del factura"                       ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "DFECFAC"    ,"D",  8, 0, "Fecha de la factura"                      ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CCODPRV"    ,"C", 12, 0, "Código del proveedor"                     ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CCODALM"    ,"C", 16, 0, "Código de almacen"                        ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CCODCAJ"    ,"C",  3, 0, "Código de caja"                           ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CNOMPRV"    ,"C",150, 0, "Nombre del proveedor"                     ,            "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CDIRPRV"    ,"C",200, 0, "Domicilio del proveedor"                  ,            "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CPOBPRV"    ,"C",200, 0, "Población del proveedor"                  ,            "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CPROVPROV"  ,"C",100, 0, "Provincia del proveedor"                  ,            "'@!'",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CPOSPRV"    ,"C",  5, 0, "Código postal del proveedor"              ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CDNIPRV"    ,"C", 30, 0, "DNI/CIF del proveedor"                    ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "LLIQUIDADA" ,"L",  1, 0, "Lógico de la liquidación"                 ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "LCONTAB"    ,"L",  1, 0, "Lógico de la contabilización"             ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "DFECENT"    ,"D",  8, 0, "Fecha de entrada"                         ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CSUPED"     ,"C", 10, 0, "Su pedido"                                ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CCONDENT"   ,"C", 20, 0, "Condición de entrada"                     ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "MCOMENT"    ,"M", 10, 0, "Comentarios"                              ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CEXPED"     ,"C", 20, 0, "Expedición"                               ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "COBSERV"    ,"C", 20, 0, "Observaciones"                            ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CCODPAGO"   ,"C",  2, 0, "Codigo del tipo de pago"                  ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NBULTOS"    ,"N",  3, 0, "Número de bultos"                         ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NPORTES"    ,"N",  6, 0, "Valor de los portes"                      ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cNumFac"    ,"C", 12, 0, "Número de la factura"                     ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "LIMPALB"    ,"L",  1, 0, "Factura importada desde albaranes"        ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CDTOESP"    ,"C", 50, 0, "Descripción de descuento especial"        ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NDTOESP"    ,"N",  5, 2, "Porcentaje de descuento especial"         ,            "'@EZ 99.99'",        "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CDPP"       ,"C", 50, 0, "Descripción descuento por pronto pago"    ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NDPP"       ,"N",  5, 2, "Porcentaje de descuento por pronto pago"  ,            "'@EZ 99.99'",        "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "LRECARGO"   ,"L",  1, 0, "Lógico para recargo"                      ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NIRPF"      ,"N",  4, 1, "Porcentaje de IRPF"                       ,            "'@EZ 99.99'",        "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CCODAGE"    ,"C",  3, 0, "Código del agente"                        ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CDIVFAC"    ,"C",  3, 0, "Código de divisa"                         ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NVDVFAC"    ,"N", 13, 6, "Valor del cambio de la divisa"            ,            "'@E 999,999.999999'","", "( cDbf )"} )
   aAdd( aItmFacPrv, { "LSNDDOC"    ,"L",  1, 0, "Enviar documento por internet"            ,            "",                   "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CDTOUNO"    ,"C", 25, 0, "Descripción de primer descuento personalizado",        "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NDTOUNO"    ,"N",  5, 2, "Porcentaje de primer descuento personalizado",         "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CDTODOS"    ,"C", 25, 0, "Descripción de segundo descuento personalizado",       "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "NDTODOS"    ,"N",  5, 2, "Porcentaje de segundo descuento personalizado",        "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CCODPRO"    ,"C",  9, 0, "Código de proyecto en contabilidad",                   "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "LRECDOC"    ,"L",  1, 0, "Documento recibido por internet"          ,            "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "LCLOFAC"    ,"L",  1, 0, ""                                         ,            "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "CNUMDOC"    ,"C", 20, 0, "Número de documento"                      ,            "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cCodUsr"    ,"C",  3, 0, "Código de usuario",                                    "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "lImprimido" ,"L",  1, 0, "Lógico de imprimido del documento",                    "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "dFecImp"    ,"D",  8, 0, "Última fecha de impresión del documento",              "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cHorImp"    ,"C",  5, 0, "Hora de la última impresión del documento",            "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nTipRet"    ,"N",  1, 0, "Tipo de retención ( 1. Base / 2. Base+IVA )",          "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nPctRet"    ,"N",  6, 2, "Porcentaje de retención",                              "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "dFecChg"    ,"D",  8, 0, "Fecha de modificación del documento",                  "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cTimChg"    ,"C",  5, 0, "Hora de modificación del documento",                   "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cCodDlg"    ,"C",  2, 0, "Código delegación",                                    "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nRegIva"    ,"N",  1, 0, "Régimen de " + cImp(),                                 "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "lFacGas"    ,"L",  1, 0, "Lógico factura de gastos",                             "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "mComGas"    ,"M", 10, 0, "Comentario de gastos",                                 "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nNetGas1"   ,"N", 16, 6, "Neto de fac. de gastos 1",                             "cPirDivFac",     "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nNetGas2"   ,"N", 16, 6, "Neto de fac. de gastos 2",                             "cPirDivFac",     "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nNetGas3"   ,"N", 16, 6, "Neto de fac. de gastos 3",                             "cPirDivFac",     "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nIvaGas1"   ,"N",  6, 2, "Porcentaje " + cImp() + " 1 de gastos",                "'@EZ 99.99'",    "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nIvaGas2"   ,"N",  6, 2, "Porcentaje " + cImp() + " 2 de gastos",                "'@EZ 99.99'",    "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nIvaGas3"   ,"N",  6, 2, "Porcentaje " + cImp() + " 3 de gastos",                "'@EZ 99.99'",    "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nReGas1"    ,"N",  6, 2, "Porcentaje R.E. 1 de gastos",                          "'@EZ 99.99'",    "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nReGas2"    ,"N",  6, 2, "Porcentaje R.E. 2 de gastos",                          "'@EZ 99.99'",    "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nReGas3"    ,"N",  6, 2, "Porcentaje R.E. 3 de gastos",                          "'@EZ 99.99'",    "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cMotRec"    ,"C",250, 0, "Motivo de la factura rectificativa",                   "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cCauRec"    ,"C",250, 0, "Causa de la factura rectificativa",                    "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nTotNet"    ,"N", 16, 6, "Total neto",                                           "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nTotIva"    ,"N", 16, 6, "Total " + cImp(),                                      "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nTotReq"    ,"N", 16, 6, "Total recargo",                                        "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nTotFac"    ,"N", 16, 6, "Total factura rectificativa",                          "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "nTotSup"    ,"N", 16, 6, "Total gastos suplidos",                                "",               "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cBanco"     ,"C", 50, 0, "Nombre del banco del proveedor" ,                      "",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cPaisIBAN"  ,"C",  2, 0, "País IBAN de la cuenta bancaria del cliente",         "",                "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cCtrlIBAN"  ,"C",  2, 0, "Dígito de control IBAN de la cuenta bancaria del cliente", "",           "", "( cDbf )"} )
   aAdd( aItmFacPrv, { "cEntBnc"    ,"C",  4, 0, "Entidad de la cuenta bancaria del proveedor" ,         "",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cSucBnc"    ,"C",  4, 0, "Sucursal de la cuenta bancaria del proveedor" ,        "",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cDigBnc"    ,"C",  2, 0, "Dígito de control de la cuenta bancaria del proveedor","",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cCtaBnc"    ,"C", 10, 0, "Cuenta bancaria del proveedor" ,                       "",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "tFecFac"    ,"C",  6, 0, "Hora de la Factura rectificativa" ,                    "",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cCtrCoste"  ,"C",  9, 0, "Código del centro de coste",                           "",               "", "( cDbf )", nil } )
   aAdd( aItmFacPrv, { "cAlmOrigen" ,"C", 16, 0, "Almacén de origen de la mercancía" ,                   "",               "", "( cDbf )", nil } )

return ( aItmFacPrv )



function aColRctPrv()

   local aColFacPrv  := {}

   aAdd( aColFacPrv, { "CSERFAC"    ,"C",  1, 0, "Serie de factura"            ,"",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NNUMFAC"    ,"N",  9, 0, "Número de factura"           ,"'999999999'",         "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CSUFFAC"    ,"C",  2, 0, "Sufijo de factura"           ,"",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CREF"       ,"C", 18, 0, "Referencia artículo"         ,"",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CREFPRV"    ,"C", 20, 0, "Referencia del proveedor"    ,"",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CDETALLE"   ,"C",250, 0, "Detalle de articulo"         ,"",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NPREUNIT"   ,"N", 16, 6, "Precio unitario"             ,"cPinDivFac",          "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NDTO"       ,"N",  6, 2, ""                            ,"'@E 99,99'",          "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NIVA"       ,"N",  6, 2, "Porcentaje de " + cImp()     ,"'@E 99,99'",          "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NCANENT"    ,"N", 16, 6, "Cantidad recibida"           ,"MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "LCONTROL"   ,"L",  1, 0, "Control reservado"           ,"",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CUNIDAD"    ,"C",  2, 0, "Unidad de venta"             ,"",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NUNICAJA"   ,"N", 16, 6, "Unidades por caja"           ,"MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "LCHGLIN"    ,"L",  1, 0, "Cambio de precio"            ,"",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "MLNGDES"    ,"M", 10, 0, ""                            ,""          ,          "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NDTOLIN"    ,"N",  6, 2, "Descuento lineal"            ,"'@E 999,99'",         "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NDTOPRM"    ,"N",  6, 2, "Descuento por promoción"     ,"'@E 999,99'",         "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NDTORAP"    ,"N",  6, 2, "Descuento por rappels"       ,"'@E 999,99'",         "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NPRECOM"    ,"N", 16, 6, "Precio de compra"            ,"cPinDivFac",          "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "LBNFLIN1"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "LBNFLIN2"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "LBNFLIN3"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "LBNFLIN4"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "LBNFLIN5"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "LBNFLIN6"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFLIN1"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFLIN2"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFLIN3"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFLIN4"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFLIN5"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFLIN6"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFSBR1"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFSBR2"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFSBR3"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFSBR4"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFSBR5"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "NBNFSBR6"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "NPVPLIN1"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NPVPLIN2"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NPVPLIN3"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NPVPLIN4"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NPVPLIN5"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NPVPLIN6"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NIVALIN1"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NIVALIN2"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NIVALIN3"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NIVALIN4"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NIVALIN5"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NIVALIN6"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aColFacPrv, { "NIVALIN"    ,"N",  6, 2, "" }                                                                      )
   aAdd( aColFacPrv, { "LIVALIN"    ,"L",  1, 0, "" }                                                                      )
   aAdd( aColFacPrv, { "CCODPR1"    ,"C", 20, 0, "Código de la propiedad 1",     "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CCODPR2"    ,"C", 20, 0, "Código de la propiedad 2",     "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CVALPR1"    ,"C", 20, 0, "Valor de la propiedad 1" ,     "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CVALPR2"    ,"C", 20, 0, "Valor de la propiedad 2" ,     "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NFACCNV"    ,"N", 16, 6, "Factor de conversión de la compra", "",               "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CALMLIN"    ,"C", 16, 0, "Código del almacen" ,          "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NCTLSTK"    ,"N",  1, 0, "Tipo de stock de la línea",    "'9'",                 "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "LLOTE"      ,"L",  1, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NLOTE"      ,"N",  9, 0, "",                             "'999999999'",         "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "cLote"      ,"C", 64, 0, "Número de lote",               "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "dFecCad"    ,"D",  8, 0, "Fecha de caducidad",           "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NNUMLIN"    ,"N",  4, 0, "Número de la línea",           "9999",                "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NUNDKIT"    ,"N", 16, 6, "Unidades del producto kit",    "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "LKITART"    ,"L",  1, 0, "Línea con escandallo",         "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "LKITCHL"    ,"L",  1, 0, "Línea pertenciente a escandallo", "",                 "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "LKITPRC"    ,"L",  1, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "LIMPLIN"    ,"L",  1, 0, "Imprimir linea",               "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "MNUMSER"    ,"M", 10, 0, "" ,                            "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CCODUBI1"   ,"C",  5, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CCODUBI2"   ,"C",  5, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CCODUBI3"   ,"C",  5, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CVALUBI1"   ,"C",  5, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CVALUBI2"   ,"C",  5, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CVALUBI3"   ,"C",  5, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CNOMUBI1"   ,"C", 30, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CNOMUBI2"   ,"C", 30, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CNOMUBI3"   ,"C", 30, 0, "",                             "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CCODFAM"    ,"C", 16, 0, "Código de familia",            "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "CGRPFAM"    ,"C",  3, 0, "Código del grupo de familia",  "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "NREQ"       ,"N", 16, 6, "Recargo de equivalencia",      "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "MOBSLIN"    ,"M", 10, 0, "Observacion de línea",         "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nPvpRec"    ,"N", 16, 6, "Precio de venta recomendado",  "cPinDivFac",          "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nNumMed"    ,"N",  1, 0, "Número de mediciones",         "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nMedUno"    ,"N", 16, 6, "Primera unidad de medición",   "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nMedDos"    ,"N", 16, 6, "Segunda unidad de medición",   "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nMedTre"    ,"N", 16, 6, "Tercera unidad de medición",   "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "lGasSup"    ,"L",  1, 0, "Linea de gastos suplidos",     "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "dFecFac"    ,"D",  8, 0, "Fecha de la factura",          "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nBultos"    ,"N", 16, 6, "Numero de bultos en líneas",   "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "cFormato"   ,"C",100, 0, "Formato de compra",            "",                    "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "cCodImp"    ,"C",  3, 0, "Código de impuesto especial",  "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "nValImp"    ,"N", 16, 6, "Importe de impuesto especial", "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "tFecFac"    ,"C",  6, 0, "Hora de la Factura" ,          "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "cCtrCoste"  ,"C",  9, 0, "Código del centro de coste" ,  "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "cAlmOrigen" ,"C", 16, 0, "Almacén de origen de la mercancía", "",              "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cRefAux"    ,"C", 18, 0, "Referencia auxiliar",          "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "cRefAux2"   ,"C", 18, 0, "Segunda referencia auxiliar",  "",                   "", "( cDbfCol )" } )
   aAdd( aColFacPrv, { "cTipCtr"    ,"C", 20, 0, "Tipo tercero centro de coste", "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "cTerCtr"    ,"C", 20, 0, "Tercero centro de coste" ,     "",                   "", "( cDbfCol )", nil } )
   aAdd( aColFacPrv, { "lValidado"  ,"L",  1, 0, "Lógico validado con consolidación", "",              "", "( cDbfCol )", .F. } )

Return ( aColFacPrv )



Function SynRctPrv( cPath )

   local oBlock
   local oError
   local aTotFac
   local hConsolidacion

   If( cPath == nil, cPath := cPatEmp(), ) ;

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvT.DBF" ), ( cCheckArea( "FACPRVT", @dbfRctPrvT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "FACPRVL", @dbfRctPrvL ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvI.DBF" ), ( cCheckArea( "FACPRVI", @dbfRctPrvI ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvD.DBF" ), ( cCheckArea( "FACPRVD", @dbfRctPrvD ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvD.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvS.DBF" ), ( cCheckArea( "FACPRVS", @dbfRctPrvS ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVP.DBF" ), ( cCheckArea( "FACPRVP", @dbfRctPrvP ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ( dbfRctPrvP )->( OrdSetFocus( "rNumFac" ) )

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROVEE.DBF" ), ( cCheckArea( "PROVEE", @dbfPrv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "PROVEE.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end



   ( dbfRctPrvT )->( OrdSetFocus( 0 ) )
   ( dbfRctPrvT )->( dbGoTop() )

   while !( dbfRctPrvT )->( eof() )

      if empty( ( dbfRctPrvT )->cSufFac )
         ( dbfRctPrvT )->cSufFac := "00"
      end

      if !empty( ( dbfRctPrvT )->cNumFac ) .AND. Len( AllTrim( ( dbfRctPrvT )->cNumFac ) ) <> 12
         ( dbfRctPrvT )->cNumFac := AllTrim( ( dbfRctPrvT )->cNumFac ) + "00"
      end

      if empty( ( dbfRctPrvT )->cCodCaj )
         ( dbfRctPrvT )->cCodCaj := "000"
      end

      ( dbfRctPrvT )->( dbSkip() )

   end

   ( dbfRctPrvT )->( OrdSetFocus( 1 ) )



   ( dbfRctPrvL )->( OrdSetFocus( 0 ) )
   ( dbfRctPrvL )->( dbGoTop() )

   while !( dbfRctPrvL )->( eof() )

      if empty( ( dbfRctPrvL )->cSufFac )
         ( dbfRctPrvL )->cSufFac := "00"
      end

      if empty( ( dbfRctPrvL )->cLote ) .AND. !empty( ( dbfRctPrvL )->nLote )
         ( dbfRctPrvL )->cLote   := AllTrim( Str( ( dbfRctPrvL )->nLote ) )
      end

      if !empty( ( dbfRctPrvL )->cRef ) .AND. empty( ( dbfRctPrvL )->cCodFam )
         ( dbfRctPrvL )->cCodFam := RetFamArt( ( dbfRctPrvL )->cRef, dbfArticulo )
      end

      if !empty( ( dbfRctPrvL )->cRef ) .AND. !empty( ( dbfRctPrvL )->cCodFam )
         ( dbfRctPrvL )->cGrpFam := cGruFam( ( dbfRctPrvL )->cCodFam, dbfFamilia )
      end

      if empty( ( dbfRctPrvL )->nReq )
         ( dbfRctPrvL )->nReq    := nPReq( dbfIva, ( dbfRctPrvL )->nIva )
      end

      if empty( ( dbfRctPrvL )->cAlmLin )
         ( dbfRctPrvL )->cAlmLin := RetFld( ( dbfRctPrvL )->cSerRct + Str( ( dbfRctPrvL )->nNumRct ) + ( dbfRctPrvL )->cSufRct, dbfRctPrvT, "cCodAlm" )
      end

      ( dbfRctPrvL )->( dbSkip() )

      SysRefresh()

   end

   ( dbfRctPrvL )->( OrdSetFocus( 1 ) )



   ( dbfRctPrvP )->( OrdSetFocus( 0 ) )
   ( dbfRctPrvP )->( dbGoTop() )

      while !( dbfRctPrvP )->( eof() )

         if empty( ( dbfRctPrvP )->cSufFac )
            ( dbfRctPrvP )->cSufFac := "00"
         end

         if empty( ( dbfRctPrvP )->cCodCaj )
            ( dbfRctPrvP )->cCodCaj := "000"
         end

         ( dbfRctPrvP )->( dbSkip() )

         SysRefresh()

      end

   ( dbfRctPrvP )->( OrdSetFocus( 1 ) )



   ( dbfRctPrvI )->( OrdSetFocus( 0 ) )
   ( dbfRctPrvI )->( dbGoTop() )

   while !( dbfRctPrvI )->( eof() )

      if empty( ( dbfRctPrvI )->cSufFac )
         ( dbfRctPrvI )->cSufFac := "00"
      end

      ( dbfRctPrvI )->( dbSkip() )

      SysRefresh()

   end

   ( dbfRctPrvI )->( OrdSetFocus( 1 ) )





      ( dbfRctPrvT )->( ordSetFocus( 1 ) )
      ( dbfRctPrvT )->( dbGoTop() )

      while !( dbfRctPrvT )->( eof() )

         if ( dbfRctPrvT )->nTotFac == 0

            aTotFac                 := aTotRctPrv( ( dbfRctPrvT )->cSerFac + Str( ( dbfRctPrvT )->nNumFac ) + ( dbfRctPrvT )->cSufFac, dbfRctPrvT, dbfRctPrvL, dbfIva, dbfDiv, dbfRctPrvP, ( dbfRctPrvT )->cDivFac )

            ( dbfRctPrvT )->nTotNet := aTotFac[1]
            ( dbfRctPrvT )->nTotIva := aTotFac[2]
            ( dbfRctPrvT )->nTotReq := aTotFac[3]
            ( dbfRctPrvT )->nTotFac := aTotFac[4]

            ( dbfRctPrvT )->( dbUnLock() )

         end

         ( dbfRctPrvT )->( dbSkip() )

         SysRefresh()

      end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfRctPrvT )->( dbCloseArea() )
   ( dbfRctPrvL )->( dbCloseArea() )
   ( dbfRctPrvI )->( dbCloseArea() )
   ( dbfRctPrvD )->( dbCloseArea() )
   ( dbfRctPrvS )->( dbCloseArea() )
   ( dbfRctPrvP )->( dbCloseArea() )
   ( dbfPrv     )->( dbCloseArea() )
   ( dbfIva     )->( dbCloseArea() )
   ( dbfFPago   )->( dbCloseArea() )
   ( dbfDiv     )->( dbCloseArea() )
   ( dbfCajT    )->( dbCloseArea() )
   ( dbfFamilia )->( dbCloseArea() )
   ( dbfArticulo)->( dbCloseArea() )

return nil



Function AppRctPrv( cCodPrv, cCodArt, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if RctPrv( nil, nil, cCodPrv, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         WinAppRec( nil, bEdtRec, D():FacturasRectificativasProveedores( nView ), cCodPrv, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



FUNCTION EdtRctPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if RctPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            nTotRctPrv()
            WinEdtRec( nil, bEdtRec, D():FacturasRectificativasProveedores( nView ) )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION ZooRctPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if RctPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            nTotRctPrv()
            WinZooRec( nil, bEdtRec, D():FacturasRectificativasProveedores( nView ) )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION DelRctPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 16 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if RctPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            WinDelRec( nil, D():FacturasRectificativasProveedores( nView ), {|| QuiRctPrv() } )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            WinDelRec( nil, D():FacturasRectificativasProveedores( nView ), {|| QuiRctPrv() } )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

Return nil



FUNCTION PrnRctPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if RctPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            GenRctPrv( 1 )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            nTotRctPrv()
            GenRctPrv( 1 )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

RETURN NIL



FUNCTION VisRctPrv( nNumFac, lOpenBrowse )

   local nLevel         := Auth():Level( "rectificativas_de_proveedores" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if RctPrv()
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            GenRctPrv( 2 )
         else
            MsgStop( "No se encuentra factura" )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( nNumFac, "nNumFac", D():FacturasRectificativasProveedores( nView ) )
            nTotRctPrv()
            GenRctPrv( 2 )
         else
            MsgStop( "No se encuentra factura" )
         end
         CloseFiles()
      end

   end

Return nil



Function IsRctPrv( cPath )

   If( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "RctPrvT.Dbf" )
      dbCreate( cPath + "RctPrvT.Dbf", aSqlStruct( aItmRctPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "RctPrvL.Dbf" )
      dbCreate( cPath + "RctPrvL.Dbf", aSqlStruct( aColRctPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "RctPrvI.Dbf" )
      dbCreate( cPath + "RctPrvI.Dbf", aSqlStruct( aIncRctPrv() ), cDriver() )
   end

   if !lExistTable( cPath + "RctPrvD.Dbf" )
      dbCreate( cPath + "RctPrvD.Dbf", aSqlStruct( aFacPrvDoc() ), cDriver() )
   end




   if !lExistIndex( cPath + "RctPrvT.Cdx" ) .OR.  !lExistIndex( cPath + "RctPrvL.Cdx" ) .OR.  !lExistIndex( cPath + "RctPrvI.Cdx" ) .OR.  !lExistIndex( cPath + "RctPrvD.Cdx" )

      rxRctPrv( cPath )

   end

Return ( nil )



FUNCTION cPrpRctPrv( cFacPrvL )

   local cReturn     := ""

   If( cFacPrvL == nil, cFacPrvL := if( !empty( tmpRctPrvL ), tmpRctPrvL, D():FacturasRectificativasProveedoresLineas( nView ) ), ) ;

   cReturn           += Alltrim( ( cFacPrvL )->cRef )

   if !empty( ( cFacPrvL )->cValPr1 )
      cReturn        += "."
      cReturn        += Alltrim( ( cFacPrvL )->cValPr1 )
   end

   if !empty( ( cFacPrvL )->cValPr2 )
      cReturn        += "."
      cReturn        += Alltrim( ( cFacPrvL )->cValPr2 )
   end

RETURN ( cReturn )








FUNCTION cDesRctPrv( cFacPrvL, cFacPrvS )

   If( cFacPrvL == nil, cFacPrvL := D():FacturasRectificativasProveedoresLineas( nView ), ) ;
   If( cFacPrvS == nil, cFacPrvS := D():FacturasRectificativasProveedoresDocumentos( nView ), ) ;

RETURN ( Descrip( cFacPrvL, cFacPrvS ) )



FUNCTION cDesRctPrvLeng( cFacPrvL, cFacPrvS, cArtLeng )

   If( cFacPrvL == nil, cFacPrvL := D():FacturasRectificativasProveedoresLineas( nView ), ) ;
   If( cFacPrvS == nil, cFacPrvS := D():FacturasRectificativasProveedoresDocumentos( nView ), ) ;
   If( cArtLeng == nil, cArtLeng := D():ArticuloLenguaje( nView ), ) ;

RETURN ( DescripLeng( cFacPrvL, cFacPrvS, cArtLeng ) )



Function cCtaRctPrv( cRctPrvT, cRctPrvP, cBncPrv )

   local cCtaRctPrv  := ""

   If( cRctPrvT == nil, cRctPrvT := D():FacturasRectificativasProveedores( nView ), ) ;
   If( cRctPrvP == nil, cRctPrvP := D():FacturasProveedoresPagos( nView ), ) ;
   If( cBncPrv == nil, cBncPrv := D():BancosProveedores( nView ), ) ;

   cCtaRctPrv        := Rtrim( ( cRctPrvT )->cPaisIBAN + ( cRctPrvT )->cCtrlIBAN + ( cRctPrvT )->cEntBnc + ( cRctPrvT )->cSucBnc + ( cRctPrvT )->cDigBnc + ( cRctPrvT )->cCtaBnc )

   if empty( cCtaRctPrv )
      if dbSeekInOrd( ( cRctPrvT )->cSerFac + Str( ( cRctPrvT )->nNumFac ) + ( cRctPrvT )->cSufFac, "nNumFac", cRctPrvP )
         cCtaRctPrv  := cProveeCuenta( ( cRctPrvP )->cCodPrv, cBncPrv )
      end
   end

Return ( cCtaRctPrv )







FUNCTION nTotLRctPrv( uFacPrvL, nDec, nRec, nVdv, cPirDiv )

   local nCalculo
   local nDtoLin
   local nDtoPrm

   If( uFacPrvL == nil, uFacPrvL := D():FacturasRectificativasProveedoresLineas( nView ), ) ;
   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRec == nil, nRec := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotURctPrv( uFacPrvL, nDec, nVdv )

   do case
   case ValType( uFacPrvL ) == "A"
      nDtoLin     := uFacPrvL[ 16 ]
      nDtoPrm     := uFacPrvL[ 17 ]
   case ValType( uFacPrvL ) == "C"
      nDtoLin     := ( uFacPrvL )->nDtoLin
      nDtoPrm     := ( uFacPrvL )->nDtoPrm
   case ValType( uFacPrvL ) == "O"
      nDtoLin     := uFacPrvL:nDtoLin
      nDtoPrm     := uFacPrvL:nDtoPrm
   end

   if nDtoLin <> 0
      nCalculo    -= nCalculo * nDtoLin / 100
   end

   if nDtoPrm <> 0
      nCalculo    -= nCalculo * nDtoPrm / 100
   end

   nCalculo       *= nTotNRctPrv( uFacPrvL )

   if nRec <> nil
      nCalculo       := Round( nCalculo, nRec )
   end

RETURN ( if( cPirDiv <> NIL, Trans( nCalculo, cPirDiv ), nCalculo ) )







FUNCTION nDtoLRctPrv( cRctPrvL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cRctPrvL == nil, cRctPrvL := D():FacturasRectificativasProveedoresLineas( nView ), ) ;
   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRou == nil, nRou := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cRctPrvL )->nDtoLin <> 0

      nCalculo          := nTotURctPrv( cRctPrvL, nDec ) * nTotNRctPrv( cRctPrvL )





      nCalculo          := nCalculo * ( cRctPrvL )->nDtoLin / 100

      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )






FUNCTION nPrmLRctPrv( cRctPrvL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cRctPrvL == nil, cRctPrvL := D():FacturasRectificativasProveedoresLineas( nView ), ) ;
   If( nDec == nil, nDec := nDinDiv(), ) ;
   If( nRou == nil, nRou := nRinDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cRctPrvL )->nDtoPrm <> 0

      nCalculo          := nTotURctPrv( cRctPrvL, nDec ) * nTotNRctPrv( cRctPrvL )





      if ( cRctPrvL )->nDtoLin <> 0
         nCalculo       -= nCalculo * ( cRctPrvL )->nDtoLin / 100
      end

      nCalculo          := nCalculo * ( cRctPrvL )->nDtoPrm / 100

      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )



FUNCTION nTotURctPrv( uFacPrvL, nDec, nVdv, cPinDiv )

   local nCalculo

   If( uFacPrvL == nil, uFacPrvL := D():FacturasRectificativasProveedoresLineas( nView ), ) ;
   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   do case
   case ValType( uFacPrvL ) == "O"
      nCalculo    := uFacPrvL:nPreUnit / nVdv
   case ValType( uFacPrvL ) == "A"
      nCalculo    := uFacPrvL[ 7 ] / nVdv
   case ValType( uFacPrvL ) == "C"
      nCalculo    := ( uFacPrvL )->nPreUnit / nVdv
   end

   nCalculo       := Round( nCalculo, nDec )

RETURN ( ( if( cPinDiv <> nil, Trans( nCalculo, cPinDiv ), nCalculo ) )  )



FUNCTION nTotIRctPrv( dbfLin, nDec, nRouDec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( dbfLin == nil, dbfLin := D():Get( "RctPrvT", nView ), ) ;
   If( nDec == nil, nDec := 0, ) ;
   If( nRouDec == nil, nRouDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := Round( ( dbfLin )->nValImp, nDec )
   nCalculo          *= nTotNRctPrv( dbfLin )
   nCalculo          := Round( nCalculo / nVdv, nRouDec )

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )



Function DesignLabelFacturaRectificativaProveedor( oFr, cDbfDoc )

   local oLabel
   local lOpenFiles  := empty( nView )

   if lOpenFiles .AND. !Openfiles()
      Return .F.
   endif

   oLabel            := TLabelGeneratorFacturaRectificativaProveedores():New( nView )



   oLabel:createTempLabelReport()
   oLabel:loadTempLabelReport()
   oLabel:dataLabel( oFr )



   if !empty( ( cDbfDoc )->mReport )
      oFr:LoadFromBlob( ( cDbfDoc )->( Select() ), "mReport")
   else
      oFr:AddPage(         "MainPage" )
      oFr:AddBand(         "MasterData",  "MainPage",       6 )
      oFr:SetProperty(     "MasterData",  "Top",            200 )
      oFr:SetProperty(     "MasterData",  "Height",         100 )
      oFr:SetObjProperty(  "MasterData",  "DataSet",        "Lineas de facturas rectificativas" )
   end



   variableReport( oFr )



   oFr:DesignReport()



   oFr:DestroyFr()

   oLabel:DestroyTempReport()
   oLabel:End()

   if lOpenFiles
      closeFiles()
   end

Return .T.






Function aLblRctPrv()

   local aLblFacPrv  := {}

   aAdd( aLblFacPrv, { "CSERFAC"    ,"C",  1, 0, "Serie de factura"            ,"",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NNUMFAC"    ,"N",  9, 0, "Número de factura"           ,"'999999999'",         "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CSUFFAC"    ,"C",  2, 0, "Sufijo de factura"           ,"",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CREF"       ,"C", 18, 0, "Referencia artículo"         ,"",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CREFPRV"    ,"C", 20, 0, "Referencia del proveedor"    ,"",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CDETALLE"   ,"C",100, 0, "Detalle de articulo"         ,"",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NPREUNIT"   ,"N", 16, 6, "Precio unitario"             ,"cPinDivFac",          "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NDTO"       ,"N",  6, 2, ""                            ,"'@E 99,99'",          "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NIVA"       ,"N",  6, 2, "Porcentaje de " + cImp()     ,"'@E 99,99'",          "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NCANENT"    ,"N", 16, 6, "Cantidad recibida"           ,"cMasUnd()",           "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LCONTROL"   ,"L",  1, 0, "Control reservado"           ,"",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CUNIDAD"    ,"C",  2, 0, "Unidad de venta"             ,"",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NUNICAJA"   ,"N", 16, 6, "Unidades por caja"           ,"cMasUnd()",           "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LCHGLIN"    ,"L",  1, 0, "Cambio de precio"            ,"",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "MLNGDES"    ,"M", 10, 0, ""                            ,""          ,          "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NDTOLIN"    ,"N",  6, 2, "Descuento lineal"            ,"'@E 999,99'",         "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NDTOPRM"    ,"N",  6, 2, "Descuento por promoción"     ,"'@E 999,99'",         "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NDTORAP"    ,"N",  6, 2, "Descuento por rappel"        ,"'@E 999,99'",         "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NPRECOM"    ,"N", 16, 6, "Precio de compra"            ,"cPinDivFac",          "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LBNFLIN1"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "LBNFLIN2"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "LBNFLIN3"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "LBNFLIN4"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "LBNFLIN5"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "LBNFLIN6"   ,"L",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFLIN1"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFLIN2"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFLIN3"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFLIN4"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFLIN5"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFLIN6"   ,"N",  6, 2, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFSBR1"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFSBR2"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFSBR3"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFSBR4"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFSBR5"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "NBNFSBR6"   ,"N",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "NPVPLIN1"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NPVPLIN2"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NPVPLIN3"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NPVPLIN4"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NPVPLIN5"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NPVPLIN6"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NIVALIN1"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NIVALIN2"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NIVALIN3"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NIVALIN4"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NIVALIN5"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NIVALIN6"   ,"N", 16, 6, "" }                                                                      )
   aAdd( aLblFacPrv, { "NIVALIN"    ,"N",  6, 2, "" }                                                                      )
   aAdd( aLblFacPrv, { "LIVALIN"    ,"L",  1, 0, "" }                                                                      )
   aAdd( aLblFacPrv, { "CCODPR1"    ,"C", 20, 0, "Código de la propiedad 1",    "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CCODPR2"    ,"C", 20, 0, "Código de la propiedad 2",    "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CVALPR1"    ,"C", 20, 0, "Valor de la propiedad 1" ,    "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CVALPR2"    ,"C", 20, 0, "Valor de la propiedad 2" ,    "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NFACCNV"    ,"N", 16, 6, "Factor de conversión de la compra", "",              "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CALMLIN"    ,"C", 16, 0, "Código del almacen" ,         "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NCTLSTK"    ,"N",  1, 0, "Tipo de stock de la línea",   "'9'",                 "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LLOTE"      ,"L",  1, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NLOTE"      ,"N",  9, 0, "",                            "'999999999'",         "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "cLote"      ,"C", 64, 0, "Número de lote",              "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NNUMLIN"    ,"N",  4, 0, "Número de la línea",          "9999",                "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NUNDKIT"    ,"N", 16, 6, "Unidades del producto kit",   "MasUnd()",            "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LKITART"    ,"L",  1, 0, "Línea con escandallo",        "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LKITCHL"    ,"L",  1, 0, "Línea pertenciente a escandallo", "",                "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LKITPRC"    ,"L",  1, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LIMPLIN"    ,"L",  1, 0, "Imprimir línea",              "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "MNUMSER"    ,"M", 10, 0, "" ,                           "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CCODUBI1"   ,"C",  5, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CCODUBI2"   ,"C",  5, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CCODUBI3"   ,"C",  5, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CVALUBI1"   ,"C",  5, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CVALUBI2"   ,"C",  5, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CVALUBI3"   ,"C",  5, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CNOMUBI1"   ,"C", 30, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CNOMUBI2"   ,"C", 30, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CNOMUBI3"   ,"C", 30, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CCODFAM"    ,"C", 16, 0, "Código de familia",           "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "CGRPFAM"    ,"C",  3, 0, "Código del grupo de familia", "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NREQ"       ,"N", 16, 6, "Recargo de equivalencia",     "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "MOBSLIN"    ,"M", 10, 0, "Observación de línea",        "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "nPvpRec"    ,"N", 16, 6, "Precio de venta recomendado", "cPinDivFac",          "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NUNDLIN"    ,"N",  5, 0, "",                            "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "LLABEL"     ,"L",  1, 0, "Lógico de etiqueta",          "",                    "", "( cDbfCol )" } )
   aAdd( aLblFacPrv, { "NLABEL"     ,"N",  5, 0, "Número de etiquetas",         "",                    "", "( cDbfCol )" } )

return ( aLblFacPrv )



Function DesignReportRctPrv( oFr, cDoc )

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !empty( ( cDoc )->mReport )

         oFr:LoadFromBlob( ( cDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "CallHbFunc('nTotRctPrv');"                                 + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "MasterData",  "MainPage", 6 )
         oFr:SetProperty(     "MasterData",  "Top", 200 )
         oFr:SetProperty(     "MasterData",  "Height", 0 )
         oFr:SetProperty(     "MasterData",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "MasterData",  "DataSet", "Facturas rectificativas" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de facturas rectificativas" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:SetTabTreeExpanded( 16, .F. )
      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function mailReportRctPrv( cCodigoDocumento )

Return ( printReportRctPrv( 6, 1, ImpresoraDefectoUsuario(), cCodigoDocumento ) )



Function PrintReportRctPrv( nDevice, nCopies, cPrinter, cDoc )

   local oFr
   local cFilePdf

   If( nDevice == nil, nDevice := 2, ) ;
   If( nCopies == nil, nCopies := 1, ) ;

   if Empty( cPrinter )
      cPrinter                := ImpresoraDefectoUsuario()
   end

   SysRefresh()

   oFr                  := frReportManager():New()

   oFr:LoadLangRes(     "Spanish.Xml" )

   oFr:SetIcon( 1 )

   oFr:SetTitle(        "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( D():Documentos( nView ) )->( Select() ), "mReport" ) } )





   DataReport( oFr )

   cFilePdf             := cPatOut() + "RectificativaProveedor" + StrTran( ( D():FacturasRectificativasProveedores( nView ) )->cSerFac + Str( ( D():FacturasRectificativasProveedores( nView ) )->nNumFac ) + ( D():FacturasRectificativasProveedores( nView ) )->cSufFac, " ", "" ) + ".Pdf"





   if !empty( ( D():Documentos( nView ) )->mReport )

      oFr:LoadFromBlob( ( D():Documentos( nView ) )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2
            oFr:PrepareReport()
            oFr:ShowPreparedReport()

         case nDevice == 1
            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:PrepareReport()
            oFr:Print()

         case nDevice == 3
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf  )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

      end

   end





   oFr:DestroyFr()

Return cFilePdf





FUNCTION nIncURctPrv( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotURctPrv( dbfTmpLin, nDec, nVdv )

   if !( dbfTmpLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfTmpLin )->nIva / 100
   end

   IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nIncLRctPrv( dbfLin, nDec, nRouDec, nVdv )

   local nCalculo := nTotLRctPrv( dbfLin, nDec, nRouDec, nVdv )

   if !( dbfLin )->lIvaLin
      nCalculo    += nCalculo * ( dbfLin )->nIva / 100
   end

RETURN ( nCalculo )







function nNewReciboProveedor( cNumFac, cTipRec, dbfFacPrvP )

   local nCon
   local nRec
   local nOrd

   If( cTipRec == nil, cTipRec := .F., ) ;

   nCon                    := 1
   nRec                    := ( dbfFacPrvP )->( Recno() )

   if empty( cTipRec )
      nOrd                 := ( dbfFacPrvP )->( OrdSetFocus( "nNumFac" ) )
   else
      nOrd                 := ( dbfFacPrvP )->( OrdSetFocus( "rNumFac" ) )
   end

   if ( dbfFacPrvP )->( dbSeek( cNumFac ) )

      while ( dbfFacPrvP )->cSerFac + Str( ( dbfFacPrvP )->nNumFac ) + ( dbfFacPrvP )->cSufFac == cNumFac .AND. !( dbfFacPrvP )->( eof() )

         ++nCon

         ( dbfFacPrvP )->( dbSkip() )

      end

   end

   ( dbfFacPrvP )->( OrdSetFocus( nOrd ) )
   ( dbfFacPrvP )->( dbGoTo( nRec ) )

return ( nCon )



STATIC FUNCTION hStockBuffer( aTmp )

   local hBuffer := {=>}

   do case
      case hb_isArray( aTmp )

         hset( hBuffer, "codigo_articulo", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "cRef" ) ) ] ) )
         hset( hBuffer, "codigo_almacen_entrada", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "cAlmLin" ) ) ] ) )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "cAlmOrigen" ) ) ] ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "cCodPr1" ) ) ] ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "cValPr1" ) ) ] ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "cCodPr2" ) ) ] ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "cValPr2" ) ) ] ) )
         hset( hBuffer, "lote", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "clote" ) ) ] ) )
         hset( hBuffer, "bultos_articulo", aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nBultos" ) ) ] )
         hset( hBuffer, "cajas_articulo", aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "nCanEnt" ) ) ] )
         hset( hBuffer, "unidades_articulo", nTotNRctPrv( aTmp ) )
         hset( hBuffer, "fecha", aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "dFecFac" ) ) ] )
         hset( hBuffer, "hora", AllTrim( aTmp[ ( D():FacturasRectificativasProveedoresLineas( nView ) )->( fieldpos( "tFecFac" ) ) ] ) )

      case hb_isChar( aTmp )

         hset( hBuffer, "codigo_articulo", AllTrim( ( aTmp )->cRef ) )
         hset( hBuffer, "codigo_almacen_entrada", AllTrim( ( aTmp )->cAlmLin ) )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( ( aTmp )->cAlmOrigen ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( ( aTmp )->cCodPr1 ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( ( aTmp )->cValPr1 ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( ( aTmp )->cCodPr2 ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( ( aTmp )->cValPr2 ) )
         hset( hBuffer, "lote", AllTrim( ( aTmp )->clote ) )
         hset( hBuffer, "bultos_articulo", ( aTmp )->nBultos )
         hset( hBuffer, "cajas_articulo", ( aTmp )->nCanEnt )
         hset( hBuffer, "unidades_articulo", nTotNRctPrv( aTmp ) )
         hset( hBuffer, "fecha", ( aTmp )->dFecFac )
         hset( hBuffer, "hora", AllTrim( ( aTmp )->tFecFac ) )

   end

RETURN ( hBuffer )







_HB_CLASS TRectificativasProveedorSenderReciver ; function TRectificativasProveedorSenderReciver ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TRectificativasProveedorSenderReciver", iif( .T., { @TSenderReciverItem() }, { @HBObject() } ), @TRectificativasProveedorSenderReciver() ) ) ;

   _HB_MEMBER { lSuccesfullSendFacturas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lSuccesfullSendFacturas"}, .F. )

   _HB_MEMBER { nFacturaNumberSend } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nFacturaNumberSend"}, .F. )

   _HB_MEMBER { cFileName } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileName"}, .F. )

   _HB_MEMBER CreateData(); oClass:AddMethod( "CreateData", @TRectificativasProveedorSenderReciver_CreateData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RestoreData(); oClass:AddMethod( "RestoreData", @TRectificativasProveedorSenderReciver_RestoreData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SendData(); oClass:AddMethod( "SendData", @TRectificativasProveedorSenderReciver_SendData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ReciveData(); oClass:AddMethod( "ReciveData", @TRectificativasProveedorSenderReciver_ReciveData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Process(); oClass:AddMethod( "Process", @TRectificativasProveedorSenderReciver_Process(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nGetFacturaNumberToSend(); oClass:AddInline( "nGetFacturaNumberToSend", {|Self | ( ( Self ) ), ( ::nFacturaNumberSend     := GetPvProfInt( "Numero", "Rectificativas proveedor", ::nFacturaNumberSend, ::cIniFile ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER IncFacturaNumberToSend(); oClass:AddInline( "IncFacturaNumberToSend", {|Self | ( ( Self ) ), ( WritePProString( "Numero", "Rectificativas proveedor",    cValToChar( ++::nFacturaNumberSend ),  ::cIniFile ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validateRecepcion( tmpRctPrvT, dbfRctPrvT); oClass:AddMethod( "validateRecepcion", @TRectificativasProveedorSenderReciver_validateRecepcion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TRectificativasProveedorSenderReciver ;



static FUNCTION TRectificativasProveedorSenderReciver_CreateData( ) ; local Self AS CLASS TRectificativasProveedorSenderReciver := QSelf() AS CLASS TRectificativasProveedorSenderReciver

   local oBlock
   local oError
   local nOrd
   local lSnd        := .F.
   local dbfRctPrvT
   local dbfRctPrvL

   if ::oSender:lServer
      ::cFileName      := "RectPrv" + win_uuidcreatestring() + ".All"
   else
      ::cFileName      := "RectPrv" + win_uuidcreatestring() + "." + RetSufEmp()
   end

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvT.DBF" ), ( cCheckArea( "RCTPRVT", @dbfRctPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RCTPRVL", @dbfRctPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end





   mkRctPrv( cPatSnd(), , cLocalDriver() )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "RctPrvT.DBF" ), ( cCheckArea( "FACPRVT", @tmpRctPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "RctPrvT.CDX" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "RctPrvL.DBF" ), ( cCheckArea( "FACPRVL", @tmpRctPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "RctPrvL.CDX" ) )

   if !empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( dbfRctPrvT )->( LastRec() )
   end

   ::oSender:SetText( "Enviando facturas rectificativas de proveedores" )

   nOrd  := ( dbfRctPrvT )->( OrdSetFocus( "lSndDoc" ) )

   if ( dbfRctPrvT )->( dbSeek( .T. ) )

      while ( dbfRctPrvT )->lSndDoc .AND. !( dbfRctPrvT )->( eof() )

         lSnd  := .T.

         dbPass( dbfRctPrvT, tmpRctPrvT, .T. )
         ::oSender:SetText( ( dbfRctPrvT )->cSerFac + "/" + AllTrim( Str( ( dbfRctPrvT )->nNumFac ) ) + "/" + AllTrim( ( dbfRctPrvT )->cSufFac ) + "; " + Dtoc( ( dbfRctPrvT )->dFecFac ) + "; " + AllTrim( ( dbfRctPrvT )->cCodPrv ) + "; " + ( dbfRctPrvT )->cNomPrv )

         if ( dbfRctPrvL )->( dbSeek( ( dbfRctPrvT )->cSerFac + Str( ( dbfRctPrvT )->nNumFac ) + ( dbfRctPrvT )->cSufFac ) )
            while ( dbfRctPrvL )->cSerFac + Str( ( dbfRctPrvL )->nNumFac ) + ( dbfRctPrvL )->cSufFac == ( dbfRctPrvT )->cSerFac + Str( ( dbfRctPrvT )->nNumFac ) + ( dbfRctPrvT )->cSufFac .AND. !( dbfRctPrvL )->( eof() )
               dbPass( dbfRctPrvL, tmpRctPrvL, .T. )
               ( dbfRctPrvL )->( dbSkip() )
            end
         end

         ( dbfRctPrvT )->( dbSkip() )

         if !empty( ::oSender:oMtr )
            ::oSender:oMtr:Set( ( dbfRctPrvT )->( OrdKeyNo() ) )
         end

      end

   end

   ( dbfRctPrvT )->( OrdSetFocus( nOrd ) )

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( dbfRctPrvT )->( dbCloseArea() )
   ( dbfRctPrvL )->( dbCloseArea() )
   ( tmpRctPrvT )->( dbCloseArea() )
   ( tmpRctPrvL )->( dbCloseArea() )

   if lSnd





      ::oSender:SetText( "Comprimiendo facturas de proveedores" )

      if ::oSender:lZipData( ::cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay facturas de proveedores para enviar" )

   end

Return ( Self )



static FUNCTION TRectificativasProveedorSenderReciver_RestoreData( ) ; local Self AS CLASS TRectificativasProveedorSenderReciver := QSelf() AS CLASS TRectificativasProveedorSenderReciver

   local oBlock
   local oError
   local dbfRctPrvT

   if ::lSuccesfullSend

      oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvT.DBF" ), ( cCheckArea( "FacPrvT", @dbfRctPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      ( dbfRctPrvT )->( OrdSetFocus( "lSndDoc" ) )

      while ( dbfRctPrvT )->( dbSeek( .T. ) ) .AND. !( dbfRctPrvT )->( eof() )
         if ( dbfRctPrvT )->( dbRLock() )
            ( dbfRctPrvT )->lSndDoc := .F.
            ( dbfRctPrvT )->( dbRUnlock() )
         end
      end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

      ( dbfRctPrvT )->( dbCloseArea() )

   end

Return ( Self )



static FUNCTION TRectificativasProveedorSenderReciver_SendData( ) ; local Self AS CLASS TRectificativasProveedorSenderReciver := QSelf() AS CLASS TRectificativasProveedorSenderReciver

   if File( cPatOut() + ::cFileName )

      if ::oSender:SendFiles( cPatOut() + ::cFileName, ::cFileName )
         ::oSender:SetText( "Fichero enviado " + ::cFileName )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



static FUNCTION TRectificativasProveedorSenderReciver_ReciveData( ) ; local Self AS CLASS TRectificativasProveedorSenderReciver := QSelf() AS CLASS TRectificativasProveedorSenderReciver

   local n
   local aExt

   aExt     := ::oSender:aExtensions()





   ::oSender:SetText( "Recibiendo rectificativas de proveedores" )

   for n := 1 to len( aExt )
      ::oSender:GetFiles( "RectPrv*." + aExt[ n ], cPatIn() )
   next

   ::oSender:SetText( "Facturas rectificativas de proveedores recibidas" )

Return Self



static FUNCTION TRectificativasProveedorSenderReciver_Process( ) ; local Self AS CLASS TRectificativasProveedorSenderReciver := QSelf() AS CLASS TRectificativasProveedorSenderReciver

   local m
   local dbfRctPrvT
   local dbfRctPrvL
   local aFiles         := Directory( cPatIn() + "RectPrv*.*" )
   local lClient        := ::oSender:lServer
   local oBlock
   local oError
   local cNumeroFactura
   local cTextoFactura  := ""





   ::oSender:SetText( "Recibiendo facturas rectificativas de proveedores" )

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE





      if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )






         if file( cPatSnd() + "RctPrvT.DBF" ) .AND. file( cPatSnd() + "RctPrvL.DBF" )

            dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "RctPrvT.DBF" ), ( cCheckArea( "RctPrvT", @tmpRctPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )

            dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvT", @tmpRctPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "RctPrvL.CDX" ) )

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvT.DBF" ), ( cCheckArea( "RctPrvT", @dbfRctPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvT", @dbfRctPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            while ( tmpRctPrvT )->( !eof() )





               if ::validateRecepcion( tmpRctPrvT, dbfRctPrvT )

                  cNumeroFactura    := ( tmpRctPrvT )->cSerFac + str( ( tmpRctPrvT )->nNumFac ) + ( tmpRctPrvT )->cSufFac
                  cTextoFactura     := ( tmpRctPrvT )->cSerFac + "/" + AllTrim( str( ( tmpRctPrvT )->nNumFac ) ) + "/" + AllTrim( ( tmpRctPrvT )->cSufFac ) + "; " + Dtoc( ( tmpRctPrvT )->dFecFac ) + "; " + AllTrim( ( tmpRctPrvT )->cCodPrv ) + "; " + ( tmpRctPrvT )->cNomPrv

                  while ( dbfRctPrvT )->( dbseek( cNumeroFactura ) )
                     dbLockDelete( dbfRctPrvT )
                  end

                  while ( dbfRctPrvL )->( dbseek( cNumeroFactura ) )
                     dbLockDelete( dbfRctPrvL )
                  end

                  dbPass( tmpRctPrvT, dbfRctPrvT, .T. )

                  if dbLock( dbfRctPrvT )
                     ( dbfRctPrvT )->lSndDoc := .F.
                     ( dbfRctPrvT )->( dbUnLock() )
                  end

                  ::oSender:SetText( "Añadido rectificativa proveedor : " + cTextoFactura )

                  if ( tmpRctPrvL )->( dbSeek( ( tmpRctPrvT )->cSerFac + Str( ( tmpRctPrvT )->nNumFac ) + ( tmpRctPrvT )->cSufFac ) )
                     while ( tmpRctPrvL )->cSerFac + Str( ( tmpRctPrvL )->nNumFac ) + ( tmpRctPrvL )->cSufFac == ( tmpRctPrvT )->cSerFac + Str( ( tmpRctPrvT )->nNumFac ) + ( tmpRctPrvT )->cSufFac .AND. !( tmpRctPrvL )->( eof() )
                        dbPass( tmpRctPrvL, dbfRctPrvL, .T. )
                        ( tmpRctPrvL )->( dbSkip() )
                     end
                  end

                  ::oSender:SetText( "Añadido lineas de rectificativa proveedor : " + cTextoFactura )

               else

                  ::oSender:SetText( "Factura fecha invalida" + cTextoFactura )

               end

               ( tmpRctPrvT )->( dbSkip() )

            end

            ( dbfRctPrvT )->( dbCloseArea() )
            ( dbfRctPrvL )->( dbCloseArea() )
            ( tmpRctPrvT )->( dbCloseArea() )
            ( tmpRctPrvL )->( dbCloseArea() )

            ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

         else

            ::oSender:SetText( "Faltan ficheros" )

            if !file( cPatSnd() + "RctPrvT.Dbf" )
               ::oSender:SetText( "Falta" + cPatSnd() + "RctPrvT.Dbf" )
            end

            if !file( cPatSnd() + "RctPrvL.Dbf" )
               ::oSender:SetText( "Falta" + cPatSnd() + "RctPrvL.Dbf" )
            end

         end

      else

          ::oSender:SetText( "Error al descomprimir los ficheros" )

      end

      RECOVER USING oError

         ( dbfRctPrvT )->( dbCloseArea() )
         ( dbfRctPrvL )->( dbCloseArea() )
         ( tmpRctPrvT )->( dbCloseArea() )
         ( tmpRctPrvL )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self



static FUNCTION TRectificativasProveedorSenderReciver_validateRecepcion( tmpRctPrvT, dbfRctPrvT ) ; local Self AS CLASS TRectificativasProveedorSenderReciver := QSelf() AS CLASS TRectificativasProveedorSenderReciver

   ::cErrorRecepcion       := "Pocesando rectificativa de cliente número " + ( dbfRctPrvT )->cSerFac + "/" + alltrim( Str( ( dbfRctPrvT )->nNumFac ) ) + "/" + alltrim( ( dbfRctPrvT )->cSufFac ) + " "

   if !( lValidaOperacion( ( tmpRctPrvT )->dFecFac, .F. ) )
      ::cErrorRecepcion    += "la fecha " + dtoc( ( tmpRctPrvT )->dFecFac ) + " no es valida en esta empresa"
      Return .F.
   end

   if !( ( dbfRctPrvT )->( dbSeek( ( tmpRctPrvT )->cSerFac + Str( ( tmpRctPrvT )->nNumFac ) + ( tmpRctPrvT )->cSufFac ) ) )
      Return .T.
   end

   if dtos( ( dbfRctPrvT )->dFecChg ) + ( dbfRctPrvT )->cTimChg >= dtos( ( tmpRctPrvT )->dFecChg ) + ( tmpRctPrvT )->cTimChg
      ::cErrorRecepcion    += "la fecha en la empresa " + dtoc( ( dbfRctPrvT )->dFecChg ) + " " + ( dbfRctPrvT )->cTimChg + " es más reciente que la recepción " + dtoc( ( tmpRctPrvT )->dFecChg ) + " " + ( tmpRctPrvT )->cTimChg
      Return .F.
   end

Return ( .T. )
