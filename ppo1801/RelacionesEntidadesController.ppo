#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 6 ".\Prg\Controllers\RelacionesEntidadesController.prg"
_HB_CLASS RelacionesEntidadesController ; function RelacionesEntidadesController ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "RelacionesEntidadesController", iif( .T., { @SQLNavigatorController() }, { @HBObject() } ), @RelacionesEntidadesController() ) ) ;

   _HB_MEMBER { aRelacionables } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aRelacionables"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @RelacionesEntidadesController_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Edit(); oClass:AddMethod( "Edit", @RelacionesEntidadesController_Edit(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AppendLine(); oClass:AddMethod( "AppendLine", @RelacionesEntidadesController_AppendLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER UpdateLine( uNewValue); oClass:AddMethod( "UpdateLine", @RelacionesEntidadesController_UpdateLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DeleteLine(); oClass:AddMethod( "DeleteLine", @RelacionesEntidadesController_DeleteLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SearchEntidad(); oClass:AddMethod( "SearchEntidad", @RelacionesEntidadesController_SearchEntidad(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS RelacionesEntidadesController ;



static FUNCTION RelacionesEntidadesController_New( oSenderController ) ; local Self AS CLASS RelacionesEntidadesController := QSelf() AS CLASS RelacionesEntidadesController

   ::Super:New( oSenderController )

   ::cTitle                := "Relaciones entidades"

   ::cName                 := "relaciones entidades"

   ::hImage                := { "16" => "gc_document_attachment_16" }

   ::nLevel                := Auth():Level( "01201" )

   ::aRelacionables        := { "Centro de coste" }

   ::oModel                := SQLRelacionesEntidadesModel():New( self )

   ::oDialogView           := RelacionesEntidadesView():New( self )

   ::oRepository           := RelacionesEntidadesRepository():New( self )

   ::oBrowseView           := RelacionesEntidadesLineasBrowseView():New( self )

RETURN ( Self )



static FUNCTION RelacionesEntidadesController_Edit( ) ; local Self AS CLASS RelacionesEntidadesController := QSelf() AS CLASS RelacionesEntidadesController

   local lEdit    := .T.

   if isFalse( ::fireEvent( "editing" ) )
      RETURN ( .F. )
   end

   ::setEditMode()

   ::beginTransactionalMode()

   ::oRowSet      := ::oRepository:getRowRelacionesEntidades( hget( ::oSenderController:oModel:hBuffer, "uuid" ) )

   ::fireEvent( "openingDialog" )

   if ::DialogViewActivate()

      ::fireEvent( "closedDialog" )

      ::commitTransactionalMode()

      ::refreshRowSet()

      ::fireEvent( "edited" )

   else

      lEdit       := .F.

      ::fireEvent( "cancelEdited" )

      ::rollbackTransactionalMode()

   end

   ::fireEvent( "exitEdited" )



RETURN ( lEdit )



static FUNCTION RelacionesEntidadesController_AppendLine( ) ; local Self AS CLASS RelacionesEntidadesController := QSelf() AS CLASS RelacionesEntidadesController

   local id    := ::oModel:insertBlankRelacionEntidad( hget( ::oSenderController:oModel:hBuffer, "uuid" ) )

   ::oRowSet:refreshAndFindId( id )

   ::oBrowseView:oBrowse:Refresh()

RETURN ( nil )



static FUNCTION RelacionesEntidadesController_DeleteLine( ) ; local Self AS CLASS RelacionesEntidadesController := QSelf() AS CLASS RelacionesEntidadesController

   ::oModel:deleteById( ::oRowSet:fieldGet( "id" ) )

   ::oRowSet:Refresh()

   ::oBrowseView:oBrowse:Refresh()

RETURN ( nil )



static FUNCTION RelacionesEntidadesController_UpdateLine( uNewValue, cCampo ) ; local Self AS CLASS RelacionesEntidadesController := QSelf() AS CLASS RelacionesEntidadesController

   ::oModel:updateFieldWhereId( ::oRowSet:fieldGet( "id" ), cCampo, uNewValue )

   ::oRowSet:Refresh()
   ::oBrowseView:oBrowse:Refresh()

RETURN ( nil )



static FUNCTION RelacionesEntidadesController_SearchEntidad( ) ; local Self AS CLASS RelacionesEntidadesController := QSelf() AS CLASS RelacionesEntidadesController

   local Uuid  := TCentroCoste():Create( cPatDat() ):SearchToUuid()

   ::UpdateLine( Uuid, "uuid_destino" )

RETURN ( nil )










_HB_CLASS SQLRelacionesEntidadesModel ; function SQLRelacionesEntidadesModel ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "SQLRelacionesEntidadesModel", iif( .T., { @SQLBaseModel() }, { @HBObject() } ), @SQLRelacionesEntidadesModel() ) ) ;

   _HB_MEMBER { cTableName } ; oClass:AddMultiData(, "relaciones_entidades", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTableName"}, .F. )

   _HB_MEMBER getColumns(); oClass:AddMethod( "getColumns", @SQLRelacionesEntidadesModel_getColumns(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER insertBlankRelacionEntidad( uuid); oClass:AddMethod( "insertBlankRelacionEntidad", @SQLRelacionesEntidadesModel_insertBlankRelacionEntidad(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getCodigo( Uuid); oClass:AddInline( "getCodigo", {|Self , Uuid| ( ( Self ) ), ::getField( "cCodigo", "uuid", Uuid )}, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS SQLRelacionesEntidadesModel ;



static FUNCTION SQLRelacionesEntidadesModel_getColumns( ) ; local Self AS CLASS SQLRelacionesEntidadesModel := QSelf() AS CLASS SQLRelacionesEntidadesModel



   hset( ::hColumns, "id",             {  "create"    => "INTEGER AUTO_INCREMENT UNIQUE PRIMARY KEY"  , "text"      => "Identificador"                              , "default"   => {|| 0 } }                                    )



   hset( ::hColumns, "uuid",           {  "create"    => "VARCHAR(40) NOT NULL UNIQUE"                , "text"      => "Uuid"                                       , "default"   => {|| win_uuidcreatestring() } }               )



   hset( ::hColumns, "uuid_origen",    {  "create"    => "VARCHAR(40) NOT NULL"                       , "text"      => "Uuid"                                       , "default"   => {|| space( 40 ) } }                          )


   hset( ::hColumns, "entidad_destino", { "create"    => "VARCHAR( 100 )"                             , "default"   => {|| space( 100 ) } }                         )




   hset( ::hColumns, "uuid_destino",    { "create"    => "VARCHAR(40) NOT NULL"                       , "text"      => "Uuid"                                       , "default"   => {|| space( 40 ) } }                          )

RETURN ( ::hColumns )



 static FUNCTION SQLRelacionesEntidadesModel_insertBlankRelacionEntidad( uuid ) ; local Self AS CLASS SQLRelacionesEntidadesModel := QSelf() AS CLASS SQLRelacionesEntidadesModel

   local hBuffer  := {=>}

   hBuffer        := ::loadBlankBuffer()

   hSet( hBuffer, "uuid_origen", uuid )

RETURN ( ::insertBuffer( hBuffer ) )










_HB_CLASS RelacionesEntidadesView ; function RelacionesEntidadesView ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "RelacionesEntidadesView", iif( .T., { @SQLBaseView() }, { @HBObject() } ), @RelacionesEntidadesView() ) ) ;

   _HB_MEMBER { addButton } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"addButton"}, .F. )
   _HB_MEMBER { editButton } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"editButton"}, .F. )
   _HB_MEMBER { delButton } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"delButton"}, .F. )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @RelacionesEntidadesView_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getBrowse(); oClass:AddInline( "getBrowse", {|Self | ( ( Self ) ), ( ::oController:oBrowseView:oBrowse ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getModel(); oClass:AddInline( "getModel", {|Self | ( ( Self ) ), ( ::oController:oModel ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getSenderModel(); oClass:AddInline( "getSenderModel", {|Self | ( ( Self ) ), ( ::oController:oSenderController:oModel ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS RelacionesEntidadesView ;



static FUNCTION RelacionesEntidadesView_Activate( ) ; local Self AS CLASS RelacionesEntidadesView := QSelf() AS CLASS RelacionesEntidadesView

   ::oDialog = TDialog():New(,,,, "Relaciones", "Relaciones",, .F.,,,,,, .F.,,,,,, .F.,, "::oDialog", nil, )





      ::oBitmap := TBitmap():ReDefine( 900, "gc_graph_claw_48",, ::oDialog,,, .F., .F.,,, .F.,,, .T. )




      ::addButton := TButton():ReDefine( 500, {||( ::oController:AppendLine() )}, ::oDialog,,, .F.,,,, .F. )




      ::delButton := TButton():ReDefine( 501, {||( ::oController:DeleteLine() )}, ::oDialog,,, .F.,,,, .F. )




      ::oController:oBrowseView:ActivateDialog( ::oDialog, 100 )




      TButton():ReDefine( 1, {||( ::oDialog:end( 1 ) )}, ::oDialog,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( ::oDialog:end() )}, ::oDialog,,, .F.,,,, .T. )



   ::oDialog:AddFastKey( 113, {|| ::oController:AppendLine() } )
   ::oDialog:AddFastKey( 115, {|| ::oController:DeleteLine() } )
   ::oDialog:AddFastKey( 116, {|| ::oDialog:end( 1 ) } )



   ::oDialog:bStart  := {|| ::getBrowse():SetFocus() }

   ::oDialog:Activate( ::oDialog:bLClicked, ::oDialog:bMoved, ::oDialog:bPainted, .T.,,,, ::oDialog:bRClicked,,, )

   if !empty( ::oBitmap )
      ::oBitmap:End()
   end

RETURN ( ::oDialog:nResult )










_HB_CLASS RelacionesEntidadesRepository ; function RelacionesEntidadesRepository ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "RelacionesEntidadesRepository", iif( .T., { @SQLBaseRepository() }, { @HBObject() } ), @RelacionesEntidadesRepository() ) ) ;

   _HB_MEMBER getTableName(); oClass:AddInline( "getTableName", {|Self | ( ( Self ) ), ( SQLRelacionesEntidadesModel():getTableName() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceRelacionesEntidades(); oClass:AddMethod( "getSQLSentenceRelacionesEntidades", @RelacionesEntidadesRepository_getSQLSentenceRelacionesEntidades(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getRowRelacionesEntidades(); oClass:AddMethod( "getRowRelacionesEntidades", @RelacionesEntidadesRepository_getRowRelacionesEntidades(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSQLSentenceUuidRelacionado( uuid, entidad_destino); oClass:AddMethod( "getSQLSentenceUuidRelacionado", @RelacionesEntidadesRepository_getSQLSentenceUuidRelacionado(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getUuidRelacionadoCentroCoste( uuid, entidad_destino); oClass:AddMethod( "getUuidRelacionadoCentroCoste", @RelacionesEntidadesRepository_getUuidRelacionadoCentroCoste(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS RelacionesEntidadesRepository ;



static FUNCTION RelacionesEntidadesRepository_getSQLSentenceRelacionesEntidades( uuid ) ; local Self AS CLASS RelacionesEntidadesRepository := QSelf() AS CLASS RelacionesEntidadesRepository

   local cSql  := "SELECT * "
      cSql     += "FROM " + ::getTableName() + " "
      cSql     +=    "WHERE uuid_origen = " + quoted( uuid )

RETURN ( cSql )



static FUNCTION RelacionesEntidadesRepository_getRowRelacionesEntidades( uuid ) ; local Self AS CLASS RelacionesEntidadesRepository := QSelf() AS CLASS RelacionesEntidadesRepository

   local cSentence   := ::getSQLSentenceRelacionesEntidades( uuid )

RETURN ( SQLRowSet():New():Build( cSentence ) )



static FUNCTION RelacionesEntidadesRepository_getSQLSentenceUuidRelacionado( uuid, entidad_destino ) ; local Self AS CLASS RelacionesEntidadesRepository := QSelf() AS CLASS RelacionesEntidadesRepository

   local cSql  := "SELECT uuid_destino "
      cSql     += "FROM " + ::getTableName() + " "
      cSql     += "WHERE uuid_origen = " + quoted( uuid ) + " "
      cSql     +=    "AND entidad_destino = " + quoted( entidad_destino )

RETURN ( cSql )



static FUNCTION RelacionesEntidadesRepository_getUuidRelacionadoCentroCoste( uuid ) ; local Self AS CLASS RelacionesEntidadesRepository := QSelf() AS CLASS RelacionesEntidadesRepository

   local cSentence   := ::getSQLSentenceUuidRelacionado( uuid, "Centro de coste" )

RETURN ( getSQLDataBase():getValue( cSentence ) )










_HB_CLASS RelacionesEntidadesLineasBrowseView ; function RelacionesEntidadesLineasBrowseView ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "RelacionesEntidadesLineasBrowseView", iif( .T., { @SQLBrowseView() }, { @HBObject() } ), @RelacionesEntidadesLineasBrowseView() ) ) ;

   _HB_MEMBER addColumns(); oClass:AddMethod( "addColumns", @RelacionesEntidadesLineasBrowseView_addColumns(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS RelacionesEntidadesLineasBrowseView ;



static FUNCTION RelacionesEntidadesLineasBrowseView_addColumns( ) ; local Self AS CLASS RelacionesEntidadesLineasBrowseView := QSelf() AS CLASS RelacionesEntidadesLineasBrowseView

   local cRelacion         := ""

   with object ( ::oBrowse:AddCol() )
      :cHeader             := "Id"
      :cOrder              := "D"
      :nWidth              := 80
      :bEditValue          := {|| ::getRowSet():fieldGet( "id" ) }
      :lHide               := .T.
   end

   with object ( ::oBrowse:AddCol() )
      :cHeader             := "Uuid"
      :nWidth              := 240
      :bEditValue          := {|| ::getRowSet():fieldGet( "uuid" ) }
      :lHide               := .T.
   end

   with object ( ::oBrowse:AddCol() )
      :cHeader             := "Uuid origen"
      :nWidth              := 155
      :bEditValue          := {|| ::getRowSet():fieldGet( "uuid_origen" ) }
      :lHide               := .T.
   end

   with object ( ::oBrowse:AddCol() )
      :cHeader             := "Entidad"
      :nWidth              := 250
      :bEditValue          := {|| ::getRowSet():fieldGet( "entidad_destino" ) }
      :nEditType           := 2
      :cEditPicture        := ""
      :aEditListTxt        := ::oController:aRelacionables
      :bOnPostEdit         := {| oCol, uNewValue, nKey | ::oController:UpdateLine( uNewValue, "entidad_destino" ) }
   end

   with object ( ::oBrowse:AddCol() )
      :cHeader             := "Uuid destino"
      :nWidth              := 155
      :bEditValue          := {|| ::getRowSet():fieldGet( "uuid_destino" ) }
      :lHide               := .T.
   end

   with object ( ::oBrowse:AddCol() )
      :cHeader             := "Relación"
      :nWidth              := 250
      :bEditValue          := {|| CentroCosteModel():getNombre( ::getRowSet():fieldGet( "uuid_destino" ) ) }
      :nEditType           := 5
      :cEditPicture        := ""
      :bEditBlock          := {|| ::oController:SearchEntidad() }
      :nBtnBmp             := 1
      :AddResource( "Lupa" )
   end

RETURN ( self )
