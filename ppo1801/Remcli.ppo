#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 14 ".\.\Prg\Remcli.prg"
_HB_CLASS TRemesas ; function TRemesas ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TRemesas", iif( .T., { @TMasDet() }, { @HBObject() } ), @TRemesas() ) ) ;

   _HB_MEMBER { oCtaRem } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCtaRem"}, .F. )
   _HB_MEMBER { oDivisas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDivisas"}, .F. )
   _HB_MEMBER { oDbfCnt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfCnt"}, .F. )
   _HB_MEMBER { oCliBnc } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCliBnc"}, .F. )
   _HB_MEMBER { oRecibos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oRecibos"}, .F. )
   _HB_MEMBER { oClientes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oClientes"}, .F. )
   _HB_MEMBER { oFacCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliT"}, .F. )
   _HB_MEMBER { oFacCliL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliL"}, .F. )
   _HB_MEMBER { oAntCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAntCliT"}, .F. )
   _HB_MEMBER { oIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oIva"}, .F. )
   _HB_MEMBER { oBandera } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBandera"}, .F. )
   _HB_MEMBER { oFormaPago } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFormaPago"}, .F. )

   _HB_MEMBER { cPorDiv } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPorDiv"}, .F. )

   _HB_MEMBER { cFicheroExportacion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFicheroExportacion"}, .F. )
   _HB_MEMBER { dExpedicionIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dExpedicionIni"}, .F. )
   _HB_MEMBER { dExpedicionFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dExpedicionFin"}, .F. )
   _HB_MEMBER { dVencimientoIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dVencimientoIni"}, .F. )
   _HB_MEMBER { dVencimeintoFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dVencimeintoFin"}, .F. )

   _HB_MEMBER { oSerieInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSerieInicio"}, .F. )
   _HB_MEMBER { cSerieInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerieInicio"}, .F. )
   _HB_MEMBER { oSerieFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSerieFin"}, .F. )
   _HB_MEMBER { cSerieFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerieFin"}, .F. )

   _HB_MEMBER { oNumeroInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oNumeroInicio"}, .F. )
   _HB_MEMBER { nNumeroInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumeroInicio"}, .F. )
   _HB_MEMBER { oNumeroFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oNumeroFin"}, .F. )
   _HB_MEMBER { nNumeroFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumeroFin"}, .F. )

   _HB_MEMBER { oSufijoInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSufijoInicio"}, .F. )
   _HB_MEMBER { cSufijoInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijoInicio"}, .F. )
   _HB_MEMBER { oSufijoFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSufijoFin"}, .F. )
   _HB_MEMBER { cSufijoFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijoFin"}, .F. )

   _HB_MEMBER { oTreeIncidencias } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTreeIncidencias"}, .F. )

   _HB_MEMBER { oNotImportCeros } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oNotImportCeros"}, .F. )
   _HB_MEMBER { lNotImportCeros } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lNotImportCeros"}, .F. )

   _HB_MEMBER { oNotImportSinCuenta } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oNotImportSinCuenta"}, .F. )
   _HB_MEMBER { lNotImportSinCuenta } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lNotImportSinCuenta"}, .F. )

   _HB_MEMBER { oNotImportarEsperaDocumentacion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oNotImportarEsperaDocumentacion"}, .F. )
   _HB_MEMBER { lNotImportarEsperaDocumentacion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lNotImportarEsperaDocumentacion"}, .F. )

   _HB_MEMBER { oClienteIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oClienteIni"}, .F. )
   _HB_MEMBER { oClienteFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oClienteFin"}, .F. )
   _HB_MEMBER { cClienteIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cClienteIni"}, .F. )
   _HB_MEMBER { cClienteFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cClienteFin"}, .F. )

   _HB_MEMBER { oFormaPagoIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFormaPagoIni"}, .F. )
   _HB_MEMBER { oFormaPagoFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFormaPagoFin"}, .F. )
   _HB_MEMBER { cFormaPagoIni } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFormaPagoIni"}, .F. )
   _HB_MEMBER { cFormaPagoFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFormaPagoFin"}, .F. )

   _HB_MEMBER { nRecAnterior } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nRecAnterior"}, .F. )
   _HB_MEMBER { cOrdenAnterior } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cOrdenAnterior"}, .F. )

   _HB_MEMBER { oSer } ; oClass:AddMultiData(, Array( 26 ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSer"}, .F. )
   _HB_MEMBER { aSer } ; oClass:AddMultiData(, Afill( Array( 26 ), .T. ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aSer"}, .F. )

   _HB_MEMBER { AS OBJECT oMeter } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMeter"}, .F. )
   _HB_MEMBER { AS NUMERIC nMeter } ; oClass:AddMultiData( "NUMERIC", 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nMeter"}, .F. )
   _HB_MEMBER { bmpConta } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"bmpConta"}, .F. )
   _HB_MEMBER { AS ARRAY aMsg } ; oClass:AddMultiData( "ARRAY", {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aMsg"}, .F. )
   _HB_MEMBER { lAgruparRecibos } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lAgruparRecibos"}, .F. )
   _HB_MEMBER { lUsarVencimiento } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lUsarVencimiento"}, .F. )
   _HB_MEMBER { lUsarSEPA } ; oClass:AddMultiData(, .T., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lUsarSEPA"}, .F. )
   _HB_MEMBER { cMru } ; oClass:AddMultiData(, "gc_briefcase2_document_16", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cMru"}, .F. )
   _HB_MEMBER { cBitmap } ; oClass:AddMultiData(, ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cBitmap"}, .F. )
   _HB_MEMBER { oMenu } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMenu"}, .F. )
   _HB_MEMBER { oGetCuentaRemesa } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetCuentaRemesa"}, .F. )
   _HB_MEMBER { oFecExp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFecExp"}, .F. )
   _HB_MEMBER { oExportado } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oExportado"}, .F. )

   _HB_MEMBER { cEsquema } ; oClass:AddMultiData(, "CORE", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cEsquema"}, .F. )
   _HB_MEMBER { cSequencia } ; oClass:AddMultiData(, "OOFF", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSequencia"}, .F. )

   _HB_MEMBER { oCuaderno } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCuaderno"}, .F. )

   _HB_MEMBER { cCuentaRemesaAnterior } ; oClass:AddMultiData(, "", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCuentaRemesaAnterior"}, .F. )

   _HB_MEMBER { lDefCobrado } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lDefCobrado"}, .F. )

   _HB_MEMBER New( cPath, oWndParent, oMenuItem); oClass:AddMethod( "New", @TRemesas_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles( lExclusive); oClass:AddMethod( "OpenFiles", @TRemesas_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TRemesas_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TRemesas_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER DefineDetails( cPath, cVia, lUniqueName, cFileName); oClass:AddMethod( "DefineDetails", @TRemesas_DefineDetails(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenService( lExclusive); oClass:AddMethod( "OpenService", @TRemesas_OpenService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseService(); oClass:AddMethod( "CloseService", @TRemesas_CloseService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode); oClass:AddMethod( "Resource", @TRemesas_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER validCuentaRemesa( oSay); oClass:AddMethod( "validCuentaRemesa", @TRemesas_validCuentaRemesa(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER changeCuentaRemesa(); oClass:AddMethod( "changeCuentaRemesa", @TRemesas_changeCuentaRemesa(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER ImportResource( nMode); oClass:AddMethod( "ImportResource", @TRemesas_ImportResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @TRemesas_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lSave(); oClass:AddMethod( "lSave", @TRemesas_lSave(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GetRecCli( oDlg); oClass:AddMethod( "GetRecCli", @TRemesas_GetRecCli(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER SetRecCli(); oClass:AddMethod( "SetRecCli", @TRemesas_SetRecCli(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )





   _HB_MEMBER LoadDetails( lAppend); oClass:AddMethod( "LoadDetails", @TRemesas_LoadDetails(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AppendDet(); oClass:AddMethod( "AppendDet", @TRemesas_AppendDet(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER EditDet(); oClass:AddMethod( "EditDet", @TRemesas_EditDet(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER RollBack(); oClass:AddMethod( "RollBack", @TRemesas_RollBack(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER SaveDet() ; oClass:AddVirtual( "SaveDet" )

   _HB_MEMBER Del(); oClass:AddMethod( "Del", @TRemesas_Del(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER DelItem(); oClass:AddMethod( "DelItem", @TRemesas_DelItem(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nTotRem( lPic); oClass:AddMethod( "nTotRem", @TRemesas_nTotRem(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER nTotRemVir( lPic); oClass:AddMethod( "nTotRemVir", @TRemesas_nTotRemVir(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER cNumRem(); oClass:AddInline( "cNumRem", {|Self | ( ( Self ) ), ( alltrim( str( ::oDbf:nNumRem ) + "/" + ::oDbf:cSufRem ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cTextoRemesaContable(); oClass:AddInline( "cTextoRemesaContable", {|Self | ( ( Self ) ), ( alltrim( str( ::oDbf:nNumRem ) ) + if( empty( ::oDbf:cSufRem  ) .OR. ( ::oDbf:cSufRem == "00" ), "", "/" + ::oDbf:cSufRem ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getReciboVirtualId(); oClass:AddInline( "getReciboVirtualId", {|Self | ( ( Self ) ), ( ::oDbfVir:cSerie + Str( ::oDbfVir:nNumFac ) + ::oDbfVir:cSufFac + Str( ::oDbfVir:nNumRec ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER gotoRecibo(); oClass:AddInline( "gotoRecibo", {|Self | ( ( Self ) ), ( ::oDbfDet:seekInOrd( ::getReciboVirtualId(), "nNumFac" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )





   _HB_MEMBER SaveModelo(); oClass:AddMethod( "SaveModelo", @TRemesas_SaveModelo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER RunModelo( oDlg); oClass:AddMethod( "RunModelo", @TRemesas_RunModelo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitMod19(); oClass:AddMethod( "InitMod19", @TRemesas_InitMod19(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitSepa19( oDlg); oClass:AddMethod( "InitSepa19", @TRemesas_InitSepa19(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER InsertPresentador(); oClass:AddMethod( "InsertPresentador", @TRemesas_InsertPresentador(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER InsertAcreedor(); oClass:AddMethod( "InsertAcreedor", @TRemesas_InsertAcreedor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER InsertDeudor(); oClass:AddMethod( "InsertDeudor", @TRemesas_InsertDeudor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitSepaXML19( oDlg); oClass:AddMethod( "InitSepaXML19", @TRemesas_InitSepaXML19(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER InsertPresentadorXml(); oClass:AddMethod( "InsertPresentadorXml", @TRemesas_InsertPresentadorXml(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER InsertAcreedorXml(); oClass:AddMethod( "InsertAcreedorXml", @TRemesas_InsertAcreedorXml(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER InsertDeudorXml(); oClass:AddMethod( "InsertDeudorXml", @TRemesas_InsertDeudorXml(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER InitMod58(); oClass:AddMethod( "InitMod58", @TRemesas_InitMod58(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )





   _HB_MEMBER nAllRecCli(); oClass:AddMethod( "nAllRecCli", @TRemesas_nAllRecCli(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nTotRemesaVir(); oClass:AddInline( "nTotRemesaVir", {|Self | ( ( Self ) ), 0 }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Report(); oClass:AddMethod( "Report", @TRemesas_Report(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER contabilizaRemesas(); oClass:AddMethod( "contabilizaRemesas", @TRemesas_contabilizaRemesas(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cambiaEstadoContabilizadoRemesas( lConta); oClass:AddMethod( "cambiaEstadoContabilizadoRemesas", @TRemesas_cambiaEstadoContabilizadoRemesas(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lContabilizaRecibos( lConta); oClass:AddMethod( "lContabilizaRecibos", @TRemesas_lContabilizaRecibos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER cRetCtaRem(); oClass:AddMethod( "cRetCtaRem", @TRemesas_cRetCtaRem(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER cBmp(); oClass:AddMethod( "cBmp", @TRemesas_cBmp(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GetNewCount(); oClass:AddMethod( "GetNewCount", @TRemesas_GetNewCount(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lNowExist(); oClass:AddMethod( "lNowExist", @TRemesas_lNowExist(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SaveDetails(); oClass:AddMethod( "SaveDetails", @TRemesas_SaveDetails(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EdtRecMenu( oDlg); oClass:AddMethod( "EdtRecMenu", @TRemesas_EdtRecMenu(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EndEdtRecMenu(); oClass:AddMethod( "EndEdtRecMenu", @TRemesas_EndEdtRecMenu(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ChangeExport(); oClass:AddMethod( "ChangeExport", @TRemesas_ChangeExport(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getSerieRecibos(); oClass:AddMethod( "getSerieRecibos", @TRemesas_getSerieRecibos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER TipoRemesa(); oClass:AddInline( "TipoRemesa", {|Self | ( ( Self ) ), ( if( ::oDbf:nTipRem == 2, "Descuento", "Pago" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CuentaCliente(); oClass:AddInline( "CuentaCliente", {|Self | ( ( Self ) ), ( ::oDbfDet:cPaisIBAN + ::oDbfDet:cCtrlIBAN + ::oDbfDet:cEntCli + ::oDbfDet:cSucCli + ::oDbfDet:cDigCli + ::oDbfDet:cCtaCli ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetValidCuentaCliente(); oClass:AddInline( "GetValidCuentaCliente", {|Self | ( ( Self ) ), ( if( Empty( ::CuentaCliente() ), cClientCuenta( ::oDbfDet:cCodCli, ::oCliBnc:cAlias ), ::CuentaCliente() ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CuentaEmpresa(); oClass:AddInline( "CuentaEmpresa", {|Self | ( ( Self ) ), ( ::oDbfDet:cEPaisIBAN + ::oDbfDet:cECtrlIBAN + ::oDbfDet:cEntEmp + ::oDbfDet:cSucEmp + ::oDbfDet:cDigEmp + ::oDbfDet:cCtaEmp ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EntidadCliente(); oClass:AddInline( "EntidadCliente", {|Self | ( ( Self ) ), ( ::oDbfDet:cEntCli ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER GetValidEntidadCliente(); oClass:AddInline( "GetValidEntidadCliente", {|Self | ( ( Self ) ), ( if( Empty( ::EntidadCliente() ), cClientEntidad( ::oDbfDet:cCodCli, ::oCliBnc:cAlias ), ::EntidadCliente() ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER GetBICClient(); oClass:AddInline( "GetBICClient", {|Self | ( ( Self ) ), ( GetBIC( ::GetValidEntidadCliente() ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER TextoDocumento(); oClass:AddInline( "TextoDocumento", {|Self | ( ( Self ) ), ( ::oDbfDet:cSerie + "/" + AllTrim( Str( ::oDbfDet:nNumFac ) ) + "/" + ::oDbfDet:cSufFac ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER IdDocumento(); oClass:AddInline( "IdDocumento", {|Self | ( ( Self ) ), ( ::oDbfDet:cSerie + AllTrim( Str( ::oDbfDet:nNumFac ) ) + ::oDbfDet:cSufFac ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER ImporteDocumento(); oClass:AddInline( "ImporteDocumento", {|Self | ( ( Self ) ), ( ::oDbfDet:nImporte ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER bancoRemesa(); oClass:AddInline( "bancoRemesa", {|Self | ( ( Self ) ), ( ::oCtaRem:oDbf:cPaisIBAN + ::oCtaRem:oDbf:cCtrlIBAN + ::oCtaRem:oDbf:cEntBan + ::oCtaRem:oDbf:cAgcBan + ::oCtaRem:oDbf:cDgcBan + ::oCtaRem:oDbf:cCtaBan ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER inicializaData(); oClass:AddMethod( "inicializaData", @TRemesas_inicializaData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getFicheroExportacion(); oClass:AddMethod( "getFicheroExportacion", @TRemesas_getFicheroExportacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getDirectorioExportacion(); oClass:AddMethod( "getDirectorioExportacion", @TRemesas_getDirectorioExportacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER setDirectorioExportacion(); oClass:AddMethod( "setDirectorioExportacion", @TRemesas_setDirectorioExportacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getFicheroExportacionXml(); oClass:AddInline( "getFicheroExportacionXml", {|Self | ( ( Self ) ), ( getPathFileNoExt( ::cFicheroExportacion ) + ".xml" ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getFicheroExportacionTxt(); oClass:AddInline( "getFicheroExportacionTxt", {|Self | ( ( Self ) ), ( getPathFileNoExt( ::cFicheroExportacion ) + ".txt" ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getIngreso(); oClass:AddInline( "getIngreso", {|Self | ( ( Self ) ), ( iif( empty( ::oDbf:dIngreso ), ::oDbf:dFecRem, ::oDbf:dIngreso ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setEstadosRecibos(); oClass:AddMethod( "setEstadosRecibos", @TRemesas_setEstadosRecibos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )








   _HB_MEMBER setEstadoRecibo(); oClass:AddInline( "setEstadoRecibo", {|Self, lCobrado, lDelete | ( ( Self ) ), ( iif( lCobrado, (  ::oDbfDet:FieldPutByName( "lCobrado", .T. ), ::oDbfDet:FieldPutByName( "dEntrada", ::getIngreso() ) ), (  ::oDbfDet:FieldPutByName( "lCobrado", .F. ), ::oDbfDet:FieldPutByName( "dEntrada", ctod("") ) ) ), iif( lDelete, (  ::oDbfDet:FieldPutByName( "nNumRem", 0 ), ::oDbfDet:FieldPutByName( "cSufRem", Space( 2 ) ), ::oDbfDet:FieldPutByName( "lRemesa", .F. ) ), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setCancelar(); oClass:AddMethod( "setCancelar", @TRemesas_setCancelar(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER DeleteDet( lMessage); oClass:AddMethod( "DeleteDet", @TRemesas_DeleteDet(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setEstadoFactura(); oClass:AddMethod( "setEstadoFactura", @TRemesas_setEstadoFactura(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SetOrdenNumeroRemesa(); oClass:AddMethod( "SetOrdenNumeroRemesa", @TRemesas_SetOrdenNumeroRemesa(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER RestoreOrdenNumeroRemesa(); oClass:AddMethod( "RestoreOrdenNumeroRemesa", @TRemesas_RestoreOrdenNumeroRemesa(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TRemesas ;



static FUNCTION TRemesas_New( cPath, cDriver, oWndParent, oMenuItem ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;
   If( oMenuItem == nil, oMenuItem := "remesas_bancarias", ) ;

   ::cDriver               := cDriver

   ::nLevel                := Auth():Level( oMenuItem )

   ::cPath                 := cPath
   ::oWndParent            := oWndParent

   ::dExpedicionIni        := boy()
   ::dExpedicionFin        := eoy()
   ::dVencimientoIni       := ::dExpedicionIni
   ::dVencimeintoFin       := date()

   ::cNumDocKey            := "nNumRem"
   ::cSufDocKey            := "cSufRem"

   ::lMoveDlgSelect        := .T.

   ::bmpConta              := LoadBitmap( GetResources(), "bConta" )

   ::bFirstKey             := {|| Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem }
   ::bWhile                := {|| Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem == Str( ::oDbfVir:nNumRem, 9 ) + ::oDbfVir:cSufRem .AND. !::oDbfVir:Eof() }

   ::lDefCobrado           := ( GetPvProfString( "REMESAS", "Cobrado", .T., cIniAplication() ) == ".T." )

RETURN ( Self )



static FUNCTION TRemesas_DefineFiles( cPath, cDriver ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   If( cPath == nil, cPath := ::cPath, ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   ::oDbf := DbfServer( "REMCLIT.DBF", "REMCLI" ):New( "REMCLIT.DBF", "REMCLI", ( cDriver ), "Remesas bancarias", ( cPath ) )

      ::oDbf:AddField( "lConta", "L", 1, 0,, .F.,,,, .F.,, .T., {} )
      ::oDbf:AddField( "bmpConta", "B", 1, 0,,,, {|| ::oDbf:lConta }, { "Contabilizado", "gc_folder2_16", 3 }, .F., 20, .F., {"gc_folder2_12", "Nil16"} )
      ::oDbf:AddField( "lExport", "L", 1, 0,, .F.,,,, .F.,, .T., {} )
      ::oDbf:AddField( "bmpExport", "B", 1, 0,,,, {|| ::oDbf:lExport }, { "Exportado", "gc_floppy_disk_16", 3 }, .F., 20, .F., {"gc_floppy_disk_12", "Nil16"} )
      ::oDbf:AddField( "nNumRem", "N", 9, 0, "999999999",,,, "Número", .T., 80, .F., {} )
      ::oDbf:AddField( "cSufRem", "C", 2, 0, "@!", RetSufEmp(),,, "Delegación", .F., 20, .F., {} )
      ::oDbf:AddField( "cCodRem", "C", 3, 0, "@!",,,, "Cuenta", .F., 80, .F., {} )
      ::oDbf:AddField( "cNomRem", "B", 60, 0,,,, {||      ::cRetCtaRem()}, "Nombre", .F., 200, .F., {} )
      ::oDbf:AddField( "dFecRem", "D", 8, 0,, Date(),,, "Fecha", .F., 80, .F., {} )
      ::oDbf:AddField( "nTipRem", "N", 1, 0, "9", 1,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "cTipRem", "B", 60, 0,,,, {||      ::TipoRemesa()}, "Tipo", .F., 80, .F., {} )
      ::oDbf:AddField( "cCodDiv", "C", 3, 0, "@!", cDivEmp(),,, "", .F.,, .T., {} )
      ::oDbf:AddField( "nVdvDiv", "N", 16, 6, "@E 999,999.9999", 1,,, "", .F.,, .T., {} )
      ::oDbf:AddField( "nTotRem", "B", 16, 6,,,, {||      ::nTotRem(.T.)}, "Total", .T., 100, .F., {} )
      ::oDbf:AddField( "cBmpDiv", "B", 20, 0,,,, {||      ::cBmp()}, "Div.", .F., 25, .F., {} )
      ::oDbf:AddField( "dConta", "D", 8, 0,,,,, "Contab.", .F.,, .F., {} )
      ::oDbf:AddField( "dExport", "D", 8, 0,, CtoD( "" ),,,, .F.,, .T., {} )
      ::oDbf:AddField( "dIngreso", "D", 8, 0,, CtoD( "" ),,, "Ingreso", .F., 80, .F., {} )
      ::oDbf:AddField( "mComent", "M", 10, 0,,,,, "Comentario", .F., 280, .F., {} )

      ::oDbf:AddIndex( "nNumRem", "RemCliT.Cdx", "Str( nNumRem ) + cSufRem",,, .F., .F., "Número",,, .T., .F. )
      ::oDbf:AddIndex( "cCodRem", "RemCliT.Cdx", "cCodRem",,, .F., .F., "Cuenta",,, .T., .F. )



RETURN ( ::oDbf )



static FUNCTION TRemesas_DefineDetails( cPath, cVia, lUniqueName, cFileName ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local oDbf

   If( cPath == nil, cPath := ::cPath, ) ;
   If( lUniqueName == nil, lUniqueName := .F., ) ;
   If( cFileName == nil, cFileName := "FacCliP", ) ;
   If( cVia == nil, cVia := cDriver(), ) ;

   if lUniqueName
      cFileName         := cGetNewFileName( cFileName, , , cPatTmp() )
   end

   oDbf := DbfServer( ( cFileName ), ( cFileName ) ):New( ( cFileName ), ( cFileName ), ( cVia ),, ( cPath ) )

      oDbf:AddField( "cSerie", "C", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nNumFac", "N", 9, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cSufFac", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nNumRec", "N", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cGuid", "C", 40, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cTipRec", "C", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCodPgo", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCodCaj", "C", 3, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cTurRec", "C", 6, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCodCli", "C", 12, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cNomCli", "C", 80, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "dEntrada", "D", 8, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nImporte", "N", 16, 6,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cDesCriP", "C", 100, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "dPreCob", "D", 8, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cPgdoPor", "C", 50, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cDocPgo", "C", 50, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lCobrado", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cDivPgo", "C", 3, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nVdvPgo", "N", 10, 6,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lConPgo", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cConGuid", "C", 40, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCtaRec", "C", 12, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nImpEur", "N", 16, 6,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lImpEur", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nNumRem", "N", 9, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cSufRem", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCtaRem", "C", 3, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lRecImp", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lRecDto", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "dFecDto", "D", 8, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "dFecVto", "D", 8, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCodAge", "C", 3, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nNumCob", "N", 9, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cSufCob", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nImpCob", "N", 16, 6,,,,,, .F.,, .F., {} )
      oDbf:AddField( "nImpGas", "N", 16, 6,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCtaGas", "C", 12, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lEsperaDoc", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lCloPgo", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "dFecImp", "D", 8, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cHorImp", "C", 5, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lNotArqueo", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCodBnc", "C", 4, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "dFecCre", "D", 8, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cHorCre", "C", 5, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCodUsr", "C", 3, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lDevuelto", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "dFecDev", "D", 8, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cMotDev", "C", 250, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cRecDev", "C", 14, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lSndDoc", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cBncEmp", "C", 50, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cBncCli", "C", 50, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cEPaisIBAN", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cECtrlIBAN", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cEntEmp", "C", 4, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cSucEmp", "C", 4, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cDigEmp", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCtaEmp", "C", 10, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cPaisIBAN", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCtrlIBAN", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cEntCli", "C", 4, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cSucCli", "c", 4, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cDigCli", "C", 2, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cCtaCli", "C", 10, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "lRemesa", "L", 1, 0,,,,,, .F.,, .F., {} )
      oDbf:AddField( "cNumMtr", "C", 15, 0,,,,,, .F.,, .F., {} )

      oDbf:AddIndex( "nNumFac", ( cFileName ), "cSerie + Str( nNumFac ) + cSufFac + Str( nNumRec ) + cTipRec",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodCli", ( cFileName ), "cCodCli",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cNomCli", ( cFileName ), "cNomCli",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "lCodCli", ( cFileName ), "cCodCli", "!lCobrado",, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "dPreCob", ( cFileName ), "dPreCob",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "dFecVto", ( cFileName ), "dFecVto",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "dEntrada", ( cFileName ), "dEntrada",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nImporte", ( cFileName ), "nImporte",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nNumRem", ( cFileName ), "Str( nNumRem ) + cSufRem",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCtaRem", ( cFileName ), "cCtaRem",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodAge", ( cFileName ), "cCodAge",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nNumCob", ( cFileName ), "Str( nNumCob ) + cSufCob",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cTurRec", ( cFileName ), "cTurRec + cSufFac + cCodCaj",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "fNumFac", ( cFileName ), "cSerie + Str( nNumFac ) + cSufFac + Str( nNumRec ) + cTipRec", "Empty( cTipRec )",, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "rNumFac", ( cFileName ), "cSerie + Str( nNumFac ) + cSufFac + Str( nNumRec ) + cTipRec", "!Empty( cTipRec )",, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cRecDec", ( cFileName ), "cRecDev",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "lCtaBnc", ( cFileName ), "cEntEmp + cSucEmp + cDigEmp + cCtaEmp", "lCobrado",, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cNumMtr", ( cFileName ), "cNumMtr",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "iNumFac", ( cFileName ), "'21' + cSerie + str( nNumFac ) + Space( 1 ) + cSufFac + Str( nNumRec )",,, .F., .F.,,,, .T., .F. )



RETURN ( oDbf )



static FUNCTION TRemesas_LoadDetails( lAppend ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   If( lAppend == nil, lAppend := .F., ) ;

   CursorWait()

   ::GetFirstKey()

   if ::cFirstKey <> nil

      do case
         case ValType( ::oDbfDet ) == "O"

            ::oDbfVir         := ::DefineDetails( cPatTmp(), cLocalDriver(), .T. )

            if ::oDbfVir <> nil

               ::oDbfVir:Activate( .F., .F. )

               if ::nMode <> 1

                  if !lAppend .AND. ::bDefaultValues <> nil
                     Eval( ::bDefaultValues, Self )
                  end

                  if ( lAppend ) .AND. ::oDbfDet:Seek( ::cFirstKey )

                     while !Empty( ::oDbfDet:OrdKeyVal() ) .AND. ( ::oDbfDet:OrdKeyVal() <= ::cFirstKey ) .AND. !::oDbfDet:Eof()

                        if ::bOnPreLoad <> nil
                           Eval( ::bOnPreLoad, Self )
                        end

                        ::oDbfVir:AppendFromObject( ::oDbfDet )

                        if ::bOnPostLoad <> nil
                           Eval( ::bOnPostLoad, Self )
                        end

                        ::oDbfDet:Skip()

                     end

                     ::oDbfVir:GoTop()

                  end

               end

            end

         case ValType( ::oDbfDet ) == "A"

            if lAppend
               aSend( ::oDbfDet, "LoadAppend()" )
            else
               aSend( ::oDbfDet, "Load()" )
            end

      end

   end

   CursorWE()

RETURN ( self )



static FUNCTION TRemesas_Activate( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local oRotor

   if nAnd( ::nLevel, 1 ) = 0
      msgStop( "Acceso no permitido." )
      RETURN NIL
   end





   if ::oWndParent <> nil
      ::oWndParent:CloseAll()
   end

   if !::OpenFiles()
      return nil
   end

   ::CreateShell( ::nLevel )






   ::oWndBrw:NewAt( "BUS",,, {||( ::oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )
      ::oWndBrw:AddSeaBar()








   ::oWndBrw:NewAt( "NEW",,, {||( ::oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )






   ::oWndBrw:NewAt( "EDIT",,, {||( ::oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )






   ::oWndBrw:NewAt( "ZOOM",,, {||( ::oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )







  ::oWndBrw:NewAt( "DEL",,, {||( ::oWndBrw:RecDel() )}, "(E)liminar", "E",,, 16,, .F. )






   ::oWndBrw:NewAt( "IMP",,, {||( ::Report() )}, "(L)istado", "L",,, 32,, .F. )






   ::oWndBrw:NewAt( "gc_document_empty_chart_",,, {||( if( validRunReport( "01120" ), TFastVentasRecibos():New():Play(), ) )}, "(R)eporting", "R",,, 32,, .F. )






   ::oWndBrw:NewAt( "BmpExptar",,, {||( ::SaveModelo() )}, "E(x)portar", "X",,, 4,, .F. )






   ::oWndBrw:NewAt( "BmpConta",,, {||( ::SetOrdenNumeroRemesa(), ::SelectRec( {|| ::contabilizaRemesas( ::lChkSelect ) }, "Contabilizar remesas", "Simular" , .F. ), ::RestoreOrdenNumeroRemesa() )}, "(C)ontabilizar", "C",,, 4,, .F. )

   if RolesModel():getRolCambiarEstado( Auth():rolUuid() )






   ::oWndBrw:NewAt( "CHGSTATE",,, {||( ::SetOrdenNumeroRemesa(), ::SelectRec( {|| ::cambiaEstadoContabilizadoRemesas( ::lChkSelect ) }, "Cambiar estado", "Contabilizado" , .F. ), ::RestoreOrdenNumeroRemesa() )}, "Cambiar es(t)ado", "T",,, 4,, .F. )

   end




   oRotor := ::oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,,,,, .F. )




      ::oWndBrw:NewAt( "GC_DICTIONARY_",,, {||( if( !Empty( ::oDbf:cCodRem ), ::oCtaRem:Edit(), MsgStop( "Cuenta vacía" ) ) )}, "Modificar cuenta",,,,, oRotor, .F. )
   ::oWndBrw:EndButtons( Self )

   ::oWndBrw:Activate( , , , , , , , , , , , , , , , , {|| ::CloseFiles() } )

RETURN NIL



static FUNCTION TRemesas_OpenFiles( lExclusive ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local lOpen          := .T.
   local oError
   local oBlock

   If( lExclusive == nil, lExclusive := .F., ) ;

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

      ::oDbfDet := DbfServer( "FACCLIP.DBF", ):NewOpen( "FACCLIP.DBF",, ( cDriver() ),, ( ::cPath ), .F., .T., .F., .F. ) ; ::oDbfDet:AddBag( "FACCLIP.CDX" ) ; ::oDbfDet:AddBag( ) ; ::oDbfDet:AutoIndex()
      ::oDbfDet:OrdSetFocus( "nNumRem" )

      ::oFacCliT        := TDataCenter():oFacCliT()

      ::oFacCliL := DbfServer( "FACCLIL.DBF", ):NewOpen( "FACCLIL.DBF",, ( cDriver() ),, ( ::cPath ), .F., .T., .F., .F. ) ; ::oFacCliL:AddBag( "FACCLIL.CDX" ) ; ::oFacCliL:AddBag( ) ; ::oFacCliL:AutoIndex()

      ::oAntCliT := DbfServer( "AntCliT.DBF", ):NewOpen( "AntCliT.DBF",, ( cDriver() ),, ( ::cPath ), .F., .T., .F., .F. ) ; ::oAntCliT:AddBag( "AntCliT.CDX" ) ; ::oAntCliT:AddBag( ) ; ::oAntCliT:AutoIndex()

      ::oClientes := DbfServer( "CLIENT.DBF", ):NewOpen( "CLIENT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oClientes:AddBag( "CLIENT.CDX" ) ; ::oClientes:AddBag( ) ; ::oClientes:AutoIndex()

      ::oIva := DbfServer( "TIVA.DBF", ):NewOpen( "TIVA.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oIva:AddBag( "TIVA.CDX" ) ; ::oIva:AddBag( ) ; ::oIva:AutoIndex()

      ::oDivisas := DbfServer( "DIVISAS.DBF", ):NewOpen( "DIVISAS.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDivisas:AddBag( "DIVISAS.CDX" ) ; ::oDivisas:AddBag( ) ; ::oDivisas:AutoIndex()

      ::oDbfCnt := DbfServer( "nCount.Dbf", ):NewOpen( "nCount.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfCnt:AddBag( "nCount.Cdx" ) ; ::oDbfCnt:AddBag( ) ; ::oDbfCnt:AutoIndex()

      ::oFormaPago := DbfServer( "fPago.Dbf", ):NewOpen( "fPago.Dbf",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oFormaPago:AddBag( "fPago.Cdx" ) ; ::oFormaPago:AddBag( ) ; ::oFormaPago:AutoIndex()

      ::oCliBnc         := TDataCenter():oCliBnc()

      ::cPorDiv         := cPorDiv( cDivEmp(), ::oDivisas:cAlias )

      ::oBandera        := TBandera():New()

      ::oCtaRem         := TCtaRem():Create( cPatEmp() )
      ::oCtaRem:OpenFiles()

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de remesas de clientes" )

      ::CloseFiles()

      lOpen             := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TRemesas_OpenService( lExclusive, cPath ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local lOpen          := .T.
   local oError
   local oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   If( lExclusive == nil, lExclusive := .F., ) ;
   If( cPath == nil, cPath := ::cPath, ) ;

   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::DefineFiles( cPath )
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir todas las bases de datos de remesas de clientes" )

      ::CloseService()

      lOpen             := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TRemesas_CloseFiles( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   if ::oDbfDet <> nil .AND. ::oDbfDet:Used()
      ::oDbfDet:End()
   end

   if ::oDivisas <> nil .AND. ::oDivisas:Used()
      ::oDivisas:End()
   end

   if ::oDbfCnt <> nil .AND. ::oDbfCnt:Used()
      ::oDbfCnt:End()
   end

   if ::oClientes <> nil .AND. ::oClientes:Used()
      ::oClientes:End()
   end

   if ::oFacCliT <> nil .AND. ::oFacCliT:Used()
      ::oFacCliT:End()
   end

   if ::oFacCliL <> nil .AND. ::oFacCliL:Used()
      ::oFacCliL:End()
   end

   if ::oAntCliT <> nil .AND. ::oAntCliT:Used()
      ::oAntCliT:End()
   end

   if ::oIva <> nil .AND. ::oIva:Used()
      ::oIva:End()
   end

   if ::oCtaRem <> nil
      ::oCtaRem:End()
   end

   if ::oCliBnc <> nil .AND. ::oCliBnc:Used()
      ::oCliBnc:End()
   end

   if ::oFormaPago <> nil .AND. ::oFormaPago:Used()
      ::oFormaPago:End()
   end

   ::oDbf         := nil
   ::oDbfDet      := nil
   ::oDivisas     := nil
   ::oDbfCnt      := nil
   ::oClientes    := nil
   ::oDbfDet      := nil
   ::oCtaRem      := nil
   ::oCliBnc      := nil
   ::oFormaPago   := nil

   if ::bmpConta <> nil
      DeleteObject( ::bmpConta )
   end

   ::bmpConta     := nil

RETURN ( .T. )



static FUNCTION TRemesas_CloseService( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   if !Empty( ::oDbf )
      ::oDbf:End()
   end

   ::oDbf         := nil

RETURN ( .T. )



static FUNCTION TRemesas_inicializaData( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   ::cSerieInicio          := "A"
   ::cSerieFin             := "Z"

   ::nNumeroInicio         := 0
   ::nNumeroFin            := 999999999

   ::cSufijoInicio         := Space( 2 )
   ::cSufijoFin            := "ZZ"

   ::lNotImportCeros                   := .T.
   ::lNotImportSinCuenta               := .T.
   ::lNotImportarEsperaDocumentacion   := .T.

   ::cClienteIni           := dbFirst( ::oClientes, 1 )
   ::cClienteFin           := dbLast ( ::oClientes, 1 )

   ::cFormaPagoIni         := dbFirst( ::oFormaPago, 1 )
   ::cFormaPagoFin         := dbLast ( ::oFormaPago, 1 )

   ::cCuentaRemesaAnterior := ::oDbf:cCodRem

return ( nil )



static FUNCTION TRemesas_Resource( nMode ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local oDlg
   local oGet     := Array( 3 )
   local oSay
   local cSay     := ::oCtaRem:cRetCtaRem( ::oDbf:cCodRem )
   local oBmpDiv
   local oBtnImportar
   local oBmpGeneral

   ::inicializaData()

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "remesas de recibos a clientes", "RemCli",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_briefcase2_document_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::oDbf:nNumRem, ::oDbf:nNumRem:= u ) }, oDlg,, ::oDbf:FieldByName( "nNumRem" ):cPict,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:cSufRem, ::oDbf:cSufRem:= u ) }, oDlg,, ::oDbf:FieldByName( "cSufRem" ):cPict,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbf:dFecRem, ::oDbf:dFecRem:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      TGetHlp():ReDefine( 125, { | u | If( PCount()==0, ::oDbf:dIngreso, ::oDbf:dIngreso:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )






      ::oExportado := TCheckBox():ReDefine( 200, { | u | If( PCount()==0, ::oDbf:lExport, ::oDbf:lExport:= u ) }, oDlg,, {||( ::ChangeExport() )},,,,, .F., {||     ( nMode <> 3 )}, .F. )





      ::oFecExp := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, ::oDbf:dExport, ::oDbf:dExport:= u ) }, oDlg,,,,,,,,, .F., {||     ( ::oDbf:lExport .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      ::oGetCuentaRemesa := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbf:cCodRem, ::oDbf:cCodRem:= u ) }, oDlg,, ::oDbf:FieldByName( "cCodRem" ):cPict,,,,,,, .T.,,, .F., .F.,,,,,, nil, "LUPA",, )

      ::oGetCuentaRemesa:bValid := {|| ::validCuentaRemesa( oSay ) }
      ::oGetCuentaRemesa:bWhen  := {|| nMode <> 3 }
      ::oGetCuentaRemesa:bHelp  := {|| ::oCtaRem:Buscar( ::oGetCuentaRemesa ) }




      oSay := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, cSay, cSay:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      oGet[ 2 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::oDbf:cCodDiv, ::oDbf:cCodDiv:= u ) }, oDlg,, "@!",,,,,,, .T., {||     ( nMode == 1 .OR. ::oDbf:LastRec() == 0 )},, .F., .F.,,,,,, nil, "LUPA",, )

         oGet[2]:bValid := {|| cDivOut( oGet[2], oBmpDiv, oGet[3], nil, nil, nil, nil, nil, nil, nil, ::oDivisas:cAlias, ::oBandera ) }
         oGet[2]:bHelp  := {|| BrwDiv( oGet[2], oBmpDiv, oGet[3], ::oDivisas:cAlias, ::oBandera ) }




        oBmpDiv := TBitmap():ReDefine( 141, "BAN_EURO",, oDlg,,, .F., .F.,,, .F.,,, .F. )







      oGet[3] := TGetHlp():ReDefine( 142, { | u | If( PCount()==0, ::oDbf:nVdvDiv, ::oDbf:nVdvDiv:= u ) }, oDlg,, "@E 999,999.9999", {||    ( ::oDbf:nVdvDiv > 0 )},,,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )




      TRadMenu():Redefine( { | u | If( PCount()==0, ::oDbf:nTipRem, ::oDbf:nTipRem:= u ) }, oDlg,, { 160, 161 },,,,, .F., {||     ( nMode == 1 )}, )





      TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::oDbf:dConta, ::oDbf:dConta:= u ) }, oDlg,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      TMultiGet():ReDefine( 180, { | u | If( PCount()==0, ::oDbf:mComent, ::oDbf:mComent:= u ) }, oDlg,,,,,,, .F.,, .F.,, )









      TButton():ReDefine( 500, {||( ::AppendDet( nMode ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( ::EditDet() )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 502, {||( ::MultiDeleteDet() )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      oBtnImportar := TButton():ReDefine( 503, {||( ::ImportResource( nMode ) )}, oDlg,,, .F., {||     ( nMode == 1 )},,, .F. )





      TButton():ReDefine( 504, {||( ::setEstadosRecibos( .T. ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 505, {||( ::setEstadosRecibos( .F. ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      ::oBrwDet               := IXBrowse():New( oDlg )

      ::oBrwDet:bClrSel       := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      ::oBrwDet:bClrSelFocus  := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      ::oBrwDet:nMarqueeStyle := 6
      ::oBrwDet:cName         := "Remesas.Lineas"
      ::oBrwDet:lFooter       := .T.

      ::oDbfVir:SetBrowse( ::oBrwDet )

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Estado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| ::gotoRecibo(), ( if( ::oDbfDet:lCobrado, "Cobrado", "Pendiente" ) ) }
         :bBmpData         := {|| ::gotoRecibo(), ( if( ::oDbfDet:lCobrado, 1, 2 ) ) }
         :nWidth           := 20
         :AddResource( "bSel" )
         :AddResource( "gc_delete_16" )
         :AddResource( "gc_money2_16" )
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Número"
         :bEditValue       := {|| ::gotoRecibo(), ::oDbfDet:cSerie + "/" + Alltrim( Str( ::oDbfDet:nNumFac ) ) + "-" + AllTrim( Str( ::oDbfDet:nNumRec ) ) }
         :nWidth           := 90
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Delegción"
         :bEditValue       := {|| ::gotoRecibo(), ::oDbfDet:cSufFac }
         :nWidth           := 40
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Fecha"
         :bStrData         := {|| ::gotoRecibo(), DtoC( ::oDbfDet:dPreCob ) }
         :nWidth           := 80
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Vencimiento"
         :bStrData         := {|| ::gotoRecibo(), DtoC( ::oDbfDet:dFecVto ) }
         :nWidth           := 80
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Cliente"
         :bStrData         := {|| ::gotoRecibo(), Rtrim( ::oDbfDet:cCodCli ) + Space( 1 ) + Rtrim( ::oDbfDet:cNomCli ) }
         :nWidth           := 146
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Descripción"
         :bStrData         := {|| ::gotoRecibo(), ::oDbfDet:cDescrip }
         :nWidth           := 220
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Forma pago"
         :bStrData         := {|| ::gotoRecibo(), Rtrim( ::oDbfDet:cCodPgo ) + Space( 1 ) + cNbrFPago( ::oDbfDet:cCodPgo ) }
         :nWidth           := 150
         :lHide            := .T.
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Agente"
         :bStrData         := {|| ::gotoRecibo(), Rtrim( ::oDbfDet:cCodAge ) + Space( 1 ) + RetNbrAge( ::oDbfDet:cCodAge ) }
         :nWidth           := 150
         :lHide            := .T.
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| ::gotoRecibo(), nTotRecCli( ::oDbfDet, ::oDivisas:cAlias, ::oDbf:cCodDiv, .T. ) }
         :nWidth           := 100
         :bFooter          := {|| ::nTotRemVir( .T. ) }
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :nFootStrAlign    := 1
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| ::gotoRecibo(), cSimDiv( ::oDbfDet:cDivPgo, ::oDivisas:cAlias ) }
         :nWidth           := 20
      end

      with object ( ::oBrwDet:AddCol() )
         :cHeader          := "Cuenta"
         :bEditValue       := {|| ::gotoRecibo(), ::oDbfDet:cPaisIBAN + ::oDbfDet:cCtrlIBAN + "-" + ::oDbfDet:cEntCli + "-" + ::oDbfDet:cSucCli + "-" + ::oDbfDet:cDigCli + "-" + ::oDbfDet:cCtaCli }
         :nWidth           := 250
         :lHide            := .T.
      end

      ::oBrwDet:CreateFromResource( 150 )
      ::oBrwDet:bLDblClick := {|| ::EditDet() }





      TButton():ReDefine( 511, {||( if( ::lSave( nMode ), oDlg:End( 1 ), ) )}, oDlg,,, .F., {||         ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 510, {||( ::setCancelar( nMode ), oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 113, {|| ::AppendDet( nMode ) } )
      oDlg:AddFastKey( 115, {|| ::MultiDeleteDet() } )
      oDlg:AddFastKey( 116, {|| if( ::lSave( nMode ), oDlg:End( 1 ), ) } )
   end

   oDlg:SetControlFastKey( "remesasBancarias", self )

   oDlg:AddFastKey(  112,   {|| ChmHelp( "Remesasbancarias2" ) } )

   oDlg:bStart             := {|| ::oGetCuentaRemesa:SetFocus() }

   oDlg:Activate( , , , .T., , , {|| ::EdtRecMenu( oDlg ) } )

   ::EndEdtRecMenu()

   oBmpDiv:End()
   oBmpGeneral:End()



   ::oBrwDet:CloseData()

RETURN ( oDlg:nResult == 1 )



static FUNCTION TRemesas_validCuentaRemesa( oSay ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cCuentaRemesaActual  := ::oGetCuentaRemesa:varGet()

   if !::oCtaRem:lGetCtaRem( ::oGetCuentaRemesa, oSay )
      Return ( .F. )
   end



   if ::cCuentaRemesaAnterior <> cCuentaRemesaActual
      ::changeCuentaRemesa()
   end

RETURN .T.



static FUNCTION TRemesas_changeCuentaRemesa( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   if !::oCtaRem:oDbf:Seek( ::oDbf:cCodRem )
      msgStop( "Cuenta de remesa no encontrada." )
      Return .F.
   end

   ::oDbfVir:GoTop()
   while !::oDbfVir:Eof()

      if ::gotoRecibo()
         ::oDbfDet:Load()
         ::oDbfDet:cBncEmp    := ::oCtaRem:oDbf:cBanco
         ::oDbfDet:cEPaisIBAN := ::oCtaRem:oDbf:cPaisIBAN
         ::oDbfDet:cECtrlIBAN := ::oCtaRem:oDbf:cCtrlIBAN
         ::oDbfDet:cEntEmp    := ::oCtaRem:oDbf:cEntBan
         ::oDbfDet:cSucEmp    := ::oCtaRem:oDbf:cAgcBan
         ::oDbfDet:cDigEmp    := ::oCtaRem:oDbf:cDgcBan
         ::oDbfDet:cCtaEmp    := ::oCtaRem:oDbf:cCtaBan
         ::oDbfDet:Save()
      end

      ::oDbfVir:Skip()

      sysrefresh()

   end

   ::oDbfVir:GoTop()

   ::oBrwDet:Refresh()

RETURN ( .T. )



static FUNCTION TRemesas_ImportResource( nMode ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local oDlg

   oDlg = TDialog():New(,,,,, "ImpRemCli",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::dExpedicionIni, ::dExpedicionIni:= u ) }, oDlg,,,,,,,,, .T.,,, .F., .T.,,,,,, nil,,, )




      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::dExpedicionFin, ::dExpedicionFin:= u ) }, oDlg,,,,,,,,, .T.,,, .F., .T.,,,,,, nil,,, )




      TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::dVencimientoIni, ::dVencimientoIni:= u ) }, oDlg,,,,,,,,, .T.,,, .F., .T.,,,,,, nil,,, )




      TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::dVencimeintoFin, ::dVencimeintoFin:= u ) }, oDlg,,,,,,,,, .T.,,, .F., .T.,,,,,, nil,,, )









      ::oSerieInicio := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::cSerieInicio, ::cSerieInicio:= u ) }, oDlg,, "@!", {||    ( ::cSerieInicio >= "A" .AND. ::cSerieInicio <= "Z"  )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oSerieInicio ) )}, {||  ( DwSerie( ::oSerieInicio ) )},,,, nil,,, )









      ::oSerieFin := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::cSerieFin, ::cSerieFin:= u ) }, oDlg,, "@!", {||    ( ::cSerieFin >= "A" .AND. ::cSerieFin <= "Z"  )}, "N/W*",,,,, .F.,,, .F., .T., {||    ( UpSerie( ::oSerieFin ) )}, {||  ( DwSerie( ::oSerieFin ) )},,,, nil,,, )




      ::oNumeroInicio := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::nNumeroInicio, ::nNumeroInicio:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




      ::oNumeroFin := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::nNumeroFin, ::nNumeroFin:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




      ::oSufijoInicio := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, ::cSufijoInicio, ::cSufijoInicio:= u ) }, oDlg,, "@!",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




      ::oSufijoFin := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, ::cSufijoFin, ::cSufijoFin:= u ) }, oDlg,, "@!",,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )





      ::oClienteIni := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::cClienteIni, ::cClienteIni:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 151 )

         ::oClienteIni:bValid    := {|| cClient( ::oClienteIni, ::oClientes:cAlias, ::oClienteIni:oHelpText ) }
         ::oClienteIni:bHelp     := {|| BrwClient( ::oClienteIni, ::oClienteIni:oHelpText ) }





      ::oClienteFin := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::cClienteFin, ::cClienteFin:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 161 )

         ::oClienteFin:bValid    := {|| cClient( ::oClienteFin, ::oClientes:cAlias, ::oClienteFin:oHelpText ) }
         ::oClienteFin:bHelp     := {|| BrwClient( ::oClienteFin, ::oClienteFin:oHelpText ) }





      ::oFormaPagoIni := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::cFormaPagoIni, ::cFormaPagoIni:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 171 )

         ::oFormaPagoIni:bValid    := {|| cFpago( ::oFormaPagoIni, ::oFormaPago:cAlias, ::oFormaPagoIni:oHelpText ) }
         ::oFormaPagoIni:bHelp     := {|| BrwFPago( ::oFormaPagoIni, ::oFormaPagoIni:oHelpText ) }





      ::oFormaPagoFin := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::cFormaPagoFin, ::cFormaPagoFin:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 181 )

         ::oFormaPagoFin:bValid    := {|| cFpago( ::oFormaPagoFin, ::oFormaPago:cAlias, ::oFormaPagoFin:oHelpText ) }
         ::oFormaPagoFin:bHelp     := {|| BrwFPago( ::oFormaPagoFin, ::oFormaPagoFin:oHelpText ) }




      ::oNotImportCeros := TCheckBox():ReDefine( 250, { | u | If( PCount()==0, ::lNotImportCeros, ::lNotImportCeros:= u ) }, oDlg,,,,,,, .F.,, .F. )




      ::oNotImportSinCuenta := TCheckBox():ReDefine( 260, { | u | If( PCount()==0, ::lNotImportSinCuenta, ::lNotImportSinCuenta:= u ) }, oDlg,,,,,,, .F.,, .F. )




      ::oNotImportarEsperaDocumentacion := TCheckBox():ReDefine( 270, { | u | If( PCount()==0, ::lNotImportarEsperaDocumentacion, ::lNotImportarEsperaDocumentacion:= u ) }, oDlg,,,,,,, .F.,, .F. )





      TWebBtn():Redefine( 1170,,,,, {|This| ( aEval( ::oSer, {|o| Eval( o:bSetGet, .T. ), o:refresh() } ) ) }, oDlg,,,,, "LEFT",,,,, ( 0 + ( 0 * 256 ) + ( 255 * 65536 ) ), ( 0 + ( 0 * 256 ) + ( 255 * 65536 ) ) ):SetTransparent()

      TWebBtn():Redefine( 1180,,,,, {|This| ( aEval( ::oSer, {|o| Eval( o:bSetGet, .F. ), o:refresh() } ) ) }, oDlg,,,,, "LEFT",,,,, ( 0 + ( 0 * 256 ) + ( 255 * 65536 ) ), ( 0 + ( 0 * 256 ) + ( 255 * 65536 ) ) ):SetTransparent()

      ::oSer[  1 ] := TCheckBox():ReDefine( 1190, { | u | If( PCount()==0, ::aSer[  1 ], ::aSer[  1 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[  2 ] := TCheckBox():ReDefine( 1200, { | u | If( PCount()==0, ::aSer[  2 ], ::aSer[  2 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[  3 ] := TCheckBox():ReDefine( 1210, { | u | If( PCount()==0, ::aSer[  3 ], ::aSer[  3 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[  4 ] := TCheckBox():ReDefine( 1220, { | u | If( PCount()==0, ::aSer[  4 ], ::aSer[  4 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[  5 ] := TCheckBox():ReDefine( 1230, { | u | If( PCount()==0, ::aSer[  5 ], ::aSer[  5 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[  6 ] := TCheckBox():ReDefine( 1240, { | u | If( PCount()==0, ::aSer[  6 ], ::aSer[  6 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[  7 ] := TCheckBox():ReDefine( 1250, { | u | If( PCount()==0, ::aSer[  7 ], ::aSer[  7 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[  8 ] := TCheckBox():ReDefine( 1260, { | u | If( PCount()==0, ::aSer[  8 ], ::aSer[  8 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[  9 ] := TCheckBox():ReDefine( 1270, { | u | If( PCount()==0, ::aSer[  9 ], ::aSer[  9 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 10 ] := TCheckBox():ReDefine( 1280, { | u | If( PCount()==0, ::aSer[ 10 ], ::aSer[ 10 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 11 ] := TCheckBox():ReDefine( 1290, { | u | If( PCount()==0, ::aSer[ 11 ], ::aSer[ 11 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 12 ] := TCheckBox():ReDefine( 1300, { | u | If( PCount()==0, ::aSer[ 12 ], ::aSer[ 12 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 13 ] := TCheckBox():ReDefine( 1310, { | u | If( PCount()==0, ::aSer[ 13 ], ::aSer[ 13 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 14 ] := TCheckBox():ReDefine( 1320, { | u | If( PCount()==0, ::aSer[ 14 ], ::aSer[ 14 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 15 ] := TCheckBox():ReDefine( 1330, { | u | If( PCount()==0, ::aSer[ 15 ], ::aSer[ 15 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 16 ] := TCheckBox():ReDefine( 1340, { | u | If( PCount()==0, ::aSer[ 16 ], ::aSer[ 16 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 17 ] := TCheckBox():ReDefine( 1350, { | u | If( PCount()==0, ::aSer[ 17 ], ::aSer[ 17 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 18 ] := TCheckBox():ReDefine( 1360, { | u | If( PCount()==0, ::aSer[ 18 ], ::aSer[ 18 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 19 ] := TCheckBox():ReDefine( 1370, { | u | If( PCount()==0, ::aSer[ 19 ], ::aSer[ 19 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 20 ] := TCheckBox():ReDefine( 1380, { | u | If( PCount()==0, ::aSer[ 20 ], ::aSer[ 20 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 21 ] := TCheckBox():ReDefine( 1390, { | u | If( PCount()==0, ::aSer[ 21 ], ::aSer[ 21 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 22 ] := TCheckBox():ReDefine( 1400, { | u | If( PCount()==0, ::aSer[ 22 ], ::aSer[ 22 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 23 ] := TCheckBox():ReDefine( 1410, { | u | If( PCount()==0, ::aSer[ 23 ], ::aSer[ 23 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 24 ] := TCheckBox():ReDefine( 1420, { | u | If( PCount()==0, ::aSer[ 24 ], ::aSer[ 24 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 25 ] := TCheckBox():ReDefine( 1430, { | u | If( PCount()==0, ::aSer[ 25 ], ::aSer[ 25 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )
      ::oSer[ 26 ] := TCheckBox():ReDefine( 1440, { | u | If( PCount()==0, ::aSer[ 26 ], ::aSer[ 26 ]:= u ) }, oDlg,,,,,,, .F.,, .F. )

      ::oMeter    := TApoloMeter():ReDefine( 140, { | u | if( pCount() == 0, ::nMeter, ::nMeter := u ) }, 140, oDlg, .F., , , .T., ( 255 + ( 255 * 256 ) + ( 255 * 65536 ) ), , ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) ) )








      TButton():ReDefine( 1, {||( ::GetRecCli( oDlg, nMode )  )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )

      oDlg:bStart    := {|| ::oClienteIni:lValid(), ::oClienteFin:lValid(), ::oFormaPagoIni:lValid(), ::oFormaPagoFin:lValid() }

   oDlg:Activate( , , , .T. )

RETURN ( oDlg:nResult == 1 )



static FUNCTION TRemesas_lSave( nMode ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local lReturn  := .T.

   if nMode == 1

      if empty( ::oDbf:cCodRem )
         msgStop( "El número de cuenta no puede estar vacío." )
         ::oGetCuentaRemesa:SetFocus()
         lReturn  := .F.
      end

   end

RETURN ( lReturn )



static FUNCTION TRemesas_RollBack( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas









RETURN ( Self )



static FUNCTION TRemesas_SaveDetails( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cNumRec
   local cNumFac

   ::RollBack()



   ::oDbfVir:GoTop()
   while !::oDbfVir:Eof()

      SysRefresh()

      cNumFac                    := ::oDbfVir:cSerie + str( ::oDbfVir:nNumFac, 9 ) + ::oDbfVir:cSufFac
      cNumRec                    := cNumFac + str( ::oDbfVir:nNumRec, 2 ) + ::oDbfVir:cTipRec

      if ::oDbfDet:SeekInOrd( cNumRec, "nNumFac" )

         ::oDbfDet:Load()

         if ::oDbf:nTipRem == 2
            ::oDbfDet:lRecDto    := .T.
            ::oDbfDet:dFecDto    := ::getIngreso()
         end

         ::oDbfDet:cCtaRem       := ::oDbf:cCodRem
         ::oDbfDet:nNumRem       := ::oDbf:nNumRem
         ::oDbfDet:cSufRem       := ::oDbf:cSufRem
         ::oDbfDet:lRemesa       := .T.







         if empty( ::oDbfDet:cEPaisIBAN ) .OR. empty( ::oDbfDet:cECtrlIBAN ) .OR. empty( ::oDbfDet:cBncEmp )    .OR. empty( ::oDbfDet:cEntEmp )    .OR. empty( ::oDbfDet:cSucEmp )    .OR. empty( ::oDbfDet:cDigEmp )    .OR. empty( ::oDbfDet:cCtaEmp )

            ::oDbfDet:cEPaisIBAN := oRetFld( ::oDbf:cCodRem, ::oCtaRem:oDbf, "cPaisIBAN" )
            ::oDbfDet:cECtrlIBAN := oRetFld( ::oDbf:cCodRem, ::oCtaRem:oDbf, "cCtrlIBAN" )
            ::oDbfDet:cBncEmp    := oRetFld( ::oDbf:cCodRem, ::oCtaRem:oDbf, "cBanco" )
            ::oDbfDet:cEntEmp    := oRetFld( ::oDbf:cCodRem, ::oCtaRem:oDbf, "cEntBan" )
            ::oDbfDet:cSucEmp    := oRetFld( ::oDbf:cCodRem, ::oCtaRem:oDbf, "cAgcBan" )
            ::oDbfDet:cDigEmp    := oRetFld( ::oDbf:cCodRem, ::oCtaRem:oDbf, "cDgcBan" )
            ::oDbfDet:cCtaEmp    := oRetFld( ::oDbf:cCodRem, ::oCtaRem:oDbf, "cCtaBan" )

         end

         ::oDbfDet:Save()

      end



      if ::oFacCliT:Seek( cNumFac )
         chkLqdFacCli( nil, ::oFacCliT:cAlias, ::oFacCliL:cAlias, ::oDbfDet:cAlias, ::oAntCliT:cAlias, ::oIva:cAlias, ::oDivisas:cAlias )
      end

      ::oDbfVir:Skip()

   end

RETURN ( .T. )



static FUNCTION TRemesas_SaveModelo( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local oDlg
   local oBmpGeneral
   local oComboEsquema
   local oComboSequencia
   local oGetFicheroExportacion

   if ::oDbf:Recno() == 0
      Return ( Self )
   end

   ::cFicheroExportacion   := ::getFicheroExportacion()

   ::cEsquema              := getConfigUser( "Esquema",           ::cEsquema )
   ::cSequencia            := getConfigUser( "Sequencia",         ::cSequencia )
   ::lAgruparRecibos       := getConfigUser( "AgruparRecibos",    ::lAgruparRecibos )
   ::lUsarVencimiento      := getConfigUser( "UsarVencimiento",   ::lUsarVencimiento )



   oDlg = TDialog():New(,,,, "Remesa de recibos a soporte magnéticos según norma " + ( if( ::oDbf:nTipRem == 2, "58", "19" ) ), "Modelo19",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmpGeneral := TBitmap():ReDefine( 500, "gc_floppy_disk_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, ::lUsarVencimiento, ::lUsarVencimiento:= u ) }, oDlg,,,,,,, .F., {||     ( ::oDbf:nTipRem <> 2 )}, .F. )






      oGetFicheroExportacion := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cFicheroExportacion, ::cFicheroExportacion:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,, {|Self|( oGetFicheroExportacion:cText( cGetFile( "*.xml", "Selección de fichero" ) ) )}, nil, "FOLDER",, )




      TCheckBox():ReDefine( 100, { | u | If( PCount()==0, ::lAgruparRecibos, ::lAgruparRecibos:= u ) }, oDlg,,,,,,, .F., {||     ( ::oDbf:nTipRem <> 2 )}, .F. )





      oComboEsquema := TComboBox():ReDefine( 160, { | u | If( PCount()==0, ::cEsquema, ::cEsquema:= u ) }, { "CORE", "COR1" }, oDlg,,,,,,, .F.,,,,,,, "oComboEsquema",,,,,,, )





      oComboSequencia := TComboBox():ReDefine( 170, { | u | If( PCount()==0, ::cSequencia, ::cSequencia:= u ) }, { "OOFF", "FRST", "FNAL", "RCUR" }, oDlg,,,,,,, .F.,,,,,,, "oComboSequencia",,,,,,, )

      ::oTreeIncidencias   := TTreeView():Redefine( 150, oDlg )




      TButton():ReDefine( 550, {||( ::RunModelo( oDlg ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 551, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F. )

      oDlg:AddFastKey( 116, {|| ::RunModelo( oDlg ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   setConfigUser( "Esquema",           ::cEsquema )
   setConfigUser( "Sequencia",         ::cSequencia )
   setConfigUser( "AgruparRecibos",    ::lAgruparRecibos )
   setConfigUser( "UsarVencimiento",   ::lUsarVencimiento )

   if !Empty( oBmpGeneral )
      oBmpGeneral:End()
   end

RETURN ( Self )



static FUNCTION TRemesas_RunModelo( oDlg ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   oDlg:Disable()

   ::InitSepaXML19( oDlg )

   ::oDbf:FieldPutByName( "lExport", .T. )
   ::oDbf:FieldPutByName( "dExport",  GetSysDate() )

   ::setDirectorioExportacion()

   oDlg:Enable()

RETURN ( Self )



static FUNCTION TRemesas_InitMod58( oDlg ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

RETURN ( Self )



static FUNCTION TRemesas_GetRecCli( oDlg, nMode ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local n           := 0
   local cCodRem     := ::oDbf:cCodRem

   if Empty( cCodRem )
      msgStop( "Debe introducir un codigo de remesa" )
      return .T.
   end

   if ( nMode <> 1 )
      msgStop( "Solo se puede importar recibos añadiendo" )
      return .T.
   end

   oDlg:Disable()

   ::oMeter:nTotal   := ::oDbfDet:OrdKeyCount()

   ::oDbfDet:GoTop()
   while !::oDbfDet:Eof()




























































      if ::oDbfDet:cSerie >= ::cSerieInicio .AND. ::oDbfDet:cSerie <= ::cSerieFin                                    .AND. ::oDbfDet:nNumFac >= ::nNumeroInicio .AND. ::oDbfDet:nNumFac <= ::nNumeroFin                                .AND. ::oDbfDet:cSufFac >= ::cSufijoInicio .AND. ::oDbfDet:cSufFac <= ::cSufijoFin                                .AND. lChkSer( ::oDbfDet:cSerie, ::aSer )                                                                         .AND. !::lNowExist( ::oDbfDet:cSerie + Str( ::oDbfDet:nNumFac ) + ::oDbfDet:cSufFac + Str( ::oDbfDet:nNumRec ) )  .AND. !::oDbfDet:lCobrado                                                                                         .AND. !Empty( ::oDbfDet:dPreCob )                                                                                 .AND. Empty( ::oDbfDet:nNumRem )                                                                                  .AND. ::oDbfDet:dPreCob >= ::dExpedicionIni                                                                       .AND. ::oDbfDet:dPreCob <= ::dExpedicionFin                                                                       .AND. ::oDbfDet:dFecVto >= ::dVencimientoIni                                                                      .AND. ::oDbfDet:dFecVto <= ::dVencimeintoFin                                                                      .AND. ::oDbfDet:cCodCli >= ::cClienteIni                                                                          .AND. ::oDbfDet:cCodCli <= ::cClienteFin                                                                          .AND. ::oDbfDet:cCodPgo >= ::cFormaPagoIni                                                                        .AND. ::oDbfDet:cCodPgo <= ::cFormaPagoFin                                                                        .AND. ( !::lNotImportCeros .OR. ::oDbfDet:nImporte > 0 )                                                          .AND. ( !::lNotImportSinCuenta .OR. !Empty( ::oDbfDet:cCtaCli ) )                                                 .AND. ( !::lNotImportarEsperaDocumentacion .OR. !::oDbfDet:lEsperaDoc )

         if ::oDbfVir:Append()
            aEval( ::oDbfVir:aTField, {| oFld, n | ::oDbfVir:FldPut( n, ::oDbfDet:FieldGet( n ) ) } )

            if ::gotoRecibo()
               ::setEstadoRecibo( ::lDefCobrado, .F. )
            end

            ::oDbfVir:Save()
         end

         n++

      end

      ::oDbfDet:Skip()

      ::oMeter:Set( ::oDbfDet:OrdKeyNo() )

   end

   ::oMeter:Set( 0 )
   ::oMeter:Refresh()

   ::oDbfVir:GoTop()

   ::oBrwDet:Refresh()

   oDlg:Enable()
   oDlg:End()

   msgInfo( Ltrim( Trans( n, "999999999" ) ) + " recibos importados, en la cuenta " + cCodRem )

RETURN ( .T. )



static FUNCTION TRemesas_nTotRem( lPic ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local nTot     := 0

   If( lPic == nil, lPic := .F., ) ;

   if ::oDbfDet <> nil .AND. ::oDbf:nNumRem <> 0

      ::oDbfDet:GetStatus()

      if ::oDbfDet:Seek( Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem )
         while Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem == Str( ::oDbfDet:nNumRem, 9 ) + ::oDbfDet:cSufRem .AND. !::oDbfDet:eof()
            nTot  += nTotRecCli( ::oDbfDet, ::oDivisas:cAlias, ::oDbf:cCodDiv, .F. )
            ::oDbfDet:Skip()
         end
      end

      ::oDbfDet:SetStatus()

   end

RETURN ( if( lPic, Trans( nTot, ::cPorDiv ), nTot ) )



static FUNCTION TRemesas_nTotRemVir( lPic ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local nTot     := 0

   If( lPic == nil, lPic := .F., ) ;

   ::oDbfVir:GetStatus()

   ::oDbfVir:GoTop()
   while !::oDbfVir:eof()
      nTot        += nTotRecCli( ::oDbfVir, ::oDivisas:cAlias, ::oDbf:cCodDiv, .F. )
      ::oDbfVir:Skip()
   end

   ::oDbfVir:SetStatus()

RETURN ( if( lPic, Trans( nTot, ::cPorDiv ), nTot ) )



static FUNCTION TRemesas_AppendDet( nMode ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local nRec
   local aCodRec  := {}
   local cCodRec

   if BrwRecCli( @aCodRec, ::oDbfDet:cAlias, ::oClientes:cAlias, ::oDivisas:cAlias, ::oBandera )

      for each nRec in aCodRec

         ::oDbfDet:Goto( nRec )

         cCodRec  := ::oDbfDet:cSerie + Str( ::oDbfDet:nNumFac ) + ::oDbfDet:cSufFac + Str( ::oDbfDet:nNumRec ) + ::oDbfDet:cTipRec

         if ::lNowExist( cCodRec )
            msgStop( "Recibo ya incluido en remesa." )
            return ( .F. )
         end

         if ::oDbfDet:lCobrado
            msgStop( "Recibo ya cobrado." )
            return ( .F. )
         end

         if !Empty( ::oDbfDet:nNumRem )
            msgStop( "Recibo ya remesado." )
            return ( .F. )
         end

         if ::oDbfVir:Append()

            aEval( ::oDbfVir:aTField, {| oFld, n | ::oDbfVir:FldPut( n, ::oDbfDet:FieldGet( n ) ) } )

            if ::gotoRecibo()
               ::setEstadoRecibo( ::lDefCobrado, .F. )
            end

            ::oDbfVir:Save()

         end

      next

      ::oBrwDet:Refresh()

   end

RETURN ( Self )



static FUNCTION TRemesas_EditDet( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cNumeroRecibo  := ::oDbfVir:cSerie + Str( ::oDbfVir:nNumFac ) + ::oDbfVir:cSufFac + Str( ::oDbfVir:nNumRec )

   if edtRecCli( cNumeroRecibo )

      if ::oDbfDet:Seek( cNumeroRecibo )
         ::oDbfVir:Load()
         aeval( ::oDbfVir:aTField, {| oFld, n | ::oDbfVir:FldPut( n, ::oDbfDet:FieldGet( n ) ) } )
         ::oDbfVir:Save()
      end

   end

Return ( Self )



static FUNCTION TRemesas_Del( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local lEstadoAnterior   := .F.

   if RolesModel():getRolNoConfirmacionEliminacion( Auth():rolUuid() ) .OR. ApoloMsgNoYes("¿ Desea eliminar el registro en curso ?", "Confirme supresión" )

      lEstadoAnterior   := ApoloMsgNoYes("¿ Desea volver los recibos a su estado original ?", "Confirmación" )

      ::GetFirstKey()

      if !Empty( ::cFirstKey )
         while ::oDbfDet:Seek( ::cFirstKey )
            ::DelItem( lEstadoAnterior )
         end
      end

      ::oDbf:Delete()

   end

RETURN ( .T. )



static FUNCTION TRemesas_DelItem( lEstadoAnterior ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cNumFac              := ::oDbfDet:cSerie + Str( ::oDbfDet:nNumFac ) + ::oDbfDet:cSufFac

   If( lEstadoAnterior == nil, lEstadoAnterior := .F., ) ;

   ::oDbfDet:FieldPutByName( "nNumRem", 0 )
   ::oDbfDet:FieldPutByName( "cSufRem", "" )
   ::oDbfDet:FieldPutByName( "lRemesa", .F. )

   if lEstadoAnterior
      ::oDbfDet:FieldPutByName( "lCobrado", .F. )
   end

   if ::oFacCliT:Seek( cNumFac )
      chkLqdFacCli( nil, ::oFacCliT:cAlias, ::oFacCliL:cAlias, ::oDbfDet:cAlias, ::oAntCliT:cAlias, ::oIva:cAlias, ::oDivisas:cAlias )
   end

RETURN ( Self )



FUNCTION Remesas( oMenuItem, oWnd )

   local nLevel
   local oRemesas

   If( oMenuItem == nil, oMenuItem := "01060", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;

   nLevel               := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return nil
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end





   AddMnuNext( "Remesas de recibos", ProcName() )

   oRemesas  := TRemesas():New( cPatEmp() )
   oRemesas:Activate( nLevel )

RETURN NIL



static function cToCeros( nImporte, cPicture, nLen )

   local cImporte

   If( cPicture == nil, cPicture := "9999999999", ) ;
   If( nLen == nil, nLen := 10, ) ;

   cImporte          := Trans( nImporte, cPicture )
   cImporte          := StrTran( cImporte, ",", "" )
   cImporte          := StrTran( cImporte, ".", "" )
   cImporte          := StrTran( Right( cImporte, nLen ), " ", "0" )

return ( cImporte )






static FUNCTION TRemesas_SetRecCli( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   if Empty( ::oDbf:cCodRem )
      return ( Self )
   end

   ::oDbfDet:OrdSetFocus( "CCTAREM" )

   while ::oDbfDet:Seek( ::oDbf:cCodRem ) .AND. ::oDbfDet:cCtaRem == ::oDbf:cCodRem .AND. !::oDbfDet:Eof()

      ::oDbfDet:Load()
      ::oDbfDet:lCobrado  := .F.
      ::oDbfDet:nNumRem   := 0
      ::oDbfDet:cSufRem   := ""
      ::oDbfDet:dEntrada  := Ctod( "" )
      ::oDbfDet:Save()

      ::oDbfDet:Skip()

   end

   ::oDbfDet:OrdSetFocus( "NNUMREM" )

RETURN ( Self )



static FUNCTION TRemesas_contabilizaRemesas( lSimula ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local nAsiento
   local cCuentaPago    := ""
   local cCuentaCliente := ""
   local cNombreCliente := ""
   local cTextoRemesa   := ""
   local aSimula        := {}
   local cCodPro        := cProCnt()
   local cRuta          := cRutCnt()
   local cTerNif        := Space(1)
   local cTerNom        := Space(1)
   local lErrorFound    := .F.
   local cCodEmp        := cCodEmpCnt( "A" )



   if ::oDbf:lConta
      if !ApoloMsgNoYes( "Remesa : " + ::cNumRem() + " contabilizada." + Chr(13)+Chr(10) + "¿ Desea contabilizarla de nuevo ?" )
         return .F.
      end
   end

   if !::lChkSelect .AND. !ChkRuta( cRutCnt() )
      ::oTreeSelect:Add( "Remesa : " + ::cNumRem() + " ruta no valida.", 0 )
      lErrorFound          := .T.
   end



   if empty( cCodEmp ) .AND. !::lChkSelect
      ::oTreeSelect:Add( "Remesa : " + ::cNumRem() + " no se definierón empresas asociadas.", 0 )
      lErrorFound          := .T.
   end



   if ::oDbf:nTipRem == 2
      cCuentaPago          := ::oCtaRem:cRetCtaDto( ::oDbf:cCodRem )
   else
      cCuentaPago          := ::oCtaRem:cRetCtaCon( ::oDbf:cCodRem )
   end

   if ::oDbf:nTipRem == 2 .AND. !ChkSubcuenta( cRuta, cCodEmp, cCuentaPago, , .F., .F. )
      ::oTreeSelect:Add( "Cuenta : " + rtrim( cCuentaPago ) + " de pago remesa no existe.", 0 )
      lErrorFound          := .T.
   end



   if ::oDbfDet:Seek( Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem )

      while Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem == Str( ::oDbfDet:nNumRem ) + ::oDbfDet:cSufRem .AND. !::oDbfDet:eof()



         cCuentaCliente          := ""
         if ::oClientes:Seek( ::oDbfDet:cCodCli )
            if ::oDbf:nTipRem == 2
               cCuentaCliente    := ::oClientes:SubCtaDto
            else
               cCuentaCliente    := ::oClientes:SubCta
            end
         end

         if !ChkSubcuenta( cRuta, cCodEmp, cCuentaCliente, , .F., .F. )
            ::oTreeSelect:Add( "Cliente : " + Rtrim( ::oClientes:Titulo ) + " cuenta cliente no existe.", 0 )
            lErrorFound    := .T.
         end

         ::oDbfDet:Skip()

      end

   else

      ::oTreeSelect:Add( "Remesa : " + ::cNumRem() + " remesa sin recibos.", 0 )

      lErrorFound          := .T.

   end



   if Empty( ::oDbf:dConta )
      ::oTreeSelect:Add( "Remesa : " + ::cNumRem() + " sin fecha de contabilización", 0 )
      lErrorFound          := .T.
   end

   if !ChkFecha( , , ::oDbf:dConta, .F., ::oTreeSelect )
      lErrorFound          := .T.
   end



   if OpenDiario( , cCodEmp )
      nAsiento             := contaplusUltimoAsiento()
   else
      ::oTreeSelect:Add( "Remesa : " + ::cNumRem() + " imposible abrir ficheros.", 0 )
      RETURN .F.
   end

   if lAplicacionContaplus()





















      aadd( aSimula, MkAsiento(  nAsiento,  ::oDbf:cCodDiv, ::oDbf:dConta, cCuentaPago, , ::nTotRem( .F. ), "Remesa " + ::cNumRem(), , , , , , , cCodPro, , , , , lSimula, cTerNif, cTerNom ) )

   else











      EnlaceA3():getInstance():Add( {  "Empresa"               => cCodEmp, "Fecha"                 => ::oDbf:dConta, "TipoRegistro"          => "0", "Cuenta"                => cCuentaPago, "DescripcionCuenta"     => "Cobro remesa " + ::cNumRem(), "TipoImporte"           => "D", "ReferenciaDocumento"   => ::cNumRem(), "DescripcionApunte"     => "Cobro remesa " + ::cNumRem(), "Importe"               => ::nTotRem( .F. ), "Moneda"                => "E", "Render"                => "ApuntesSinIVA" } )

   end



   if ::oDbfDet:Seek( Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem )

      while Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem == Str( ::oDbfDet:nNumRem ) + ::oDbfDet:cSufRem .AND. !::oDbf:Eof()

         cCuentaCliente          := ""
         cNombreCliente          := ""

         if ::oClientes:Seek( ::oDbfDet:cCodCli )
            if ::oDbf:nTipRem == 2
               cCuentaCliente    := ::oClientes:SubCtaDto
            else
               cCuentaCliente    := ::oClientes:SubCta
            end
            cNombreCliente       := ::oClientes:Titulo
         end

         if lAplicacionContaplus()





















            aadd( aSimula, MkAsiento(  nAsiento,  ::oDbf:cCodDiv, ::oDbf:dConta, cCuentaCliente, , , "Remesa " + alltrim( ::cTextoRemesaContable() ) + ", Recibo " + ::oDbfDet:cSerie + "/" + alltrim( str( ::oDbfDet:nNumFac ) ) + "/" + ::oDbfDet:cSufFac + "-" + alltrim( str( ::oDbfDet:nNumRec ) ), nTotRecCli( ::oDbfDet:cAlias, ::oDivisas:cAlias, ::oDbf:cCodDiv, .F. ), ::oDbfDet:cSerie + str( ::oDbfDet:nNumFac ) + ::oDbfDet:cSufFac, , , , , cCodPro, , , , , lSimula, cTerNif, cTerNom ) )

         else











            EnlaceA3():getInstance():Add( {  "Empresa"               => cCodEmp, "Fecha"                 => ::oDbf:dConta, "TipoRegistro"          => "0", "Cuenta"                => cCuentaCliente, "DescripcionCuenta"     => cNombreCliente, "TipoImporte"           => "H", "ReferenciaDocumento"   => ::oDbfDet:cSerie + alltrim( str( ::oDbfDet:nNumFac ) ) , "DescripcionApunte"     => "Remesa " + alltrim( ::cNumRem() ) + ", Recibo " + ::oDbfDet:cSerie + "/" + alltrim( str( ::oDbfDet:nNumFac ) ) + "/" + ::oDbfDet:cSufFac + "-" + alltrim( str( ::oDbfDet:nNumRec ) ), "Importe"               => nTotRecCli( ::oDbfDet:cAlias, ::oDivisas:cAlias, ::oDbf:cCodDiv, .F. ), "Moneda"                => "E", "Render"                => "ApuntesSinIVA" } )

         end

         ::oDbfDet:Skip()

      end

   end



   if !lSimula .AND. !lErrorFound

      ::cambiaEstadoContabilizadoRemesas( .T. )

      if lAplicacionA3()

         if EnlaceA3():getInstance():Render():writeASCII()
            ::oTreeSelect:Add( "Fichero " + ( EnlaceA3():getInstance():cDirectory + "\" + EnlaceA3():getInstance():cFile ) + " exportado con exito.", 1 )
         end

         EnlaceA3():getInstance():destroyInstance()

      else

         ::oTreeSelect:Add( "Remesa : " + ::cNumRem() + " asiento generado num. " + alltrim( str( nAsiento ) ), 1 )

      end

   else

      msgTblCon( aSimula, ::oDbf:cCodDiv, ::oDivisas:cAlias, !lErrorFound, ::cNumRem(), {|| aWriteAsiento( aSimula, ::oDbf:cCodDiv, .T., ::oTreeSelect, ::cNumRem(), nAsiento ), ::cambiaEstadoContabilizadoRemesas( .T. ) } )

   end

   CloseDiario()

RETURN NIL



static FUNCTION TRemesas_cRetCtaRem( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cCtaRem  := ""

   if ::oCtaRem <> nil
      cCtaRem     := ::oCtaRem:cRetCtaRem( ::oDbf:cCodRem )
   end

RETURN ( cCtaRem )



static FUNCTION TRemesas_cBmp( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cBmpDiv  := ""

   if ::oDivisas <> nil .AND. ::oBandera <> nil
      cBmpDiv     := cSimDiv( ::oDbf:cCodDiv, ::oDivisas:cAlias )
   end

return ( cBmpDiv )



static FUNCTION TRemesas_GetNewCount( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   ::oDbf:nNumRem       := nNewDoc( nil, ::oDbf:nArea, "NREMESA", nil, ::oDbfCnt:nArea )

RETURN ( Self )



static FUNCTION TRemesas_lNowExist( cCodRec ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local lRet  := .F.

   ::oDbfVir:GetStatus()

   ::oDbfVir:GoTop()
   while !::oDbfVir:eof()
      if ::oDbfVir:cSerie + Str( ::oDbfVir:nNumFac, 9 ) + ::oDbfVir:cSufFac + Str( ::oDbfVir:nNumRec ) == cCodRec
         lRet  := .T.
      end
      ::oDbfVir:Skip()
   end

   ::oDbfVir:SetStatus()

RETURN ( lRet )



static FUNCTION TRemesas_lContabilizaRecibos( lConta ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   If( lConta == nil, lConta := .T., ) ;

   if ::oDbfDet <> nil

      ::oDbfDet:GetStatus()

      if ::oDbfDet:Seek( Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem )
         while Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem == Str( ::oDbfDet:nNumRem, 9 ) + ::oDbfDet:cSufRem .AND. !::oDbfDet:eof()

            ::oDbfDet:FieldPutByName( "lConPgo", lConta )

            ::oDbfDet:Skip()

         end
      end

      ::oDbfDet:SetStatus()

   end

RETURN ( Self )



static FUNCTION TRemesas_cambiaEstadoContabilizadoRemesas( lConta ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   ::oDbf:FieldPutByName( "lConta", lConta )





   ::lContabilizaRecibos( lConta )

   ::oWndBrw:Refresh()

RETURN Self



static FUNCTION TRemesas_nAllRecCli( cCodigoCliente ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local nTotRecCli  := 0
   local nRecno      := ::oDbfDet:Recno()

   while Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem + cCodigoCliente == Str( ::oDbfDet:nNumRem ) + ::oDbfDet:cSufRem + ::oDbfDet:cCodCli .AND. !::oDbfDet:Eof()

      nTotRecCli     += nTotRecCli( ::oDbfDet, ::oDivisas:cAlias, cDivEmp() )

      ::oDbfDet:Skip()

   end

   ::oDbfDet:GoTo( nRecno )

RETURN nTotRecCli



static FUNCTION TRemesas_EdtRecMenu( oDlg ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   ::oMenu := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )




            MenuAddItem( "&1. Modificar cuenta", "Modificar cuenta", .F.,, {|oMenuItem|( if( !Empty( ::oDbf:cCodRem ), ::oCtaRem:Edit(), MsgStop( "Cuenta vacía" ) ) )},, "gc_book_telephone_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&2. Modificar recibo", "Modificar el recibo seleccionado", .F.,, {|oMenuItem|( EdtRecCli( ::oDbfVir:cSerie + Str( ::oDbfVir:nNumFac ) + ::oDbfVir:cSufFac + Str( ::oDbfVir:nNumRec ) ) )},, "gc_briefcase2_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&3. Visualizar recibo", "Visualiza el recibo seleccionado", .F.,, {|oMenuItem|( ZooRecCli( ::oDbfVir:cSerie + Str( ::oDbfVir:nNumFac ) + ::oDbfVir:cSufFac + Str( ::oDbfVir:nNumRec ) ) )},, "gc_briefcase2_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )
         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( ::oMenu )

   ::oBrwDet:Load()

RETURN ( ::oMenu )



static FUNCTION TRemesas_EndEdtRecMenu( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

RETURN ( ::oMenu:End() )



static FUNCTION TRemesas_Report( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas



   ListRem():New( "Listado de remesas de clientes" ):Play()



RETURN ( self )







static FUNCTION TRemesas_InitMod19( oDlg ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

RETURN ( Self )



static FUNCTION TRemesas_InitSepa19( oDlg ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

RETURN ( Self )



static FUNCTION TRemesas_InitSepaXML19( oDlg ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local oBlock
   local oError

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::oTreeIncidencias:deleteAll()

      if ::lAgruparRecibos
         ::oDbfDet:OrdSetFocus( "nNumRem" )
      end

      ::oCuaderno             := SepaXml():New( ::getFicheroExportacionXml() )

      ::oCuaderno:setScheme( ::cEsquema )
      ::oCuaderno:setSeqTp( ::cSequencia )
      ::oCuaderno:setOriginalMessageIdentification( id_File( "REMESA" + alltrim( str( ::oDbf:nNumRem ) ) ) )
      ::oCuaderno:setPaymentInformationIdentification( alltrim( ::oCtaRem:oDbf:cNifPre ) + "." + ttos( datetime() ) )
      ::oCuaderno:setRequestedCollectionDate( sDate( ::getIngreso() ) )



      ::InsertPresentadorXml()



      ::InsertAcreedorXml()



      if ::oDbfDet:Seek( Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem )

         while ( str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem == str( ::oDbfDet:nNumRem, 9 ) + ::oDbfDet:cSufRem ) .AND. !( ::oDbfDet:eof() )

            ::InsertDeudorXml()

            ::oDbfDet:Skip()

         end

      end



      ::oCuaderno:Activate()

      if !empty( ::oCuaderno:aErrors )
         aeval( ::oCuaderno:aErrors, {|error| ::oTreeIncidencias:add( error ) } )
      else
         if file( ::oCuaderno:cFileOut ) .AND. apoloMsgNoYes( "Proceso de exportación realizado." + Chr(13)+Chr(10) + "¿ Desea abrir el fichero resultante ?", "Elija una opción." )
            shellExecute( 0, "open", ::oCuaderno:cFileOut, , , 1 )
         end
      end



      if ::lAgruparRecibos
         ::oDbfDet:OrdSetFocus( "nNumRem" )
      end

   RECOVER USING oError

      msgStop( "Error al generar remesa de recibos." + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

RETURN ( Self )



static FUNCTION TRemesas_InsertPresentador( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   with object ( ::oCuaderno:GetPresentador() )
      :Sufijo(       ::oCtaRem:oDbf:cSufCta )
      :Nombre(       ::oCtaRem:oDbf:cNomPre )
      :Referencia(   ::cNumRem() )
      :Nif(          ::oCtaRem:oDbf:cNifPre )
      :Entidad(      ::oCtaRem:oDbf:cEntPre )
      :Oficina(      ::oCtaRem:oDbf:cAgcPre )
   end

RETURN ( Self )



static FUNCTION TRemesas_InsertPresentadorXml( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   with object ( ::oCuaderno:oInitPart )
      :nEntity    := 0
      :Nm         := ::oCtaRem:oDbf:cNomPre
      :IBAN       := ::oCtaRem:oDbf:cPaisIBAN + ::oCtaRem:oDbf:cCtrlIBAN + ::oCtaRem:oDbf:cEntBan + ::oCtaRem:oDbf:cAgcBan + ::oCtaRem:oDbf:cDgcBan + ::oCtaRem:oDbf:cCtaBan
      :BICOrBEI   := getBIC( ::oCtaRem:oDbf:cEntPre )
      :id         := id_Name( ::oCtaRem:oDbf:cPaiPre, ::oCtaRem:oDbf:cSufCta, ::oCtaRem:oDbf:cNifPre )
      :Prtry      := "SEPA"
   end

RETURN ( Self )



static FUNCTION TRemesas_InsertAcreedor( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   with object ( ::oCuaderno:InsertAcreedor() )
      :FechaCobro(   ::oDbfDet:dFecVto )
      :Sufijo(       ::oCtaRem:oDbf:cSufCta )
      :Nombre(       ::oCtaRem:oDbf:cNomAcr )
      :Direccion(    ::oCtaRem:oDbf:cDirAcr )
      :CodigoPostal( ::oCtaRem:oDbf:cPosAcr )
      :Poblacion(    ::oCtaRem:oDbf:cPobAcr )
      :Provincia(    ::oCtaRem:oDbf:cProAcr )
      :Pais(         ::oCtaRem:oDbf:cPaiAcr )
      :Nif(          ::oCtaRem:oDbf:cNifPre )
      :CuentaIBAN(   ::bancoRemesa() )
   end

RETURN ( Self )



static FUNCTION TRemesas_InsertAcreedorXml( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   with object ( ::oCuaderno:oCreditor )
      :nEntity    := 0
      :Nm         := ::oCtaRem:oDbf:cNomAcr
      :BICOrBEI   := getBIC( ::oCtaRem:oDbf:cEntPre )
      :Id         := id_Name( ::oCtaRem:oDbf:cPaiPre, ::oCtaRem:oDbf:cSufCta, ::oCtaRem:oDbf:cNifAcr )
   end

RETURN ( Self )



static FUNCTION TRemesas_InsertDeudor( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   with object ( ::oCuaderno:InsertDeudor() )
      :Sufijo(             ::oCtaRem:oDbf:cSufCta )
      :Referencia(         "RECIBO" + ::TextoDocumento() )
      :ReferenciaMandato(  ::IdDocumento() )
      :Importe(            ::ImporteDocumento() )
      :EntidadBIC(         ::GetBICClient() )
      :Nombre(             ::oClientes:Titulo )
      :Direccion(          ::oClientes:Domicilio )
      :CodigoPostal(       ::oClientes:CodPostal )
      :Poblacion(          ::oClientes:Poblacion )
      :Provincia(          ::oClientes:Provincia )
      :Nif(                ::oClientes:Nif )
      :CuentaIBAN(         ::GetValidCuentaCliente() )
      :Concepto(           "FACTURA Nº" + ::TextoDocumento() )
   end

RETURN ( Self )



static FUNCTION TRemesas_InsertDeudorXml( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local oDebtor

   if !::oClientes:Seek( ::oDbfDet:cCodCli )
      ::oCuaderno:addError( "Código del cliente " + rtrim( ::oDbfDet:cCodCli ) + ", no existe." )
      RETURN ( Self )
   end

   if empty( ::GetValidCuentaCliente() )
      ::oCuaderno:addError( "Cuenta bancaria invalida, para el cliente " + rtrim( ::oDbfDet:cCodCli ) + ", en el recibo " + ::oDbfDet:cSerie + "/" + alltrim( str( ::oDbfDet:nNumFac ) ) + "-" + alltrim( str( ::oDbfDet:nNumRec ) ) )
      RETURN ( Self )
   end

   if empty( ::oCtaRem:dFechaFirma( ::oDbf:cCodRem ) )
      ::oCuaderno:addError( "Fecha de firma esta vacía en cuenta de remesa" )
      RETURN ( Self )
   end

   oDebtor              := SepaDebitActor():New( ::oCuaderno, "Dbtr" )
   oDebtor:nEntity      := 0
   oDebtor:Nm           := ::oClientes:Titulo
   oDebtor:Id           := ::oClientes:Nif
   oDebtor:InstdAmt     := ::ImporteDocumento()
   oDebtor:ReqdColltnDt := sDate( ::oDbf:dExport )
   oDebtor:IBAN         := ::GetValidCuentaCliente()
   oDebtor:BICOrBEI     := ::GetBICClient()
   oDebtor:MndtId       := hb_md5( alltrim( ::oClientes:Nif ) + ttos( datetime() ) )
   oDebtor:DtOfSgntr    := sDate( ::oCtaRem:dFechaFirma( ::oDbf:cCodRem ) )
   oDebtor:EndToEndId   := "Recibo " + ::TextoDocumento()

   ::oCuaderno:addDebtor( oDebtor )

RETURN ( Self )



static FUNCTION TRemesas_ChangeExport( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   if ::oDbf:lExport
      ::oDbf:dExport    := GetSysDate()
   else
      ::oDbf:dExport    := Ctod( "" )
   end

   ::oFecExp:Refresh()

RETURN .T.



static FUNCTION TRemesas_getSerieRecibos( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cSerieRecibo   := ""

   if ::oDbfDet:Seek( Str( ::oDbf:nNumRem, 9 ) + ::oDbf:cSufRem )
      cSerieRecibo      := ::oDbfDet:cSerie
   end

RETURN ( cSerieRecibo )



static FUNCTION TRemesas_getFicheroExportacion( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cFicheroExportacion  := ::getDirectorioExportacion()

   if ( rat( "\", cFicheroExportacion ) == 0 )
      cFicheroExportacion     += "\"
   end

   cFicheroExportacion        += "Remesa" + alltrim( str( ::oDbf:nNumRem, 9 ) ) + "-" + ::oDbf:cSufRem
   cFicheroExportacion        := padr( cFicheroExportacion, 200 )

Return ( cFicheroExportacion )



static FUNCTION TRemesas_getDirectorioExportacion( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cDirectory  := getPvProfString( "main", "Directorio SEPA", "", cIniAplication() )

   if empty( cDirectory )
      cDirectory     := "C:\Sepa"
   end

   cDirectory        := cpath( cDirectory )

RETURN ( cDirectory )



static FUNCTION TRemesas_setDirectorioExportacion( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local cDirectory  := cOnlyPath( ::cFicheroExportacion )

   if !empty( cDirectory )
      writePProString( "main", "Directorio SEPA", cDirectory, cIniAplication() )
   end

RETURN ( cDirectory )



static FUNCTION TRemesas_setEstadosRecibos( lCobrado ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local nSelect

   for each nSelect in ::oBrwDet:aSelected

      ::oDbfVir:goto( nSelect )

      if ::gotoRecibo()
         ::setEstadoRecibo( lCobrado, .F. )
         ::oBrwDet:Refresh()
      end

   next

RETURN ( nil )



static FUNCTION TRemesas_setCancelar( nMode ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   ::oDbfVir:gotop()

   while !::oDbfVir:Eof()

      if ::gotoRecibo()
         ::setEstadoRecibo( ::oDbfVir:lCobrado, .F., .T. )
      end

      ::oDbfVir:Skip()

   end

RETURN ( nil )



static FUNCTION TRemesas_DeleteDet( lMessage ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   If( lMessage == nil, lMessage := .T., ) ;

   if ::oDbfVir:Recno() == 0
      RETURN ( Self )
   end

   if RolesModel():getRolNoConfirmacionEliminacion( Auth():rolUuid() ) .OR. if( lMessage, ApoloMsgNoYes("¿ Desea eliminar definitivamente este registro ?", "Confirme supersión" ), .T. )

      if ::gotoRecibo()
         ::setEstadoRecibo( .F., .T. )
         ::setEstadoFactura()
      end

      ::oDbfVir:Delete( .T. )

      if ::bOnPostDeleteDetail <> nil
         Eval( ::bOnPostDeleteDetail, Self )
      end

      if( ::oBrwDet <> nil, ::oBrwDet:Refresh(), )

   end

RETURN ( Self )



static FUNCTION TRemesas_setEstadoFactura( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   local nNumFac
   local nOrdFac
   local nRecFac
   local nRecRec

   nNumFac        := ::oDbfDet:cSerie + Str( ::oDbfDet:nNumFac ) + ::oDbfDet:cSufFac

   nRecRec        := ::oDbfDet:Recno()

   nRecFac        := ::oFacCliT:Recno()
   nOrdFac        := ::oFacCliT:OrdSetFocus( "nNumFac" )

   if ::oFacCliT:Seek( nNumFac )
      ChkLqdFacCli( nil, ::oFacCliT:cAlias, ::oFacCliL:cAlias, ::oDbfDet:cAlias, ::oAntCliT:cAlias, ::oIva:cAlias, ::oDivisas:cAlias )
   end

   ::oFacCliT:OrdSetFocus( nOrdFac )
   ::oFacCliT:GoTo( nRecFac )
   ::oDbfDet:GoTo( nRecRec )

Return ( Self )



static FUNCTION TRemesas_SetOrdenNumeroRemesa( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   ::nRecAnterior       := ::oDbf:Recno()
   ::cOrdenAnterior     := ::oDbf:OrdSetFocus( "nNumRem" )

Return ( self )



static FUNCTION TRemesas_RestoreOrdenNumeroRemesa( ) ; local Self AS CLASS TRemesas := QSelf() AS CLASS TRemesas

   ::oDbf:OrdSetFocus( ::cOrdenAnterior )
   ::oDbf:GoTo( ::nRecAnterior )

Return ( self )



FUNCTION lValidRemesaCliente( oGetRemesaCliente, oDbfRemesaCliente )

   local lValid   := .F.
   local xValor   := oGetRemesaCliente:varGet()

   if empty( xValor )
      return .T.
   end

   if oDbfRemesaCliente:SeekInOrd( xValor, "nNumRem" )
      lValid      := .T.
   else
      msgStop( "Remesa no encontrada" )
   end

RETURN lValid
