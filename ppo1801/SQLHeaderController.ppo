#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 7 ".\Prg\Controllers\SQLHeaderController.prg"
_HB_CLASS SQLHeaderController ; function SQLHeaderController ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "SQLHeaderController", iif( .T., { @SQLBaseController() }, { @HBObject() } ), @SQLHeaderController() ) ) ;

   _HB_MEMBER getControllersHistoryBrowser(); oClass:AddMethod( "getControllersHistoryBrowser", @SQLHeaderController_getControllersHistoryBrowser(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER saveHistoryOfBrowsers(); oClass:AddMethod( "saveHistoryOfBrowsers", @SQLHeaderController_saveHistoryOfBrowsers(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER buildControllersRowSetWithForeingKey( id); oClass:AddMethod( "buildControllersRowSetWithForeingKey", @SQLHeaderController_buildControllersRowSetWithForeingKey(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER clearControllersTmpIds(); oClass:AddMethod( "clearControllersTmpIds", @SQLHeaderController_clearControllersTmpIds(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER updateIdParentControllersInEdit( id); oClass:AddMethod( "updateIdParentControllersInEdit", @SQLHeaderController_updateIdParentControllersInEdit(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER updateIdParentControllersInInsert(); oClass:AddMethod( "updateIdParentControllersInInsert", @SQLHeaderController_updateIdParentControllersInInsert(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER beginTransaction(); oClass:AddInline( "beginTransaction", {|Self | ( ( Self ) ), ( getSQLDatabase():beginTransaction() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER commitTransaction(); oClass:AddInline( "commitTransaction", {|Self | ( ( Self ) ), ( getSQLDatabase():commit() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER rollbackTransaction(); oClass:AddInline( "rollbackTransaction", {|Self | ( ( Self ) ), ( getSQLDatabase():rollback() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Append( oBrowse); oClass:AddMethod( "Append", @SQLHeaderController_Append(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Duplicate( oBrowse); oClass:AddMethod( "Duplicate", @SQLHeaderController_Duplicate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER initDuplicateMode(); oClass:AddMethod( "initDuplicateMode", @SQLHeaderController_initDuplicateMode(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER endDuplicateMode() ; oClass:AddVirtual( "endDuplicateMode" )
      _HB_MEMBER cancelDuplicateMode(); oClass:AddMethod( "cancelDuplicateMode", @SQLHeaderController_cancelDuplicateMode(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER endDuplicateModePosInsert(); oClass:AddMethod( "endDuplicateModePosInsert", @SQLHeaderController_endDuplicateModePosInsert(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Edit( oBrowse); oClass:AddMethod( "Edit", @SQLHeaderController_Edit(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER initEditMode(); oClass:AddMethod( "initEditMode", @SQLHeaderController_initEditMode(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER endEditMode() ; oClass:AddVirtual( "endEditMode" )
      _HB_MEMBER cancelEditMode(); oClass:AddMethod( "cancelEditMode", @SQLHeaderController_cancelEditMode(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER endEditModePosUpdate(); oClass:AddMethod( "endEditModePosUpdate", @SQLHeaderController_endEditModePosUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Zoom( oBrowse); oClass:AddMethod( "Zoom", @SQLHeaderController_Zoom(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER initZoomMode() ; oClass:AddVirtual( "initZoomMode" )
      _HB_MEMBER endZoomMode() ; oClass:AddVirtual( "endZoomMode" )
      _HB_MEMBER cancelZoomMode() ; oClass:AddVirtual( "cancelZoomMode" )

   _HB_MEMBER Delete( oBrowse); oClass:AddMethod( "Delete", @SQLHeaderController_Delete(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER initDeleteMode() ; oClass:AddVirtual( "initDeleteMode" )
      _HB_MEMBER endDeleteMode() ; oClass:AddVirtual( "endDeleteMode" )
      _HB_MEMBER cancelDeleteMode() ; oClass:AddVirtual( "cancelDeleteMode" )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS SQLHeaderController ;



static FUNCTION SQLHeaderController_Append( oBrowse ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   local nRecno
   local lTrigger

   if ::notUserAppend()
      msgStop( "Acceso no permitido." )
      RETURN ( .F. )
   end

   ::setAppendMode()

   if isFalse( ::initAppendMode() )
      RETURN ( .F. )
   end

   ::clearControllersTmpIds()

   ::buildControllersRowSetWithForeingKey( 0 )

   ::getControllersHistoryBrowser()

   ::beginTransaction()

   nRecno         := ::oModel:getRowSetRecno()

   ::oModel:loadBlankBuffer()

   if ::oView:Dialog()

      ::endAppendModePreInsert()

      ::oModel:insertBuffer()

      ::commitTransaction()

      ::updateIdParentControllersInInsert()

      ::endAppendModePostInsert()

      ::evalOnPostAppend()

   else

      ::rollbackTransaction()

      ::cancelAppendMode()

      ::oModel:setRowSetRecno( nRecno )

      RETURN ( .F. )

   end

   ::saveHistoryOfBrowsers()

   if !empty( oBrowse )
      oBrowse:refreshCurrent()
      oBrowse:setFocus()
   end

RETURN ( .T. )



static FUNCTION SQLHeaderController_Duplicate( oBrowse ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   local nRecno

   if ::notUserDuplicate()
      msgStop( "Acceso no permitido." )
      RETURN ( Self )
   end

   ::setDuplicateMode()

   nRecno         := ::oModel:getRowSetRecno()

   ::oModel:loadCurrentBuffer()

   if ::oView:Dialog( ::oModel )
      ::oModel:insertBuffer()
   else
      ::oModel:setRowSetRecno( nRecno )
   end

   if !empty( oBrowse )
      oBrowse:refreshCurrent()
      oBrowse:setFocus()
   end

RETURN ( Self )



static FUNCTION SQLHeaderController_initDuplicateMode( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   ::clearControllersTmpIds()

   ::buildControllersRowSetWithForeingKey( ::getIdfromRowset() )

   ::getControllersHistoryBrowser()

RETURN ( self )



static FUNCTION SQLHeaderController_endDuplicateModePosInsert( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   ::updateIdParentControllersInInsert()

   ::saveHistoryOfBrowsers()

RETURN ( self )



static FUNCTION SQLHeaderController_cancelDuplicateMode( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   ::saveHistoryOfBrowsers()

RETURN ( Self )



static FUNCTION SQLHeaderController_Edit( oBrowse ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   if ::notUserEdit()
      msgStop( "Acceso no permitido." )
      RETURN ( Self )
   end

   ::setEditMode()

   ::preEdit()

   ::oModel:setIdToFind( ::oModel:getKeyFieldOfRecno() )

   ::oModel:loadCurrentBuffer()

   if ::oView:Dialog( ::oModel )

      ::oModel:updateBuffer()

      ::postEdit()

   end

   if !empty( oBrowse )
      oBrowse:refreshCurrent()
      oBrowse:setFocus()
   end

RETURN ( .T. )



static FUNCTION SQLHeaderController_Zoom( oBrowse ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   if ::notUserZoom()
      msgStop( "Acceso no permitido." )
      RETURN ( Self )
   end

   ::setZoomMode()

   ::oModel:loadCurrentBuffer()

   ::oView:Dialog( ::oModel )

   if !empty( oBrowse )
      oBrowse:setFocus()
   end

RETURN ( Self )



static FUNCTION SQLHeaderController_initEditMode( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   ::clearControllersTmpIds()

   ::buildControllersRowSetWithForeingKey( ::getIdfromRowset() )

   ::beginTransaction()

   ::getControllersHistoryBrowser()

RETURN ( Self )



static FUNCTION SQLHeaderController_endEditModePosUpdate( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   ::updateIdParentControllersInEdit( ::getIdfromRowset() )

   ::commitTransaction()

   ::saveHistoryOfBrowsers()

RETURN ( Self )



static FUNCTION SQLHeaderController_cancelEditMode( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   ::rollbackTransaction()

   ::saveHistoryOfBrowsers()

RETURN ( self )



static FUNCTION SQLHeaderController_Delete( oBrowse ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   local nSelected
   local cNumbersOfDeletes

   if ::notUserDelete()
      msgStop( "Acceso no permitido." )
      RETURN ( Self )
   end

   if empty( oBrowse )
      msgStop( "Faltan parametros." )
      RETURN ( Self )
   end

   nSelected            := len( oBrowse:aSelected )

   if nSelected > 1
      cNumbersOfDeletes := alltrim( str( nSelected, 3 ) ) + " registros?"
   else
      cNumbersOfDeletes := "el registro en curso?"
   end

   if RolesModel():getRolNoConfirmacionEliminacion( Auth():rolUuid() ) .OR. msgNoYes( "¿Desea eliminar " + cNumbersOfDeletes, "Confirme eliminación" )
      ::oModel:deleteSelection( oBrowse:aSelected )
   end

   oBrowse:refreshCurrent()
   oBrowse:setFocus()

RETURN ( Self )



static FUNCTION SQLHeaderController_buildControllersRowSetWithForeingKey( id ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

RETURN ( hEval( ::ControllerContainer:getControllers(), {| k, oController| oController:oModel:buildRowSetWithForeignKey( id ) } ) )



static FUNCTION SQLHeaderController_clearControllersTmpIds( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

RETURN ( hEval( ::ControllerContainer:getControllers(), { | k, oController| oController:oModel:resetTmpIds() } ) )



static FUNCTION SQLHeaderController_updateIdParentControllersInEdit( id ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

RETURN ( hEval( ::ControllerContainer:getControllers(), { | k, oController| oController:oModel:confirmIdParentToChildsOf( ::getIdfromRowset() ) } ) )



static FUNCTION SQLHeaderController_updateIdParentControllersInInsert( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

   local lastId :=  getSQLDatabase():LastInsertId()

RETURN ( hEval( ::ControllerContainer:getControllers(), { | k, oController| oController:oModel:confirmIdParentToChildsOf( lastId ) } ) )



static FUNCTION SQLHeaderController_getControllersHistoryBrowser( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

RETURN ( hEval( ::ControllerContainer:getControllers(), { | k, oController| oController:getHistoryBrowse() } ) )



static FUNCTION SQLHeaderController_saveHistoryOfBrowsers( ) ; local Self AS CLASS SQLHeaderController := QSelf() AS CLASS SQLHeaderController

RETURN ( hEval( ::ControllerContainer:getControllers(), { | k, oController| oController:saveHistoryBrowse() } ) )
