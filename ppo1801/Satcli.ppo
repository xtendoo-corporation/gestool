#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 204 ".\.\Prg\Satcli.prg"
memvar cDbf
memvar cDbfCol
memvar cDetalle
memvar cCliente
memvar cDbfCli
memvar cDbfObr
memvar cDbfAge
memvar cAgente
memvar cDbfPgo
memvar cFPago
memvar cDbfIva
memvar cIva
memvar cPromoL
memvar cDbfPromol
memvar cDbfRut
memvar cDbfTrn
memvar cDbfPro
memvar cDbfTblPro
memvar aTotIva
memvar aTotIvm
memvar cCtaCli
memvar nTotBrt
memvar nTotIva
memvar nTotReq
memvar nTotImp
memvar nTotSat
memvar nTotDto
memvar nTotDpp
memvar nTotUno
memvar nTotDos
memvar nTotNet
memvar nTotPnt
memvar nTotCos
memvar nTotIvm
memvar nTotPes
memvar nTotAge
memvar nTotTrn
memvar nTotRnt
memvar nTotDif
memvar nTotAtp
memvar nPctRnt
memvar aIvaUno
memvar aIvaDos
memvar aIvaTre
memvar aIvmUno
memvar aIvmDos
memvar aIvmTre
memvar nTotUnd
memvar nTotPage
memvar aImpVto
memvar aDatVto
memvar cPicUndSat
memvar nVdvDivSat
memvar cPouDivSat
memvar cPorDivSat
memvar cPouChgSat
memvar nDouDivSat
memvar nRouDivSat
memvar nTotArt
memvar nTotCaj
memvar nPagina
memvar lEnd
memvar nTotalDto

memvar nNumArt
memvar nNumCaj

memvar oReport

static oWndBrw

static nView

static oBrwIva
static dbfRuta

static dbfSatCliI
static dbfSatCliD
static dbfSatCliS
static dbfClient
static dbfArtPrv
static dbfDiv
static dbfCajT
static oBandera
static oNewImp
static dbfCodebar
static dbfTarPreL
static dbfTarPreS
static dbfPromoT
static dbfPromoL
static dbfPromoC
static dbfIva
static dbfTmpLin
static dbfTmpInc
static dbfTmpDoc
static dbfTmpSer
static dbfKit
static dbfFPago
static dbfObrasT
static dbfAlm
static dbfAgent
static dbfFamilia
static dbfProvee
static dbfDoc
static dbfTblPro
static dbfPro
static dbfEstado

static lImpuestos
static oImpuestos

static dbfArtDiv
static dbfDelega
static dbfAgeCom
static dbfEmp
static dbfPedPrvL
static dbfAlbPrvL
static dbfFacPrvL
static dbfRctPrvL
static dbfPreCliL
static dbfPedCliL
static dbfFacCliL
static dbfFacRecL
static dbfTikCliL
static dbfFacCliP
static dbfAntCliT
static dbfTikCliT
static dbfProLin
static dbfProMat
static oOperario
static cTmpLin
static cTmpInc
static cTmpDoc
static cTmpSer
static oGetNet
static oGetTrn
static oGetIva
static oGetReq
static oGetAge
static oGetIvm
static oGetPnt
static oGetRnt
static oGetPes
static oGetDif
static oGetTotal
static oGetTarifa
static oFont
static oMenu
static cPouDiv
static cPorDiv
static cPicUnd
static nDouDiv
static nRouDiv
static cPpvDiv
static nDpvDiv
static nVdvDiv
static oStock
static oTipArt
static oGrpFam
static oFraPub
static bEdtRec          := { | aTmp, aGet, cSatCliT, oBrw, bWhen, bValid, nMode | EdtRec( aTmp, aGet, cSatCliT, oBrw, bWhen, bValid, nMode ) }
static bEdtDet          := { | aTmp, aGet, dbfSatCliL, oBrw, bWhen, bValid, nMode, aTmpSat | EdtDet( aTmp, aGet, dbfSatCliL, oBrw, bWhen, bValid, nMode, aTmpSat ) }
static bEdtInc          := { | aTmp, aGet, dbfSatCliL, oBrw, bWhen, bValid, nMode, aTmpSat | EdtInc( aTmp, aGet, dbfSatCliI, oBrw, bWhen, bValid, nMode, aTmpSat ) }
static bEdtDoc          := { | aTmp, aGet, dbfSatCliD, oBrw, bWhen, bValid, nMode, aTmpSat | EdtDoc( aTmp, aGet, dbfSatCliD, oBrw, bWhen, bValid, nMode, aTmpSat ) }

static cOldCodCli       := ""
static cOldCodArt       := ""
static cOldPrpArt       := ""
static cOldLotArt       := ""
static cOldUndMed       := ""
static cOldSituacion    := ""

static lOpenFiles       := .F.
static lExternal        := .F.
static oUndMedicion
static cFiltroUsuario   := ""

static nTarifaPrecio    := 0
static oBtnPrecio

static oComisionLinea
static nComisionLinea   := 0

static oMailing
static oMailingOperario

static cMaquina         := ""

static oDetCamposExtra

static oBtnKit

static oBrwProperties

static Counter

static oTrans

static oTipoCtrCoste
static cTipoCtrCoste
static aTipoCtrCoste       := { "Centro de coste", "Proveedor", "Agente", "Cliente" }
static oCentroCoste





FUNCTION GenSatCli( nDevice, cCaption, cCodDoc, cPrinter, nCopies )

   local oInf
   local oDevice
   local nNumSat

   if ( D():SatClientes( nView ) )->( Lastrec() ) == 0
      return nil
   end

   nNumSat              := ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat

   If( nDevice == nil, nDevice := 1, ) ;
   If( cCaption == nil, cCaption := "Imprimiendo S.A.T.", ) ;
   If( cCodDoc == nil, cCodDoc := cFormatoSATClientes(), ) ;

   if !lExisteDocumento( cCodDoc, dbfDoc )
      return nil
   end



   if Empty( nCopies )
      nCopies           := retfld( ( D():SatClientes( nView ) )->cCodCli, D():Get( "Client", nView ), "CopiasF" )
   end

   if nCopies == 0
      nCopies           := nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Get( "NCount", nView ) )
   end

   if nCopies == 0
      nCopies           := 1
   end





   if lVisualDocumento( cCodDoc, D():Documentos( nView ) )
      PrintReportSatCli( nDevice, nCopies, cPrinter, cCodDoc )
   else
      msgStop( "El formato ya no es soportado" )
   end

   lChgImpDoc( D():SatClientes( nView ) )

RETURN NIL



Static Function SatCliReportSkipper( dbf, dbfSatCliL )

   ( dbfSatCliL )->( dbSkip() )

   nTotPage              += nTotLSatCli( dbfSatCliL )

Return nil



Static Function ePage( oInf, cCodDoc )

   private nPagina      := oInf:nPage
   private lEnd         := oInf:lFinish

   PrintItems( cCodDoc, oInf )

Return nil



STATIC FUNCTION OpenFiles( lExt )

   local oError
   local oBlock

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de S.A.T. de clientes" )
      Return ( .F. )
   end

   If( lExt == nil, lExt := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      DisableAcceso()

      lOpenFiles        := .T.

      nView             := D():CreateView()





      D():Atipicas( nView )

      D():SatClientes( nView )

      D():SatClientesLineas( nView )

      D():Clientes( nView )

      D():objectGruposClientes( nView )

      D():Get( "CliInc", nView )

      D():ArticuloStockAlmacenes( nView )

      D():Articulos( nView )

      D():Documentos( nView )

      D():Contadores( nView )

      D():ArticuloLenguaje( nView )

      D():GetObject( "UnidadMedicion", nView )

      D():ImpuestosEspeciales( nView )

      D():Ofertas( nView )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SATCLII.DBF" ), ( cCheckArea( "SATCLII", @dbfSatCliI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "SATCLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SATCLID.DBF" ), ( cCheckArea( "SATCLID", @dbfSatCliD ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "SATCLID.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SATCLIS.DBF" ), ( cCheckArea( "SATCLIS", @dbfSatCliS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "SATCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROVART.DBF" ), ( cCheckArea( "PROVART", @dbfArtPrv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROVART.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGENTES.DBF" ), ( cCheckArea( "AGENTES", @dbfAgent ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGENTES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TarPreL.DBF" ), ( cCheckArea( "TarPreL", @dbfTarPreL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TarPreL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TarPreS.DBF" ), ( cCheckArea( "TarPreS", @dbfTarPreS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TarPreS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOT.DBF" ), ( cCheckArea( "PROMOT", @dbfPromoT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOL.DBF" ), ( cCheckArea( "PROMOL", @dbfPromoL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMOC.DBF" ), ( cCheckArea( "PROMOC", @dbfPromoC ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMOC.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RDOCUMEN.DBF" ), ( cCheckArea( "RDOCUMEN", @dbfDoc ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RDOCUMEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CTIPO" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRO.DBF" ), ( cCheckArea( "PRO", @dbfPro ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfTblPro ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAS", @dbfObrasT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RUTA.DBF" ), ( cCheckArea( "RUTA", @dbfRuta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RUTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTDIV.DBF" ), ( cCheckArea( "ARTDIV", @dbfArtDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "Almacen.Dbf" ), ( cCheckArea( "ALMACEN", @dbfAlm ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "Almacen.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DELEGA.DBF" ), ( cCheckArea( "DELEGA", @dbfDelega ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DELEGA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGECOM.DBF" ), ( cCheckArea( "AGECOM", @dbfAgeCom ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGECOM.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Empresa.DBF" ), ( cCheckArea( "Empresa", @dbfEmp ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Empresa.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PedProvL.DBF" ), ( cCheckArea( "PedProvL", @dbfPedPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PedProvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbProvL.DBF" ), ( cCheckArea( "AlbPROVL", @dbfAlbPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbProvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PedCliL.DBF" ), ( cCheckArea( "PedCliL", @dbfPedCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PedCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PreCLIL.DBF" ), ( cCheckArea( "PreCLIL", @dbfPreCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PreCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cStkFast" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACCLIL.DBF" ), ( cCheckArea( "FACCLIL", @dbfFacCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FacRecL.DBF" ), ( cCheckArea( "FacRecL", @dbfFacRecL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FacRecL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cRef" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @dbfTikCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CSTKFAST" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROLIN.DBF" ), ( cCheckArea( "PROLIN", @dbfProLin ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROLIN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PROMAT.DBF" ), ( cCheckArea( "PROMAT", @dbfProMat ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PROMAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "cCodArt" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.Dbf" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "Provee.Dbf" ), ( cCheckArea( "Provee", @dbfProvee ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "Provee.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ESTADOSAT.DBF" ), ( cCheckArea( "ESTADOSAT", @dbfEstado ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ESTADOSAT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      if !TDataCenter():OpenFacCliP( @dbfFacCliP )
         lOpenFiles     := .F.
      end

      oBandera          := TBandera():New()

      oStock            := TStock():Create( cPatEmp() )
      if !oStock:lOpenFiles()
         lOpenFiles     := .F.
      end

      oNewImp           := TNewImp():New( cPatEmp() )
      if !oNewImp:OpenFiles()
         lOpenFiles     := .F.
      end

      oTrans            := TTrans():New( cPatEmp() )
      if !oTrans:OpenFiles()
         lOpenFiles     := .F.
      end

      oTipArt           := TTipArt():Create( cPatEmp() )
      if !oTipArt:OpenFiles()
         lOpenFiles     := .F.
      end

      oGrpFam           := TGrpFam():Create( cPatEmp() )
      if !oGrpFam:OpenFiles()
         lOpenFiles     := .F.
      end

      oFraPub           := TFrasesPublicitarias():Create( cPatEmp() )
      if !oFraPub:OpenFiles()
         lOpenFiles     := .F.
      end



      oUndMedicion      := UniMedicion():Create( cPatEmp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles     := .F.
      end

      oOperario         := TOperarios():Create()
      if !oOperario:OpenFiles()
         lOpenFiles     := .F.
      end

      oCentroCoste        := TCentroCoste():Create( cPatDat() )
      if !oCentroCoste:OpenFiles()
         lOpenFiles     := .F.
      end

      oDetCamposExtra   := TDetCamposExtra():New()
      oDetCamposExtra:OpenFiles()
      oDetCamposExtra:SetTipoDocumento( "S.A.T" )
      oDetCamposExtra:setbId( {|| D():SatClientesId( nView ) } )

      oMailing          := TGenmailingDatabaseSATClientes():New( nView )
      oMailing:setBlockRecipients( {|| alltrim( retFld( ( D():SatClientes( nView ) )->cCodCli, D():Clientes( nView ), "cMeiInt" ) ) } )

      oMailingOperario  := TGenmailingDatabaseSATClientes():New( nView )
      oMailingOperario:setBlockRecipients( {|| alltrim( oRetFld( ( D():SatClientes( nView ) )->cCodOpe, oOperario:oDbf, "cMeiTra" ) ) } )

      Counter           := TCounter():New( nView, "nSatCli" )

      CodigosPostales():GetInstance():OpenFiles()





      oFont             := TFont():New( "Arial", 8, 26, .F., .T. )





      public nTotSat    := 0
      public nTotDto    := 0
      public nTotDPP    := 0
      public nTotNet    := 0
      public nTotIvm    := 0
      public nTotIva    := 0
      public nTotReq    := 0
      public nTotAge    := 0
      public nTotUno    := 0
      public nTotDos    := 0
      public nTotPnt    := 0
      public nTotTrn    := 0
      public nTotCos    := 0
      public nTotAtp    := 0
      public nTotPes    := 0
      public nPctRnt    := 0
      public nTotRnt    := 0
      public nTotDif    := 0
      public nTotUnd    := 0

      public aTotIva    := { { 0,0,nil,0,0,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0,0,0 } }
      public aIvaUno    := aTotIva[ 1 ]
      public aIvaDos    := aTotIva[ 2 ]
      public aIvaTre    := aTotIva[ 3 ]

      public aTotIvm    := { { 0,nil,0 }, { 0,nil,0 }, { 0,nil,0 }, }
      public aIvmUno    := aTotIvm[ 1 ]
      public aIvmDos    := aTotIvm[ 2 ]
      public aIvmTre    := aTotIvm[ 3 ]

      public aImpVto    := {}
      public aDatVto    := {}

      public nNumArt    := 0
      public nNumCaj    := 0





      if lAIS() .AND. !oUser():lAdministrador()

         cFiltroUsuario    := "Field->cSufPre == '" + Application():CodigoDelegacion() + "' .and. Field->cCodCaj == '" + Application():CodigoCaja() + "'"
         if RolesModel():getRolFiltrarVentas( Auth():rolUuid() )
            cFiltroUsuario += " .and. Field->cCodUsr == '" + Auth():Codigo()  + "'"
         end

         ( D():SatClientes( nView ) )->( AdsSetAOF( cFiltroUsuario ) )

      end

      EnableAcceso()

   RECOVER USING oError

      lOpenFiles     := .F.

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      EnableAcceso()

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

RETURN ( lOpenFiles )



STATIC FUNCTION CloseFiles()

   DisableAcceso()

   DestroyFastFilter( D():SatClientes( nView ), .T., .T. )

   if !Empty( oFont )
      oFont:end()
   end

   if !Empty( dbfSatCliI   )
      ( dbfSatCliI   )->( dbCloseArea() )
   end

   if !Empty( dbfSatCliD   )
      ( dbfSatCliD   )->( dbCloseArea() )
   end

   if !Empty( dbfSatCliS   )
      ( dbfSatCliS   )->( dbCloseArea() )
   end

   if !Empty( D():Clientes( nView ) )
      ( D():Clientes( nView )    )->( dbCloseArea() )
   end

   if !Empty( dbfIva )
      ( dbfIva       )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreL )
      ( dbfTarPreL   )->( dbCloseArea() )
   end

   if !Empty( dbfTarPreS )
      ( dbfTarPreS   )->( dbCloseArea() )
   end

   if !Empty( dbfPromoT )
      ( dbfPromoT    )->( dbCloseArea() )
   end

   if !Empty( dbfPromoL )
      ( dbfPromoL    )->( dbCloseArea() )
   end

   if !Empty( dbfPromoC )
      ( dbfPromoC    )->( dbCloseArea() )
   end

   if !Empty( dbfAgent )
      ( dbfAgent     )->( dbCloseArea() )
   end

   if dbfCodebar <> nil
      ( dbfCodebar )->( dbCloseArea() )
   end

   if !Empty( dbfFPago )
      ( dbfFPago     )->( dbCloseArea() )
   end

   if !Empty( dbfDiv )
      ( dbfDiv       )->( dbCloseArea() )
   end

   if !Empty( dbfDoc )
      ( dbfDoc       )->( dbCloseArea() )
   end

   if !Empty( dbfFamilia )
      ( dbfFamilia   )->( dbCloseArea() )
   end

   if !Empty( dbfKit )
      ( dbfKit       )->( dbCloseArea() )
   end

   if !Empty( dbfPro )
      ( dbfPro       )->( dbCloseArea() )
   end

   if !Empty( dbfTblPro )
      ( dbfTblPro    )->( dbCloseArea() )
   end

   if !Empty( dbfObrasT )
      ( dbfObrasT    )->( dbCloseArea() )
   end

   if !Empty( dbfRuta )
      ( dbfRuta      )->( dbCloseArea() )
   end

   if !Empty( dbfArtDiv )
      ( dbfArtDiv    )->( dbCloseArea() )
   end

   if !Empty( dbfCajT )
      ( dbfCajT )->( dbCloseArea() )
   end

   if !Empty( dbfAlm )
      ( dbfAlm )->( dbCloseArea() )
   end

   if dbfArtPrv <> nil
      ( dbfArtPrv )->( dbCloseArea() )
   end

   if dbfDelega <> nil
      ( dbfDelega )->( dbCloseArea() )
   end

   if dbfAgeCom <> nil
      ( dbfAgeCom )->( dbCloseArea() )
   end

   if dbfEmp <> nil
      ( dbfEmp )->( dbCloseArea() )
   end

   if dbfPedPrvL <> nil
      ( dbfPedPrvL )->( dbCloseArea() )
   end

   if dbfAlbPrvL <> nil
      ( dbfAlbPrvL )->( dbCloseArea() )
   end

   if dbfFacPrvL <> nil
      ( dbfFacPrvL )->( dbCloseArea() )
   end

   if dbfRctPrvL <> nil
      ( dbfRctPrvL )->( dbCloseArea() )
   end

   if dbfPedCliL <> nil
      ( dbfPedCliL )->( dbCloseArea() )
   end

   if dbfPreCliL <> nil
      ( dbfPreCliL )->( dbCloseArea() )
   end

   if dbfFacCliL <> nil
      ( dbfFacCliL )->( dbCloseArea() )
   end

   if dbfFacRecL <> nil
      ( dbfFacRecL )->( dbCloseArea() )
   end

   if dbfTikCliT <> nil
      ( dbfTikCliT )->( dbCloseArea() )
   end

   if dbfTikCliL <> nil
      ( dbfTikCliL )->( dbCloseArea() )
   end

   if dbfProLin <> nil
      ( dbfProLin )->( dbCloseArea() )
   end

   if dbfProMat <> nil
      ( dbfProMat )->( dbCloseArea() )
   end

   if dbfFacCliP <> nil
      ( dbfFacCliP )->( dbCloseArea() )
   end

   if dbfAntCliT <> nil
      ( dbfAntCliT )->( dbCloseArea() )
   end

   if dbfEstado <> nil
      ( dbfEstado )->( dbCloseArea() )
   end

   if !Empty( oNewImp )
      oNewImp:End()
   end

   if !Empty( oStock )
      oStock:end()
   end

   if !Empty( oTipArt )
      oTipArt:end()
   end

   if !Empty( oGrpFam )
      oGrpFam:end()
   end

   if !Empty( oUndMedicion )
      oUndMedicion:end()
   end

   if !Empty( oFraPub )
      oFraPub:end()
   end

   if !Empty( oOperario )
      oOperario:End()
   end

   if !Empty( oDetCamposExtra )
      oDetCamposExtra:CloseFiles()
   end

   if !Empty( oCentroCoste )
      oCentroCoste:End()
   end

   if !empty( oMailing )
      oMailing:end()
   end

   if !empty( oMailingOperario )
      oMailingOperario:End()
   end

   if !Empty( oTrans )
      oTrans:End()
   end

   D():DeleteView( nView )

   CodigosPostales():GetInstance():CloseFiles()

   dbfSatCliI     := nil
   dbfSatCliD     := nil
   dbfArtPrv      := nil
   dbfIva         := nil
   dbfTarPreL     := nil
   dbfTarPreS     := nil
   dbfPromoT      := nil
   dbfPromoL      := nil
   dbfPromoC      := nil
   dbfAgent       := nil
   dbfCodebar     := nil
   dbfFpago       := nil
   dbfDiv         := nil
   dbfDoc         := nil
   dbfFamilia     := nil
   dbfKit         := nil
   dbfPro         := nil
   dbfTblPro      := nil
   dbfObrasT      := nil
   dbfRuta        := nil
   dbfArtDiv      := nil
   dbfCajT        := nil
   dbfDelega      := nil
   oBandera       := nil
   oNewImp        := nil
   oTrans         := nil
   oStock         := nil
   oTipArt        := nil
   oGrpFam        := nil
   dbfAgeCom      := nil
   dbfEmp         := nil
   dbfEstado      := nil

   oOperario      := nil

   dbfPedPrvL     := nil
   dbfAlbPrvL     := nil
   dbfFacPrvL     := nil
   dbfFacPrvL     := nil

   dbfPedCliL     := nil
   dbfPedCliL     := nil
   dbfFacCliL     := nil
   dbfFacRecL     := nil
   dbfTikCliL     := nil

   dbfProLin      := nil
   dbfProMat      := nil

   oCentroCoste   := nil

   lOpenFiles     := .F.

   oWndBrw        := nil

   EnableAcceso()

RETURN .T.



FUNCTION SatCli( oMenuItem, oWnd, cCodCli, cCodArt )

   local oSnd
   local oRpl
   local oImp
   local oPrv
   local oDel
   local oPdf
   local oMail
   local oDup
   local oBtnEur
   local nLevel
   local lEuro          := .F.
   local oRotor
   local oScript

   If( oMenuItem == nil, oMenuItem := "sat_de_clientes", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;
   If( cCodCli == nil, cCodCli := "", ) ;
   If( cCodArt == nil, cCodArt := "", ) ;

   nLevel               := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      return .F.
   end





   DisableAcceso()

























   oWndBrw := TShell():New( 0, 0, 22, 80, "S.A.T. a clientes",, oWnd,,, .F.,,, ( D():SatClientes( nView ) ),,,,, {"Número", "Fecha", "Código", "Nombre", "Código postal", "Población", "Provincia", "Dirección", "Agente", "Operario", "Estado artículo", "Situación"}, {||( WinAppRec( oWndBrw:oBrw, bEdtRec, D():SatClientes( nView ), cCodCli, cCodArt ) )}, {||( WinEdtRec( oWndBrw:oBrw, bEdtRec, D():SatClientes( nView ), cCodCli, cCodArt ) )}, {||( WinDelRec( oWndBrw:oBrw, D():SatClientes( nView ), {|| QuiSatCli() } ) )}, {||( WinDupRec( oWndBrw:oBrw, bEdtRec, D():SatClientes( nView ), cCodCli, cCodArt ) )}, nil, nLevel, "gc_power_drill_sat_user_16", ( 190 + ( 57 * 256 ) + ( 0 * 65536 ) ),, {||( WinZooRec( oWndBrw:oBrw, bEdtRec, D():SatClientes( nView ) ) )}, .T. )

     oWndBrw:lFechado     := .T.

     oWndBrw:bChgIndex    := {|| if( RolesModel():getRolFiltrarVentas( Auth():rolUuid() ), CreateFastFilter( cFiltroUsuario, D():SatClientes( nView ), .F., , cFiltroUsuario ), CreateFastFilter( "", D():SatClientes( nView ), .F. ) ) }

     oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():SatClientes( nView ) )->lCloSat }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "gc_lock2_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Estado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():SatClientes( nView ) )->lEstado }
         :nWidth           := 20
         :SetCheck( { "gc_check_12", "gc_delete_12" } )
         :AddResource( "gc_trafficlight_on_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():SatClientes( nView ) )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "gc_mail2_16" )

      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Incidencia"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nEstadoIncidencia( ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat ) }
         :nWidth           := 20
         :lHide            := .T.
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_check_12" )
         :AddResource( "gc_document_information_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Imprimir"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():SatClientes( nView ) )->lImprimido }
         :nWidth           := 20
         :lHide            := .T.
         :SetCheck( { "Sel16", "Nil16" } )
         :AddResource( "gc_printer2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumSat"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cSerSat + "/" + AllTrim( Str( ( D():SatClientes( nView ) )->nNumSat ) ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cCodDlg }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| Trans( ( D():SatClientes( nView ) )->cTurSat, "######" ) }
         :nWidth           := 40
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dDesFec"
         :bEditValue       := {|| Dtoc( ( D():SatClientes( nView ) )->dFecSat ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cCodCaj }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Usuario"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cCodUsr }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( D():SatClientes( nView ) )->cCodCli ) }
         :nWidth           := 70
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cNomCli }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código postal"
         :cSortOrder       := "CodPostal"
         :bEditValue       := {|| alltrim( ( D():SatClientes( nView ) )->cPosCli ) }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Población"
         :cSortOrder       := "Poblacion"
         :bEditValue       := {|| alltrim( ( D():SatClientes( nView ) )->cPobCli ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Provincia"
         :cSortOrder       := "Provincia"
         :bEditValue       := {|| alltrim( ( D():SatClientes( nView ) )->cPrvCli ) }
         :nWidth           := 100
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Agente"
         :cSortOrder       := "cCodAge"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cCodAge }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Situación"
         :cSortOrder       := "cSituac"
         :bEditValue       := {|| AllTrim( ( D():SatClientes( nView ) )->cSituac ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Estado artículo"
         :cSortOrder       := "cCodEst"
         :bStrData         := {|| AllTrim( ( D():SatClientes( nView ) )->cCodEst ) + if( !Empty( ( D():SatClientes( nView ) )->cCodEst ), " - ", "" ) + RetFld( ( D():SatClientes( nView ) )->cCodEst, dbfEstado, "cNombre" ) }
         :nWidth           := 140
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Operario"
         :cSortOrder       := "cCodOpe"
         :bStrData         := {|| AllTrim( ( D():SatClientes( nView ) )->cCodOpe ) + if( !Empty( ( D():SatClientes( nView ) )->cCodOpe ), " - ", "" ) + oRetFld( ( D():SatClientes( nView ) )->cCodOpe, oOperario:oDbf, "cNomTra", "cCodTra" ) }
         :nWidth           := 140
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Ruta"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cCodRut }
         :nWidth           := 40
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Almacén"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cCodAlm }
         :nWidth           := 60
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Dirección"
         :cSortOrder       := "cCodObr"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->cCodObr }
         :nWidth           := 50
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->nTotNet }
         :cEditPicture     := cPorDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( D():SatClientes( nView ) )->nTotIva }
         :cEditPicture     := cPorDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "R.E."
         :bEditValue       := {|| ( D():SatClientes( nView ) )->nTotReq }
         :cEditPicture     := cPorDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( D():SatClientes( nView ) )->nTotSat }
         :cEditPicture     := cPorDiv()
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEuro, cDivChg(), ( D():SatClientes( nView ) )->cDivSat ), dbfDiv ) }
         :nWidth           := 30
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

   oDetCamposExtra:addCamposExtra( oWndBrw )

   oWndBrw:cHtmlHelp    := "S.A.T de clientes"

   oWndBrw:CreateXFromCode()





   oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar()







   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )







   oDup := oWndBrw:NewAt( "DUP",,, {||( oWndBrw:RecDup() )}, "(D)uplicar", "D",, {|This|This:Toggle()}, 2,, .F. )







      oWndBrw:NewAt( "Dup",,, {||( DupSerie( oWndBrw ) )}, "Series",,,, 2, oDup, .F. )






   oWndBrw:NewAt( "EDIT",,, {||( oWndBrw:RecEdit() )}, "(M)odificar", "M",,, 4,, .F. )






   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )







   oDel := oWndBrw:NewAt( "DEL",,, {||( oWndBrw:RecDel() )}, "(E)liminar", "E",, {|This|This:Toggle()}, 16,, .F. )








   oPrv := oWndBrw:NewAt( "IMP",, "Imprimir pedidos", {||( GenSatCli( 1 ), oWndBrw:Refresh() )}, "(I)mprimir", "I",, {|This|This:Toggle()}, 32,, .F. )


      lGenSatCli( oWndBrw:oBrw, oPrv, 1 )





   oWndBrw:NewAt( "GC_PRINTER2_",,, {||( ImprimirSeriesSatClientes() )}, "Imp(r)imir series", "R",,, 32,, .F. )








   oImp := oWndBrw:NewAt( "PREV1",, "Satvisualizar pedidos", {||( GenSatCli( 2 ), oWndBrw:Refresh() )}, "(P)revisualizar", "P",, {|This|This:Toggle()}, 32,, .F. )


      lGenSatCli( oWndBrw:oBrw, oImp, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",,, {||( GenSatCli( 3 ) )}, "Pd(f)", "F",, {|This|This:Toggle()}, 32,, .F. )


      lGenSatCli( oWndBrw:oBrw, oPdf, 3 )




   oMail := oWndBrw:NewAt( "GC_MAIL_EARTH_",,, {||( oMailing:documentsDialog( oWndBrw:oBrw:aSelected ) )}, "Correo electrónico cliente",,,, 32,, .F. )





   oMail := oWndBrw:NewAt( "GC_MAIL_EARTH_",,, {||( oMailingOperario:documentsDialog( oWndBrw:oBrw:aSelected ) )}, "Correo electrónico operario",,,, 32,, .F. )






   oWndBrw:NewAt( "gc_portable_barcode_scanner_",,, {||( TLabelGeneratorSATClientes():New( nView ):Dialog() )}, "Eti(q)uetas", "Q",,, 32,, .F. )

   if oUser():lAdministrador()






      oWndBrw:NewAt( "CHGSTATE",,, {||( ChgState( oWndBrw:oBrw ) )}, "Cambiar Es(t)ado", "T",,, 4,, .F. )

   end








   oSnd := oWndBrw:NewAt( "LBL",, "Seleccionar S.A.T. para ser enviados", {||lSnd( oWndBrw, D():SatClientes( nView ) )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():SatClientes( nView ), "lSndDoc", .T., .T., .T. ) )}, "Todos",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():SatClientes( nView ), "lSndDoc", .F., .T., .T. ) )}, "Ninguno",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():SatClientes( nView ), "lSndDoc", .T., .F., .T. ) )}, "Abajo",,,, 4, oSnd, .F. )






   oBtnEur := oWndBrw:NewAt( "gc_currency_euro_",,, {||( lEuro := !lEuro, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )
   if RolesModel():getRolCambiarCampos( Auth():rolUuid() )






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():SatClientes( nView ), aItmSatCli() ) )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():SatClientesLineas( nView ), aColSatCli() ) )}, "Lineas",,,, 4, oRpl, .F. )

   end






   oWndBrw:NewAt( "INFO",,, {||( TTrazaDocumento():Activate( "32", ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat ) )}, "I(n)forme documento", "N",,, 4,, .F. )




   oWndBrw:NewAt( "gc_document_text_pencil_",,, {||( Counter:OpenDialog() )}, "Establecer contadores",,,,,, .F. )





   oScript := oWndBrw:NewAt( "gc_folder_document_",,, {||( oScript:Expand() )}, "Scripts",,,,,, .F. )
      ImportScript( oWndBrw, oScript, "SATClientes", nView )






   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,, {|This|This:Toggle()},,, .F. )




      oWndBrw:NewAt( "GC_USER_",,, {||( EdtCli( ( D():SatClientes( nView ) )->cCodCli ) )}, "Modificar cliente",,,,, oRotor, .F. )




      oWndBrw:NewAt( "INFO",,, {||( InfCliente( ( D():SatClientes( nView ) )->cCodCli ) )}, "Informe de cliente",,,,, oRotor, .F. )




      oWndBrw:NewAt( "GC_WORKER2_",,, {||( if( !Empty( ( D():SatClientes( nView ) )->cCodObr ), EdtObras( ( D():SatClientes( nView ) )->cCodCli, ( D():SatClientes( nView ) )->cCodObr, dbfObrasT ), MsgStop( "No hay obra asociada al S.A.T." ) ) )}, "Modificar dirección",,,,, oRotor, .F. )







      oWndBrw:NewAt( "GC_DOCUMENT_EMPTY_",,, {||( if( !( D():SatClientes( nView ) )->lEstado, AlbCli( nil, nil, { "SAT" => D():SatClientesId( nView ) }  ), msgStop( "El S.A.T. ya ha sido convertido" ) ) )}, "Generar albarán",,,,, oRotor, .T. )







      oWndBrw:NewAt( "GC_DOCUMENT_TEXT_USER_",,, {||( if( !( D():SatClientes( nView ) )->lEstado, FactCli( nil, nil, { "SAT" => D():SatClientesId( nView ) } ), msgStop( "El S.A.T. ya ha sido convertido" ) ) )}, "Generar factura",,,,, oRotor, .T. )







      oWndBrw:NewAt( "GC_CASH_REGISTER_USER_",,, {||( if( !( D():SatClientes( nView ) )->lEstado, generateTicketFromDocument( { "SAT" => D():SatClientesId( nView ) } ), msgStop( "El S.A.T. ya ha sido convertido" ) ) )}, "Convertir a ticket",,,,, oRotor, .T. )




   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .F. )

   oWndBrw:oActiveFilter:SetFields( aItmSatCli() )
   oWndBrw:oActiveFilter:SetFilterType( "32" )

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp, .F. )

   EnableAcceso()

   if !empty( oWndBrw )

      if uFieldempresa( "lFltYea" )
         oWndBrw:setYearCombobox()
      end

      if !empty( cCodCli ) .OR. !empty( cCodArt )
         oWndBrw:RecAdd()
         cCodCli  := nil
         cCodArt  := nil
      end

   end

Return .T.



STATIC FUNCTION EdtRec( aTmp, aGet, dbf, oBrw, cCodCli, cCodArt, nMode )

   local oDlg
   local oFld
   local nOrd
   local oBrwLin
   local oBrwInc
   local oBrwDoc
   local oSay           := Array( 11 )
   local cSay           := Array( 11 )
   local oSayLabels     := Array( 10 )
   local oGetMasDiv
   local cGetMasDiv     := ""
   local oBmpEmp
   local oBmpDiv
   local oRieCli
   local nRieCli
   local oTlfCli
   local cTlfCli
   local cSerie         := cNewSer( "nSatCli", D():Documentos( nView ) )
   local oAprovado
   local cAprovado
   local oSayGetRnt
   local cTipSat
   local oSayDias
   local oBmpGeneral
   local oBmpEstado





   cOldCodCli           := aTmp[6]
   cOldSituacion        := aTmp[ 61 ]

   setOldPorcentajeAgente( aTmp[ 43 ] )

   do case
   case nMode == 1

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 17 ]  := Application():codigoAlmacen()
      aTmp[ 46 ]  := cDivEmp()
      aTmp[ 18 ]  := Application():CodigoCaja()
      aTmp[ 19 ]  := cDefFpg()
      aTmp[ 58 ]  := Auth():Codigo()
      aTmp[ 47 ]  := nChgDiv( aTmp[ 46 ], dbfDiv )
      aTmp[ 22 ]  := .F.
      aTmp[ 3 ]  := RetSufEmp()
      aTmp[ 62 ]  := nDiasValidez()
      aTmp[ 48 ]  := .T.
      aTmp[ 67 ]  := Application():CodigoDelegacion()
      aTmp[ 52 ]  := uFieldEmpresa( "lIvaInc" )
      aTmp[ 73 ]  := padr( getConfigTraslation( "Gastos" ), 250 )
      aTmp[ 53 ]  := nIva( dbfIva, cDefIva() )

      if !Empty( cCodCli )
         aTmp[ 6 ]  := cCodCli
      end

   case nMode == 2

      if aTmp[ 57 ] .AND. !oUser():lAdministrador()
         msgStop( "El S.A.T. está cerrado." )
         Return .F.
      end

      lChangeRegIva( aTmp )

      aTmp[ 58 ]  := Auth():Codigo()

   case nMode == 4

      if !lCurSesion()
         MsgStop( "No hay sesiones activas, imposible añadir documentos" )
         Return .F.
      end

      if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lAdministrador()
         msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
         Return .F.
      end

      aTmp[ 5 ]  := GetSysDate()
      aTmp[ 4 ]  := cCurSesion()
      aTmp[ 22 ]  := .F.
      aTmp[ 57 ]  := .F.
      aTmp[ 58 ]  := Auth():Codigo()

   end

   if Empty( Rtrim( aTmp[ 1 ] ) )
      aTmp[ 1 ]  := cSerie
   end

   if Empty( aTmp[ 28 ] )
      aTmp[ 28 ]  := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end

   if Empty( aTmp[ 29 ] )
      aTmp[ 29 ]  := Padr( "General", 50 )
   end

   if Empty( aTmp[ 31 ] )
      aTmp[ 31 ]     := Padr( "Pronto pago", 50 )
   end





   if BeginTrans( aTmp, nMode )
      Return .F.
   end

   cAprovado            := if( aTmp[ 22 ], "Aprobado", "" )





   if Empty( aTmp[ 75 ] )
      aTmp[ 75 ]  := RetFld( aTmp[ 6 ], D():Clientes( nView ), "Telefono" )
   end





   nOrd                 := ( D():SatClientes( nView ) )->( ordSetFocus( 1 ) )

   cPicUnd              := MasUnd()
   cPouDiv              := cPouDiv( aTmp[ 46 ], dbfDiv )
   cPorDiv              := cPorDiv( aTmp[ 46 ], dbfDiv )
   nDouDiv              := nDouDiv( aTmp[ 46 ], dbfDiv )
   nRouDiv              := nRouDiv( aTmp[ 46 ], dbfDiv )





   cSay[ 2 ]            := RetFld( aTmp[ 16 ], dbfTarPreS )
   cSay[ 3 ]            := RetFld( aTmp[ 6 ] + aTmp[ 15 ], dbfObrasT, "cNomObr" )
   cSay[ 4 ]            := RetFld( aTmp[ 17 ], dbfAlm )
   cSay[ 5 ]            := RetFld( aTmp[ 19 ], dbfFPago )
   cSay[ 6 ]            := RetFld( aTmp[ 14 ], dbfAgent )
   cSay[ 7 ]            := RetFld( aTmp[ 20 ], dbfRuta )
   cSay[ 8 ]            := oTrans:cNombre( aTmp[ 55 ] )
   cSay[ 9 ]            := RetFld( aTmp[ 18 ], dbfCajT )
   cSay[10 ]            := UsuariosModel():getNombreWhereCodigo( aTmp[ 58 ] )
   cSay[11 ]            := RetFld( cCodEmp() + aTmp[ 67 ], dbfDelega, "cNomDlg" )

   cTlfCli              := RetFld( aTmp[ 6 ], D():Clientes( nView ), "Telefono" )

   nRieCli              := oStock:nRiesgo( aTmp[ 6 ] )





   InitTarifaCabecera( aTmp[ 28 ] )





   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "S.A.T. a clientes", "PEDCLI",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )











      oFld := TFolder():ReDefine( 200, {"&S.A.T.", "Da&tos", "&Incidencias", "D&ocumentos"}, { "SATCLI_1","SATCLI_2","PEDCLI_3","PEDCLI_4" }, oDlg,,,,, .F., )









      oBmpGeneral := TBitmap():ReDefine( 990, "gc_power_drill_sat_user_48",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_folders2_48",, oFld:aDialogs[2],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_information_48",, oFld:aDialogs[3],,, .F., .F.,,, .F.,,, .T. )





      oBmpGeneral := TBitmap():ReDefine( 990, "gc_address_book_48",, oFld:aDialogs[4],,, .F., .F.,,, .F.,,, .T. )







      aGet[6] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[6], aTmp[6]:= u ) }, oFld:aDialogs[1],,, {||    ( LoaCli( aGet, aTmp, nMode, oRieCli ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[6] ) )}, nil, "LUPA",, )







      TBtnBmp():ReDefine( 341, "Info16",,,,, {|Self|( CargaMaquinas( aTmp, oBrwLin ) )}, oFld:aDialogs[1], .F.,, .F., "",,,,, !.T.,, .F.,,, .F., !.F.,, .F. )




      aGet[7] := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, aTmp[7], aTmp[7]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[12] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 8 ] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 8 ], Rtrim( aTmp[ 9 ] ) + Space( 1 ) + Rtrim( aTmp[ 10 ] ) )}, nil, "gc_earth_lupa_16",, )




      aGet[ 9 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 10 ] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )





      aGet[ 11 ] := TGetHlp():ReDefine( 107, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],,, {||    ( CodigosPostales():GetInstance():validCodigoPostal() )},,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )















      oGetTarifa  := comboTarifa():Build( { "idCombo" => 132, "uValue" => aTmp[ 28 ] } )
      oGetTarifa:Resource( oFld:aDialogs[1] )







      oBtnPrecio := TBtnBmp():ReDefine( 174, "gc_arrow_down_16",,,,, {|Self|( ChangeTarifaCabecera( oGetTarifa:getTarifa(), dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1], .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )}, .F.,,,,,, !.T.,, .F.,,, .F., !.F.,, .F. )








      oRieCli := TGetHlp():ReDefine( 133, { | u | If( PCount()==0, nRieCli, nRieCli:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[75] := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, aTmp[75], aTmp[75]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 13 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )











      aGet[16] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[16], aTmp[16]:= u ) }, oFld:aDialogs[1],,, {||    ( cTarifa( aGet[16], oSay[ 2 ] ) )},,,,,, .F., {||     ( nMode <> 3 .AND. oUser():lAdministrador() )},, .F., .F.,,,,, {|Self|( BrwTarifa( aGet[16], oSay[ 2 ] ) )}, nil, "LUPA",, )




      oSay[ 2 ] := TGetHlp():ReDefine( 141, { | u | If( PCount()==0, cSay[ 2 ], cSay[ 2 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[15] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[15], aTmp[15]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[ 15 ], oSay[ 3 ], aTmp[ 6 ], dbfObrasT ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwObras( aGet[ 15 ], oSay[ 3 ], aTmp[ 6 ], dbfObrasT ) )}, nil, "LUPA",, )




      oSay[ 3 ] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cSay[ 3 ], cSay[ 3 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 17 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 17 ], aTmp[ 17 ]:= u ) }, oFld:aDialogs[ 1 ],,, {||    ( cAlmacen( aGet[ 17 ], , oSay[ 4 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[ 17 ], oSay[ 4 ] ) )}, nil, "LUPA",, )






      oSay[ 4 ] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSay[ 4 ], cSay[ 4 ]:= u ) }, oFld:aDialogs[ 1 ],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( ExpAlmacen( aTmp[ 17 ], dbfTmpLin, oBrwLin ) )}, nil, "Bot",, )












      aGet[ 19 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cFPago( aGet[ 19 ], dbfFPago, oSay[ 5 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ 19 ], oSay[ 5 ] ) )}, nil, "LUPA",, )




      oSay[ 5 ] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, cSay[ 5 ], cSay[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ 14 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oFld:aDialogs[1],,, {||    ( LoadAgente( aGet[ 14 ], dbfAgent, oSay[ 6 ], aGet[ 43 ], dbfAgeCom, dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 14 ], oSay[ 6 ] ) )}, nil, "LUPA",, )






      oSay[ 6 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, cSay[ 6 ], cSay[ 6 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( changeAgentPercentageInAllLines(aTmp[ 43 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )}, nil, "Bot",, )







      aGet[ 43 ] := TGetHlp():ReDefine( 182, { | u | If( PCount()==0, aTmp[ 43 ], aTmp[ 43 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( validateAgentPercentage( aGet[ 43 ], dbfTmpLin, oBrwLin ), RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( !Empty( aTmp[ 14 ] ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      oGetAge := TGetHlp():ReDefine( 183, { | u | If( PCount()==0, nTotAge, nTotAge:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      aGet[ 83 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 83 ], aTmp[ 83 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 310 )

         aGet[ 83 ]:bHelp     := {|| oOperario:Buscar( aGet[ 83 ] ) }
         aGet[ 83 ]:bValid    := {|| oOperario:Existe( aGet[ 83 ], aGet[ 83 ]:oHelpText, "cNomTra", .T., .T., "0" ) }











      aGet[ 20 ] := TGetHlp():ReDefine( 185, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cRuta( aGet[ 20 ], dbfRuta, oSay[ 7 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[ 20 ], dbfRuta, oSay[ 7 ] ) )}, nil, "LUPA",, )




      oSay[ 7 ] := TGetHlp():ReDefine( 186, { | u | If( PCount()==0, cSay[ 7 ], cSay[ 7 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )













      aGet[ 46 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( cDivOut( aGet[ 46 ], oBmpDiv, aGet[ 47 ], @cPouDiv, @nDouDiv, @cPorDiv, @nRouDiv, nil, nil, oGetMasDiv, dbfDiv, oBandera ) )}, "N/W*",,,,, .F., {||     ( nMode == 1 .AND. ( dbfTmpLin )->( LastRec() ) == 0 )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 46 ], oBmpDiv, aGet[ 47 ], dbfDiv, oBandera )}, nil, "LUPA",, )




      oBmpDiv := TBitmap():ReDefine( 201, "BAN_EURO",, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .F. )








      oBmpEmp := TBitmap():ReDefine( 500,, "Bmp\ImgSatCli.bmp", oDlg,,, .F., .F.,,, .F.,,, .F. )





      oBrwLin                 := IXBrowse():New( oFld:aDialogs[1] )

      oBrwLin:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwLin:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }
      oBrwLin:bClrStd         := {|| { if( ( dbfTmpLin )->lKitChl, 8421504, 0 ), GetSysColor( 5 ) } }

      oBrwLin:cAlias          := dbfTmpLin

      oBrwLin:nMarqueeStyle   := 6
      oBrwLin:lFooter         := .T.
      oBrwLin:cName           := "Satsupuesto a cliente.Detalle"

      oBrwLin:CreateFromResource( 210 )

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Oferta"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfTmpLin )->lLinOfe }
         :nWidth              := 60
         :SetCheck( { "gc_star2_16", "Nil16" } )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Número"
         :bEditValue          := {|| ( dbfTmpLin )->nNumLin }
         :cEditPicture        := "9999"
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Posición"
         :cSortOrder          := "nPosPrint"
         :bEditValue          := {|| ( dbfTmpLin )->nPosPrint }
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | if( !empty( oCol ), oCol:SetOrder(), ) }
         :cEditPicture        := "9999"
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código"
         :bEditValue          := {|| ( dbfTmpLin )->cRef }
         :nWidth              := 60
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "C. Barras"
         :bEditValue          := {|| cCodigoBarrasDefecto( ( dbfTmpLin )->cRef, dbfCodeBar ) }
         :nWidth              := 100
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Descripción"
         :bEditValue          := {|| if( Empty( ( dbfTmpLin )->cRef ), ( dbfTmpLin )->mLngDes, ( dbfTmpLin )->cDetalle ) }
         :nWidth              := 300
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Observaciones"
         :bEditValue          := {|| ( dbfTmpLin )->mObsLin }
         :nWidth              := 300
         :lHide               := .T.
         :nEditType           := 1
         :bOnPostEdit         := {|o,x,n| ChangeComentario( o, x, n, aTmp ) }
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Código proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cCodPrv ) }
         :nWidth              := 50
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Nombre proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cNomPrv ) }
         :nWidth              := 150
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Referencia proveedor"
         :bEditValue          := {|| AllTrim( ( dbfTmpLin )->cRefPrv ) }
         :nWidth              := 50
         :lHide               := !( IsMuebles() )
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 1"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr1 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Valor prop. 1"
         :bEditValue          := {|| retValProp( ( dbfTmpLin )->cCodPr1 + ( dbfTmpLin )->cValPr1 )}
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Prop. 2"
         :bEditValue          := {|| ( dbfTmpLin )->cValPr2 }
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Valor prop. 2"
         :bEditValue          := {|| retValProp( ( dbfTmpLin )->cCodPr2 + ( dbfTmpLin )->cValPr2 )}
         :nWidth              := 40
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Lote"
         :bEditValue          := {|| ( dbfTmpLin )->cLote }
         :nWidth              := 60
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Bultos"
         :bEditValue          := {|| NotBulto( ( dbfTmpLin )->nBultos ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreCajas()
         :bEditValue          := {|| NotCaja( ( dbfTmpLin )->nCanSat ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := cNombreUnidades()
         :bEditValue          := {|| nTotNSatCli( dbfTmpLin ) }
         :cEditPicture        := cPicUnd
         :nWidth              := 60
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "UM. Unidad de medición"
         :bEditValue          := {|| ( dbfTmpLin )->cUnidad }
         :nWidth              := 25
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Peso"
         :bEditValue          := {|| ( dbfTmpLin )->nPesokg }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "T. Peso"
         :bEditValue          := {|| ( nTotNSatCli( dbfTmpLin ) * ( dbfTmpLin )->nPesokg ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Alm."
         :bEditValue          := {|| ( dbfTmpLin )->cAlmLin }
         :nWidth              := 35
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Precio"
         :bEditValue          := {|| nImpUSatCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Dto."
         :bEditValue          := {|| ( dbfTmpLin )->nDto }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Dto. Lin."
         :bEditValue          := {|| nDtoUSatCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Prm."
         :bEditValue          := {|| ( dbfTmpLin )->nDtoPrm }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% Age"
         :bEditValue          := {|| ( dbfTmpLin )->nComAge }
         :cEditPicture        := "@E 999.99"
         :nWidth              := 40
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "% " + cImp()
         :bEditValue          := {|| ( dbfTmpLin )->nIva }
         :cEditPicture        := "@E 99.9"
         :nWidth              := 50
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Portes"
         :bEditValue          := {|| nTrnUSatCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "P. verde"
         :bEditValue          := {|| nPntUSatCli( dbfTmpLin, nDouDiv ) }
         :cEditPicture        := cPouDiv
         :nWidth              := 70
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :lHide               := .T.
      end

      with object ( oBrwLin:AddCol() )
         :cHeader             := "Total"
         :bEditValue          := {|| nTotLSatCli( dbfTmpLin, nDouDiv, nRouDiv, , , aTmp[ 80 ] ) }
         :cEditPicture        := cPorDiv
         :nWidth              := 80
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
         :nFooterType         := 1
      end

      if nMode <> 3
         oBrwLin:bLDblClick  := {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) }
      end








      aGet[ 29 ] := TGetHlp():ReDefine( 219, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 30 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 30 ], aTmp[ 30 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )




      aGet[ 31 ] := TGetHlp():ReDefine( 229, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 32 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 33 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 34 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )






      aGet[ 35 ] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[1],, "@!",, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 36 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaTotal( aTmp ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .T.,,,,,, nil,,, )





      oBrwIva                        := IXBrowse():New( oFld:aDialogs[ 1 ] )

      oBrwIva:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwIva:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwIva:SetArray( aTotIva, , , .F. )
      oBrwIva:lHscroll               := .F.

      oBrwIva:nMarqueeStyle          := 5
      oBrwIva:lRecordSelector        := .F.

      oBrwIva:CreateFromResource( 490 )

      with object ( oBrwIva:AddCol() )
         :cHeader          := "Base"
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 2 ], cPorDiv ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "Imp. esp."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 6 ], cPorDiv ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader       := "%" + cImp()
         :bStrData      := {|| if( !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ), aTotIva[ oBrwIva:nArrayAt, 3 ], "" ) }
         :bEditValue    := {|| aTotIva[ oBrwIva:nArrayAt, 3 ] }
         :nWidth        := 44
         :cEditPicture  := "@E 999.99"
         :nDataStrAlign := 1
         :nHeadStrAlign := 1
         :nFootStrAlign := 1
         :nEditType     := 1
         :bEditWhen     := {|| !IsNil( aTotIva[ oBrwIva:nArrayAt, 3 ] ) }
         :bOnPostEdit   := {|o,x| EdtIva( o, x, aTotIva[ oBrwIva:nArrayAt, 3 ], dbfTmpLin, dbfIva, oBrwLin ), RecalculaTotal( aTmp ) }
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := cImp()
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil, Trans( aTotIva[ oBrwIva:nArrayAt, 8 ], cPorDiv ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "% R.E."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil .AND. aTmp[ 42 ], Trans( aTotIva[ oBrwIva:nArrayAt, 4 ], "@EZ 99.9" ), "" ) }
         :nWidth           := 44
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwIva:AddCol() )
         :cHeader          := "R.E."
         :bStrData         := {|| if( aTotIva[ oBrwIva:nArrayAt, 3 ] <> nil .AND. aTmp[ 42 ], Trans( aTotIva[ oBrwIva:nArrayAt, 9 ], cPorDiv ), "" ) }
         :nWidth           := 76
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end









      aGet[ 73 ] := TGetHlp():ReDefine( 411, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 53 ] := TGetHlp():ReDefine( 412, { | u | If( PCount()==0, aTmp[ 53 ], aTmp[ 53 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 53 ] ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 53 ], dbfIva, , .T. ) )}, nil, "LUPA",, )







      aGet[ 54 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[1],, cPorDiv, {||    ( RecalculaTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaTotal( aTmp ) ) }, .F., .F.,,,,,, nil,,, )



      oGetNet := TSay():ReDefine( 401, {|| nTotNet}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetTrn := TSay():ReDefine( 402, {|| nTotTrn}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetIvm := TSay():ReDefine( 403, {|| nTotIvm}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      aGet[ 80 ] := TCheckBox():ReDefine( 409, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ), oBrwLin:Refresh() )},,,,, .F., {||     ( nMode <> 3 )}, .F. )



      oGetPnt := TSay():ReDefine( 404, {|| nTotPnt}, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetIva := TSay():ReDefine( 405, {|| nTotIva}, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      aGet[ 42 ] := TCheckBox():ReDefine( 406, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],, {||( RecalculaTotal( aTmp ) )},,,,, .F., {||     ( nMode <> 3 )}, .F. )



      oGetReq := TSay():ReDefine( 407, {|| nTotReq}, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      oImpuestos := TCheckBox():ReDefine( 711, { | u | If( PCount()==0, lImpuestos, lImpuestos:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( .F. )}, .F. )

      oSayGetRnt := TSay():ReDefine( 709,, oFld:aDialogs[1],,,, .F.,, .F., .F., )



      oGetRnt := TGetHlp():ReDefine( 408, { | u | If( PCount()==0, nTotRnt, nTotRnt:= u ) }, oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




      oGetMasDiv := TSay():ReDefine( 410, {|| cGetMasDiv}, oFld:aDialogs[1],,,, .F., oFont, .F., .F., )




      oGetTotal := TSay():ReDefine( 420, {|| nTotSat}, oFld:aDialogs[1],,,, .F., oFont, .F., .F., )









      TButton():ReDefine( 515, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .T. ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 500, {||( AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( EdtDeta( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( DelDeta( oBrwLin, aTmp ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( EdtZoom( oBrwLin, bEdtDet, aTmp ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )





      TButton():ReDefine( 524, {||( LineUp( dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 525, {||( LineDown( dbfTmpLin, oBrwLin ) )}, oFld:aDialogs[1],,, .F., {||     ( nMode <> 3 )},,, .F. )




      oBtnKit := TButton():ReDefine( 526, {||( lEscandalloEdtRec( .T., oBrwLin ) )}, oFld:aDialogs[1],,, .F.,,,, .F. )




      TButton():ReDefine( 527, {||( importarArticulosScaner() )}, oFld:aDialogs[1],,, .F.,,,, .F. )










      aGet[1] := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, aTmp[1], aTmp[1]:= u ) }, oFld:aDialogs[1],, "@!", {||    ( aTmp[1] >= "A" .AND. aTmp[1] <= "Z"  )}, "N/W*",,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[1] ) )}, {||  ( DwSerie( aGet[1] ) )},,,, nil,,, )





      aGet[2] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[2], aTmp[2]:= u ) }, oFld:aDialogs[1],, "999999999",,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )




      aGet[3] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[3], aTmp[3]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      aGet[ 5 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )







      aGet[ 71 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 71 ], aTmp[ 71 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( SetDiasSAT( aTmp, aGet ) ) }, .F., .T.,,,,,, nil,, 112, )




      oAprovado := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, cAprovado, cAprovado:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      aGet[ 61 ] := TComboBox():ReDefine( 218, { | u | If( PCount()==0, aTmp[ 61 ], aTmp[ 61 ]:= u ) }, ( SituacionesModel():getArrayNombres() ), oFld:aDialogs[1],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "aGet[ 61 ]",,,,,,, )






      aGet[ 23 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,, 123, )




      aGet[ 52 ] := TCheckBox():ReDefine( 129, { | u | If( PCount()==0, aTmp[ 52 ], aTmp[ 52 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( ( dbfTmpLin )->( ordKeyCount() ) == 0 )}, .F. )








      aGet[ 87 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 87 ], aTmp[ 87 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cEstadoArticulo( aGet[ 87 ], dbfEstado, aGet[ 87 ]:oHelpText, oBmpEstado ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwEstadoArticulo( aGet[ 87 ], aGet[ 87 ]:oHelpText, oBmpEstado ) )}, nil, "LUPA",, 351 )




      oBmpEstado := TBitmap():ReDefine( 352,,, oFld:aDialogs[1],,, .F., .F.,,, .F.,,, .T. )







      aGet[ 82 ] := TCheckBox():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 82 ], aTmp[ 82 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F.,, .F. )





      aGet[ 58 ] := TGetHlp():ReDefine( 115, { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSay[ 10 ]:cText( UsuariosModel():getNombreWhereCodigo( aTmp[ 58 ] ) ), .T.  )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 10 ] := TGetHlp():ReDefine( 116, { | u | If( PCount()==0, cSay[ 10 ], cSay[ 10 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      aGet[ 67 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 67 ], aTmp[ 67 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oSay[ 11 ] := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSay[ 11 ], cSay[ 11 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )











      aGet[ 55 ] := TGetHlp():ReDefine( 235, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[2],,, {||    ( LoadTrans( aTmp, aGet[ 55 ], aGet[ 56 ], oSay[ 8 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oTrans:Buscar( aGet[ 55 ] ), .T. )}, nil, "LUPA",, )




      oSay[ 8 ] := TGetHlp():ReDefine( 236, { | u | If( PCount()==0, cSay[ 8 ], cSay[ 8 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      aGet[ 56 ] := TGetHlp():ReDefine( 237, { | u | If( PCount()==0, aTmp[ 56 ], aTmp[ 56 ]:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )












      aGet[ 18 ] := TGetHlp():ReDefine( 165, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[2],,, {||    cCajas( aGet[ 18 ], dbfCajT, oSay[ 9 ] )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 18 ], oSay[ 9 ] ) )}, nil, "LUPA",, )





      oSay[ 9 ] := TGetHlp():ReDefine( 166, { | u | If( PCount()==0, cSay[ 9 ], cSay[ 9 ]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ 89 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 89 ], aTmp[ 89 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oCentroCoste:Existe( aGet[ 89 ], aGet[ 89 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 89 ] ) )}, nil, "LUPA",, 351 )






     aGet[ 44 ] := TGetHlp():ReDefine( 128, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[2],, "99999",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )









      aGet[49] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[49], aTmp[49]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[50] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[50], aTmp[50]:= u ) }, oFld:aDialogs[2],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[ 24 ] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 25 ] := TMultiGet():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 25 ], aTmp[ 25 ]:= u ) }, oFld:aDialogs[2],, "N/W*",,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      aGet[ 26 ] := TMultiGet():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 26 ], aTmp[ 26 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )








      aGet[ 64 ] := TCheckBox():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 65 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 65 ], aTmp[ 65 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      aGet[ 66 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 66 ], aTmp[ 66 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 85 ] := TGetHlp():ReDefine( 590, { | u | If( PCount()==0, aTmp[ 85 ], aTmp[ 85 ]:= u ) }, oFld:aDialogs[2],, "@R 99:99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 86 ] := TGetHlp():ReDefine( 591, { | u | If( PCount()==0, aTmp[ 86 ], aTmp[ 86 ]:= u ) }, oFld:aDialogs[2],, "@R 99:99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      oGetPes := TGetHlp():ReDefine( 570, { | u | If( PCount()==0, nTotPes, nTotPes:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oGetDif := TGetHlp():ReDefine( 580, { | u | If( PCount()==0, nTotDif, nTotDif:= u ) }, oFld:aDialogs[2],, ( MasUnd() ),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oBrwInc                 := IXBrowse():New( oFld:aDialogs[ 3 ] )

      oBrwInc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwInc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwInc:cAlias          := dbfTmpInc

      oBrwInc:nMarqueeStyle   := 6
      oBrwInc:cName           := "Satsupuesto a cliente.Incidencias"

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Resuelta"
            :bStrData         := {|| "" }
            :bEditValue       := {|| ( dbfTmpInc )->lListo }
            :nWidth           := 70
            :SetCheck( { "Sel16", "Cnt16" } )
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpInc )->dFecInc ) }
            :nWidth           := 90
         end

         with object ( oBrwInc:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpInc )->mDesInc }
            :nWidth           := 500
         end

         if nMode <> 3
            oBrwInc:bLDblClick   := {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) }
         end

         oBrwInc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( WinDelRec( oBrwInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( WinZooRec( oBrwInc, bEdtInc, dbfTmpInc ) )}, oFld:aDialogs[ 3 ],,, .F.,,,, .F. )





      oBrwDoc                 := IXBrowse():New( oFld:aDialogs[ 4 ] )

      oBrwDoc:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDoc:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDoc:cAlias          := dbfTmpDoc

      oBrwDoc:nMarqueeStyle   := 6
      oBrwDoc:nRowHeight      := 40
      oBrwDoc:nDataLines      := 2

         with object ( oBrwDoc:AddCol() )
            :cHeader          := "Documento"
            :bEditValue       := {|| Rtrim( ( dbfTmpDoc )->cNombre ) + Chr(13)+Chr(10) + Space( 5 ) + Rtrim( ( dbfTmpDoc )->cRuta ) }
            :nWidth           := 960
         end

         if nMode <> 3
            oBrwDoc:bLDblClick   := {|| ShellExecute( oDlg:hWnd, "open", Rtrim( ( dbfTmpDoc )->cRuta ) ) }
         end

         oBrwDoc:CreateFromResource( 210 )





      TButton():ReDefine( 500, {||( WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 501, {||( WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 502, {||( WinDelRec( oBrwDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 503, {||( WinZooRec( oBrwDoc, bEdtDoc, dbfTmpDoc ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )




      TButton():ReDefine( 504, {||( ShellExecute( oDlg:hWnd, "open", rTrim( ( dbfTmpDoc )->cRuta ) ) )}, oFld:aDialogs[ 4 ],,, .F.,,,, .F. )









      TButton():ReDefine( 3, {||( RecSatCli( aTmp ), oBrwLin:Refresh( .T. ), RecalculaTotal( aTmp ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 1, {||( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 4, {||( if( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ), GenSatCli( 1 ), ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




      TButton():ReDefine( 2, {||( if ( ExitNoSave( nMode, dbfTmpLin ), oDlg:end(), ) )}, oDlg,,, .F.,,,, .F. )

      oSayLabels[ 1 ] := TGroup():ReDefine( 700,, oFld:aDialogs[ 1 ],,,, .T. )
      oSayLabels[ 2 ] := TSay():ReDefine( 703,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 3 ] := TSay():ReDefine( 704,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 4 ] := TSay():ReDefine( 705,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 5 ] := TSay():ReDefine( 706,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 6 ] := TSay():ReDefine( 708,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 7 ] := TSay():ReDefine( 710,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )
      oSayLabels[ 9 ] := TSay():ReDefine( 712,, oFld:aDialogs[ 1 ],,,, .F.,, .F., .F., )

   if nMode <> 3

      oFld:aDialogs[1]:AddFastKey( 113, {|| AppDeta( oBrwLin, bEdtDet, aTmp, .F. ) } )
      oFld:aDialogs[1]:AddFastKey( 114, {|| EdtDeta( oBrwLin, bEdtDet, aTmp ) } )
      oFld:aDialogs[1]:AddFastKey( 115, {|| DelDeta( oBrwLin, aTmp ) } )

      oFld:aDialogs[3]:AddFastKey( 113, {|| WinAppRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 114, {|| WinEdtRec( oBrwInc, bEdtInc, dbfTmpInc, nil, nil, aTmp ) } )
      oFld:aDialogs[3]:AddFastKey( 115, {|| WinDelRec( oBrwInc, dbfTmpInc ) } )

      oFld:aDialogs[4]:AddFastKey( 113, {|| WinAppRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 114, {|| WinEdtRec( oBrwDoc, bEdtDoc, dbfTmpDoc, nil, nil, aTmp ) } )
      oFld:aDialogs[4]:AddFastKey( 115, {|| WinDelRec( oBrwDoc, dbfTmpDoc ) } )

      oDlg:AddFastKey( 116, {|| EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ) } )
      oDlg:AddFastKey( 117, {|| if( EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg ), GenSatCli( 1 ), ) } )
      oDlg:AddFastKey( 120, {|| oDetCamposExtra:Play( Space(1) ) } )

      oDlg:AddFastKey( 65,    {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )

   end

   CodigosPostales():GetInstance():setBinding( { "CodigoPostal" => aGet[ 11 ], "Poblacion" => aGet[ 9 ], "Provincia" => aGet[ 10 ] } )

   do case
      case nMode == 1 .AND. lRecogerUsuario() .AND. Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 58 ] ), ( aGet[ 83 ]:lValid(), aGet[ 87 ]:lValid() ), oDlg:End() ), aGet[ 55 ]:lValid() }

      case nMode == 1 .AND. lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| if( lGetUsuario( aGet[ 58 ] ), ( aGet[ 83 ]:lValid(), aGet[ 87 ]:lValid(), AppDeta( oBrwLin, bEdtDet, aTmp, nil, cCodArt ) ), oDlg:End() ) , aGet[ 55 ]:lValid() }

      case nMode == 1 .AND. !lRecogerUsuario() .AND. !Empty( cCodArt )
         oDlg:bStart := {|| aGet[ 83 ]:lValid(), aGet[ 87 ]:lValid(), AppDeta( oBrwLin, bEdtDet, aTmp, nil, cCodArt ), aGet[ 55 ]:lValid() }

      otherwise
         oDlg:bStart := {|| StartEdtRec( oBrwLin ), aGet[ 55 ]:lValid() }

   end







   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|(  RecalculaTotal( aTmp ) )}, .T.,,, {|Self|(  edtRecMenu( aTmp, oDlg ) , setDialog( aGet, oSayGetRnt, oGetRnt ) , oBrwLin:Load() , oBrwInc:Load() )}, oDlg:bRClicked,,, )

   oMenu:End()

   oBmpEmp:end()
   oBmpDiv:end()
   oBmpGeneral:End()
   oBmpEstado:End()

   ( D():SatClientes( nView ) )->( ordSetFocus( nOrd ) )

   KillTrans( oBrwLin )





   oBrwInc:CloseData()

RETURN ( oDlg:nResult == 1 )



Static Function StartEdtRec( oBrwLin )





   lEscandalloEdtRec( .F., oBrwLin )


Return ( nil )


Static Function lEscandalloEdtRec( lSet, oBrwLin )

   local lShwKit     := lShwKit()

   if lSet
      lShwKit        := !lShwKit
   end

   if lShwKit
      SetWindowText( oBtnKit:hWnd, "Ocultar Esc&ll." )
      if ( dbfTmpLin )->( Used() )
         ( dbfTmpLin )->( dbClearFilter() )
      end
   else
      SetWindowText( oBtnKit:hWnd, "Mostrar Esc&ll." )
      if ( dbfTmpLin )->( Used() )
         ( dbfTmpLin )->( dbSetFilter( {|| ! Field->lKitChl }, "!lKitChl" ) )
      end
   end

   if lSet
      lShwKit( lShwKit )
   end

   if !Empty( oBrwLin )
      oBrwLin:Refresh()
   end

Return ( nil )



static function CargaMaquinas( aTmp, oBrwLin )

   if !Empty( aTmp[ 6 ] )
      cMaquina    := InfCliente( aTmp[ 6 ], nil, .T. )
   end

   if !Empty( cMaquina )
      AppDeta( oBrwLin, bEdtDet, aTmp, , cMaquina  )
   end

return .T.



Static Function EdtRecMenu( aTmp, oDlg )

   oMenu := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .T.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

            if !lExternal




            MenuAddItem( "&1. Campos extra [F9]", "Mostramos y rellenamos los campos extra para la familia", .F.,, {|oMenuItem|( oDetCamposExtra:Play( Space(1) ) )},, "gc_form_plus2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&2. Modificar cliente", "Modificar la ficha del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), EdtCli( aTmp[ 6 ] ), MsgStop( "Código cliente vacío" ) ) )},, "gc_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&3. Modificar cliente contactos", "Modifica la ficha del cliente en contactos", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), EdtCli( aTmp[ 6 ], , 5 ), MsgStop( "Código de cliente vacío" ) ) )},, "gc_user_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )





            MenuAddItem( "&4. Informe de cliente", "Abrir el informe del cliente", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 6 ] ), InfCliente( aTmp[ 6 ] ), MsgStop( "Código cliente vacío" ) ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )



            MenuAddItem( "&5. Modificar dirección", "Modificar ficha de la dirección", .F.,, {|oMenuItem|( if( !Empty( aTmp[ 15 ] ), EdtObras( aTmp[ 6 ], aTmp[ 15 ], dbfObrasT ), MsgStop( "No hay obra asociada para el S.A.T." ) ) )},, "gc_worker2_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

            MenuAddItem(,,,,,,,,,,,,,,,,,.T.,,,,,,,,,,,,,,,,,)

            end




            MenuAddItem( "&6. Informe del documento", "Abrir el informe del documento", .F.,, {|oMenuItem|( TTrazaDocumento():Activate( "32", aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ] ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )






            MenuAddItem( "&7. Firmar documento", "Firmar documento", .F.,, {|oMenuItem|( if( empty( aTmp[ 88 ] ) .OR.  msgNoYes( "El documento ya está firmado, ¿Desea voler a firmarlo?" ), aTmp[ 88 ] := signatureToMemo(), ) )},, "gc_sign_document_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuEnd()

   MenuEnd()

   oDlg:SetMenu( oMenu )

Return ( oMenu )





STATIC FUNCTION AppDeta( oBrwLin, bEdtDet, aTmp, lTot, cCodArt  )

   If( lTot == nil, lTot := .F., ) ;





   WinAppRec( oBrwLin, bEdtDet, dbfTmpLin, lTot, cCodArt, aTmp )

   if !Empty( oBrwLin )
      oBrwLin:Refresh()
   end

RETURN RecalculaTotal( aTmp )







STATIC FUNCTION EdtDeta( oBrwLin, bEdtDet, aTmp )

   WinEdtRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nil, aTmp )

RETURN RecalculaTotal( aTmp )







STATIC FUNCTION DelDeta( oBrwLin, aTmp )

   CursorWait()

   while ( dbfTmpSer )->( dbSeek( Str( ( dbfTmpLin )->nNumLin, 4 ) ) )
      ( dbfTmpSer )->( dbDelete() )
   end

   if ( dbfTmpLin )->lKitArt
      dbDelKit( oBrwLin, dbfTmpLin, ( dbfTmpLin )->nNumLin )
   end

   WinDelRec( oBrwLin, dbfTmpLin )

   RecalculaTotal( aTmp )

   CursorWE()

RETURN ( .T. )







STATIC FUNCTION EdtZoom( oBrwLin, bEdtDet, aTmp )

RETURN WinZooRec( oBrwLin, bEdtDet, dbfTmpLin, .F., nil, aTmp )






STATIC FUNCTION EdtDet( aTmp, aGet, dbfSatCliL, oBrw, lTotLin, cCodArtEnt, nMode, aTmpSat )

   local oDlg
   local oFld
   local oBtn
   local oTotal
   local nTotSatCli
   local cGet3
   local oGet3
   local oBtnSer
   local oSayPr1
   local oSayPr2
   local cSayPr1           := ""
   local cSayPr2           := ""
   local oSayVp1
   local oSayVp2
   local cSayVp1           := ""
   local cSayVp2           := ""
   local oSayAlm
   local cSayAlm           := ""
   local bmpImage
   local oSayLote
   local oSayGrp
   local cSayGrp           := ""
   local oSayFam
   local cSayFam           := ""
   local oStkAct
   local nStkAct           := 0
   local cCodArt           := Padr( aTmp[ 4 ], 32 )
   local oRentLin
   local cRentLin
   local cCodDiv           := aTmpSat[ 46 ]
   local oSayDias
   local oGetCaducidad
   local dGetCaducidad

   If( lTotLin == nil, lTotLin := .F., ) ;

   SysRefresh()

   cTipoCtrCoste           := AllTrim( aTmp[ 93 ] )

   do case
   case nMode == 1

      aTmp[ 1  ]    := aTmpSat[ 1 ]
      aTmp[ 2  ]    := aTmpSat[ 2 ]
      aTmp[ 3  ]    := aTmpSat[ 3 ]
      aTmp[ 8 ]    := 1
      aTmp[ 23  ]    := lTotLin
      aTmp[ 7  ]    := 1
      aTmp[ 37  ]    := aTmpSat[ 52 ]
      aTmp[ 36  ]    := aTmpSat[ 17 ]
      aTmp[ 82 ]    := aTmpSat[ 6 ]
      aTmp[ 83 ]    := aTmpSat[ 5 ]

      aTmp[ 73  ]    := oGetTarifa:getTarifa()

      aTmp[ 88  ]    := aTmpSat[ 15 ]

      if !Empty( cCodArtEnt )
         cCodArt           := Padr( cCodArtEnt, 32 )
      end

      aTmp[ 66 ]    := aTmpSat[ 71 ]

      cTipoCtrCoste        := "Centro de coste"

   case nMode == 2

      lTotLin              := aTmp[ 23 ]

   end





   cOldCodArt           := aTmp[ 4 ]
   cOldPrpArt           := aTmp[ 25 ] + aTmp[ 26 ] + aTmp[ 27 ] + aTmp[ 28 ]
   cOldLotArt           := aTmp[ 42 ]
   cOldUndMed           := aTmp[ 18 ]





   cSayGrp              := RetFld( aTmp[ 52 ], oGrpFam:GetAlias() )
   cSayFam              := RetFld( aTmp[ 51 ], dbfFamilia )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "líneas de S.A.T. a clientes", "LFACCLI",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )











      oFld := TFolder():ReDefine( 400, {"&General", "Da&tos", "&Observaciones", "&Centro coste"}, { "LFACCLI_1","LSATCLI_2","LFACCLI_3","LCTRCOSTE" }, oDlg,,,,, .F., )







      aGet[ 4 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodArt, cCodArt:= u ) }, oFld:aDialogs[1],,, {||    ( LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwArticulo( aGet[ 4 ], aGet[ 5 ], .F., .T., oBtn, aGet[ 42 ], aTmp[ 25 ], aTmp[ 26 ], aGet[ 27 ], aGet[ 28 ], , if( uFieldEmpresa( "lStockAlm" ), aTmp[ 36 ], nil ) ) )}, nil, "LUPA",, )




      aGet[ 5 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 5 ] ) ) .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      aGet[ 22 ] := TMultiGet():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oFld:aDialogs[1],,,,,,, .F., {||     ( ( lModDes() .OR. Empty( aTmp[ 22 ] ) ) .AND. nMode <> 3 )}, .F.,, )








      oSayLote := TSay():ReDefine( 113,, oFld:aDialogs[1],,,, .F.,, .F., .F., )





      aGet[ 42 ] := TGetHlp():ReDefine( 112, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )


      aGet[ 42 ]:bValid   := {|| StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct ), LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) }

      if !aTmp[ 68 ]






      oGetCaducidad := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, dGetCaducidad, dGetCaducidad:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 341, )

      end



      oBrwProperties                       := IXBrowse():New( oFld:aDialogs[1] )

      oBrwProperties:nDataType             := 2

      oBrwProperties:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwProperties:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwProperties:lHScroll              := .T.
      oBrwProperties:lVScroll              := .T.

      oBrwProperties:nMarqueeStyle         := 3
      oBrwProperties:lRecordSelector       := .F.
      oBrwProperties:lFastEdit             := .T.
      oBrwProperties:nFreeze               := 1
      oBrwProperties:lFooter               := .T.

      oBrwProperties:SetArray( {}, .F., 0, .F. )

      oBrwProperties:MakeTotals()

      oBrwProperties:CreateFromResource( 500 )











      aGet[ 27 ] := TGetHlp():ReDefine( 270, { | u | If( PCount()==0, aTmp[ 27 ], aTmp[ 27 ]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[27], oSayVp1, aTmp[25 ], dbfTblPro ), LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[27], oSayVp1, aTmp[25 ] ) )}, nil, "LUPA",, )

         aGet[ 27 ]:bChange   := {|| aGet[ 27 ]:Assign(), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct ) }



      oSayPr1 := TSay():ReDefine( 271, {|| cSayPr1}, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      oSayVp1 := TGetHlp():ReDefine( 272, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[28] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[28], aTmp[28]:= u ) }, oFld:aDialogs[1],,, {||    ( if( lPrpAct( aTmp[28], oSayVp2, aTmp[26 ], dbfTblPro ), LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ), .F. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwPropiedadActual( aGet[28], oSayVp2, aTmp[26 ] ) )}, nil, "LUPA",, )

         aGet[ 28 ]:bChange   := {|| aGet[ 28 ]:Assign(), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct ) }



      oSayPr2 := TSay():ReDefine( 281, {|| cSayPr2}, oFld:aDialogs[1],,,, .F.,, .F., .F., )




      oSayVp2 := TGetHlp():ReDefine( 282, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ 84 ] := TGetHlp():ReDefine( 256, { | u | If( PCount()==0, aTmp[ 84 ], aTmp[ 84 ]:= u ) }, oFld:aDialogs[1],, "@E 999999999999.99",,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 257, )








      aGet[ 18 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oUndMedicion:Existe( aGet[ 18 ], aGet[ 18 ]:oHelpText, "cNombre" ), ValidaMedicion( aTmp, aGet ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oUndMedicion:Buscar( aGet[ 18 ] ), ValidaMedicion( aTmp, aGet ) )}, nil, "LUPA",, 171 )











      aGet[ ( dbfSatCliL )->( fieldpos( "nMedUno" ) ) ] := TGetHlp():ReDefine( 520, { | u | If( PCount()==0, aTmp[ ( dbfSatCliL )->( fieldpos( "nMedUno" ) ) ], aTmp[ ( dbfSatCliL )->( fieldpos( "nMedUno" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 521, )

         aGet[ ( dbfSatCliL )->( fieldpos( "nMedUno" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfSatCliL )->( fieldpos( "nMedDos" ) ) ] := TGetHlp():ReDefine( 530, { | u | If( PCount()==0, aTmp[ ( dbfSatCliL )->( fieldpos( "nMedDos" ) ) ], aTmp[ ( dbfSatCliL )->( fieldpos( "nMedDos" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 531, )

         aGet[ ( dbfSatCliL )->( fieldpos( "nMedDos" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ ( dbfSatCliL )->( fieldpos( "nMedTre" ) ) ] := TGetHlp():ReDefine( 540, { | u | If( PCount()==0, aTmp[ ( dbfSatCliL )->( fieldpos( "nMedTre" ) ) ], aTmp[ ( dbfSatCliL )->( fieldpos( "nMedTre" ) ) ]:= u ) }, oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 541, )

         aGet[ ( dbfSatCliL )->( fieldpos( "nMedTre" ) ) ]:oSay:SetColor( 8388608 )









      aGet[ 6 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( lTiva( dbfIva, aTmp[ 6 ], @aTmp[ 53 ] ) )}, "N/W*",,,,, .F., {||     ( lModIva() .AND. nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( BrwIva( aGet[ 6 ], dbfIva, , .T. ) )}, nil, "LUPA",, )










      aGet[ 39 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 39 ], aTmp[ 39 ]:= u ) }, oFld:aDialogs[ 1 ],, cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,, {|Self|( oNewImp:nBrwImp( aGet[ 39 ] ) )}, nil,, 126, )












      aGet[ 80 ] := TGetHlp():ReDefine( 450, { | u | If( PCount()==0, aTmp[ 80 ], aTmp[ 80 ]:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     ( uFieldEmpresa( "lUseBultos" ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,, 451, )










      aGet[ 7 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) )},,,,,, .F., {||     ( lUseCaj() .AND. nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 131, )









      aGet[ 8 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oFld:aDialogs[1],, cPicUnd, {||    ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin .AND. oUser():lModificaUnidades() )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ), LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, .F. ) ) }, .F., .T.,,,,,, nil,, 141, )









      aGet[ 11 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )












      aGet[ 73 ] := TGetHlp():ReDefine( 156, { | u | If( PCount()==0, aTmp[ 73 ], aTmp[ 73 ]:= u ) }, oFld:aDialogs[1],, "9", {||    ( aTmp[ 73 ] >= 1 .AND. aTmp[ 73 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )}, {|nKey,nFlags,Self| (  changeTarifa( aTmp, aGet, aTmpSat ), loadComisionAgente( aTmp, aGet, aTmpSat ), recalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,, {||      1}, {||      6},, nil,,, )













      aGet[ 13 ] := TGetHlp():ReDefine( 350, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 351, )









      aGet[12] := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, aTmp[12], aTmp[12]:= u ) }, oFld:aDialogs[1],, cPpvDiv, {||    ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,, 152, )





      aGet[ 29 ] := TGetHlp():ReDefine( 295, { | u | If( PCount()==0, aTmp[ 29 ], aTmp[ 29 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )





      aGet[ 19 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )




      aGet[ 20 ] := TGetHlp():ReDefine( 175, { | u | If( PCount()==0, aTmp[ 20 ], aTmp[ 20 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )





      aGet[ 63 ] := TGetHlp():ReDefine( 400, { | u | If( PCount()==0, aTmp[ 63 ], aTmp[ 63 ]:= u ) }, oFld:aDialogs[1],, "@E 999,999.999999",,,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin)},, .F., .F.,,,,,, nil,,, )





      aGet[ 64 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 64 ], aTmp[ 64 ]:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .F.,,,,,, nil,,, )




      aGet[ 81 ] := TGetHlp():ReDefine( 460, { | u | If( PCount()==0, aTmp[ 81 ], aTmp[ 81 ]:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )








      aGet[14] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[14], aTmp[14]:= u ) }, oFld:aDialogs[1],, "@E 999.99", {||    ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )








      aGet[ 15 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99", {||    ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) )},,,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,,,,, nil,,, )







      aGet[ 16 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oFld:aDialogs[1],, "@E 99.99",, "N/W*",,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )},, .F., .T.,,,,,, nil,,, )

      if !aTmp[ 68 ]





      oComisionLinea := TGetHlp():ReDefine( 201, { | u | If( PCount()==0, nComisionLinea, nComisionLinea:= u ) }, oFld:aDialogs[ 1 ],, cPorDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      end











      aGet[30] := TGetHlp():ReDefine( 260, { | u | If( PCount()==0, aTmp[30], aTmp[30]:= u ) }, oFld:aDialogs[1],, cPouDiv, {||    ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) .AND. aTmp[30] >= 0 )}, ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ),,,,, .F., {||     ( nMode <> 3 .AND. !lTotLin )}, {|nKey,nFlags,Self| ( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) ) }, .F., .T.,,, {||      0},,, nil,, 261, )





      oTotal := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, nTotSat, nTotSat:= u ) }, oFld:aDialogs[1],, cPorDiv,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 50 ] := TGetHlp():ReDefine( 205, { | u | If( PCount()==0, aTmp[ 50 ], aTmp[ 50 ]:= u ) }, oFld:aDialogs[1],,, {||    ( oTipArt:Existe( aGet[ 50 ], oGet3 ) )},,,,,, .F., {||     ( nMode <> 3 .AND. nMode <> 5 .AND. !lTotLin )},, .F., .F.,,,,, {|Self|( oTipArt:Buscar( aGet[ 50 ] ) )}, nil, "LUPA",, )





      oGet3 := TGetHlp():ReDefine( 206, { | u | If( PCount()==0, cGet3, cGet3:= u ) }, oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )












      aGet[36] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[36], aTmp[36]:= u ) }, oFld:aDialogs[1],,, {||    ( cAlmacen( aGet[36], , oSayAlm ), if( !uFieldEmpresa( "lNStkAct" ), StocksModel():lPutStockActual( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct ), .T. ) )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[36], oSayAlm ) )}, nil, "LUPA",, )




      oSayAlm := TGetHlp():ReDefine( 301, { | u | If( PCount()==0, cSayAlm, cSayAlm:= u ) }, oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )








      aGet[ 88 ] := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 88 ], aTmp[ 88 ]:= u ) }, oFld:aDialogs[1],,, {||    ( cObras( aGet[ 88 ], aGet[ 88 ]:oHelpText, aTmpSat[ 6 ], dbfObrasT ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwObras( aGet[ 88 ], aGet[ 88 ]:oHelpText, aTmpSat[ 6 ], dbfObrasT ) )}, nil, "LUPA",, 331 )





      oStkAct := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, nStkAct, nStkAct:= u ) }, oFld:aDialogs[1],, cPicUnd,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 91 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 91 ], aTmp[ 91 ]:= u ) }, oFld:aDialogs[2],, "9999",, "N/W*",,,,, .F., {||     ( nMode == 1 )},, .F., .T.,,,,,, nil,,, )




      aGet[24] := TCheckBox():ReDefine( 110, { | u | If( PCount()==0, aTmp[24], aTmp[24]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      aGet[83] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[83], aTmp[83]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      aGet[9] := TCheckBox():ReDefine( 130, { | u | If( PCount()==0, aTmp[9], aTmp[9]:= u ) }, oFld:aDialogs[2],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )







      aGet[ 34 ] := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, aTmp[ 34 ], aTmp[ 34 ]:= u ) }, oFld:aDialogs[1],, cPouDiv,,,,,,, .F., {||     ( oUser():lAdministrador() .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,, 321, )






      aGet[ 35 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 35 ], aTmp[ 35 ]:= u ) }, oFld:aDialogs[2],, cPouDiv,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      aGet[ 85 ] := TGetHlp():ReDefine( 310, { | u | If( PCount()==0, aTmp[ 85 ], aTmp[ 85 ]:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 57 ] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     ( nMode <> 3 )}, {|nKey,nFlags,Self| ( ChgBmp( aGet[ 57 ], bmpImage ) ) }, .F., .F.,,,,, {|Self|( GetBmp( aGet[ 57 ], bmpImage ) )}, nil, "LUPA",, )











      aGet[ 52 ] := TGetHlp():ReDefine( ( 150 ), { | u | If( PCount()==0, aTmp[ 52 ], aTmp[ 52 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( oSayGrp:cText( RetFld( aTmp[ 52  ], oGrpFam:GetAlias() ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oGrpFam:Buscar( aGet[ 52 ] ) )}, nil, "LUPA",, )




      oSayGrp := TGetHlp():ReDefine( ( 151 ), { | u | If( PCount()==0, cSayGrp, cSayGrp:= u ) }, oFld:aDialogs[ 2 ],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )







      aGet[ 51 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 51 ], aTmp[ 51 ]:= u ) }, oFld:aDialogs[2],,, {||    ( oSayFam:cText( RetFld( aTmp[ 51  ], dbfFamilia ) ), .T. )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFamilia( aGet[ 51 ], oSayFam ) )}, nil, "LUPA",, )




      oSayFam := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cSayFam, cSayFam:= u ) }, oFld:aDialogs[2],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )








      aGet[ 55 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 55 ], aTmp[ 55 ]:= u ) }, oFld:aDialogs[ 2 ],,, {||    ( cProvee( aGet[ 55 ], dbfProvee, aGet[ 55 ]:oHelpText ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwProvee( aGet[ 55 ], aGet[ 55 ]:oHelpText ) )}, nil, "LUPA",, 201 )




      oRentLin := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, cRentLin, cRentLin:= u ) }, oFld:aDialogs[2],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,, 301, )




      aGet[ 44 ] := TCheckBox():ReDefine( 330, { | u | If( PCount()==0, aTmp[ 44 ], aTmp[ 44 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 45 ] := TCheckBox():ReDefine( 340, { | u | If( PCount()==0, aTmp[ 45 ], aTmp[ 45 ]:= u ) }, oFld:aDialogs[ 2 ],,,,,,, .F., {||     ( nMode <> 3 )}, .F. )




      aGet[ 33 ] := TRadMenu():Redefine( { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oFld:aDialogs[ 2 ],, { 350, 351, 352 },,,,, .F., {||     ( nMode <> 3 )}, )





      aGet[ 54 ] := TMultiGet():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 54 ], aTmp[ 54 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      aGet[ 77 ] := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 77 ], aTmp[ 77 ]:= u ) }, oFld:aDialogs[3],,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      bmpImage := TBitmap():ReDefine( 220,, ( cFileBitmap( cPatImg(), aTmp[ 57 ] ) ), oDlg,, { |nRow,nCol,nKeyFlags| ( bmpImage:lStretch := !bmpImage:lStretch, bmpImage:Refresh() ) }, .F., .F.,,, .F.,,, .F. )

         bmpImage:SetColor( , GetSysColor( 15 ) )












      aGet[ 92 ] := TGetHlp():ReDefine( 410, { | u | If( PCount()==0, aTmp[ 92 ], aTmp[ 92 ]:= u ) }, oFld:aDialogs[4],,, {||    ( oCentroCoste:Existe( aGet[ 92 ], aGet[ 92 ]:oHelpText, "cNombre" ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oCentroCoste:Buscar( aGet[ 92 ] ) )}, nil, "LUPA",, 411 )






      oTipoCtrCoste := TComboBox():ReDefine( 140, { | u | If( PCount()==0, cTipoCtrCoste, cTipoCtrCoste:= u ) }, aTipoCtrCoste, oFld:aDialogs[4],,,,,,, .F., {||     ( nMode <> 3 )},,,,,, "oTipoCtrCoste",,,,,,, )

         oTipoCtrCoste:bChange   := {|| clearGet( aGet[ 94 ] ), loadGet( aGet[ 94 ], cTipoCtrCoste ) }







      aGet[ 94 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 94 ], aTmp[ 94 ]:= u ) }, oFld:aDialogs[4],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, 160 )









      oBtn := TButton():ReDefine( 1, {||( SaveDeta( aTmp, aTmpSat, aGet, oDlg, oBrw, bmpImage, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, oSayLote, cCodArt, oBtn, oBtnSer, oFld ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 9, {||( ChmHelp( "Añadir_v" ) )}, oDlg,,, .F.,,,, .F. )




      oBtnSer := TButton():ReDefine( 552, {||( EditarNumeroSerie( aTmp, oStock, nMode ) )}, oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         if uFieldEmpresa( "lGetLot")
            oDlg:AddFastKey( 13,   {|| if( !Empty( aGet[ 4 ] ), aGet[ 4 ]:lValid(), ), oBtn:SetFocus(), oBtn:Click() } )
         end
         oDlg:AddFastKey( 116,          {|| oBtn:SetFocus(), oBtn:Click() } )
      end

      oDlg:AddFastKey( 117, {|| oBtnSer:Click() } )





      oDlg:bStart := {||   SetDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, aTmpSat, oSayLote, oRentLin, oFld ), if( !Empty( oGetCaducidad ), oGetCaducidad:Hide(), ), if( !Empty( cCodArtEnt ), aGet[ 4 ]:lValid(), ), loadGet( aGet[ 94 ], cTipoCtrCoste ), aGet[ 94 ]:lValid(), aGet[ 18 ]:lValid(), aGet[ 55 ]:lValid(), aGet[ 88 ]:lValid() }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted := {|hDC,cPS|( RecalculaLinea( aTmp, aTmpSat, nDouDiv, oTotal, oRentLin, cCodDiv ) )}, .T.,,, {|Self|( EdtDetMenu( aGet[ 4 ], oDlg ) )}, oDlg:bRClicked,,, )

   EndDetMenu()

RETURN ( oDlg:nResult == 1 )







STATIC FUNCTION SetDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, aTmpSat, oSayLote, oRentLin, oFld )

   local cCodArt  := aGet[ 4 ]:varGet()

   if !uFieldEmpresa( "lUseBultos" )
      aGet[ 80 ]:Hide()
   else
      if !Empty( aGet[ 80 ] )
         aGet[ 80 ]:SetText( uFieldempresa( "cNbrBultos" ) )
      end
   end

   if aGet[ 7 ] <> nil
      if !lUseCaj()
         aGet[ 7 ]:hide()
      else
         aGet[ 7 ]:SetText( cNombreCajas() )
      end
   end

   if aGet[ 8 ] <> nil
      aGet[ 8 ]:SetText( cNombreUnidades() )
   end

   if aGet[ 39 ] <> nil
      if !uFieldEmpresa( "lUseImp" )
         aGet[ 39 ]:Hide()
      else
         if !uFieldEmpresa( "lModImp" )
            aGet[ 39 ]:Disable()
         end
      end
   end

   if aGet[ 13 ] <> nil
      if !uFieldEmpresa( "lUsePor" )
         aGet[ 13 ]:Hide()
      end
   end

   if aGet[ 12 ] <> nil
      if !uFieldEmpresa( "lUsePnt" ) .OR. !aTmpSat[ 80 ]
         aGet[ 12 ]:Hide()
      end
   end

   if aGet[ 30 ] <> nil
      if !uFieldEmpresa( "lDtoLin" )
         aGet[ 30 ]:Hide()
      end
   end

   if oRentLin <> nil .AND. RolesModel():getRolNoMostrarRentabilidad( Auth():rolUuid() )
      oRentLin:Hide()
   end

   if aTmp[ 68 ]
      aGet[ 11 ]:Hide()
      aGet[ 67 ]:Show()
   end

   if aTmp[ 33 ] == 2

      if !Empty( aGet[ 84 ] )
         aGet[ 84 ]:Show()
      end

   else

      if !Empty( aGet[ 84 ] )
         aGet[ 84 ]:Hide()
      end

   end

   do case
   case nMode == 1

      aTmp[ 4    ]  := Space( 32 )
      aTmp[ 37 ]  := aTmpSat[ 52 ]
      aTmp[ 32 ]  := nLastNum( dbfTmpLin )

      if aGet[ 91 ] <> nil
         aGet[ 91 ]:cText( nLastNum( dbfTmpLin, "nPosPrint" ) )
      end

      aGet[ 7  ]:cText( 1 )
      aGet[ 8 ]:cText( 1 )
      aGet[ 36  ]:cText( aTmpSat[ 17 ] )
      aGet[ 5 ]:show()

      if aGet[ 22 ] <> nil
         aGet[ 22 ]:hide()
      end

      if aGet[ 42 ] <> nil
         aGet[ 42 ]:hide()
      end

      if oSayLote <> nil
         oSayLote:Hide()
      end

      if aTmpSat[ 51 ] <= 2
         aGet[ 6 ]:cText( nIva( dbfIva, cDefIva() ) )
      end

      if !empty( aGet[ 92 ] )
         aGet[ 92 ]:cText( aTmpSat[ 89 ] )
         aGet[ 92 ]:lValid()
      endif

      cTipoCtrCoste        := "Centro de coste"
      oTipoCtrCoste:Refresh()
      clearGet( aGet[ 94 ] )

   case nMode <> 1 .AND. empty( cCodArt )

      aGet[ 4    ]:hide()
      aGet[ 5]:hide()

      if aGet[ 22 ] <> nil
         aGet[ 22 ]:show()
      end

      if aGet[ 42 ] <> nil
         aGet[ 42 ]:hide()
      end

      if oSayLote <> nil
         oSayLote:hide()
      end

   case nMode <> 1 .AND. !empty( cCodArt )

      aGet[ 4     ]:show()
      aGet[ 5 ]:show()
      aGet[ 22  ]:hide()

      if aTmp[ 40 ]

         if !Empty( aGet[ 42 ] ) .AND. !Empty( oSayLote )
            aGet[ 42 ]:Show()
            oSayLote:Show()
         end

      else

        if !Empty( aGet[ 42 ] ) .AND. !Empty( oSayLote )
            aGet[ 42 ]:Hide()
            oSayLote:Hide()
        end

      end

      if oStkAct <> nil
         StocksModel():lPutStockActual( cCodArt, aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct )
      end

   end

   if !empty( aGet[ 92 ] )
      aGet[ 92 ]:lValid()
   endif

   if !Empty( oStkAct )

      if !uFieldEmpresa( "lNStkAct" )
         oStkAct:Show()
      else
         oStkAct:Hide()
      end

   end

   if !Empty( aTmp[ 25 ] )

      if !Empty( aGet[27 ] )
         aGet[ 27 ]:Show()
         aGet[ 27 ]:lValid()
      end
      if !Empty( oSayPr1 )
         oSayPr1:Show()
         oSayPr1:SetText( retProp( aTmp[25], dbfPro ) )
      end
      if !Empty( oSayVp1 )
         oSayVp1:Show()
      end

   else

      if !Empty( aGet[27 ] )
         aGet[27 ]:hide()
      end
      if !Empty( oSayPr1 )
         oSayPr1:hide()
      end
      if !Empty( oSayVp1 )
         oSayVp1:hide()
      end

   end

   if !Empty( aTmp[ 26 ] )

      if !Empty( aGet[28 ] )
         aGet[ 28 ]:Show()
         aGet[ 28 ]:lValid()
      end

      if !Empty( oSayPr2 )
         oSayPr2:Show()
         oSayPr2:SetText( retProp(  aTmp[26], dbfPro ) )
      end

      if !Empty( oSayVp2 )
         oSayVp2:Show()
      end

   else

      if !Empty( aGet[28 ] )
         aGet[28 ]:hide()
      end
      if !Empty( oSayPr2 )
         oSayPr2:hide()
      end
      if !Empty( oSayVp2 )
         oSayVp2:hide()
      end

   end





   if Empty( aTmp[ 73 ] )
      if !Empty( aGet[ 73 ] )
         aGet[ 73 ]:cText( oGetTarifa:getTarifa() )
      else
         aTmp[ 73 ]     := oGetTarifa:getTarifa()
      end
   end

   if !Empty( aGet[ 73 ] )
      if !uFieldEmpresa( "lPreLin" )
         aGet[ 73 ]:Hide()
      else
         aGet[ 73 ]:Show()
      end
   end





   if aGet[ 36 ] <> nil
      aGet[ 36 ]:lValid()
   end

   aGet[ 4 ]:SetFocus()

   if !lAccArticulo() .OR. RolesModel():getRolNoVerPreciosCosto( Auth():rolUuid() )

      if !Empty( aGet[ 34 ] )
         aGet[ 34 ]:Hide()
      end

   end





   if ( empty( aTmp[ 11 ] ) .OR. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) ) .AND. nMode <> 3

      aGet[ 11 ]:HardEnable()
      aGet[ 14    ]:HardEnable()
      aGet[ 15 ]:HardEnable()

      if aGet[ 13 ] <> nil
         aGet[ 13 ]:HardEnable()
      end

      if aGet[ 12 ] <> nil
         aGet[ 12 ]:HardEnable()
      end

      if aGet[ 30 ] <> nil
         aGet[ 30 ]:HardEnable()
      end

   else

      aGet[ 11 ]:HardDisable()
      aGet[ 14    ]:HardDisable()
      aGet[ 15 ]:HardDisable()

      if aGet[ 13 ] <> nil
         aGet[ 13 ]:HardDisable()
      end

      if aGet[ 12 ] <> nil
         aGet[ 12 ]:HardDisable()
      end

      if aGet[ 30 ] <> nil
         aGet[ 30 ]:HardDisable()
      end

   end



   if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
      aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
      aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
   end

   if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
      aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
   end

   if oUndMedicion:oDbf:Seek(  aTmp[ 18 ] )

      if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
         aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
      end

      if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
         aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
      end

      if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] ) .AND. oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
         aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
      end

   end



   if !Empty( oFld )
      oFld:SetOption( 1 )
   end



   if !empty(oBrwProperties)
      oBrwProperties:Hide()
      oBrwProperties:Cargo    := nil
   end



   aGet[ 4 ]:SetFocus()

Return nil



STATIC FUNCTION SaveDeta( aTmp, aTmpSat, aGet, oDlg2, oBrw, bmpImage, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, oSayLote, cCodArt, oBtn, oBtnSer, oFld )

   local n
   local i
   local aClo
   local nRec
   local hAtipica
   local nPrecioPropiedades   := 0

   oBtn:SetFocus()

   if !aGet[ 4 ]:lValid()
      return nil
   end

   if !lMoreIva( aTmp[ 6 ] )
      return nil
   end

   if Empty( aTmp[ 36 ] ) .AND. !Empty( aTmp[ 4 ] )
      msgStop( "Código de almacén no puede estar vacío", "Atención" )
      return nil
   end

   if !cAlmacen( aGet[ 36 ], dbfAlm )
      return nil
   end



   if ( nMode == 1 ) .AND. RetFld( aTmp[ 4 ], D():Articulos( nView ), "lNumSer" ) .AND. !( dbfTmpSer )->( dbSeek( Str( aTmp[ 32 ], 4 ) + aTmp[ 4 ] ) )
      MsgStop( "Tiene que introducir números de serie para este artículo." )
      oBtnSer:Click()
      Return nil
   end



   if lPrecioMinimo( aTmp[ 4 ], aTmp[ 11 ], nMode, D():Articulos( nView ) )
      msgStop( "El precio de venta es inferior al precio mínimo.")
      Return nil
   end



   if aTmp[ 33 ] == 2 .AND. aTmp[ 84 ] == 0
      if !ApoloMsgNoYes( "¿Está seguro de dejar el contador del producto a 0?", "Elija una opción" )
         aGet[ 84 ]:SetFocus()
         Return nil
      end
   end



   aTmp[ 93 ]     := cTipoCtrCoste
   nRec                 := ( dbfTmpLin )->( RecNo() )

   aTmp[ 53 ]        := nPReq( dbfIva, aTmp[ 6 ] )

   aClo                 := aClone( aTmp )



   if nMode == 1

      aTmp[ 4 ]     := cCodArt

      if aTmp[ 40 ]
         saveLoteActual( aTmp[ 4 ], aTmp[ 42 ], nView )
      end



      if !empty( oBrwProperties:Cargo )

         for n := 1 to len( oBrwProperties:Cargo )

            for i := 1 to len( oBrwProperties:Cargo[ n ] )

               if !Empty( oBrwProperties:Cargo[ n, i ] )

                  if isNum( oBrwProperties:Cargo[ n, i ]:Value ) .AND. oBrwProperties:Cargo[ n, i ]:Value <> 0

                     aTmp[ 32 ]     := nLastNum( dbfTmpLin )
                     aTmp[ 91 ]   := nLastNum( dbfTmpLin, "nPosPrint" )
                     aTmp[ 8]     := oBrwProperties:Cargo[ n, i ]:Value
                     aTmp[ 25 ]     := oBrwProperties:Cargo[ n, i ]:cCodigoPropiedad1
                     aTmp[ 27 ]     := oBrwProperties:Cargo[ n, i ]:cValorPropiedad1
                     aTmp[ 26 ]     := oBrwProperties:Cargo[ n, i ]:cCodigoPropiedad2
                     aTmp[ 28 ]     := oBrwProperties:Cargo[ n, i ]:cValorPropiedad2



                     nPrecioPropiedades   := nPrePro( aTmp[ 4 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ], aTmp[ 73 ], aTmpSat[ 52 ], dbfArtDiv, dbfTarPreL, aTmpSat[ 16 ] )
                     if !empty(nPrecioPropiedades)
                        aTmp[ 11 ]  := nPrecioPropiedades
                     end



                     saveDetail( aTmp, aClo, aGet, aTmpSat, dbfTmpLin, oBrw, nMode )

                  end

               end

            next

         next

         aCopy( dbBlankRec( dbfTmpLin ), aTmp )

         aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      else

         saveDetail( aTmp, aClo, aGet, aTmpSat, dbfTmpLin, oBrw, nMode )



      end

   else

      WinGather( aTmp, aGet, dbfTmpLin, oBrw, nMode )

   end

   ( dbfTmpLin )->( dbGoTo( nRec ) )



   cOldCodArt                          := ""
   cOldUndMed                          := ""

   if !Empty( aGet[ 18 ] )
      aGet[ 18 ]:lValid()
   end



   if bmpImage <> nil
      bmpImage:Hide()
      if !Empty( bmpImage:hBitmap )
         PalbmpFree( bmpImage:hBitmap, bmpImage:hPalette )
      endif
   end

   if nMode == 1 .AND. lEntCon()

      nTotSatCli( nil, D():SatClientes( nView ), dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmpSat )

      aCopy( dbBlankRec( dbfTmpLin ), aTmp )
      aEval( aGet, {| o, i | if( "GET" $ o:ClassName(), o:cText( aTmp[ i ] ), ) } )

      setDlgMode( aTmp, aGet, nMode, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, oTotal, aTmpSat, oSayLote, , oFld )

      SysRefresh()

   else

      oDlg2:end( 1 )

   end

RETURN NIL



Static Function saveDetail( aTmp, aClo, aGet, aTmpSat, dbfTmpLin, oBrw, nMode )

   local hAtipica
   local sOfertaArticulo
   local nCajasGratis         := 0
   local nUnidadesGratis      := 0



   hAtipica                   := hAtipica( hValue( aTmp, aTmpSat ) )
   if !empty( hAtipica )
      if hhaskey( hAtipica, "nCajasGratis" ) .AND. hget( hAtipica, "nCajasGratis" ) <> 0
         nCajasGratis         := hget( hAtipica, "nCajasGratis" )
      end
      if hhaskey( hAtipica, "nUnidadesGratis" ) .AND. hget( hAtipica, "nUnidadesGratis" ) <> 0
         nUnidadesGratis      := hget( hAtipica, "nUnidadesGratis" )
      end
   end



   if empty( nCajasGratis ) .AND. empty( nUnidadesGratis )
      sOfertaArticulo         := structOfertaArticulo( D():getHashArray( aTmpSat, "SatCliT", nView ), D():getHashArray( aTmp, "SatCliL", nView ), nTotLSatCli( aTmp ), nView )
      if !empty( sOfertaArticulo )
         nCajasGratis         := sOfertaArticulo:nCajasGratis
         nUnidadesGratis      := sOfertaArticulo:nUnidadesGratis
      end
   end



   if nCajasGratis <> 0
      aTmp[ 78 ]        := .T.
      aTmp[ 7 ]        -= nCajasGratis
      commitDetail( aTmp, aClo, nil, aTmpSat, dbfTmpLin, oBrw, nMode )

      aTmp[ 78 ]        := .T.
      aTmp[ 7 ]        := nCajasGratis
      aTmp[ 11 ]        := 0
      aTmp[ 14    ]        := 0
      aTmp[ 30 ]        := 0
      aTmp[ 15 ]        := 0
      aTmp[ 16 ]        := 0
   end



   if nUnidadesGratis <> 0
      aTmp[ 78 ]        := .T.
      aTmp[ 8]        -= nUnidadesGratis

      commitDetail( aTmp, aClo, nil, aTmpSat, dbfTmpLin, oBrw, nMode )

      aTmp[ 78 ]        := .T.
      aTmp[ 8]        := nUnidadesGratis
      aTmp[ 11 ]        := 0
      aTmp[ 14    ]        := 0
      aTmp[ 30 ]        := 0
      aTmp[ 15 ]        := 0
      aTmp[ 16 ]        := 0
   end

   commitDetail( aTmp, aClo, aGet, aTmpSat, dbfTmpLin, oBrw, nMode )

Return nil



Static Function commitDetail( aTmp, aClo, aGet, aTmpSat, dbfTmpLin, oBrw, nMode )

   winGather( aTmp, aGet, dbfTmpLin, oBrw, nMode, nil, .F. )

   if ( nMode == 1 ) .AND. ( aClo[ 43 ] )
      appendKit( aClo, aTmpSat )
   end

Return nil



Static Function EditarNumeroSerie( aTmp, oStock, nMode )

   with object ( TNumerosSerie() )

      :nMode            := nMode

      :cCodArt          := aTmp[ 4    ]
      :cCodAlm          := aTmp[ 36 ]
      :nNumLin          := aTmp[ 32 ]

      :lCompras         := .T.

      :nTotalUnidades   := nTotNSatCli( aTmp )

      :oStock           := oStock

      :uTmpSer          := dbfTmpSer

      :Resource()

   end

Return ( nil )



Static Function EdtInc( aTmp, aGet, dbfSatCliI, oBrw, bWhen, bValid, nMode, aTmpSat )

   local oDlg

   if nMode == 1
      aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]  := .T.
   end

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "incidencias de S.A.T. a clientes", "INCIDENCIA",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "dFecInc" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lAviso" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "mDesInc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )




      TCheckBox():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ], aTmp[ ( dbfTmpInc )->( FieldPos( "lListo" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F. )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpInc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )



Static Function EdtDoc( aTmp, aGet, dbfSatCliD, oBrw, bWhen, bValid, nMode, aTmpLin )

   local oDlg
   local oRuta
   local oNombre
   local oObservacion

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "documento de S.A.T. a cliente", "DOCUMENTOS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      oNombre := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cNombre" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      oRuta := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "cRuta" ) ) ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( oRuta:cText( cGetFile( "Doc ( *.* ) | " + "*.*", "Seleccione el nombre del fichero" ) ) )}, nil, "FOLDER",, )





      oObservacion := TMultiGet():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ], aTmp[ ( dbfTmpDoc )->( FieldPos( "mObsDoc" ) ) ]:= u ) }, oDlg,,,,,,, .F., {||     ( nMode <> 3 )}, .F.,, )





      TButton():ReDefine( 1, {||( WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| WinGather( aTmp, nil, dbfTmpDoc, oBrw, nMode ), oDlg:end( 1 ) } )
   end

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

Return ( oDlg:nResult == 1 )



STATIC FUNCTION PrnSerie()

   local oDlg
   local oFmtDoc
   local cFmtDoc     := cFormatoDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) )
   local oSayFmt
   local cSayFmt
   local oSerIni
   local oSerFin
   local cSerIni     := ( D():SatClientes( nView ) )->cSerSat
   local cSerFin     := ( D():SatClientes( nView ) )->cSerSat
   local nDocIni     := ( D():SatClientes( nView ) )->nNumSat
   local nDocFin     := ( D():SatClientes( nView ) )->nNumSat
   local cSufIni     := ( D():SatClientes( nView ) )->cSufSat
   local cSufFin     := ( D():SatClientes( nView ) )->cSufSat
   local oPrinter
   local cPrinter    := ImpresoraDefectoUsuario()
   local lCopiasSat  := .T.
   local lInvOrden   := .F.
   local oNumCop
   local nNumCop     := if( nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) == 0, Max( Retfld( ( D():SatClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) )
   local oRango
   local nRango      := 1
   local dFecDesde   := CtoD( "01/01/" + Str( Year( Date() ) ) )
   local dFecHasta   := Date()

   if Empty( cFmtDoc )
      cFmtDoc           := cSelPrimerDoc( "SC" )
   end

   cSayFmt           := cNombreDoc( cFmtDoc )

   oDlg = TDialog():New(,,,, "Imprimir series de S.A.T.", "IMPSERIES",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )



   oRango := TRadMenu():Redefine( { | u | If( PCount()==0, nRango, nRango:= u ) }, oDlg,, { 201, 202 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z"  )},,,,,, .T., {||     ( nRango == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( nRango == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( nRango == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 210, { | u | If( PCount()==0, dFecDesde, dFecDesde:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 220, { | u | If( PCount()==0, dFecHasta, dFecHasta:= u ) }, oDlg,,,,,,,,, .F., {||     ( nRango == 2 )},, .F., .T.,,,,,, nil,,, )



   TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )



   TCheckBox():ReDefine( 170, { | u | If( PCount()==0, lCopiasSat, lCopiasSat:= u ) }, oDlg,,,,,,, .F.,, .F. )









   oNumCop := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, nNumCop, nNumCop:= u ) }, oDlg,, "999999999", {||    nNumCop > 0},,,,,, .F., {||     !lCopiasSat},, .F., .T.,,, {||      1}, {||      99999},, nil,,, )







   oFmtDoc := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, cFmtDoc, cFmtDoc:= u ) }, oDlg,,, {||    ( cDocumento( oFmtDoc, oSayFmt, dbfDoc ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oFmtDoc, oSayFmt, "SC" ) )}, nil, "LUPA",, )





   oSayFmt := TGetHlp():ReDefine( 91, { | u | If( PCount()==0, cSayFmt, cSayFmt:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 92, "gc_document_text_pencil_12",,,,,{|| EdtDocumento( cFmtDoc ) }, oDlg, .F., , .F.,  )




   oPrinter := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cPrinter, cPrinter:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 161, "gc_printer2_check_16",,,,,{|| PrinterPreferences( oPrinter ) }, oDlg, .F., , .F.,  )





   TButton():ReDefine( 1, {||(  StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, nil, lCopiasSat, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| StartPrint( SubStr( cFmtDoc, 1, 3 ), cSerIni + Str( nDocIni, 9 ) + cSufIni, cSerFin + Str( nDocFin, 9 ) + cSufFin, oDlg, nil, lCopiasSat, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta ), oDlg:end( 1 ) } )

   oDlg:bStart := { || oSerIni:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oWndBrw:oBrw:refresh()

RETURN NIL



STATIC FUNCTION StartPrint( cFmtDoc, cDocIni, cDocFin, oDlg, cPrinter, lCopiasSat, nNumCop, lInvOrden, nRango, dFecDesde, dFecHasta )

   local nCopyClient
   local nRecno
   local nOrdAnt

   oDlg:disable()

   if nRango == 1

      nRecno      := ( D():SatClientes( nView ) )->( recno() )
      nOrdAnt     := ( D():SatClientes( nView ) )->( OrdSetFocus( "nNumSat" ) )

      if ! lInvOrden

         if ( D():SatClientes( nView ) )->( dbSeek( cDocIni, .T. ) )



            while ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat >= cDocIni   .AND.  ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat <= cDocFin   .AND.  !( D():SatClientes( nView ) )->( Eof() )

                  lChgImpDoc( D():SatClientes( nView ) )

               if lCopiasSat

                  nCopyClient := if( nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) == 0, Max( Retfld( ( D():SatClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) )

                  GenSatCli( 1, "Imprimiendo documento : " + ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, cFmtDoc, cPrinter, nCopyClient )

               else

                  GenSatCli( 1, "Imprimiendo documento : " + ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, cFmtDoc, cPrinter, nNumCop )

               end

               ( D():SatClientes( nView ) )->( dbSkip() )

            end

         end

      else

         if ( D():SatClientes( nView ) )->( dbSeek( cDocFin ) )



            while ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat >= cDocIni   .AND. ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat <= cDocFin   .AND. !( D():SatClientes( nView ) )->( Bof() )

                  lChgImpDoc( D():SatClientes( nView ) )

               if lCopiasSat

                  nCopyClient := if( nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) == 0, Max( Retfld( ( D():SatClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) )

                  GenSatCli( 1, "Imprimiendo documento : " + ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, cFmtDoc, cPrinter, nCopyClient )

               else

                  GenSatCli( 1, "Imprimiendo documento : " + ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, cFmtDoc, cPrinter, nNumCop )

               end

               ( D():SatClientes( nView ) )->( dbSkip( -1 ) )

            end

         end

      end

   else

      nRecno      := ( D():SatClientes( nView ) )->( recno() )
      nOrdAnt     := ( D():SatClientes( nView ) )->( OrdSetFocus( "dFecSat" ) )

      if ! lInvOrden

         ( D():SatClientes( nView ) )->( dbGoTop() )

         while !( D():SatClientes( nView ) )->( Eof() )

            if ( D():SatClientes( nView ) )->dFecSat >= dFecDesde .AND. ( D():SatClientes( nView ) )->dFecSat <= dFecHasta

               lChgImpDoc( D():SatClientes( nView ) )

               if lCopiasSat

                  nCopyClient := if( nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) == 0, Max( Retfld( ( D():SatClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) )

                  GenSatCli( 1, "Imprimiendo documento : " + ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, cFmtDoc, cPrinter, nCopyClient )

               else

                  GenSatCli( 1, "Imprimiendo documento : " + ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, cFmtDoc, cPrinter, nNumCop )

               end

            end

            ( D():SatClientes( nView ) )->( dbSkip() )

         end

      else

         ( D():SatClientes( nView ) )->( dbGobottom() )

         while !( D():SatClientes( nView ) )->( Bof() )

            if ( D():SatClientes( nView ) )->dFecSat >= dFecDesde .AND. ( D():SatClientes( nView ) )->dFecSat <= dFecHasta

               lChgImpDoc( D():SatClientes( nView ) )

               if lCopiasSat

                  nCopyClient := if( nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) == 0, Max( Retfld( ( D():SatClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" ), 1 ), nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Documentos( nView ) ) )

                  GenSatCli( 1, "Imprimiendo documento : " + ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, cFmtDoc, cPrinter, nCopyClient )

               else

                  GenSatCli( 1, "Imprimiendo documento : " + ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, cFmtDoc, cPrinter, nNumCop )

               end

            end

            ( D():SatClientes( nView ) )->( dbSkip( -1 ) )

         end

      end

   end

   ( D():SatClientes( nView ) )->( dbGoTo( nRecNo ) )
   ( D():SatClientes( nView ) )->( ordSetFocus( nOrdAnt ) )

   oDlg:enable()

RETURN NIL



STATIC FUNCTION RecalculaTotal( aTmp )

   nTotSatCli( nil, D():SatClientes( nView ), dbfTmpLin, dbfIva, dbfDiv, dbfFPago, aTmp )





   aTotIva     := aSort( aTotIva,,, {|x,y| x[1] > y[1] } )

   if oBrwIva  <> nil
      oBrwIva:Refresh()
   end





   if oGetNet <> nil
      oGetNet:SetText( Trans( nTotNet, cPorDiv ) )
   end

   if oGetIvm <> nil
      oGetIvm:SetText( Trans( nTotIvm, cPorDiv ) )
   end

   if oGetRnt <> nil
      oGetRnt:cText( AllTrim( Trans( nTotRnt, cPorDiv ) + Space( 1 ) + AllTrim( cSimDiv( aTmp[ 46 ], dbfDiv ) ) + " : " + AllTrim( Trans( nPctRnt, "999.99" ) ) + "%" ) )
   end

   IF oGetIva <> nil
      oGetIva:SetText( Trans( nTotIva, cPorDiv ) )
   end

   if oGetReq <> nil
      oGetReq:SetText( Trans( nTotReq, cPorDiv ) )
   end

   if oGetPnt <> nil
      oGetPnt:SetText( Trans( nTotPnt, cPorDiv ) )
   end

   if oGetTrn <> nil
      oGetTrn:SetText( Trans( nTotTrn, cPorDiv ) )
   end

   if oGetTotal <> nil
      oGetTotal:SetText( Trans( nTotSat, cPorDiv ) )
   end

   if oGetAge <> nil
      oGetAge:SetText( Trans( nTotAge, cPorDiv ) )
   end

   if oGetPes <> nil
      oGetPes:cText( nTotPes )
   end

   if oGetDif <> nil
      oGetDif:cText( nTotDif )
   end

Return .T.



STATIC FUNCTION LoaArt( aTmp, aGet, aTmpSat, oStkAct, oSayPr1, oSayPr2, oSayVp1, oSayVp2, bmpImage, oSayLote, nMode, lFocused )

   local nDtoAge
   local nImpAtp
   local nImporteTarifa
   local nCosPro
   local cCodFam
   local cCodArt              := aGet[ 4 ]:VarGet()
   local cPrpArt
   local cLotArt
   local nPrePro              := 0
   local nPosComa
   local cProveedor
   local nTarOld              := aTmp[ 73 ]
   local lChgCodArt           := ( empty( cOldCodArt ) .OR. rtrim( cOldCodArt ) <> rtrim( cCodArt ) )
   local nDescuentoArticulo   := 0
   local hValue
   local hAtipica
   local sOfertaArticulo

   If( lFocused == nil, lFocused := .T., ) ;

   if empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

      if empty( aTmp[ 6 ] )
         aGet[ 6 ]:bWhen     := {|| .T. }
      end

      aGet[ 5 ]:Hide()

      if !empty( aGet[ 22 ] )
          aGet[ 22 ]:Show()
      end

      if !empty( oBrwProperties )
         oBrwProperties:Hide()
      end

      if lFocused .AND. !empty( aGet[ 22 ] )
        aGet[ 22 ]:SetFocus()
      end

   else

      aGet[ 6     ]:bWhen   := {|| lModIva() }
      aGet[ 5 ]:show()

      if aGet[ 22 ] <> nil
         aGet[ 22 ]:hide()
      end





      if "," $ cCodArt
         nPosComa                := At( ",", cCodArt )
         cProveedor              := RJust( Left( cCodArt, nPosComa - 1 ), "0", RetNumCodPrvEmp() )
         cCodArt                 := cSeekProveedor( cCodArt, dbfArtPrv )
      else
         cCodArt                 := cSeekCodebar( cCodArt, dbfCodebar, D():Articulos( nView ) )
      end





      if ( D():Articulos( nView ) )->( dbSeek( cCodArt ) ) .OR. ( D():Articulos( nView ) )->( dbSeek( Upper( cCodArt ) ) )

         if ( D():Articulos( nView ) )->lObs
            MsgStop( "Artículo catalogado como obsoleto" )
            return .F.
         end

         if ( lChgCodArt )

            cCodArt              := ( D():Articulos( nView ) )->Codigo
            aTmp[ 4 ]        := cCodArt
            aGet[ 4 ]:cText( cCodArt )



            aTmp[ 89 ]     := ( D():Articulos( nView ) )->cRefAux
            aTmp[ 90 ]    := ( D():Articulos( nView ) )->cRefAux2

            if ( D():Articulos( nView ) )->lMosCom .AND. !Empty( ( D():Articulos( nView ) )->mComent )
               MsgStop( Trim( ( D():Articulos( nView ) )->mComent ) )
            end





            if !Empty( aGet[ 55 ] )
               aGet[ 55 ]:cText( ( D():Articulos( nView ) )->cPrvHab )
               aGet[ 55 ]:lValid()
            else
               aTmp[ 55 ]  := ( D():Articulos( nView ) )->cPrvHab
            end

            aTmp[ 62 ]  := Padr( cRefPrvArt( cCodArt, ( D():Articulos( nView ) )->cPrvHab , dbfArtPrv ), 18 )





            if ( D():Articulos( nView ) )->lLote

               if oSayLote <> nil
                  oSayLote:Show()
               end

               if aGet[ 42 ] <> nil
                  aGet[ 42 ]:show()
               end

               if uFieldempresa( "lLoaUltLot" )

                  if aGet[ 42 ] <> nil
                     aGet[ 42 ]:cText( ( D():Articulos( nView ) )->cLote )
                  else
                     aTmp[ 42 ] := ( D():Articulos( nView ) )->cLote
                  end

               end

               aTmp[ 40 ]    := ( D():Articulos( nView ) )->lLote

            else

               if oSayLote <> nil
                  oSayLote:hide()
               end

               if aGet[ 42 ] <> nil
                  aGet[ 42 ]:hide()
               end

            end

            aTmp[ 40   ]     := ( D():Articulos( nView ) )->lLote





            aTmp[ 47 ]     := ( D():Articulos( nView ) )->lMsgVta
            aTmp[ 48 ]     := ( D():Articulos( nView ) )->lNotVta

            cCodFam              := ( D():Articulos( nView ) )->Familia

            if !Empty( cCodFam )

               if aGet[ 51 ] <> nil
                  aGet[ 51 ]:cText( cCodFam )
                  aGet[ 51 ]:lValid()
               else
                  aTmp[ 51 ]  := cCodFam
               end

               if aGet[ 52 ] <> nil
                  aGet[ 52 ]:cText( cGruFam( cCodFam, dbfFamilia ) )
                  aGet[ 52 ]:lValid()
               else
                  aTmp[ 52 ]  := cGruFam( cCodFam, dbfFamilia )
               end

            else

               if aGet[ 51 ] <> nil
                  aGet[ 51 ]:cText( Space( 8 ) )
                  aGet[ 51 ]:lValid()
               end

               if aGet[ 52 ] <> nil
                  aGet[ 52 ]:cText( Space( 3 ) )
                  aGet[ 52 ]:lValid()
               end

            end





            if !Empty( aGet[ 77 ] )
               aGet[ 77 ]:cText( ( D():Articulos( nView ) )->Descrip )
            else
               aTmp[ 77 ]     := ( D():Articulos( nView ) )->Descrip
            end





            if !Empty( aGet[ 85 ] )
               aGet[ 85 ]:cText( ( D():Articulos( nView ) )->cDesUbi )
            else
               aTmp[ 85 ]     := ( D():Articulos( nView ) )->cDesUbi
            end





            if ( D():Articulos( nView ) )->nBulEnt <> 0
               if !empty( aGet )
                  aGet[ 80 ]:cText( ( D():Articulos( nView ) )->nBulEnt )
               else
                  aTmp[ 80 ]  := ( D():Articulos( nView ) )->nBulEnt
               end
            end

            if ( D():Articulos( nView ) )->nCajEnt <> 0
               if  aGet[ 7 ] <> nil
                   aGet[ 7 ]:cText( ( D():Articulos( nView ) )->nCajEnt )
               else
                   aTmp[ 7 ] := ( D():Articulos( nView ) )->nCajEnt

               end
            end

            if ( D():Articulos( nView ) )->nUniCaja <> 0
               if aGet[ 8 ] <> nil
                  aGet[ 8 ]:cText( ( D():Articulos( nView ) )->nUniCaja )
               else
                  aTmp[ 8 ] := ( D():Articulos( nView ) )->nUniCaja
               end
            end





            if aTmpSat[ 51 ] <= 2

               if aGet[ 6 ] <> nil
                  aGet[ 6 ]:cText( nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva ) )
               else
                  aTmp[ 6 ] := nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva )
               end

               aTmp[ 53 ]     := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )

            end

            if aGet[ 5 ] <> nil
               aGet[ 5 ]:cText( ( D():Articulos( nView ) )->Nombre )
            else
               aTmp[ 5 ] := ( D():Articulos( nView ) )->Nombre
            end

            if aGet[ 22 ] <> nil
               aGet[ 22 ]:cText( ( D():Articulos( nView ) )->Descrip )
            else
               aTmp[ 22 ]  := ( D():Articulos( nView ) )->Descrip
            end





            if ( D():Articulos( nView ) )->lKitArt

               aTmp[ 43 ]        := .T.
               aTmp[ 24 ]        := lImprimirCompuesto( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
               aTmp[ 45 ]        := lPreciosCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )

               if lStockCompuestos( ( D():Articulos( nView ) )->Codigo, D():Articulos( nView ) )
                  if aGet[ 33 ] <> nil
                     aGet[ 33 ]:SetOption( ( D():Articulos( nView ) )->nCtlStock )
                  else
                     aTmp[ 33 ]  := ( D():Articulos( nView ) )->nCtlStock
                  end
               else
                  if aGet[ 33 ] <> nil
                     aGet[ 33 ]:SetOption( 3 )
                  else
                     aTmp[ 33 ]  := 3
                  end
               end

            else

               aTmp[ 24 ]        := .F.
               if aGet[ 33 ] <> nil
                  aGet[ 33 ]:SetOption( ( D():Articulos( nView ) )->nCtlStock )
               else
                  aTmp[ 33 ]     := ( D():Articulos( nView ) )->nCtlStock
               end

            end

            if aTmp[ 33 ] == 2

               if !Empty( aGet[ 84 ] )
                  aGet[ 84 ]:cText( ( D():Articulos( nView ) )->nCntAct )
                  aGet[ 84 ]:Show()
               else
                  aTmp[ 84 ]     := ( D():Articulos( nView ) )->nCntAct
               end

            else

               if !Empty( aGet[ 84 ] )
                  aGet[ 84 ]:Hide()
               end

            end





            aTmp[ 38 ]     := ( D():Articulos( nView ) )->cCodImp
            oNewImp:setCodeAndValue( aTmp[ 38 ], aGet[ 39 ] )

            if !Empty( ( D():Articulos( nView ) )->cCodImp )
               aTmp[ 79 ]     := RetFld( ( D():Articulos( nView ) )->cCodImp, oNewImp:oDbf:cAlias, "lIvaVol" )
            end





            aTmp[ 25 ]        := ( D():Articulos( nView ) )->cCodPrp1
            aTmp[ 26 ]        := ( D():Articulos( nView ) )->cCodPrp2

            if ( !Empty( aTmp[ 25 ] ) .OR. !Empty( aTmp[ 26 ] ) ) .AND. ( uFieldEmpresa( "lUseTbl" ) .AND. ( nMode == 1 ) )

               aGet[ 7  ]:cText( 0 )
               aGet[ 8 ]:cText( 0 )

               setPropertiesTable( cCodArt, aTmp[ 25 ], aTmp[ 26 ], 0, aGet[ 8 ], oBrwProperties, nView )

            else

               hidePropertiesTable( oBrwProperties )

               if !Empty( aTmp[ 25 ] )

                  if aGet[ 27 ] <> nil
                     aGet[ 27 ]:Show()
                     if lFocused
                        aGet[ 27 ]:SetFocus()
                     end
                  end

                  if oSayPr1 <> nil
                     oSayPr1:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp1, dbfPro ) )
                     oSayPr1:show()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:SetText( "" )
                     oSayVp1:Show()
                  end

               else

                  if aGet[ 27 ] <>  nil
                     aGet[ 27 ]:hide()
                  end

                  if oSayPr1 <> nil
                     oSayPr1:Hide()
                  end

                  if oSayVp1 <> nil
                     oSayVp1:Hide()
                  end

               end

               if !Empty( aTmp[ 26 ] )

                  if aGet[ 28 ] <> nil
                     aGet[ 28 ]:show()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:SetText( retProp( ( D():Articulos( nView ) )->cCodPrp2, dbfPro ) )
                     oSayPr2:Show()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:SetText( "" )
                     oSayVp2:Show()
                  end

               else

                  if aGet[ 28 ] <> nil
                     aGet[ 28 ]:hide()
                  end

                  if oSayPr2 <> nil
                     oSayPr2:hide()
                  end

                  if oSayVp2 <> nil
                     oSayVp2:hide()
                  end

               end

            end



            loadComisionAgente( aTmp, aGet, aTmpSat )






            if !Empty( aGet[ 19 ] )
               aGet[ 19  ]:cText( ( D():Articulos( nView ) )->nPesoKg )
            else
               aGet[ 19  ] := ( D():Articulos( nView ) )->nPesoKg
            end

            if !Empty( aGet[ 20 ] )
                aGet[ 20 ]:cText( ( D():Articulos( nView ) )->cUndDim )
            else
                aGet[ 20 ] := ( D():Articulos( nView ) )->cUndDim
            end

            if !Empty( aGet[ 63 ] )
               aGet[ 63 ]:cText( ( D():Articulos( nView ) )->nVolumen )
            else
               aGet[ 63 ] := ( D():Articulos( nView ) )->nVolumen
            end

            if !Empty( aGet[ 18 ] )
                aGet[ 18 ]:cText( ( D():Articulos( nView ) )->cUnidad )
                aGet[ 18 ]:lValid()
            else
                aTmp[ 18 ] := ( D():Articulos( nView ) )->cUnidad
            end

            if !Empty( aGet[ 64 ] )
                aGet[ 64 ]:cText( ( D():Articulos( nView ) )->cVolumen )
            else
                aTmp[ 64 ]:= ( D():Articulos( nView ) )->cVolumen
            end





            if ( D():Articulos( nView ) )->lFacCnv
               aTmp[ 29 ]     := ( D():Articulos( nView ) )->nFacCnv
            end





            if oStkAct <> nil .AND. aTmp[ 33 ] <= 1
               StocksModel():lPutStockActual( cCodArt, aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct )
            end





            if !Empty( aGet[ 57 ] )
               aGet[ 57 ]:cText( ( D():Articulos( nView ) )->cImagen )
            else
               aTmp[ 57 ]     := ( D():Articulos( nView ) )->cImagen
            end

            if !Empty( bmpImage )
               if !Empty( aTmp[ 57 ] )
                  bmpImage:Show()
                  bmpImage:LoadBmp( cFileBitmap( cPatImg(), aTmp[ 57 ] ) )
               else
                  bmpImage:Hide()
               end
            end





            if aGet[ 50 ] <> nil
               aGet[ 50 ]:cText( ( D():Articulos( nView ) )->cCodTip )
            else
               aTmp[ 50 ]  := ( D():Articulos( nView ) )->cCodTip
            end

         end






         cPrpArt                 := aTmp[ 25 ] + aTmp[ 26 ] + aTmp[ 27 ] + aTmp[ 28 ]
         cLotArt                 := aTmp[ 42 ]

         if ( lChgCodArt ) .OR. ( cPrpArt <> cOldPrpArt ) .OR. ( cLotArt <> cOldLotArt )

            if oStkAct <> nil .AND. aTmp[ 33 ] <= 1
               StocksModel():lPutStockActual( cCodArt, aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ], oStkAct )
            end





            if nMode == 1
               cCodFam        := RetFamArt( cCodArt, D():Articulos( nView ) )
            else
               cCodFam        := aTmp[ 51 ]
            end



            if !Empty( aGet[ 14 ] )
               aGet[ 14 ]:cText( 0 )
            else
               aTmp[ 14 ] := 0
            end

            if !Empty( aGet[ 30 ] )
               aGet[ 30 ]:cText( 0 )
            else
               aTmp[ 30 ] := 0
            end

            if !Empty( aGet[ 15 ] )
               aGet[ 15 ]:cText( 0 )
            else
               aTmp[ 15 ]:= 0
            end

            aTmp[ 78  ] := .F.





            if aGet[ 12 ] <> nil
               aGet[ 12 ]:cText( ( D():Articulos( nView ) )->nPntVer1 )
            else
               aTmp[ 12 ]  := ( D():Articulos( nView ) )->nPntVer1
            end

            aTmp[ 35 ]     := ( D():Articulos( nView ) )->PvpRec





            do case
               case uFieldEmpresa( "nCosVta" ) < 2

                  nCosPro           := oStock:nCostoMedio( aTmp[ 4 ], aTmp[ 36 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ] )

                  if nCosPro == 0
                     nCosPro        := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ) )
                  end

               case uFieldEmpresa( "nCosVta" ) == 2

                  nCosPro           := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ) )

               case uFieldEmpresa( "nCosVta" ) == 3

                  nCosPro           := MaterialesProducidosLineasModel():getCosto(  aTmp[ 4 ], aTmp[ 25 ], aTmp[ 26 ], aTmp[ 27 ], aTmp[ 28 ], aTmp[ 42 ] )

                  if nCosPro == 0
                     nCosPro        := nCosto( aTmp[ 4 ], D():Articulos( nView ), dbfKit, .F., , D():Get( "Divisas", nView ) )
                  end

            end










            if aGet[ 34 ] <> nil
               aGet[ 34 ]:cText( nCosPro )
            else
               aTmp[ 34 ]  := nCosPro
            end





            if uFieldempresa( "lDtoCliLin" )

               if !empty( aGet ) .AND. !empty( aGet[ 14 ] )
                  aGet[ 14 ]:cText( retFld( aTmpSat[ 6 ], D():Clientes( nView ), "nDtoEsp" ) )
                  aTmp[ 14 ]     := retFld( aTmpSat[ 6 ], D():Clientes( nView ), "nDtoEsp" )
               else
                  aTmp[ 14 ]     := retFld( aTmpSat[ 6 ], D():Clientes( nView ), "nDtoEsp" )
               end

            end





            nDescuentoArticulo   := nDescuentoArticulo( cCodArt, aTmpSat[ 6 ], nView )
            if nDescuentoArticulo <> 0
               if !Empty( aGet[ 14 ] )
                  aGet[ 14 ]:cText( nDescuentoArticulo )
               else
                  aTmp[ 14 ]  := nDescuentoArticulo
               end
            end





            if aTmp[ 14 ] == 0

               if !Empty( aGet[ 14 ] )
                  aGet[ 14 ]:cText( nDescuentoFamilia( cCodFam, dbfFamilia ) )
               else
                  aTmp[ 14 ]     := nDescuentoFamilia( cCodFam, dbfFamilia )
               end

            end





            if !Empty( aGet[ 18 ] )
               aGet[ 18 ]:cText( ( D():Articulos( nView ) )->cUnidad )
            else
               aTmp[ 18 ]  := ( D():Articulos( nView ) )->cUnidad
            end





            if !aTmp[ 68 ]

               nPrePro        := nPrePro( aTmp[ 4 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ], aTmp[ 73 ], aTmpSat[ 52 ], dbfArtDiv, dbfTarPreL, aTmpSat[16] )

               if nPrePro == 0
                  aGet[ 11 ]:cText( nRetPreArt( aTmp[ 73 ], aTmpSat[ 46 ], aTmpSat[52], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp ) )
               else
                  aGet[ 11 ]:cText( nPrePro )
               end

            else

               aGet[ 11 ]:cText( 0 )
               aGet[ 67 ]:cText( nPreAlq( aTmp[ 4 ], aTmp[ 73 ], aTmpSat[52], D():Articulos( nView ) ) )

            end





            if !Empty( aTmpSat[ 16 ] )





               nImporteTarifa     := RetPrcTar( cCodArt, aTmpSat[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL, aTmp[ 73 ] )
               if nImporteTarifa  <> 0
                  aGet[ 11 ]:cText( nImporteTarifa )
               end

               nImporteTarifa     := RetPctTar( cCodArt, cCodFam, aTmpSat[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL )
               if nImporteTarifa  <> 0
                  aGet[ 14 ]:cText( nImporteTarifa )
               end

               nImporteTarifa     := RetLinTar( cCodArt, cCodFam, aTmpSat[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL )
               if nImporteTarifa  <> 0
                  aGet[ 30 ]:cText( nImporteTarifa )
               end

               nImporteTarifa     := RetComTar( cCodArt, cCodFam, aTmpSat[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpSat[14], dbfTarPreL, dbfTarPreS )
               if nImporteTarifa  <> 0
                  aGet[ 16 ]:cText( nImporteTarifa )
               end



               nImporteTarifa     := RetDtoPrm( cCodArt, cCodFam, aTmpSat[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpSat[5], dbfTarPreL )
               if nImporteTarifa  <> 0
                  aGet[ 15 ]:cText( nImporteTarifa )
               end





               nDtoAge     := RetDtoAge( cCodArt, cCodFam, aTmpSat[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], aTmpSat[5], aTmpSat[14], dbfTarPreL, dbfTarPreS )
               if nDtoAge  <> 0
                  aGet[ 16 ]:cText( nDtoAge )
               end

            end





            hValue   := hValue( aTmp, aTmpSAT )
            hAtipica := hAtipica( hValue )

            if !Empty( hAtipica )

               if hhaskey( hAtipica, "nTarifaFamilia" ) .AND. hAtipica[ "nTarifaFamilia" ] > 0
                  aGet[ 11 ]:cText( nRetPreArt( hAtipica[ "nTarifaFamilia" ], aTmpSat[ 46 ], aTmpSat[52], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp ) )
               end

               if hhaskey( hAtipica, "nImporte" ) .AND. hAtipica[ "nImporte" ] <> 0
                  aGet[ 11 ]:cText( hAtipica[ "nImporte" ] )
               end

               if hhaskey( hAtipica, "nDescuentoPorcentual" ) .AND. hAtipica[ "nDescuentoPorcentual"] <> 0
                  aGet[ 14 ]:cText( hAtipica[ "nDescuentoPorcentual"] )
               end

               if hhaskey( hAtipica, "nDescuentoPromocional" ) .AND. hAtipica[ "nDescuentoPromocional" ] <> 0
                  aGet[ 15 ]:cText( hAtipica[ "nDescuentoPromocional" ] )
               end

               if hhaskey( hAtipica, "nComisionAgente" ) .AND. hAtipica[ "nComisionAgente" ] <> 0
                  aGet[ 16 ]:cText( hAtipica[ "nComisionAgente" ] )
               end

               if hhaskey( hAtipica, "nDescuentoLineal" ) .AND. hAtipica[ "nDescuentoLineal" ] <> 0
                  aGet[ 30 ]:cText( hAtipica[ "nDescuentoLineal" ] )
               end

            end



            sOfertaArticulo   := structOfertaArticulo( D():getHashArray( aTmpSat, "SatCliT", nView ), D():getHashArray( aTmp, "SatCliL", nView ), nTotLSatCli( aTmp ), nView )

            if !empty( sOfertaArticulo )

               if ( sOfertaArticulo:nPrecio <> 0 )
                  aGet[ 11 ]:cText( sOfertaArticulo:nPrecio )
               end

               if ( sOfertaArticulo:nDtoPorcentual <> 0 )
                  aGet[ 14 ]:cText( sOfertaArticulo:nDtoPorcentual )
               end

               if ( sOfertaArticulo:nDtoLineal <> 0 )
                  aGet[ 30 ]:cText( sOfertaArticulo:nDtoLineal )
               end

               aTmp[ 78 ] := .T.

            end



            if oUndMedicion:oDbf:Seek( ( D():Articulos( nView ) )->cUnidad )

               if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( ( D():Articulos( nView ) )->nLngArt )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
               else
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
               end

               if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( ( D():Articulos( nView ) )->nAltArt )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
               else
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
               end

               if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( ( D():Articulos( nView ) )->nAncArt )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
               else
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
                  aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
               end

            else

               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()

               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()

               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()

            end

         end





         cOldPrpArt := cPrpArt
         cOldCodArt := cCodArt
         cOldLotArt := cLotArt





         if Empty( aTmp[ 11 ] ) .OR. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) )

            aGet[ 11 ]:HardEnable()
            aGet[ 14    ]:HardEnable()
            aGet[ 15 ]:HardEnable()

            if aGet[ 13 ] <> nil
               aGet[ 13 ]:HardEnable()
            end

            if aGet[ 12 ] <> nil
               aGet[ 12 ]:HardEnable()
            end

            if aGet[ 30 ] <> nil
               aGet[ 30 ]:HardEnable()
            end

         else

            aGet[ 11 ]:HardDisable()
            aGet[ 14    ]:HardDisable()
            aGet[ 15 ]:HardDisable()

            if aGet[ 13 ] <> nil
               aGet[ 13 ]:HardDisable()
            end

            if aGet[ 12 ] <> nil
               aGet[ 12 ]:HardDisable()
            end

            if aGet[ 30 ] <> nil
               aGet[ 30 ]:HardDisable()
            end

         end

      else

         MsgStop( "Artículo no encontrado" )
         Return .F.

      end

   end

Return .T.






STATIC FUNCTION RecalculaLinea( aTmp, aTmpSat, nDec, oTotal, oMargen, cCodDiv, lTotal )

   local nCalculo
   local nUnidades
   local nMargen
   local nCosto
   local nRentabilidad
   local nBase    := 0

   If( lTotal == nil, lTotal := .F., ) ;

   nUnidades      := nTotNSatCli( aTmp )

   if aTmp[ 68 ]
      nCalculo    := aTmp[ 67  ]
   else
      nCalculo    := aTmp[ 11  ]
   end

   nCalculo       -= aTmp[ 30  ]





   if !aTmp[ 37 ]

      if aTmp[ 79 ]
         nCalculo += aTmp[ 39 ] * NotCero( aTmp[ 63 ] )
      else
         nCalculo += aTmp[ 39 ]
      end

   end

   nCalculo       *= nUnidades





   if aTmp[ 13 ] <> 0
      nCalculo    += aTmp[ 13 ] * nUnidades
   end





   IF aTmp[ 14    ] <> 0
      nCalculo    -= nCalculo * aTmp[ 14    ] / 100
   end

   IF aTmp[ 15 ] <> 0
      nCalculo    -= nCalculo * aTmp[ 15 ] / 100
   end





   nCosto            := nUnidades * aTmp[ 34 ]

   if aTmp[ 37 ] .AND. aTmp[ 6 ] <> 0
      nBase          := nCalculo - Round( nCalculo / ( 100 / aTmp[ 6 ] + 1 ), nRouDiv )
   else
      nBase          := nCalculo
   end

   nMargen           := nBase - nCosto

   if nCalculo == 0
      nRentabilidad  := 0
   else
      nRentabilidad  := nRentabilidad( nCalculo, 0, nCosto )
   end





   if aTmpSat[ 80 ] .AND. aTmp[ 12 ] <> 0
      nCalculo    += aTmp[ 12  ] * nUnidades
   end

   nCalculo       := Round( nCalculo, nDec )

   if !Empty( oTotal )
      oTotal:cText( nCalculo )
   end

   if oMargen <> nil
      oMargen:cText( AllTrim( Trans( nMargen, cPorDiv ) + Space( 1 ) + AllTrim( cSimDiv( cCodDiv, dbfDiv ) ) + " : " + AllTrim( Trans( nRentabilidad, "999.99" ) ) + "%" ) )
   end

   if !Empty( oComisionLinea )
      oComisionLinea:cText( Round( ( nMargen * aTmp[ 16 ] / 100 ), nRouDiv ) )
   end

return if( !lTotal, .T., nCalculo )



STATIC FUNCTION nTotLAgeSat( dbfDetalle )

   local nCalculo := ( dbfDetalle )->nPreDiv * (dbfDetalle)->nUniCaja

   IF lCalCaj()
      nCalculo    *= If( ( dbfDetalle )->nCanSat <> 0, ( dbfDetalle )->nCanSat, 1 )
   end

   nCalculo       := Round( nCalculo * ( dbfDetalle )->nComAge / 100, 0 )

RETURN ( nCalculo )







STATIC FUNCTION nTotLNumArt( dbfDetalle )

   local nCalculo := 0

   IF lCalCaj() .AND. (dbfDetalle)->NCANSAT <> 0 .AND. (dbfDetalle)->NPreDiv <> 0
      nCalculo := (dbfDetalle)->NCANSAT
   end

RETURN ( nCalculo )



STATIC FUNCTION BeginTrans( aTmp, nMode )

   local lErrors  := .F.
   local cDbfLin  := "PCliL"
   local cDbfInc  := "PCliI"
   local cDbfDoc  := "PCliD"
   local cDbfSer  := "SCliS"
   local cSat     := aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ]
   local oError
   local oBlock

   oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   cTmpLin        := cGetNewFileName( cPatTmp() + cDbfLin )
   cTmpInc        := cGetNewFileName( cPatTmp() + cDbfInc )
   cTmpDoc        := cGetNewFileName( cPatTmp() + cDbfDoc )
   cTmpSer        := cGetNewFileName( cPatTmp() + cDbfSer )





   dbCreate( cTmpInc, aSqlStruct( aIncSatCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpInc, cCheckArea( cDbfInc, @dbfTmpInc ), .F. )

   if !NetErr()
      ( dbfTmpInc )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
      ( dbfTmpInc )->( OrdCreate( cTmpInc, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
   else
      lErrors     := .T.
   end

   dbCreate( cTmpDoc, aSqlStruct( aSatCliDoc() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpDoc, cCheckArea( cDbfDoc, @dbfTmpDoc ), .F. )

   if !NetErr()
      ( dbfTmpDoc )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
      ( dbfTmpDoc )->( OrdCreate( cTmpDoc, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
   else
      lErrors     := .T.
   end

   dbCreate( cTmpLin, aSqlStruct( aColSatCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cTmpLin, cCheckArea( cDbfLin, @dbfTmpLin ), .F. )

   if !NetErr()

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "nNumLin", "Str( nNumLin, 4 )", {|| Str( Field->nNumLin ) } ) )

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted()} ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )

      ( dbfTmpLin )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpLin )->( OrdCreate( cTmpLin, "nPosPrint", "Str( nPosPrint, 4 )", {|| Str( Field->nPosPrint ) } ) )

   else
      lErrors     := .T.
   end





   if ( D():SatClientesLineas( nView ) )->( dbSeek( cSat ) )

      while ( D():SatClientesLineasId( nView ) == cSat .AND. !( D():SatClientesLineas( nView ) )->( eof() ) )

         dbPass( D():SatClientesLineas( nView ), dbfTmpLin, .T. )
         ( D():SatClientesLineas( nView ) )->( dbSkip() )

      end

   end

   ( dbfTmpLin )->( dbGoTop() )





   if ( nMode <> 4 ) .AND. ( dbfSatCliI )->( dbSeek( cSat ) )

      while ( ( dbfSatCliI )->cSerSat + Str( ( dbfSatCliI )->NNUMSAT ) + ( dbfSatCliI )->CSUFSAT == cSat .AND. !( dbfSatCliI )->( eof() ) )

         dbPass( dbfSatCliI, dbfTmpInc, .T. )
         ( dbfSatCliI )->( DbSkip() )

      end

   end

   ( dbfTmpInc )->( dbGoTop() )





   if ( nMode <> 4 ) .AND. ( dbfSatCliD )->( dbSeek( cSat ) )

      while ( ( dbfSatCliD )->cSerSat + Str( ( dbfSatCliD )->NNUMSAT ) + ( dbfSatCliD )->CSUFSAT == cSat .AND. !( dbfSatCliD )->( eof() ) )

         dbPass( dbfSatCliD, dbfTmpDoc, .T. )
         ( dbfSatCliD )->( dbSkip() )

      end

   end

   ( dbfTmpDoc )->( dbGoTop() )





   dbCreate( cTmpSer, aSqlStruct( aSerSatCli() ), cLocalDriver() )

   dbUseArea( .T., cLocalDriver(), cTmpSer, cCheckArea( cDbfSer, @dbfTmpSer ), .F. )

   if !( dbfTmpSer )->( NetErr() )

      ( dbfTmpSer )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmpSer )->( OrdCreate( cTmpSer, "nNumLin", "Str( nNumLin, 4 ) + cRef", {|| Str( Field->nNumLin, 4 ) + Field->cRef } ) )

      if ( nMode <> 4 ) .AND. ( dbfSatCliS )->( dbSeek( cSat ) )

         while ( ( dbfSatCliS )->cSerSat + Str( ( dbfSatCliS )->nNumSat ) + ( dbfSatCliS )->cSufSat == cSat ) .AND. !( dbfSatCliS )->( eof() )

            dbPass( dbfSatCliS, dbfTmpSer, .T. )

            ( dbfSatCliS )->( dbSkip() )

         end

      end

      ( dbfTmpSer )->( dbGoTop() )

   else
      lErrors     := .T.
   end

   oDetCamposExtra:SetTemporal( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "", nMode )

   RECOVER USING oError

      msgStop( "Imposible crear tablas temporales" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      KillTrans()

      lErrors     := .T.

   end

   ErrorBlock( oBlock )

RETURN ( lErrors )



STATIC FUNCTION EndTrans( aTmp, aGet, nMode, oBrwLin, oBrw, oBrwInc, oDlg )

   local aTabla
   local oError
   local oBlock
   local cSerSat
   local nNumSat
   local cSufSat
   local dFecSat
   local cCodCli
   local cCodEst
   local nOrdAnt
   local lResultBeforeEndEvent := .T.

   if Empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end

   cSerSat              := aTmp[ 1 ]
   nNumSat              := aTmp[ 2 ]
   cSufSat              := aTmp[ 3 ]
   cCodCli              := aTmp[ 6 ]
   dFecSat              := aTmp[ 5 ]
   cCodEst              := aTmp[ 87 ]





   if !lValidaOperacion( aTmp[ 5 ] )
      Return .F.
   end

   if !lValidaSerie( aTmp[ 1 ] )
      return .F.
   end

   if Empty( aTmp[ 6 ] )
      msgStop( "Cliente no puede estar vacío." )
      aGet[ 6 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 17 ] )
      msgStop( "Almacén no puede estar vacío." )
      aGet[ 17 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 18 ] )
      msgStop( "Caja no puede estar vacía." )
      aGet[ 18 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 46 ] )
      MsgStop( "No puede almacenar documento sin código de divisa." )
      aGet[ 46 ]:SetFocus()
      return .F.
   end

   if Empty( aTmp[ 14 ] ) .AND. lRecogerAgentes()
      msgStop( "Agente no puede estar vacio." )
      aGet[ 14 ]:SetFocus()
      return .F.
   end

   if ( dbfTmpLin )->( eof() )
      MsgStop( "No puede almacenar un documento sin lineas." )
      return .F.
   end

   lResultBeforeEndEvent   := runEventScript( "SatClientes\beforeEndTrans", aGet, aTmp, nView, dbfTmpLin, nMode )

   if IsLogic( lResultBeforeEndEvent ) .AND. !lResultBeforeEndEvent
      Return .F.
   end

   oDlg:Disable()

   oMsgText( "Archivando" )

   oBlock      := ErrorBlock( { | oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE



   if ( cOldSituacion <> aTmp[ 61 ] )
      ( dbfTmpInc )->( dbAppend() )
      ( dbfTmpInc )->dFecInc     := GetSysDate()
      ( dbfTmpInc )->mDesInc     := "Cambio de estado de " + AllTrim( cOldSituacion ) + " a " + Alltrim( aTmp[ 61 ] ) + "."
   end



   ( dbfTmpLin )->( dbClearFilter() )



   aTmp[ 59 ]        := Date()
   aTmp[ 60 ]        := Time()
   aTmp[ 28 ]        := oGetTarifa:getTarifa()

   if isAppendOrDuplicateMode( nMode )
      nNumSat              := nNewDoc( cSerSat, D():SatClientes( nView ), "nSatCli", , D():Contadores( nView ) )
      aTmp[ 2 ]     := nNumSat
      cSufSat              := retSufEmp()
      aTmp[ 3 ]     := cSufSat
   end



   begintransaction()



   if isEditMode( nMode )

      while ( D():SatClientesLineas( nView ) )->( dbSeek( cSerSat + str( nNumSat ) + cSufSat ) )
         if dbLock( D():SatClientesLineas( nView ) )
            ( D():SatClientesLineas( nView ) )->( dbDelete() )
            ( D():SatClientesLineas( nView ) )->( dbUnLock() )
         end
         ( D():SatClientesLineas( nView ) )->( dbSkip() )
      end

      while ( dbfSatCliI )->( dbSeek( cSerSat + str( nNumSat ) + cSufSat ) )
         if dbLock( dbfSatCliI )
            ( dbfSatCliI )->( dbDelete() )
            ( dbfSatCliI )->( dbUnLock() )
         end
      end

      while ( dbfSatCliD )->( dbSeek( cSerSat + str( nNumSat ) + cSufSat ) )
         if dbLock( dbfSatCliD )
            ( dbfSatCliD )->( dbDelete() )
            ( dbfSatCliD )->( dbUnLock() )
         end
      end

      while ( dbfSatCliS )->( dbSeek( cSerSat + str( nNumSat ) + cSufSat ) )
         if dbLock( dbfSatCliS )
            ( dbfSatCliS )->( dbDelete() )
            ( dbfSatCliS )->( dbUnLock() )
         end
      end

   end

   oMsgProgress()
   oMsgProgress():SetRange( 0, ( dbfTmpLin )->( LastRec() ) )





   ( dbfTmpLin )->( dbGoTop() )
   while !( dbfTmpLin )->( Eof() )

      ( dbfTmpLin )->dFecSat     := dFecSat
      ( dbfTmpLin )->dFecha      := dFecSat
      ( dbfTmpLin )->cCodCli     := cCodCli
      ( dbfTmpLin )->nRegIva     := aTmp[ 51 ]

      if isEditMode( nMode ) .AND. ( dbfTmpLin )->nCtlstk == 2

         if ( D():Articulos( nView ) )->( dbSeek( ( dbfTmpLin )->cRef ) )

            if dbLock( D():Articulos( nView ) )
               ( D():Articulos( nView ) )->cCodEst    := aTmp[ 87 ]
               ( D():Articulos( nView ) )->( dbUnLock() )
            end

         end

      end

      dbPass( dbfTmpLin, D():SatClientesLineas( nView ), .T., cSerSat, nNumSat, cSufSat )

      ( dbfTmpLin )->( dbSkip() )

      oMsgProgress():Deltapos(1)

   end





   ( dbfTmpInc )->( dbGoTop() )
   while !( dbfTmpInc )->( Eof() )
      dbPass( dbfTmpInc, dbfSatCliI, .T., cSerSat, nNumSat, cSufSat )
      ( dbfTmpInc )->( dbSkip() )
   end





   ( dbfTmpDoc )->( dbGoTop() )
   while !( dbfTmpDoc )->( Eof() )
      dbPass( dbfTmpDoc, dbfSatCliD, .T., cSerSat, nNumSat, cSufSat )
      ( dbfTmpDoc )->( dbSkip() )
   end





   ( dbfTmpSer )->( dbGoTop() )
   while ( dbfTmpSer )->( !eof() )
      dbPass( dbfTmpSer, dbfSatCliS, .T., cSerSat, nNumSat, cSufSat, dFecSat )
      ( dbfTmpSer )->( dbSkip() )
   end





   aTmp[ 76 ]     := nTotNet
   aTmp[ 77 ]     := nTotIva
   aTmp[ 78 ]     := nTotReq
   aTmp[ 79 ]     := nTotSat





   oDetCamposExtra:saveExtraField( aTmp[ 1 ] + Str( aTmp[ 2 ] ) + aTmp[ 3 ], "" )

   WinGather( aTmp, , D():SatClientes( nView ), , nMode )





   if uFieldempresa( "lAddAtp" )

      ( dbfTmpLin )->( dbGoTop() )

      while !( dbfTmpLin )->( Eof() )

         if !Empty( ( dbfTmpLin )->cRef )




            AtipicasModel():AddArticulo( {   "cCodCli"   => cCodCli, "cCodArt"   => ( dbfTmpLin )->cRef, "cNomArt"   => ( dbfTmpLin )->cDetalle, "nPreUnit"  => ( dbfTmpLin )->nPreDiv } )

         end

         ( dbfTmpLin )->( dbSkip() )

      end

      ( dbfTmpLin )->( dbGoTop() )

   end







   if nMode == 2

      nOrdAnt := ( D():SatClientes( nView ) )->( OrdSetFocus( "cNumDes" ) )

      ( D():SatClientes( nView ) )->( dbGoTop() )


      if ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat == cSerSat + Str( nNumSat ) + cSufSat .AND. ( D():SatClientes( nView ) )->dFecSat  == dFecSat

         if ( D():SatClientesLineas( nView ) )->( dbSeek( cSerSat + Str( nNumSat ) + cSufSat ) )

            while ( D():SatClientesLineas( nView ) )->cSerSat + Str( ( D():SatClientesLineas( nView ) )->nNumSat ) + ( D():SatClientesLineas( nView ) )->cSufSat == cSerSat + Str( nNumSat ) + cSufSat .AND. !( D():SatClientesLineas( nView ) )->( Eof() )

               if ( D():Articulos( nView ) )->( dbSeek( ( D():SatClientesLineas( nView ) )->cRef ) )

                  if dbLock( D():Articulos( nView ) )
                     ( D():Articulos( nView ) )->cCodEst    := cCodEst
                     ( D():Articulos( nView ) )->( dbUnLock() )
                  end

               end

               ( D():SatClientesLineas( nView ) )->( dbSkip() )

            end

         end

      end

      ( D():SatClientes( nView ) )->( OrdSetFocus( nOrdAnt ) )

   end



   commitTransaction()

   oMsgText( "Finalizamos la transacción" )

   RECOVER USING oError

      rollBackTransaction()

      msgStop( "Imposible almacenar documento" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

   oMsgProgress()
   oMsgText()

   endProgress()

   oDlg:Enable()
   oDlg:End( 1 )

Return .T.



Static Function KillTrans( oBrwLin )





   if !Empty( dbfTmpLin ) .AND. ( dbfTmpLin )->( Used() )
      ( dbfTmpLin )->( dbCloseArea() )
   end

   if !Empty( dbfTmpInc ) .AND. ( dbfTmpInc )->( Used() )
      ( dbfTmpInc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpDoc ) .AND. ( dbfTmpDoc )->( Used() )
      ( dbfTmpDoc )->( dbCloseArea() )
   end

   if !Empty( dbfTmpSer ) .AND. ( dbfTmpSer )->( Used() )
      ( dbfTmpSer )->( dbCloseArea() )
   end

   dbfErase( cTmpLin )
   dbfErase( cTmpInc )
   dbfErase( cTmpDoc )
   dbfErase( cTmpSer )

Return .T.



STATIC FUNCTION LoaCli( aGet, aTmp, nMode, oRieCli, oTlfCli )

   local lValid      := .T.
   local cNewCodCli  := aGet[ 6 ]:VarGet()
   local lChgCodCli  := ( Empty( cOldCodCli ) .OR. cOldCodCli <> cNewCodCli )

   if Empty( cNewCodCli )
      return .T.
   elseif At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[ 6 ], "0", RetNumCodCliEmp() )
   else
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodCliEmp() )
   end

   if ( D():Clientes( nView ) )->( dbSeek( cNewCodCli ) )

      if !( isAviableClient( nView, nMode ) )
         return .F.
      end

      if oTlfCli <> nil
         oTlfCli:SetText( ( D():Clientes( nView ) )->Telefono )
      end





      aGet[ 6 ]:cText( ( D():Clientes( nView ) )->Cod )





      if ( D():Clientes( nView ) )->nColor <> 0
         aGet[ 7 ]:SetColor( , ( D():Clientes( nView ) )->nColor )
      end

      if Empty( aGet[ 7 ]:varGet() ) .OR. lChgCodCli
         aGet[ 7 ]:cText( ( D():Clientes( nView ) )->Titulo )
      end

      if Empty( aGet[ 75 ]:varGet() ) .OR. lChgCodCli
         aGet[ 75 ]:cText( ( D():Clientes( nView ) )->Telefono )
      end

      if !Empty( aGet[ 8 ] ) .AND. ( Empty( aGet[ 8 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 8 ]:cText( ( D():Clientes( nView ) )->Domicilio )
      end

      if !Empty( aGet[ 9 ] ) .AND. ( Empty( aGet[ 9 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 9 ]:cText( ( D():Clientes( nView ) )->Poblacion )
      end

      if !Empty( aGet[ 10 ] ) .AND. ( Empty( aGet[ 10 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 10 ]:cText( ( D():Clientes( nView ) )->Provincia )
      end

      if !Empty( aGet[ 11 ] ) .AND. ( Empty( aGet[ 11 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 11 ]:cText( ( D():Clientes( nView ) )->CodPostal )
      end

      if !Empty( aGet[12] ) .AND. ( Empty( aGet[ 12 ]:varGet() ) .OR. lChgCodCli )
         aGet[ 12 ]:cText( ( D():Clientes( nView ) )->Nif )
      end

      if ( Empty( aTmp[63] ) .OR. lChgCodCli )
         aTmp[ 63 ]  := ( D():Clientes( nView ) )->cCodGrp
      end





      if ( lChgCodCli ) .AND. !Empty( aGet[ 15 ] )

         if dbSeekInOrd( cNewCodCli, "lDefObr", dbfObrasT )
            aGet[ 15 ]:cText( ( dbfObrasT )->cCodObr )
         else
            aGet[ 15 ]:cText( Space( 10 ) )
         end

         aGet[ 15 ]:lValid()

      end

      if ( lChgCodCli )





         if oRieCli <> nil
            oStock:SetRiesgo( cNewCodCli, oRieCli, ( D():Clientes( nView ) )->Riesgo )
         end

         aTmp[ 13 ]  := ( D():Clientes( nView ) )->lModDat

      end

      if ( lChgCodCli )
         aTmp[ 80 ]  := ( D():Clientes( nView ) )->lPntVer
      end

      if nMode == 1

         aTmp[ 51 ]   := ( D():Clientes( nView ) )->nRegIva

         lChangeRegIva( aTmp )





         if Empty( aTmp[ 1 ] )

            if !Empty( ( D():Clientes( nView ) )->Serie )
               aGet[ 1 ]:cText( ( D():Clientes( nView ) )->Serie )
            end

         else

            if !Empty( ( D():Clientes( nView ) )->Serie ) .AND. aTmp[ 1 ] <> ( D():Clientes( nView ) )->Serie .AND. ApoloMsgNoYes( "La serie del cliente seleccionado es distinta a la anterior.", "¿Desea cambiar la serie?" )
               aGet[ 1 ]:cText( ( D():Clientes( nView ) )->Serie )
            end

         end

         if !Empty( aGet[ 17 ] )
            if ( Empty( aGet[ 17 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cCodAlm )
               aGet[ 17 ]:cText( ( D():Clientes( nView ) )->cCodAlm )
               aGet[ 17 ]:lValid()
            end
         end

         if aGet[ 16 ] <> nil
            if !Empty( aGet[ 16 ] ) .AND. ( Empty( aGet[ 16 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cCodTar )
               aGet[ 16 ]:cText( ( D():Clientes( nView ) )->cCodTar )
               aGet[ 16 ]:lValid()
            end
         end

         if ( Empty( aGet[ 19 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->CodPago )
            aGet[ 19 ]:cText( (D():Clientes( nView ) )->CodPago )
            aGet[ 19 ]:lValid()
         end

         if aGet[14] <> nil
            if ( Empty( aGet[ 14 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cAgente )
               aGet[ 14 ]:cText( ( D():Clientes( nView ) )->cAgente )
               aGet[ 14 ]:lValid()
            end
         end

         if ( Empty( aGet[ 20 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cCodRut )
            aGet[ 20 ]:cText( ( D():Clientes( nView ) )->cCodRut )
            aGet[ 20 ]:lValid()
         end

         if !empty( oGetTarifa )
            if ( empty( oGetTarifa:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( D():Clientes( nView ) )->nTarifa )
               oGetTarifa:setTarifa( ( D():Clientes( nView ) )->nTarifa )
            end
         else
            aTmp[ 28 ]  := ( D():Clientes( nView ) )->nTarifa
         end

         if !Empty( aGet[ 55 ] ) .AND. ( Empty( aGet[ 55 ]:varGet() ) .OR. lChgCodCli ) .AND. !Empty( ( D():Clientes( nView ) )->cCodTrn )
            aGet[ 55 ]:cText( ( D():Clientes( nView ) )->cCodTrn )
            aGet[ 55 ]:lValid()
         end

         if lChgCodCli

            aGet[ 42 ]:Click( ( D():Clientes( nView ) )->lReq ):Refresh()

            aGet[ 80 ]:Click( ( D():Clientes( nView ) )->lPntVer ):Refresh()

            if ( D():Clientes( nView ) )->lMosCom .AND. !Empty( ( D():Clientes( nView ) )->mComent ) .AND. lChgCodCli
               MsgStop( Trim( ( D():Clientes( nView ) )->mComent ) )
            end





            if !uFieldempresa( "lDtoCliLin" )
               aGet[ 29 ]:cText( ( D():Clientes( nView ) )->cDtoEsp )
               aGet[ 30 ]:cText( ( D():Clientes( nView ) )->nDtoEsp )
            end

            aGet[ 31    ]:cText( ( D():Clientes( nView ) )->cDpp )

            aGet[ 32    ]:cText( ( D():Clientes( nView ) )->nDpp )

            aGet[ 33 ]:cText( ( D():Clientes( nView ) )->cDtoUno )

            aGet[ 34 ]:cText( ( D():Clientes( nView ) )->nDtoCnt )

            aGet[ 35 ]:cText( ( D():Clientes( nView ) )->cDtoDos )

            aGet[ 36 ]:cText( ( D():Clientes( nView ) )->nDtoRap )

            aTmp[ 68 ]  := ( D():Clientes( nView ) )->nDtoAtp

            aTmp[ 69 ]  := ( D():Clientes( nView ) )->nSbrAtp

            ShowIncidenciaCliente( ( D():Clientes( nView ) )->Cod, nView )

         end

      end

      cOldCodCli  := ( D():Clientes( nView ) )->Cod

      lValid      := .T.

   ELSE

      msgStop( "Cliente no encontrado", "Cadena buscada : " + cNewCodCli )
      lValid      := .T.

   end

RETURN lValid



STATIC FUNCTION CreateFiles( cPath )

   if !lExistTable( cPath + "SatCliT.Dbf", cLocalDriver() )
      dbCreate( cPath + "SatCliT.Dbf", aSqlStruct( aItmSatCli() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "SatCliL.Dbf", cLocalDriver() )
      dbCreate( cPath + "SatCliL.Dbf", aSqlStruct( aColSatCli() ),  cLocalDriver() )
   end

   if !lExistTable( cPath + "SatCliI.Dbf", cLocalDriver() )
      dbCreate( cPath + "SatCliI.Dbf", aSqlStruct( aIncSatCli() ),  cLocalDriver() )
   end

   if !lExistTable( cPath + "SatCliD.Dbf", cLocalDriver() )
      dbCreate( cPath + "SatCliD.Dbf", aSqlStruct( aSatCliDoc() ),  cLocalDriver() )
   end

   if !lExistTable( cPath + "SatCliS.Dbf", cLocalDriver() )
      dbCreate( cPath + "SatCliS.Dbf", aSqlStruct( aSerSatCli() ),  cLocalDriver() )
   end

RETURN NIL



STATIC FUNCTION ChgState( oBrw )

   local nRec

   for each nRec in ( oBrw:aSelected )

      ( D():SatClientes( nView ) )->( dbGoTo( nRec ) )

      if dbLock( D():SatClientes( nView ) )
         ( D():SatClientes( nView ) )->lEstado := !( D():SatClientes( nView ) )->lEstado
         ( D():SatClientes( nView ) )->( dbRUnlock() )
      end

   next

   oBrw:Refresh()
   oBrw:SetFocus()

RETURN NIL






STATIC FUNCTION lMoreIva( nCodIva )





   IF aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 3, 3 ] == nil
      RETURN .T.
   end

   IF aTotIva[ 1, 3 ] == nCodIva .OR. aTotIva[ 2, 3 ] == nCodIva .OR. aTotIva[ 3, 3 ] == nCodIva
      RETURN .T.
   end

   MsgStop( "Documento con mas de 3 Tipos de " + cImp() )

RETURN .F.



static function lGenSatCli( oBrw, oBtn, nDevice )

   local bAction

   If( nDevice == nil, nDevice := 1, ) ;

   if Empty( oBtn )
      return nil
   end

   IF !( dbfDoc )->( dbSeek( "SC" ) )








         oWndBrw:NewAt( "GC_DOCUMENT_WHITE_",,, {||( msgStop( "No hay pedidos de proveedores predefinidos" ) )}, "No hay documentos", "N",,, 4, oBtn, .F. )

   ELSE

      WHILE ( dbfDoc )->CTIPO == "SC" .AND. !( dbfDoc )->( eof() )

         bAction  := bGenSatCli( nDevice, "Imprimiendo S.A.T. a clientes", ( dbfDoc )->CODIGO )

         oWndBrw:NewAt( "gc_document_white_", , , bAction, Rtrim( ( dbfDoc )->cDescrip ) , , , , , oBtn )

         ( dbfDoc )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenSatCli( nDevice, cTitle, cCodDoc )

   local bGen
   local nDev  := by( nDevice )
   local cTit  := by( cTitle    )
   local cCod  := by( cCodDoc   )

   if nDev == 1
      bGen     := {|| nGenSatCli( nDev, cTit, cCod ) }
   else
      bGen     := {|| GenSatCli( nDev, cTit, cCod ) }
   end

return ( bGen )



static function nGenSatCli( nDevice, cTitle, cCodDoc, cPrinter, nCopy )

   local nImpYet     := 1
   local nCopyClient := Retfld( ( D():SatClientes( nView ) )->cCodCli, D():Clientes( nView ), "CopiasF" )

   If( nDevice == nil, nDevice := 1, ) ;
   If( nCopy == nil, nCopy := Max( nCopyClient, nCopiasDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Contadores( nView ) ) ), ) ;

   nCopy             := Max( nCopy, 1 )

   while nImpYet <= nCopy
      GenSatCli( nDevice, cTitle, cCodDoc, cPrinter )
      nImpYet++
   end


   lChgImpDoc( D():SatClientes( nView ) )

return nil



STATIC FUNCTION nClrPane( dbfTmpLin )

   local cClr

   if ( dbfTmpLin )->lControl .OR. ( dbfTmpLin )->lTotLin
      cClr     := 14197607
   else
      cClr     := 16777215
   end

return cClr



STATIC FUNCTION nClrText( dbfTmpLin )

   local cClr

   if ( dbfTmpLin )->lKitChl
      cClr     := 8421504
   else
      cClr     := 0
   end

return cClr



STATIC FUNCTION RecSatCli( aTmpSat )

   local nDtoAge
   local nImpAtp           := 0
   local nImporteTarifa    := 0
   local nRecno
   local cCodFam
   local hAtipica
   local sOfertaArticulo




   if !apoloMsgNoYes(      "¡Atención!,"                                      + Chr(13)+Chr(10) +  "todos los precios se recalcularán en función de"  + Chr(13)+Chr(10) +  "los valores en las bases de datos.", "¿Desea proceder?" )
      return nil
   end

   nRecno                  := ( dbfTmpLin )->( RecNo() )

   ( dbfTmpLin )->( dbGotop() )

   ( D():Articulos( nView ) )->( ordSetFocus( "Codigo" ) )
   while !( dbfTmpLin )->( eof() )





      if ( D():Articulos( nView ) )->( dbSeek( ( dbfTmpLin )->cRef ) )

         if aTmpSat[ 51 ] <= 2
            ( dbfTmpLin )->nIva     := nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva )
            ( dbfTmpLin )->nReq     := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )
         end





         if !Empty( ( D():Articulos( nView ) )->cCodImp )
            ( dbfTmpLin )->cCodImp  := ( D():Articulos( nView ) )->cCodImp
            ( dbfTmpLin )->nValImp  := oNewImp:nValImp( ( D():Articulos( nView ) )->cCodImp, aTmpSat[ 52 ], ( dbfTmpLin )->nIva )
         end





         ( dbfTmpLin )->nPreDiv     := nRetPreArt( ( dbfTmpLin )->nTarLin, aTmpSat[ 46 ], aTmpSat[ 52 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )





         ( dbfTmpLin )->nCtlStk     := ( D():Articulos( nView ) )->nCtlStock
         ( dbfTmpLin )->nCosDiv     := nCosto( nil, D():Articulos( nView ), dbfKit )





         ( dbfTmpLin )->nPntVer     := ( D():Articulos( nView ) )->nPntVer1





         do case





         case !Empty( aTmpSat[ 16 ] )

            cCodFam  := ( dbfTmpLin )->cCodFam

            nImporteTarifa  := RetPrcTar( ( dbfTmpLin )->cRef, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL, ( dbfTmpLin )->nTarLin )
            if nImporteTarifa <> 0
               ( dbfTmpLin )->nPreDiv  := nImporteTarifa
            end

            nImporteTarifa  := RetPctTar( ( dbfTmpLin )->cRef, cCodFam, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL )
            if nImporteTarifa <> 0
               ( dbfTmpLin )->nDto     := nImporteTarifa
            end

            nImporteTarifa  := RetComTar( ( dbfTmpLin )->cRef, cCodFam, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpSat[ 14 ], dbfTarPreL, dbfTarPreS )
            if nImporteTarifa <> 0
               ( dbfTmpLin )->nComAge  := nImporteTarifa
            end





            nImporteTarifa  := RetDtoPrm( ( dbfTmpLin )->cRef, cCodFam, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpSat[ 5 ], dbfTarPreL )
            if nImporteTarifa <> 0
               ( dbfTmpLin )->nDtoPrm  := nImporteTarifa
            end





            nDtoAge  := RetDtoAge( ( dbfTmpLin )->cRef, cCodFam, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpSat[ 5 ], aTmpSat[ 14 ], dbfTarPreL, dbfTarPreS )
            if nDtoAge <> 0
               ( dbfTmpLin )->nComAge  := nDtoAge
            end





         case !Empty( aTmpSat[ 16 ] )

            cCodFam  := ( dbfTmpLin )->cCodFam

            nImporteTarifa  := RetPrcTar( ( dbfTmpLin )->cRef, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL, ( dbfTmpLin )->nTarLin )
            if nImporteTarifa <> 0
               ( dbfTmpLin )->nPreDiv  := nImporteTarifa
            end

            nImporteTarifa  := RetPctTar( ( dbfTmpLin )->cRef, cCodFam, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, dbfTarPreL )
            if nImporteTarifa <> 0
               ( dbfTmpLin )->nDto     := nImporteTarifa
            end

            nImporteTarifa  := RetComTar( ( dbfTmpLin )->cRef, cCodFam, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpSat[ 14 ], dbfTarPreL, dbfTarPreS )
            if nImporteTarifa <> 0
               ( dbfTmpLin )->nComAge  := nImporteTarifa
            end





            nImporteTarifa  := RetDtoPrm( ( dbfTmpLin )->cRef, cCodFam, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpSat[ 5 ], dbfTarPreL )
            if nImporteTarifa <> 0
               ( dbfTmpLin )->nDtoPrm  := nImporteTarifa
            end





            nDtoAge  := RetDtoAge( ( dbfTmpLin )->cRef, cCodFam, aTmpSat[ 16 ], ( dbfTmpLin )->cCodPr1, ( dbfTmpLin )->cCodPr2, ( dbfTmpLin )->cValPr1, ( dbfTmpLin )->cValPr2, aTmpSat[ 5 ], aTmpSat[ 14 ], dbfTarPreL, dbfTarPreS )
            if nDtoAge <> 0
               ( dbfTmpLin )->nComAge  := nDtoAge
            end

         end





         hAtipica := hAtipica( hValue( dbfTmpLin, aTmpSat ) )

         if !Empty( hAtipica )

            if hhaskey( hAtipica, "nTarifaFamilia" ) .AND. hAtipica[ "nTarifaFamilia" ] > 0
               ( dbfTmpLin )->nPreDiv  := nRetPreArt( hAtipica[ "nTarifaFamilia" ], aTmpSat[ 46 ], aTmpSat[ 52 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
            end

            if hhaskey( hAtipica, "nImporte" ) .AND. hAtipica[ "nImporte" ] <> 0
               ( dbfTmpLin )->nPreDiv  := hAtipica[ "nImporte" ]
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" ) .AND. hAtipica[ "nDescuentoPorcentual" ] <> 0
               ( dbfTmpLin )->nDto     := hAtipica[ "nDescuentoPorcentual" ]
            end

            if hhaskey( hAtipica, "nDescuentoPromocional" ) .AND. hAtipica[ "nDescuentoPromocional" ] <> 0
               ( dbfTmpLin )->nDtoPrm  := hAtipica[ "nDescuentoPromocional" ]
            end

            if hhaskey( hAtipica, "nDescuentoLineal" ) .AND. hAtipica[ "nDescuentoLineal" ] <> 0
               ( dbfTmpLin )->nDtoDiv  := hAtipica[ "nDescuentoLineal" ]
            end

            if hhaskey( hAtipica, "nComisionAgente" ) .AND. hAtipica[ "nComisionAgente" ] <> 0
               ( dbfTmpLin )->nComAge  := hAtipica[ "nComisionAgente" ]
            end

         end



         sOfertaArticulo   := structOfertaArticulo( D():getHashArray( aTmpSat, "SatCliT", nView ), D():getHashTable( dbfTmpLin, "SatCliL", nView ), nTotLSatCli( dbfTmpLin ), nView )

         if !empty( sOfertaArticulo )

            if ( sOfertaArticulo:nPrecio <> 0 )
               ( dbfTmpLin )->nPreDiv  := sOfertaArticulo:nPrecio
            end

            if ( sOfertaArticulo:nDtoPorcentual <> 0 )
               ( dbfTmpLin )->nDto     := sOfertaArticulo:nDtoPorcentual
            end

            if ( sOfertaArticulo:nDtoLineal <> 0 )
               ( dbfTmpLin )->nDtoDiv  := sOfertaArticulo:nDtoLineal
            end

            ( dbfTmpLin )->lLinOfe     := sOfertaArticulo:isImporte()

         end

      end

      ( dbfTmpLin )->( dbSkip() )

   end

   ( dbfTmpLin )->( dbGoTo( nRecno ) )

return nil



Static Function nEstadoIncidencia( cNumSat )

   local nEstado  := 0

   if ( dbfSatCliI )->( dbSeek( cNumSat ) )

      while ( dbfSatCliI )->cSerSat + Str( ( dbfSatCliI )->nNumSat ) + ( dbfSatCliI )->cSufSat == cNumSat .AND. !( dbfSatCliI )->( Eof() )

         if ( dbfSatCliI )->lListo
            do case
               case nEstado == 0 .OR. nEstado == 3
                    nEstado := 3
               case nEstado == 1
                    nEstado := 2
            end
         else
            do case
               case nEstado == 0
                    nEstado := 1
               case nEstado == 3
                    nEstado := 2
            end
         end

         ( dbfSatCliI )->( dbSkip() )

      end

   end

Return ( nEstado )



Static Function SatCliNotas()

   local cObserv  := ""
   local aData    := {}

   aAdd( aData, "S.A.T. " + ( D():SatClientes( nView ) )->cSerSat + "/" + AllTrim( Str( ( D():SatClientes( nView ) )->nNumSat ) ) + "/" + Alltrim( ( D():SatClientes( nView ) )->cSufSat ) + " de " + Rtrim( ( D():SatClientes( nView ) )->cNomCli ) )
   aAdd( aData, "32" )
   aAdd( aData, ( D():SatClientes( nView ) )->cCodCli )
   aAdd( aData, ( D():SatClientes( nView ) )->cNomCli )
   aAdd( aData, ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat )

   if !Empty( ( D():SatClientes( nView ) )->cRetPor )
      cObserv     += Rtrim( ( D():SatClientes( nView ) )->cRetPor ) + Space( 1 )
   end

   if !Empty( ( D():SatClientes( nView ) )->cRetMat )
      cObserv     += Rtrim( ( D():SatClientes( nView ) )->cRetMat ) + Space( 1 )
   end

   aAdd( aData, cObserv )

   GenerarNotas( aData )

Return ( nil )



Static Function AppendKit( uTmpLin, aTmpSat )

   local cCodArt
   local cSerSat
   local nNumSat
   local cSufSat
   local nCanSat
   local dFecSat
   local cAlmLin
   local nIvaLin
   local lIvaLin
   local nComAge
   local nUniCaj
   local nDtoGrl
   local nDtoPrm
   local nDtoDiv
   local nNumLin
   local nPosPrint
   local nTarLin
   local nRecAct                       := ( dbfKit )->( Recno() )
   local nUnidades                     := 0
   local nStkActual                    := 0
   local nStockMinimo                  := 0

   if ValType( uTmpLin ) == "A"
      cCodArt                          := uTmpLin[ 4    ]
      cSerSat                          := uTmpLin[ 1 ]
      nNumSat                          := uTmpLin[ 2 ]
      cSufSat                          := uTmpLin[ 3 ]
      nCanSat                          := uTmpLin[ 7 ]
      dFecSat                          := uTmpLin[ 21  ]
      cAlmLin                          := uTmpLin[ 36 ]
      nIvaLin                          := uTmpLin[ 6    ]
      lIvaLin                          := uTmpLin[ 37 ]
      nComAge                          := uTmpLin[ 16 ]
      nUniCaj                          := uTmpLin[ 8]
      nDtoGrl                          := uTmpLin[ 14    ]
      nDtoPrm                          := uTmpLin[ 15 ]
      nDtoDiv                          := uTmpLin[ 30 ]
      nNumLin                          := uTmpLin[ 32 ]
      nPosPrint                        := uTmpLin[ 91 ]
      nTarLin                          := uTmpLin[ 73 ]
   else
      cCodArt                          := ( uTmpLin )->cRef
      cSerSat                          := ( uTmpLin )->cSerSat
      nNumSat                          := ( uTmpLin )->nNumSat
      cSufSat                          := ( uTmpLin )->cSufSat
      nCanSat                          := ( uTmpLin )->nCanSat
      dFecSat                          := ( uTmpLin )->dFecha
      cAlmLin                          := ( uTmpLin )->cAlmLin
      nIvaLin                          := ( uTmpLin )->nIva
      lIvaLin                          := ( uTmpLin )->lIvaLin
      nComAge                          := ( uTmpLin )->nComAge
      nUniCaj                          := ( uTmpLin )->nUniCaja
      nDtoGrl                          := ( uTmpLin )->nDto
      nDtoPrm                          := ( uTmpLin )->nDtoPrm
      nDtoDiv                          := ( uTmpLin )->nDtoDiv
      nNumLin                          := ( uTmpLin )->nNumLin
      nPosPrint                        := ( uTmpLin )->nPosPrint
      nTarLin                          := ( uTmpLin )->nTarLin
   end

   if ( dbfKit )->( dbSeek( cCodArt ) )

      while ( dbfKit )->cCodKit == cCodArt .AND. !( dbfKit )->( eof() )

         if ( D():Articulos( nView ) )->( dbSeek( ( dbfKit )->cRefKit ) )

            ( dbfTmpLin )->( dbAppend() )

            ( dbfTmpLin )->nNumLin     := nNumLin
            ( dbfTmpLin )->nPosPrint   := nPosPrint
            ( dbfTmpLin )->lKitChl     := .T.

            ( dbfTmpLin )->cRef        := ( dbfkit      )->cRefKit
            ( dbfTmpLin )->cDetalle    := ( D():Articulos( nView ) )->Nombre
            ( dbfTmpLin )->nPntVer     := ( D():Articulos( nView ) )->nPntVer1
            ( dbfTmpLin )->cUnidad     := ( D():Articulos( nView ) )->cUnidad
            ( dbfTmpLin )->nPesokg     := ( D():Articulos( nView ) )->nPesoKg
            ( dbfTmpLin )->cPesokg     := ( D():Articulos( nView ) )->cUndDim
            ( dbfTmpLin )->nVolumen    := ( D():Articulos( nView ) )->nVolumen
            ( dbfTmpLin )->cVolumen    := ( D():Articulos( nView ) )->cVolumen

            ( dbfTmpLin )->cCodImp     := ( D():Articulos( nView ) )->cCodImp
            ( dbfTmpLin )->lLote       := ( D():Articulos( nView ) )->lLote
            ( dbfTmpLin )->nLote       := ( D():Articulos( nView ) )->nLote
            ( dbfTmpLin )->cLote       := ( D():Articulos( nView ) )->cLote

            ( dbfTmpLin )->nValImp     := oNewImp:nValImp( ( D():Articulos( nView ) )->cCodImp )
            ( dbfTmpLin )->nCosDiv     := nCosto( nil, D():Articulos( nView ), dbfKit )

            if ( D():Articulos( nView ) )->lFacCnv
               ( dbfTmpLin )->nFacCnv  := ( D():Articulos( nView ) )->nFacCnv
            end

            ( dbfTmpLin )->cSerSat     := cSerSat
            ( dbfTmpLin )->nNumSat     := nNumSat
            ( dbfTmpLin )->cSufSat     := cSufSat
            ( dbfTmpLin )->nCanSat     := nCanSat
            ( dbfTmpLin )->dFecha      := dFecSat
            ( dbfTmpLin )->cAlmLin     := cAlmLin
            ( dbfTmpLin )->lIvaLin     := lIvaLin
            ( dbfTmpLin )->nComAge     := nComAge





            ( dbfTmpLin )->lImpLin     := lImprimirComponente( cCodArt, D():Articulos( nView ) )
            ( dbfTmpLin )->lKitPrc     := lPreciosComponentes( cCodArt, D():Articulos( nView ) )





            ( dbfTmpLin )->nUniCaja    := nUniCaj * ( dbfKit )->nUndKit

            if ( dbfTmpLin )->lKitPrc
               ( dbfTmpLin )->nPreDiv  := nRetPreArt( nTarLin, aTmpSat[ 46 ], aTmpSat[ 52 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
            end





            if !Empty( nIvaLin )
               ( dbfTmpLin )->nIva     := nIva( dbfIva, ( D():Articulos( nView ) )->TipoIva )
               ( dbfTmpLin )->nReq     := nReq( dbfIva, ( D():Articulos( nView ) )->TipoIva )
            else
               ( dbfTmpLin )->nIva     := 0
               ( dbfTmpLin )->nReq     := 0
            end

            if lStockComponentes( cCodArt, D():Articulos( nView ) )
               ( dbfTmpLin )->nCtlStk  := ( D():Articulos( nView ) )->nCtlStock
            else
               ( dbfTmpLin )->nCtlstk  := 3
            end





            if ( dbfKit )->lAplDto
               ( dbfTmpLin )->nDto     := nDtoGrl
               ( dbfTmpLin )->nDtoPrm  := nDtoPrm
               ( dbfTmpLin )->nDtoDiv  := nDtoDiv
            end

            if ( D():Articulos( nView ) )->lKitArt
               AppendKit( dbfTmpLin, aTmpSat )
            end





            nStockMinimo      := nStockMinimo( ( dbfKit )->cRefKit, cAlmLin, nView )

            if ( D():Articulos( nView ) )->lMsgVta .AND. !uFieldEmpresa( "lNStkAct" ) .AND. nStockMinimo > 0

               nStkActual     := StocksModel():nStockArticulo( ( dbfKit )->cRefKit, cAlmLin )
               nUnidades      := nUniCaj * ( dbfKit )->nUndKit

               do case
                  case nStkActual - nUnidades < 0



                        MsgStop( "No hay stock suficiente para realizar la venta" + Chr(13)+Chr(10) +  "del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( D():Articulos( nView ) )->Nombre ), "¡Atención!" )

                  case nStkActual - nUnidades < nStockMinimo






                        MsgStop( "El stock del componente " + AllTrim( ( dbfKit )->cRefKit ) + " - " + AllTrim( ( D():Articulos( nView ) )->Nombre ) + Chr(13)+Chr(10) +  "está bajo minimo." + Chr(13)+Chr(10) +  "Unidades a vender : " + AllTrim( Trans( nUnidades, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock minimo : " + AllTrim( Trans( nStockMinimo, MasUnd() ) ) + Chr(13)+Chr(10) +  "Stock actual : " + AllTrim( Trans( nStkActual, MasUnd() ) ), "¡Atención!" )

               end

            end

         end

         ( dbfKit )->( dbSkip() )

      end

   end

   ( dbfKit )->( dbGoTo( nRecAct ) )

Return ( nil )



STATIC FUNCTION DupSerie( oWndBrw )

   local oDlg
   local oSerIni
   local oSerFin
   local oTxtDup
   local nTxtDup     := 0
   local nRecno      := ( D():SatClientes( nView ) )->( Recno() )
   local nOrdAnt     := ( D():SatClientes( nView ) )->( OrdSetFocus( 1 ) )
   local oDesde      := TDesdeHasta():Init( ( D():SatClientes( nView ) )->cSerSat, ( D():SatClientes( nView ) )->nNumSat, ( D():SatClientes( nView ) )->cSufSat, GetSysDate() )
   local lCancel     := .F.
   local oBtnAceptar
   local oBtnCancel
   local oFecDoc
   local cFecDoc     := GetSysDate()




   oDlg = TDialog():New(,,,, "Duplicar series de S.A.T.", "DUPSERDOC",, .F.,,,,, oWndBrw, .F.,,,,,, .F.,, "oDlg", nil, )



   TRadMenu():Redefine( { | u | If( PCount()==0, oDesde:nRadio, oDesde:nRadio:= u ) }, oDlg,, { 90, 91 },,,,, .F.,, )










   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, oDesde:cSerieInicio, oDesde:cSerieInicio:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieInicio >= "A" .AND. oDesde:cSerieInicio <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )










   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, oDesde:cSerieFin, oDesde:cSerieFin:= u ) }, oDlg,, "@!", {||    ( oDesde:cSerieFin >= "A" .AND. oDesde:cSerieFin <= "Z"  )},,,,,, .T., {||     ( oDesde:nRadio == 1 )},, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, oDesde:nNumeroInicio, oDesde:nNumeroInicio:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, oDesde:nNumeroFin, oDesde:nNumeroFin:= u ) }, oDlg,, "999999999",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, oDesde:cSufijoInicio, oDesde:cSufijoInicio:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, oDesde:cSufijoFin, oDesde:cSufijoFin:= u ) }, oDlg,, "##",,,,,,, .F., {||     ( oDesde:nRadio == 1 )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oDesde:dFechaInicio, oDesde:dFechaInicio:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 180, { | u | If( PCount()==0, oDesde:dFechaFin, oDesde:dFechaFin:= u ) }, oDlg,,,,,,,,, .F., {||     ( oDesde:nRadio == 2 )},, .F., .T.,,,,,, nil,,, )




   oFecDoc := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, cFecDoc, cFecDoc:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   oBtnAceptar := TButton():ReDefine( 1, {||( DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) )}, oDlg,,, .F.,,,, .F. )





   oBtnCancel := TButton():ReDefine( 2, {||( lCancel := .T., oDlg:end() )}, oDlg,,, .F.,,,, .T. )







      oDlg:AddFastKey( 116, {|| DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, @lCancel, cFecDoc ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|( lCancel )},,, oDlg:bRClicked,,, )

   ( D():SatClientes( nView ) )->( dbGoTo( nRecNo ) )
   ( D():SatClientes( nView ) )->( ordSetFocus( nOrdAnt ) )

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



STATIC FUNCTION DupStart( oDesde, oDlg, oBtnAceptar, oBtnCancel, oTxtDup, lCancel, cFecDoc )

   local nOrd
   local nDuplicados    := 0
   local nProcesed      := 0

   oBtnAceptar:Hide()
   oBtnCancel:bAction   := {|| lCancel := .T. }

   if oDesde:nRadio == 1

      nOrd              := ( D():SatClientes( nView ) )->( OrdSetFocus( "nNumSat" ) )

      ( D():SatClientes( nView ) )->( dbSeek( oDesde:cNumeroInicio(), .T. ) )

      while !lCancel .AND. ( D():SatClientes( nView ) )->( !eof() )






         if ( D():SatClientes( nView ) )->cSerSat >= oDesde:cSerieInicio  .AND. ( D():SatClientes( nView ) )->cSerSat <= oDesde:cSerieFin     .AND. ( D():SatClientes( nView ) )->nNumSat >= oDesde:nNumeroInicio .AND. ( D():SatClientes( nView ) )->nNumSat <= oDesde:nNumeroFin    .AND. ( D():SatClientes( nView ) )->cSufSat >= oDesde:cSufijoInicio .AND. ( D():SatClientes( nView ) )->cSufSat <= oDesde:cSufijoFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( D():SatClientes( nView ) )->cSerSat + "/" + Alltrim( Str( ( D():SatClientes( nView ) )->nNumSat ) ) + "/" + ( D():SatClientes( nView ) )->cSufSat

            DuplicateSAST( cFecDoc )

         end

         ( D():SatClientes( nView ) )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( D():SatClientes( nView ) )->( OrdSetFocus( nOrd ) )

   else

      nOrd              := ( D():SatClientes( nView ) )->( OrdSetFocus( "dFecSat" ) )

      ( D():SatClientes( nView ) )->( dbSeek( oDesde:dFechaInicio, .T. ) )

      while !lCancel .AND. ( D():SatClientes( nView ) )->( !eof() )


         if ( D():SatClientes( nView ) )->dFecSat >= oDesde:dFechaInicio  .AND. ( D():SatClientes( nView ) )->dFecSat <= oDesde:dFechaFin

            ++nDuplicados

            oTxtDup:cText  := "Duplicando : " + ( D():SatClientes( nView ) )->cSerSat + "/" + Alltrim( Str( ( D():SatClientes( nView ) )->nNumSat ) ) + "/" + ( D():SatClientes( nView ) )->cSufSat

            DuplicateSAST( cFecDoc )

         end

         ( D():SatClientes( nView ) )->( dbSkip() )

         ++nProcesed

         oTxtDup:Set( nProcesed )

      end

      ( D():SatClientes( nView ) )->( OrdSetFocus( nOrd ) )

   end

   lCancel              := .T.

   oBtnAceptar:Show()

   if lCancel
      msgStop( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso cancelado" )
   else
      msgInfo( "Total de registros duplicados : " + Str( nDuplicados ), "Proceso finalizado" )
   end

RETURN ( oDlg:End() )



STATIC FUNCTION SatRecDup( cDbf, xField1, xField2, xField3, lCab, cFecDoc )

   local nRec           := ( cDbf )->( Recno() )
   local aTabla         := {}
   local nOrdAnt

   If( lCab == nil, lCab := .F., ) ;

   aTabla               := DBScatter( cDbf )
   aTabla[ 1 ]   := xField1
   aTabla[ 2 ]   := xField2
   aTabla[ 3 ]   := xField3

   if lCab

      aTabla[ 4     ]  := cCurSesion()
      if !Empty( cFecDoc )
         aTabla[ 5  ]  := cFecDoc
      end
      aTabla[ 18     ]  := Application():CodigoCaja()
      aTabla[ 21     ]  := Ctod("")
      aTabla[ 45     ]  := Space( 12 )
      aTabla[ 48     ]  := .T.
      aTabla[ 57     ]  := .F.
      aTabla[ 58     ]  := Auth():Codigo()
      aTabla[ 59     ]  := GetSysDate()
      aTabla[ 60     ]  := Time()
      aTabla[ 64  ]  := .F.
      aTabla[ 65     ]  := Ctod("")
      aTabla[ 66     ]  := Space( 5 )
      aTabla[ 67     ]  := Application():CodigoDelegacion()
      aTabla[ 22     ]  := .F.

      nOrdAnt                 := ( cDbf )->( OrdSetFocus( "NNUMSAT" ) )

   end

   if dbDialogLock( cDbf, .T. )
      aEval( aTabla, { | uTmp, n | ( cDbf )->( fieldPut( n, uTmp ) ) } )
      ( cDbf )->( dbUnLock() )
   end

   if lCab
      ( cDbf )->( OrdSetFocus( nOrdAnt ) )
   end

   ( cDbf )->( dbGoTo( nRec ) )

RETURN ( .T. )



STATIC FUNCTION DuplicateSAST( cFecDoc )

   local nNewNumSat  := 0



   nNewNumSat  := nNewDoc( ( D():SatClientes( nView ) )->cSerSat, D():SatClientes( nView ), "NSATCLI" )



   SatRecDup( D():SatClientes( nView ), ( D():SatClientes( nView ) )->cSerSat, nNewNumSat, ( D():SatClientes( nView ) )->cSufSat, .T., cFecDoc )



   if ( D():SatClientesLineas( nView ) )->( dbSeek( ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat ) )

      while D():SatClientesId( nView ) == D():SatClientesLineasId( nView ) .AND. D():SatClientesLineasNotEof( nView )

         SatRecDup( D():SatClientesLineas( nView ), ( D():SatClientes( nView ) )->cSerSat, nNewNumSat, ( D():SatClientes( nView ) )->cSufSat, .F. )

         ( D():SatClientesLineas( nView ) )->( dbSkip() )

      end

   end



   if ( dbfSatCliD )->( dbSeek( ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat ) )


      while ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat == ( dbfSatCliD )->cSerSat + Str( ( dbfSatCliD )->nNumSat ) + ( dbfSatCliD )->cSufSat .AND.  !( dbfSatCliD )->( Eof() )

         SatRecDup( dbfSatCliD, ( D():SatClientes( nView ) )->cSerSat, nNewNumSat, ( D():SatClientes( nView ) )->cSufSat, .F. )

         ( dbfSatCliD )->( dbSkip() )

      end

   end

RETURN ( .T. )



STATIC FUNCTION SetDialog( aGet, oSayGetRnt, oGetRnt )

   aGet[ 23   ]:Refresh()

   if !lAccArticulo() .OR. RolesModel():getRolNoMostrarRentabilidad( Auth():rolUuid() )

      if !Empty( oSayGetRnt )
         oSayGetRnt:Hide()
      end

      if !Empty( oGetRnt )
         oGetRnt:Hide()
      end

   end

   Eval( aGet[ 71  ]:bChange )

Return nil



STATIC FUNCTION ChangeTarifa( aTmp, aGet, aTmpSat )

   local nPrePro  := 0

   nPrePro        := nPrePro( aTmp[ 4 ], aTmp[ 25 ], aTmp[ 27 ], aTmp[ 26 ], aTmp[ 28 ], aTmp[ 73 ], aTmpSat[ 52 ], dbfArtDiv, dbfTarPreL, aTmpSat[ 16 ] )

   if nPrePro == 0
      nPrePro     := nRetPreArt( aTmp[ 73 ], aTmpSat[ 46 ], aTmpSat[ 52 ], D():Articulos( nView ), dbfDiv, dbfKit, dbfIva, , , oNewImp )
   end

   if !Empty( aTmpSat[ 16 ] )
      nPrePro     := RetPrcTar( aTmp[ 4 ], aTmpSat[16], aTmp[25], aTmp[26], aTmp[27], aTmp[28], dbfTarPreL, aTmp[ 73 ] )
   end

   if nPrePro <> 0
      aGet[ 11 ]:cText( nPrePro )
   end

return .T.



Static Function ValidaMedicion( aTmp, aGet )

   local cNewUndMed  := aGet[ 18 ]:VarGet





   if ( Empty( cOldUndMed ) .OR. cOldUndMed <> cNewUndMed )

      if oUndMedicion:oDbf:Seek( aTmp[ 18 ] )

         if oUndMedicion:oDbf:nDimension >= 1 .AND. !Empty( oUndMedicion:oDbf:cTextoDim1 )
            if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim1 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( ( D():Articulos( nView ) )->nLngArt )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Show()
            else
               aTmp[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := ( D():Articulos( nView ) )->nLngArt
            end
         else
            if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 2 .AND. !Empty( oUndMedicion:oDbf:cTextoDim2 )
            if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim2 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( ( D():Articulos( nView ) )->nAltArt )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Show()
            else
               aTmp[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := ( D():Articulos( nView ) )->nAltArt
            end

         else
            if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
               aTmp[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]  := 0
            end
         end

         if oUndMedicion:oDbf:nDimension >= 3 .AND. !Empty( oUndMedicion:oDbf:cTextoDim3 )
            if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:oSay:SetText( oUndMedicion:oDbf:cTextoDim3 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( ( D():Articulos( nView ) ) ->nAncArt )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Show()
            else
               aTmp[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := ( D():Articulos( nView ) )->nAncArt
            end
         else
            if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]  := 0
            end
         end

      else

         if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ] )
            aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:Hide()
            aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ] )
            aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:Hide()
            aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
         end

         if !Empty( aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ] )
            aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:Hide()
            aGet[ ( D():SatClientesLineas( nView ) )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
         end

      end

      cOldUndMed := cNewUndMed

   end

Return .T.



Static Function loadComisionAgente( aTmp, aGet, aTmpSat )

   local nComisionAgenteTarifa

   nComisionAgenteTarifa      := nComisionAgenteTarifa( aTmpSat[ 14 ], aTmp[ 73 ], nView )
   if nComisionAgenteTarifa == 0
      nComisionAgenteTarifa   := aTmpSat[ 43 ]
   end

   if !empty( aGet[ 16 ] )
      aGet[ 16 ]:cText( nComisionAgenteTarifa )
   else
      aTmp[ 16 ]        := nComisionAgenteTarifa
   end

return .T.
#line 8163 ".\.\Prg\Satcli.prg"
Static Function DataReport( oFr )





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "SAT", ( D():SatClientes( nView ) )->( Select() ), .F., { 1, 1, 0 } )
   oFr:SetFieldAliases( "SAT", cItemsToReport( aItmSatCli() ) )

   oFr:SetWorkArea(     "Lineas de SAT", ( D():SatClientesLineas( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de SAT", cItemsToReport( aColSatCli() ) )

   oFr:SetWorkArea(     "Incidencias de SAT", ( dbfSatCliI )->( Select() ) )
   oFr:SetFieldAliases( "Incidencias de SAT", cItemsToReport( aIncSatCli() ) )

   oFr:SetWorkArea(     "Documentos de SAT", ( dbfSatCliD )->( Select() ) )
   oFr:SetFieldAliases( "Documentos de SAT", cItemsToReport( aSatCliDoc() ) )

   oFr:SetWorkArea(     "Series de lineas de SAT", ( dbfSatCliS )->( Select() ) )
   oFr:SetFieldAliases( "Series de lineas de SAT", cItemsToReport( aSerSatCli() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Clientes", ( D():Clientes( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Clientes", cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Obras", ( dbfObrasT )->( Select() ) )
   oFr:SetFieldAliases( "Obras",  cItemsToReport( aItmObr() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Rutas", ( dbfRuta )->( Select() ) )
   oFr:SetFieldAliases( "Rutas", cItemsToReport( aItmRut() ) )

   oFr:SetWorkArea(     "Agentes", ( dbfAgent )->( Select() ) )
   oFr:SetFieldAliases( "Agentes", cItemsToReport( aItmAge() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( D():Articulos( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Ofertas", ( D():Ofertas( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Ofertas", cItemsToReport( aItmOfe() ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetWorkArea(     "Impuestos especiales",  oNewImp:Select() )
   oFr:SetFieldAliases( "Impuestos especiales",  cObjectsToReport( oNewImp:oDbf ) )

   oFr:SetWorkArea(     "Transportistas", oTrans:Select() )
   oFr:SetFieldAliases( "Transportistas", cObjectsToReport( oTrans:oDbf ) )

   oFr:SetMasterDetail( "SAT", "Lineas de SAT",                   {|| ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat } )
   oFr:SetMasterDetail( "SAT", "Series de lineas de SAT",         {|| ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat } )
   oFr:SetMasterDetail( "SAT", "Incidencias de SAT",              {|| ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat } )
   oFr:SetMasterDetail( "SAT", "Documentos de SAT",               {|| ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat } )
   oFr:SetMasterDetail( "SAT", "Empresa",                         {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "SAT", "Clientes",                        {|| ( D():SatClientes( nView ) )->cCodCli } )
   oFr:SetMasterDetail( "SAT", "Obras",                           {|| ( D():SatClientes( nView ) )->cCodCli + ( D():SatClientes( nView ) )->cCodObr } )
   oFr:SetMasterDetail( "SAT", "Almacen",                         {|| ( D():SatClientes( nView ) )->cCodAlm } )
   oFr:SetMasterDetail( "SAT", "Rutas",                           {|| ( D():SatClientes( nView ) )->cCodRut } )
   oFr:SetMasterDetail( "SAT", "Agentes",                         {|| ( D():SatClientes( nView ) )->cCodAge } )
   oFr:SetMasterDetail( "SAT", "Formas de pago",                  {|| ( D():SatClientes( nView ) )->cCodPgo } )
   oFr:SetMasterDetail( "SAT", "Transportistas",                  {|| ( D():SatClientes( nView ) )->cCodTrn } )

   oFr:SetMasterDetail( "Lineas de SAT", "Artículos",             {|| SynchronizeDetails() } )
   oFr:SetMasterDetail( "Lineas de SAT", "Ofertas",               {|| ( D():SatClientesLineas( nView ) )->cRef } )
   oFr:SetMasterDetail( "Lineas de SAT", "Unidades de medición",  {|| ( D():SatClientesLineas( nView ) )->cUnidad } )
   oFr:SetMasterDetail( "Lineas de SAT", "Impuestos especiales",  {|| ( D():SatClientesLineas( nView ) )->cCodImp } )

   oFr:SetResyncPair(   "SAT", "Lineas de SAT" )
   oFr:SetResyncPair(   "SAT", "Series de lineas de SAT" )
   oFr:SetResyncPair(   "SAT", "Incidencias de SAT" )
   oFr:SetResyncPair(   "SAT", "Documentos de SAT" )
   oFr:SetResyncPair(   "SAT", "Empresa" )
   oFr:SetResyncPair(   "SAT", "Clientes" )
   oFr:SetResyncPair(   "SAT", "Obras" )
   oFr:SetResyncPair(   "SAT", "Almacenes" )
   oFr:SetResyncPair(   "SAT", "Rutas" )
   oFr:SetResyncPair(   "SAT", "Agentes" )
   oFr:SetResyncPair(   "SAT", "Formas de pago" )
   oFr:SetResyncPair(   "SAT", "Transportistas" )

   oFr:SetResyncPair(   "Lineas de SAT", "Artículos" )
   oFr:SetResyncPair(   "Lineas de SAT", "Ofertas" )
   oFr:SetResyncPair(   "Lineas de SAT", "Unidades de medición" )
   oFr:SetResyncPair(   "Lineas de SAT", "Impuestos especiales" )

Return nil



Static Function SynchronizeDetails()

Return ( ( D():SatClientesLineas( nView ) )->cRef )



Static Function VariableReport( oFr )

   oFr:DeleteCategory(  "SAT" )
   oFr:DeleteCategory(  "Lineas de SAT" )





   oFr:AddVariable(     "SAT",             "Total bruto",                        "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "SAT",             "Total SAT",                          "GetHbVar('nTotSat')" )
   oFr:AddVariable(     "SAT",             "Total descuento",                    "GetHbVar('nTotDto')" )
   oFr:AddVariable(     "SAT",             "Total descuento pronto pago",        "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "SAT",             "Total descuentos",                   "GetHbVar('nTotalDto')" )
   oFr:AddVariable(     "SAT",             "Total neto",                         "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "SAT",             "Total primer descuento definible",   "GetHbVar('nTotUno')" )
   oFr:AddVariable(     "SAT",             "Total segundo descuento definible",  "GetHbVar('nTotDos')" )
   oFr:AddVariable(     "SAT",             "Total " + cImp(),                    "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "SAT",             "Total RE",                           "GetHbVar('nTotReq')" )
   oFr:AddVariable(     "SAT",             "Total página",                       "GetHbVar('nTotPag')" )
   oFr:AddVariable(     "SAT",             "Total retención",                    "GetHbVar('nTotRet')" )
   oFr:AddVariable(     "SAT",             "Total peso",                         "GetHbVar('nTotPes')" )
   oFr:AddVariable(     "SAT",             "Total costo",                        "GetHbVar('nTotCos')" )
   oFr:AddVariable(     "SAT",             "Total anticipado",                   "GetHbVar('nTotAnt')" )
   oFr:AddVariable(     "SAT",             "Total cobrado",                      "GetHbVar('nTotCob')" )
   oFr:AddVariable(     "SAT",             "Total artículos",                    "GetHbVar('nTotArt')" )
   oFr:AddVariable(     "SAT",             "Total cajas",                        "GetHbVar('nTotCaj')" )
   oFr:AddVariable(     "SAT",             "Cuenta por defecto del cliente",     "GetHbVar('cCtaCli')" )

   oFr:AddVariable(     "SAT",             "Bruto primer tipo de " + cImp(),     "GetHbArrayVar('aIvaUno',1)" )
   oFr:AddVariable(     "SAT",             "Bruto segundo tipo de " + cImp(),    "GetHbArrayVar('aIvaDos',1)" )
   oFr:AddVariable(     "SAT",             "Bruto tercer tipo de " + cImp(),     "GetHbArrayVar('aIvaTre',1)" )
   oFr:AddVariable(     "SAT",             "Base primer tipo de " + cImp(),      "GetHbArrayVar('aIvaUno',2)" )
   oFr:AddVariable(     "SAT",             "Base segundo tipo de " + cImp(),     "GetHbArrayVar('aIvaDos',2)" )
   oFr:AddVariable(     "SAT",             "Base tercer tipo de " + cImp(),      "GetHbArrayVar('aIvaTre',2)" )
   oFr:AddVariable(     "SAT",             "Porcentaje primer tipo " + cImp(),   "GetHbArrayVar('aIvaUno',3)" )
   oFr:AddVariable(     "SAT",             "Porcentaje segundo tipo " + cImp(),  "GetHbArrayVar('aIvaDos',3)" )
   oFr:AddVariable(     "SAT",             "Porcentaje tercer tipo " + cImp(),   "GetHbArrayVar('aIvaTre',3)" )
   oFr:AddVariable(     "SAT",             "Porcentaje primer tipo RE",          "GetHbArrayVar('aIvaUno',4)" )
   oFr:AddVariable(     "SAT",             "Porcentaje segundo tipo RE",         "GetHbArrayVar('aIvaDos',4)" )
   oFr:AddVariable(     "SAT",             "Porcentaje tercer tipo RE",          "GetHbArrayVar('aIvaTre',4)" )
   oFr:AddVariable(     "SAT",             "Importe primer tipo " + cImp(),      "GetHbArrayVar('aIvaUno',8)" )
   oFr:AddVariable(     "SAT",             "Importe segundo tipo " + cImp(),     "GetHbArrayVar('aIvaDos',8)" )
   oFr:AddVariable(     "SAT",             "Importe tercer tipo " + cImp(),      "GetHbArrayVar('aIvaTre',8)" )
   oFr:AddVariable(     "SAT",             "Importe primer RE",                  "GetHbArrayVar('aIvaUno',9)" )
   oFr:AddVariable(     "SAT",             "Importe segundo RE",                 "GetHbArrayVar('aIvaDos',9)" )
   oFr:AddVariable(     "SAT",             "Importe tercer RE",                  "GetHbArrayVar('aIvaTre',9)" )

   oFr:AddVariable(     "SAT",             "Fecha del primer vencimiento",       "GetHbArrayVar('aDatVto',1)" )
   oFr:AddVariable(     "SAT",             "Fecha del segundo vencimiento",      "GetHbArrayVar('aDatVto',2)" )
   oFr:AddVariable(     "SAT",             "Fecha del tercer vencimiento",       "GetHbArrayVar('aDatVto',3)" )
   oFr:AddVariable(     "SAT",             "Fecha del cuarto vencimiento",       "GetHbArrayVar('aDatVto',4)" )
   oFr:AddVariable(     "SAT",             "Fecha del quinto vencimiento",       "GetHbArrayVar('aDatVto',5)" )
   oFr:AddVariable(     "SAT",             "Fecha del sexto vencimiento",        "GetHbArrayVar('aDatVto',6)" )
   oFr:AddVariable(     "SAT",             "Fecha del septimo vencimiento",      "GetHbArrayVar('aDatVto',7)" )
   oFr:AddVariable(     "SAT",             "Fecha del octavovencimiento",        "GetHbArrayVar('aDatVto',8)" )
   oFr:AddVariable(     "SAT",             "Fecha del noveno vencimiento",       "GetHbArrayVar('aDatVto',9)" )
   oFr:AddVariable(     "SAT",             "Fecha del decimo vencimiento",       "GetHbArrayVar('aDatVto',10)" )
   oFr:AddVariable(     "SAT",             "Fecha del undecimo vencimiento",     "GetHbArrayVar('aDatVto',11)" )
   oFr:AddVariable(     "SAT",             "Fecha del duodecimo vencimiento",    "GetHbArrayVar('aDatVto',12)" )

   oFr:AddVariable(     "SAT",             "Importe del primer vencimiento",     "GetHbArrayVar('aImpVto',1)" )
   oFr:AddVariable(     "SAT",             "Importe del segundo vencimiento",    "GetHbArrayVar('aImpVto',2)" )
   oFr:AddVariable(     "SAT",             "Importe del tercero vencimiento",    "GetHbArrayVar('aImpVto',3)" )
   oFr:AddVariable(     "SAT",             "Importe del cuarto vencimiento",     "GetHbArrayVar('aImpVto',4)" )
   oFr:AddVariable(     "SAT",             "Importe del quinto vencimiento",     "GetHbArrayVar('aImpVto',5)" )
   oFr:AddVariable(     "SAT",             "Importe del sexto vencimiento",      "GetHbArrayVar('aImpVto',6)" )
   oFr:AddVariable(     "SAT",             "Importe del septimo vencimiento",    "GetHbArrayVar('aImpVto',7)" )
   oFr:AddVariable(     "SAT",             "Importe del octavo vencimiento",     "GetHbArrayVar('aImpVto',8)" )
   oFr:AddVariable(     "SAT",             "Importe del noveno vencimiento",     "GetHbArrayVar('aImpVto',9)" )
   oFr:AddVariable(     "SAT",             "Importe del decimo vencimiento",     "GetHbArrayVar('aImpVto',10)" )
   oFr:AddVariable(     "SAT",             "Importe del undecimo vencimiento",   "GetHbArrayVar('aImpVto',11)" )
   oFr:AddVariable(     "SAT",             "Importe del duodecimo vencimiento",  "GetHbArrayVar('aImpVto',12)" )

   oFr:AddVariable(     "Lineas de SAT",   "Detalle del artículo",                "CallHbFunc('cDesSatCli')"  )
   oFr:AddVariable(     "Lineas de SAT",   "Detalle del artículo otro lenguaje",  "CallHbFunc('cDesSatCliLeng')"  )
   oFr:AddVariable(     "Lineas de SAT",   "Total unidades artículo",             "CallHbFunc('nTotNSatCli')" )
   oFr:AddVariable(     "Lineas de SAT",   "Precio unitario del artículo",        "CallHbFunc('nTotUSatCli')" )
   oFr:AddVariable(     "Lineas de SAT",   "Total línea de SAT",                  "CallHbFunc('nTotLSatCli')" )
   oFr:AddVariable(     "Lineas de SAT",   "Total peso por línea",                "CallHbFunc('nPesLSatCli')" )
   oFr:AddVariable(     "Lineas de SAT",   "Total final línea del SAT",           "CallHbFunc('nTotFSatCli')" )

Return nil



Static Function SetDiasSAT( aTmp, aGet )

   aGet[ 71 ]:oSay:SetText( "Entrega " + Alltrim( Str( aTmp[ 71 ] - aTmp[ 5 ] ) ) + " dias" )

Return nil



Static Function hValue( aTmp, aTmpSat )

   local hValue                        := {=>}

   do case
      case ValType( aTmp ) == "A"

         hValue[ "cCodigoArticulo"   ] := aTmp[ 4 ]
         hValue[ "cCodigoPropiedad1" ] := aTmp[ 25 ]
         hValue[ "cCodigoPropiedad2" ] := aTmp[ 26 ]
         hValue[ "cValorPropiedad1"  ] := aTmp[ 27 ]
         hValue[ "cValorPropiedad2"  ] := aTmp[ 28 ]
         hValue[ "cCodigoFamilia"    ] := aTmp[ 51 ]
         hValue[ "nTarifaPrecio"     ] := aTmp[ 73 ]
         hValue[ "nCajas"            ] := aTmp[ 7 ]
         hValue[ "nUnidades"         ] := aTmp[ 8 ]
         hValue[ "lIvaIncluido"      ] := aTmp[ 37 ]

      case ValType( aTmp ) == "C"

         hValue[ "cCodigoArticulo"   ] := ( aTmp )->cRef
         hValue[ "cCodigoPropiedad1" ] := ( aTmp )->cCodPr1
         hValue[ "cCodigoPropiedad2" ] := ( aTmp )->cCodPr2
         hValue[ "cValorPropiedad1"  ] := ( aTmp )->cValPr1
         hValue[ "cValorPropiedad2"  ] := ( aTmp )->cValPr2
         hValue[ "cCodigoFamilia"    ] := ( aTmp )->cCodFam
         hValue[ "nTarifaPrecio"     ] := ( aTmp )->nTarLin
         hValue[ "nCajas"            ] := ( aTmp )->nCanSat
         hValue[ "nUnidades"         ] := ( aTmp )->nUniCaja
         hValue[ "lIvaIncluido"      ] := ( aTmp )->lIvaLin

   end

   hValue[ "nTotalLinea"       ]       := nTotLSatCli( aTmp )

   do case
      case ValType( aTmpSat ) == "A"

         hValue[ "cCodigoCliente"    ] := aTmpSat[ 6 ]
         hValue[ "cCodigoGrupo"      ] := aTmpSat[ 63 ]
         hValue[ "lIvaIncluido"      ] := aTmpSat[ 52 ]
         hValue[ "dFecha"            ] := aTmpSat[ 5 ]
         hValue[ "cGrupoCliente"     ] := aTmpSat[ 63 ]
         hValue[ "cDivisa"           ] := aTmpSat[ 46 ]

      case ValType( aTmpSat ) == "C"

         hValue[ "cCodigoCliente"    ] := ( aTmpSat )->cCodCli
         hValue[ "cCodigoGrupo"      ] := ( aTmpSat )->cCodGrp
         hValue[ "lIvaIncluido"      ] := ( aTmpSat )->lIvaInc
         hValue[ "dFecha"            ] := ( aTmpSat )->dFecSat
         hValue[ "cGrupoCliente"     ] := ( aTmpSat )->cCodGrp
         hValue[ "cDivisa"           ] := ( aTmpSat )->cDivSat

   end

   hValue[ "nTipoDocumento"         ]  := "32"
   hValue[ "nView"                  ]  := nView

Return ( hValue )



Static Function ImprimirSeriesSatClientes( nDevice, lExt )

   local aStatus
   local oPrinter
   local cFormato

   If( nDevice == nil, nDevice := 1, ) ;
   If( lExt == nil, lExt := .F., ) ;



   oPrinter          := PrintSeries():New( nView ):SetVentas()



   oPrinter:Serie(      ( D():SatClientes( nView ) )->cSerSat )
   oPrinter:Documento(  ( D():SatClientes( nView ) )->nNumSat )
   oPrinter:Sufijo(     ( D():SatClientes( nView ) )->cSufSat )

   if lExt

      oPrinter:oFechaInicio:cText( ( D():SatClientes( nView ) )->dFecSat )
      oPrinter:oFechaFin:cText( ( D():SatClientes( nView ) )->dFecSat )

   end

   oPrinter:oFormatoDocumento:TypeDocumento( "SC" )



   cFormato          := cFormatoDocumento( ( D():SatClientes( nView ) )->cSerSat, "nSatCli", D():Contadores( nView ) )
   if empty( cFormato )
      cFormato       := cFirstDoc( "SC", D():Documentos( nView ) )
   end
   oPrinter:oFormatoDocumento:cText( cFormato )



   aStatus           := D():GetInitStatus( "SatCliT", nView )

   oPrinter:bInit    := {||   ( D():SatClientes( nView ) )->( dbSeek( oPrinter:DocumentoInicio(), .T. ) ) }


   oPrinter:bWhile   := {||   oPrinter:InRangeDocumento( D():SatClientesId( nView ) )                  .AND.  ( D():SatClientes( nView ) )->( !eof() ) }




   oPrinter:bFor     := {||   oPrinter:InRangeFecha( ( D():SatClientes( nView ) )->dFecSat )           .AND.  oPrinter:InRangeCliente( ( D():SatClientes( nView ) )->cCodCli )         .AND.  oPrinter:InRangeAgente( ( D():SatClientes( nView ) )->cCodAge )         .AND.  oPrinter:InRangeGrupoCliente( retGrpCli( ( D():SatClientes( nView ) )->cCodCli, D():Clientes( nView ) ) ) }

   oPrinter:bSkip    := {||   ( D():SatClientes( nView ) )->( dbSkip() ) }





   oPrinter:bAction  := {||   GenSatCli(  nDevice, "Imprimiendo documento : " + D():SatClientesId( nView ), oPrinter:oFormatoDocumento:uGetValue, oPrinter:oImpresora:uGetValue, if( !oPrinter:oCopias:lCopiasPredeterminadas, oPrinter:oCopias:uGetValue, ) ) }

   oPrinter:bStart   := {||   if( lExt, oPrinter:DisableRange(), ) }



   oPrinter:Resource():End()



   D():SetStatus( "SatCliT", nView, aStatus )

   if !Empty( oWndBrw )
      oWndBrw:Refresh()
   end

Return .T.








FUNCTION nTotSatCli( cNumSat, cSatCliT, cSatCliL, cIva, cDiv, cFPago, aTmp, cDivRet, lPic )

   local n
   local nRecno
   local cCodDiv
   local bCondition
   local nTotalArt
   local nDtoEsp
   local nDtoPP
   local nDtoUno
   local nDtoDos
   local nDtoAtp
   local nSbrAtp
   local dFecFac
   local lIvaInc
   local nIvaMan
   local nKgsTrn
   local lPntVer           := .F.
   local nManObr           := 0
   local nTotalLin         := 0
   local nTotalUnd         := 0
   local aTotalDto         := { 0, 0, 0 }
   local aTotalDPP         := { 0, 0, 0 }
   local aTotalUno         := { 0, 0, 0 }
   local aTotalDos         := { 0, 0, 0 }
   local aTotalAtp         := { 0, 0, 0 }
   local lRecargo
   local nTotAcu           := 0
   local nDescuentosLineas := 0
   local nRegIva
   local nBaseGasto
   local nIvaGasto

   If( cSatCliT == nil, cSatCliT := D():SatClientes( nView ), ) ;
   If( cSatCliL == nil, cSatCliL := D():SatClientesLineas( nView ), ) ;
   If( cIva == nil, cIva := dbfIva, ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( cFPago == nil, cFPago := dbfFPago, ) ;
   If( cNumSat == nil, cNumSat := ( cSatCliT )->cSerSat + Str( ( cSatCliT )->nNumSat ) + ( cSatCliT )->cSufSat, ) ;
   If( lPic == nil, lPic := .F., ) ;

   if Empty( Select( cSatCliT ) )
      Return ( 0 )
   end

   if Empty( Select( cSatCliL ) )
      Return ( 0 )
   end

   if Empty( Select( cIva ) )
      Return ( 0 )
   end

   if Empty( Select( cDiv ) )
      Return ( 0 )
   end

   public nTotBrt    := 0
   public nTotSat    := 0
   public nTotDto    := 0
   public nTotDPP    := 0
   public nTotNet    := 0
   public nTotIvm    := 0
   public nTotIva    := 0
   public nTotReq    := 0
   public nTotAge    := 0
   public nTotUno    := 0
   public nTotDos    := 0
   public nTotPnt    := 0
   public nTotTrn    := 0
   public nTotCos    := 0
   public nTotRnt    := 0
   public nTotAtp    := 0
   public nTotPes    := 0
   public nPctRnt    := 0
   public nTotDif    := 0
   public nTotUnd    := 0

   public aTotIva    := { { 0,0,nil,0,0,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0,0,0 } }
   public aIvaUno    := aTotIva[ 1 ]
   public aIvaDos    := aTotIva[ 2 ]
   public aIvaTre    := aTotIva[ 3 ]

   public aTotIvm    := { { 0,nil,0 }, { 0,nil,0 }, { 0,nil,0 }, }
   public aIvmUno    := aTotIvm[ 1 ]
   public aIvmDos    := aTotIvm[ 2 ]
   public aIvmTre    := aTotIvm[ 3 ]

   public aImpVto    := {}
   public aDatVto    := {}

   public nNumArt    := 0
   public nNumCaj    := 0

   public nTotalDto  := 0

   public cCtaCli    := cClientCuenta( ( cSatCliT )->cCodCli )

   nRecno            := ( cSatCliL )->( RecNo() )

   if aTmp <> nil
      lRecargo       := aTmp[ 42]
      nDtoEsp        := aTmp[ 30 ]
      nDtoPP         := aTmp[ 32    ]
      nDtoUno        := aTmp[ 34 ]
      nDtoDos        := aTmp[ 36 ]
      cCodDiv        := aTmp[ 46 ]
      nVdvDiv        := aTmp[ 47 ]
      dFecFac        := aTmp[ 5 ]
      lIvaInc        := aTmp[ 52 ]
      nIvaMan        := aTmp[ 53 ]
      nManObr        := aTmp[ 54 ]
      nDtoAtp        := aTmp[ 68 ]
      nSbrAtp        := aTmp[ 69 ]
      nKgsTrn        := aTmp[ 56 ]
      lPntVer        := aTmp[ 80 ]
      nRegIva        := aTmp[ 51 ]
      bCondition     := {|| !( cSatCliL )->( eof() ) }
      ( cSatCliL )->( dbGoTop() )
   else
      lRecargo       := ( cSatCliT )->lRecargo
      nDtoEsp        := ( cSatCliT )->nDtoEsp
      nDtoPP         := ( cSatCliT )->nDpp
      nDtoUno        := ( cSatCliT )->nDtoUno
      nDtoDos        := ( cSatCliT )->nDtoDos
      cCodDiv        := ( cSatCliT )->cDivSat
      nVdvDiv        := ( cSatCliT )->nVdvSat
      dFecFac        := ( cSatCliT )->dFecSat
      nIvaMan        := ( cSatCliT )->nIvaMan
      lIvaInc        := ( cSatCliT )->lIvaInc
      nManObr        := ( cSatCliT )->nManObr
      nDtoAtp        := ( cSatCliT )->nDtoAtp
      nSbrAtp        := ( cSatCliT )->nSbrAtp
      nKgsTrn        := ( cSatCliT )->nKgsTrn
      lPntVer        := ( cSatCliT )->lOperPV
      nRegIva        := ( cSatCliT )->nRegIva
      bCondition     := {|| ( cSatCliL )->cSerSat + Str( ( cSatCliL )->nNumSat ) + ( cSatCliL )->cSufSat == cNumSat .AND. !( cSatCliL )->( eof() ) }
      ( cSatCliL )->( dbSeek( cNumSat ) )
   end





   cPouDiv           := cPouDiv( cCodDiv, cDiv )
   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   cPpvDiv           := cPpvDiv( cCodDiv, cDiv )
   nDouDiv           := nDouDiv( cCodDiv, cDiv )
   nRouDiv           := nRouDiv( cCodDiv, cDiv )
   nDpvDiv           := nDpvDiv( cCodDiv, cDiv )

   WHILE Eval( bCondition )

      if lValLine( cSatCliL )

         if ( cSatCliL )->lTotLin





            if ( cSatCliL )->nPreDiv <> nTotalLin .OR. ( cSatCliL )->nUniCaja <> nTotalUnd

               if ( cSatCliL )->( dbRLock() )
                  ( cSatCliL )->nPreDiv    := nTotalLin
                  ( cSatCliL )->nUniCaja   := nTotalUnd
                  ( cSatCliL )->( dbUnLock() )
               end

            end





            nTotalLin         := 0
            nTotalUnd         := 0

         else

            nTotArt           := nTotLSatCli( cSatCliL, nDouDiv, nRouDiv, , , .F., .F. )
            nTotPnt           := if( lPntVer, nPntLSatCli( cSatCliL, nDpvDiv ), 0 )
            nTotTrn           := nTrnLSatCli( cSatCliL, nDouDiv )
            nTotIvm           := nTotISatCli( cSatCliL, nDouDiv, nRouDiv )
            nTotCos           += nTotCSatCli( cSatCliL, nDouDiv, nRouDiv )
            nTotPes           += nPesLSatCli( cSatCliL )
            nDescuentosLineas += nTotDtoLSatCli( cSatCliL, nDouDiv )

            if aTmp <> nil
               nTotAge        += nComLSatCli( aTmp, cSatCliL, nDouDiv, nRouDiv )
            else
               nTotAge        += nComLSatCli( cSatCliT, cSatCliL, nDouDiv, nRouDiv )
            end

            nNumArt           += nTotNSatCli( cSatCliL )
            nNumCaj           += ( cSatCliL )->nCanSat





            nTotUnd           += nTotNSatCli( cSatCliL )





            DO CASE
            CASE aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == ( cSatCliL )->nIva
               aTotIva[ 1, 3 ]      := ( cSatCliL )->nIva
               aTotIva[ 1, 4 ]      := ( cSatCliL )->nReq
               aTotIva[ 1, 1 ]      += nTotArt
               aTotIva[ 1, 6 ]      += nTotIvm
               aTotIva[ 1, 7 ]      += nTotTrn
               aTotIva[ 1, 5 ]      += nTotPnt

            CASE aTotIva[ 2, 3 ] == NIL .OR. aTotIva[ 2, 3 ] == ( cSatCliL )->nIva
               aTotIva[ 2, 3 ]      := ( cSatCliL )->nIva
               aTotIva[ 2, 4 ]      := ( cSatCliL )->nReq
               aTotIva[ 2, 1 ]      += nTotArt
               aTotIva[ 2, 6 ]      += nTotIvm
               aTotIva[ 2, 7 ]      += nTotTrn
               aTotIva[ 2, 5 ]      += nTotPnt

            CASE aTotIva[ 3, 3 ] == NIL .OR. aTotIva[ 3, 3 ] == ( cSatCliL )->nIva
               aTotIva[ 3, 3 ]      := ( cSatCliL )->nIva
               aTotIva[ 3, 4 ]      := ( cSatCliL )->nReq
               aTotIva[ 3, 1 ]      += nTotArt
               aTotIva[ 3, 6 ]      += nTotIvm
               aTotIva[ 3, 7 ]      += nTotTrn
               aTotIva[ 3, 5 ]      += nTotPnt

            end




            if ( cSatCliL )->nValImp <> 0

               do case
                  case aTotIvm[ 1, 2 ] == nil .OR. aTotIvm[ 1, 2 ] == ( cSatCliL )->nValImp
                     aTotIvm[ 1, 1 ]      += nTotNSatCli( cSatCliL ) * if( ( cSatCliL )->lVolImp, NotCero( ( cSatCliL )->nVolumen ), 1 )
                     aTotIvm[ 1, 2 ]      := ( cSatCliL )->nValImp
                     aTotIvm[ 1, 3 ]      := aTotIvm[ 1, 1 ] * aTotIvm[ 1, 2 ]

                  case aTotIvm[ 2, 2 ] == nil .OR. aTotIvm[ 2, 2 ] == ( cSatCliL )->nValImp
                     aTotIvm[ 2, 1 ]      += nTotNSatCli( cSatCliL ) * if( ( cSatCliL )->lVolImp, NotCero( ( cSatCliL )->nVolumen ), 1 )
                     aTotIvm[ 2, 2 ]      := ( cSatCliL )->nValImp
                     aTotIvm[ 2, 3 ]      := aTotIvm[ 2, 1 ] * aTotIvm[ 2, 2 ]

                  case aTotIvm[ 3, 2 ] == nil .OR. aTotIvm[ 3, 2 ] == ( cSatCliL )->nValImp
                     aTotIvm[ 3, 1 ]      += nTotNSatCli( cSatCliL ) * if( ( cSatCliL )->lVolImp, NotCero( ( cSatCliL )->nVolumen ), 1 )
                     aTotIvm[ 3, 2 ]      := ( cSatCliL )->nValImp
                     aTotIvm[ 3, 3 ]      := aTotIvm[ 3, 1 ] * aTotIvm[ 3, 2 ]

               end

            end

         end

      end

      ( cSatCliL )->( dbSkip() )

   end

   ( cSatCliL )->( dbGoto( nRecno ) )





   aTotIva           := aSort( aTotIva,,, {|x,y| if( x[3] <> nil, x[3], -1 ) > if( y[3] <> nil, y[3], -1 )  } )

   aTotIva[ 1, 2 ]         := Round( aTotIva[ 1, 1 ], nRouDiv )
   aTotIva[ 2, 2 ]         := Round( aTotIva[ 2, 1 ], nRouDiv )
   aTotIva[ 3, 2 ]         := Round( aTotIva[ 3, 1 ], nRouDiv )

   nTotBrt           := aTotIva[ 1, 1 ] + aTotIva[ 2, 1 ] + aTotIva[ 3, 1 ]







   if nSbrAtp <= 1 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





   IF nDtoEsp  <> 0

      aTotalDto[1]   := Round( aTotIva[ 1, 2 ] * nDtoEsp / 100, nRouDiv )
      aTotalDto[2]   := Round( aTotIva[ 2, 2 ] * nDtoEsp / 100, nRouDiv )
      aTotalDto[3]   := Round( aTotIva[ 3, 2 ] * nDtoEsp / 100, nRouDiv )

      nTotDto        := aTotalDto[1] + aTotalDto[2] + aTotalDto[3]

      aTotIva[ 1, 2 ]      -= aTotalDto[1]
      aTotIva[ 2, 2 ]      -= aTotalDto[2]
      aTotIva[ 3, 2 ]      -= aTotalDto[3]

   end





   if nSbrAtp == 2 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





   IF nDtoPP   <> 0

      aTotalDPP[1]   := Round( aTotIva[ 1, 2 ] * nDtoPP / 100, nRouDiv )
      aTotalDPP[2]   := Round( aTotIva[ 2, 2 ] * nDtoPP / 100, nRouDiv )
      aTotalDPP[3]   := Round( aTotIva[ 3, 2 ] * nDtoPP / 100, nRouDiv )

      nTotDPP        := aTotalDPP[1] + aTotalDPP[2] + aTotalDPP[3]

      aTotIva[ 1, 2 ]      -= aTotalDPP[1]
      aTotIva[ 2, 2 ]      -= aTotalDPP[2]
      aTotIva[ 3, 2 ]      -= aTotalDPP[3]

   end





   if nSbrAtp == 3 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

   IF nDtoUno <> 0

      aTotalUno[1]   := Round( aTotIva[ 1, 2 ] * nDtoUno / 100, nRouDiv )
      aTotalUno[2]   := Round( aTotIva[ 2, 2 ] * nDtoUno / 100, nRouDiv )
      aTotalUno[3]   := Round( aTotIva[ 3, 2 ] * nDtoUno / 100, nRouDiv )

      nTotUno        := aTotalUno[1] + aTotalUno[2] + aTotalUno[3]

      aTotIva[ 1, 2 ]      -= aTotalUno[1]
      aTotIva[ 2, 2 ]      -= aTotalUno[2]
      aTotIva[ 3, 2 ]      -= aTotalUno[3]

   end





   if nSbrAtp == 4 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end

   IF nDtoDos <> 0

      aTotalDos[1]   := Round( aTotIva[ 1, 2 ] * nDtoDos / 100, nRouDiv )
      aTotalDos[2]   := Round( aTotIva[ 2, 2 ] * nDtoDos / 100, nRouDiv )
      aTotalDos[3]   := Round( aTotIva[ 3, 2 ] * nDtoDos / 100, nRouDiv )

      nTotDos        := aTotalDos[1] + aTotalDos[2] + aTotalDos[3]

      aTotIva[ 1, 2 ]      -= aTotalDos[1]
      aTotIva[ 2, 2 ]      -= aTotalDos[2]
      aTotIva[ 3, 2 ]      -= aTotalDos[3]

   end





   if nSbrAtp == 5 .AND. nDtoAtp <> 0

      aTotalAtp[1]   := Round( aTotIva[ 1, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[2]   := Round( aTotIva[ 2, 2 ] * nDtoAtp / 100, nRouDiv )
      aTotalAtp[3]   := Round( aTotIva[ 3, 2 ] * nDtoAtp / 100, nRouDiv )

      nTotAtp        := aTotalAtp[ 1 ] + aTotalAtp[ 2 ] + aTotalAtp[ 3 ]

   end





   aTotIva[ 1, 2 ]         += aTotIva[ 1, 7 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 7 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 7 ]





   aTotIva[ 1, 2 ]         += aTotIva[ 1, 5 ]
   aTotIva[ 2, 2 ]         += aTotIva[ 2, 5 ]
   aTotIva[ 3, 2 ]         += aTotIva[ 3, 5 ]





   if !lIvaInc .AND. uFieldEmpresa( "lIvaImpEsp" )
      aTotIva[ 1, 2 ]      += aTotIva[ 1, 6 ]
      aTotIva[ 2, 2 ]      += aTotIva[ 2, 6 ]
      aTotIva[ 3, 2 ]      += aTotIva[ 3, 6 ]
   end

   if !lIvaInc

      if nRegIva <= 1





         aTotIva[ 1, 8 ]      := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 3 ] / 100, nRouDiv ), 0 )
         aTotIva[ 2, 8 ]      := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 3 ] / 100, nRouDiv ), 0 )
         aTotIva[ 3, 8 ]      := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 3 ] / 100, nRouDiv ), 0 )





         if lRecargo
            aTotIva[ 1, 9 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] * aTotIva[ 1, 4 ] / 100, nRouDiv ), 0 )
            aTotIva[ 2, 9 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] * aTotIva[ 2, 4 ] / 100, nRouDiv ), 0 )
            aTotIva[ 3, 9 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] * aTotIva[ 3, 4 ] / 100, nRouDiv ), 0 )
         end

         if uFieldEmpresa( "lIvaImpEsp")
            aTotIva[ 1, 2 ]            -= aTotIva[ 1, 6 ]
            aTotIva[ 2, 2 ]            -= aTotIva[ 2, 6 ]
            aTotIva[ 3, 2 ]            -= aTotIva[ 3, 6 ]
         end

      end

   else

      if  !uFieldEmpresa( "lIvaImpEsp" )
         aTotIva[ 1, 2 ]         -= aTotIva[ 1, 6 ]
         aTotIva[ 2, 2 ]         -= aTotIva[ 2, 6 ]
         aTotIva[ 3, 2 ]         -= aTotIva[ 3, 6 ]
      end

      if nRegIva <= 1

         if aTotIva[ 1, 3 ] <> 0
            aTotIva[ 1, 8 ]   := if( aTotIva[ 1, 3 ] <> nil, Round( aTotIva[ 1, 2 ] / ( 100 / aTotIva[ 1, 3 ] + 1 ), nRouDiv ), 0 )
         end
         if aTotIva[ 2, 3 ] <> 0
            aTotIva[ 2, 8 ]   := if( aTotIva[ 2, 3 ] <> nil, Round( aTotIva[ 2, 2 ] / ( 100 / aTotIva[ 2, 3 ] + 1 ), nRouDiv ), 0 )
         end
         if aTotIva[ 3, 3 ] <> 0
            aTotIva[ 3, 8 ]   := if( aTotIva[ 3, 3 ] <> nil, Round( aTotIva[ 3, 2 ] / ( 100 / aTotIva[ 3, 3 ] + 1 ), nRouDiv ), 0 )
         end

         if lRecargo
            if aTotIva[ 1, 4 ] <> 0
               aTotIva[ 1, 9 ]   := if( aTotIva[ 1, 3 ] <> NIL, Round( aTotIva[ 1, 2 ] / ( 100 / aTotIva[ 1, 4 ] + 1 ), nRouDiv ), 0 )
            end
            if aTotIva[ 3, 4 ] <> 0
               aTotIva[ 2, 9 ]   := if( aTotIva[ 2, 3 ] <> NIL, Round( aTotIva[ 2, 2 ] / ( 100 / aTotIva[ 2, 4 ] + 1 ), nRouDiv ), 0 )
            end
            if aTotIva[ 3, 4 ] <> 0
               aTotIva[ 3, 9 ]   := if( aTotIva[ 3, 3 ] <> NIL, Round( aTotIva[ 3, 2 ] / ( 100 / aTotIva[ 3, 4 ] + 1 ), nRouDiv ), 0 )
            end
         end

         aTotIva[ 1, 2 ]      -= aTotIva[ 1, 8 ]
         aTotIva[ 2, 2 ]      -= aTotIva[ 2, 8 ]
         aTotIva[ 3, 2 ]      -= aTotIva[ 3, 8 ]

      end

      if uFieldEmpresa( "lIvaImpEsp")
         aTotIva[ 1, 2 ]         -= aTotIva[ 1, 6 ]
         aTotIva[ 2, 2 ]         -= aTotIva[ 2, 6 ]
         aTotIva[ 3, 2 ]         -= aTotIva[ 3, 6 ]
      end

      aTotIva[ 1, 2 ]      -= aTotIva[ 1, 9 ]
      aTotIva[ 2, 2 ]      -= aTotIva[ 2, 9 ]
      aTotIva[ 3, 2 ]      -= aTotIva[ 3, 9 ]

   end



   if nManObr <> 0

      if lIvaInc
         nIvaGasto   := Round( nManObr / ( 100 / nIvaMan + 1 ), nRouDiv )
         nBaseGasto  := nManObr - nIvaGasto
      else
         nBaseGasto  := nManObr
         nIvaGasto   := Round( nManObr * nIvaMan / 100, nRouDiv )
      end

      do case
      case aTotIva[ 1, 3 ] == nil .OR. aTotIva[ 1, 3 ] == nIvaMan
         aTotIva[ 1, 3 ]   := nIvaMan
         aTotIva[ 1, 2 ]   += nBaseGasto
         aTotIva[ 1, 8 ]   += nIvaGasto

      case aTotIva[ 2, 3 ] == nil .OR. aTotIva[ 2, 3 ] == nIvaMan
         aTotIva[ 2, 3 ]   := nIvaMan
         aTotIva[ 2, 2 ]   += nBaseGasto
         aTotIva[ 2, 8 ]   += nIvaGasto

      case aTotIva[ 3, 3 ] == nil .OR. aTotIva[ 3, 3 ] == nIvaMan
         aTotIva[ 3, 3 ]   := nIvaMan
         aTotIva[ 3, 2 ]   += nBaseGasto
         aTotIva[ 3, 8 ]   += nIvaGasto

      end

   end





   nTotNet           := Round( aTotIva[ 1, 2 ] + aTotIva[ 2, 2 ] + aTotIva[ 3, 2 ], nRouDiv )





   if nKgsTrn <> 0
      nTotDif        := nKgsTrn - nTotPes
   else
      nTotDif        := 0
   end





   nTotIvm           := Round( aTotIvm[ 1, 3 ] + aTotIvm[ 2, 3 ] + aTotIvm[ 3, 3 ], nRouDiv )





   nTotTrn           := Round( aTotIva[ 1, 7 ] + aTotIva[ 2, 7 ] + aTotIva[ 3, 7 ], nRouDiv )





   nTotPnt           := Round( aTotIva[ 1, 5 ] + aTotIva[ 2, 5 ] + aTotIva[ 3, 5 ], nRouDiv )





   nTotIva           := Round( aTotIva[ 1, 8 ] + aTotIva[ 2, 8 ] + aTotIva[ 3, 8 ], nRouDiv )





   nTotReq           := Round( aTotIva[ 1, 9 ] + aTotIva[ 2, 9 ] + aTotIva[ 3, 9 ], nRouDiv )





   nTotImp           := Round( nTotIva + nTotReq + nTotIvm, nRouDiv )





   nTotRnt           := Round(  nTotNet - nManObr - nTotAge - nTotPnt - nTotAtp - nTotCos, nRouDiv )

   nPctRnt           := nRentabilidad( nTotNet - nManObr - nTotAge - nTotPnt, nTotAtp, nTotCos )





   nTotSat           := nTotNet + nTotImp





   nTotalDto         := nDescuentosLineas + nTotDto + nTotDpp + nTotUno + nTotDos + nTotAtp

   ( cSatCliL )->( dbGoTo( nRecno) )





   if cDivRet <> nil .AND. cDivRet <> cCodDiv
      nTotNet     := nCnv2Div( nTotNet, cCodDiv, cDivRet )
      nTotIvm     := nCnv2Div( nTotIvm, cCodDiv, cDivRet )
      nTotIva     := nCnv2Div( nTotIva, cCodDiv, cDivRet )
      nTotReq     := nCnv2Div( nTotReq, cCodDiv, cDivRet )
      nTotSat     := nCnv2Div( nTotSat, cCodDiv, cDivRet )
      nTotPnt     := nCnv2Div( nTotPnt, cCodDiv, cDivRet )
      nTotTrn     := nCnv2Div( nTotTrn, cCodDiv, cDivRet )
      cPorDiv     := cPorDiv( cDivRet, cDiv )
   end

RETURN ( if( lPic, Trans( nTotSat, cPorDiv ), nTotSat ) )



FUNCTION aTotSatCli( cSat, dbfMaster, dbfLine, dbfIva, dbfDiv, dbfFPago, cDivRet )

   nTotSatCli( cSat, dbfMaster, dbfLine, dbfIva, dbfDiv, dbfFPago, nil, cDivRet )

RETURN ( { nTotNet, nTotIva, nTotReq, nTotSat, nTotPnt, nTotTrn, nTotAge, nTotCos } )



FUNCTION BrwSatCli( oGet, cSatCliT, cSatCliL, dbfIva, dbfDiv, dbfFPago, oIva )

   local oDlg
   local oBrw
   local oGet1
   local cGet1
   local nOrd     := GetBrwOpt( "BrwSatCli" )
   local lIva     := oIva:VarGet()
   local oCbxOrd
   local aCbxOrd  := { "Número", "Fecha", "Cliente", "Nombre" }
   local cCbxOrd
   local nOrdAnt
   local nRecAnt

   nOrd           := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd        := aCbxOrd[ nOrd ]
   nOrdAnt        := ( cSatCliT )->( OrdSetFocus( nOrd ) )
   nRecAnt        := ( cSatCliT )->( Recno() )

   ( cSatCliT )->( dbSetFilter( {|| !Field->lEstado .AND. Field->lIvaInc == lIva }, "!lEstado .and. lIvaInc == lIva" ) )
   ( cSatCliT )->( dbGoTop() )

   oDlg = TDialog():New(,,,, if( lIva, "S.A.T. de clientes con " + cImp() + " incluido", "S.A.T. de clientes con " + cImp() + " desglosado" ), "HELPENTRY",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )






      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,, {||    ( OrdClearScope( oBrw, cSatCliT ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, cSatCliT, .T., nil, .F. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






      oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( cSatCliT )->( ordSetFocus( oCbxOrd:nAt ) ), oBrw:Refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                 := IXBrowse():New( oDlg )

      oBrw:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias          := cSatCliT
      oBrw:nMarqueeStyle   := 5
      oBrw:cName           := "SAT a cliente.Browse"

      oBrw:bLDblClick      := {|| oDlg:end( 1 ) }

      oBrw:CreateFromResource( 105 )

      with object ( oBrw:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := "nNumSat"
         :bEditValue       := {|| ( cSatCliT )->cSerSat + "/" + AllTrim( Str( ( cSatCliT )->nNumSat ) ) + "/" + ( cSatCliT )->cSufSat }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecSat"
         :bEditValue       := {|| dtoc( ( cSatCliT )->dFecSat ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := "cCodCli"
         :bEditValue       := {|| AllTrim( ( cSatCliT )->cCodCli ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomCli"
         :bEditValue       := {|| AllTrim( ( cSatCliT )->cNomCli ) }
         :nWidth           := 300
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotSatCli( ( cSatCliT )->cSerSat + Str( ( cSatCliT )->nNumSat ) + ( cSatCliT )->cSufSat, cSatCliT, cSatCliL, dbfIva, dbfDiv, dbfFPago, nil, cDivEmp(), .T. ) }
         :nWidth           := 100
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )




      TButton():ReDefine( 500,, oDlg,,, .F., {||     .F.},,, .F. )




      TButton():ReDefine( 501,, oDlg,,, .F., {||     .F.},,, .F. )

   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( oBrw:Load() )}, oDlg:bRClicked,,, )

   DestroyFastFilter( cSatCliT )

   SetBrwOpt( "BrwSatCli", ( cSatCliT )->( OrdNumber() ) )

   if oDlg:nResult == 1
      oGet:cText( ( cSatCliT )->cSerSat + Str( ( cSatCliT )->nNumSat ) + ( cSatCliT )->cSufSat )
      oGet:lValid()
   end

   ( cSatCliT )->( dbClearFilter() )
   ( cSatCliT )->( ordSetFocus( nOrdAnt ) )
   ( cSatCliT )->( dbGoTo( nRecAnt ) )

RETURN ( oDlg:nResult == 1 )



FUNCTION ChgSatCli( cSat, nMode, cSatCliT )

   local oBlock
   local oError
   local lExito := .T.
   local lClose := .F.

   IF nMode <> 1 .OR. Empty( cSat )
      RETURN NIL
   end

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   IF cSatCliT == NIL

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SATCLI.DBF" ), ( cCheckArea( "SATCLI", @cSatCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "SATCLI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      lClose := .T.

   end

   IF (cSatCliT)->( dbSeek( cSat ) )
      if dbDialogLock( cSatCliT )
         (cSatCliT)->lEstado   := .T.
         (cSatCliT)->( dbUnLock() )
      end
   ELSE
      lExito := .F.
   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   IF lClose
      (cSatCliT)->( dbCloseArea() )
   end

RETURN lExito



FUNCTION nTotUSatCli( uTmpLin, nDec, nVdv )

   local nCalculo       := 0

   If( uTmpLin == nil, uTmpLin := D():SatClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   do case
      case Valtype( uTmpLin ) == "C"

         if ( uTmpLin )->lAlquiler
            nCalculo    := ( uTmpLin )->nPreAlq
         else
            nCalculo    := ( uTmpLin )->nPreDiv
         end

      case Valtype( uTmpLin ) == "O"

         if uTmpLin:lAlquiler
            nCalculo    := uTmpLin:nPreAlq
         else
            nCalculo    := uTmpLin:nPreDiv
         end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nImpUSatCli( uTmpLin, nDec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ValType( uTmpLin ) == "C"

      if ( uTmpLin )->lAlquiler
         nCalculo    := ( uTmpLin )->nPreAlq
      else
         nCalculo    := ( uTmpLin )->nPreDiv
      end

      if ( uTmpLin )->lIvaLin

         if ( uTmpLin )->nIva <> 0
            nCalculo -= nCalculo / ( 100 / ( uTmpLin )->nIva + 1 )
         end

         if ( uTmpLin )->nValImp <> 0
            nCalculo -= ( uTmpLin )->nValImp
         end

      end

   else

      if uTmpLin:lAlquiler
         nCalculo    := uTmpLin:nPreAlq
      else
         nCalculo    := uTmpLin:nPreDiv
      end

      if uTmpLin:lIvaLin

         if uTmpLin:nIva <> 0
            nCalculo -= nCalculo / ( 100 / uTmpLin:nIva + 1 )
         end

         if uTmpLin:nValImp <> 0
            nCalculo -= uTmpLin:nValImp
         end

      end

   end

   nCalculo          := Round( nCalculo / nVdv, nDec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nBrtLSatCli( uTmpLin, nDec, nRec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nImpUSatCli( uTmpLin, nDec, nVdv, cPorDiv )
   nCalculo          *= nTotNSatCli( uTmpLin )

   nCalculo          := Round( nCalculo / nVdv, nRec )

Return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nIvaUSatCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := nTotUSatCli( dbfTmpLin, nDec, nVdv )
   nCalculo       := nCalculo * ( dbfTmpLin )->nIva / 100

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )






FUNCTION nTotFSatCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPorDiv )

   local nCalculo    := 0

   If( dbfLin == nil, dbfLin := D():SatClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .T., ) ;
   If( lImpTrn == nil, lImpTrn := .T., ) ;

   nCalculo          += nTotLSatCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )
   nCalculo          += nIvaLSatCli( dbfLin, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn )


return ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )




FUNCTION cDesSatCli( cSatCliL, cSatCliS )

   If( cSatCliL == nil, cSatCliL := D():SatClientesLineas( nView ), ) ;
   If( cSatCliS == nil, cSatCliS := dbfSatCliS, ) ;

RETURN ( Descrip( cSatCliL, cSatCliS ) )



FUNCTION cDesSatCliLeng( cSatCliL, cSatCliS, cArtLeng )

   If( cSatCliL == nil, cSatCliL := D():SatClientesLineas( nView ), ) ;
   If( cSatCliS == nil, cSatCliS := dbfSatCliS, ) ;
   If( cArtLeng == nil, cArtLeng := D():ArticuloLenguaje( nView ), ) ;

RETURN ( DescripLeng( cSatCliL, cSatCliS, cArtLeng ) )



Function isLineaTotalSatCli( uSatCliL )

   if isArray( uSatCliL )
      Return ( uSatCliL[ 23 ] )
   end

Return ( ( uSatCliL )->lTotLin )



Function nDescuentoLinealSatCli( uSatCliL, nDec, nVdv )

   local nDescuentoLineal

   if isArray( uSatCliL )
      nDescuentoLineal  := uSatCliL[ 30 ]
   else
      nDescuentoLineal  := ( uSatCliL )->nDtoDiv
   end

Return ( Round( nDescuentoLineal / nVdv, nDec ) )



Function nDescuentoPorcentualSatCli( uSatCliL )

   local nDescuentoPorcentual

   if isArray( uSatCliL )
      nDescuentoPorcentual  := uSatCliL[ 14 ]
   else
      nDescuentoPorcentual  := ( uSatCliL )->nDto
   end

Return ( nDescuentoPorcentual )



Function nDescuentoPromocionSatCli( uSatCliL )

   local nDescuentoPromocion

   if isArray( uSatCliL )
      nDescuentoPromocion  := uSatCliL[ 15 ]
   else
      nDescuentoPromocion  := ( uSatCliL )->nDtoPrm
   end

Return ( nDescuentoPromocion )



Function nPuntoVerdeSatCli( uSatCliL )

   local nPuntoVerde

   if isArray( uSatCliL )
      nPuntoVerde  := uSatCliL[ 12 ]
   else
      nPuntoVerde  := ( uSatCliL )->nPntVer
   end

Return ( nPuntoVerde )



Function nTransporteSatCli( uSatCliL )

   local nTransporte

   if isArray( uSatCliL )
      nTransporte  := uSatCliL[ 13 ]
   else
      nTransporte  := ( uSatCliL )->nImpTrn
   end

Return ( nTransporte )



FUNCTION nTotLSatCli( uSatCliL, nDec, nRou, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo
   local nUnidades

   If( uSatCliL == nil, uSatCliL := D():SatClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .T., ) ;
   If( lImpTrn == nil, lImpTrn := .T., ) ;

   if isLineaTotalSatCli( uSatCliL )

      nCalculo          := nTotUSatCli( uSatCliL, nDec, nVdv )

   else

      nUnidades         := nTotNSatCli( uSatCliL )
      nCalculo          := nTotUSatCli( uSatCliL, nDec, nVdv ) * nUnidades





      nCalculo          -= nDescuentoLinealSatCli( uSatCliL, nDec, nVdv ) * nUnidades

      if lDto .AND. nDescuentoPorcentualSatCli( uSatCliL ) <> 0
         nCalculo       -= nCalculo * nDescuentoPorcentualSatCli( uSatCliL ) / 100
      end

      if lDto .AND. nDescuentoPromocionSatCli( uSatCliL ) <> 0
         nCalculo       -= nCalculo * nDescuentoPromocionSatCli( uSatCliL ) / 100
      end





      if lPntVer .AND. nPuntoVerdeSatCli( uSatCliL ) <> 0
         nCalculo       += nPuntoVerdeSatCli( uSatCliL ) * nUnidades
      end





      if lImpTrn .AND. nTransporteSatCli( uSatCliL ) <> 0
         nCalculo       += nTransporteSatCli( uSatCliL ) * nUnidades
      end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   if nRou <> nil
      nCalculo          := Round( nCalculo, nRou )
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )








FUNCTION nPrmLSatCli( cSatCliL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cSatCliL == nil, cSatCliL := D():SatClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cSatCliL )->nDtoPrm <> 0 .AND. !( cSatCliL )->lTotLin

      nCalculo          := nTotUSatCli( cSatCliL, nDec ) * nTotNSatCli( cSatCliL )





      nCalculo          -= Round( ( cSatCliL )->nDtoDiv / nVdv , nDec )

      if ( cSatCliL )->nDto <> 0
         nCalculo       -= nCalculo * ( cSatCliL )->nDto / 100
      end

      nCalculo          := nCalculo * ( cSatCliL )->nDtoPrm / 100

      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )



FUNCTION nTotCSatCli( dbfLine, nDec, nRec, nVdv, cPouDiv )

   local nCalculo       := 0

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRec == nil, nRec := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if !( dbfLine )->lKitChl
      nCalculo          := nTotNSatCli( dbfLine )
      nCalculo          *= ( dbfLine )->nCosDiv
   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

   nCalculo             := Round( nCalculo, nRec )

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nPesLSatCli( cSatCliL )

   local nCalculo    := 0

   If( cSatCliL == nil, cSatCliL := D():SatClientesLineas( nView ), ) ;

   if !( cSatCliL )->lTotLin .AND. !( cSatCliL )->lControl
      nCalculo       := Abs( nTotNSatCli( cSatCliL ) ) * ( cSatCliL )->nPesoKg
   end

RETURN ( nCalculo )



FUNCTION nVolLSatCli( dbfLine )

   local nCalculo    := 0

   if !( dbfLine )->lTotLin .AND. !( dbfLine )->lControl
      nCalculo       := nTotNSatCli( dbfLine ) * ( dbfLine )->nVolumen
   end

RETURN ( nCalculo )



FUNCTION nIvaLSatCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo    := 0

   if ( dbfLin )->nRegIva <= 1

      nCalculo          := nTotLSatCli( dbfLin, nDec, nRouDec, nVdv, lDto, lPntVer, lImpTrn, cPouDiv )

      if !( dbfLin )->lIvaLin
         nCalculo    := nCalculo * ( dbfLin )->nIva / 100
      else
         nCalculo    -= nCalculo / ( 1 + ( dbfLin )->nIva / 100 )
      end

   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



Function nPntUSatCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nPntVer

   IF nVdv <> 0
      nCalculo    := ( dbfTmpLin )->nPntVer / nVdv
   end

RETURN ( round( nCalculo, nDec ) )



FUNCTION nPntLSatCli( dbfLin, nDec, nVdv )

   local nPntVer

   If( dbfLin == nil, dbfLin := D():SatClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;





   nPntVer           := nPntUSatCli( dbfLin, nDec, nVdv )
   nPntVer           *= nTotNSatCli( dbfLin )

RETURN ( Round( nPntVer, nDec ) )



FUNCTION nTrnUSatCli( dbfTmpLin, nDec, nVdv )

   local nCalculo

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo       := ( dbfTmpLin )->nImpTrn

   IF nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nDec ) )



FUNCTION nDtoUSatCli( dbfTmpLin, nDec, nVdv )

   local nCalculo := ( dbfTmpLin )->nDtoDiv

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if nVdv <> 0
      nCalculo    /= nVdv
   end

RETURN ( round( nCalculo, nDec ) )



FUNCTION nTrnLSatCli( dbfLin, nDec, nRou, nVdv )

   local nImpTrn

   If( dbfLin == nil, dbfLin := D():SatClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;





   nImpTrn           := nTrnUSatCli( dbfLin, nDec ) * nTotNSatCli( dbfLin )

   IF nVdv <> 0
      nImpTrn        := nImpTrn / nVdv
   end

RETURN ( Round( nImpTrn, nRou ) )






FUNCTION nDtoLSatCli( cSatCliL, nDec, nRou, nVdv )

   local nCalculo       := 0

   If( cSatCliL == nil, cSatCliL := D():SatClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   if ( cSatCliL )->nDto <> 0 .AND. !( cSatCliL )->lTotLin

      nCalculo          := nTotUSatCli( cSatCliL, nDec ) * nTotNSatCli( cSatCliL )





      nCalculo          -= Round( ( cSatCliL )->nDtoDiv / nVdv , nDec )

      nCalculo          := nCalculo * ( cSatCliL )->nDto / 100


      if nVdv <> 0
         nCalculo       := nCalculo / nVdv
      end

      if nRou <> nil
         nCalculo       := Round( nCalculo, nRou )
      end

   end

RETURN ( nCalculo )



FUNCTION mkSatCli( cPath, lAppend, cPathOld, oMeter, bFor )

   local cSatCliT
   local cSatCliL

   local oldSatCliT
   local oldSatCliL
   local oldSatCliI
   local oldSatCliD

   if oMeter <> NIL
      oMeter:cText   := "Generando Bases"
      sysrefresh()
   end

   If( lAppend == nil, lAppend := .F., ) ;
   If( bFor == nil, bFor := {|| .T. }, ) ;

   createFiles( cPath )

   rxSatCli( cPath, cLocalDriver() )

   if lAppend .AND. lIsDir( cPathOld )

      dbUseArea( .T., cDriver(), cPath + "SATCLIT.DBF", cCheckArea( "SATCLIT", @cSatCliT ), .F. )
      if !( cSatCliT )->( neterr() )
         ( cSatCliT )->( ordListAdd( cPath + "SATCLIT.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "SatCliL.DBF", cCheckArea( "SatCliL", @cSatCliL ), .F. )
      if !( cSatCliL )->( neterr() )
         ( cSatCliL )->( ordListAdd( cPath + "SatCliL.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "SatCliI.Dbf", cCheckArea( "SatCliI", @dbfSatCliI ), .F. )
      if !( dbfSatCliI )->( neterr() )
         ( dbfSatCliI )->( ordListAdd( cPath + "SatCliI.Cdx" ) )
      end

      dbUseArea( .T., cDriver(), cPath + "SatCliD.Dbf", cCheckArea( "SatCliD", @dbfSatCliD ), .F. )
      if !( dbfSatCliD )->( neterr() )
         ( dbfSatCliD )->( ordListAdd( cPath + "SatCliD.Cdx" ) )
      end





      dbUseArea( .T., cDriver(), cPathOld + "SatCliT.DBF", cCheckArea( "SatCliT", @oldSatCliT ), .F. )
      if !( cSatCliT )->( neterr() )
         ( oldSatCliT )->( ordListAdd( cPathOld + "SatCliT.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "SatCliL.DBF", cCheckArea( "SatCliL", @oldSatCliL ), .F. )
      if !( oldSatCliL )->( neterr() )
         ( oldSatCliL )->( ordListAdd( cPathOld + "SatCliL.CDX" ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "SatCliI.DBF", cCheckArea( "SatCliI", @oldSatCliI ), .F. )
      if !( oldSatCliI )->( neterr() )
         ( oldSatCliI )->( ordListAdd( cPathOld + "SatCliI.CDX"  ) )
      end

      dbUseArea( .T., cDriver(), cPathOld + "SatCliD.DBF", cCheckArea( "SatCliD", @oldSatCliD ), .F. )
      if !( oldSatCliD )->( neterr() )
         ( oldSatCliD )->( ordListAdd( cPathOld + "SatCliD.CDX"  ) )
      end





      while !( oldSatCliT )->( eof() )

         if eval( bFor, oldSatCliT )

            dbCopy( oldSatCliT, cSatCliT, .T. )

            if ( oldSatCliL )->( dbSeek( ( oldSatCliT )->cSerSat + Str( ( oldSatCliT )->nNumSat ) + ( oldSatCliT )->cSufSat ) )
               while ( oldSatCliL )->cSerSat + Str( ( oldSatCliL )->nNumSat ) + ( oldSatCliL )->cSufSat == ( oldSatCliT )->cSerSat + Str( ( oldSatCliT )->nNumSat ) + ( oldSatCliT )->cSufSat .AND. !( oldSatCliL )->( eof() )
                  dbCopy( oldSatCliL, cSatCliL, .T. )
                  ( oldSatCliL )->( dbSkip() )
               end
            end

            if ( oldSatCliI )->( dbSeek( ( oldSatCliT )->cSerSat + Str( ( oldSatCliT )->nNumSat ) + ( oldSatCliT )->cSufSat ) )
               while ( oldSatCliI )->cSerSat + Str( ( oldSatCliI )->nNumSat ) + ( oldSatCliI )->cSufSat == ( oldSatCliT )->cSerSat + Str( ( oldSatCliT )->nNumSat ) + ( oldSatCliT )->cSufSat .AND. !( oldSatCliI )->( eof() )
                  dbCopy( oldSatCliI, dbfSatCliI, .T. )
                  ( oldSatCliI )->( dbSkip() )
               end
            end

            if ( oldSatCliD )->( dbSeek( ( oldSatCliT )->cSerSat + Str( ( oldSatCliT )->nNumSat ) + ( oldSatCliT )->cSufSat ) )
               while ( oldSatCliD )->cSerSat + Str( ( oldSatCliD )->nNumSat ) + ( oldSatCliD )->cSufSat == ( oldSatCliT )->cSerSat + Str( ( oldSatCliT )->nNumSat ) + ( oldSatCliT )->cSufSat .AND. !( oldSatCliI )->( eof() )
                  dbCopy( oldSatCliD, dbfSatCliD, .T. )
                  ( oldSatCliD )->( dbSkip() )
               end
            end

         end

         ( oldSatCliT )->( dbSkip() )

      end

      ( cSatCliT )->( dbCloseArea() )
      ( cSatCliL )->( dbCloseArea() )
      ( dbfSatCliI )->( dbCloseArea() )
      ( dbfSatCliD )->( dbCloseArea() )

      ( oldSatCliT )->( dbCloseArea() )
      ( oldSatCliL )->( dbCloseArea() )
      ( oldSatCliI )->( dbCloseArea() )
      ( oldSatCliD )->( dbCloseArea() )

   end

Return Nil



FUNCTION rxSatCli( cPath, cDriver )

   local cSatCliT

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;




   if !lExistTable( cPath + "SatCliT.Dbf", cDriver ) .OR.  !lExistTable( cPath + "SatCliL.Dbf", cDriver ) .OR.  !lExistTable( cPath + "SatCliI.Dbf", cDriver ) .OR.  !lExistTable( cPath + "SatCliD.Dbf", cDriver )
      __Run( 'lExistTable( cPath + "SatCliS.Dbf", cDriver )' )
      createFiles( cPath )
   end

   fEraseIndex( cPath + "SatCliT.Cdx", cDriver )
   fEraseIndex( cPath + "SatCliL.Cdx", cDriver )
   fEraseIndex( cPath + "SatCliI.Cdx", cDriver )
   fEraseIndex( cPath + "SatCliD.Cdx", cDriver )
   fEraseIndex( cPath + "SatCliS.Cdx", cDriver )

   dbUseArea( .T., cDriver, cPath + "SATCLIT.DBF", cCheckArea( "SATCLIT", @cSatCliT ), .F. )
   if !( cSatCliT )->( neterr() )
      ( cSatCliT )->( __dbPack() )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLIT.CDX", "NNUMSAT", "CSERSAT + STR( NNUMSAT ) + CSUFSAT", {|| Field->CSERSAT + STR(Field->NNUMSAT) + Field->CSUFSAT } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLIT.CDX", "DFECSAT", "DFECSAT", {|| Field->DFECSAT } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLIT.CDX", "CCODCLI", "CCODCLI + Dtos( dFecSat )", {|| Field->CCODCLI + Dtos( Field->dFecSat ) } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLIT.CDX", "CNOMCLI", "cNomCli + Dtos( dFecSat )", {|| Field->cNomCli + Dtos( Field->dFecSat ) } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLIT.CDX", "cCodObr", "cCodObr", {|| Field->cCodObr } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLIT.CDX", "cCodAge", "cCodAge", {|| Field->cCodAge } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLIT.CDX", "CTURSAT", "CTURSAT + CSUFSAT + cCodCaj", {|| Field->CTURSAT + Field->CSUFSAT + Field->cCodCaj } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.CDX", "lSndDoc", "lSndDoc", {|| Field->lSndDoc } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.Cdx", "cCodUsr", "cCodUsr + Dtos( dFecCre ) + cTimCre", {|| Field->cCodUsr + Dtos( Field->dFecCre ) + Field->cTimCre } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.Cdx", "cNumAlb", "cNumAlb", {|| Field->cNumAlb } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.Cdx", "iNumSat", "'32' + cSerSat + Str( nNumSat ) + Space( 1 ) + cSufSat", {|| "32" + Field->cSerSat + Str( Field->nNumSat ) + Space( 1 ) + Field->cSufSat } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.Cdx", "cCodOpe", "cCodOpe", {|| Field->cCodOpe } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.Cdx", "cCodCat", "cCodCat", {|| Field->cCodCat } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.Cdx", "cSituac", "cSituac", {|| Field->cSituac } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.Cdx", "cCodEst", "cCodEst", {|| Field->cCodEst } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() }, , , , , , , , , .T. ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.Cdx", "cNumDes", "CSERSAT + STR( NNUMSAT ) + CSUFSAT", {|| Field->CSERSAT + STR(Field->NNUMSAT) + Field->CSUFSAT } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.CDX", "Poblacion", "UPPER( Field->cPobCli )", {|| UPPER( Field->cPobCli ) } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.CDX", "Provincia", "UPPER( Field->cPrvCli )", {|| UPPER( Field->cPrvCli ) } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliT.CDX", "CodPostal", "Field->cPosCli", {|| Field->cPosCli } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}, , , , , , , , , .T.  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLIT.CDX", "DDESFEC", "DFECSAT", {|| Field->DFECSAT } ) )

      ( cSatCliT )->( dbCloseArea() )

   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de S.A.T. de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "SATCLIL.DBF", cCheckArea( "SATCLIL", @cSatCliT ), .F. )
   if !( cSatCliT )->( neterr() )
      ( cSatCliT )->( __dbPack() )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliL.Cdx", "NNUMSAT", "CSERSAT + STR( NNUMSAT ) + CSUFSAT", {|| Field->CSERSAT + STR( Field->NNUMSAT ) + Field->CSUFSAT } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliL.Cdx", "CREF", "CREF", {|| Field->CREF }, ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliL.Cdx", "Lote", "cLote", {|| Field->cLote }, ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliL.Cdx", "iNumSat", "'32' + cSerSat + Str( nNumSat ) + Space( 1 ) + cSufSat + Str( nNumLin )", {|| "32" + Field->cSerSat + Str( Field->nNumSat ) + Space( 1 ) + Field->cSufSat + Str( Field->nNumLin ) } ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliL.Cdx", "nNumLin", "Str( NNUMSAT ) + Str( nNumLin )", {|| Str( Field->nNumSat ) + Str( Field->nNumLin ) }, ) )

      ( cSatCliT )->( ordCondSet("!Deleted() .and. NCTLSTK == 2", {||!Deleted() .AND. Field->NCTLSTK == 2 }  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliL.Cdx", "cCodCli", "cCodCli", {|| Field->cCodCli }, ) )

      ( cSatCliT )->( ordCondSet("!Deleted() .and. NCTLSTK == 2", {||!Deleted() .AND. Field->NCTLSTK == 2 }  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliL.Cdx", "cCliArt", "cCodCli + cRef", {|| Field->cCodCli + Field->cRef }, ) )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliL.Cdx", "nPosPrint", "cSerSat + Str( nNumSat ) + cSufSat + Str( nPosPrint )", {|| Field->cSerSat + Str( Field->nNumSat ) + Field->cSufSat + Str( Field->nPosPrint ) } ) )

      ( cSatCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de S.A.T. de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "SATCLII.DBF", cCheckArea( "SATCLII", @cSatCliT ), .F. )
   if !( cSatCliT )->( neterr() )
      ( cSatCliT )->( __dbPack() )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLII.CDX", "NNUMSAT", "CSERSAT + STR( NNUMSAT ) + CSUFSAT", {|| Field->CSERSAT + STR(Field->NNUMSAT) + Field->CSUFSAT } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliI.Cdx", "iNumSat", "'32' + cSerSat + Str( nNumSat ) + Space( 1 ) + cSufSat", {|| "32" + Field->cSerSat + Str( Field->nNumSat ) + Space( 1 ) + Field->cSufSat } ) )

      ( cSatCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de S.A.T. de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "SATCLID.DBF", cCheckArea( "SATCLID", @cSatCliT ), .F. )
   if !( cSatCliT )->( neterr() )
      ( cSatCliT )->( __dbPack() )

      ( cSatCliT )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SATCLID.CDX", "NNUMSAT", "CSERSAT + STR( NNUMSAT ) + CSUFSAT", {|| Field->CSERSAT + STR(Field->NNUMSAT) + Field->CSUFSAT } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliD.Cdx", "iNumSat", "'32' + cSerSat + Str( nNumSat ) + Space( 1 ) + cSufSat", {|| "32" + Field->cSerSat + Str( Field->nNumSat ) + Space( 1 ) + Field->cSufSat } ) )

      ( cSatCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de S.A.T. de clientes" )
   end

   dbUseArea( .T., cDriver, cPath + "SatCliS.Dbf", cCheckArea( "SatCliS", @cSatCliT ), .F. )

   if !( cSatCliT )->( neterr() )
      ( cSatCliT )->( __dbPack() )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliS.CDX", "nNumSat", "cSerSat + Str( nNumSat ) + cSufSat + Str( nNumLin )", {|| Field->cSerSat + Str( Field->nNumSat ) + Field->cSufSat + Str( Field->nNumLin ) } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| ! !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliS.CDX", "cRefSer", "cRef + cAlmLin + cNumSer", {|| Field->cRef + Field->cAlmLin + Field->cNumSer } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliS.CDX", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliS.Cdx", "iNumSat", "'32' + cSerSat + Str( nNumSat ) + Space( 1 ) + cSufSat", {|| "32" + Field->cSerSat + Str( Field->nNumSat ) + Space( 1 ) + Field->cSufSat } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliS.CDX", "nNumRef", "cSerSat + Str( nNumSat ) + cSufSat + cRef + Str( nNumLin )", {|| Field->cSerSat + Str( Field->nNumSat ) + Field->cSufSat + Field->cRef + + Str( Field->nNumLin ) } ) )

      ( cSatCliT )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( cSatCliT )->( ordCreate( cPath + "SatCliS.CDX", "cRef", "cRef + cNumSer", {|| Field->cRef + Field->cNumSer } ) )

      ( cSatCliT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de numeros de series de Sataranes de clientes" )
   end

RETURN NIL



FUNCTION nTotNSatCli( uDbf )

   local nTotUnd

   If( uDbf == nil, uDbf := D():SatClientesLineas( nView ), ) ;

   do case
      case ValType( uDbf ) == "A"

         nTotUnd  := NotBulto( uDbf[ 80 ] )
         nTotUnd  *= NotCaja( uDbf[ 7 ] )
         nTotUnd  *= uDbf[ 8 ]
         nTotUnd  *= NotCero( uDbf[ 10 ] )
         nTotUnd  *= NotCero( uDbf[ 70 ] )
         nTotUnd  *= NotCero( uDbf[ 71 ] )
         nTotUnd  *= NotCero( uDbf[ 72 ] )

      case ValType( uDbf ) == "O"

         nTotUnd  := NotBulto( uDbf:nBultos )
         nTotUnd  *= NotCaja( uDbf:nCanSat )
         nTotUnd  *= uDbf:nUniCaja
         nTotUnd  *= NotCero( uDbf:nUndKit )
         nTotUnd  *= NotCero( uDbf:nMedUno )
         nTotUnd  *= NotCero( uDbf:nMedDos )
         nTotUnd  *= NotCero( uDbf:nMedTre )

      otherwise

         nTotUnd  := NotBulto( ( uDbf )->nBultos )
         nTotUnd  *= NotCaja( ( uDbf )->nCanSat )
         nTotUnd  *= ( uDbf )->nUniCaja
         nTotUnd  *= NotCero( ( uDbf )->nUndKit )
         nTotUnd  *= NotCero( ( uDbf )->nMedUno )
         nTotUnd  *= NotCero( ( uDbf )->nMedDos )
         nTotUnd  *= NotCero( ( uDbf )->nMedTre )

   end

RETURN ( nTotUnd )



FUNCTION nTotISatCli( dbfLin, nDec, nRouDec, nVdv, cPorDiv )

   local nCalculo    := 0

   If( dbfLin == nil, dbfLin := D():SatClientesLineas( nView ), ) ;
   If( nDec == nil, nDec := 0, ) ;
   If( nRouDec == nil, nRouDec := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   IF !( dbfLin )->LTOTLIN





      nCalculo       := Round( ( dbfLin )->nValImp, nDec )





      nCalculo       *= nTotNSatCli( dbfLin )

         if ( dbfLin )->LVOLIMP
            nCalculo *= NotCero( ( dbfLin )->nVolumen )
         end

      nCalculo       := Round( nCalculo / nVdv, nRouDec )

   end

RETURN ( if( cPorDiv <> NIL, Trans( nCalculo, cPorDiv ), nCalculo ) )



FUNCTION nImpLSatCli( uSatCliT, cSatCliL, nDec, nRou, nVdv, lIva, lDto, lPntVer, lImpTrn, cPouDiv )

   local nCalculo
   local lIvaInc

   If( nDec == nil, nDec := 0, ) ;
   If( nRou == nil, nRou := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lIva == nil, lIva := .F., ) ;
   If( lDto == nil, lDto := .T., ) ;
   If( lPntVer == nil, lPntVer := .F., ) ;
   If( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo          := nTotLSatCli( cSatCliL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if ValType( uSatCliT ) == "A"
      nCalculo       -= Round( nCalculo * uSatCliT[ 30 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uSatCliT[ 32    ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uSatCliT[ 34 ]  / 100, nRou )
      nCalculo       -= Round( nCalculo * uSatCliT[ 36 ]  / 100, nRou )
      lIvaInc        := uSatCliT[ 52 ]
   else
      nCalculo       -= Round( nCalculo * ( uSatCliT )->nDtoEsp / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uSatCliT )->nDpp    / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uSatCliT )->nDtoUno / 100, nRou )
      nCalculo       -= Round( nCalculo * ( uSatCliT )->nDtoDos / 100, nRou )
      lIvaInc        := ( uSatCliT )->lIvaInc
   end

   if ( cSatCliL )->nIva <> 0
      if lIva
         if !lIvaInc
            nCalculo += Round( nCalculo * ( cSatCliL )->nIva / 100, nRou )
         end
      else
         if lIvaInc
            nCalculo -= Round( nCalculo / ( 100 / ( cSatCliL )->nIva  + 1 ), nRou )
         end
      end
   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nDtoAtpSatCli( uSatCliT, cSatCliL, nDec, nRou, nVdv, lPntVer, lImpTrn )

   local nCalculo    := 0
   local nDtoAtp     := 0

   If( nDec == nil, nDec := 0, ) ;
   If( nRou == nil, nRou := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( lPntVer == nil, lPntVer := .F., ) ;
   If( lImpTrn == nil, lImpTrn := .F., ) ;

   nCalculo          := nTotLSatCli( cSatCliL, nDec, nRou, nVdv, .T., lPntVer, lImpTrn )

   if ( uSatCliT )->nSbrAtp <= 1 .AND. ( uSatCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uSatCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uSatCliT )->nDtoEsp / 100, nRou )

   if ( uSatCliT )->nSbrAtp == 2 .AND. ( uSatCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uSatCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uSatCliT )->nDpp    / 100, nRou )

   if ( uSatCliT )->nSbrAtp == 3 .AND. ( uSatCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uSatCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uSatCliT )->nDtoUno / 100, nRou )

   if ( uSatCliT )->nSbrAtp == 4 .AND. ( uSatCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uSatCliT )->nDtoAtp / 100, nRou )
   end

   nCalculo       -= Round( nCalculo * ( uSatCliT )->nDtoDos / 100, nRou )

   if ( uSatCliT )->nSbrAtp == 5 .AND. ( uSatCliT )->nDtoAtp <> 0
      nDtoAtp     += Round( nCalculo * ( uSatCliT )->nDtoAtp / 100, nRou )
   end

RETURN ( nDtoAtp )



FUNCTION nComLSatCli( cSatCliT, cSatCliL, nDecOut, nDerOut )

   local nImp        := nImpLSatCli( cSatCliT, cSatCliL, nDecOut, nDerOut )

RETURN ( nImp * ( cSatCliL )->nComAge / 100 )



FUNCTION dFecSatCli( cSatCli, cSatCliT )

   local dFecSat  := CtoD("")

   IF ( cSatCliT )->( dbSeek( cSatCli ) )
      dFecSat  := ( cSatCliT )->dFecSat
   end

RETURN ( dFecSat )



FUNCTION lEstSatCli( cSatCli, cSatCliT )

   local lEstSat  := .F.

   IF ( cSatCliT )->( dbSeek( cSatCli ) )
      lEstSat     := ( cSatCliT )->lEstado
   end

RETURN ( lEstSat )



FUNCTION cNbrSatCli( cSatCli, cSatCliT )

   local cNomCli  := ""

   IF ( cSatCliT )->( dbSeek( cSatCli ) )
      cNomCli  := ( cSatCliT )->CNOMCLI
   end

RETURN ( cNomCli )






function nTotDSatCli( cCodArt, cSatCliL )

   local nTotVta  := 0
   local nRecno   := ( cSatCliL )->( Recno() )

   if ( cSatCliL )->( dbSeek( cCodArt ) )

      while ( cSatCliL )->CREF == cCodArt .AND. !( cSatCliL )->( eof() )

         If !( cSatCliL )->LTOTLIN
            nTotVta += nTotNSatCli( cSatCliL )
         end

         ( cSatCliL )->( dbSkip() )

      end

   end

   ( cSatCliL )->( dbGoTo( nRecno ) )

return ( nTotVta )



function nVtaSatCli( cCodCli, dDesde, dHasta, cSatCliT, cSatCliL, dbfIva, dbfDiv )

   local nCon     := 0
   local nRec     := ( cSatCliT )->( Recno() )





   if ( cSatCliT )->( dbSeek( cCodCli ) )

      while ( cSatCliT )->cCodCli == cCodCli .AND. !( cSatCliT )->( Eof() )


         if ( dDesde == nil .OR. ( cSatCliT )->dFecSat >= dDesde )    .AND. ( dHasta == nil .OR. ( cSatCliT )->dFecSat <= dHasta )

            nCon  += nTotSatCli( ( cSatCliT )->cSerSat + Str( ( cSatCliT )->nNumSat ) + ( cSatCliT )->cSufSat, cSatCliT, cSatCliL, dbfIva, dbfDiv, nil, nil, cDivEmp(), .F. )

         end

         ( cSatCliT )->( dbSkip() )

      end

   end

   ( cSatCliT )->( dbGoTo( nRec ) )

return nCon



function aItmSatCli()

   local aItmSatCli :=  {}

   aAdd( aItmSatCli, { "CSERSAT",   "C",  1,  0, "Serie de S.A.T." ,                            "Serie",                   "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NNUMSAT",   "N",  9,  0, "Número de S.A.T." ,                           "Numero",                  "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CSUFSAT",   "C",  2,  0, "Sufijo de S.A.T." ,                           "Sufijo",                  "", "( cDbf )", {|| RetSufEmp() } } )
   aAdd( aItmSatCli, { "CTURSAT",   "C",  6,  0, "Sesión del S.A.T.",                           "Turno",                   "", "( cDbf )", {|| cCurSesion( nil, .F.) } } )
   aAdd( aItmSatCli, { "DFECSAT",   "D",  8,  0, "Fecha del S.A.T.",                            "Fecha",                   "", "( cDbf )", {|| GetSysDate() } } )
   aAdd( aItmSatCli, { "CCODCLI",   "C", 12,  0, "Código del cliente",                          "Cliente",                 "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CNOMCLI",   "C", 80,  0, "Nombre del cliente",                          "NombreCliente",           "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CDIRCLI",   "C",200,  0, "Domicilio del cliente",                       "DomicilioCliente",        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CPOBCLI",   "C",200,  0, "Población del cliente",                       "PoblacionCliente",        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CPRVCLI",   "C",100,  0, "Provincia del cliente",                       "ProvinciaCliente",        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CPOSCLI",   "C", 15,  0, "Código postal del cliente",                   "CodigoPostalCliente",     "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CDNICLI",   "C", 30,  0, "DNI del cliente",                             "DniCliente",              "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "LMODCLI",   "L",  1,  0, "Modificar datos del cliente",                 "ModificarDatosCliente",   "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CCODAGE",   "C",  3,  0, "Código del agente",                           "Agente",                  "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CCODOBR",   "C", 10,  0, "Código de dirección",                         "Direccion",               "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CCODTAR",   "C",  5,  0, "Código de tarifa",                            "Tarifa",                  "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CCODALM",   "C", 16,  0, "Código del almacen",                          "Almacen",                 "", "( cDbf )", {|| Application():codigoAlmacen() } } )
   aAdd( aItmSatCli, { "CCODCAJ",   "C",  3,  0, "Código de caja",                              "Caja",                    "", "( cDbf )", {|| Application():CodigoCaja() } } )
   aAdd( aItmSatCli, { "CCODPGO",   "C",  2,  0, "Código de pago",                              "Pago",                    "", "( cDbf )", {|| cDefFpg() } } )
   aAdd( aItmSatCli, { "CCODRUT",   "C",  4,  0, "Código de la ruta",                           "Ruta",                    "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "DFECENT",   "D",  8,  0, "Fecha de entrada",                            "FechaEntrada",            "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "lEstado",   "L",  1,  0, "Estado del S.A.T.",                           "Estado",                  "", "( cDbf )", {|| 1 } } )
   aAdd( aItmSatCli, { "CSUSAT",    "C",100,  0, "",                                            "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CCONDENT",  "C",100,  0, "",                                            "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "MCOMENT",   "M", 10,  0, "Comentarios",                                 "Comentarios",             "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "MOBSERV",   "M", 10,  0, "Averia",                                      "Averia",                  "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "LMAYOR",    "L",  1,  0, "" ,                                           "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NTARIFA",   "N",  1,  0, "Tarifa de precio aplicada" ,                  "NumeroTarifa",            "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CDTOESP",   "C", 50,  0, "Descripción del descuento",                   "DescripcionDescuento1",   "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDTOESP",   "N",  5,  2, "Porcentaje de descuento",                     "PorcentajeDescuento1",    "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CDPP",      "C", 50,  0, "Descripción del descuento por pronto pago",   "DescripcionDescuento2",   "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDPP",      "N",  5,  2, "Pct. de dto. por pronto pago",                "PorcentajeDescuento2",    "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CDTOUNO",   "C", 50,  0, "Desc. del primer descuento pers.",            "DescripcionDescuento3",   "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDTOUNO",   "N",  5,  2, "Pct. del primer descuento pers.",             "PorcentajeDescuento3",    "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CDTODOS",   "C", 50,  0, "Desc. del segundo descuento pers.",           "DescripcionDescuento4",   "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDTODOS",   "N",  5,  2, "Pct. del segundo descuento pers.",            "PorcentajeDescuento4",    "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDTOCNT",   "N",  5,  2, "Pct. de dto. por pago contado",               "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDTORAP",   "N",  5,  2, "Pct. de dto. por rappel",                     "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDTOPUB",   "N",  5,  2, "Pct. de dto. por publicidad",                 "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDTOPGO",   "N",  5,  2, "Pct. de dto. por pago centralizado",          "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NDTOPTF",   "N",  7,  2, "",                                            "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "LRECARGO",  "L",  1,  0, "Aplicar recargo de equivalencia",             "RecargoEquivalencia",     "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NPCTCOMAGE","N",  5,  2, "Pct. de comisión del agente",                 "ComisionAgente",          "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NBULTOS",   "N",  5,  0, "Numero de bultos",                            "Bultos",                  "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CNUMSat",   "C", 10,  0, "" ,                                           "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CDIVSAT",   "C",  3,  0, "Código de divisa",                            "Divisa",                  "", "( cDbf )", {|| cDivEmp() } } )
   aAdd( aItmSatCli, { "NVDVSAT",   "N", 10,  4, "Valor del cambio de la divisa",               "ValorDivisa",             "", "( cDbf )", {|| nChgDiv() } } )
   aAdd( aItmSatCli, { "LSNDDOC",   "L",  1,  0, "Valor lógico documento enviado",              "Envio",                   "", "( cDbf )", {|| .T. } } )
   aAdd( aItmSatCli, { "CRETPOR",   "C",150,  0, "Retirado por" ,                               "Retirado",                "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CRETMAT",   "C",150,  0, "Matrícula" ,                                  "Matricula",               "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "NREGIVA",   "N",  1,  0, "Regimen de " + cImp() ,                       "TipoImpuesto",            "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "LIVAINC",   "L",  1,  0, "Lógico de " + cImp() + " incluido",           "ImpuestosIncluidos",      "", "( cDbf )", {|| uFieldEmpresa( "lIvaInc" ) } } )
   aAdd( aItmSatCli, { "NIVAMAN",   "N",  6,  2, "Porcentaje de " + cImp() + " del gasto",      "ImpuestoGastos",          "", "( cDbf )", {|| nIva( nil, cDefIva() ) } } )
   aAdd( aItmSatCli, { "NMANOBR",   "N", 16,  6, "Gastos" ,                                     "Gastos",                  "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cCodTrn",   "C",  9,  0, "Código de transportista" ,                    "Transportista",           "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "nKgsTrn"   ,"N", 16,  6, "TARA del transportista" ,                     "TaraTransportista",       "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "lCloSat",   "L",  1,  0, "" ,                                           "DocumentoCerrado",        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cCodUsr",   "C",  3,  0, "Código de usuario",                           "Usuario",                 "", "( cDbf )", {|| Auth():Codigo() } } )
   aAdd( aItmSatCli, { "dFecCre",   "D",  8,  0, "Fecha de creación del documento",             "FechaCreacion",           "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cTimCre",   "C",  5,  0, "Hora de creación del documento",              "HoraCreacion",            "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cSituac",   "C", 20,  0, "Situación del documento",                     "Situacion",               "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "nDiaVal",   "N",  3,  0, "Dias de validez",                             "DiasValidez",             "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cCodGrp",   "C",  4,  0, "Código de grupo de cliente",                  "GrupoCliente",            "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "lImprimido","L",  1,  0, "Lógico de imprimido del documento",           "Imprimido",               "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "dFecImp",   "D",  8,  0, "Última fecha de impresión del documento",     "FechaImpresion",          "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cHorImp",   "C",  5,  0, "Hora de la última impresión del documento",   "HoraImpresion",           "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cCodDlg",   "C",  2,  0, "Código delegación" ,                          "Delegacion",              "", "( cDbf )", {|| Application():CodigoDelegacion() } } )
   aAdd( aItmSatCli, { "nDtoAtp",   "N",  6,  2, "Porcentaje de descuento atípico",             "DescuentoAtipico",        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "nSbrAtp",   "N",  1,  0, "Lugar donde aplicar dto atípico",             "LugarAplicarDescuentoAtipico","", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "dFecEntr",  "D",  8,  0, "Fecha de entrada de alquiler",                "EntradaAlquiler",         "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "dFecSal",   "D",  8,  0, "Fecha de salidad de alquiler",                "SalidaAlquiler",          "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "lAlquiler", "L",  1,  0, "Lógico de alquiler",                          "Alquiler",                "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cManObr",   "C",250,  0, "Literal de gastos" ,                          "LiteralGastos",           "", "( cDbf )", {|| padr( getConfigTraslation( "Gastos" ), 250 ) } } )
   aAdd( aItmSatCli, { "cNumTik",   "C", 13,  0, "Número del ticket generado" ,                 "NumeroTicket",            "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "CTLFCLI",   "C", 20,  0, "Teléfono del cliente" ,                       "TelefonoCliente",         "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "nTotNet",   "N", 16,  6, "Total neto" ,                                 "TotalNeto",               "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "nTotIva",   "N", 16,  6, "Total " + cImp() ,                            "TotalImpuesto",           "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "nTotReq",   "N", 16,  6, "Total recargo" ,                              "TotalRecargo",            "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "nTotSat",   "N", 16,  6, "Total S.A.T." ,                               "TotalDocumento",          "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "lOperPV",   "L",  1,  0, "Lógico para operar con punto verde" ,         "OperarPuntoVerde",        "", "( cDbf )", {|| .F. } } )
   aAdd( aItmSatCli, { "cNumAlb",   "C", 12,  0, "Número del albarán donde se agrupa" ,         "",                        "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "lGarantia", "L",  1,  0, "Lógico de reparación en garantía" ,           "ReparacionGarantia",      "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cCodOpe",   "C",  5,  0, "Código operario" ,                            "Operario",                "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cCodCat",   "C", 10,  0, "Código categoría" ,                           "Categoria",               "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cHorIni",   "C",  5,  0, "Hora de inicio" ,                             "HoraInicio",              "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cHorFin",   "C",  5,  0, "Hora de fin" ,                                "HoraFin",                 "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cCodEst",   "C",  3,  0, "Código estado" ,                              "Estado",                  "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "mFirma",    "M", 10,  0, "Firma" ,                                      "Firma",                   "", "( cDbf )", nil } )
   aAdd( aItmSatCli, { "cCtrCoste", "C",  9,  0, "Código del centro de coste" ,                 "CentroCoste",             "", "( cDbf )", nil } )

return ( aItmSatCli )



function aCalSatCli()

   local aCalSatCli  := {}

   aAdd( aCalSatCli, { "nTotArt",                                                   "N", 16,  6, "Total artículos",             "cPicUndSat",  "" } )
   aAdd( aCalSatCli, { "nTotCaj",                                                   "N", 16,  6, "Total cajas",                 "cPicUndSat",  "" } )
   aAdd( aCalSatCli, { "aTotIva[1,1]",                                              "N", 16,  6, "Bruto primer tipo de " + cImp(),    "cPorDivSat",  "aTotIva[1,1] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[2,1]",                                              "N", 16,  6, "Bruto segundo tipo de " + cImp(),   "cPorDivSat",  "aTotIva[2,1] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[3,1]",                                              "N", 16,  6, "Bruto tercer tipo de " + cImp(),    "cPorDivSat",  "aTotIva[3,1] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[1,2]",                                              "N", 16,  6, "Base primer tipo de " + cImp(),     "cPorDivSat",  "aTotIva[1,2] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[2,2]",                                              "N", 16,  6, "Base segundo tipo de " + cImp(),    "cPorDivSat",  "aTotIva[2,2] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[3,2]",                                              "N", 16,  6, "Base tercer tipo de " + cImp(),     "cPorDivSat",  "aTotIva[3,2] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[1,3]",                                              "N",  5,  2, "Porcentaje primer tipo " + cImp(),  "'@R 99.99%'", "aTotIva[1,3] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[2,3]",                                              "N",  5,  2, "Porcentaje segundo tipo " + cImp(), "'@R 99.99%'", "aTotIva[2,3] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[3,3]",                                              "N",  5,  2, "Porcentaje tercer tipo " + cImp(),  "'@R 99.99%'", "aTotIva[3,3] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[1,4]",                                              "N",  5,  2, "Porcentaje primer tipo RE",   "'@R 99.99%'", "aTotIva[1,4] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[2,4]",                                              "N",  5,  2, "Porcentaje segundo tipo RE",  "'@R 99.99%'", "aTotIva[2,4] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[3,4]",                                              "N",  5,  2, "Porcentaje tercer tipo RE",   "'@R 99.99%'", "aTotIva[3,4] != 0" } )
   aAdd( aCalSatCli, { "round( aTotIva[1,2] * aTotIva[1,3] / 100, nDouDivSat )",    "N", 16,  6, "Importe primer tipo " + cImp(),     "cPorDivSat",  "aTotIva[1,2] != 0" } )
   aAdd( aCalSatCli, { "round( aTotIva[2,2] * aTotIva[2,3] / 100, nDouDivSat )",    "N", 16,  6, "Importe segundo tipo " + cImp(),    "cPorDivSat",  "aTotIva[2,2] != 0" } )
   aAdd( aCalSatCli, { "round( aTotIva[3,2] * aTotIva[3,3] / 100, nDouDivSat )",    "N", 16,  6, "Importe tercer tipo " + cImp(),     "cPorDivSat",  "aTotIva[3,2] != 0" } )
   aAdd( aCalSatCli, { "round( aTotIva[1,2] * aTotIva[1,4] / 100, nDouDivSat )",    "N", 16,  6, "Importe primer RE",           "cPorDivSat",  "aTotIva[1,2] != 0" } )
   aAdd( aCalSatCli, { "round( aTotIva[2,2] * aTotIva[2,4] / 100, nDouDivSat )",    "N", 16,  6, "Importe segundo RE",          "cPorDivSat",  "aTotIva[2,2] != 0" } )
   aAdd( aCalSatCli, { "round( aTotIva[3,2] * aTotIva[3,4] / 100, nDouDivSat )",    "N", 16,  6, "Importe tercer RE",           "cPorDivSat",  "aTotIva[3,2] != 0" } )
   aAdd( aCalSatCli, { "aTotIvm[1,1]",                                              "N", 16,  6, "Total unidades primer tipo de impuestos especiales",    "cPorDivSat",  "aTotIvm[1,1] != 0" } )
   aAdd( aCalSatCli, { "aTotIvm[2,1]",                                              "N", 16,  6, "Total unidades segundo tipo de impuestos especiales",   "cPorDivSat",  "aTotIvm[2,1] != 0" } )
   aAdd( aCalSatCli, { "aTotIvm[3,1]",                                              "N", 16,  6, "Total unidades tercer tipo de impuestos especiales",    "cPorDivSat",  "aTotIvm[3,1] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[1,2]",                                              "N", 16,  6, "Importe del primer tipo de impuestos especiales",       "cPorDivSat",  "aTotIvm[1,2] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[2,2]",                                              "N", 16,  6, "Importe del segundo tipo de impuestos especiales",      "cPorDivSat",  "aTotIvm[2,2] != 0" } )
   aAdd( aCalSatCli, { "aTotIva[3,2]",                                              "N", 16,  6, "Importe del tercer tipo de impuestos especiales",       "cPorDivSat",  "aTotIvm[3,2] != 0" } )
   aAdd( aCalSatCli, { "aTotIvm[1,3]",                                              "N", 16,  6, "Total importe primer tipo de impuestos especiales",     "cPorDivSat",  "aTotIvm[1,3] != 0" } )
   aAdd( aCalSatCli, { "aTotIvm[2,3]",                                              "N", 16,  6, "Total importe segundo tipo de impuestos especiales",    "cPorDivSat",  "aTotIvm[2,3] != 0" } )
   aAdd( aCalSatCli, { "aTotIvm[3,3]",                                              "N", 16,  6, "Total importe tercer tipo de impuestos especiales",     "cPorDivSat",  "aTotIvm[3,3] != 0" } )
   aAdd( aCalSatCli, { "nTotBrt",                                                   "N", 16,  6, "Total bruto",                 "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotDto",                                                   "N", 16,  6, "Total descuento",             "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotDpp",                                                   "N", 16,  6, "Total descuento pronto pago", "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotNet",                                                   "N", 16,  6, "Total neto",                  "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotIva",                                                   "N", 16,  6, "Total " + cImp(),             "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotIvm",                                                   "N", 16,  6, "Total IVMH",                  "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotReq",                                                   "N", 16,  6, "Total RE",                    "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotSat",                                                   "N", 16,  6, "Total S.A.T.",           "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotPes",                                                   "N", 16,  6, "Total peso",                  "'@E 99,999.99'","lEnd" } )
   aAdd( aCalSatCli, { "nTotCos",                                                   "N", 16,  6, "Total costo",                 "cPorDivSat",  "lEnd" } )
   aAdd( aCalSatCli, { "nTotPage",                                                  "N", 16,  6, "Total página",                "cPorDivSat",  "!lEnd" } )
   aAdd( aCalSatCli, { "nImpEuros( nTotSat, (cDbf)->cDivSat, cDbfDiv )",            "N", 16,  6, "Total Satsupuesto (Euros)",   "",            "lEnd" } )
   aAdd( aCalSatCli, { "nImpPesetas( nTotSat, (cDbf)->cDivSat, cDbfDiv )",          "N", 16,  6, "Total Satsupuesto (Pesetas)", "",            "lEnd" } )
   aAdd( aCalSatCli, { "nPagina",                                                   "N",  2,  0, "Numero de página",            "'99'",        "" } )
   aAdd( aCalSatCli, { "lEnd",                                                      "L",  1,  0, "Fin del documento",           "",            "" } )

return ( aCalSatCli )



function aColSatCli()

   local aColSatCli  := {}

   aAdd( aColSatCli, { "CSERSAT", "C",    1,  0, "Serie de S.A.T." ,                                  "Serie",                   "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NNUMSAT", "N",    9,  0, "Numero de S.A.T." ,                                 "Numero",                  "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CSUFSAT", "C",    2,  0, "Sufijo de S.A.T." ,                                 "Sufijo",                  "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CREF",    "C",   18,  0, "Referencia del artículo" ,                          "Articulo",                "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CDETALLE","C",  250,  0, "Descripción de artículo" ,                          "DescripcionArticulo",     "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NIVA"    ,"N",    6,  2, "Porcentaje de " + cImp() ,                          "PorcentajeImpuesto",      "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NCANSAT" ,"N",   16,  6, "Cantidad pedida" ,                                  "Cajas",                   "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NUNICAJA","N",   16,  6, "Unidades por caja" ,                                "Unidades",                "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LCONTROL","L",    1,  0, "" ,                                                 "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NUNDKIT", "N",   16,  6, "Unidades tipo kit" ,                                "UnidadesKit",             "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NPreDiv" ,"N",   16,  6, "Importe del artículo" ,                             "PrecioVenta",             "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NPNTVER", "N",   16,  6, "Importe punto verde" ,                              "PuntoVerde",              "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nImpTrn", "N",   16,  6, "Importe del transporte",                            "Portes",                  "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NDTO",    "N",    6,  2, "Descuento del artículo" ,                           "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NDTOPRM", "N",    6,  2, "Descuento de la promoción" ,                        "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NCOMAGE", "N",    6,  2, "Comisión del agente" ,                              "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NCANENT", "N",   16,  6, "Unidades de entrada" ,                              "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CUNIDAD", "C",    2,  0, "Unidad de venta" ,                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NPESOKG", "N",   16,  6, "Peso del artículo" ,                                "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cPesoKg", "C",    2,  0, "Unidad de peso del artículo" ,                      "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "DFECHA",  "D",    8,  0, "Fecha de entrega",                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "MLNGDES", "M",   10,  0, "Descripción de artículo sin codificar",             "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LTOTLIN", "L",    1,  0, "Linea de total" ,                                   "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LIMPLIN", "L",    1,  0, "Linea no imprimible" ,                              "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CCODPR1", "C",   20,  0, "Código de la primera propiedad",                    "CodigoPropiedad1",        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CCODPR2", "C",   20,  0, "Código de la segunda propiedad",                    "CodigoPropiedad2",        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CVALPR1", "C",   20,  0, "Valor de la primera propiedad",                     "ValorPropiedad1",         "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CVALPR2", "C",   20,  0, "Valor de la segunda propiedad",                     "ValorPropiedad2",         "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NFACCNV", "N",   16,  6, "Factor de conversión de la compra",                 "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NDTODIV", "N",   16,  6, "Descuento lineal de la compra",                     "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CTIPMOV", "C",    2,  0, "Tipo de movimiento",                                "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NNUMLIN", "N",    4,  0, "Numero de la línea",                                "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NCTLSTK", "N",    1,  0, "Tipo de stock de la línea",                         "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NCOSDIV", "N",   16,  6, "Costo del artículo" ,                               "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NPVSATC", "N",   16,  6, "Precio de venta recomendado" ,                      "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CALMLIN", "C",   16,  0, "Código de almacén" ,                                "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LIVALIN", "L",    1,  0, "Línea con " + cImp() + " incluido",                 "LineaImpuestoIncluido",   "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CCODIMP", "C",    3,  0, "Código del impuesto especial",                      "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NVALIMP", "N",   16,  6, "Importe de impuesto",                               "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LLOTE",   "L",    1,  0, "",                                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NLOTE",   "N",    9,  0, "",                                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cLote",   "C",   64,  0, "Número de Lote",                                    "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LKITART", "L",    1,  0, "Línea con escandallo",                              "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LKITCHL", "L",    1,  0, "Línea pertenciente a escandallo",                   "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LKITPRC", "L",    1,  0, "",                                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NMESGRT", "N",    2,  0, "Meses de garantía",                                 "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LMSGVTA", "L",    1,  0, "Avisar en venta sin stocks",                        "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "LNOTVTA", "L",    1,  0, "No permitir venta sin stocks",                      "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "MNUMSER", "M",   10,  0, "" ,                                                 "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CCODTIP", "C",    4,  0, "Código del tipo de artículo",                       "Tipo",                    "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CCODFAM", "C",   16,  0, "Código de familia",                                 "Familia",                 "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CGRPFAM", "C",    3,  0, "Código del grupo de familia",                       "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NREQ",    "N",   16,  6, "Recargo de equivalencia",                           "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "MOBSLIN", "M",   10,  0, "Observacion de línea",                              "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CCODPRV", "C",   12,  0, "Código del proveedor",                              "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CNOMPRV", "C",   30,  0, "Nombre del proveedor",                              "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CIMAGEN", "C",  250,  0, "Fichero de imagen" ,                                "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NPUNTOS", "N",   15,  6, "Puntos del artículo",                               "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NVALPNT", "N",   16,  6, "Valor del punto",                                   "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NDTOPNT", "N",    5,  2, "Descuento puntos",                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NINCPNT", "N",    5,  2, "Incremento porcentual",                             "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CREFPRV", "C",   18,  0, "Referencia artículo proveedor",                     "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NVOLUMEN","N",   16,  6, "Volumen del artículo" ,                             "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CVOLUMEN","C",    2,  0, "Unidad del volumen" ,                               "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "DFECENT" ,"D",    8,  0, "Fecha de entrada del alquiler",                     "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "DFECSAL" ,"D",    8,  0, "Fecha de salida del alquiler",                      "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nPreAlq" ,"N",   16,  6, "Precio de alquiler",                                "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "lAlquiler","L",   1,  0, "Lógico de alquiler",                                "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nNumMed"  ,"N",   1,  0, "Número de mediciones",                              "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nMedUno"  ,"N",  16,  6, "Primera unidad de medición",                        "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nMedDos"  ,"N",  16,  6, "Segunda unidad de medición",                        "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nMedTre"  ,"N",  16,  6, "Tercera unidad de medición",                        "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nTarLin"  ,"N",   1,  0, "Tarifa de precio aplicada" ,                        "NumeroTarifa",            "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "lImpFra"  ,"L",   1,  0, "Lógico de imprimir frase publicitaria",             "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cCodFra"  ,"C",   3,  0, "Código de frase publicitaria",                      "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cTxtFra"  ,"C", 250,  0, "",                                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "Descrip"  ,"M",  10,  0, "Descripción larga",                                 "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "lLinOfe"  ,"L",   1,  0, "Línea con oferta",                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "lVolImp"  ,"L",   1,  0, "Lógico aplicar volumen con impuestos especiales",   "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nBultos"  ,"N",  16,  6, "Número de bultos en líneas",                        "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cFormato" ,"C", 100,  0, "Formato de venta",                                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cCodCli"  ,"C",  12,  0, "Código del cliente",                                "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "dFecSat"  ,"D",   8,  0, "Fecha del SAT",                                     "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "NCNTACT"  ,"N",  15,  6, "Contador actual",                                   "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "CDESUBI"  ,"C", 200,  0, "Descripción de la ubicación",                       "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "lLabel"   ,"L",   1,  0, "Lógico para marca de etiqueta",                     "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nLabel"   ,"N",   6,  0, "Unidades de etiquetas a imprimir",                  "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cObrLin"  ,"C",  10,  0, "Dirección de la linea",                             "Direccion",               "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cRefAux"  ,"C",  18,  0, "Referencia auxiliar",                               "",                        "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "cRefAux2" ,"C",  18,  0, "Segunda referencia auxiliar",                       "",                        "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "nPosPrint","N",   4,  0, "Posición de impresión",                             "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cCtrCoste","C",   9,  0, "Código del centro de coste",                        "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cTipCtr",  "C",  20,  0, "Tipo tercero centro de coste",                      "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "cTerCtr",  "C",  20,  0, "Tercero centro de coste",                           "",                        "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "id_tipo_v","N",  16,  0, "Identificador tipo de venta",                       "IdentificadorTipoVenta",  "", "( cDbfCol )", nil } )
   aAdd( aColSatCli, { "nRegIva",  "N",   1,  0, "Régimen de " + cImp(),                              "TipoImpuesto",            "", "( cDbfCol )", nil } )

return ( aColSatCli )



function aCocSatCli()

   local aCocSatCli :=  {}

   aAdd( aCocSatCli, { "Descrip( cDbfCol )",                                         "C", 50, 0, "Detalle del artículo",      "",            "Descripción", "" } )
   aAdd( aCocSatCli, { "nTotNSatCli( cDbfCol )",                                     "N", 16, 6, "Total articulos",           "MasUnd()",    "Unidades",    "" } )
   aAdd( aCocSatCli, { "nTotUSatCli( cDbfCol, nDouDivSat, nVdvDivSat )",             "N", 16, 6, "Precio unitario",           "cPouDivSat",  "Precio",      "" } )
   aAdd( aCocSatCli, { "nTotLSatCli( cDbfCol, nDouDivSat, nRouDivSat, nVdvDivSat )", "N", 16, 6, "Total línea de S.A.T.",     "cPorDivSat",  "Total",       "" } )

return ( aCocSatCli )



function aIncSatCli()

   local aColSatCli  := {}

   aAdd( aColSatCli, { "cSerSat", "C",    1,  0, "Serie de S.A.T." ,                "",                   "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "nNumSat", "N",    9,  0, "Numero de S.A.T." ,               "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "cSufSat", "C",    2,  0, "Sufijo de S.A.T." ,               "",                   "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "cCodTip", "C",    3,  0, "Tipo de incidencia" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "dFecInc", "D",    8,  0, "Fecha de la incidencia" ,         "",                   "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "mDesInc", "M",   10,  0, "Descripción de la incidencia" ,   "",                   "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "lListo",  "L",    1,  0, "Lógico de listo" ,                "",                   "", "( cDbfCol )" } )
   aAdd( aColSatCli, { "lAviso",  "L",    1,  0, "Lógico de aviso" ,                "",                   "", "( cDbfCol )" } )

return ( aColSatCli )



function aSatCliDoc()

   local aSatCliDoc  := {}

   aAdd( aSatCliDoc, { "cSerSat", "C",    1,  0, "Serie de S.A.T." ,                "",                   "", "( cDbfCol )" } )
   aAdd( aSatCliDoc, { "nNumSat", "N",    9,  0, "Numero de S.A.T." ,               "'999999999'",        "", "( cDbfCol )" } )
   aAdd( aSatCliDoc, { "cSufSat", "C",    2,  0, "Sufijo de S.A.T." ,               "",                   "", "( cDbfCol )" } )
   aAdd( aSatCliDoc, { "cNombre", "C",  250,  0, "Nombre del documento" ,           "",                   "", "( cDbfCol )" } )
   aAdd( aSatCliDoc, { "cRuta",   "C",  250,  0, "Ruta del documento" ,             "",                   "", "( cDbfCol )" } )
   aAdd( aSatCliDoc, { "mObsDoc", "M",   10,  0, "Observaciones del documento" ,    "",                   "", "( cDbfCol )" } )

return ( aSatCliDoc )



function aSerSatCli()

   local aColSatCli  := {}

   aAdd( aColSatCli,  { "cSerSat",     "C",  1,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColSatCli,  { "nNumSat",     "N",  9,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColSatCli,  { "cSufSat",     "C",  2,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColSatCli,  { "dFecSat",     "D",  8,   0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColSatCli,  { "nNumLin",     "N",  4,   0, "Número de la línea",               "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColSatCli,  { "lUndNeg",     "L",  1,   0, "Lógico de unidades en negativo",   "",                  "", "( cDbfCol )" } )
   aAdd( aColSatCli,  { "cRef",        "C", 18,   0, "Referencia del artículo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColSatCli,  { "cAlmLin",     "C", 16,   0, "Almacen del artículo",             "",                  "", "( cDbfCol )" } )
   aAdd( aColSatCli,  { "cNumSer",     "C", 30,   0, "Número de serie",                  "",                  "", "( cDbfCol )" } )

return ( aColSatCli )



Function SynSatCli( cPath )

   local oError
   local oBlock
   local nOrdAnt
   local aTotSat
   local cSatCliL
   local cSatCliT
   local dbfArticulo

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SATCLIT.DBF" ), ( cCheckArea( "SATCLIT", @cSatCliT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "SATCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SATCLIL.DBF" ), ( cCheckArea( "SATCLIL", @cSatCliL ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "SATCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SATCLII.DBF" ), ( cCheckArea( "SATCLII", @dbfSatCliI ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "SATCLII.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SATCLIS.DBF" ), ( cCheckArea( "SATCLIS", @dbfSatCliS ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "SATCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FPAGO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   ( cSatCliT )->( ordSetFocus( 0 ) )
   ( cSatCliT )->( dbGoTop() )

      while !( cSatCliT )->( eof() )

         if Empty( ( cSatCliT )->cSufSat )
            ( cSatCliT )->cSufSat := "00"
         end

         if !Empty( ( cSatCliT )->cNumAlb ) .AND. Len( AllTrim( ( cSatCliT )->cNumAlb ) ) <> 12
         ( cSatCliT )->cNumAlb := AllTrim( ( cSatCliT )->cNumAlb ) + "00"
         end

         if !Empty( ( cSatCliT )->cNumTik ) .AND. Len( AllTrim( ( cSatCliT )->cNumTik ) ) <> 13
         ( cSatCliT )->cNumTik := AllTrim( ( cSatCliT )->cNumTik ) + "00"
         end

         if Empty( ( cSatCliT )->cCodCaj )
            ( cSatCliT )->cCodCaj := "000"
         end

         if Empty( ( cSatCliT )->cCodGrp )
            ( cSatCliT )->cCodGrp := RetGrpCli( ( cSatCliT )->cCodCli, dbfClient )
         end

         if Empty( ( cSatCliT )->cCodRut )
            ( cSatCliT )->cCodRut := RetFld( ( cSatCliT )->cCodCli, dbfClient, "cCodRut" )
         end

         if Empty( ( cSatCliT )->cNomCli )
            ( cSatCliT )->cNomCli := RetFld( ( cSatCliT )->cCodCli, dbfClient, "Titulo" )
         end

         if Empty( ( cSatCliT )->cDirCli )
            ( cSatCliT )->cDirCli := RetFld( ( cSatCliT )->cCodCli, dbfClient, "Domicilio" )
         end

         if Empty( ( cSatCliT )->cPobCli )
            ( cSatCliT )->cPobCli := RetFld( ( cSatCliT )->cCodCli, dbfClient, "Poblacion" )
         end

         if Empty( ( cSatCliT )->cPrvCli )
            ( cSatCliT )->cPrvCli := RetFld( ( cSatCliT )->cCodCli, dbfClient, "Provincia" )
         end

         if Empty( ( cSatCliT )->cPosCli )
            ( cSatCliT )->cPosCli := RetFld( ( cSatCliT )->cCodCli, dbfClient, "CodPostal" )
         end

         if Empty( ( cSatCliT )->cDniCli )
            ( cSatCliT )->cDniCli := RetFld( ( cSatCliT )->cCodCli, dbfClient, "Nif" )
         end





         if ( cSatCliT )->nTotSat == 0 .AND. dbLock( cSatCliT )

            aTotSat                 := aTotSatCli( ( cSatCliT )->cSerSat + Str( ( cSatCliT )->nNumSat ) + ( cSatCliT )->cSufSat, cSatCliT, cSatCliL, dbfIva, dbfDiv, dbfFPago, ( cSatCliT )->cDivSat )

            ( cSatCliT )->nTotNet := aTotSat[1]
            ( cSatCliT )->nTotIva := aTotSat[2]
            ( cSatCliT )->nTotReq := aTotSat[3]
            ( cSatCliT )->nTotSat := aTotSat[4]

            ( cSatCliT )->( dbUnLock() )

         end

         ( cSatCliT )->( dbSkip() )

      end

   ( cSatCliT )->( ordSetFocus( 1 ) )



   ( cSatCliL )->( ordSetFocus( 0 ) )
   ( cSatCliL )->( dbGoTop() )

      while !( cSatCliL )->( eof() )

         if Empty( ( cSatCliL )->cSufSat )
            ( cSatCliL )->cSufSat := "00"
         end

         if Empty( ( cSatCliL )->cLote ) .AND. !Empty( ( cSatCliL )->nLote )
            ( cSatCliL )->cLote      := AllTrim( Str( ( cSatCliL )->nLote ) )
         end

         if ( cSatCliL )->lIvaLin    <> RetFld( ( cSatCliL )->cSerSat + Str( ( cSatCliL )->nNumSat ) + ( cSatCliL )->cSufSat, cSatCliT, "lIvaInc" )
            ( cSatCliL )->lIvaLin    := RetFld( ( cSatCliL )->cSerSat + Str( ( cSatCliL )->nNumSat ) + ( cSatCliL )->cSufSat, cSatCliT, "lIvaInc" )
         end

         if !Empty( ( cSatCliL )->cRef ) .AND. Empty( ( cSatCliL )->cCodFam )
            ( cSatCliL )->cCodFam    := RetFamArt( ( cSatCliL )->cRef, dbfArticulo )
         end

         if !Empty( ( cSatCliL )->cRef ) .AND. !Empty( ( cSatCliL )->cCodFam )
            ( cSatCliL )->cGrpFam    := cGruFam( ( cSatCliL )->cCodFam, dbfFamilia )
         end

         if !Empty( ( cSatCliL )->cRef ) .AND. Empty( ( cSatCliL )->cCodTip )
            ( cSatCliL )->cCodTip    := RetFld( ( cSatCliL )->cRef, dbfArticulo, "cCodTip" )
         end

         if Empty( ( cSatCliL )->nReq )
            ( cSatCliL )->nReq       := nPReq( dbfIva, ( cSatCliL )->nIva )
         end

         if Empty( ( cSatCliL )->nPosPrint )
            ( cSatCliL )->nPosPrint  := ( cSatCliL )->nNumLin
         end

         if ( cSatCliL )->nRegIva <> RetFld( ( cSatCliL )->cSerSat + str( ( cSatCliL )->nNumSat ) + ( cSatCliL )->cSufSat, cSatCliT, "nRegIva" )
            if ( cSatCliL )->( dbRLock() )
               ( cSatCliL )->nRegIva    := RetFld( ( cSatCliL )->cSerSat + str( ( cSatCliL )->nNumSat ) + ( cSatCliL )->cSufSat, cSatCliT, "nRegIva" )
               ( cSatCliL )->( dbUnLock() )
            end
         end

         ( cSatCliL )->( dbSkip() )

         SysRefresh()

      end

   ( cSatCliL )->( ordSetFocus( 1 ) )



   ( dbfSatCliI )->( ordSetFocus( 0 ) )
   ( dbfSatCliI )->( dbGoTop() )

      while !( dbfSatCliI )->( eof() )

         if Empty( ( dbfSatCliI )->cSufSat )
            ( dbfSatCliI )->cSufSat := "00"
         end

         ( dbfSatCliI )->( dbSkip() )

         SysRefresh()

      end

   ( dbfSatCliI )->( ordSetFocus( 1 ) )



   ( dbfSatCliS )->( ordSetFocus( 0 ) )
   ( dbfSatCliS )->( dbGoTop() )

      while !( dbfSatCliS )->( eof() )

         if Empty( ( dbfSatCliS )->cSufSat )
            ( dbfSatCliS )->cSufSat := "00"
         end

         if ( dbfSatCliS )->dFecSat <> RetFld( ( dbfSatCliS )->cSerSat + Str( ( dbfSatCliS )->nNumSat ) + ( dbfSatCliS )->cSufSat, cSatCliT, "dFecSat" )
            ( dbfSatCliS )->dFecSat := RetFld( ( dbfSatCliS )->cSerSat + Str( ( dbfSatCliS )->nNumSat ) + ( dbfSatCliS )->cSufSat, cSatCliT, "dFecSat" )
         end

         ( dbfSatCliS )->( dbSkip() )

         SysRefresh()

      end

   ( dbfSatCliS )->( ordSetFocus( 1 ) )



   ( cSatCliL )->( dbGoTop() )
   while !( cSatCliL )->( eof() )

      if !( cSatCliT )->( dbSeek( ( cSatCliL )->cSerSat + str( ( cSatCliL )->nNumSat ) + ( cSatCliL )->cSufSat ) )

         if ( cSatCliL )->( dbRLock() )
            ( cSatCliL )->( dbDelete() )
            ( cSatCliL )->( dbRUnLock() )
         end

      end

      ( cSatCliL )->( dbSkip() )

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( cSatCliT )->( dbCloseArea() )
   ( cSatCliL )->( dbCloseArea() )
   ( dbfSatCliI )->( dbCloseArea() )
   ( dbfSatCliS )->( dbCloseArea() )
   ( dbfArticulo)->( dbCloseArea() )
   ( dbfFamilia )->( dbCloseArea() )
   ( dbfIva     )->( dbCloseArea() )
   ( dbfDiv     )->( dbCloseArea() )
   ( dbfFPago   )->( dbCloseArea() )
   ( dbfClient  )->( dbCloseArea() )

return nil








_HB_CLASS TSATClientesSenderReciver ; function TSATClientesSenderReciver ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TSATClientesSenderReciver", iif( .T., { @TSenderReciverItem() }, { @HBObject() } ), @TSATClientesSenderReciver() ) ) ;

   _HB_MEMBER { cFileName } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileName"}, .F. )

   _HB_MEMBER CreateData(); oClass:AddMethod( "CreateData", @TSATClientesSenderReciver_CreateData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RestoreData(); oClass:AddMethod( "RestoreData", @TSATClientesSenderReciver_RestoreData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SendData(); oClass:AddMethod( "SendData", @TSATClientesSenderReciver_SendData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ReciveData(); oClass:AddMethod( "ReciveData", @TSATClientesSenderReciver_ReciveData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Process(); oClass:AddMethod( "Process", @TSATClientesSenderReciver_Process(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validateRecepcion(); oClass:AddMethod( "validateRecepcion", @TSATClientesSenderReciver_validateRecepcion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TSATClientesSenderReciver ;



static FUNCTION TSATClientesSenderReciver_CreateData( ) ; local Self AS CLASS TSATClientesSenderReciver := QSelf() AS CLASS TSATClientesSenderReciver

   local oBlock
   local oError
   local lSnd        := .F.
   local cSatCliT
   local cSatCliL
   local dbfSatCliI
   local tmpSatCliT
   local tmpSatCliL
   local tmpSatCliI

   ::cFileName       := "SatCli" + win_uuidcreatestring() + "." + RetSufEmp()

   ::oSender:SetText( "Enviando S.A.T. de clientes" )

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SatCliT.DBF" ), ( cCheckArea( "SatCliT", @cSatCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "SatCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SatCliL.DBF" ), ( cCheckArea( "SatCliL", @cSatCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "SatCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SatCliI.DBF" ), ( cCheckArea( "SatCliI", @dbfSatCliI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "SatCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end



   mkSatCli( cPatSnd() )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "SatCliT.DBF" ), ( cCheckArea( "SatCliT", @tmpSatCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "SatCliT.CDX" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "SatCliL.DBF" ), ( cCheckArea( "SatCliL", @tmpSatCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "SatCliL.CDX" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "SatCliI.DBF" ), ( cCheckArea( "SatCliI", @tmpSatCliI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "SatCliI.CDX" ) )

   if !Empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( cSatCliT )->( LastRec() )
   end

   while !( cSatCliT )->( eof() )

      if ( cSatCliT )->lSndDoc

         lSnd  := .T.

         dbPass( cSatCliT, tmpSatCliT, .T. )

         ::oSender:SetText( ( cSatCliT )->cSerSat + "/" + AllTrim( Str( ( cSatCliT )->nNumSat ) ) + "/" + AllTrim( ( cSatCliT )->cSufSat ) + "; " + Dtoc( ( cSatCliT )->dFecSat ) + "; " + AllTrim( ( cSatCliT )->cCodCli ) + "; " + ( cSatCliT )->cNomCli )

         if ( cSatCliL )->( dbSeek( ( cSatCliT )->CSERSat + Str( ( cSatCliT )->NNUMSat ) + ( cSatCliT )->CSUFSat ) )
            while ( ( cSatCliL )->cSerSat + Str( ( cSatCliL )->NNUMSat ) + ( cSatCliL )->CSUFSat ) == ( ( cSatCliT )->CSERSat + Str( ( cSatCliT )->NNUMSat ) + ( cSatCliT )->CSUFSat ) .AND. !( cSatCliL )->( eof() )
               dbPass( cSatCliL, tmpSatCliL, .T. )
               ( cSatCliL )->( dbSkip() )
            end
         end

         if ( dbfSatCliI )->( dbSeek( ( cSatCliT )->cSerSat + Str( ( cSatCliT )->nNumSat ) + ( cSatCliT )->cSufSat ) )
            while ( ( dbfSatCliI )->cSerSat + Str( ( dbfSatCliI )->nNumSat ) + ( dbfSatCliI )->cSufSat ) == ( ( cSatCliT )->cSerSat + Str( ( cSatCliT )->nNumSat ) + ( cSatCliT )->cSufSat ) .AND. !( dbfSatCliI )->( eof() )
               dbPass( dbfSatCliI, tmpSatCliI, .T. )
               ( dbfSatCliI )->( dbSkip() )
            end
         end

      end

      ( cSatCliT )->( dbSkip() )

      if !Empty( ::oSender:oMtr )
         ::oSender:oMtr:Set( ( cSatCliT )->( OrdKeyNo() ) )
      end

   end

   RECOVER USING oError

      msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   ( cSatCliT )->( dbCloseArea() )
   ( cSatCliL )->( dbCloseArea() )
   ( dbfSatCliI )->( dbCloseArea() )
   ( tmpSatCliT )->( dbCloseArea() )
   ( tmpSatCliL )->( dbCloseArea() )
   ( tmpSatCliI )->( dbCloseArea() )

   if lSnd

      ::oSender:SetText( "Comprimiendo S.A.T. a clientes" )

      if ::oSender:lZipData( ::cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay S.A.T. a clientes para enviar" )

   end

Return ( Self )



static FUNCTION TSATClientesSenderReciver_RestoreData( ) ; local Self AS CLASS TSATClientesSenderReciver := QSelf() AS CLASS TSATClientesSenderReciver

   local oBlock
   local oError
   local cSatCliT

   if ::lSuccesfullSend

      oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SatCliT.DBF" ), ( cCheckArea( "SatCliT", @cSatCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "SatCliT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      ( cSatCliT )->( OrdSetFocus( "lSndDoc" ) )

      while ( cSatCliT )->( dbSeek( .T. ) ) .AND. !( cSatCliT )->( eof() )
         if ( cSatCliT )->( dbRLock() )
            ( cSatCliT )->lSndDoc := .F.
            ( cSatCliT )->( dbRUnlock() )
         end
      end

      RECOVER USING oError

         msgStop( "Imposible abrir todas las bases de datos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

      ( cSatCliT )->( dbCloseArea() )

   end

Return ( Self )



static FUNCTION TSATClientesSenderReciver_SendData( ) ; local Self AS CLASS TSATClientesSenderReciver := QSelf() AS CLASS TSATClientesSenderReciver

   if File( cPatOut() + ::cFileName )





      if ::oSender:SendFiles( cPatOut() + ::cFileName, ::cFileName )
         ::lSuccesfullSend := .T.
         ::oSender:SetText( "Fichero enviado " + ::cFileName )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



static FUNCTION TSATClientesSenderReciver_ReciveData( ) ; local Self AS CLASS TSATClientesSenderReciver := QSelf() AS CLASS TSATClientesSenderReciver

   local n
   local aExt

   aExt     := ::oSender:aExtensions()





   ::oSender:SetText( "Recibiendo S.A.T. de clientes" )

   for n := 1 to len( aExt )
      ::oSender:GetFiles( "SatCli*." + aExt[ n ], cPatIn() )
   next

   ::oSender:SetText( "S.A.T. de clientes recibidos" )

Return Self



static FUNCTION TSATClientesSenderReciver_Process( ) ; local Self AS CLASS TSATClientesSenderReciver := QSelf() AS CLASS TSATClientesSenderReciver

   local m
   local oBlock
   local oError
   local cSatCliT
   local cSatCliL
   local dbfSatCliI
   local dbfSatClid
   local tmpSatCliT
   local tmpSatCliL
   local tmpSatCliI
   local tmpSatCliD
   local aFiles      := Directory( cPatIn() + "SatCli*.*" )
   local cOperario   := GetPvProfString(  "Envioyrecepcion", "Operario", "",   cIniAplication() )

   for m := 1 to len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

      BEGIN SEQUENCE

         if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )




            if lExistTable( cPatSnd() + "SatCliT.DBF", cLocalDriver() )    .AND. lExistTable( cPatSnd() + "SatCliL.DBF", cLocalDriver() )    .AND. lExistTable( cPatSnd() + "SatCliI.DBF", cLocalDriver() )    .AND. lExistTable( cPatSnd() + "SatCliD.DBF", cLocalDriver() )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "SatCliT.DBF" ), ( cCheckArea( "SatCliT", @tmpSatCliT ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "SatCliT.CDX" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "SatCliL.DBF" ), ( cCheckArea( "SatCliL", @tmpSatCliL ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "SatCliL.CDX" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "SatCliI.DBF" ), ( cCheckArea( "SatCliI", @tmpSatCliI ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "SatCliI.CDX" ) )

               dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "SatCliD.DBF" ), ( cCheckArea( "SatCliD", @tmpSatCliD ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
               if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "SatCliD.CDX" ) )

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SatCliT.DBF" ), ( cCheckArea( "SatCliT", @cSatCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "SatCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SatCliL.DBF" ), ( cCheckArea( "SatCliL", @cSatCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "SatCliL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SatCliI.DBF" ), ( cCheckArea( "SatCliI", @dbfSatCliI ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "SatCliI.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "SatCliD.DBF" ), ( cCheckArea( "SatCliD", @dbfSatCliD ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
               if !lAIS() ; ordListAdd( ( cPatEmp() + "SatCliD.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

               while !( tmpSatCliT )->( eof() )

                  if ::validateRecepcion( tmpSatCliT, cSatCliT, cOperario )

                     dbPass( tmpSatCliT, cSatCliT, .T. )

                     if dbLock( cSatCliT )
                        ( cSatCliT )->lSndDoc := .F.
                        ( cSatCliT )->( dbUnLock() )
                     end

                     ::oSender:SetText( "Añadido     : " + ( tmpSatCliL )->cSerSat + "/" + AllTrim( Str( ( tmpSatCliL )->nNumSat ) ) + "/" + AllTrim( ( tmpSatCliL )->cSufSat ) + "; " + Dtoc( ( tmpSatCliT )->dFecSat ) + "; " + AllTrim( ( tmpSatCliT )->cCodCli ) + "; " + ( tmpSatCliT )->cNomCli )

                     if ( tmpSatCliL )->( dbSeek( ( tmpSatCliT )->cSerSat + Str( ( tmpSatCliT )->nNumSat ) + ( tmpSatCliT )->cSufSat ) )
                        while ( tmpSatCliL )->cSerSat + Str( ( tmpSatCliL )->nNumSat ) + ( tmpSatCliL )->cSufSat == ( tmpSatCliT )->cSerSat + Str( ( tmpSatCliT )->nNumSat ) + ( tmpSatCliT )->cSufSat .AND. !( tmpSatCliL )->( eof() )
                           dbPass( tmpSatCliL, cSatCliL, .T. )
                           ( tmpSatCliL )->( dbSkip() )
                        end
                     end

                     if ( tmpSatCliI )->( dbSeek( ( tmpSatCliT )->cSerSat + Str( ( tmpSatCliT )->nNumSat ) + ( tmpSatCliT )->cSufSat ) )
                        while ( tmpSatCliI )->cSerSat + Str( ( tmpSatCliI )->nNumSat ) + ( tmpSatCliI )->cSufSat == ( tmpSatCliT )->cSerSat + Str( ( tmpSatCliT )->nNumSat ) + ( tmpSatCliT )->cSufSat .AND. !( tmpSatCliI )->( eof() )
                           dbPass( tmpSatCliI, dbfSatCliI, .T. )
                           ( tmpSatCliI )->( dbSkip() )
                        end
                     end

                     if ( tmpSatCliD )->( dbSeek( ( tmpSatCliT )->cSerSat + Str( ( tmpSatCliT )->nNumSat ) + ( tmpSatCliT )->cSufSat ) )
                        while ( tmpSatCliD )->cSerSat + Str( ( tmpSatCliD )->nNumSat ) + ( tmpSatCliD )->cSufSat == ( tmpSatCliT )->cSerSat + Str( ( tmpSatCliT )->nNumSat ) + ( tmpSatCliT )->cSufSat .AND. !( tmpSatCliD )->( eof() )
                           dbPass( tmpSatCliD, dbfSatCliD, .T. )
                           ( tmpSatCliD )->( dbSkip() )
                        end
                     end

                  else

                     ::oSender:SetText( "Desestimado : " + ( tmpSatCliL )->cSerSat + "/" + AllTrim( Str( ( tmpSatCliL )->nNumSat ) ) + "/" + AllTrim( ( tmpSatCliL )->cSufSat ) + "; " + Dtoc( ( tmpSatCliT )->dFecSat ) + "; " + AllTrim( ( tmpSatCliT )->cCodCli ) + "; " + ( tmpSatCliT )->cNomCli )

                  end

                  ( tmpSatCliT )->( dbSkip() )

               end

               ( cSatCliT )->( dbCloseArea() )
               ( cSatCliL )->( dbCloseArea() )
               ( dbfSatCliI )->( dbCloseArea() )
               ( dbfSatCliD )->( dbCloseArea() )
               ( tmpSatCliT )->( dbCloseArea() )
               ( tmpSatCliL )->( dbCloseArea() )
               ( tmpSatCliI )->( dbCloseArea() )
               ( tmpSatCliD )->( dbCloseArea() )

               ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

            else

               ::oSender:SetText( "Faltan ficheros" )

               if !lExistTable( cPatSnd() + "SatCliT.DBF", cLocalDriver() )
                  ::oSender:SetText( "Falta " + cPatSnd() + "SatCliT.DBF" )
               end

               if !lExistTable( cPatSnd() + "SatCliL.DBF", cLocalDriver() )
                  ::oSender:SetText( "Falta " + cPatSnd() + "SatCliL.DBF" )
               end


               if !lExistTable( cPatSnd() + "SatCliI.DBF", cLocalDriver() )
                  ::oSender:SetText( "Falta " + cPatSnd() + "SatCliL.DBF" )
               end

               if !lExistTable( cPatSnd() + "SatCliD.DBF", cLocalDriver() )
                  ::oSender:SetText( "Falta " + cPatSnd() + "SatCliD.DBF" )
               end

            end

            fErase( cPatSnd() + "SatCliT.DBF" )
            fErase( cPatSnd() + "SatCliL.DBF" )
            fErase( cPatSnd() + "SatCliI.DBF" )
            fErase( cPatSnd() + "SatCliD.DBF" )

         else

            ::oSender:SetText( "Error al descomprimir los ficheros" )

         end

      RECOVER USING oError

         ( cSatCliT )->( dbCloseArea() )
         ( cSatCliL )->( dbCloseArea() )
         ( dbfSatCliI )->( dbCloseArea() )
         ( dbfSatCliD )->( dbCloseArea() )
         ( tmpSatCliT )->( dbCloseArea() )
         ( tmpSatCliL )->( dbCloseArea() )
         ( tmpSatCliI )->( dbCloseArea() )
         ( tmpSatCliD )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self



static FUNCTION TSATClientesSenderReciver_validateRecepcion( tmpSatCliT, dbfSatCliT, cOperario ) ; local Self AS CLASS TSATClientesSenderReciver := QSelf() AS CLASS TSATClientesSenderReciver

   ::cErrorRecepcion       := "Pocesando S.A.T. de cliente número " + ( dbfSatCliT )->cSerSat + "/" + alltrim( Str( ( dbfSatCliT )->nNumSat ) ) + "/" + alltrim( ( dbfSatCliT )->cSufSat ) + " "

   if !( lValidaOperacion( ( tmpSatCliT )->dFecSat, .F. ) )
      ::cErrorRecepcion    += "la fecha " + dtoc( ( tmpSatCliT )->dFecSat ) + " no es valida en esta empresa"
      Return .F.
   end

   if !empty( cOperario ) .AND. ( ( tmpSatCliT )->cCodOpe <> cOperario )
      ::cErrorRecepcion    += "el operario " + cOperario + " no coincide"
      Return .F.
   end

   if !( ( dbfSatCliT )->( dbSeek( ( tmpSatCliT )->cSerSat + Str( ( tmpSatCliT )->nNumSat ) + ( tmpSatCliT )->cSufSat ) ) )
      Return .T.
   end

   if dtos( ( dbfSatCliT )->dFecCre ) + ( dbfSatCliT )->cTimCre >= dtos( ( tmpSatCliT )->dFecCre ) + ( tmpSatCliT )->cTimCre
      ::cErrorRecepcion    += "la fecha en la empresa " + dtoc( ( dbfSatCliT )->dFecCre ) + " " + ( dbfSatCliT )->cTimCre + " es más reciente que la recepción " + dtoc( ( tmpSatCliT )->dFecCre ) + " " + ( tmpSatCliT )->cTimCre
      Return .F.
   end

Return ( .T. )



Function AppSatCli( cCodCli, cCodArt, lOpenBrowse )

   local nLevel         := Auth():Level( "sat_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 2 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if SatCli( nil, nil, cCodCli, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( .T. )
         WinAppRec( nil, bEdtRec, D():SatClientes( nView ), cCodCli, cCodArt )
         CloseFiles()
      end

   end

RETURN .T.



FUNCTION EdtSatCli( cNumSat, lOpenBrowse )

   local nLevel         := Auth():Level( "sat_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if SatCli()
         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra S.A.T." )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            WinEdtRec( nil, bEdtRec, D():SatClientes( nView ) )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION ZooSatCli( cNumSat, lOpenBrowse, lPda )

   local nLevel         := Auth():Level( "sat_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;
   If( lPda == nil, lPda := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 8 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if SatCli()
         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra S.A.T." )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            WinZooRec( nil, bEdtRec, D():SatClientes( nView ) )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION DelSatCli( cNumSat, lOpenBrowse )

   local nLevel         := Auth():Level( "sat_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 16 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if SatCli()
         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            WinDelRec( nil, D():SatClientes( nView ), {|| QuiSatCli() } )
         else
            MsgStop( "No se encuentra S.A.T." )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            WinDelRec( nil, D():SatClientes( nView ), {|| QuiSatCli() } )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION PrnSatCli( cNumSat, lOpenBrowse )

   local nLevel         := Auth():Level( "sat_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if SatCli()
         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            GenSatCli( 1 )
         else
            MsgStop( "No se encuentra S.A.T." )
         end
      end

   else

      if OpenFiles( .T. )
         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            GenSatCli( 1 )
         else
            MsgStop( "No se encuentra S.A.T." )
         end
         CloseFiles()
      end

   end

Return .T.



FUNCTION VisSatCli( cNumSat, lOpenBrowse )

   local nLevel         := Auth():Level( "sat_de_clientes" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 32 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if SatCli()
         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            GenSatCli( 2 )
         else
            MsgStop( "No se encuentra S.A.T." )
         end
      end

   else

      if OpenFiles( .T. )

         if dbSeekInOrd( cNumSat, "nNumSat", D():SatClientes( nView ) )
            GenSatCli( 2 )
         end

         CloseFiles()

      end

   end

Return .T.



FUNCTION QuiSatCli()

   local nOrdDet
   local nOrdInc
   local nOrdDoc

   if ( D():SatClientes( nView ) )->lEstado
      msgStop( "No se pueden eliminar S.A.T. ya procesados." )
      Return .F.
   end

   if ( D():SatClientes( nView ) )->lCloSat .AND. !oUser():lAdministrador()
      msgStop( "Solo puede eliminar S.A.T. cerrados los administradores." )
      Return .F.
   end

   nOrdInc        := ( dbfSatCliI )->( OrdSetFocus( "nNumSat" ) )
   nOrdDoc        := ( dbfSatCliD )->( OrdSetFocus( "nNumSat" ) )





   while ( D():SatClientesLineas( nView ) )->( dbSeek( D():SatClientesId( nView ) ) ) .AND. D():SatClientesLineasNotEof( nView )
     if dbLock( D():SatClientesLineas( nView ) )
        ( D():SatClientesLineas( nView ) )->( dbDelete() )
        ( D():SatClientesLineas( nView ) )->( dbUnLock() )
      end
   end





   while ( dbfSatCliI )->( dbSeek( ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView )  )->cSufSat ) ) .AND. !( dbfSatCliI )->( eof() )
      if dbLock( dbfSatCliI )
         ( dbfSatCliI )->( dbDelete() )
         ( dbfSatCliI )->( dbUnLock() )
      end
   end





   while ( dbfSatCliD )->( dbSeek( ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView )  )->cSufSat ) ) .AND. !( dbfSatCliD )->( eof() )
      if dbLock( dbfSatCliD )
         ( dbfSatCliD )->( dbDelete() )
         ( dbfSatCliD )->( dbUnLock() )
      end
   end

   ( dbfSatCliI )->( OrdSetFocus( nOrdInc ) )
   ( dbfSatCliD )->( OrdSetFocus( nOrdDoc ) )

Return .T.



FUNCTION IsSatCli( cPath )

   If( cPath == nil, cPath := cPatEmp(), ) ;

   if !lExistTable( cPath + "SatCliT.Dbf" )
      dbCreate( cPath + "SatCliT.Dbf", aSqlStruct( aItmSatCli() ), cDriver() )
   end

   if !lExistTable( cPath + "SatCliL.Dbf" )
      dbCreate( cPath + "SatCliL.Dbf", aSqlStruct( aColSatCli() ), cDriver() )
   end

   if !lExistTable( cPath + "SatCliI.Dbf" )
      dbCreate( cPath + "SatCliI.Dbf", aSqlStruct( aIncSatCli() ), cDriver() )
   end

   if !lExistTable( cPath + "SatCliD.Dbf" )
      dbCreate( cPath + "SatCliD.Dbf", aSqlStruct( aSatCliDoc() ), cDriver() )
   end




   if !lExistIndex( cPath + "SatCliT.Cdx" ) .OR.  !lExistIndex( cPath + "SatCliL.Cdx" ) .OR.  !lExistIndex( cPath + "SatCliI.Cdx" ) .OR.  !lExistTable( cPath + "SatCliD.Cdx" )

      rxSatCli( cPath )

   end

Return ( nil )



Function DesignReportSatCli( oFr, dbfDoc )

   local lOpen    := .F.
   local lFlag    := .F.





   if lOpenFiles
      lFlag       := .T.
   else
      if Openfiles()
         lFlag    := .T.
         lOpen    := .T.
      else
         lFlag    := .F.
      end
   end

   if lFlag





      DataReport( oFr )





      if !Empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "   CallHbFunc('nTotSatCli');"                              + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "MasterData",  "MainPage", 6 )
         oFr:SetProperty(     "MasterData",  "Top", 200 )
         oFr:SetProperty(     "MasterData",  "Height", 0 )
         oFr:SetProperty(     "MasterData",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "MasterData",  "DataSet", "SAT" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de SAT" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )





      oFr:DesignReport()





      oFr:DestroyFr()





      if lOpen
         CloseFiles()
      end

   else

      Return .F.

   end

Return .T.



Function mailReportSATCli( cCodigoDocumento )

Return ( printReportSATCli( 6, 1, ImpresoraDefectoUsuario(), cCodigoDocumento ) )



Function PrintReportSatCli( nDevice, nCopies, cPrinter, cCodigoDocumento )

   local oFr
   local cFilePdf              := cPatOut() + "SATCliente" + StrTran( ( D():SatClientes( nView ) )->cSerSat + Str( ( D():SatClientes( nView ) )->nNumSat ) + ( D():SatClientes( nView ) )->cSufSat, " ", "" ) + ".Pdf"
   local nOrd

   If( nDevice == nil, nDevice := 2, ) ;
   If( nCopies == nil, nCopies := 1, ) ;
   If( cCodigoDocumento == nil, cCodigoDocumento := cFormatoSATClientes(), ) ;

   if empty( cCodigoDocumento )
      msgStop( "El código del documento esta vacio" )
      Return ( nil )
   end

   if !lMemoDocumento( cCodigoDocumento, dbfDoc )
      msgStop( "El formato " + cCodigoDocumento + " no se encuentra, o no es un formato visual." )
      Return ( nil )
   end

   if Empty( cPrinter )
      cPrinter                := ImpresoraDefectoUsuario()
   end

   SysRefresh()


   oFr                        := frReportManager():New()

   oFr:LoadLangRes( "Spanish.Xml" )
   oFr:SetIcon( 1 )
   oFr:SetTitle( "Diseñador de documentos" )





   oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





   DataReport( oFr )





   if !Empty( ( dbfDoc )->mReport )

      oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





      VariableReport( oFr )





      oFr:PrepareReport()





      do case
         case nDevice == 2

            oFr:ShowPreparedReport()

         case nDevice == 1

            oFr:PrintOptions:SetPrinter( cPrinter )
            oFr:PrintOptions:SetCopies( nCopies )
            oFr:PrintOptions:SetShowDialog( .F. )
            oFr:Print()

         case nDevice == 3

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .T. )
            oFr:DoExport(     "PDFExport" )

         case nDevice == 6

            oFr:SetProperty(  "PDFExport", "ShowDialog",       .F. )
            oFr:SetProperty(  "PDFExport", "DefaultPath",      cPatOut() )
            oFr:SetProperty(  "PDFExport", "FileName",         cFilePdf )
            oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
            oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
            oFr:SetProperty(  "PDFExport", "Outline",          .T. )
            oFr:SetProperty(  "PDFExport", "OpenAfterExport",  .F. )
            oFr:DoExport(     "PDFExport" )

      end

   end





   oFr:DestroyFr()


Return cFilePdf







Function nTotDtoLSatCli( dbfLin, nDec, nVdv, cPorDiv )

   local nCalculo

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nDtoLSatCli( dbfLin, nDec, nVdv ) * nTotNSatCli( dbfLin )

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

   nCalculo          := Round( nCalculo, nDec )

RETURN ( if( cPorDiv <> nil, Trans( nCalculo, cPorDiv ), nCalculo ) )



Static Function YearComboBoxChange()

   if ( oWndBrw:oWndBar:cYearComboBox() <> "[Todos]" )
      oWndBrw:oWndBar:setYearComboBoxExpression( "Year( Field->dFecSat ) == " + oWndBrw:oWndBar:cYearComboBox() )
   else
      oWndBrw:oWndBar:setYearComboBoxExpression( "" )
   end

   oWndBrw:chgFilter()

Return nil



Function sTotSatCli( cSat, dbfMaster, dbfLine, dbfIva, dbfDiv, cDivRet )

   local sTotal

   nTotSatCli( cSat, dbfMaster, dbfLine, dbfIva, dbfDiv, nil, nil, cDivRet, .F. )

   sTotal                                 := sTotal()
   sTotal:nTotalBruto                     := nTotBrt
   sTotal:nTotalNeto                      := nTotNet
   sTotal:nTotalIva                       := nTotIva
   sTotal:aTotalIva                       := aTotIva
   sTotal:nTotalRecargoEquivalencia       := nTotReq
   sTotal:nTotalDocumento                 := nTotSat
   sTotal:nTotalPuntoVerde                := nTotPnt
   sTotal:nTotalTransporte                := nTotTrn
   sTotal:nTotalAgente                    := nTotAge
   sTotal:nTotalCosto                     := nTotCos
   sTotal:nTotalImpuestoHidrocarburos     := nTotIvm
   sTotal:nTotalRentabilidad              := nTotRnt
   sTotal:nTotalDescuentoGeneral          := nTotDto
   sTotal:nTotalDescuentoProntoPago       := nTotDpp
   sTotal:nTotalDescuentoUno              := nTotUno
   sTotal:nTotalDescuentoDos              := nTotDos

Return ( sTotal )



Static Function cFormatoSATClientes( cSerie )

   local cFormato

   If( cSerie == nil, cSerie := ( D():SatClientes( nView ) )->cSerSat, ) ;

   cFormato          := cFormatoDocumento( cSerie, "nSatCli", D():Contadores( nView ) )

   if Empty( cFormato )
      cFormato       := cFirstDoc( "SC", D():Documentos( nView ) )
   end

Return ( cFormato )



static function ChangeComentario( oCol, uNewValue, nKey, aTmp )





   if IsNum( nKey ) .AND. ( nKey <> 27 ) .AND. !IsNil( uNewValue )

      ( dbfTmpLin )->mObsLin       := uNewValue

      RecalculaTotal( aTmp )

   end

Return .T.



Function DesignLabelSATClientes( oFr, cDoc )

   local oLabel
   local lOpenFiles  := empty( nView )

   if lOpenFiles .AND. !Openfiles()
      Return .F.
   endif

   oLabel            := TLabelGeneratorSATClientes():New( nView )



   oLabel:createTempLabelReport()
   oLabel:loadTempLabelReport()
   oLabel:dataLabel( oFr )



   if !Empty( ( cDoc )->mReport )
      oFr:LoadFromBlob( ( cDoc )->( Select() ), "mReport")
   else
      oFr:AddPage(         "MainPage" )
      oFr:AddBand(         "MasterData",  "MainPage",       6 )
      oFr:SetProperty(     "MasterData",  "Top",            200 )
      oFr:SetProperty(     "MasterData",  "Height",         100 )
      oFr:SetObjProperty(  "MasterData",  "DataSet",        "Lineas de SAT" )
   end

   oFr:DesignReport()
   oFr:DestroyFr()

   oLabel:DestroyTempReport()
   oLabel:End()

   if lOpenFiles
      closeFiles()
   end

Return .T.



Function getExtraFieldSATCliente( cFieldName )

Return ( getExtraField( cFieldName, oDetCamposExtra, D():SATClientesId( nView ) ) )



Static Function lChangeRegIva( aTmp )

   lImpuestos     := ( aTmp[ 51 ] <= 1 )

   if !Empty( oImpuestos )
      oImpuestos:Refresh()
   end

return ( .T. )



Static Function importarArticulosScaner()

   local memoArticulos

   memoArticulos  := dialogArticulosScaner()

   if memoArticulos <> nil
      msgStop( "tengo q procesar ")
   end

Return nil



Static Function LoadTrans( aTmp, oGetCod, oGetKgs, oSayTrn )

   local uValor   := oGetCod:VarGet()

   if Empty( uValor )

      oSayTrn:cText( "" )
      oGetKgs:cText( 0 )

   else

      if oTrans:oDbf:SeekInOrd( uValor, "cCodTrn" )
         oGetCod:cText( uValor )
         oSayTrn:cText( oTrans:oDbf:cNomTrn )
         oGetKgs:cText( oTrans:oDbf:nKgsTrn )
      else
         msgStop( "Código de transportista no encontrado." )
         Return .F.
      end

   end

   RecalculaTotal( aTmp )

Return .T.
