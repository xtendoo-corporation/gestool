#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 9 ".\.\Prg\Siges.prg"
_HB_CLASS TSiges ; function TSiges ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TSiges", iif( .F., { }, { @HBObject() } ), @TSiges() ) ) ;

   _HB_MEMBER { nLevel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nLevel"}, .F. )

   _HB_MEMBER { cIniFile } ; oClass:AddMultiData(, cIniEmpresa(), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cIniFile"}, .F. )

   _HB_MEMBER { oGetPathFile } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetPathFile"}, .F. )
   _HB_MEMBER { cPathFile } ; oClass:AddMultiData(, Space( 254 ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPathFile"}, .F. )

   _HB_MEMBER { cFilTxt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFilTxt"}, .F. )
   _HB_MEMBER { oFilTxt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFilTxt"}, .F. )
   _HB_MEMBER { hFilTxt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"hFilTxt"}, .F. )

   _HB_MEMBER { oBtnOk } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnOk"}, .F. )
   _HB_MEMBER { oBtnCancel } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBtnCancel"}, .F. )

   _HB_MEMBER { oFile } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFile"}, .F. )

   _HB_MEMBER { oTree } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTree"}, .F. )
   _HB_MEMBER { oTreeFile } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTreeFile"}, .F. )

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )

   _HB_MEMBER { oAlbCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliT"}, .F. )
   _HB_MEMBER { oAlbCliL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbCliL"}, .F. )
   _HB_MEMBER { oAlbPrvT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbPrvT"}, .F. )
   _HB_MEMBER { oAlbPrvL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAlbPrvL"}, .F. )
   _HB_MEMBER { oTikCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTikCliT"}, .F. )
   _HB_MEMBER { oTikCliL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTikCliL"}, .F. )
   _HB_MEMBER { oDbfFam } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfFam"}, .F. )
   _HB_MEMBER { oDbfClient } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfClient"}, .F. )
   _HB_MEMBER { oDbfDiv } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfDiv"}, .F. )
   _HB_MEMBER { oDbfArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfArt"}, .F. )
   _HB_MEMBER { oDbfIva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfIva"}, .F. )
   _HB_MEMBER { oDbfPrv } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfPrv"}, .F. )
   _HB_MEMBER { oDbfPrvArt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfPrvArt"}, .F. )

   _HB_MEMBER { cNumOldDocumento } ; oClass:AddMultiData(, Space(1), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNumOldDocumento"}, .F. )
   _HB_MEMBER { cNumOldGst } ; oClass:AddMultiData(, Space(1), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNumOldGst"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @TSiges_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @TSiges_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Create(); oClass:AddInline( "Create", {|Self, oMenuItem, oWnd | ( ( Self ) ), ( if( ::New( oMenuItem, oWnd ) <> nil, ::Activate(), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TSiges_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TSiges_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoadFromIni(); oClass:AddMethod( "LoadFromIni", @TSiges_LoadFromIni(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER SaveToIni(); oClass:AddMethod( "SaveToIni", @TSiges_SaveToIni(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Import(); oClass:AddMethod( "Import", @TSiges_Import(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER ImportFile(); oClass:AddMethod( "ImportFile", @TSiges_ImportFile(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER ProccesLine( cLine); oClass:AddMethod( "ProccesLine", @TSiges_ProccesLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TSiges ;



static FUNCTION TSiges_New( oMenuItem, oWnd ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   If( oMenuItem == nil, oMenuItem := "01073", ) ;

   ::nLevel             := Auth():Level( oMenuItem )

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return ( nil )
   end

   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

RETURN ( Self )



static FUNCTION TSiges_LoadFromIni( ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   ::cPathFile             := GetPvProfString( "SIGES", "Ruta", cValToChar( ::cPathFile ), ::cIniFile )
   ::cPathFile             := Padr( ::cPathFile, 254 )

RETURN ( Self )



static FUNCTION TSiges_SaveToIni( ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   WritePProString( "SIGES", "Ruta", cValToChar( ::cPathFile ), ::cIniFile )

RETURN ( Self )



static FUNCTION TSiges_OpenFiles( ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   local lOpen    := .T.
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

   ::oAlbCliT := TDataCenter():oAlbCliT()

   ::oAlbCliL := DbfServer( "ALBCLIL.DBF", ):NewOpen( "ALBCLIL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbCliL:AddBag( "ALBCLIL.CDX" ) ; ::oAlbCliL:AddBag( ) ; ::oAlbCliL:AutoIndex()

   ::oAlbPrvT := DbfServer( "ALBPROVT.DBF", ):NewOpen( "ALBPROVT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbPrvT:AddBag( "ALBPROVT.CDX" ) ; ::oAlbPrvT:AddBag( ) ; ::oAlbPrvT:AutoIndex()

   ::oAlbPrvL := DbfServer( "ALBPROVL.DBF", ):NewOpen( "ALBPROVL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oAlbPrvL:AddBag( "ALBPROVL.CDX" ) ; ::oAlbPrvL:AddBag( ) ; ::oAlbPrvL:AutoIndex()

   ::oDbfDiv := DbfServer( "DIVISAS.DBF", ):NewOpen( "DIVISAS.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfDiv:AddBag( "DIVISAS.CDX" ) ; ::oDbfDiv:AddBag( ) ; ::oDbfDiv:AutoIndex()

   ::oDbfClient := DbfServer( "CLIENT.DBF", ):NewOpen( "CLIENT.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfClient:AddBag( "CLIENT.CDX" ) ; ::oDbfClient:AddBag( ) ; ::oDbfClient:AutoIndex()

   ::oDbfArt := DbfServer( "ARTICULO.DBF", ):NewOpen( "ARTICULO.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfArt:AddBag( "ARTICULO.CDX" ) ; ::oDbfArt:AddBag( ) ; ::oDbfArt:AutoIndex()

   ::oDbfIva := DbfServer( "TIVA.DBF", ):NewOpen( "TIVA.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfIva:AddBag( "TIVA.CDX" ) ; ::oDbfIva:AddBag( ) ; ::oDbfIva:AutoIndex()

   ::oDbfPrv := DbfServer( "PROVEE.DBF", ):NewOpen( "PROVEE.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfPrv:AddBag( "PROVEE.CDX" ) ; ::oDbfPrv:AddBag( ) ; ::oDbfPrv:AutoIndex()

   ::oDbfPrvArt := DbfServer( "PROVART.DBF", ):NewOpen( "PROVART.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfPrvArt:AddBag( "PROVART.CDX" ) ; ::oDbfPrvArt:AddBag( ) ; ::oDbfPrvArt:AutoIndex()

   ::oTikCliT := DbfServer( "TIKET.DBF", ):NewOpen( "TIKET.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oTikCliT:AddBag( "TIKET.CDX" ) ; ::oTikCliT:AddBag( ) ; ::oTikCliT:AutoIndex()

   ::oTikCliL := DbfServer( "TIKEL.DBF", ):NewOpen( "TIKEL.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oTikCliL:AddBag( "TIKEL.CDX" ) ; ::oTikCliL:AddBag( ) ; ::oTikCliL:AutoIndex()

   ::oDbfFam := DbfServer( "FAMILIAS.DBF", ):NewOpen( "FAMILIAS.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfFam:AddBag( "FAMILIAS.CDX" ) ; ::oDbfFam:AddBag( ) ; ::oDbfFam:AutoIndex()

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      ::CloseFiles()
      lOpen       := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TSiges_CloseFiles( ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   if !Empty ( ::oAlbCliT )
      ::oAlbCliT:End()
   end

   if !Empty ( ::oAlbCliL )
      ::oAlbCliL:End()
   end

   if !Empty ( ::oAlbPrvT )
      ::oAlbPrvT:End()
   end

   if !Empty ( ::oAlbPrvL )
      ::oAlbPrvL:End()
   end

   if !Empty ( ::oDbfDiv )
      ::oDbfDiv:End()
   end

   if !Empty ( ::oDbfClient )
      ::oDbfClient:End()
   end

   if !Empty ( ::oDbfArt )
      ::oDbfArt:End()
   end

   if !Empty ( ::oDbfIva )
      ::oDbfIva:End()
   end

   if !Empty ( ::oDbfPrv )
      ::oDbfPrv:End()
   end

   if !Empty ( ::oDbfPrvArt )
      ::oDbfPrvArt:End()
   end

   if !Empty ( ::oTikCliT )
      ::oTikCliT:End()
   end

   if !Empty ( ::oTikCliL )
      ::oTikCliL:End()
   end

   if !Empty ( ::oDbfFam )
      ::oDbfFam:End()
   end

   ::oAlbCliT     := nil
   ::oAlbCliL     := nil
   ::oAlbPrvT     := nil
   ::oAlbPrvL     := nil
   ::oDbfDiv      := nil
   ::oDbfClient   := nil
   ::oDbfArt      := nil
   ::oDbfIva      := nil
   ::oDbfPrv      := nil
   ::oDbfPrvArt   := nil
   ::oTikCliT     := nil
   ::oTikCliL     := nil
   ::oDbfFam      := nil


RETURN ( Self )



static FUNCTION TSiges_Activate( oWnd ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   if ! ::OpenFiles()
      Return ( Self )
   end

   ::LoadFromIni()





   ::oDlg = TDialog():New(,,,,, "SIGES",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )





      ::oGetPathFile := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cPathFile, ::cPathFile:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "Folder",, )

      ::oGetPathFile:bHelp := {|| ::oGetPathFile:cText( cGetDir( "Seleccione la ruta" ) ) }





      ::oTree     := TTreeView():Redefine( 100, ::oDlg )








      ::oBtnOk := TButton():ReDefine( 1, {||( ::Import() )}, ::oDlg,,, .F.,,,, .F. )




      ::oBtnCancel := TButton():ReDefine( 2, {||( ::oDlg:end() )}, ::oDlg,,, .F.,,,, .F. )

   ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )





   ::SaveToIni()

   ::CloseFiles()

RETURN ( Self )



static FUNCTION TSiges_Import( ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   local n
   local aFiles

   ::cPathFile    := cPath( ::cPathFile )

   ::oDlg:Disable()

   aFiles         := Directory( ::cPathFile + "*.*" )

   for n := 1 to len( aFiles )

      ::ImportFile( ::cPathFile + aFiles[ n, 1 ] )

   next

   ::oDlg:Enable()

   MsgInfo( "Proceso finalizado" )

RETURN ( Self )



static FUNCTION TSiges_ImportFile( cFile ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   ::oTreeFile    := ::oTree:Add( "Importando fichero " + cFile )
   ::oTree:Select( ::oTreeFile )

   ::oFile        := TTxtFile():New( cFile, 0 )

   if ::oFile:hFile == -1
      ::oTreeFile:Add( "Imposible abrir fichero " + cFile + ", error : " + Str( fError() ) )
   else

      while !( ::oFile:lEoF() )

         ::ProccesLine( ::oFile:ReadLine() )

         ::oFile:Skip()

      end

      ::oFile:End()

   end

RETURN ( Self )



static FUNCTION TSiges_ProccesLine( cLine ) ; local Self AS CLASS TSiges := QSelf() AS CLASS TSiges

   local cNumeroDocumento
   local cNum
   local nRec
   local nOrdAnt

   do case

      case SubStr( cLine, 1, 4 ) == "1004"



         cNumeroDocumento  := "A" + Str( Val( SubStr( cLine, 29, 10 ) ), 9 ) + RetSufEmp()

         if !::oAlbCliT:Seek( cNumeroDocumento )



            ::oAlbCliT:Append()

            ::oAlbCliT:cSerAlb      := "A"
            ::oAlbCliT:nNumAlb      := Val( SubStr( cLine, 29, 10 ) )
            ::oAlbCliT:cSufAlb      := RetSufEmp()
            ::oAlbCliT:cCodCli      := Rjust( SubStr( cLine, 89, 6 ), "0", RetNumCodCliEmp() )
            ::oAlbCliT:cCodObr      := SubStr( cLine, 118, 10 )
            ::oAlbCliT:dFecAlb      := Ctod( SubStr( cLine, 157, 2 ) + "-" + SubStr( cLine, 155, 2 ) + "-" + SubStr( cLine, 151, 4 ) )
            ::oAlbCliT:dFecCre      := Ctod( SubStr( cLine, 157, 2 ) + "-" + SubStr( cLine, 155, 2 ) + "-" + SubStr( cLine, 151, 4 ) )
            ::oAlbCliT:cTimCre      := SubStr( cLine, 159, 2 ) + ":" + SubStr( cLine, 161, 2 )
            ::oAlbCliT:cTurAlb      := cCurSesion()
            ::oAlbCliT:cCodAlm      := Application():codigoAlmacen()
            ::oAlbCliT:cDivAlb      := cDivEmp()
            ::oAlbCliT:cCodPago     := cDefFpg()
            ::oAlbCliT:cCodCaj      := Application():CodigoCaja()
            ::oAlbCliT:cCodUsr      := Auth():Codigo()
            ::oAlbCliT:nVdvAlb      := nChgDiv( cDivEmp(), ::oDbfDiv )
            ::oAlbCliT:lFacturado   := .F.
            ::oAlbCliT:lSndDoc      := .T.
            ::oAlbCliT:dFecEnv      := Ctod( "" )
            ::oAlbCliT:dFecImp      := Ctod( "" )
            ::oAlbCliT:cCodDlg      := Application():CodigoDelegacion()
            ::oAlbCliT:lIvaInc      := .T.

            if SubStr( cLine, 58, 1 )  == "J"
               ::oAlbCliT:nDtoEsp      :=  Val( SubStr( cLine, 59, 2 ) + "." + SubStr( cLine, 61, 2 ) )
            end

            ::oDbfClient:GoTop()

            if ::oDbfClient:Seek( Rjust( SubStr( cLine, 89, 6 ), "0", RetNumCodCliEmp() ) )

               ::oAlbCliT:cNomCli   := ::oDbfClient:Titulo
               ::oAlbCliT:cDirCli   := ::oDbfClient:Domicilio
               ::oAlbCliT:cPobCli   := ::oDbfClient:Poblacion
               ::oAlbCliT:cPrvCli   := ::oDbfClient:Provincia
               ::oAlbCliT:cPosCli   := ::oDbfClient:CodPostal
               ::oAlbCliT:cDniCli   := ::oDbfClient:Nif

            else

               ::oAlbCliT:cNomCli   := Space( 80 )
               ::oAlbCliT:cDirCli   := Space( 100 )
               ::oAlbCliT:cPobCli   := Space( 35 )
               ::oAlbCliT:cPrvCli   := Space( 20 )
               ::oAlbCliT:cPosCli   := Space( 5 )
               ::oAlbCliT:cDniCli   := Space( 15 )

            end

            ::oAlbCliT:Save()

            ::oTreeFile:Add( "Procesando albarán de cliente : A" + "/" + AllTrim( Str( Val( SubStr( cLine, 29, 10 ) ), 9 ) ) + "/" + RetSufEmp() )

         else




            if cNumeroDocumento <> ::cNumOldDocumento

               while ::oAlbCliL:Seek( cNumeroDocumento )
                  ::oAlbCliL:Delete( .F. )
               end

            end

         end



         ::oAlbCliL:Append()

         ::oAlbCliL:cSerAlb      := "A"
         ::oAlbCliL:nNumAlb      := Val( SubStr( cLine, 29, 10 ) )
         ::oAlbCliL:cSufAlb      := RetSufEmp()
         ::oAlbCliL:cRef         := Padr( SubStr( cLine, 6, 8 ), 18 )

         if ::oDbfArt:Seek( Padr( SubStr( cLine, 6, 8 ), 18 ) )
            ::oAlbCliL:cDetalle  := ::oDbfArt:Nombre
            ::oAlbCliL:cUniDad   := ::oDbfArt:cUnidad
            ::oAlbCliL:nPesoKg   := ::oDbfArt:nPesoKg
            ::oAlbCliL:nCosDiv   := ::oDbfArt:pCosto
            ::oAlbCliL:nPvpRec   := ::oDbfArt:PvpRec
         else
            ::oAlbCliL:cDetalle  := Space(250)
            ::oAlbCliL:cUniDad   := Space(2)
            ::oAlbCliL:nPesoKg   := 0
            ::oAlbCliL:nCosDiv   := 0
            ::oAlbCliL:nPvpRec   := 0
         end

         ::oAlbCliL:nPreUnit     := Val( SubStr( cLine, 39, 6 ) + "." + SubStr( cLine, 45, 3 ) )
         ::oAlbCliL:nCanEnt      := 1
         ::oAlbCliL:nUniCaja     := Val( SubStr( cLine, 48, 6 ) + "." + SubStr( cLine, 56, 3 ) )
         ::oAlbCliL:lControl     := .F.
         ::oAlbCliL:lTotLin      := .F.
         ::oAlbCliL:dFecha       := Ctod( SubStr( cLine, 157, 2 ) + "-" + SubStr( cLine, 155, 2 ) + "-" + SubStr( cLine, 151, 4 ) )
         ::oAlbCliL:cAlmLin      := Application():codigoAlmacen()
         ::oAlbCliL:lIvaLin      := .T.
         ::oAlbCliL:nIva         := nIvaCodTer( SubStr( cLine, 57, 1 ), ::oDbfIva:cAlias )

         do case
            case SubStr( cLine, 58, 1 )  == "P"
               ::oAlbCliL:nDtoDiv   :=  Val( SubStr( cLine, 59, 1 ) + "." + SubStr( cLine, 60, 3 ) )
            case SubStr( cLine, 58, 1 )  == "J"
               ::oAlbCliL:nDto      :=  Val( SubStr( cLine, 59, 2 ) + "." + SubStr( cLine, 61, 2 ) )
         end

         ::oAlbCliL:Save()



         ::oTreeFile:Add( Space(5) + "Artículo: " + AllTrim( Padr( SubStr( cLine, 6, 8 ), 18 ) ) + " ; " + AllTrim( Str( Val( SubStr( cLine, 48, 6 ) + "." + SubStr( cLine, 56, 3 ) ) ) ) + " ; " + AllTrim( Str( Val( SubStr( cLine, 39, 6 ) + "." + SubStr( cLine, 45, 3 ) ) ) ) )



         ::cNumOldDocumento      := cNumeroDocumento

      case SubStr( cLine, 1, 4 ) == "1009"



         nRec              := ::oAlbPrvT:Recno()
         nOrdAnt           := ::oAlbPrvT:OrdSetFocus( "CSUALB" )

         if !::oAlbPrvT:Seek( SubStr( cLine, 5, 10 ) )



            ::oAlbPrvT:Append()

            cNum                  := nNewDoc( "A", ::oAlbPrvT:cAlias, "NALBPRV" )
            cNumeroDocumento      := "A" + Str( cNum ) + RetSufEmp()

            ::oAlbPrvT:cSerAlb    := "A"
            ::oAlbPrvT:nNumAlb    := cNum
            ::oAlbPrvT:cSufAlb    := RetSufEmp()
            ::oAlbPrvT:cTurAlb    := cCurSesion()
            ::oAlbPrvT:cCodAlm    := Application():codigoAlmacen()
            ::oAlbPrvT:cCodCaj    := Application():CodigoCaja()
            ::oAlbPrvT:cDivAlb    := cDivEmp()
            ::oAlbPrvT:nVdvAlb    := nChgDiv( cDivEmp(), ::oDbfDiv )
            ::oAlbPrvT:lSndDoc    := .T.
            ::oAlbPrvT:cCodUsr    := Auth():Codigo()
            ::oAlbPrvT:cCodDlg    := Application():CodigoDelegacion()
            ::oAlbPrvT:cCodPgo    := cDefFpg()
            ::oAlbPrvT:lFacturado := .F.
            ::oAlbPrvT:dFecAlb    := Ctod( SubStr( cLine, 76, 2 ) + "-" + SubStr( cLine, 74, 2 ) + "-" + SubStr( cLine, 70, 4 ) )
            ::oAlbPrvT:cSuAlb     := SubStr( cLine, 5, 10 )
            ::oAlbPrvT:dSuAlb     := Ctod( SubStr( cLine, 76, 2 ) + "-" + SubStr( cLine, 74, 2 ) + "-" + SubStr( cLine, 70, 4 ) )
            ::oAlbPrvT:dFecChg    := Ctod( SubStr( cLine, 76, 2 ) + "-" + SubStr( cLine, 74, 2 ) + "-" + SubStr( cLine, 70, 4 ) )
            ::oAlbPrvT:cTimChg    := SubStr( cLine, 78, 2 ) + ":" + SubStr( cLine, 80, 2 )
            ::oAlbPrvT:nDtoEsp    := Val( SubStr( cLine, 82, 2 ) + "." + SubStr( cLine, 84, 2 ) )
            ::oAlbPrvT:cCodPrv    := Rjust( SubStr( cLine, 16, 6 ), "0", RetNumCodPrvEmp() )
            ::oAlbPrvT:cNumPed    := SubStr( cLine, 22, 10 )

            if ::oDbfPrv:Seek( Rjust( SubStr( cLine, 16, 6 ), "0", RetNumCodPrvEmp() ) )

               ::oAlbPrvT:cNomPrv := ::oDbfPrv:Titulo
               ::oAlbPrvT:cDirPrv := ::oDbfPrv:Domicilio
               ::oAlbPrvT:cPobPrv := ::oDbfPrv:Poblacion
               ::oAlbPrvT:cProPrv := ::oDbfPrv:Provincia
               ::oAlbPrvT:cPosPrv := ::oDbfPrv:CodPostal
               ::oAlbPrvT:cDniPrv := ::oDbfPrv:Nif

            else

               ::oAlbPrvT:cNomPrv := Space(35)
               ::oAlbPrvT:cDirPrv := Space(35)
               ::oAlbPrvT:cPobPrv := Space(25)
               ::oAlbPrvT:cProPrv := Space(20)
               ::oAlbPrvT:cPosPrv := Space(5)
               ::oAlbPrvT:cDniPrv := Space(15)

            end

            ::oAlbPrvT:Save()

            ::oTreeFile:Add( "Procesando albarán de proveedor : A" + "/" + AllTrim( Str( cNum, 9 ) ) + "/" + RetSufEmp() )

         else

            cNumeroDocumento  := ::oAlbPrvT:cSerAlb + Str( ::oAlbPrvT:nNumAlb ) + ::oAlbPrvT:cSufAlb

            if cNumeroDocumento <> ::cNumOldDocumento

               while ::oAlbPrvL:Seek( cNumeroDocumento )
                  ::oAlbPrvL:Delete( .F. )
               end

            end

         end



         ::oAlbPrvL:Append()

         ::oAlbPrvL:cSerAlb      := "A"
         ::oAlbPrvL:nNumAlb      := Val( SubStr( cNumeroDocumento, 2, 9 ) )
         ::oAlbPrvL:cSufAlb      := RetSufEmp()
         ::oAlbPrvL:cRef         := Padr( SubStr( cLine, 32, 8 ), 18 )
         ::oAlbPrvL:nUniCaja     := Val( SubStr( cLine, 88, 6 ) + "." + SubStr( cLine, 94, 3 ) )
         ::oAlbPrvL:nCanEnt      := 1
         ::oAlbPrvL:nCanPed      := 1
         ::oAlbPrvL:lIvaLin      := .T.
         ::oAlbPrvL:cAlmLin      := Application():codigoAlmacen()
         ::oAlbPrvL:lControl     := .F.
         ::oAlbPrvL:cNumPed      := SubStr( cLine, 22, 10 )
         ::oAlbPrvL:nPreDiv      := Val( SubStr( cLine, 61, 6 ) + "." + SubStr( cLine, 67, 3 ) )
         ::oAlbPrvL:nDtoLin      := Val( SubStr( cLine, 82, 2 ) + "." + SubStr( cLine, 84, 2 ) )
         ::oAlbPrvL:nIva         := nIva( ::oDbfIva, cDefIva() )

         if ::oDbfArt:Seek( Padr( SubStr( cLine, 32, 8 ), 18 ) )
            ::oAlbPrvL:cDetalle  := ::oDbfArt:Nombre
            ::oAlbPrvL:cUniDad   := ::oDbfArt:cUnidad
         else
            ::oAlbPrvL:cDetalle  := Space(250)
            ::oAlbPrvL:cUniDad   := Space(2)
         end

         ::oAlbPrvL:Save()

      ::oTreeFile:Add( Space(5) + "Artículo: " + AllTrim( Padr( SubStr( cLine, 32, 8 ), 18 ) ) + " ; " + AllTrim( Str( Val( SubStr( cLine, 88, 6 ) + "." + SubStr( cLine, 94, 3 ) ) ) ) + " ; " + AllTrim( Str( Val( SubStr( cLine, 61, 6 ) + "." + SubStr( cLine, 67, 3 ) ) ) ) )

      ::oAlbPrvT:OrdSetFocus( nOrdAnt )
      ::oAlbPrvT:GoTo( nRec )

      ::cNumOldDocumento      := cNumeroDocumento

      case SubStr( cLine, 1, 4 ) == "1017"



         ::oDbfArt:GoTop()

         if !::oDbfArt:Seek( Padr( SubStr( cLine, 22, 8 ), 18 ) )

            ::oTreeFile:Add( "Añadiendo el artículo: " + Padr( SubStr( cLine, 22, 8 ), 18 ) )



            ::oDbfArt:Append()

            ::oDbfArt:Codigo        := Padr( SubStr( cLine, 22, 8 ), 18 )
            ::oDbfArt:Nombre        := Padr( SubStr( cLine, 30, 30 ), 100 )
            ::oDbfArt:cDesTik       := SubStr( cLine, 60, 20 )
            ::oDbfArt:CodeBar       := Padr( SubStr( cLine, 7, 15 ), 20 )
            ::oDbfArt:TipoIva       := cCodTerToCodIva( SubStr( cLine, 97, 1 ), ::oDbfIva:cAlias )
            ::oDbfArt:lIvaInc       := .F.
            ::oDbfArt:cPrvHab       := Rjust( SubStr( cLine, 107, 6 ), "0", RetNumCodPrvEmp() )
            ::oDbfArt:pCosto        := 0
            ::oDbfArt:PvpRec        := 0
            ::oDbfArt:pVenta1       := Val( SubStr( cLine, 131, 6 ) + "." + SubStr( cLine, 137, 3 ) )
            ::oDbfArt:pVtaIva1      := ( ( Val( SubStr( cLine, 131, 6 ) + "." + SubStr( cLine, 137, 3 ) ) * nIvaCodTer( SubStr( cLine, 97, 1 ), ::oDbfIva:cAlias ) ) / 100 )
            ::oDbfArt:nMinimo       := Val( SubStr( cLine, 154, 5 ) + "." + SubStr( cLine, 159, 3 ) )
            ::oDbfArt:LastChg       := GetSysDate()
            ::oDbfArt:dFecChg       := GetSysDate()
            ::oDbfArt:cTimChg       := Time()
            ::oDbfArt:cUnidad       := SubStr( cLine, 153, 1 ) + Space(1)
            ::oDbfArt:cCodUsr       := Auth():Codigo()
            ::oDbfArt:lSndDoc       := .T.

            ::oDbfArt:Save()



            ::oDbfPrvArt:Append()

            ::oDbfPrvArt:cCodArt    := Padr( SubStr( cLine, 22, 8 ), 18 )
            ::oDbfPrvArt:cCodPrv    := Rjust( SubStr( cLine, 107, 6 ), "0", RetNumCodPrvEmp() )
            ::oDbfPrvArt:cRefPrv    := Padr( SubStr( cLine, 113, 15 ), 18 )
            ::oDbfPrvArt:cDivPrv    := cDivEmp()
            ::oDbfPrvArt:lDefPrv    := .T.

            ::oDbfPrvArt:Save()

         else

            ::oTreeFile:Add( "Modificando el artículo: " + Padr( SubStr( cLine, 22, 8 ), 18 ) )

            ::oDbfArt:Load()

            ::oDbfArt:Nombre        := Padr( SubStr( cLine, 30, 30 ), 100 )
            ::oDbfArt:cDesTik       := SubStr( cLine, 60, 20 )
            ::oDbfArt:CodeBar       := Padr( SubStr( cLine, 7, 15 ), 20 )
            ::oDbfArt:TipoIva       := cCodTerToCodIva( SubStr( cLine, 97, 1 ), ::oDbfIva:cAlias )

            if ::oDbfArt:cPrvHab <> Rjust( SubStr( cLine, 107, 6 ), "0", RetNumCodPrvEmp() )
               ::oDbfArt:cPrvHab    := Rjust( SubStr( cLine, 107, 6 ), "0", RetNumCodPrvEmp() )



               ::oDbfPrvArt:OrdSetFocus( "CCODPRV" )

               ::oDbfPrvArt:GoTop()

               if ::oDbfPrvArt:Seek( Rjust( SubStr( cLine, 107, 6 ), "0", RetNumCodPrvEmp() ) + Padr( SubStr( cLine, 22, 8 ), 18 ) )

                  ::oDbfPrvArt:Append()
                  ::oDbfPrvArt:cRefPrv    := Padr( SubStr( cLine, 113, 15 ), 18 )
                  ::oDbfPrvArt:Save()

               else

                  ::oDbfPrvArt:GoTop()

                  while !::oDbfPrvArt:Eof()
                     ::oDbfPrvArt:Load()
                     ::oDbfPrvArt:lDefPrv    := .F.
                     ::oDbfPrvArt:Save()
                  ::oDbfPrvArt:Skip()
                  end

                  ::oDbfPrvArt:Append()

                  ::oDbfPrvArt:cCodArt    := Padr( SubStr( cLine, 22, 8 ), 18 )
                  ::oDbfPrvArt:cCodPrv    := Rjust( SubStr( cLine, 107, 6 ), "0", RetNumCodPrvEmp() )
                  ::oDbfPrvArt:cRefPrv    := Padr( SubStr( cLine, 113, 15 ), 18 )
                  ::oDbfPrvArt:cDivPrv    := cDivEmp()
                  ::oDbfPrvArt:lDefPrv    := .T.

                  ::oDbfPrvArt:Save()

               end

            end

            ::oDbfArt:pVenta1       := Val( SubStr( cLine, 131, 6 ) + "." + SubStr( cLine, 137, 3 ) )
            ::oDbfArt:pVtaIva1      := ( ( Val( SubStr( cLine, 131, 6 ) + "." + SubStr( cLine, 137, 3 ) ) * nIvaCodTer( SubStr( cLine, 97, 1 ), ::oDbfIva:cAlias ) ) / 100 )
            ::oDbfArt:nMinimo       := Val( SubStr( cLine, 154, 5 ) + "." + SubStr( cLine, 159, 3 ) )
            ::oDbfArt:dFecChg       := GetSysDate()
            ::oDbfArt:cTimChg       := Time()
            ::oDbfArt:cUnidad       := SubStr( cLine, 153, 1 ) + Space(1)
            ::oDbfArt:lSndDoc       := .T.

            ::oDbfArt:Save()

         end

      case SubStr( cLine, 1, 4 ) == "1020"



         cNumeroDocumento  := "A" + SubStr( cLine, 29, 10 ) + RetSufEmp()

         if !::oTikCliT:Seek( cNumeroDocumento )



            ::oTikCliT:Append()

            ::oTikCliT:cSerTik      := "A"
            ::oTikCliT:cNumTik      := SubStr( cLine, 33, 10 )
            ::oTikCliT:cSufTik      := RetSufEmp()
            ::oTikCliT:cTipTik      := "1"
            ::oTikCliT:cTurTik      := cCurSesion()
            ::oTikCliT:dFecTik      := Ctod( SubStr( cLine, 157, 2 ) + "-" + SubStr( cLine, 155, 2 ) + "-" + SubStr( cLine, 151, 4 ) )
            ::oTikCliT:cHorTik      := SubStr( cLine, 159, 2 ) + ":" + SubStr( cLine, 161, 2 )
            ::oTikCliT:cCcjTik      := Auth():Codigo()
            ::oTikCliT:cNcjTik      := Application():CodigoCaja()
            ::oTikCliT:cAlmTik      := Application():codigoAlmacen()
            ::oTikCliT:cFpgTik      := cDefFpg()
            ::oTikCliT:cDivTik      := cDivEmp()
            ::oTikCliT:nVdvTik      := nChgDiv( cDivEmp(), ::oDbfDiv )
            ::oTikCliT:cCodDlg      := Application():CodigoDelegacion()
            ::oTikCliT:dFecCre      := Ctod( SubStr( cLine, 157, 2 ) + "-" + SubStr( cLine, 155, 2 ) + "-" + SubStr( cLine, 151, 4 ) )
            ::oTikCliT:cTimCre      := SubStr( cLine, 159, 2 ) + ":" + SubStr( cLine, 161, 2 )
            ::oTikCliT:nTarifa      := 1
            ::oTikCliT:cRetMat      := Padr( SubStr( cLine, 119, 10 ), 20 )
            ::oTikCliT:cCliTik      := Rjust( SubStr( cLine, 94, 6 ), "0", RetNumCodCliEmp() )

            if ::oDbfClient:Seek( Rjust( SubStr( cLine, 94, 6 ), "0", RetNumCodCliEmp() ) )
               ::oTikCliT:cNomTik   := ::oDbfClient:Titulo
               ::oTikCliT:cDirCli   := ::oDbfClient:Domicilio
               ::oTikCliT:cPobCli   := ::oDbfClient:Poblacion
               ::oTikCliT:cPrvCli   := ::oDbfClient:Provincia
               ::oTikCliT:cPosCli   := ::oDbfClient:CodPostal
               ::oTikCliT:cDniCli   := ::oDbfClient:Nif
            else
               ::oTikCliT:cNomTik   := Space( 80 )
               ::oTikCliT:cDirCli   := Space( 100 )
               ::oTikCliT:cPobCli   := Space( 35 )
               ::oTikCliT:cPrvCli   := Space( 20 )
               ::oTikCliT:cPosCli   := Space( 5 )
               ::oTikCliT:cDniCli   := Space( 15 )
            end

            ::oTikCliT:lCloTik      := .F.
            ::oTikCliT:lSndDoc      := .T.
            ::oTikCliT:lPgdTik      := .T.
            ::oTikCliT:lLiqTik      := .T.
            ::oTikCliT:lConTik      := .F.
            ::oTikCliT:lSelDoc      := .T.
            ::oTikCliT:lCnvTik      := .F.
            ::oTikCliT:cNumDoc      := Space( 12 )




            ::oTikCliT:Save()

            ::oTreeFile:Add( "Procesando tiket de cliente : A" + "/" + AllTrim( SubStr( cLine, 33, 10 ) ) + "/" + RetSufEmp() )

         else




            if cNumeroDocumento <> ::cNumOldDocumento

               while ::oTikCliL:Seek( cNumeroDocumento )
                  ::oTikCliL:Delete( .F. )
               end

            end

         end



         ::oTikCliL:Append()

         ::oTikCliL:cSerTil         := "A"
         ::oTikCliL:cNumTil         := SubStr( cLine, 29, 10 )
         ::oTikCliL:cSufTil         := RetSufEmp()
         ::oTikCliL:cCbaTil         := Padr( SubStr( cLine, 6, 8 ), 18 )
         ::oTikCliL:cAlmLin         := Application():codigoAlmacen()
         ::oTikCliL:lControl        := .F.
         ::oTikCliL:lOfeTil         := .F.
         ::oTikCliL:lFreTil         := .F.

         if ::oDbfArt:Seek( Padr( SubStr( cLine, 6, 8 ), 18 ) )
            ::oTikCliL:cNomTil      := ::oDbfArt:Nombre
            ::oTikCliL:cCodFam      := ::oDbfArt:Familia
            ::oTikCliL:cGrpFam      := RetFld( ::oDbfArt:Familia, ::oDbfFam:cAlias, "cCodGrp"  )
            ::oTikCliL:lTipAcc      := ::oDbfArt:lTipAcc
            ::oTikCliL:nCtlStk      := ::oDbfArt:nCtlStock
            ::oTikCliL:nCosDiv      := ::oDbfArt:pCosto
         else
            ::oTikCliL:cNomTil      := Space(250)
            ::oTikCliL:cCodFam      := Space( 8 )
            ::oTikCliL:cGrpFam      := Space( 3 )
            ::oTikCliL:nCtlStk      := 1
            ::oTikCliL:nCosDiv      := 0
         end

         ::oTikCliL:nPvpTil         := Val( SubStr( cLine, 39, 6 ) + "." + SubStr( cLine, 45, 3 ) )
         ::oTikCliL:nUntTil         := Val( SubStr( cLine, 48, 6 ) + "." + SubStr( cLine, 54, 3 ) )
         ::oTikCliL:nIvaTil         := nIvaCodTer( SubStr( cLine, 57, 1 ), ::oDbfIva:cAlias )

         do case
            case SubStr( cLine, 58, 1 ) == "P"
               ::oTikCliL:nDtoLin   := 0
               ::oTikCliL:nDtoDiv   := Val( SubStr( cLine, 59, 1 ) + "." + SubStr( cLine, 60, 3 ) )
            case SubStr( cLine, 58, 1 ) == "J"
               ::oTikCliL:nDtoLin   := Val( SubStr( cLine, 59, 2 ) + "." + SubStr( cLine, 60, 2 ) )
               ::oTikCliL:nDtoDiv   := 0
            Otherwise
               ::oTikCliL:nDtoLin   := 0
               ::oTikCliL:nDtoDiv   := 0
         end

         ::oTikCliL:Save()



         ::oTreeFile:Add( Space(5) + "Artículo: " + AllTrim( Padr( SubStr( cLine, 6, 8 ), 18 ) ) + " ; " + AllTrim( Str( Val( SubStr( cLine, 48, 6 ) + "." + SubStr( cLine, 54, 3 ) ) ) ) + " ; " + AllTrim( Str( Val( SubStr( cLine, 39, 6 ) + "." + SubStr( cLine, 45, 3 ) ) ) ) )



         ::cNumOldDocumento         := cNumeroDocumento

   end

RETURN ( Self )
