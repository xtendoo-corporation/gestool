#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 5 ".\.\Prg\TAuditor.prg"
static oAuditor



Function CreateAuditor()

   if Empty( oAuditor )
      oAuditor    := TAuditor():Create( cPatDat() )
   end

Return nil



Function CloseAuditor()

   if !Empty( oAuditor )
      oAuditor:CloseService()
   end

   oAuditor       := nil

Return nil



Function OpenAuditor()

   if Empty( oAuditor )
      oAuditor    := TAuditor():Create( cPatDat() )
   end

   if !Empty( oAuditor )
      oAuditor:OpenService()
   end

Return nil



Function AddAuditor( cCodUse, cCodMnu, cCodOpe )

Return oAuditor:Add( cCodUse, cCodMnu, cCodOpe )



Function oAuditor()

Return ( oAuditor )



Function ShellAuditor( cPath, oWnd, oMenuItem )








   TAuditor():New( cPath, oWnd, oMenuItem ):Activate()









Return ( oAuditor )



Function AuditorAddEvent( cEvent, cDocument, cTipo )

   if !Empty( oAuditor )
      oAuditor:AddEvent( cEvent, cDocument, cTipo )
   end

Return ( oAuditor )



_HB_CLASS TAuditor ; function TAuditor ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TAuditor", iif( .T., { @TMant() }, { @HBObject() } ), @TAuditor() ) ) ;

   _HB_MEMBER { lOpenFiles } ; oClass:AddMultiData(, .F., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lOpenFiles"}, .F. )

   _HB_MEMBER { cMru } ; oClass:AddMultiData(, "gc_security_agent_16", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cMru"}, .F. )
   _HB_MEMBER { aBmp } ; oClass:AddMultiData(, {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aBmp"}, .F. )

   _HB_MEMBER { oEmpresa } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oEmpresa"}, .F. )

   _HB_MEMBER { oFilter } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFilter"}, .F. )

   _HB_MEMBER { oTree } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTree"}, .F. )
   _HB_MEMBER { oImageList } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oImageList"}, .F. )

   _HB_MEMBER { dInicio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dInicio"}, .F. )
   _HB_MEMBER { dFin } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFin"}, .F. )

   _HB_MEMBER { oCodigoUsuario } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodigoUsuario"}, .F. )
   _HB_MEMBER { cCodigoUsuario } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodigoUsuario"}, .F. )

   _HB_MEMBER { oCodigoEmpresa } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodigoEmpresa"}, .F. )
   _HB_MEMBER { cCodigoEmpresa } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodigoEmpresa"}, .F. )

   _HB_MEMBER { cComentario } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cComentario"}, .F. )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TAuditor_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER OpenService(); oClass:AddMethod( "OpenService", @TAuditor_OpenService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @TAuditor_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TAuditor_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TAuditor_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseService(); oClass:AddMethod( "CloseService", @TAuditor_CloseService(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode); oClass:AddMethod( "Resource", @TAuditor_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AddEvent( cEvent); oClass:AddMethod( "AddEvent", @TAuditor_AddEvent(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER StartAplication(); oClass:AddMethod( "StartAplication", @TAuditor_StartAplication(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EndAplication(); oClass:AddMethod( "EndAplication", @TAuditor_EndAplication(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER BitmapOperacion(); oClass:AddMethod( "BitmapOperacion", @TAuditor_BitmapOperacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AddEventFacturaClientes( nMode, cDocument); oClass:AddMethod( "AddEventFacturaClientes", @TAuditor_AddEventFacturaClientes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER FechayHoraOperacion(); oClass:AddInline( "FechayHoraOperacion", {|Self | ( ( Self ) ), ( Dtoc( ::oDbf:dFecOpe ) + Space( 1 ) + ::oDbf:cTimOpe ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER UsuarioOperacion(); oClass:AddMethod( "UsuarioOperacion", @TAuditor_UsuarioOperacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EmpresaOperacion(); oClass:AddMethod( "EmpresaOperacion", @TAuditor_EmpresaOperacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER NumeroOperacion(); oClass:AddMethod( "NumeroOperacion", @TAuditor_NumeroOperacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER TipoOperacion(); oClass:AddMethod( "TipoOperacion", @TAuditor_TipoOperacion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Filter(); oClass:AddMethod( "Filter", @TAuditor_Filter(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER InitFilter(); oClass:AddMethod( "InitFilter", @TAuditor_InitFilter(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CreateFilter(); oClass:AddMethod( "CreateFilter", @TAuditor_CreateFilter(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AplyFilter(); oClass:AddMethod( "AplyFilter", @TAuditor_AplyFilter(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DropTrigger(); oClass:AddMethod( "DropTrigger", @TAuditor_DropTrigger(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CreateTrigger(); oClass:AddMethod( "CreateTrigger", @TAuditor_CreateTrigger(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TAuditor ;



static FUNCTION TAuditor_Activate( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return ( Self )
   end

   if ::oWndParent <> nil
      ::oWndParent:CloseAll()
   end

   if Empty( ::oDbf ) .OR. !::oDbf:Used()
      ::lOpenFiles      := ::OpenFiles()
   end

   if ::lOpenFiles

      if !::lCreateShell
         ::CreateShell( ::nLevel )
      end






      ::oWndBrw:NewAt( "BUS",,, {||( ::oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )
         ::oWndBrw:AddSeaBar()






      ::oWndBrw:NewAt( "ZOOM",,, {||( ::Zoom() )}, "(Z)oom", "Z",,, 8,, .F. )





      ::oWndBrw:NewAt( "BFILTER",,, {||( ::Filter() )}, "(F)iltrar", "F",,,,, .F. )

      ::oWndBrw:EndButtons( Self )

      if ::cHtmlHelp <> nil
         ::oWndBrw:cHtmlHelp  := ::cHtmlHelp
      end

      ::oWndBrw:Activate(  nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, {|| ::CloseFiles() } )

   end

RETURN ( Self )



static FUNCTION TAuditor_OpenFiles( lExclusive ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local oError
   local oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   If( lExclusive == nil, lExclusive := .F., ) ;

   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

      ::oEmpresa := DbfServer( "Empresa.Dbf", ):NewOpen( "Empresa.Dbf",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oEmpresa:AddBag( "Empresa.Cdx" ) ; ::oEmpresa:AddBag( ) ; ::oEmpresa:AutoIndex()

      ::lOpenFiles      := .T.





      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_flash_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "PedPrv" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "AlbPrv" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "FacPrv" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "MovAlm" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_notebook_user_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_clipboard_empty_user_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_document_empty_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_document_text_businessman_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_cash_register_user_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_document_text_money2_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_briefcase2_user_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_clipboard_empty_bag_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_document_empty_bag_16" ) )
      aAdd( ::aBmp, LoadBitmap( GetResources(), "gc_user_16" ) )

   RECOVER USING oError

      msgStop( "Imposible abrir las bases de datos de auditorias" + Chr(13)+Chr(10) + ErrorMessage( oError ) )
      ::CloseFiles()

      ::lOpenFiles      := .F.

   end
   ErrorBlock( oBlock )

RETURN ( ::lOpenFiles )



static FUNCTION TAuditor_OpenService( lExclusive ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local oError
   local oBlock

   If( lExclusive == nil, lExclusive := .F., ) ;

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::DefineFiles()
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

      ::lOpenFiles      := .T.

   RECOVER USING oError

      msgStop( "Imposible abrir las bases de datos de auditorias" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      ::CloseFiles()

      ::lOpenFiles      := .F.

   end
   ErrorBlock( oBlock )

RETURN ( ::lOpenFiles )



static FUNCTION TAuditor_DefineFiles( cPath, cDriver ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   If( cPath == nil, cPath := cPatDat(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   ::oDbf := DbfServer( "OperationLog.Dbf", "OperationLog" ):New( "OperationLog.Dbf",, ( cDriver() ), "OperationLog", ( cPath ) )

      ::oDbf:AddField( "dDate", "D", 8, 0,,,,, "Fecha", .F., 200, .F., {} )
      ::oDbf:AddField( "cTime", "C", 8, 0,,,,, "Hora", .F., 200, .F., {} )
      ::oDbf:AddField( "cUserName", "C", 40, 0,,,,, "Usuario", .F., 200, .F., {} )
      ::oDbf:AddField( "cTable", "C", 50, 0,,,,, "Tabla", .F., 200, .F., {} )
      ::oDbf:AddField( "cOperation", "C", 50, 0,,,,, "Operación", .F., 200, .F., {} )

      ::oDbf:AddIndex( "dDate", "OperationLog.Cdx", "Dtos( dDate ) + cTime",,, .F., .F., "Fecha",,, .T., .F. )
      ::oDbf:AddIndex( "cTable", "OperationLog.Cdx", "cTable + Dtos( dDate ) + cTime",,, .F., .F., "Tabla",,, .T., .F. )
      ::oDbf:AddIndex( "cOperation", "OperationLog.Cdx", "cOperation + Dtos( dDate ) + cTime",,, .F., .F., "Operacion",,, .T., .F. )



RETURN ( ::oDbf )



static FUNCTION TAuditor_Resource( nMode ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local oDlg
   local oGetUse
   local oGetEmp
   local cTipDoc  := ::TipoOperacion()
   local cNumDoc  := ::NumeroOperacion()

   oDlg = TDialog():New(,,,,, "Auditor",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbf:cCodOpe, ::oDbf:cCodOpe:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbf:dFecOpe, ::oDbf:dFecOpe:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::oDbf:cTimOpe, ::oDbf:cTimOpe:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      oGetUse := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::oDbf:cCodUse, ::oDbf:cCodUse:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, 101 )





      oGetEmp := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::oDbf:cCodEmp, ::oDbf:cCodEmp:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, 151 )

      oGetEmp:oHelpText:cText( oRetFld( ::oDbf:cCodEmp, ::oEmpresa, "cNombre" ) )




      TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cTipDoc, cTipDoc:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 170, { | u | If( PCount()==0, cNumDoc, cNumDoc:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:cComDoc, ::oDbf:cComDoc:= u ) }, oDlg,,,,,,,,, .T., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

RETURN ( oDlg:nResult == 1 )



static FUNCTION TAuditor_CloseService( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   if !Empty( ::oDbf ) .AND. ::oDbf:Used()
      ::oDbf:end()
   end

RETURN .T.



static FUNCTION TAuditor_CloseFiles( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   if !Empty( ::oDbf ) .AND. ::oDbf:Used()
      ::oDbf:end()
   end

   if !Empty( ::oEmpresa ) .AND. ::oEmpresa:Used()
      ::oEmpresa:end()
   end





   aEval( ::aBmp, {| hBmp | DeleteObject( hBmp ) } )

RETURN .T.



static FUNCTION TAuditor_StartAplication( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

RETURN ( ::AddEvent( "Inicio de aplicación" ) )



static FUNCTION TAuditor_EndAplication( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

RETURN ( ::AddEvent( "Salida de aplicación" ) )



static FUNCTION TAuditor_AddEvent( cEvent, cDocument, cTipo ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   If( cDocument == nil, cDocument := "", ) ;
   If( cTipo == nil, cTipo := "", ) ;

RETURN ( .T. )



static FUNCTION TAuditor_AddEventFacturaClientes( nMode, cDocument ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   do case
      case nMode == 1
         ::AddEvent( "Añadida nueva factura de clientes",         cDocument, "11" )
      case nMode == 4
         ::AddEvent( "Duplicada nueva factura de clientes",   cDocument, "11" )
      case nMode == 2
         ::AddEvent( "Modificada factura de clientes",        cDocument, "11" )
   end

RETURN ( .T. )



static FUNCTION TAuditor_BitmapOperacion( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   if !Empty( ::aBmp )

      do case
         case Empty( ::oDbf:cTipDoc )
            Return ( ::aBmp[ 1 ] )
         case ( ::oDbf:cTipDoc == "11" )
            Return ( ::aBmp[ 9 ] )
         case ( ::oDbf:cTipDoc == "18" )
            Return ( ::aBmp[ 12 ] )
      end

   end

Return ( "" )



static FUNCTION TAuditor_UsuarioOperacion( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

return ( ::oDbf:cCodUse )



static FUNCTION TAuditor_EmpresaOperacion( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   if !Empty( ::oEmpresa )
      return ( ::oDbf:cCodEmp + Space( 1 ) + "-" + Space( 1 ) + oRetFld( ::oDbf:cCodEmp, ::oEmpresa, "cNombre" ) )
   end

return ( ::oDbf:cCodEmp )



static FUNCTION TAuditor_NumeroOperacion( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   if Empty( ::oDbf:cNumDoc )
      return ""
   end

   do case
   case ::oDbf:cTipDoc == "12" .OR. ::oDbf:cTipDoc == "15"
      return ( Left( ::oDbf:cNumDoc, 1 ) + "/" + Alltrim( SubStr( ::oDbf:cNumDoc, 2, 10 ) ) + "/" + Alltrim( SubStr( ::oDbf:cNumDoc, 10, 2 ) ) )

   case ::oDbf:cTipDoc == "05"
      return ( Alltrim( Left( ::oDbf:cNumDoc, 9 ) ) + "/" + Alltrim( SubStr( ::oDbf:cNumDoc, 10, 2 ) ) )

   case ::oDbf:cTipDoc == "24" .OR. ::oDbf:cTipDoc == "25" .OR. ::oDbf:cTipDoc == "18" .OR. ::oDbf:cTipDoc == "19"
      return ( Left( ::oDbf:cNumDoc, 1 ) + "/" + Alltrim( SubStr( ::oDbf:cNumDoc, 2, 9 ) ) + "/" + Alltrim( SubStr( ::oDbf:cNumDoc, 11, 2 ) ) + "-" + Alltrim( SubStr( ::oDbf:cNumDoc, 13, 2 ) ) )

   case ::oDbf:cTipDoc == "21"
      return ( ::oDbf:cNumDoc )

   end

return ( Left( ::oDbf:cNumDoc, 1 ) + "/" + Alltrim( SubStr( ::oDbf:cNumDoc, 2, 9 ) ) + "/" + Alltrim( SubStr( ::oDbf:cNumDoc, 11, 2 ) ) )



static FUNCTION TAuditor_TipoOperacion( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local cTextDocument  := "Evento"

   do case
      case ::oDbf:cTipDoc == "21"
         cTextDocument  := "Tabla de clientes"
      case ::oDbf:cTipDoc == "08"
         cTextDocument  := "Presupuestos a clientes"
      case ::oDbf:cTipDoc == "09"
         cTextDocument  := getConfigTraslation("Pedidos de clientes")
      case ::oDbf:cTipDoc == "10"
         cTextDocument  := "Albaranes de clientes"
      case ::oDbf:cTipDoc == "11"
         cTextDocument  := "Facturas de clientes"
      case ::oDbf:cTipDoc == "13"
         cTextDocument  := "Anticipos de clientes"
      case ::oDbf:cTipDoc == "12"
         cTextDocument  := "Tickets de clientes"
      case ::oDbf:cTipDoc == "18"
         cTextDocument  := "Recibos de clientes"
      case ::oDbf:cTipDoc == "15"
         cTextDocument  := "Devoluciones de clientes"
      case ::oDbf:cTipDoc == "16"
         cTextDocument  := "Vales de clientes"
      case ::oDbf:cTipDoc == "17"
         cTextDocument  := "Apartados de clientes"
      case ::oDbf:cTipDoc == "24"
         cTextDocument  := "Ent. pedido"
      case ::oDbf:cTipDoc == "25"
         cTextDocument  := "Ent. albarán"
   end

Return ( cTextDocument )



static FUNCTION TAuditor_Filter( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local oDlg

   ::dInicio         := Ctod( "01/01/" + Str( Year( Date() ) ) )
   ::dFin            := Date()
   ::cCodigoUsuario  := Space( 3 )
   ::cCodigoEmpresa  := Space( 2 )
   ::cComentario     := Space( 100 )

   oDlg = TDialog():New(,,,,, "Auditor_Filter",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )

   ::oTree           := TTreeView():Redefine( 100, oDlg )

   ::oImageList      := TImageList():New( 16, 16 )




   TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::dInicio, ::dInicio:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )




   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::dFin, ::dFin:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   ::oCodigoUsuario := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cCodigoUsuario, ::cCodigoUsuario:= u ) }, oDlg,, "@!",,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 131 )






   ::oCodigoEmpresa := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::cCodigoEmpresa, ::cCodigoEmpresa:= u ) }, oDlg,, "@!",,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 141 )

   ::oCodigoEmpresa:bValid := {|| cEmpresa( ::oCodigoEmpresa, ::oEmpresa:cAlias, ::oCodigoEmpresa:oHelpText ) }
   ::oCodigoEmpresa:bHelp  := {|| BrwEmpresa( ::oCodigoEmpresa, ::oEmpresa:cAlias, ::oCodigoEmpresa:oHelpText ) }



   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::cComentario, ::cComentario:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




   TButton():ReDefine( 500, {||( ::AplyFilter() )}, oDlg,,, .F.,,,, .F. )




   TButton():ReDefine( 510, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F. )

   oDlg:AddFastKey( 116, {|| ::AplyFilter() } )

   oDlg:Activate( , , , .T., , , {|| ::InitFilter() } )

Return ( oDlg:nResult == 1 )



static FUNCTION TAuditor_InitFilter( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local oTree

   ::oImageList:AddMasked( TBitmap():Define( "gc_flash_16" ),           ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_document_text_businessman_16" ),  ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_briefcase2_user_16" ), ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_user_16" ),           ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )

   oTree       := ::oTree:Add( "Eventos",                      0 )
                  oTree:Add( "Inicio de aplicación",                 0 )
                  oTree:Add( "Salida de aplicación",                   0 )
                  oTree:Add( "Inicio facturas de clientes",           0 )
                  oTree:Add( "Salida facturas de clientes",             0 )

   oTree       := ::oTree:Add( "Facturas clientes",            1 )
                  oTree:Add( "Añadida nueva factura de clientes",             1 )
                  oTree:Add( "Duplicada nueva factura de clientes",       1 )
                  oTree:Add( "Modificada factura de clientes",            1 )
                  oTree:Add( "Eliminada factura de clientes",          1 )
                  oTree:Add( "Impresa factura de clientes",           1 )
                  oTree:Add( "Previsualizada factura de clientes",         1 )
                  oTree:Add( "Liquidada factura de clientes",         1 )
                  oTree:Add( "Contabiliza factura de clientes",            1 )
                  oTree:Add( "Marca como contabilizada factura de clientes",       1 )
                  oTree:Add( "Marca como no contabilizada factura de clientes",     1 )

   oTree       := ::oTree:Add( "Recibos clientes",             2 )
                  oTree:Add( "Genera recibo de factura de clientes", 2 )

   oTree       := ::oTree:Add( "Clientes",                     3 )
                  oTree:Add( "Inicio de cliente",                   3 )
                  oTree:Add( "Salida de cliente",                     3 )
                  oTree:Add( "Añadido nuevo cliente" ,                    3 )
                  oTree:Add( "Duplicado cliente",               3 )
                  oTree:Add( "Modifica cliente",                    3 )
                  oTree:Add( "Elimina cliente",                  3 )

   ::oTree:SetImagelist( ::oImageList )

Return ( Self )



static FUNCTION TAuditor_CreateFilter( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local oItem
   local aItems
   local cFilterOperacion           := ""
   local cFilterExpresion           := "( dFecOpe >= Ctod( '" + Dtoc( ::dInicio ) + "') .and. dFecOpe <= Ctod( '" + Dtoc( ::dFin ) +"' ) )"

   for each aItems in ::oTree:aItems

      if !Empty( aItems:aItems )

         for each oItem in aItems:aItems


            if ::oTree:GetCheck( oItem )

               if !Empty( cFilterOperacion )
                  cFilterOperacion  += " .or. "
               end

               cFilterOperacion     += "'" + Alltrim( oItem:cPrompt ) + "' $ cCodOpe"

            end

         next

      end

   next

   if !Empty( cFilterOperacion )
      cFilterExpresion              += " .and. "
      cFilterExpresion              += "(" + cFilterOperacion + ")"
   end

   if !Empty( ::cCodigoUsuario )
      cFilterExpresion              += " .and. "
      cFilterExpresion              += "cCodUse == '" + ::cCodigoUsuario + "'"
   end

   if !Empty( ::cCodigoEmpresa )
      cFilterExpresion              += " .and. "
      cFilterExpresion              += "cCodEmp == '" + ::cCodigoEmpresa + "'"
   end

   if !Empty( ::cComentario )
      cFilterExpresion              += " .and. "
      cFilterExpresion              += "cComDoc $ '" + Alltrim( ::cComentario ) + "'"
   end

Return ( cFilterExpresion )



static FUNCTION TAuditor_AplyFilter( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

Return ( Self )



static FUNCTION TAuditor_DropTrigger( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local nError
   local cErrorAds
   local cTrigger := ""
   local lTrigger

   cTrigger       += "DROP TRIGGER DatosAgendaUsr.UpdateDatosAgendaUsr;" + Chr(13)+Chr(10)

   if ADSCreateSQLStatement( "Trigger", 2 )

      lTrigger    := ADSExecuteSQLDirect( cTrigger )
      if !lTrigger

          nError  := AdsGetLastError( @cErrorAds )

          msgStop( cErrorAds, "ERROR DROP TRIGGER en ADSExecuteSQLDirect" )

          Return ( Self )

      endif

   else

      nError      := AdsGetLastError( @cErrorAds )

      msgStop( cErrorAds, "ERROR DROP TRIGGER en ADSCreateSQLStatement" )

   end

Return ( Self )



static FUNCTION TAuditor_CreateTrigger( ) ; local Self AS CLASS TAuditor := QSelf() AS CLASS TAuditor

   local nError
   local cErrorAds
   local cTrigger := ""
   local lTrigger

   cTrigger       += 'CREATE TRIGGER "UpdateDatosAgendaUsr" ON "DatosAgendaUsr" AFTER UPDATE' + Chr(13)+Chr(10)

   cTrigger       += "BEGIN" + Chr(13)+Chr(10)

   cTrigger       += "DECLARE @co CURSOR AS SELECT * FROM __OLD;" + Chr(13)+Chr(10)
   cTrigger       += "DECLARE @cn CURSOR AS SELECT * FROM __NEW;" + Chr(13)+Chr(10)

   cTrigger       += "OPEN @co;" + Chr(13)+Chr(10)
   cTrigger       += "OPEN @cn;" + Chr(13)+Chr(10)

   cTrigger       += "TRY" + Chr(13)+Chr(10)

   cTrigger       += "FETCH @co;" + Chr(13)+Chr(10)
   cTrigger       += "FETCH @cn;" + Chr(13)+Chr(10)

   cTrigger       += "INSERT INTO DatosOperationLog ( dDate, cTime, cOperation )" + Chr(13)+Chr(10)
   cTrigger       += "VALUES ( cast( Now() as sql_date ), cast( CurTime() as sql_varchar ), " + "'" + "UPDATE" + "'" + " );" + Chr(13)+Chr(10)

   cTrigger       += "FINALLY" + Chr(13)+Chr(10)

   cTrigger       += "CLOSE @co;" + Chr(13)+Chr(10)
   cTrigger       += "CLOSE @cn;" + Chr(13)+Chr(10)

   cTrigger       += "END TRY;" + Chr(13)+Chr(10)

   cTrigger       += "END;" + Chr(13)+Chr(10)

   if ADSCreateSQLStatement( "Trigger", 2 )

      lTrigger    := ADSExecuteSQLDirect( cTrigger )
      if !lTrigger

          nError  := AdsGetLastError( @cErrorAds )

          msgStop( cErrorAds, "ERROR CREATE TRIGGER en ADSExecuteSQLDirect" )

          Return ( Self )

      endif

   else

      nError      := AdsGetLastError( @cErrorAds )

      msgStop( cErrorAds, "ERROR CREATE TRIGGER en ADSCreateSQLStatement" )

   end

Return ( Self )
