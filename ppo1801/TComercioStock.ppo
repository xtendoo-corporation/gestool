#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 9 ".\Prg\Comercio\TComercioStock.prg"
_HB_CLASS TComercioStock ; function TComercioStock ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TComercioStock", iif( .T., { @TComercioConector() }, { @HBObject() } ), @TComercioStock() ) ) ;

   _HB_MEMBER { TComercio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"TComercio"}, .F. )

   _HB_MEMBER { oWaitMeter } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oWaitMeter"}, .F. )

   _HB_MEMBER { externalsProductsToUpdate } ; oClass:AddMultiData(, {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"externalsProductsToUpdate"}, .F. )
   _HB_MEMBER { hProductsToUpdate } ; oClass:AddMultiData(, {=>}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"hProductsToUpdate"}, .F. )

   _HB_MEMBER resetProductsToUpdateStocks(); oClass:AddInline( "resetProductsToUpdateStocks", {|Self | ( ( Self ) ), ( ::hProductsToUpdate := {=>} ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getProductsToUpadateStocks(); oClass:AddInline( "getProductsToUpadateStocks", {|Self | ( ( Self ) ), ( ::hProductsToUpdate ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )



   _HB_MEMBER buildListProductToUpdate(); oClass:AddMethod( "buildListProductToUpdate", @TComercioStock_buildListProductToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER calculateStocksProductsToUpdate(); oClass:AddMethod( "calculateStocksProductsToUpdate", @TComercioStock_calculateStocksProductsToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER calculateStocksProductToUpdate(); oClass:AddMethod( "calculateStocksProductToUpdate", @TComercioStock_calculateStocksProductToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
         _HB_MEMBER addStockProductToUpdate( hProduct); oClass:AddMethod( "addStockProductToUpdate", @TComercioStock_addStockProductToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setIdAttributeProductsToUpdate(); oClass:AddMethod( "setIdAttributeProductsToUpdate", @TComercioStock_setIdAttributeProductsToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER setIdAttributeProductToUpdate(); oClass:AddMethod( "setIdAttributeProductToUpdate", @TComercioStock_setIdAttributeProductToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
         _HB_MEMBER setIdAttributeProductStockToUpdate( hStockProductData); oClass:AddMethod( "setIdAttributeProductStockToUpdate", @TComercioStock_setIdAttributeProductStockToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER createCommandProductsToUpdate(); oClass:AddMethod( "createCommandProductsToUpdate", @TComercioStock_createCommandProductsToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER createCommandProductToUpdate(); oClass:AddMethod( "createCommandProductToUpdate", @TComercioStock_createCommandProductToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
         _HB_MEMBER getCommandProductToUpdate(); oClass:AddMethod( "getCommandProductToUpdate", @TComercioStock_getCommandProductToUpdate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER insertProductsToUpadateStocks(); oClass:AddMethod( "insertProductsToUpadateStocks", @TComercioStock_insertProductsToUpadateStocks(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )



   _HB_MEMBER appendProductsToUpadateStocks(); oClass:AddMethod( "appendProductsToUpadateStocks", @TComercioStock_appendProductsToUpadateStocks(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER updateWebProductStocks(); oClass:AddMethod( "updateWebProductStocks", @TComercioStock_updateWebProductStocks(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )



   _HB_MEMBER getIdAttributeProductStock( idProductPrestashop, idFirstProperty, valueFirstProperty, idSecondProperty, valueSecondProperty); oClass:AddMethod( "getIdAttributeProductStock", @TComercioStock_getIdAttributeProductStock(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER updateProductStocks( cWebName, aProductsWeb); oClass:AddMethod( "updateProductStocks", @TComercioStock_updateProductStocks(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER idProductAttribute( idProductPrestashop, attributeFirstProperty, attributeSecondProperty); oClass:AddMethod( "idProductAttribute", @TComercioStock_idProductAttribute(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER evalProductsToStock(); oClass:AddMethod( "evalProductsToStock", @TComercioStock_evalProductsToStock(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getIdProductPrestashop(); oClass:AddMethod( "getIdProductPrestashop", @TComercioStock_getIdProductPrestashop(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER executeMultiCommand( cMultiCommand); oClass:AddMethod( "executeMultiCommand", @TComercioStock_executeMultiCommand(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TComercioStock ;



static FUNCTION TComercioStock_buildListProductToUpdate( startIdProduct ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local idProductAttribute
   local idProductPrestashop

   ::resetProductsToUpdateStocks()

   ( D():Articulos( ::getView() ) )->( ordsetfocus( "lWebShop" ) )

   if ( D():Articulos( ::getView() ) )->( dbseek( startIdProduct ) )

      while ( alltrim( ( D():Articulos( ::getView() ) )->cWebShop ) == ::getCurrentWebName() ) .AND. !( ( D():Articulos( ::getView() ) )->( eof() ) )

         ::writeText( alltrim( ( D():Articulos( ::getView() ) )->Codigo ) + space( 1 ) + alltrim( ( D():Articulos( ::getView() ) )->Nombre ) )

         idProductPrestashop     := ::getIdProductPrestashop( ( D():Articulos( ::getView() ) )->Codigo, ::getCurrentWebName() )

         if idProductPrestashop <> 0
            ::insertProductsToUpadateStocks( ( D():Articulos( ::getView() ) )->Codigo, idProductPrestashop, ::getCurrentWebName() )
         end

         ( D():Articulos( ::getView() ) )->( dbskip() )

      end

   else

      msgStop( ::getCurrentWebName(), "no encontrado" )

   end

Return ( self )



static FUNCTION TComercioStock_appendProductsToUpadateStocks( idProduct, nView ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local nScan
   local cWebShop
   local idProductPrestashop

   if Empty( nView )
      Return ( self )
   end

   if D():gotoArticulos( idProduct, nView )
      cWebShop                := ( D():Articulos( nView ) )->cWebShop
   end

   if empty(cWebShop)
      Return ( self )
   end

   idProductPrestashop        := ::getIdProductPrestashop( idProduct, cWebShop )

   if empty(idProductPrestashop)
      Return ( self )
   end

   ::insertProductsToUpadateStocks( idProduct, idProductPrestashop, cWebShop )

Return ( self )



static FUNCTION TComercioStock_insertProductsToUpadateStocks( idProduct, idProductPrestashop, cWebShop, idFirstProperty, valueFirstProperty, idSecondProperty, valueSecondProperty ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local nScan
   local hProduct







   hProduct          := {  "id"                    => idProduct, "idProductPrestashop"   => idProductPrestashop, "idFirstProperty"       => idFirstProperty, "valueFirstProperty"    => valueFirstProperty, "idSecondProperty"      => idSecondProperty, "valueSecondProperty"   => valueSecondProperty, "commandSQL"            => "" }

   nScan             := hscan( ::hProductsToUpdate, {|k,v| k == cWebShop } )
   if nScan == 0
      hset( ::hProductsToUpdate, cWebShop, { hProduct } )
   else
      if ascan( ::hProductsToUpdate[ cWebShop ], {|h| hget( h, "id" ) == idProduct .AND. hget( h, "idFirstProperty" ) == idFirstProperty .AND. hget( h, "valueFirstProperty" ) == valueFirstProperty .AND. hget( h, "idSecondProperty" ) == idSecondProperty .AND. hget( h, "valueSecondProperty" ) == valueSecondProperty } )  == 0
         aadd( ::hProductsToUpdate[ cWebShop ], hProduct )
      end
   end

Return ( ::hProductsToUpdate )



static FUNCTION TComercioStock_updateWebProductStocks( ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   if !( ::TComercioConfig():isRealTimeConexion() )
      Return .F.
   end

   if empty(::hProductsToUpdate)
      Return .F.
   end

   ::oWaitMeter      := TWaitMeter():New( "Actualizando stocks", "Espere por favor..." ):Run()

   ::calculateStocksProductsToUpdate()

   ::createCommandProductsToUpdate()

   ::oWaitMeter:End()

Return ( .T. )



static FUNCTION TComercioStock_updateProductStocks( cWebName, aProductsWeb ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   ::TComercioConfig():setCurrentWebName( cWebName )

   ::calculateStocksProductToUpdate( aProductsWeb )

   ::setIdAttributeProductsToUpdate()

Return ( Self )



static FUNCTION TComercioStock_addStockProductToUpdate( hProduct ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local hStock
   local nTotalStock             := 0
   local aStockArticulo
   local idProductAttribute      := 0
   local aStockProducts          := {}
   local idProduct               := hget( hProduct, "id" )
   local idProductPrestashop     := hget( hProduct, "idProductPrestashop" )
   local idFirstProperty         := hget( hProduct, "idFirstProperty" )
   local valueFirstProperty      := hget( hProduct, "valueFirstProperty" )
   local idSecondProperty        := hget( hProduct, "idSecondProperty" )
   local valueSecondProperty     := hget( hProduct, "valueSecondProperty" )

   if !empty(::oWaitMeter)
      ::oWaitMeter:setMessage( "Calculando stocks " + alltrim( idProduct ) )
   end

   ::writeText( "Calculando stocks " + alltrim( idProduct ) )



   aStockArticulo                := StocksModel():aStockArticulo( idProduct, ::TComercioConfig():getStore() )



   for each hStock in aStockArticulo





      if ( hGet( hStock, "articulo" ) == idProduct )                                                           .AND. ( empty( idFirstProperty )       .OR. ( hGet( hStock, "propiedad1" ) == idFirstProperty ) )   .AND. ( empty( valueFirstProperty )    .OR. ( hGet( hStock, "valor1" ) == valueFirstProperty ) ) .AND. ( empty( idSecondProperty )      .OR. ( hGet( hStock, "propiedad2" ) == idSecondProperty ) )  .AND. ( empty( valueSecondProperty )   .OR. ( hGet( hStock, "valor2" ) == valueSecondProperty ) )



            nTotalStock          += hGet( hStock, "unidades" )

            if ( !empty( hGet( hStock, "valor1" ) ) .OR. !empty( hGet( hStock, "valor2" ) ) )







               aadd( aStockProducts,   {  "idProduct"             => idProduct, "idProductAttribute"    => idProductAttribute, "idFirstProperty"       => hGet( hStock, "propiedad1" ), "idSecondProperty"      => hGet( hStock, "propiedad2" ), "valueFirstProperty"    => hGet( hStock, "valor1" ), "valueSecondProperty"   => hGet( hStock, "valor2" ), "unitStock"             => hGet( hStock, "unidades" ) } )

            end



      end

   next



   idProductAttribute            := 0







   aadd( aStockProducts,         {  "idProduct"             => idProduct , "idProductAttribute"    => idProductAttribute, "idFirstProperty"       => space( 20 ) , "idSecondProperty"      => space( 20 ) , "valueFirstProperty"    => space( 20 ) , "valueSecondProperty"   => space( 20 ) , "unitStock"             => nTotalStock } )

   hset( hProduct, "stocks", aStockProducts )

Return .T.



static FUNCTION TComercioStock_setIdAttributeProductsToUpdate( ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local hProductsToUpdate

   ::meterProcesoSetTotal( len( ::hProductsToUpdate ) )

   for each hProductsToUpdate in ::hProductsToUpdate

      ::setIdAttributeProductToUpdate( hProductsToUpdate )

      ::meterProcesoText()

   next

Return .T.



static FUNCTION TComercioStock_setIdAttributeProductToUpdate( hProductsToUpdate ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   aeval( hget( hProductsToUpdate, "stocks" ), {|hStock| ::setIdAttributeProductStockToUpdate( hProductsToUpdate, @hStock ) } )

Return .T.



static FUNCTION TComercioStock_setIdAttributeProductStockToUpdate( hProduct, hStock ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local idProductAttribute      := 0
   local attributeFirstProperty  := 0
   local attributeSecondProperty := 0

   if !empty( hget( hStock, "valueFirstProperty" ) )
      attributeFirstProperty     := ::TPrestashopId():getValueAttribute( hget( hStock, "idFirstProperty" ) + hget( hStock, "valueFirstProperty" ), ::getCurrentWebName() )
   end

   if !empty( hget( hStock, "valueSecondProperty" ) )
      attributeSecondProperty    := ::TPrestashopId():getValueAttribute( hget( hStock, "idSecondProperty" ) + hget( hStock, "valueSecondProperty" ), ::getCurrentWebName() )
   end

   if ( attributeFirstProperty <> 0 ) .AND. ( attributeSecondProperty <> 0 )
      idProductAttribute         := ::idProductAttribute( hget( hProduct, "idProductPrestashop" ), attributeFirstProperty, attributeSecondProperty )
   end

Return ( idProductAttribute )



static FUNCTION TComercioStock_getIdAttributeProductStock( idProductPrestashop, idFirstProperty, valueFirstProperty, idSecondProperty, valueSecondProperty ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local idProductAttribute      := 0
   local attributeFirstProperty  := 0
   local attributeSecondProperty := 0

   If( idFirstProperty == nil, idFirstProperty := space( 20 ), ) ;
   If( valueFirstProperty == nil, valueFirstProperty := space( 20 ), ) ;
   If( idSecondProperty == nil, idSecondProperty := space( 20 ), ) ;
   If( valueSecondProperty == nil, valueSecondProperty := space( 20 ), ) ;

   if !empty( valueFirstProperty )
      attributeFirstProperty     := ::TPrestashopId():getValueAttribute( idFirstProperty + valueFirstProperty, ::getCurrentWebName() )
   end

   if !empty( valueSecondProperty )
      attributeSecondProperty    := ::TPrestashopId():getValueAttribute( idSecondProperty + valueSecondProperty, ::getCurrentWebName() )
   end

   if ( attributeFirstProperty <> 0 ) .OR. ( attributeSecondProperty <> 0 )
      idProductAttribute         := ::idProductAttribute( idProductPrestashop, attributeFirstProperty, attributeSecondProperty )
   end

Return ( idProductAttribute )



static FUNCTION TComercioStock_createCommandProductsToUpdate( ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   heval( ::hProductsToUpdate, {|cWebName, aProductsWeb| ::createCommandProductToUpdate( cWebName, aProductsWeb ) } )

Return .T.



static FUNCTION TComercioStock_createCommandProductToUpdate( cWebName, aProductsToUpdate ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local cCommand
   local hProduct

   ::TComercioConfig():setCurrentWebName( cWebName )

   ::meterProcesoSetTotal( len( ::hProductsToUpdate ) )

    if ::prestaShopConnect()

      for each hProduct in aProductsToUpdate

         if !empty( hProduct )

            cCommand    := ::getCommandProductToUpdate( hProduct )

            if !empty(cCommand)
               ::executeMultiCommand( cCommand )
            end

            ::TComercio:saveLastInsertStock( hget( hProduct, "id" ) )

         end

      next

      ::prestaShopDisConnect()

      Return .T.

   end

Return .T.



static FUNCTION TComercioStock_getCommandProductToUpdate( hProduct ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local cText
   local aStock
   local hStock
   local cCommand             := ""
   local nTotalStock          := 0
   local idProductAttribute   := 0

   if !( hhaskey( hProduct, "stocks" ) )
      Return ( cCommand )
   end

   aStock                     := hget( hProduct, "stocks" )


   cCommand                   += "DELETE FROM " + ::cPrefixTable( "stock_available" )                                   +  " WHERE id_product = " + alltrim( str( hget( hProduct, "idProductPrestashop" ) ) )     + ";"

   for each hStock in aStock

      idProductAttribute      := ::TPrestashopId():getValueProductAttributeCombination( hget( hProduct, "id" ) + hget( hStock, "idFirstProperty" ) + hget( hStock, "valueFirstProperty" ) + hget( hStock, "idSecondProperty" ) + hget( hStock, "valueSecondProperty" ), ::getCurrentWebName() )

      if ( .T. )
















         cCommand             += "INSERT IGNORE INTO " + ::cPrefixTable( "stock_available" ) + " ( "                    +  "id_product, "                                                                      +  "id_product_attribute, "                                                            +  "id_shop, "                                                                         +  "id_shop_group, "                                                                   +  "quantity, "                                                                        +  "depends_on_stock, "                                                                +  "out_of_stock ) "                                                                   +  "VALUES ( "                                                                            +  "'" + alltrim( str( hget( hProduct, "idProductPrestashop" ) ) ) + "', "             +  "'" + alltrim( str( idProductAttribute ) ) + "', "                                  +  "'1', "                                                                             +  "'0', "                                                                             +  "'" + alltrim( str( hget( hStock, "unitStock" ) ) ) + "', "                         +  "'0', "                                                                             +  "'2' )"                                                                             + ";"

         nTotalStock          += hget( hStock, "unitStock" )

      end

      cText                   := "Actualizando stock, propiedades "
      cText                   += alltrim( hget( hProduct, "id" ) )                                                      + ", "
      cText                   += alltrim( str( hget( hProduct, "idProductPrestashop" ) ) )                              + ", "
      cText                   += alltrim( hget( hStock, "valueFirstProperty"  ) )                                       + ", "
      cText                   += alltrim( hget( hStock, "valueSecondProperty" ) )                                       + ", "
      cText                   += "cantidad : " + alltrim( str( hget( hStock, "unitStock" ) ) )


   next

   if ( nTotalStock <= 0 ) .AND. ( TComercioConfig():isDeleteWithoutStock() )



      cCommand                := "UPDATE  " + ::cPrefixTable( "product" )                                               +  " SET active = 0, indexed = 0"                                                         +  " WHERE id_product = '" + alltrim( str( hget( hProduct, "idProductPrestashop" ) ) )    + "';"

      cText                   := "Desactivando artículo "
      cText                   += alltrim( hget( hProduct, "id" ) )                                                      + ", "
      cText                   += alltrim( str( hget( hProduct, "idProductPrestashop" ) ) )                              + ", "

   end

   if !empty(::oWaitMeter)
      ::oWaitMeter:setMessage( cText )
   end

   ::writeText( cText )

Return ( cCommand )



static FUNCTION TComercioStock_idProductAttribute( idProductPrestashop, attributeFirstProperty, attributeSecondProperty ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local oQuery
   local oQuery2
   local lPrp1                := .F.
   local lPrp2                := .F.
   local cCommand             := ""
   local idProductAttribute   := 0

   do case
      case !empty( attributeFirstProperty ) .AND. empty( attributeSecondProperty )

         cCommand             := "SELECT * FROM " + ::cPrefixTable( "product_attribute" ) + " WHERE id_product = " + alltrim( str( idProductPrestashop ) )

         ::writeText( cCommand )

         oQuery               := TMSQuery():New( ::oConexionMySQLDatabase(), cCommand )

         if oQuery:Open() .AND. oQuery:recCount() > 0

            oQuery:GoTop()
            while !oQuery:Eof()

               cCommand       := "SELECT * FROM " + ::cPrefixTable( "product_attribute_combination" ) + " WHERE id_product_attribute = " + alltrim( str( oQuery:FieldGet( 1 ) ) )

               ::writeText( cCommand )

               oQuery2        := TMSQuery():New( ::oConexionMySQLDatabase(), cCommand )

               if oQuery2:Open() .AND. oQuery2:recCount() == 1 .AND. oQuery2:fieldGet( 1 ) == attributeFirstProperty
                  idProductAttribute     := oQuery:fieldGet( 1 )
                  exit
               end

               oQuery:Skip()

            end

         end

      case !empty( attributeFirstProperty ) .AND. !empty( attributeSecondProperty )

         cCommand             := "SELECT * FROM " + ::cPrefixTable( "product_attribute" ) + " WHERE id_product = " + alltrim( str( idProductPrestashop ) )

         ::writeText( cCommand )

         oQuery               := TMSQuery():New( ::oConexionMySQLDatabase(), cCommand )

         if oQuery:Open()

            oQuery:GoTop()
            while !oQuery:Eof()

               cCommand       := "SELECT * FROM " + ::cPrefixTable( "product_attribute_combination" ) + " WHERE id_product_attribute=" + alltrim( str( oQuery:FieldGet( 1 ) ) )

               ::writeText( cCommand )

               oQuery2        := TMSQuery():New( ::oConexionMySQLDatabase(), cCommand )

               if oQuery2:Open() .AND. oQuery2:recCount() == 2

                  oQuery2:GoTop()
                  while !oQuery2:Eof()

                     if !lPrp1
                        lPrp1 := ( oQuery2:FieldGet( 1 ) == attributeFirstProperty )
                        exit
                     end

                     oQuery2:Skip()

                  end

                  oQuery2:GoTop()
                  while !oQuery2:Eof()

                     if !lPrp2
                        lPrp2 := ( oQuery2:FieldGet( 1 ) == attributeSecondProperty )
                        exit
                     end

                     oQuery2:Skip()

                  end

                  if lPrp1 .AND. lPrp2
                     idProductAttribute     := oQuery:FieldGet( 1 )
                     exit
                  end

               end

               oQuery:Skip()

               lPrp1          := .F.
               lPrp2          := .F.

            end

         end

   end

Return idProductAttribute



static FUNCTION TComercioStock_calculateStocksProductsToUpdate( ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   heval( ::hProductsToUpdate, {|cWebName, aProductsWeb| ::calculateStocksProductToUpdate( cWebName, aProductsWeb ) } )

Return ( self )



static FUNCTION TComercioStock_calculateStocksProductToUpdate( cWebName, aProducts ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local hProduct

   ::meterProcesoSetTotal( len( aProducts ) )

   for each hProduct in aProducts

      ::addStockProductToUpdate( hProduct )

      ::meterProcesoText()

   next

Return .F.



static FUNCTION TComercioStock_evalProductsToStock( ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   if ::prestaShopConnect()

      heval( ::hProductsToUpdate, {|cWebName, aProductsWeb| ::updateProductStocks( cWebName, aProductsWeb ) } )

      ::prestaShopDisConnect()

   end

Return ( Self )



static FUNCTION TComercioStock_getIdProductPrestashop( idProductgestool, cCurrentWebName ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local idProductPrestashop     := ::TPrestashopId():getValueProduct( idProductgestool, cCurrentWebName )

   if ( idProductPrestashop == 0 )
      ::writeText( "Producto " + alltrim( idProductgestool ) + " no encontrado en la web " + alltrim( cCurrentWebName ) )
   end

Return ( idProductPrestashop)



static FUNCTION TComercioStock_executeMultiCommand( cMultiCommand ) ; local Self AS CLASS TComercioStock := QSelf() AS CLASS TComercioStock

   local cCommand
   local aCommand := hb_atokens( cMultiCommand, ";")

   for each cCommand in aCommand

      if !empty( cCommand )
         ::commandExecDirect( cCommand )
      end

   next

Return ( self )
