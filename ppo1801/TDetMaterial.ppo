#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 10 ".\.\Prg\TDetMaterial.prg"
_HB_CLASS TDetMaterial ; function TDetMaterial ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TDetMaterial", iif( .T., { @TDetalleArticulos() }, { @HBObject() } ), @TDetMaterial() ) ) ;

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )
   _HB_MEMBER { oFld } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFld"}, .F. )

   _HB_MEMBER { oGetCaja } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetCaja"}, .F. )
   _HB_MEMBER { oGetUnidades } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetUnidades"}, .F. )
   _HB_MEMBER { oGetBultos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetBultos"}, .F. )
   _HB_MEMBER { oGetFormato } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetFormato"}, .F. )
   _HB_MEMBER { oGetPrecio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetPrecio"}, .F. )
   _HB_MEMBER { oLote } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oLote"}, .F. )
   _HB_MEMBER { oFecCad } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFecCad"}, .F. )
   _HB_MEMBER { oSayPr1 } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayPr1"}, .F. )
   _HB_MEMBER { oSayPr2 } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayPr2"}, .F. )
   _HB_MEMBER { oValPr1 } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oValPr1"}, .F. )
   _HB_MEMBER { oValPr2 } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oValPr2"}, .F. )
   _HB_MEMBER { oSayVp1 } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayVp1"}, .F. )
   _HB_MEMBER { oSayVp2 } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayVp2"}, .F. )
   _HB_MEMBER { cOldCodArt } ; oClass:AddMultiData(, "", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cOldCodArt"}, .F. )
   _HB_MEMBER { dOldFecCad } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dOldFecCad"}, .F. )
   _HB_MEMBER { oStkAct } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oStkAct"}, .F. )
   _HB_MEMBER { nStkAct } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nStkAct"}, .F. )
   _HB_MEMBER { oMenu } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oMenu"}, .F. )

   _HB_MEMBER { oGetTotalUnidades } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetTotalUnidades"}, .F. )
   _HB_MEMBER { nGetTotalUnidades } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nGetTotalUnidades"}, .F. )
   _HB_MEMBER { oGetTotalPrecio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetTotalPrecio"}, .F. )
   _HB_MEMBER { nGetTotalPrecio } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nGetTotalPrecio"}, .F. )

   _HB_MEMBER { oGetPes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetPes"}, .F. )
   _HB_MEMBER { oGetUndPes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetUndPes"}, .F. )
   _HB_MEMBER { oGetTotPes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetTotPes"}, .F. )
   _HB_MEMBER { nGetTotPes } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nGetTotPes"}, .F. )
   _HB_MEMBER { oGetVol } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetVol"}, .F. )
   _HB_MEMBER { oGetUndVol } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetUndVol"}, .F. )
   _HB_MEMBER { oGetTotVol } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetTotVol"}, .F. )
   _HB_MEMBER { nGetTotVol } ; oClass:AddMultiData(, 0, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nGetTotVol"}, .F. )

   _HB_MEMBER New( cPath, oParent); oClass:AddMethod( "New", @TDetMaterial_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TDetMaterial_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles( lExclusive); oClass:AddMethod( "OpenFiles", @TDetMaterial_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode, lLiteral); oClass:AddMethod( "Resource", @TDetMaterial_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER SetResource( nMode); oClass:AddMethod( "SetResource", @TDetMaterial_SetResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER SaveResource( oGetArt, oDlg); oClass:AddMethod( "SaveResource", @TDetMaterial_SaveResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER LoaArticulo( oGetArticulo, oGetNombre); oClass:AddMethod( "LoaArticulo", @TDetMaterial_LoaArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SaveDetails(); oClass:AddMethod( "SaveDetails", @TDetMaterial_SaveDetails(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER DeleteDetails(); oClass:AddMethod( "DeleteDetails", @TDetMaterial_DeleteDetails(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nUnidades( oDbf); oClass:AddMethod( "nUnidades", @TDetMaterial_nUnidades(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cUnidades(); oClass:AddInline( "cUnidades", {|Self, oDbf | ( ( Self ) ), ( Trans( ::nUnidades( oDbf ), ::oParent:cPicUnd ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lUnidades(); oClass:AddInline( "lUnidades", {|Self, oDbf | ( ( Self ) ), ( ( ::oGetTotalUnidades:cText( ::nUnidades( oDbf ) ), .T. ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nPrecio(); oClass:AddInline( "nPrecio", {|Self, oDbf | ( ( Self ) ), ( Round( ::nUnidades( oDbf ) * oDbf:FieldGetByName( "nImpOrd" ), ::oParent:nDorDiv ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cPrecio(); oClass:AddInline( "cPrecio", {|Self, oDbf | ( ( Self ) ), ( Trans( ::nPrecio( oDbf ), ::oParent:cPorDiv ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lPrecio(); oClass:AddInline( "lPrecio", {|Self, oDbf | ( ( Self ) ), ( ::oGetTotalPrecio:cText( ::nPrecio( oDbf ) ), .T. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nTotal( oDbf); oClass:AddMethod( "nTotal", @TDetMaterial_nTotal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER cTotal(); oClass:AddInline( "cTotal", {|Self, oDbf | ( ( Self ) ), ( Trans( ::nTotal( oDbf ), ::oParent:cPorDiv ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lTotal(); oClass:AddInline( "lTotal", {|Self, oDbf, oGet | ( ( Self ) ), ( oGet:cText( ::nTotal( oDbf ) ), .T. ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nTotPeso( oDbf); oClass:AddMethod( "nTotPeso", @TDetMaterial_nTotPeso(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER nTotVolumen( oDbf); oClass:AddMethod( "nTotVolumen", @TDetMaterial_nTotVolumen(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lTotPeso( oDbf); oClass:AddMethod( "lTotPeso", @TDetMaterial_lTotPeso(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lTotVolumen( oDbf); oClass:AddMethod( "lTotVolumen", @TDetMaterial_lTotVolumen(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lStkAct(); oClass:AddMethod( "lStkAct", @TDetMaterial_lStkAct(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER EdtRotor( oDlg); oClass:AddMethod( "EdtRotor", @TDetMaterial_EdtRotor(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ActualizaSqlStock( cNumDoc); oClass:AddMethod( "ActualizaSqlStock", @TDetMaterial_ActualizaSqlStock(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER RollBackSqlStock( cNumDoc); oClass:AddMethod( "RollBackSqlStock", @TDetMaterial_RollBackSqlStock(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )



oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TDetMaterial ;



static FUNCTION TDetMaterial_New( cPath, oParent ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   If( cPath == nil, cPath := cPatEmp(), ) ;

   ::cPath                 := cPath
   ::oParent               := oParent

   ::bOnPreSaveDetail      := {|| ::SaveDetails() }
   ::bOnPreDelete          := {|| ::DeleteDetails() }

   ::bOnPreDeleteDetail    := {|| ::RollBackSqlStock( ::oParent:oDbf:cSerOrd + Str( ::oParent:oDbf:nNumOrd ) + ::oParent:oDbf:cSufOrd ) }
   ::bOnPostSaveDetail     := {|| ::ActualizaSqlStock( ::oParent:oDbf:cSerOrd + Str( ::oParent:oDbf:nNumOrd ) + ::oParent:oDbf:cSufOrd ) }

   ::setPathBeforeAppend( "Produccion\MateriaPrima\beforeAppend" )
   ::setPathAfterAppend( "Produccion\MateriaPrima\AfterAppend" )

RETURN ( Self )



static FUNCTION TDetMaterial_DefineFiles( cPath, cVia, lUniqueName, cFileName ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   local oDbf

   If( cPath == nil, cPath := ::cPath, ) ;
   If( lUniqueName == nil, lUniqueName := .F., ) ;
   If( cFileName == nil, cFileName := "ProMat", ) ;
   If( cVia == nil, cVia := cDriver(), ) ;

   if lUniqueName
      cFileName         := cGetNewFileName( cFileName, , , cPath )
   end

   oDbf := DbfServer( ( cFileName ), ( cFileName ) ):New( ( cFileName ), ( cFileName ), ( cVia ), "Materias primas", ( cPath ) )

      oDbf:AddField( "cSerOrd", "C", 01, 0,,,,, "Serie", .F.,, .T., {} )
      oDbf:AddField( "nNumOrd", "N", 09, 0,,,,, "Número", .F.,, .T., {} )
      oDbf:AddField( "cSufOrd", "C", 02, 0,,,,, "Sufijo", .F.,, .T., {} )
      oDbf:AddField( "nNumLin", "N", 04, 0,,,,, "Número de línea", .F., 20, .F., {} )
      oDbf:AddField( "cCodArt", "C", 18, 0,,,,, "Código artículo", .F., 60, .F., {} )
      oDbf:AddField( "cNomArt", "C", 100, 0,,,,, "Nombre artículo", .F., 240, .F., {} )
      oDbf:AddField( "cAlmOrd", "C", 16, 0,,,,, "Almacén", .F., 50, .F., {} )
      oDbf:AddField( "nCajOrd", "N", 16, 6,,,,, "Cajas", .F.,, .T., {} )
      oDbf:AddField( "nUndOrd", "N", 16, 6,,,,, "Unidades", .F.,, .T., {} )
      oDbf:AddField( "nImpOrd", "N", 16, 6,,,,, "Precio", .F., 80, .F., {} )
      oDbf:AddField( "nPeso", "N", 16, 6,,,,, "Peso del artículo", .F., 80, .F., {} )
      oDbf:AddField( "cUndPes", "C", 2, 0,,,,, "Unidad del peso", .F., 80, .F., {} )
      oDbf:AddField( "nVolumen", "N", 16, 6,,,,, "Volumen del artículo", .F., 80, .F., {} )
      oDbf:AddField( "cUndVol", "C", 2, 0,,,,, "Unidad del volumen", .F., 80, .F., {} )
      oDbf:AddField( "cCodPr1", "C", 20, 0,,,,, "Código de primera propiedad", .F., 80, .F., {} )
      oDbf:AddField( "cCodPr2", "C", 20, 0,,,,, "Código de segunda propiedad", .F., 80, .F., {} )
      oDbf:AddField( "cValPr1", "C", 20, 0,,,,, "Valor de primera propiedad", .F., 80, .F., {} )
      oDbf:AddField( "cValPr2", "C", 20, 0,,,,, "Valor de segunda propiedad", .F., 80, .F., {} )
      oDbf:AddField( "lLote", "L", 1, 0,,,,, "Lógico lote", .F., 80, .F., {} )
      oDbf:AddField( "cLote", "C", 64, 0,,,,, "Lote", .F., 80, .F., {} )
      oDbf:AddField( "cCodPro", "C", 18, 0,,,,, "Código del artídulo producido", .F., 80, .F., {} )
      oDbf:AddField( "dFecOrd", "D", 08, 0,,,,, "Fecha", .F.,, .T., {} )
      oDbf:AddField( "nTipArt", "N", 1, 0,,,,, "Clasificación", .F.,, .T., {} )
      oDbf:AddField( "dFecCad", "D", 08, 0,,,,, "Fecha caducidad", .F., 80, .F., {} )
      oDbf:AddField( "cHorIni", "C", 6, 0,,,,, "Hora", .F.,, .T., {} )
      oDbf:AddField( "nBultos", "N", 16, 6,,,,, "Numero de bultos en líneas", .F.,, .T., {} )
      oDbf:AddField( "cFormato", "C", 100, 0,,,,, "Formato", .F.,, .T., {} )
      oDbf:AddField( "lValidado", "L", 10, 0,,,,, "Lógico validado con consolidación", .F.,, .T., {} )

      ::CommunFields( oDbf )

      oDbf:AddIndex( "cNumOrd", ( cFileName ), "cSerOrd + Str( nNumOrd, 9 ) + cSufOrd",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodPro", ( cFileName ), "cCodPro",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodArt", ( cFileName ), "cCodArt",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cArtLot", ( cFileName ), "cCodArt + cValPr1 + cValPr2 + cLote",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nNumLin", ( cFileName ), "Str( nNumLin, 4 )",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cLote", ( cFileName ), "cLote",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cGrpFam", ( cFileName ), "cSerOrd + Str( nNumOrd, 9 ) + cSufOrd + cGrpFam",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodFam", ( cFileName ), "cSerOrd + Str( nNumOrd, 9 ) + cSufOrd + cCodFam",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodTip", ( cFileName ), "cSerOrd + Str( nNumOrd, 9 ) + cSufOrd + cCodTip",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodCat", ( cFileName ), "cSerOrd + Str( nNumOrd, 9 ) + cSufOrd + cCodCat",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodTmp", ( cFileName ), "cSerOrd + Str( nNumOrd, 9 ) + cSufOrd + cCodTmp",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodFab", ( cFileName ), "cSerOrd + Str( nNumOrd, 9 ) + cSufOrd + cCodFab",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nTipArt", ( cFileName ), "cSerOrd + Str( nNumOrd, 9 ) + cSufOrd + Str( nTipArt, 1 )",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "iNumOrd", ( cFileName ), "'30' + cSerOrd + Str( nNumOrd, 9 ) + cSufOrd",,, .F., .F.,,,, .T., .F. )

      oDbf:AddIndex( "cStkFast", ( cFileName ), "cCodArt + cAlmOrd + dtos( dFecOrd ) + cHorIni + cValPr1 + cValPr2 + cLote", "!lValidado",, .F., .T.,,,, .T., .F. )



RETURN ( oDbf )



static FUNCTION TDetMaterial_OpenFiles( lExclusive, cPath ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   local lOpen             := .T.
   local oError
   local oBlock

   If( lExclusive == nil, lExclusive := .F., ) ;

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      if Empty( ::oDbf )
         ::oDbf            := ::DefineFiles( cPath )
      end

      ::oDbf:Activate( .F., !lExclusive )

   RECOVER USING oError

      lOpen                := .F.

      ::CloseFiles()

      msgStop( "Imposible abrir todas las bases de datos" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TDetMaterial_Resource( nMode ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   local oGetArt
   local oGetNom
   local oGetAlm
   local oSayAlm
   local cSayAlm
   local cSayPr1
   local cSayPr2
   local cSayVp1
   local cSayVp2
   local oBtnSer
   local oBtnAdelante
   local oBtnAtras

   ::cOldCodArt         := ::oDbfVir:cCodArt

   if nMode == 1
      ::oDbfVir:cAlmOrd := ::oParent:oDbf:cAlmOrg
      ::oDbfVir:nCajOrd := 1
      ::oDbfVir:nUndOrd := 1
      ::oDbfVir:nNumLin := nLastNum( ::oDbfVir )
   else
      cSayVp1           :=  oRetFld( ::oDbfVir:cCodPr1 + ::oDbfVir:cValPr1, ::oParent:oTblPro, "cDesTbl" )
      cSayVp2           :=  oRetFld( ::oDbfVir:cCodPr2 + ::oDbfVir:cValPr2, ::oParent:oTblPro, "cDesTbl" )
   end

   if !uFieldEmpresa( "lNStkAct" )
      ::nStkAct         := StocksModel():nGlobalStockArticulo( ::oDbfVir:cCodArt, ::oDbfVir:cAlmOrd )
   else
      ::nStkAct         := 0
   end

   ::nGetTotalUnidades  := ::nUnidades( ::oDbfVir )
   ::nGetTotalPrecio    := ::nPrecio( ::oDbfVir )
   ::nGetTotPes         := ::nTotPeso( ::oDbfVir )
   ::nGetTotVol         := ::nTotVolumen( ::oDbfVir )

   cSayAlm              := RetAlmacen( ::oDbfVir:cAlmOrd, ::oParent:oAlm )



   ::oDlg = TDialog():New(,,,, LblTitle( nMode ) + "materia prima", "LProducido",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )







      ::oFld := TFolder():ReDefine( 400, {"&Artículo", "Da&tos"}, { "LProducido_1","LProducido_2" }, ::oDlg,,,,, .F., )










      oGetArt := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbfVir:cCodArt, ::oDbfVir:cCodArt:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

      oGetArt:bValid := {|| ::LoaArticulo( oGetArt, oGetNom ) }
      oGetArt:bHelp  := {|| BrwArticulo( oGetArt, oGetNom, .F., .T., , ::oLote, ::oDbfVir:cCodPr1, ::oDbfVir:cCodPr2, ::oValPr1, ::oValPr2, ::oFecCad  ) }





      oGetNom := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, ::oDbfVir:cNomArt, ::oDbfVir:cNomArt:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||        ( lModDes() .AND. nMode <> 3 )},, .F., .F.,,,,,, nil,,, )










      ::oLote := TGetHlp():ReDefine( 210, { | u | If( PCount()==0, ::oDbfVir:cLote, ::oDbfVir:cLote:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil,, 211, )

      ::oLote:bValid := {|| ::LoaArticulo( oGetArt, oGetNom ) }








      ::oFecCad := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, ::oDbfVir:dFecCad, ::oDbfVir:dFecCad:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 321, )








      ::oSayPr1 := TSay():ReDefine( 221, {|| cSayPr1}, ::oFld:aDialogs[1],,,, .F.,, .F., .F., )






      ::oValPr1 := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, ::oDbfVir:cValPr1, ::oDbfVir:cValPr1:= u ) }, ::oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         ::oValPr1:bValid := {|| lPrpAct( ::oDbfVir:cValPr1, ::oSayVp1, ::oDbfVir:cCodPr1, ::oParent:oTblPro:cAlias ) }
         ::oValPr1:bHelp  := {|| brwPropiedadActual( ::oValPr1, ::oSayVp1, ::oDbfVir:cCodPr1 ) }





      ::oSayVp1 := TGetHlp():ReDefine( 222, { | u | If( PCount()==0, cSayVp1, cSayVp1:= u ) }, ::oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )



      ::oSayPr2 := TSay():ReDefine( 231, {|| cSayPr2}, ::oFld:aDialogs[1],,,, .F.,, .F., .F., )






      ::oValPr2 := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, ::oDbfVir:cValPr2, ::oDbfVir:cValPr2:= u ) }, ::oFld:aDialogs[1],,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil, "LUPA",, )

         ::oValPr2:bValid := {|| lPrpAct( ::oDbfVir:cValPr2, ::oSayVp2, ::oDbfVir:cCodPr2, ::oParent:oTblPro:cAlias ) }
         ::oValPr2:bHelp  := {|| brwPropiedadActual( ::oValPr2, ::oSayVp2, ::oDbfVir:cCodPr2 ) }




      ::oSayVp2 := TGetHlp():ReDefine( 232, { | u | If( PCount()==0, cSayVp2, cSayVp2:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      ::oGetBultos := TGetHlp():ReDefine( 330, { | u | If( PCount()==0, ::oDbfVir:nBultos, ::oDbfVir:nBultos:= u ) }, ::oFld:aDialogs[1],, ::oParent:cPicUnd,,,,,,, .F., {||     ( uFieldEmpresa( "lUseBultos" ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,, 331, )







      ::oGetCaja := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbfVir:nCajOrd, ::oDbfVir:nCajOrd:= u ) }, ::oFld:aDialogs[1],, ::oParent:cPicUnd,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,, 121, )

      ::oGetCaja:bChange   := {|| ::lUnidades( ::oDbfVir ), ::lPrecio( ::oDbfVir ), ::lTotPeso( ::oDbfVir ), ::lTotVolumen( ::oDbfVir ) }
      ::oGetCaja:bValid    := {|| ::lUnidades( ::oDbfVir ), ::lPrecio( ::oDbfVir ), ::lTotPeso( ::oDbfVir ), ::lTotVolumen( ::oDbfVir ) }






      ::oGetUnidades := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::oDbfVir:nUndOrd, ::oDbfVir:nUndOrd:= u ) }, ::oFld:aDialogs[1],, ::oParent:cPicUnd,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      ::oGetUnidades:bChange  := {|| ::lUnidades( ::oDbfVir ), ::lPrecio( ::oDbfVir ), ::lTotPeso( ::oDbfVir ), ::lTotVolumen( ::oDbfVir ) }
      ::oGetUnidades:bValid   := {|| ::lUnidades( ::oDbfVir ), ::lPrecio( ::oDbfVir ), ::lTotPeso( ::oDbfVir ), ::lTotVolumen( ::oDbfVir ) }





      ::oGetTotalUnidades := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::nGetTotalUnidades, ::nGetTotalUnidades:= u ) }, ::oFld:aDialogs[1],, ::oParent:cPicUnd,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )






      ::oGetPrecio := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::oDbfVir:nImpOrd, ::oDbfVir:nImpOrd:= u ) }, ::oFld:aDialogs[1],, ::oParent:cPouDiv,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      ::oGetPrecio:bChange := {|| ::lPrecio( ::oDbfVir ) }
      ::oGetPrecio:bChange := {|| ::lPrecio( ::oDbfVir ) }





      ::oGetTotalPrecio := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::nGetTotalPrecio, ::nGetTotalPrecio:= u ) }, ::oFld:aDialogs[1],, ::oParent:cPorDiv,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      ::oGetPes := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::oDbfVir:nPeso, ::oDbfVir:nPeso:= u ) }, ::oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      ::oGetPes:bChange   := {|| ::lTotPeso( ::oDbfVir ) }
      ::oGetPes:bValid    := {|| ::lTotPeso( ::oDbfVir ) }




      ::oGetUndPes := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, ::oDbfVir:cUndPes, ::oDbfVir:cUndPes:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      ::oGetTotPes := TGetHlp():ReDefine( 172, { | u | If( PCount()==0, ::nGetTotPes, ::nGetTotPes:= u ) }, ::oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      ::oGetVol := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, ::oDbfVir:nVolumen, ::oDbfVir:nVolumen:= u ) }, ::oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )

      ::oGetVol:bChange   := {|| ::lTotVolumen( ::oDbfVir ) }
      ::oGetVol:bValid    := {|| ::lTotVolumen( ::oDbfVir ) }




      ::oGetUndVol := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, ::oDbfVir:cUndVol, ::oDbfVir:cUndVol:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      ::oGetTotVol := TGetHlp():ReDefine( 182, { | u | If( PCount()==0, ::nGetTotVol, ::nGetTotVol:= u ) }, ::oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )










      oGetAlm := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, ::oDbfVir:cAlmOrd, ::oDbfVir:cAlmOrd:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( oGetAlm, oSayAlm ) )}, nil, "LUPA",, )

      oGetAlm:bChange   := {|| ::oLote:lValid() }
      oGetAlm:bValid    := {|| cAlmacen( oGetAlm, ::oParent:oAlm, oSayAlm ), ::oLote:lValid() }




      oSayAlm := TGetHlp():ReDefine( 191, { | u | If( PCount()==0, cSayAlm, cSayAlm:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      ::oGetFormato := TGetHlp():ReDefine( 340, { | u | If( PCount()==0, ::oDbfVir:cFormato, ::oDbfVir:cFormato:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      ::oStkAct := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, ::nStkAct, ::nStkAct:= u ) }, ::oFld:aDialogs[1],, MasUnd(),,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )





      ::LoadPropiedadesArticulos( ::oFld:aDialogs[ 2 ], nMode )








      oBtnSer := TButton():ReDefine( 3, {||( nil )}, ::oDlg,,, .F.,,,, .F. )

      oBtnSer:bAction   := {|| ::oParent:oDetSeriesMaterial:Resource( nMode ) }




      oBtnAtras := TButton():ReDefine( 4, {||( if( ::oFld:nOption > 1, ::oFld:SetOption( ::oFld:nOption - 1 ), ) )}, ::oDlg,,, .F.,,,, .F. )




      oBtnAdelante := TButton():ReDefine( 5, {||( if( ::oFld:nOption < Len( ::oFld:aDialogs ), ::oFld:SetOption( ::oFld:nOption + 1 ), ) )}, ::oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 1, {||( ::SaveResource( oGetArt ) )}, ::oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )




        TButton():ReDefine( 2, {||( ::oDlg:end() )}, ::oDlg,,, .F.,,,, .F. )

      if nMode <> 3
         ::oDlg:AddFastKey( 117, {|| oBtnSer:Click() } )
         ::oDlg:AddFastKey( 116, {|| ::SaveResource( oGetArt ) } )
         ::oDlg:AddFastKey( 118, {|| oBtnAtras:Click() } )
         ::oDlg:AddFastKey( 119, {|| oBtnAdelante:Click() } )
      end

      ::oDlg:bStart := {|| ::EdtRotor(), ::SetResource( nMode ) }

   ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

   ::oMenu:End()

RETURN ( ::oDlg:nResult == 1 )



static FUNCTION TDetMaterial_SetResource( nMode ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   if !lUseCaj()
      ::oGetCaja:Hide()
   end

   if !uFieldEmpresa( "lUseBultos" )
      if !Empty( ::oGetBultos )
         ::oGetBultos:Hide()
      end
   else
      if !Empty( ::oGetBultos )
         ::oGetBultos:SetText( uFieldempresa( "cNbrBultos" ) )
      end
   end

   if nMode == 1

      ::oLote:Hide()
      ::oFecCad:Hide()

      ::oSayPr1:Hide()
      ::oValPr1:Hide()
      ::oSayVp1:Hide()

      ::oSayPr2:Hide()
      ::oValPr2:Hide()
      ::oSayVp2:Hide()

   else

      if ::oDbfVir:lLote
         ::oLote:Show()
         ::oFecCad:Show()
      else
         ::oLote:Hide()
         ::oFecCad:Hide()
      end

      if !Empty( ::oDbfVir:cCodPr1 )
         ::oSayPr1:Show()
         ::oSayPr1:SetText( retProp( ::oDbfVir:cCodPr1, ::oParent:oPro:cAlias ) )
         ::oValPr1:Show()
         ::oSayVp1:Show()
      else
         ::oSayPr1:Hide()
         ::oValPr1:Hide()
         ::oSayVp1:Hide()
      end

      if !Empty( ::oDbfVir:cCodPr2 )
         ::oSayPr2:Show()
         ::oSayPr2:SetText( retProp( ::oDbfVir:cCodPr2, ::oParent:oPro:cAlias ) )
         ::oValPr2:Show()
         ::oSayVp2:Show()
      else
         ::oSayPr2:Hide()
         ::oValPr2:Hide()
         ::oSayVp2:Hide()
      end

   end

   ::oClasificacionArticulo:SetNumber( ::oDbfVir:nTipArt )

RETURN ( Self )



static FUNCTION TDetMaterial_LoaArticulo( oGetArticulo, oGetNombre ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   local cCodArt           := oGetArticulo:VarGet()
   local lChgCodArt        := .F.
   local cLote
   local dFechaCaducidad
   local nCosPro           := 0

   if Empty( cCodArt )

      if lRetCodArt()
         MsgStop( "No se pueden añadir lineas sin codificar" )
         return .F.
      end

      return .T.

   else

      lChgCodArt     := Empty( ::cOldCodArt ) .OR. ( ::oDbfVir:cCodArt + ::oDbfVir:cValPr1 + ::oDbfVir:cValPr2 + ::oDbfVir:cLote <> ::cOldCodArt )





      ::oParent:oArt:ordSetFocus( "CodeBar" )

      if ::oParent:oArt:Seek( cCodArt )
         cCodArt  := ::oParent:oArt:Codigo
      end





      ::oParent:oArt:ordSetFocus( "Codigo" )

      if ::oParent:oArt:Seek( cCodArt ) .OR. ::oParent:oArt:Seek( Upper( cCodArt ) )

         cCodArt  := ::oParent:oArt:Codigo



         ::oDbfVir:cCodPr1    := ::oParent:oArt:cCodPrp1
         ::oDbfVir:cCodPr2    := ::oParent:oArt:cCodPrp2

         if !Empty( ::oDbfVir:cCodPr1 )
            ::oSayPr1:Show()
            ::oSayPr1:SetText( retProp( ::oDbfVir:cCodPr1, ::oParent:oPro:cAlias ) )
            ::oValPr1:Show()
            ::oSayVp1:Show()
         else
            ::oSayPr1:Hide()
            ::oValPr1:Hide()
            ::oSayVp1:Hide()
         end

         if !Empty( ::oDbfVir:cCodPr2 )
            ::oSayPr2:Show()
            ::oSayPr2:SetText( retProp( ::oDbfVir:cCodPr2, ::oParent:oPro:cAlias ) )
            ::oValPr2:Show()
            ::oSayVp2:Show()
         else
            ::oSayPr2:Hide()
            ::oValPr2:Hide()
            ::oSayVp2:Hide()
         end

         if lChgCodArt

            oGetNombre:cText( ::oParent:oArt:Nombre )

            if ::oParent:oArt:nCajEnt <> 0
               ::oGetCaja:cText( ::oParent:oArt:nCajEnt )
            end

            if ::oParent:oArt:nUniCaja <> 0
               ::oGetUnidades:cText( ::oParent:oArt:nUniCaja )
            end

            if ::oParent:oArt:lLote

               ::oDbfVir:lLote   := ::oParent:oArt:lLote

               if Empty( cLote )
                  cLote          := ::oParent:oArt:cLote
               end

               if !Empty( ::oLote )

                  ::oLote:Show()

                  if Empty( ::oLote:VarGet() )
                     ::oLote:cText( cLote )
                  end

               else

                  if Empty( ::oDbfVir:cLote)
                     ::oDbfVir:cLote := cLote
                  end

               end

               if Empty( dFechaCaducidad )
                  dFechaCaducidad      := StocksModel():getFechaCaducidad( cCodArt, ::oDbfVir:cCodPr1, ::oDbfVir:cCodPr2, ::oDbfVir:cValPr1, ::oDbfVir:cValPr2, ::oDbfVir:cLote )
               end


               if !Empty( ::oFecCad )

                  ::oFecCad:Show()

                  if Empty( ::oFecCad:VarGet() ) .OR. (dFechaCaducidad <> ::oDbfVir:dFecCad )
                     ::oFecCad:cText( dFechaCaducidad )
                  end

               else

                  if Empty( ::oDbfVir:dFecCad )
                     ( ::oDbfVir:dFecCad ) := dFechaCaducidad
                  end

               end

            else

               ::oLote:Hide()
               ::oFecCad:Hide()

            end



            do case

               case uFieldEmpresa( "nCosVta" ) <> 3

                  ::oGetPrecio:cText( ::oParent:oArt:pCosto )

               case uFieldEmpresa( "nCosVta" ) == 3

                  nCosPro     := MaterialesProducidosLineasModel():getCosto(  ::oDbfVir:cCodArt, ::oDbfVir:cCodPr1, ::oDbfVir:cCodPr2, ::oDbfVir:cValPr1, ::oDbfVir:cValPr2, ::oDbfVir:cLote )

                  if nCosPro == 0
                     ::oGetPrecio:cText( ::oParent:oArt:pCosto )
                  else
                     ::oGetPrecio:cText( nCosPro )
                  end

            end

            ::oGetPes:cText(     ::oParent:oArt:nPesoKg )
            ::oGetUndPes:cText(  ::oParent:oArt:cUndDim )
            ::oGetVol:cText(     ::oParent:oArt:nVolumen )
            ::oGetUndVol:cText(  ::oParent:oArt:cVolumen )

            ::LoadCommunFields()



            if !uFieldEmpresa( "lNStkAct" )
               ::oStkAct:cText( StocksModel():nStockArticulo( cCodArt, ::oDbfVir:cAlmOrd, ::oDbfvir:cCodPr1, ::oDbfVir:cCodPr2, ::oDbfvir:cValPr1, ::oDbfVir:cValPr2, ::oDbfVir:cLote ) )
            end

         end

         ::lUnidades( ::oDbfVir )
         ::lPrecio( ::oDbfVir )
         ::lTotPeso( ::oDbfVir )
         ::lTotVolumen( ::oDbfVir )

         ::cOldCodArt         := ::oDbfVir:cCodArt + ::oDbfVir:cValPr1 + ::oDbfVir:cValPr2 + ::oDbfVir:cLote

         return .T.

      else

         MsgStop( "Artículo no encontrado" )

         return .F.

      end

   end

RETURN .T.



static FUNCTION TDetMaterial_nUnidades( oDbf ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   If( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( if( !Empty( ::oParent:nDouDiv ), Round( NotCaja( oDbf:FieldGetByName( "nCajOrd" ) ) * oDbf:FieldGetByName( "nUndOrd" ), ::oParent:nDouDiv ), ( NotCaja( oDbf:FieldGetByName( "nCajOrd" ) ) * oDbf:FieldGetByName( "nUndOrd" ) ) ) )



static FUNCTION TDetMaterial_nTotal( oDbf ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   local nTotal   := 0

   If( oDbf == nil, oDbf := ::oDbf, ) ;

   oDbf:GetStatus()

   oDbf:GoTop()
   while !oDbf:Eof()
      nTotal      += ::nPrecio( oDbf )
      oDbf:Skip()
   end

   oDbf:SetStatus()

RETURN ( nTotal )



static FUNCTION TDetMaterial_SaveDetails( ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   ::oDbfVir:cSerOrd  := ::oParent:oDbf:cSerOrd
   ::oDbfVir:nNumOrd  := ::oParent:oDbf:nNumOrd
   ::oDbfVir:cSufOrd  := ::oParent:oDbf:cSufOrd
   ::oDbfVir:dFecOrd  := ::oParent:oDbf:dFecOrd

RETURN ( Self )



static FUNCTION TDetMaterial_DeleteDetails( ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   while ::oParent:oDetSeriesMaterial:oDbfVir:SeekInOrd( Str( ::oDbfVir:nNumLin, 4 ) + ::oDbfVir:cCodArt, "nNumLin" )
      ::oParent:oDetSeriesMaterial:oDbfVir:Delete(.F.)
   end

RETURN ( Self )



static FUNCTION TDetMaterial_nTotPeso( oDbf ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   If( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( Round( ::nUnidades( oDbf ), ::oParent:nDouDiv ) * oDbf:nPeso )



static FUNCTION TDetMaterial_nTotVolumen( oDbf ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   If( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( Round( ::nUnidades( oDbf ), ::oParent:nDouDiv ) * oDbf:nVolumen )



static FUNCTION TDetMaterial_lTotPeso( oDbf ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   If( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( ::oGetTotPes:cText( ::nTotPeso( oDbf ) ), .T. )



static FUNCTION TDetMaterial_lTotVolumen( oDbf ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   If( oDbf == nil, oDbf := ::oDbf, ) ;

RETURN ( ::oGetTotVol:cText( ::nTotVolumen( oDbf ) ), .T. )



static FUNCTION TDetMaterial_lStkAct( ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

RETURN ( if( !uFieldEmpresa( "lNStkAct" ), ::oStkAct:cText( StocksModel():nStockArticulo( ::oDbfVir:cCodArt, ::oDbfVir:cAlmOrd, ::oDbfVir:cCodPr1, ::oDbfVir:cCodPr2, ::oDbfvir:cValPr1, ::oDbfVir:cValPr2, ::oDbfVir:cLote ) ), ), .T. )



static FUNCTION TDetMaterial_EdtRotor( ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   ::oMenu := MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )

      MenuAddItem( "&1. Rotor",, .F.,,,,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )

         MenuBegin( .F.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,,,,,,,, .F.,,,,,, )





            MenuAddItem( "&1. Modificar artículo", "Modificar la ficha del artículo", .F.,, {|oMenuItem|( if( Empty( ::oDbfVir:cCodArt ), msgStop( "No hay artículo seleccionado" ), EdtArticulo( ::oDbfVir:cCodArt ) ) )},, "gc_object_cube_16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&2. Informe de artículo", "Abrir el informe del artículo", .F.,, {|oMenuItem|( if( Empty( ::oDbfVir:cCodArt ), msgStop( "No hay artículo seleccionado" ), InfArticulo( ::oDbfVir:cCodArt ) ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )




            MenuAddItem( "&3. Informe de stock", "Abrir el informe del stock", .F.,, {|oMenuItem|( InfStock( ::oDbfVir:cCodArt ) )},, "Info16",,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F.,,,,, .F., .F., .F. )
         MenuEnd()

   MenuEnd()

   ::oDlg:SetMenu( ::oMenu )

RETURN ( ::oMenu )



static FUNCTION TDetMaterial_SaveResource( oGetArt ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   if Empty( ::oDbfVir:cCodArt )
      MsgStop( "Tiene que seleccionar un artículo." )
      oGetArt:SetFocus()
      Return .F.
   end

   if !::runScriptBeforeAppend( self )
      Return .F.
   end

   ::oDbfVir:nTipArt    := ::oClasificacionArticulo:GetNumber()

   ::oParent:oTotProducido:Refresh()
   ::oParent:oTotMaterias:Refresh()
   ::oParent:oTotPersonal:Refresh()

RETURN ::oDlg:end( 1 )



static FUNCTION TDetMaterial_ActualizaSqlStock( cNumDoc ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   local nRec
   local nOrdAnt

   nRec     := ::oParent:oDetMaterial:oDbf:Recno()
   nOrdAnt  := ::oParent:oDetMaterial:oDbf:OrdSetFocus( "cNumOrd" )

   if ::oParent:oDetMaterial:oDbf:Seek( cNumDoc )


      while ::oParent:oDetMaterial:oDbf:cSerOrd + Str( ::oParent:oDetMaterial:oDbf:nNumOrd ) + ::oParent:oDetMaterial:oDbf:cSufOrd == cNumDoc .AND.  !::oParent:oDetMaterial:oDbf:Eof()



         ::oParent:oDetMaterial:oDbf:Skip()

      end

  end

   ::oParent:oDetMaterial:oDbf:OrdSetFocus( nOrdAnt )
   ::oParent:oDetMaterial:oDbf:GoTo( nRec )

Return .T.



static FUNCTION TDetMaterial_RollBackSqlStock( cNumDoc ) ; local Self AS CLASS TDetMaterial := QSelf() AS CLASS TDetMaterial

   local nRec
   local nOrdAnt

   nRec     := ::oParent:oDetMaterial:oDbf:Recno()
   nOrdAnt  := ::oParent:oDetMaterial:oDbf:OrdSetFocus( "cNumOrd" )

   if ::oParent:oDetMaterial:oDbf:Seek( cNumDoc )


      while ::oParent:oDetMaterial:oDbf:cSerOrd + Str( ::oParent:oDetMaterial:oDbf:nNumOrd ) + ::oParent:oDetMaterial:oDbf:cSufOrd == cNumDoc .AND.  !::oParent:oDetMaterial:oDbf:Eof()



         ::oParent:oDetMaterial:oDbf:Skip()

      end

  end

   ::oParent:oDetMaterial:oDbf:OrdSetFocus( nOrdAnt )
   ::oParent:oDetMaterial:oDbf:GoTo( nRec )

Return .T.



FUNCTION hStockBufferDetalleMaterial( oDbf )

   local hBuffer := {=>}

   do case
      case hb_isObject( oDbf )

         hset( hBuffer, "codigo_articulo", AllTrim( oDbf:cCodArt ) )
         hset( hBuffer, "codigo_almacen_entrada", "" )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( oDbf:cAlmOrd ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( oDbf:cCodPr1 ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( oDbf:cValPr1 ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( oDbf:cCodPr2 ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( oDbf:cValPr2 ) )
         hset( hBuffer, "lote", AllTrim( oDbf:cLote ) )
         hset( hBuffer, "bultos_articulo", oDbf:nBultos )
         hset( hBuffer, "cajas_articulo", oDbf:nCajOrd )
         hset( hBuffer, "unidades_articulo", nTotNProduccion( oDbf ) )
         hset( hBuffer, "fecha", oDbf:dFecOrd )
         hset( hBuffer, "hora", AllTrim( oDbf:cHorIni ) )

   end

RETURN ( hBuffer )



Function nTotNMaterial( uDbf )

   local nTotUnd

   do case
      case ValType( uDbf ) == "O"
         nTotUnd  := NotCaja( uDbf:nCajOrd )
         nTotUnd  *= uDbf:nUndOrd

      otherwise
         nTotUnd  := NotCaja( ( uDbf )->nCajOrd )
         nTotUnd  *= ( uDbf )->nUndOrd

   end

RETURN ( nTotUnd )










_HB_CLASS TDetSeriesMaterial ; function TDetSeriesMaterial ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TDetSeriesMaterial", iif( .T., { @TDet() }, { @HBObject() } ), @TDetSeriesMaterial() ) ) ;

   _HB_MEMBER New( cPath, oParent); oClass:AddMethod( "New", @TDetSeriesMaterial_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TDetSeriesMaterial_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SaveDetails(); oClass:AddMethod( "SaveDetails", @TDetSeriesMaterial_SaveDetails(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode, lLiteral); oClass:AddMethod( "Resource", @TDetSeriesMaterial_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TDetSeriesMaterial ;



static FUNCTION TDetSeriesMaterial_New( cPath, oParent ) ; local Self AS CLASS TDetSeriesMaterial := QSelf() AS CLASS TDetSeriesMaterial

   If( cPath == nil, cPath := cPatEmp(), ) ;

   ::cPath              := cPath
   ::oParent            := oParent

   ::bOnPreSaveDetail   := {|| ::SaveDetails() }

RETURN ( Self )



static FUNCTION TDetSeriesMaterial_DefineFiles( cPath, cVia, lUniqueName, cFileName ) ; local Self AS CLASS TDetSeriesMaterial := QSelf() AS CLASS TDetSeriesMaterial

   local oDbf

   If( cPath == nil, cPath := ::cPath, ) ;
   If( lUniqueName == nil, lUniqueName := .F., ) ;
   If( cFileName == nil, cFileName := "MatSer", ) ;
   If( cVia == nil, cVia := cDriver(), ) ;

   if lUniqueName
      cFileName         := cGetNewFileName( cFileName, , , cPath )
   end

   oDbf := DbfServer( ( cFileName ), ( cFileName ) ):New( ( cFileName ), ( cFileName ), ( cVia ), "Números de serie de materias primas", ( cPath ) )

      oDbf:AddField( "cSerOrd", "C", 01, 0,,,,, "Código", .F.,, .T., {} )
      oDbf:AddField( "nNumOrd", "N", 09, 0,,,,, "Número", .F.,, .T., {} )
      oDbf:AddField( "cSufOrd", "C", 02, 0,,,,, "Sufijo", .F.,, .T., {} )
      oDbf:AddField( "dFecOrd", "D", 08, 0,,,,, "Fecha", .F.,, .T., {} )
      oDbf:AddField( "nNumLin", "N", 04, 0,,,,, "Número de línea", .F., 60, .F., {} )
      oDbf:AddField( "cCodArt", "C", 18, 0,,,,, "Artículo", .F., 60, .F., {} )
      oDbf:AddField( "cAlmOrd", "C", 16, 0,,,,, "Almacén", .F., 50, .F., {} )
      oDbf:AddField( "lUndNeg", "L", 01, 0,,,,, "Lógico de unidades en negativo", .F.,, .T., {} )
      oDbf:AddField( "cNumSer", "C", 30, 0,,,,, "Número de serie", .F.,, .T., {} )

      oDbf:AddIndex( "cNumOrd", ( cFileName ), "cSerOrd + Str( nNumOrd ) + cSufOrd + Str( nNumLin )",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cCodArt", ( cFileName ), "cCodArt + cAlmOrd + cNumSer",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "cNumSer", ( cFileName ), "cNumSer",,, .F., .F.,,,, .T., .F. )
      oDbf:AddIndex( "nNumLin", ( cFileName ), "Str( nNumLin, 4 ) + cCodArt",,, .F., .F.,,,, .T., .F. )



RETURN ( oDbf )



static FUNCTION TDetSeriesMaterial_SaveDetails( ) ; local Self AS CLASS TDetSeriesMaterial := QSelf() AS CLASS TDetSeriesMaterial

   ::oDbfVir:cSerOrd  := ::oParent:oDbf:cSerOrd
   ::oDbfVir:nNumOrd  := ::oParent:oDbf:nNumOrd
   ::oDbfVir:cSufOrd  := ::oParent:oDbf:cSufOrd
   ::oDbfVir:dFecOrd  := ::oParent:oDbf:dFecOrd

RETURN ( Self )



static FUNCTION TDetSeriesMaterial_Resource( nMode ) ; local Self AS CLASS TDetSeriesMaterial := QSelf() AS CLASS TDetSeriesMaterial

   with object ( TNumerosSerie() )

      :nMode            := nMode

      :cCodArt          := ::oParent:oDetMaterial:oDbfVir:cCodArt
      :nNumLin          := ::oParent:oDetMaterial:oDbfVir:nNumLin
      :cCodAlm          := ::oParent:oDbf:cAlmOrd

      :nTotalUnidades   := ::oParent:oDetMaterial:nUnidades( ::oParent:oDetMaterial:oDbfVir )

      :oStock           := ::oParent:oStock

      ::oDbfVir:GetStatus()
      ::oDbfVir:OrdSetFocus( "nNumLin" )

      :uTmpSer          := ::oDbfVir

      :Resource()

      ::oDbfVir:SetStatus()

   end

RETURN ( Self )
