#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 9 ".\.\Prg\TFastReportAlmacen.prg"
_HB_CLASS TFastReportAlmacen ; function TFastReportAlmacen ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFastReportAlmacen", iif( .T., { @TFastreportTerceros() }, { @HBObject() } ), @TFastReportAlmacen() ) ) ;

   _HB_MEMBER { cType } ; oClass:AddMultiData(, "Almacenes", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cType"}, .F. )

   _HB_MEMBER { oStock } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oStock"}, .F. )

   _HB_MEMBER { cExpresionHeader } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cExpresionHeader"}, .F. )

   _HB_MEMBER { lApplyFilters } ; oClass:AddMultiData(, .T., nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lApplyFilters"}, .F. )

   _HB_MEMBER { oCamposExtra } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCamposExtra"}, .F. )
   _HB_MEMBER { aExtraFields } ; oClass:AddMultiData(, {}, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aExtraFields"}, .F. )

   _HB_MEMBER { aTypeDocs } ; oClass:AddMultiData(, { "C", "N", "D", "L", "C" }, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aTypeDocs"}, .F. )

   _HB_MEMBER Create(); oClass:AddMethod( "Create", @TFastReportAlmacen_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lResource(); oClass:AddMethod( "lResource", @TFastReportAlmacen_lResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lGenerate(); oClass:AddMethod( "lGenerate", @TFastReportAlmacen_lGenerate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER lValidRegister(); oClass:AddMethod( "lValidRegister", @TFastReportAlmacen_lValidRegister(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TFastReportAlmacen_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TFastReportAlmacen_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DataReport(); oClass:AddMethod( "DataReport", @TFastReportAlmacen_DataReport(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER AddVariable(); oClass:AddMethod( "AddVariable", @TFastReportAlmacen_AddVariable(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER StartDialog(); oClass:AddMethod( "StartDialog", @TFastReportAlmacen_StartDialog(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER BuildTree( oTree); oClass:AddMethod( "BuildTree", @TFastReportAlmacen_BuildTree(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER insertFacturaCliente(); oClass:AddMethod( "insertFacturaCliente", @TFastReportAlmacen_insertFacturaCliente(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER insertRectificativa(); oClass:AddMethod( "insertRectificativa", @TFastReportAlmacen_insertRectificativa(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER insertTicketCliente(); oClass:AddMethod( "insertTicketCliente", @TFastReportAlmacen_insertTicketCliente(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AddClientes(); oClass:AddMethod( "AddClientes", @TFastReportAlmacen_AddClientes(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER idDocumento(); oClass:AddInline( "idDocumento", {|Self | ( ( Self ) ), ( ::oDbf:cClsDoc + ::oDbf:cSerDoc + ::oDbf:cNumDoc + ::oDbf:cSufDoc ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER idDocumentoLinea(); oClass:AddInline( "idDocumentoLinea", {|Self | ( ( Self ) ), ( ::idDocumento() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setMeterText(); oClass:AddInline( "setMeterText", {|Self, cText | ( ( Self ) ), ( if ( !empty( ::oMtrInf ), ::oMtrInf:cText := cText, ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER setMeterTotal(); oClass:AddInline( "setMeterTotal", {|Self, nTotal | ( ( Self ) ), ( if ( !empty( ::oMtrInf ), ::oMtrInf:SetTotal( nTotal ), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER setMeterAutoIncremental(); oClass:AddInline( "setMeterAutoIncremental", {|Self | ( ( Self ) ), ( if ( !empty( ::oMtrInf ), ::oMtrInf:AutoInc(), ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RiesgoAlcanzado(); oClass:AddInline( "RiesgoAlcanzado", {|Self | ( ( Self ) ), ( ClientesModel():Riesgo( ::oDbf:cCodCli ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER TotalFacturado(); oClass:AddInline( "TotalFacturado", {|Self | ( ( Self ) ), ( ::oStock:nFacturado( ::oDbf:cCodCli ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER nFacturacionCliente(); oClass:AddInline( "nFacturacionCliente", {|Self | ( ( Self ) ), ( ::oStock:nFacturacionCliente( ::oDbf:cCodCli ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER TotalPendiente(); oClass:AddInline( "TotalPendiente", {|Self | ( ( Self ) ), ( ::oStock:nFacturacionPendiente( ::oDbf:cCodCli ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER nPedidoCliente(); oClass:AddInline( "nPedidoCliente", {|Self | ( ( Self ) ), ( ::oStock:nPedidoCliente( ::oDbf:cCodCli ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER nPagadoCliente(); oClass:AddInline( "nPagadoCliente", {|Self | ( ( Self ) ), ( ::oStock:nPagadoCliente( ::oDbf:cCodCli ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lClienteSinVentas(); oClass:AddInline( "lClienteSinVentas", {|Self | ( ( Self ) ), ( ClientesModel():lClienteSinVentas( ::oDbf:cCodCli, ::dIniInf, ::dFinInf ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER setFilterClientIdHeader(); oClass:AddInline( "setFilterClientIdHeader", {|Self | ( ( Self ) ), ( if( ::lApplyFilters, ::cExpresionHeader   += ' .and. ( alltrim( Field->cCodCli ) >= "' + alltrim( ::oGrupoCliente:Cargo:Desde ) + '" .and. alltrim( Field->cCodCli ) <= "' + alltrim( ::oGrupoCliente:Cargo:Hasta ) + '" )', ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER setFilterPaymentId(); oClass:AddInline( "setFilterPaymentId", {|Self | ( ( Self ) ), ( if( ::lApplyFilters, ::cExpresionHeader  += ' .and. ( Field->cCodPgo >= "' + ::oGrupoFpago:Cargo:Desde + '" .and. Field->cCodPgo <= "' + ::oGrupoFpago:Cargo:Hasta + '" )', ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER setFilterPaymentInvoiceId(); oClass:AddInline( "setFilterPaymentInvoiceId", {|Self | ( ( Self ) ), ( if( ::lApplyFilters, ::cExpresionHeader  += ' .and. ( Field->cCodPago >= "' + ::oGrupoFpago:Cargo:Desde + '" .and. Field->cCodPago <= "' + ::oGrupoFpago:Cargo:Hasta + '" )', ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER setFilterRouteId(); oClass:AddInline( "setFilterRouteId", {|Self | ( ( Self ) ), ( if( ::lApplyFilters, ::cExpresionHeader  += ' .and. ( Field->cCodRut >= "' + ::oGrupoRuta:Cargo:Desde + '" .and. Field->cCodRut <= "' + ::oGrupoRuta:Cargo:Hasta + '" )', ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER setFilterAgentId(); oClass:AddInline( "setFilterAgentId", {|Self | ( ( Self ) ), ( if( ::lApplyFilters, ::cExpresionHeader  += ' .and. ( Field->cCodAge >= "' + ::oGrupoAgente:Cargo:Desde + '" .and. Field->cCodAge <= "' + ::oGrupoAgente:Cargo:Hasta + '" )', ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER setFilterAlmacenId(); oClass:AddInline( "setFilterAlmacenId", {|Self | ( ( Self ) ), ( if( ::lApplyFilters, ::cExpresionHeader  += ' .and. ( Field->cCodAlm >= "' + ::oGrupoAlmacen:Cargo:Desde + '" .and. Field->cCodAlm <= "' + ::oGrupoAlmacen:Cargo:Hasta + '" )', ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )


   _HB_MEMBER setFilterAlmacenTicketId(); oClass:AddInline( "setFilterAlmacenTicketId", {|Self | ( ( Self ) ), ( if( ::lApplyFilters, ::cExpresionHeader  += ' .and. ( Field->cAlmTik >= "' + ::oGrupoAlmacen:Cargo:Desde + '" .and. Field->cAlmTik <= "' + ::oGrupoAlmacen:Cargo:Hasta + '" )', ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AddFieldCamposExtra(); oClass:AddMethod( "AddFieldCamposExtra", @TFastReportAlmacen_AddFieldCamposExtra(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER loadValuesExtraFields(); oClass:AddMethod( "loadValuesExtraFields", @TFastReportAlmacen_loadValuesExtraFields(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFastReportAlmacen ;



static FUNCTION TFastReportAlmacen_Create( uParam ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   ::AddField( "cCodCli",  "C", 12, 0, {|| "@!" }, "Código cliente"                          )
   ::AddField( "cNomCli",  "C",100, 0, {|| ""   }, "Nombre cliente"                          )
   ::AddField( "cDniCli",  "C", 30, 0, {|| "@!" }, "NIF cliente"                             )

   ::AddField( "cCodTip",  "C", 12, 0, {|| "@!" }, "Código del tipo de cliente"              )
   ::AddField( "cCodGrp",  "C", 12, 0, {|| "@!" }, "Código grupo de cliente"                 )
   ::AddField( "cCodPgo",  "C",  2, 0, {|| "@!" }, "Código de forma de pago"                 )
   ::AddField( "cCodRut",  "C", 12, 0, {|| "@!" }, "Código de la ruta"                       )
   ::AddField( "cCodAge",  "C", 12, 0, {|| "@!" }, "Código del agente"                       )
   ::AddField( "cCodUsr",  "C",  3, 0, {|| "@!" }, "Código usuario"                          )
   ::AddField( "cNomUsr",  "C",100, 0, {|| "@!" }, "Nombre usuario"                          )
   ::AddField( "cCodObr",  "C", 10, 0, {|| "@!" }, "Código dirección"                        )
   ::AddField( "cCodAlm",  "C", 16, 0, {|| "@!" }, "Código almacén"                          )

   ::AddField( "cTipDoc",  "C", 30, 0, {|| "" },   "Tipo de documento"                       )

   ::AddField( "cClsDoc",  "C",  2, 0, {|| "" },   "Clase de documento"                      )
   ::AddField( "cIdeDoc",  "C", 27, 0, {|| "" },   "Identificador del documento"             )
   ::AddField( "cSerDoc",  "C",  1, 0, {|| "" },   "Serie del documento"                     )
   ::AddField( "cNumDoc",  "C", 10, 0, {|| "" },   "Número del documento"                    )
   ::AddField( "cSufDoc",  "C",  2, 0, {|| "" },   "Delegación del documento"                )
   ::AddField( "cNumRec",  "C",  2, 0, {|| "" },   "Número del recibo"                       )
   ::AddField( "cCodPos",  "C", 15, 0, {|| "@!" }, "Código postal del documento"             )
   ::AddField( "cTipRec",  "C",  1, 0, {|| "@!" }, "Tipo de recibo"                          )
   ::AddField( "cTurno",   "C",  6, 0, {|| "" },   "Sesión"                                  )

   ::AddField( "nAnoDoc",  "N",  4, 0, {|| "" },   "Año del documento"                       )
   ::AddField( "nMesDoc",  "N",  2, 0, {|| "" },   "Mes del documento"                       )
   ::AddField( "dFecDoc",  "D",  8, 0, {|| "" },   "Fecha del documento"                     )
   ::AddField( "cHorDoc",  "C",  2, 0, {|| "" },   "Hora del documento"                      )
   ::AddField( "cMinDoc",  "C",  2, 0, {|| "" },   "Minutos del documento"                   )

   ::AddField( "nTotNet",  "N", 16, 6, {|| "" },   "Total neto"                              )
   ::AddField( "nTotIva",  "N", 16, 6, {|| "" },   "Total " + cImp()                         )
   ::AddField( "nTotReq",  "N", 16, 6, {|| "" },   "Total RE"                                )
   ::AddField( "nTotDoc",  "N", 16, 6, {|| "" },   "Total documento"                         )
   ::AddField( "nTotPnt",  "N", 16, 6, {|| "" },   "Total punto verde"                       )
   ::AddField( "nTotTrn",  "N", 16, 6, {|| "" },   "Total transporte"                        )
   ::AddField( "nTotAge",  "N", 16, 6, {|| "" },   "Total agente"                            )
   ::AddField( "nTotCos",  "N", 16, 6, {|| "" },   "Total costo"                             )
   ::AddField( "nTotIvm",  "N", 16, 6, {|| "" },   "Total impuestos especiales"              )
   ::AddField( "nTotRnt",  "N", 16, 6, {|| "" },   "Total rentabilidad"                      )
   ::AddField( "nTotRet",  "N", 16, 6, {|| "" },   "Total retenciones"                       )
   ::AddField( "nTotCob",  "N", 16, 6, {|| "" },   "Total cobros"                            )
   ::AddField( "nIva",     "N",  6, 2, {|| "" },   "Porcentaje impuesto"                     )
   ::AddField( "nReq",     "N", 16, 6, {|| "" },   "Porcentaje recargo"                      )
   ::AddField( "lCobRec",  "L",  1, 0, {|| "" },   "Lógico recibo cobrado"                   )
   ::AddField( "nComAge",  "N",  6, 2, {|| "" },   "Comisión agente"                         )

   ::AddField( "cSrlTot",  "M", 10, 0, {|| "" },   "Total serializado"                       )

   ::AddField( "uCargo",   "C", 20, 0, {|| "" },   "Cargo"                                   )

   ::AddField( "nNumRem",  "N",  9, 0, {|| "999999999" },   "Número de la remesa"            )
   ::AddField( "cSufRem",  "C",  2, 0, {|| "@!" },          "Sufijo de la remesa"            )
   ::AddField( "cEstado",  "C", 20, 0, {|| "" },            "Estado del documento"           )

   ::AddField( "nRieCli",  "N", 16, 0, {|| "" },            "Riesgo del cliente"             )
   ::AddField( "dFecVto",  "D",  8, 0, {|| "" },            "Vencimiento del recibo"         )

   ::AddFieldCamposExtra()

   ::AddTmpIndex( "cCodCli", "cCodCli" )
   ::AddTmpIndex( "cDniCli", "cDniCli" )

RETURN ( self )



static FUNCTION TFastReportAlmacen_lResource( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   ::lNewInforme     := .T.
   ::lDefCondiciones := .F.

   ::cTipoInforme    := "Almacenes"
   ::cBmpInforme     := "PACKAGE_64"

   ::cSubTitle       := "Informe de almacenes"

   if !::lTabletVersion
      if !::NewResource()
         return .F.
      end
   end





   if !::lGrupoAlmacen( .T. )
      return .F.
   end

   if !::lGrupoCliente( .T. )
      return .F.
   end

   if !::lGrupoGrupoCliente( .T. )
      return .F.
   end

   if !::lGrupoProveedor( .T. )
      return .F.
   end

   if !::lGrupoGProveedor( .T. )
      return .F.
   end

   if !::lGrupoFpago( .T. )
      return .F.
   end

   if !::lGrupoRuta( .T. )
      return .F.
   end

   if !::lGrupoAgente( .T. )
      return .F.
   end

   if !::lGrupoSerie( .T. )
      return .F.
   end

   if !::lGrupoSufijo( .T. )
      return .F.
   end

   if !::lGrupoIva( .T. )
      return .T.
   end

   ::oFilter      := TFilterCreator():Init()
   if !Empty( ::oFilter )
      ::oFilter:SetDatabase( ::oDbf )
      ::oFilter:SetFilterType( "21" )
   end

RETURN .T.



static FUNCTION TFastReportAlmacen_OpenFiles( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   local lOpen    := .T.
   local oError
   local oBlock

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::cDriver         := cDriver()

      ::nView           := D():CreateView( ::cDriver )

      ::lApplyFilters   := lAIS()

      D():SatClientes( ::nView )
      ( D():SatClientes( ::nView ) )->( OrdSetFocus( "cCodCli" ) )

      D():SatClientesLineas( ::nView )

      D():PresupuestosClientes( ::nView )
      ( D():PresupuestosClientes( ::nView ) )->( OrdSetFocus( "cCodCli" ) )

      D():PresupuestosClientesLineas( ::nView )

      D():PedidosClientes( ::nView )
      ( D():PedidosClientes( ::nView ) )->( OrdSetFocus( "cCodCli" ) )

      D():PedidosClientesLineas( ::nView )

      D():AlbaranesClientes( ::nView )
      ( D():AlbaranesClientes( ::nView ) )->( OrdSetFocus( "cCodCli" ) )

      D():AlbaranesClientesLineas( ::nView )

      D():FacturasClientes( ::nView )
      ( D():FacturasClientes( ::nView ) )->( OrdSetFocus( "cCodCli" ) )

      D():FacturasClientesLineas( ::nView )

      D():FacturasClientesCobros( ::nView )

      D():AnticiposClientes( ::nView )

      D():FacturasRectificativas( ::nView )

      D():FacturasRectificativasLineas( ::nView )

      D():TiketsClientes( ::nView )

      D():TiketsLineas( ::nView )

      D():TiketsCobros( ::nView )

      D():ClientesDirecciones( ::nView )

      D():ClientesBancos( ::nView )

      D():Atipicas( ::nView )

      D():ClientesDocumentos( ::nView )

      D():ClientesIncidencias( ::nView )

      D():Clientes( ::nView )

      D():Agentes( ::nView )

      D():Ruta( ::nView )

      D():FormasPago( ::nView )

      D():TiposIva( ::nView )

      D():Divisas( ::nView )

      D():objectGruposClientes( ::nView )

      D():Proveedores( ::nView )





      ::oStock                := TStock():Create( cPatEmp() )
      if !::oStock:lOpenFiles()
         lOpen                := .F.
      end

      ::oCamposExtra          := TDetCamposExtra():New( cPatEmp(), ::cDriver )
      if !::oCamposExtra:OpenFiles()
         lOpen                := .F.
      else
         ::oCamposExtra:setTipoDocumento( "Facturas a clientes" )
         ::aExtraFields       := ::oCamposExtra:aExtraFields()
      end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible abrir las bases de datos de clientes" )

      ::CloseFiles()

      lOpen       := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TFastReportAlmacen_CloseFiles( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   if !Empty( ::oStock )
      ::oStock:End()
   end

   if !Empty( ::oCamposExtra )
      ::oCamposExtra:CloseFiles()
      ::oCamposExtra:End()
   end

   if !Empty( ::nView )
      D():DeleteView( ::nView )
   end

   ::nView     := nil

RETURN .T.



static FUNCTION TFastReportAlmacen_AddFieldCamposExtra( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   local cField

   if isArray( ::aExtraFields ) .AND. Len( ::aExtraFields ) <> 0

      for each cField in ::aExtraFields






         ::AddField( "fld" + cField[ "código" ], ::aTypeDocs[ cField[ "tipo" ] ] , cField[ "longitud" ], cField[ "decimales" ], {|| ::oCamposExtra:cPictData( cField ) }, Capitalize( cField[ "descripciÃ³n" ] ) )

      next

   end

Return ( Self )



static FUNCTION TFastReportAlmacen_StartDialog( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   ::CreateTreeImageList()

   ::BuildTree( ::oTreeReporting, .T. )

RETURN ( Self )



static FUNCTION TFastReportAlmacen_BuildTree( oTree, lLoadFile ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   local aReports

   If( oTree == nil, oTree := ::oTreeReporting, ) ;
   If( lLoadFile == nil, lLoadFile := .T., ) ;

   aReports := {  {  "Title" => "Operaciones de almacenes", "Image" => 16, "Type" => "Almacenes",                           "Directory" => "Almacenes\Almacenes",                                "File" => "Almacenes.fr3"  } }

   ::BuildNode( aReports, oTree, lLoadFile )

RETURN ( Self )



static FUNCTION TFastReportAlmacen_DataReport( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen





   ::oFastReport:SetWorkArea(       "Informe", ::oDbf:nArea )
   ::oFastReport:SetFieldAliases(   "Informe", cObjectsToReport( ::oDbf ) )





   ::oFastReport:SetWorkArea(       "Empresa",                          ::oDbfEmp:nArea )
   ::oFastReport:SetFieldAliases(   "Empresa",                          cItemsToReport( aItmEmp() ) )

   ::oFastReport:SetWorkArea(       "Clientes",                         ( D():Clientes( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Clientes",                         cItemsToReport( aItmCli() ) )

   ::oFastReport:SetWorkArea(       "Agentes",                          ( D():Agentes( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Agentes",                          cItemsToReport( aItmAge() ) )

   ::oFastReport:SetWorkArea(       "Rutas",                            ( D():Ruta( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Rutas",                            cItemsToReport( aItmRut() ) )

   ::oFastReport:SetWorkArea(       "Formas de pago",                   ( D():FormasPago( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Formas de pago",                   cItemsToReport( aItmFPago() ) )

   ::oFastReport:SetWorkArea(       "Grupos de cliente",                D():objectGruposClientes( ::nView ):Select() )
   ::oFastReport:SetFieldAliases(   "Grupos de cliente",                cObjectsToReport( D():objectGruposClientes( ::nView ):oDbf ) )

   ::oFastReport:SetWorkArea(       "Direcciones",                      ( D():ClientesDirecciones( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Direcciones",                      cItemsToReport( aItmObr() ) )

   ::oFastReport:SetWorkArea(       "Bancos",                           ( D():ClientesBancos( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Bancos",                           cItemsToReport( aCliBnc() ) )

   ::oFastReport:SetWorkArea(       "Tarifas de cliente",               ( D():Atipicas( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Tarifas de cliente",               cItemsToReport( aItmAtp() ) )

   ::oFastReport:SetWorkArea(       "Documentos",                       ( D():ClientesDocumentos( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Documentos",                       cItemsToReport( aCliDoc() ) )

   ::oFastReport:SetWorkArea(       "Incidencias",                      ( D():ClientesIncidencias( ::nView ) )->( select() ) )
   ::oFastReport:SetFieldAliases(   "Incidencias",                      cItemsToReport( aCliInc() ) )





   ::oFastReport:SetMasterDetail(   "Informe", "Empresa",               {|| cCodEmp() } )
   ::oFastReport:SetMasterDetail(   "Informe", "Bancos",                {|| ::oDbf:cCodCli } )
   ::oFastReport:SetMasterDetail(   "Informe", "Clientes",              {|| ::oDbf:cCodCli } )
   ::oFastReport:SetMasterDetail(   "Informe", "Tarifas de cliente",    {|| ::oDbf:cCodCli } )
   ::oFastReport:SetMasterDetail(   "Informe", "Documentos",            {|| ::oDbf:cCodCli } )
   ::oFastReport:SetMasterDetail(   "Informe", "Incidencias",           {|| ::oDbf:cCodCli } )
   ::oFastReport:SetMasterDetail(   "Informe", "Agentes",               {|| ::oDbf:cCodAge } )
   ::oFastReport:SetMasterDetail(   "Informe", "Rutas",                 {|| ::oDbf:cCodRut } )
   ::oFastReport:SetMasterDetail(   "Informe", "Formas de pago",        {|| ::oDbf:cCodPgo } )

   ::oFastReport:SetMasterDetail(   "Clientes", "Grupos de cliente",    {|| ( D():Clientes( ::nView ) )->cCodGrp } )
   ::oFastReport:SetMasterDetail(   "Clientes", "PaÃ­s",                 {|| ( D():Clientes( ::nView ) )->cCodPai } )





   if ::cReportType == "Listado"
      ::oFastReport:SetMasterDetail(   "Informe", "Direcciones",           {|| ::oDbf:cCodCli } )
   else
      ::oFastReport:SetMasterDetail(   "Informe", "Direcciones",           {|| ::oDbf:cCodCli + ::oDbf:cCodObr } )
   end

   ::oFastReport:SetResyncPair(     "Informe", "Empresa" )
   ::oFastReport:SetResyncPair(     "Informe", "Facturas" )
   ::oFastReport:SetResyncPair(     "Informe", "Agentes" )
   ::oFastReport:SetResyncPair(     "Informe", "Bancos" )
   ::oFastReport:SetResyncPair(     "Informe", "Clientes" )
   ::oFastReport:SetResyncPair(     "Informe", "Tarifas de cliente" )
   ::oFastReport:SetResyncPair(     "Informe", "Documentos" )
   ::oFastReport:SetResyncPair(     "Informe", "Incidencias" )
   ::oFastReport:SetResyncPair(     "Informe", "Rutas" )
   ::oFastReport:SetResyncPair(     "Informe", "Formas de pago" )

   ::oFastReport:SetResyncPair(     "Clientes", "Grupos de cliente" )
   ::oFastReport:SetResyncPair(     "Clientes", "PaÃ­s" )

   do case
      case ::cReportType == "Almacenes"

         ::FastReportSATCliente()

         ::FastReportPresupuestoCliente()

         ::FastReportPedidoCliente()

         ::FastReportAlbaranCliente()

         ::FastReportFacturaCliente()

         ::FastReportFacturaRectificativa()

         ::FastReportTicket( .T. )

   end

   ::AddVariable()

Return ( Self )



static FUNCTION TFastReportAlmacen_AddVariable( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   do case
      case ::cReportType == "Almacenes"

         ::AddVariableSATCliente()

         ::AddVariableLineasSATCliente()

         ::AddVariablePresupuestoCliente()

         ::AddVariableLineasPresupuestoCliente()

         ::AddVariablePedidoCliente()

         ::AddVariableLineasPedidoCliente()

         ::AddVariableAlbaranCliente()

         ::AddVariableLineasAlbaranCliente()

         ::AddVariableFacturaCliente()

         ::AddVariableLineasFacturaCliente()

         ::AddVariableRectificativaCliente()

         ::AddVariableLineasRectificativaCliente()

         ::AddVariableTicketCliente()

         ::AddVariableLineasTicketCliente()

   end

   ::oFastReport:AddVariable(    "Clientes",    "Riesgo alcanzado",   "CallHbFunc( 'oTinfGen', ['RiesgoAlcanzado'])" )
   ::oFastReport:AddVariable(    "Clientes",    "Total movimientos",  "CallHbFunc( 'oTinfGen', ['TotalFacturado'])" )
   ::oFastReport:AddVariable(    "Clientes",    "Total pendiente",    "CallHbFunc( 'oTinfGen', ['TotalPendiente'])" )
   ::oFastReport:AddVariable(    "Clientes",    "Total pagado",       "CallHbFunc( 'oTinfGen', ['nPagadoCliente'])" )
   ::oFastReport:AddVariable(    "Clientes",    "Total pedido",       "CallHbFunc( 'oTinfGen', ['nPedidoCliente'])" )
   ::oFastReport:AddVariable(    "Clientes",    "Total facturado",    "CallHbFunc( 'oTinfGen', ['nFacturacionCliente'])" )
   ::oFastReport:AddVariable(    "Clientes",    "Cliente sin ventas", "CallHbFunc( 'oTinfGen', ['lClienteSinVentas'])" )

Return ( ::Super:AddVariable() )



static FUNCTION TFastReportAlmacen_lGenerate( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   ::oDbf:Zap()





   do case
      case ::cReportType == "Almacenes"

         ::AddMovimientoAlmacen()

         ::AddPresupuestoCliente()

         ::AddPedidoCliente()

         ::AddSATCliente()

         ::AddAlbaranCliente()

         ::AddFacturaCliente()

         ::AddTicket()

         ::AddRectificativaCliente()

         ::AddPedidoProveedor()

         ::AddAlbaranProveedor()

         ::AddFacturaProveedor()

         ::AddRectificativaProveedor()

   end

   if !empty(::oFilter)
      ::oDbf:SetFilter( ::oFilter:cExpresionFilter )
   end

   ::oDbf:GoTop()

RETURN ( ::oDbf:LastRec() > 0 )



static FUNCTION TFastReportAlmacen_lValidRegister( cCodigoCliente ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   if !empty( ::oGrupoCliente ) .AND. !( ::oDbf:cCodCli >= ::oGrupoCliente:Cargo:Desde .AND. ::oDbf:cCodCli <= ::oGrupoCliente:Cargo:Hasta )
      Return .F.
   end

   if !empty( ::oGrupoFpago ) .AND. !( ::oDbf:cCodPgo >= ::oGrupoFpago:Cargo:Desde .AND. ::oDbf:cCodPgo <= ::oGrupoFpago:Cargo:Hasta )
      Return .F.
   end

   if !empty( ::oGrupoRuta ) .AND. !( ::oDbf:cCodRut >= ::oGrupoRuta:Cargo:Desde .AND. ::oDbf:cCodRut  <= ::oGrupoRuta:Cargo:Hasta )
      Return .F.
   end

   if !empty( ::oGrupoAgente ) .AND. !( ::oDbf:cCodAge  >= ::oGrupoAgente:Cargo:Desde .AND. ::oDbf:cCodAge <= ::oGrupoAgente:Cargo:Hasta )
      Return .F.
   end

   if !empty( ::oGrupoGCliente ) .AND. !( ::oGrupoGCliente:Cargo:ValidMayorIgual( ::oDbf:cCodGrp, ::oGrupoGCliente:Cargo:Desde ) .AND. ::oGrupoGCliente:Cargo:ValidMenorIgual( ::oDbf:cCodGrp, ::oGrupoGcliente:Cargo:Hasta ) )
      return .F.
   end

RETURN ( .T. )



static FUNCTION TFastReportAlmacen_insertFacturaCliente( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   local sTot
   local oError
   local oBlock
   local aTotIva

   oBlock                        := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ( D():FacturasClientesFecha( ::nView ) )->( OrdSetFocus( "dFecFac" ) )
      ( D():FacturasClientesLineas( ::nView ) )->( OrdSetFocus( "nNumFac" ) )



      ::cExpresionHeader          := 'Field->dFecFac >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. Field->dFecFac <= Ctod( "' + Dtoc( ::dFinInf ) + '" )'
      ::cExpresionHeader          += ' .and. Field->cSerie >= "' + Rtrim( ::oGrupoSerie:Cargo:Desde ) + '" .and. Field->cSerie <= "'    + Rtrim( ::oGrupoSerie:Cargo:Hasta ) + '"'
      ::cExpresionHeader          += ' .and. ( Field->cSufFac >= "' + Rtrim( ::oGrupoSufijo:Cargo:Desde ) + '" .and. Field->cSufFac <= "' + Rtrim( ::oGrupoSufijo:Cargo:Hasta ) + '" )'

      ::setFilterClientIdHeader()

      ::setFilterPaymentId()

      ::setFilterRouteId()

      ::setFilterAgentId()

      ::setFilterAlmacenId()



      ::setMeterText( "Procesando facturas" )

      ( D():FacturasClientesFecha( ::nView ) )->( setCustomFilter ( ::cExpresionHeader))

      ::setMeterTotal( ( D():FacturasClientesFecha( ::nView ) )->( dbcustomkeycount() ) )

      ( D():FacturasClientesFecha( ::nView ) )->( dbgotop() )

      while !::lBreak .AND. !( D():FacturasClientesFecha( ::nView ) )-> ( eof() )

         sTot                    := sTotFacCli( ( D():FacturasClientesFecha( ::nView ) )->cSerie + Str( ( D():FacturasClientesFecha( ::nView ) )->nNumFac ) + ( D():FacturasClientesFecha( ::nView ) )->cSufFac, D():FacturasClientesFecha( ::nView ), D():FacturasClientesLineas( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ), D():FacturasClientesCobros( ::nView ), D():AnticiposClientes( ::nView ) )

         for each aTotIva in sTot:aTotalIva


            if aTotIva[ 8 ] <> 0       .AND. ( cCodigoIva( D():TiposIva( ::nView ), aTotIva[ 3 ] ) >= ::oGrupoIva:Cargo:Desde .AND. cCodigoIva( D():TiposIva( ::nView ), aTotIva[ 3 ] ) <= ::oGrupoIva:Cargo:Hasta )

               ::oDbf:Blank()

               ::oDbf:cCodCli    := ( D():FacturasClientesFecha( ::nView ) )->cCodCli
               ::oDbf:cNomCli    := ( D():FacturasClientesFecha( ::nView ) )->cNomCli
               ::oDbf:cCodAge    := ( D():FacturasClientesFecha( ::nView ) )->cCodAge
               ::oDbf:cCodPgo    := ( D():FacturasClientesFecha( ::nView ) )->cCodPago
               ::oDbf:cCodRut    := ( D():FacturasClientesFecha( ::nView ) )->cCodRut
               ::oDbf:cCodUsr    := ( D():FacturasClientesFecha( ::nView ) )->cCodUsr
               ::oDbf:cNomUsr    := UsuariosModel():getNombreWhereCodigo( ( D():FacturasClientesFecha( ::nView ) )->cCodUsr )
               ::oDbf:cCodObr    := ( D():FacturasClientesFecha( ::nView ) )->cCodObr
               ::oDbf:nComAge    := ( D():FacturasClientesFecha( ::nView ) )->nPctComAge

               ::oDbf:cCodAlm    := ( D():FacturasClientesFecha( ::nView ) )->cCodAlm

               ::oDbf:cCodPos    := ( D():FacturasClientesFecha( ::nView ) )->cPosCli

               ::oDbf:cCodGrp    := RetFld( ( D():FacturasClientesFecha( ::nView ) )->cCodCli, ( D():Clientes( ::nView ) ), "cCodGrp", "Cod")

               ::oDbf:cTipDoc    := "Factura clientes"
               ::oDbf:cClsDoc    := "11"
               ::oDbf:cSerDoc    := ( D():FacturasClientesFecha( ::nView ) )->cSerie
               ::oDbf:cNumDoc    := Str( ( D():FacturasClientesFecha( ::nView ) )->nNumFac )
               ::oDbf:cSufDoc    := ( D():FacturasClientesFecha( ::nView ) )->cSufFac
               ::oDbf:cIdeDoc    := Upper( ::oDbf:cTipDoc ) + ::oDbf:cSerDoc + ::oDbf:cNumDoc + ::oDbf:cSufDoc

               ::oDbf:nAnoDoc    := Year( ( D():FacturasClientesFecha( ::nView ) )->dFecFac )
               ::oDbf:nMesDoc    := Month( ( D():FacturasClientesFecha( ::nView ) )->dFecFac )
               ::oDbf:dFecDoc    := ( D():FacturasClientesFecha( ::nView ) )->dFecFac
               ::oDbf:cHorDoc    := SubStr( ( D():FacturasClientesFecha( ::nView ) )->cTimCre, 1, 2 )
               ::oDbf:cMinDoc    := SubStr( ( D():FacturasClientesFecha( ::nView ) )->cTimCre, 4, 2 )

               ::oDbf:nIva       := aTotIva[ 3 ]
               ::oDbf:nReq       := aTotIva[ 4 ]
               ::oDbf:nTotNet    := aTotIva[ 2 ]
               ::oDbf:nTotIva    := aTotIva[ 8 ]
               ::oDbf:nTotReq    := aTotIva[ 9 ]
               ::oDbf:nTotDoc    := sTot:nTotalDocumento
               ::oDbf:nTotPnt    := aTotIva[ 5 ]
               ::oDbf:nTotTrn    := aTotIva[ 7 ]
               ::oDbf:nTotCos    := sTot:nTotalCosto
               ::oDbf:nTotIvm    := aTotIva[ 6 ]
               ::oDbf:nTotRnt    := sTot:nTotalRentabilidad
               ::oDbf:nTotRet    := sTot:nTotalRetencion
               ::oDbf:nTotCob    := sTot:nTotalCobrado

               ::oDbf:nRieCli    := RetFld( ( D():FacturasClientesFecha( ::nView ) )->cCodCli, ( D():Clientes( ::nView ) ), "Riesgo", "Cod" )
               ::oDbf:cDniCli    := RetFld( ( D():FacturasClientesFecha( ::nView ) )->cCodCli, ( D():Clientes( ::nView ) ), "Nif", "Cod" )





               if ::lValidRegister()
                  ::oDbf:Insert()
               else
                  ::oDbf:Cancel()
               end

            end

         next

         ( D():FacturasClientesFecha( ::nView ) )->( dbskip() )

         ::setMeterAutoIncremental()

      end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible aï¿½adir facturas de clientes" )

   end

   ErrorBlock( oBlock )

RETURN ( Self )



static FUNCTION TFastReportAlmacen_insertRectificativa( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   local sTot
   local oError
   local oBlock
   local aTotIva

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ( D():FacturasRectificativas( ::nView ) )->( OrdSetFocus( "dFecFac" ) )
      ( D():FacturasRectificativasLineas( ::nView ) )->( OrdSetFocus( "nNumFac" ) )



      ::cExpresionHeader          := 'Field->dFecFac >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. Field->dFecFac <= Ctod( "' + Dtoc( ::dFinInf ) + '" )'
      ::cExpresionHeader          += ' .and. Field->cSerie >= "' + Rtrim( ::oGrupoSerie:Cargo:Desde ) + '" .and. Field->cSerie <= "'    + Rtrim( ::oGrupoSerie:Cargo:Hasta ) + '"'
      ::cExpresionHeader          += ' .and. ( Field->cSufFac >= "' + Rtrim( ::oGrupoSufijo:Cargo:Desde ) + '" .and. Field->cSufFac <= "' + Rtrim( ::oGrupoSufijo:Cargo:Hasta ) + '" )'

      ::setFilterClientIdHeader()

      ::setFilterPaymentId()

      ::setFilterRouteId()

      ::setFilterAgentId()

      ::setFilterAlmacenId()



      ::setMeterText( "Procesando facturas rectificativas" )

      ( D():FacturasRectificativas( ::nView ) )->( setCustomFilter( ::cExpresionHeader ) )

      ::setMeterTotal( ( D():FacturasRectificativas( ::nView ) )->( dbcustomkeycount() ) )

      ( D():FacturasRectificativas( ::nView ) )->( dbgotop() )

      while !::lBreak .AND. !( D():FacturasRectificativas( ::nView ) )->( Eof() )

         sTot              := sTotFacRec( ( D():FacturasRectificativas( ::nView ) )->cSerie + Str( ( D():FacturasRectificativas( ::nView ) )->nNumFac ) + ( D():FacturasRectificativas( ::nView ) )->cSufFac, D():FacturasRectificativas( ::nView ), D():FacturasRectificativasLineas( ::nView ), D():TiposIva( ::nView ), D():Divisas( ::nView ), D():FacturasClientesCobros( ::nView ) )

         for each aTotIva in sTot:aTotalIva


            if aTotIva[ 8 ] <> 0       .AND. ( cCodigoIva( D():TiposIva( ::nView ), aTotIva[ 3 ] ) >= ::oGrupoIva:Cargo:Desde .AND. cCodigoIva( D():TiposIva( ::nView ), aTotIva[ 3 ] ) <= ::oGrupoIva:Cargo:Hasta )

               ::oDbf:Blank()

               ::oDbf:cCodCli    := ( D():FacturasRectificativas( ::nView ) )->cCodCli
               ::oDbf:cNomCli    := ( D():FacturasRectificativas( ::nView ) )->cNomCli
               ::oDbf:cCodAge    := ( D():FacturasRectificativas( ::nView ) )->cCodAge
               ::oDbf:cCodPgo    := ( D():FacturasRectificativas( ::nView ) )->cCodPago
               ::oDbf:cCodRut    := ( D():FacturasRectificativas( ::nView ) )->cCodRut
               ::oDbf:cCodUsr    := ( D():FacturasRectificativas( ::nView ) )->cCodUsr
               ::oDbf:cNomUsr    := UsuariosModel():getNombreWhereCodigo( ( D():FacturasRectificativas( ::nView ) )->cCodUsr )
               ::oDbf:cCodObr    := ( D():FacturasRectificativas( ::nView ) )->cCodObr
               ::oDbf:nComAge    := ( D():FacturasRectificativas( ::nView ) )->nPctComAge
               ::oDbf:cCodAlm    := ( D():FacturasRectificativas( ::nView ) )->cCodAlm

               ::oDbf:cCodPos    := ( D():FacturasRectificativas( ::nView ) )->cPosCli

               ::oDbf:cCodGrp    := RetFld( ( D():FacturasRectificativas( ::nView ) )->cCodCli, ( D():Clientes( ::nView ) ), "cCodGrp", "Cod" )

               ::oDbf:cTipDoc    := "Factura rectificativa"
               ::oDbf:cClsDoc    := "14"
               ::oDbf:cSerDoc    := ( D():FacturasRectificativas( ::nView ) )->cSerie
               ::oDbf:cNumDoc    := Str( ( D():FacturasRectificativas( ::nView ) )->cNumFac )
               ::oDbf:cSufDoc    := ( D():FacturasRectificativas( ::nView ) )->cSufFac
               ::oDbf:cIdeDoc    := Upper( ::oDbf:cTipDoc ) + ::oDbf:cSerDoc + ::oDbf:cNumDoc + ::oDbf:cSufDoc

               ::oDbf:nAnoDoc    := Year( ( D():FacturasRectificativas( ::nView ) )->dFecFac )
               ::oDbf:nMesDoc    := Month( ( D():FacturasRectificativas( ::nView ) )->dFecFac )
               ::oDbf:dFecDoc    := ( D():FacturasRectificativas( ::nView ) )->cFecFac
               ::oDbf:cHorDoc    := SubStr( ( D():FacturasRectificativas( ::nView ) )->cTimCre, 1, 2 )
               ::oDbf:cMinDoc    := SubStr( ( D():FacturasRectificativas( ::nView ) )->cTimCre, 4, 2 )

               ::oDbf:nIva       := aTotIva[ 3 ]
               ::oDbf:nReq       := aTotIva[ 4 ]
               ::oDbf:nTotNet    := aTotIva[ 2 ]
               ::oDbf:nTotIva    := aTotIva[ 8 ]
               ::oDbf:nTotReq    := aTotIva[ 9 ]
               ::oDbf:nTotDoc    := sTot:nTotalDocumento
               ::oDbf:nTotPnt    := aTotIva[ 5 ]
               ::oDbf:nTotTrn    := aTotIva[ 7 ]
               ::oDbf:nTotCos    := sTot:nTotalCosto
               ::oDbf:nTotIvm    := aTotIva[ 6 ]
               ::oDbf:nTotRnt    := sTot:nTotalRentabilidad
               ::oDbf:nTotRet    := sTot:nTotalRetencion
               ::oDbf:nTotCob    := sTot:nTotalCobrado

               ::oDbf:nRieCli    := RetFld( ( D():FacturasRectificativas( ::nView ) )->cCodCli, ( D():Clientes( ::nView ) ), "Riesgo", "Cod" )
               ::oDbf:cDniCli    := RetFld( ( D():FacturasRectificativas( ::nView ) )->cCodCli, ( D():Clientes( ::nView ) ), "Nif", "Cod" )





               if ::lValidRegister()
                  ::oDbf:Insert()
               else
                  ::oDbf:Cancel()
               end

               ::addFacturasRectificativasClientes()

            end

         next

         ( D():FacturasRectificativas( ::nView ) )->( dbskip() )

         ::setMeterAutoIncremental()

      end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible aï¿½adir facturas rectificativa" )

   end

   ErrorBlock( oBlock )

RETURN ( Self )



static FUNCTION TFastReportAlmacen_insertTicketCliente( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   local sTot
   local oError
   local oBlock
   local nPosIva        := 1

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ( D():TiketsClientes( ::nView ) )->( OrdSetFocus( "dFecTik" ) )
      ( D():TiketsLineas( ::nView ) )->( OrdSetFocus( "cNumTik" ) )



      ::cExpresionHeader          := 'Field->dFecTik >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. Field->dFecTik <= Ctod( "' + Dtoc( ::dFinInf ) + '" )'
      ::cExpresionHeader          += ' .and. Rtrim( cCliTik ) >= "' + Rtrim( ::oGrupoCliente:Cargo:Desde )   + '" .and. Rtrim( cCliTik ) <= "' + Rtrim( ::oGrupoCliente:Cargo:Hasta ) + '"'
      ::cExpresionHeader          += ' .and. Field->cSerTik >= "' + Rtrim( ::oGrupoSerie:Cargo:Desde ) + '" .and. Field->cSerTik <= "'    + Rtrim( ::oGrupoSerie:Cargo:Hasta ) + '"'
      ::cExpresionHeader          += ' .and. ( Field->cSufTik >= "' + Rtrim( ::oGrupoSufijo:Cargo:Desde ) + '" .and. Field->cSufTik <= "' + Rtrim( ::oGrupoSufijo:Cargo:Hasta ) + '" )'

      ::setFilterRouteId()

      ::setFilterAgentId()

      ::setFilterAlmacenId()



      ::setMeterText( "Procesando tickets" )

      ( D():TiketsClientes( ::nView ) )->( setCustomFilter( ::cExpresionHeader ) )

      ::setMeterTotal( ( D():TiketsClientes( ::nView ) )->( dbcustomkeycount() ) )

      ( D():TiketsClientes( ::nView ) )->( dbgotop() )

      while !::lBreak .AND. !( D():TiketsClientes( ::nView ) )->( eof() )

         sTot              := sTotTikCli( ( D():TiketsClientes( ::nView ) )->cSerTik + ( D():TiketsClientes( ::nView ) )->cNumTik + ( D():TiketsClientes( ::nView ) )->cSufTik, D():TiketsClientes( ::nView ), D():TiketsLineas( ::nView ), D():Divisas( ::nView ) )

         for nPosIva := 1 to 3

            if sTot:aIvaTik[ nPosIva ] <> nil

               if ( cCodigoIva( D():TiposIva( ::nView ), sTot:aIvaTik[ nPosIva ] ) >= ::oGrupoIva:Cargo:Desde .AND. cCodigoIva( D():TiposIva( ::nView ), sTot:aIvaTik[ nPosIva ] ) <= ::oGrupoIva:Cargo:Hasta )

                  ::oDbf:Blank()

                  ::oDbf:cCodCli    := ( D():TiketsClientes( ::nView ) )->cCliTik
                  ::oDbf:cNomCli    := ( D():TiketsClientes( ::nView ) )->cNomTik
                  ::oDbf:cCodAge    := ( D():TiketsClientes( ::nView ) )->cCodAge
                  ::oDbf:cCodPgo    := ( D():TiketsClientes( ::nView ) )->cFpgTik
                  ::oDbf:cCodRut    := ( D():TiketsClientes( ::nView ) )->cCodRut
                  ::oDbf:cCodUsr    := ( D():TiketsClientes( ::nView ) )->cCcjTik
                  ::oDbf:cNomUsr    := UsuariosModel():getNombreWhereCodigo( ( D():TiketsClientes( ::nView ) )->cCcjTik )
                  ::oDbf:cCodObr    := ( D():TiketsClientes( ::nView ) )->cCodObr
                  ::oDbf:cCodAlm    := ( D():TiketsClientes( ::nView ) )->cAlmTik

                  ::oDbf:cCodPos    := ( D():TiketsClientes( ::nView ) )->cPosCli

                  ::oDbf:cCodGrp    := RetFld( ( D():TiketsClientes( ::nView ) )->cCliTik, ( D():Clientes( ::nView ) ), "cCodGrp", "Cod" )

                  ::oDbf:cTipDoc    := "Simplificada"
                  ::oDbf:cClsDoc    := "12"
                  ::oDbf:cSerDoc    := ( D():TiketsClientes( ::nView ) )->cSerTik
                  ::oDbf:cNumDoc    := ( D():TiketsClientes( ::nView ) )->cNumTik
                  ::oDbf:cSufDoc    := ( D():TiketsClientes( ::nView ) )->cSufTik
                  ::oDbf:cIdeDoc    := Upper( ::oDbf:cTipDoc ) + ::oDbf:cSerDoc + ::oDbf:cNumDoc + ::oDbf:cSufDoc

                  ::oDbf:nAnoDoc    := Year( ( D():TiketsClientes( ::nView ) )->dFecTik )
                  ::oDbf:nMesDoc    := Month( ( D():TiketsClientes( ::nView ) )->dFecTik )
                  ::oDbf:dFecDoc    := ( D():TiketsClientes( ::nView ) )->dFecTik
                  ::oDbf:cHorDoc    := SubStr( ( D():TiketsClientes( ::nView ) )->cTimCre, 1, 2 )
                  ::oDbf:cMinDoc    := SubStr( ( D():TiketsClientes( ::nView ) )->cTimCre, 4, 2 )

                  ::oDbf:nIva       := sTot:aIvaTik[ nPosIva ]
                  ::oDbf:nReq       := 0
                  ::oDbf:nTotNet    := sTot:aBasTik[ nPosIva ]
                  ::oDbf:nTotIva    := sTot:nTotalIva
                  ::oDbf:nTotDoc    := sTot:nTotalDocumento
                  ::oDbf:nTotAge    := sTot:nTotalAgente
                  ::oDbf:nTotCos    := sTot:nTotalCosto
                  ::oDbf:nTotIvm    := sTot:aIvmTik[ nPosIva ]
                  ::oDbf:nTotRnt    := sTot:nTotalRentabilidad
                  ::oDbf:nTotCob    := sTot:nTotalCobrado

                  ::oDbf:nRieCli    := RetFld( ( D():TiketsClientes( ::nView ) )->cCliTik, ( D():Clientes( ::nView ) ), "Riesgo", "Cod" )
                  ::oDbf:cDniCli    := RetFld( ( D():TiketsClientes( ::nView ) )->cCliTik, ( D():Clientes( ::nView ) ), "Nif", "Cod" )





                  if ::lValidRegister()
                     ::oDbf:Insert()
                  else
                     ::oDbf:Cancel()
                  end

                  ::addTicketsClientes()

               end

            end

         next

         ( D():TiketsClientes( ::nView ) )->( dbskip() )

         ::setMeterAutoIncremental()

      end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible aï¿½adir facturas de clientes" )

   end

   ErrorBlock( oBlock )

RETURN ( Self )



static FUNCTION TFastReportAlmacen_AddClientes( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   ::setMeterTotal( ( D():Clientes( ::nView ) )->( dbcustomkeycount() ) )

   ::setMeterText( "Procesando clientes" )





   ( D():Clientes( ::nView ) )->( dbgotop() )

   while !( D():Clientes( ::nView ) )->( Eof() ) .AND. !::lBreak

      ::oDbf:Blank()

      ::oDbf:cCodCli := ( D():Clientes( ::nView ) )->Cod
      ::oDbf:cNomCli := ( D():Clientes( ::nView ) )->Titulo
      ::oDbf:cCodGrp := ( D():Clientes( ::nView ) )->cCodGrp
      ::oDbf:cCodPgo := ( D():Clientes( ::nView ) )->CodPago
      ::oDbf:cCodRut := ( D():Clientes( ::nView ) )->cCodRut
      ::oDbf:cCodAge := ( D():Clientes( ::nView ) )->cAgente
      ::oDbf:cCodPos := ( D():Clientes( ::nView ) )->CodPostal
      ::oDbf:nRieCli := ( D():Clientes( ::nView ) )->Riesgo
      ::oDbf:cDniCli := ( D():Clientes( ::nView ) )->Nif

      if ::lValidRegister()
         ::oDbf:Insert()
      else
         ::oDbf:Cancel()
      end

      ( D():Clientes( ::nView ) )->( dbskip() )

      ::setMeterAutoIncremental()

   end

RETURN ( Self )



static FUNCTION TFastReportAlmacen_loadValuesExtraFields( ) ; local Self AS CLASS TFastReportAlmacen := QSelf() AS CLASS TFastReportAlmacen

   local cField
   local uValor

   if isArray( ::aExtraFields ) .AND. len( ::aExtraFields ) <> 0

      for each cField in ::aExtraFields

         uValor             := ::oCamposExtra:valueExtraField( cField[ "código" ], ::oDbf:cSerDoc + Padr( ::oDbf:cNumDoc, 9 ) + ::oDbf:cSufDoc, cField )

         ::oDbf:fieldPutByName( "fld" + cField[ "código" ], uValor )

      next

   end

Return nil
