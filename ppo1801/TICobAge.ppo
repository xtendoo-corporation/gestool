#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 8 ".\.\Prg\TICobAge.prg"
_HB_CLASS TInfCobAge ; function TInfCobAge ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TInfCobAge", iif( .T., { @TInfGen() }, { @HBObject() } ), @TInfCobAge() ) ) ;

   _HB_MEMBER { nAgeDes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nAgeDes"}, .F. )
   _HB_MEMBER { nAgeHas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nAgeHas"}, .F. )
   _HB_MEMBER { cSufDes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufDes"}, .F. )
   _HB_MEMBER { cSufHas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufHas"}, .F. )
   _HB_MEMBER { oCobAgeT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCobAgeT"}, .F. )
   _HB_MEMBER { oCobAgeL } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCobAgeL"}, .F. )
   _HB_MEMBER { oFacCliT } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFacCliT"}, .F. )

   _HB_MEMBER Create(); oClass:AddMethod( "Create", @TInfCobAge_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TInfCobAge_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TInfCobAge_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lResource( cFld); oClass:AddMethod( "lResource", @TInfCobAge_lResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lGenerate(); oClass:AddMethod( "lGenerate", @TInfCobAge_lGenerate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TInfCobAge ;



static FUNCTION TInfCobAge_Create( ) ; local Self AS CLASS TInfCobAge := QSelf() AS CLASS TInfCobAge

   ::AddField( "cNumLiq", "C", 12, 0, {|| "@!" },        "Liquidación",      .F., "Número de la liquidación",    10 )
   ::AddField( "dFecLiq", "D",  8, 0, {|| "@!" },        "Fecha",            .F., "Fecha liquidación",            8 )
   ::AddField( "cCodAge", "C",  3, 0, {|| "@!" },        "Cod. Age.",        .F., "Código agente",               20 )
   ::AddField( "cNomAge", "C", 30, 0, {|| "@!" },        "Agente",           .F., "Nombre agente",               20 )
   ::AddField( "cTipo",   "C", 14, 0, {|| "@!" },        "Tipo",             .T., "Tipo de factura",             20 )
   ::AddField( "cNumFac", "C", 14, 0, {|| "@!" },        "Factura",          .T., "Número de factura",           20 )
   ::AddField( "dFecFac", "D",  8, 0, {|| "@!" },        "Fecha",            .T., "Fecha de la factura",         10 )
   ::AddField( "cCodCli", "C", 12, 0, {|| "@!" },        "Cod. Cli.",        .F., "Código de cliente",           10 )
   ::AddField( "cNomCli", "C", 80, 0, {|| "@!" },        "Cliente",          .T., "Nombre del cliente",          50 )
   ::AddField( "nTotBas", "N", 16, 6, {|| ::cPicOut },   "Base",             .T., "Base comisionable",           12 )
   ::AddField( "nPorCom", "N", 16, 6, {|| "@E 999.99" }, "% Com.",           .T., "Porcentaje de comisión",      12 )
   ::AddField( "nTotCom", "N", 16, 6, {|| ::cPicOut },   "Total",            .T., "Total comisión",              12 )

   ::AddTmpIndex( "cNumLiq", "cNumLiq + cNumFac" )

   ::AddGroup( {|| ::oDbf:cNumLiq }, {|| "Liquidación : " + AllTrim( ::oDbf:cNumLiq ) + " Fecha: " + Dtoc( ::oDbf:dFecLiq ) + " Agente: " + AllTrim( ::oDbf:cCodAge ) + " - " + AllTrim( ::oDbf:cNomAge ) }, {|| "Total liquidación..." } )

   ::oCobAgeT  := ::xOthers[ 1 ]
   ::oCobAgeL  := ::xOthers[ 2 ]

RETURN ( Self )



static FUNCTION TInfCobAge_OpenFiles( ) ; local Self AS CLASS TInfCobAge := QSelf() AS CLASS TInfCobAge

   local lOpen    := .T.
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

   ::oDbfDiv := DbfServer( "DIVISAS.DBF", ):NewOpen( "DIVISAS.DBF",, ( cDriver() ),, ( cPatDat() ), .F., .T., .F., .F. ) ; ::oDbfDiv:AddBag( "DIVISAS.CDX" ) ; ::oDbfDiv:AddBag( ) ; ::oDbfDiv:AutoIndex()

   ::oFacCliT     := TDataCenter():oFacCliT()

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      ::CloseFiles()
      lOpen          := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TInfCobAge_CloseFiles( ) ; local Self AS CLASS TInfCobAge := QSelf() AS CLASS TInfCobAge

   if !Empty( ::oDbfDiv ) .AND. ::oDbfDiv:Used()
      ::oDbfDiv:End()
   end

   if !Empty( ::oFacCliT ) .AND. ::oFacCliT:Used()
      ::oFacCliT:End()
   end

   ::oDbfDiv  := nil
   ::oFacCliT := nil

RETURN ( .T. )



static FUNCTION TInfCobAge_lResource( cFld ) ; local Self AS CLASS TInfCobAge := QSelf() AS CLASS TInfCobAge

   ::nAgeDes      := dbFirst ( ::oCobAgeT, 2 )
   ::nAgeHas      := dbLast  ( ::oCobAgeT, 2 )
   ::cSufDes      := dbFirst ( ::oCobAgeT, 3 )
   ::cSufHas      := dbLast  ( ::oCobAgeT, 3 )

   ::lDefDivInf   := .F.
   ::lDefSerInf   := .F.

   if !::StdResource( "INF_GENCOBAGE" )
      return .F.
   end

   ::lLoadDivisa()









   TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::nAgeDes, ::nAgeDes:= u ) }, ::oFld:aDialogs[1],, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )



   TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cSufDes, ::cSufDes:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::nAgeHas, ::nAgeHas:= u ) }, ::oFld:aDialogs[1],, "999999999",,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )



   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cSufHas, ::cSufHas:= u ) }, ::oFld:aDialogs[1],,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )

   if !::oDefAgeInf( 140, 141, 150, 151, 160 )
      return .F.
   end

   ::oMtrInf:SetTotal( ::oCobAgeT:Lastrec() )

   ::CreateFilter( , ::oCobAgeT )

RETURN .T.






static FUNCTION TInfCobAge_lGenerate( ) ; local Self AS CLASS TInfCobAge := QSelf() AS CLASS TInfCobAge

   local nKlgEnt  := 0
   local cExpHead := ""

   ::oDlg:Disable()

   ::oDbf:Zap()



   ::aHeader         := {  {|| "Fecha   : " + Dtoc( Date() ) }, {|| "Rango   : " + Alltrim( Str( ::nAgeDes ) ) + "/" + AllTrim( ::cSufDes ) + " > " + Alltrim( Str( ::nAgeHas ) ) + "/" + Alltrim( ::cSufHas ) } , {|| "Agentes : " + if( ::lAgeAll, "Todos", AllTrim( ::cAgeOrg ) + " > " + AllTrim( ::cAgeDes ) ) } }

   ::oCobAgeT:OrdSetFocus( "nNumCob" )
   ::oCobAgeL:OrdSetFocus( "nNumCob" )

   cExpHead          := 'dFecCob >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. dFecCob <= Ctod( "' + Dtoc( ::dFinInf ) + '" )'

   if !::lAgeAll
      cExpHead       += '.and. cCodAge >= "' + Rtrim( ::cAgeOrg ) + '" .and. cCodAge <= "' + Rtrim( ::cAgeDes ) + '"'
   end

   if !Empty( ::oFilter:cExpresionFilter )
      cExpHead       += ::oFilter:cExpresionFilter
   end

   ::oCobAgeT:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oCobAgeT:cFile ), ::oCobAgeT:OrdKey(), ( cExpHead ), , , , , , , , .T. )

   if ::oCobAgeT:Seek( Str( ::nAgeDes ) + ::cSufDes )

      while Str( ::oCobAgeT:nNumCob ) + ::oCobAgeT:cSufCob <= Str( ::nAgeHas ) + ::cSufHas .AND. !::oCobAgeT:eof()





         if ::oCobAgeL:Seek( Str( ::oCobAgeT:nNumCob ) + ::oCobAgeT:cSufCob )


            while Str( ::oCobAgeT:nNumCob ) + ::oCobAgeT:cSufCob == Str( ::oCobAgeL:nNumCob ) + ::oCobAgeL:cSufCob .AND. !::oCobAgeL:Eof()

               ::oDbf:Append()

               ::oDbf:cNumLiq    := AllTrim( Str( ::oCobAgeT:nNumCob ) ) + "/" + ::oCobAgeT:cSufCob
               ::oDbf:dFecLiq    := ::oCobAgeT:dFecCob
               ::oDbf:cCodAge    := ::oCobAgeT:cCodAge
               ::oDbf:cNomAge    := cNbrAgent( ::oCobAgeT:cCodAge, ::oDbfAge:cAlias )
               ::oDbf:cTipo      := if( ::oCobAgeL:lFacRec, "Rectificativa", "Factura" )
               ::oDbf:cNumFac    := ::oCobAgeL:cSerFac + "/" + AllTrim( Str( ::oCobAgeL:nNumFac ) )+ "/" + ::oCobAgeL:cSufFac
               ::oDbf:dFecFac    := ::oCobAgeL:dFecFac
               ::oDbf:cCodCli    := ::oCobAgeL:cCodCli
               ::oDbf:cNomCli    := oRetFld( Padr( ::oCobAgeL:cCodCli, 12 ), ::oFacCliT, "cNomCli", "CCODCLI" )
               ::oDbf:nTotBas    := ::oCobAgeL:nImpCom
               ::oDbf:nPorCom    := ::oCobAgeL:nComAge
               ::oDbf:nTotCom    := ( ::oCobAgeL:nImpCom * ::oCobAgeL:nComAge / 100 )

               ::oDbf:Save()

               ::oCobAgeL:Skip()

            end

         end

         ::oCobAgeT:Skip()

         ::oMtrInf:AutoInc( ::oCobAgeT:OrdKeyNo() )

      end

   end

   ::oCobAgeT:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oCobAgeT:cFile ) )

   ::oMtrInf:AutoInc( ::oCobAgeT:LastRec() )

   ::oCobAgeT:SetStatus()

   ::oDlg:Enable()

RETURN ( ::oDbf:LastRec() > 0 )
