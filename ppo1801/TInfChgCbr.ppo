#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 8 ".\.\Prg\TInfChgCbr.prg"
_HB_CLASS TInfChgCBr ; function TInfChgCBr ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TInfChgCBr", iif( .T., { @TInfGen() }, { @HBObject() } ), @TInfChgCBr() ) ) ;

   _HB_MEMBER { AS OBJECT oDbfBar } ; oClass:AddMultiData( "OBJECT",, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDbfBar"}, .F. )

   _HB_MEMBER create(); oClass:AddMethod( "create", @TInfChgCBr_create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles(); oClass:AddMethod( "OpenFiles", @TInfChgCBr_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TInfChgCBr_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lResource( cFld); oClass:AddMethod( "lResource", @TInfChgCBr_lResource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lGenerate(); oClass:AddMethod( "lGenerate", @TInfChgCBr_lGenerate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TInfChgCBr ;



static FUNCTION TInfChgCBr_create( ) ; local Self AS CLASS TInfChgCBr := QSelf() AS CLASS TInfChgCBr

   ::AddField( "cCodArt",  "C", 18, 0, {|| "@!" },        "Código artículo",                 .F., "Cod. artículo"            , 15, .F. )
   ::AddField( "cNomArt",  "C",100, 0, {|| "@!" },        "Descripción",               .F., "Descripción"              , 50, .F. )
   ::AddField( "cCodBar",  "C", 20, 0, {|| "@!" },        "Código de barras",          .T., "Código de barras"         , 25, .F. )
   ::AddField( "cTipBar",  "C", 40, 0, {|| "@!" },        "Tipo de código de barras",  .T., "Tipo de código de barras" , 40, .F. )
   ::AddField( "cDefecto", "C", 10, 0, {|| "@!" },        "Defecto",                   .T., "Defecto"                  , 10, .F. )
   ::AddField( "LastChg",  "D",  8, 0, {|| "@!" },        "Cambio",                    .F., "Fecha de cambio"          , 10, .F. )

   ::AddTmpIndex( "CCODART", "CCODART + CCODBAR" )

   ::AddGroup( {|| ::oDbf:cCodArt }, {|| "Artículo  : " + Rtrim( ::oDbf:cCodArt ) + "-" + Rtrim( ::oDbf:cNomArt ) }, {||""} )

   ::dIniInf      := GetSysDate()
   ::lDefSerInf   := .F.
   ::lDefDivInf   := .F.

RETURN ( self )



static FUNCTION TInfChgCBr_OpenFiles( ) ; local Self AS CLASS TInfChgCBr := QSelf() AS CLASS TInfChgCBr

   local lOpen    := .T.
   local oBlock   := ErrorBlock( {| oError | ApoloBreak( oError ) } )

   BEGIN SEQUENCE

      ::oDbfBar := DbfServer( "ARTCODEBAR.DBF", ):NewOpen( "ARTCODEBAR.DBF",, ( cDriver() ),, ( cPatEmp() ), .F., .T., .F., .F. ) ; ::oDbfBar:AddBag( "ARTCODEBAR.CDX" ) ; ::oDbfBar:AddBag( ) ; ::oDbfBar:AutoIndex()

   RECOVER

      msgStop( "Imposible abrir todas las bases de datos" )
      ::CloseFiles()
      lOpen       := .F.

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TInfChgCBr_CloseFiles( ) ; local Self AS CLASS TInfChgCBr := QSelf() AS CLASS TInfChgCBr

   if !Empty( ::oDbfBar ) .AND. ::oDbfBar:Used()
      ::oDbfBar:End()
   end

   ::oDbfBar      := nil

RETURN ( Self )



static FUNCTION TInfChgCBr_lResource( cFld ) ; local Self AS CLASS TInfChgCBr := QSelf() AS CLASS TInfChgCBr

   if !::StdResource( "INFCHGBAR" )
      return .F.
   end

   if !::lDefArtInf( 110, 120, 130, 140, 600 )
      return .F.
   end





   ::oMtrInf:SetTotal( ::oDbfArt:Lastrec() )

   ::CreateFilter( aItmArt(), ::oDbfArt:cAlias )

RETURN .T.






static FUNCTION TInfChgCBr_lGenerate( ) ; local Self AS CLASS TInfChgCBr := QSelf() AS CLASS TInfChgCBr

   local cExpHead := ""

   ::oDlg:Disable()
   ::oDbf:Zap()



   ::aHeader      := {  {|| "Fecha     : " + Dtoc( Date() ) }, {|| "Periodo   : " + Dtoc( ::dIniInf ) + " > " + Dtoc( ::dFinInf ) }, {|| "Artículos : " + if( ::lAllArt, "Todos", AllTrim( ::cArtOrg ) + " > " + AllTrim( ::cArtDes ) ) } }

   cExpHead       := 'LastChg >= Ctod( "' + Dtoc( ::dIniInf ) + '" ) .and. LastChg <= Ctod( "' + Dtoc( ::dFinInf ) + '" )'

   if !::lAllArt
      cExpHead    += ' .and. Codigo >= "' + Rtrim( ::cArtOrg ) + '" .and. Codigo <= "' + Rtrim( ::cArtDes ) + '"'
   end

   if !Empty( ::oFilter:cExpresionFilter )
      cExpHead    := " .and. " + ::oFilter:cExpresionFilter
   end

   ::oDbfArt:AddTmpIndex( Auth():Codigo(), GetFileNoExt( ::oDbfArt:cFile ), ::oDbfArt:OrdKey(), ( cExpHead ), , , , , , , , .T. )

   ::oMtrInf:SetTotal( ::oDbfArt:OrdKeyCount() )

   ::oDbfArt:OrdSetFocus( "Codigo" )

   ::oDbfArt:GoTop()

   while !::oDbfArt:Eof()

      if ::oDbfBar:SeekInOrd( ::oDbfArt:Codigo, "cCodArt" )

         while ::oDbfBar:cCodArt == ::oDbfArt:Codigo .AND. !::oDbfBar:Eof()

            ::oDbf:Append()

            ::oDbf:LastChg          := ::oDbfArt:LastChg
            ::oDbf:cCodArt          := ::oDbfArt:Codigo
            ::oDbf:cNomArt          := ::oDbfArt:Nombre
            ::oDbf:cCodBar          := ::oDbfBar:cCodBar

            if ::oDbfBar:lDefBar
               ::oDbf:cDefecto      := "Si"
            else
               ::oDbf:cDefecto      := ""
            end

            do case
               case ::oDbfBar:nTipBar == 1
                  ::oDbf:cTipBar    := "Ean13"
               case ::oDbfBar:nTipBar == 2
                  ::oDbf:cTipBar    := "Code39"
               case ::oDbfBar:nTipBar == 3
                  ::oDbf:cTipBar    := "Code128"
            end

            ::oDbf:Save()

            ::oDbfBar:Skip()

         end

      end

      ::oDbfArt:Skip()

      ::oMtrInf:AutoInc( ::oDbfArt:OrdKeyNo() )

   end

   ::oDbfArt:IdxDelete( Auth():Codigo(), GetFileNoExt( ::oDbfArt:cFile ) )

   ::oMtrInf:AutoInc( ::oDbfArt:Lastrec() )

   ::oDlg:Enable()

RETURN ( ::oDbf:LastRec() > 0 )
