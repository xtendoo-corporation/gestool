#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 10 ".\.\Prg\TPrepareDocument.prg"
_HB_CLASS TPrepareDocument ; function TPrepareDocument ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TPrepareDocument", iif( .F., { }, { @HBObject() } ), @TPrepareDocument() ) ) ;

   _HB_MEMBER { oDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDlg"}, .F. )
   _HB_MEMBER { oFld } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFld"}, .F. )

   _HB_MEMBER { oBmp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBmp"}, .F. )

   _HB_MEMBER { cTituloVentana } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTituloVentana"}, .F. )

   _HB_MEMBER { oTextoNumeroDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTextoNumeroDocumento"}, .F. )
   _HB_MEMBER { cTextoNumeroDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTextoNumeroDocumento"}, .F. )
   _HB_MEMBER { oTextoClienteDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTextoClienteDocumento"}, .F. )
   _HB_MEMBER { cTextoClienteDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTextoClienteDocumento"}, .F. )

   _HB_MEMBER { oNumBultos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oNumBultos"}, .F. )
   _HB_MEMBER { cNumBultos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNumBultos"}, .F. )
   _HB_MEMBER { oNumEstuches } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oNumEstuches"}, .F. )
   _HB_MEMBER { cNumEstuches } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNumEstuches"}, .F. )

   _HB_MEMBER { oFechaSalida } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFechaSalida"}, .F. )
   _HB_MEMBER { cFechaSalida } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFechaSalida"}, .F. )

   _HB_MEMBER { oImpresora } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oImpresora"}, .F. )
   _HB_MEMBER { cImpresora } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cImpresora"}, .F. )
   _HB_MEMBER { oFormatoImpresion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFormatoImpresion"}, .F. )
   _HB_MEMBER { cFormatoImpresion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFormatoImpresion"}, .F. )

   _HB_MEMBER { oCodigoBarras } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodigoBarras"}, .F. )
   _HB_MEMBER { cCodigoBarras } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodigoBarras"}, .F. )

   _HB_MEMBER { DbfCabecera } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"DbfCabecera"}, .F. )
   _HB_MEMBER { dbfLineas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dbfLineas"}, .F. )

   _HB_MEMBER { nView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nView"}, .F. )

   _HB_MEMBER { lErrorOnCreate } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lErrorOnCreate"}, .F. )
   _HB_MEMBER { nRecnoHead } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nRecnoHead"}, .F. )
   _HB_MEMBER { nOrderHead } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nOrderHead"}, .F. )
   _HB_MEMBER { nRecnoLine } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nRecnoLine"}, .F. )
   _HB_MEMBER { nOrderLine } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nOrderLine"}, .F. )

   _HB_MEMBER { oBrwOriginalLines } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwOriginalLines"}, .F. )
   _HB_MEMBER { aOriginalLines } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aOriginalLines"}, .F. )

   _HB_MEMBER { oBrwFinalLines } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oBrwFinalLines"}, .F. )
   _HB_MEMBER { aFinalLines } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aFinalLines"}, .F. )

   _HB_MEMBER { aKitLines } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aKitLines"}, .F. )

   _HB_MEMBER { aInfoLines } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aInfoLines"}, .F. )
   _HB_MEMBER { aMateriasPrimas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aMateriasPrimas"}, .F. )

   _HB_MEMBER { cSerieDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSerieDocumento"}, .F. )
   _HB_MEMBER { nNumeroDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nNumeroDocumento"}, .F. )
   _HB_MEMBER { cSufijoDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSufijoDocumento"}, .F. )

   _HB_MEMBER { cIdDocumento } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cIdDocumento"}, .F. )

   _HB_MEMBER { cCodigoBarras } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodigoBarras"}, .F. )
   _HB_MEMBER { cLote } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cLote"}, .F. )
   _HB_MEMBER { dFechaCaducidad } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"dFechaCaducidad"}, .F. )
   _HB_MEMBER { cCodigoArticulo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodigoArticulo"}, .F. )
   _HB_MEMBER { nUnidades } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nUnidades"}, .F. )
   _HB_MEMBER { uuidEtiqueta } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"uuidEtiqueta"}, .F. )

   _HB_MEMBER { aUuidQR } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aUuidQR"}, .F. )

   _HB_MEMBER { nPos } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nPos"}, .F. )

   _HB_MEMBER Run( nView); oClass:AddMethod( "Run", @TPrepareDocument_Run(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lCheckConditions(); oClass:AddMethod( "lCheckConditions", @TPrepareDocument_lCheckConditions(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER New(); oClass:AddMethod( "New", @TPrepareDocument_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Dialog(); oClass:AddMethod( "Dialog", @TPrepareDocument_Dialog(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER loadInitData(); oClass:AddMethod( "loadInitData", @TPrepareDocument_loadInitData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validCodigoBarras(); oClass:AddMethod( "validCodigoBarras", @TPrepareDocument_validCodigoBarras(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setHashCodeBar(); oClass:AddMethod( "setHashCodeBar", @TPrepareDocument_setHashCodeBar(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SetCodigoArticulo(); oClass:AddMethod( "SetCodigoArticulo", @TPrepareDocument_SetCodigoArticulo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER resetCodeBar(); oClass:AddMethod( "resetCodeBar", @TPrepareDocument_resetCodeBar(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER processCodeBar(); oClass:AddMethod( "processCodeBar", @TPrepareDocument_processCodeBar(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER AddNewLine(); oClass:AddMethod( "AddNewLine", @TPrepareDocument_AddNewLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER DelOriginalLine(); oClass:AddMethod( "DelOriginalLine", @TPrepareDocument_DelOriginalLine(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER end(); oClass:AddMethod( "end", @TPrepareDocument_end(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER StartDialog(); oClass:AddMethod( "StartDialog", @TPrepareDocument_StartDialog(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER loadUnprepareLinesFromDocument() ; oClass:AddVirtual( "loadUnprepareLinesFromDocument" )
   _HB_MEMBER loadPrepareLinesFromDocument() ; oClass:AddVirtual( "loadPrepareLinesFromDocument" )
   _HB_MEMBER loadKitLinesFromDocument() ; oClass:AddVirtual( "loadKitLinesFromDocument" )

   _HB_MEMBER getValueOriginalLine(); oClass:AddInline( "getValueOriginalLine", {|Self, cField | ( ( Self ) ), ( if( len( ::aOriginalLines ) == 0, "", ::aOriginalLines[ ::oBrwOriginalLines:nArrayAt, ( ::dbfLineas )->( FieldPos( cField ) ) ] ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getValueFinalLine(); oClass:AddInline( "getValueFinalLine", {|Self, cField | ( ( Self ) ), ( if( len( ::aFinalLines ) == 0, "", ::aFinalLines[ ::oBrwFinalLines:nArrayAt, ( ::dbfLineas )->( FieldPos( cField ) ) ] ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER nPosScanOriginalLines(); oClass:AddMethod( "nPosScanOriginalLines", @TPrepareDocument_nPosScanOriginalLines(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER nPosScanFinalLines(); oClass:AddMethod( "nPosScanFinalLines", @TPrepareDocument_nPosScanFinalLines(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setLinesToDocument(); oClass:AddMethod( "setLinesToDocument", @TPrepareDocument_setLinesToDocument(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER setPreparated(); oClass:AddMethod( "setPreparated", @TPrepareDocument_setPreparated(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER printLabel(); oClass:AddMethod( "printLabel", @TPrepareDocument_printLabel(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER saveBultos(); oClass:AddMethod( "saveBultos", @TPrepareDocument_saveBultos(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER print(); oClass:AddMethod( "print", @TPrepareDocument_print(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Info( nView, oWndBrw); oClass:AddMethod( "Info", @TPrepareDocument_Info(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER DialogInfo(); oClass:AddMethod( "DialogInfo", @TPrepareDocument_DialogInfo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER lPrepareInfo(); oClass:AddMethod( "lPrepareInfo", @TPrepareDocument_lPrepareInfo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER aAddInfoLines( aField); oClass:AddMethod( "aAddInfoLines", @TPrepareDocument_aAddInfoLines(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addStockInfo(); oClass:AddMethod( "addStockInfo", @TPrepareDocument_addStockInfo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addProducir(); oClass:AddMethod( "addProducir", @TPrepareDocument_addProducir(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER addStockReal(); oClass:AddMethod( "addStockReal", @TPrepareDocument_addStockReal(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TPrepareDocument ;



static FUNCTION TPrepareDocument_Run( nView ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::New( nView )

   if ::lCheckConditions()
      ::Dialog()
   end

Return self



static FUNCTION TPrepareDocument_lCheckConditions( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   if ( ::DbfCabecera )->( OrdKeyNo() ) == 0
      MsgBeepStop( "No hay documento para preparar" )
      Return ( .F. )
   end

   if !( ::DbfCabecera )->lPdtCrg
      MsgBeepStop( "Documento no está seleccionado para preparar" )
      Return ( .F. )
   end

   if ( ::DbfCabecera )->nPrepare == 4
      MsgBeepStop( "Documento totalmente preparado" )
      Return ( .F. )
   end

Return( .T. )



static FUNCTION TPrepareDocument_New( nView ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local oError
   local oBlock

   if !empty( nView )
      ::nView              := nView
   end

   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::nRecnoHead         := ( ::dbfCabecera )->( Recno() )
      ::nOrderHead         := ( ::dbfCabecera )->( OrdSetFocus( 1 ) )

      ::nRecnoLine         := ( ::dbfLineas )->( Recno() )
      ::nOrderLine         := ( ::dbfLineas )->( OrdSetFocus( 1 ) )

      ::aOriginalLines     := {}
      ::aFinalLines        := {}
      ::aKitLines          := {}

      ::aUuidQR            := {}

   RECOVER USING oError

      ::lErrorOnCreate     := .T.

      MsgBeepStop( "Error en la proparación del documento" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end
   ErrorBlock( oBlock )

Return ( Self )



static FUNCTION TPrepareDocument_Dialog( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::loadInitData()

   ::oDlg = TDialog():New(,,,, "Preparando " + ::cTituloVentana, "PREPARARDOCUMENTO",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )





   ::oBmp := TBitmap():ReDefine( 990, "GC_BARCODE_SCANNER_48",, ::oDlg,,, .F., .F.,,, .F.,,, .T. )




   ::oTextoNumeroDocumento := TSay():ReDefine( 100, {||      ::cTextoNumeroDocumento}, ::oDlg,,,, .F.,, .F., .F., )




   ::oTextoClienteDocumento := TSay():ReDefine( 110, {||      ::cTextoClienteDocumento}, ::oDlg,,,, .F.,, .F., .F., )




   ::oCodigoBarras := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::cCodigoBarras, ::cCodigoBarras:= u ) }, ::oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )

   ::oCodigoBarras:bValid  := {|| ::validCodigoBarras() }

   ::oBrwOriginalLines                        := IXBrowse():New( ::oDlg )

   ::oBrwOriginalLines:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
   ::oBrwOriginalLines:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

   ::oBrwOriginalLines:SetArray( ::aOriginalLines, , , .F. )

   ::oBrwOriginalLines:nMarqueeStyle          := 6
   ::oBrwOriginalLines:lRecordSelector        := .F.
   ::oBrwOriginalLines:lHScroll               := .F.
   ::oBrwOriginalLines:lFooter                := .T.

   ::oBrwOriginalLines:CreateFromResource( 130 )

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Código"
      :bStrData         := {|| ::getValueOriginalLine( "cRef" ) }
      :nWidth           := 100
   end

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Detalle"
      :bStrData         := {|| ::getValueOriginalLine( "cDetalle" ) }
      :nWidth           := 260
   end

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Lote"
      :bStrData         := {|| ::getValueOriginalLine( "cLote" ) }
      :nWidth           := 100
   end

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Unidades"
      :bEditValue       := {|| ::getValueOriginalLine( "nUniCaja" ) }
      :cEditPicture     := MasUnd()
      :nWidth           := 60
      :nDataStrAlign    := 1
      :nHeadStrAlign    := 1
      :nFooterType      := 1
      :cFooterPicture   := MasUnd()
      :nFootStrAlign    := 1
   end

   ::oBrwFinalLines                        := IXBrowse():New( ::oDlg )

   ::oBrwFinalLines:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
   ::oBrwFinalLines:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

   ::oBrwFinalLines:SetArray( ::aFinalLines, , , .F. )

   ::oBrwFinalLines:nMarqueeStyle          := 6
   ::oBrwFinalLines:lRecordSelector        := .F.
   ::oBrwFinalLines:lHScroll               := .F.
   ::oBrwFinalLines:lFooter                := .T.

   ::oBrwFinalLines:CreateFromResource( 140 )

   with object ( ::oBrwFinalLines:AddCol() )
      :cHeader          := "Código"
      :bStrData         := {|| ::getValueFinalLine( "cRef" ) }
      :nWidth           := 100
   end

   with object ( ::oBrwFinalLines:AddCol() )
      :cHeader          := "Detalle"
      :bStrData         := {|| ::getValueFinalLine( "cDetalle" ) }
      :nWidth           := 260
   end

   with object ( ::oBrwFinalLines:AddCol() )
      :cHeader          := "Lote"
      :bStrData         := {|| ::getValueFinalLine( "cLote" ) }
      :nWidth           := 100
   end

   with object ( ::oBrwFinalLines:AddCol() )
      :cHeader          := "Unidades"
      :bEditValue       := {|| ::getValueFinalLine( "nUniCaja" ) }
      :cEditPicture     := MasUnd()
      :nWidth           := 60
      :nDataStrAlign    := 1
      :nHeadStrAlign    := 1
      :nFooterType      := 1
      :cFooterPicture   := MasUnd()
      :nFootStrAlign    := 1
   end





   TButton():ReDefine( 520, {||( ::printLabel() )}, ::oDlg,,, .F.,,,, .T. )





   TButton():ReDefine( 510, {||( ::setLinesToDocument(), ::setPreparated( .T. ), ::end() )}, ::oDlg,,, .F.,,,, .T. )





   TButton():ReDefine( 500, {||( ::setLinesToDocument(), ::setPreparated(), ::end() )}, ::oDlg,,, .F.,,,, .T. )





   TButton():ReDefine( 550, {||( ::end() )}, ::oDlg,,, .F.,,,, .T. )

      ::oDlg:bStart := {|| ::StartDialog() }

   ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

Return ( Self )



static FUNCTION TPrepareDocument_StartDialog( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   if !empty( ::oBrwOriginalLines )
      ::oBrwOriginalLines:MakeTotals()
      ::oBrwOriginalLines:Load()
      ::oBrwOriginalLines:GoTop()
      ::oBrwOriginalLines:Refresh()
   end

   if !empty( ::oBrwFinalLines )
      ::oBrwFinalLines:MakeTotals()
      ::oBrwFinalLines:Load()
      ::oBrwFinalLines:GoTop()
      ::oBrwFinalLines:Refresh()
   end

Return ( Self )



static FUNCTION TPrepareDocument_loadInitData( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::nPos            := 0

   ::cCodigoBarras   := Space( 200 )

   ::aOriginalLines  := ::loadUnprepareLinesFromDocument()
   ::aFinalLines     := ::loadPrepareLinesFromDocument()
   ::aKitLines       := ::loadKitLinesFromDocument()

   ::cLote           := ""
   ::nUnidades       := 1
   ::dFechaCaducidad := Stod( "" )
   ::uuidEtiqueta    := ""

Return ( Self )



static FUNCTION TPrepareDocument_validCodigoBarras( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local hHas128

   if !Empty( AllTrim( ::cCodigoBarras ) )

      hHas128              := GetHashPrepareGs128( AllTrim( ::cCodigoBarras ) )

      if !empty( hHas128 )
         ::setHashCodeBar( hHas128 )
      end

      ::SetCodigoArticulo()

      ::processCodeBar()

   end

   ::resetCodeBar()

Return ( .T. )



static FUNCTION TPrepareDocument_setHashCodeBar( hHas128 ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::cCodigoBarras         := uGetCodigo( hHas128, "01" )
   ::cLote                 := Upper( uGetCodigo( hHas128, "10" ) )
   ::nUnidades             := val( uGetCodigo( hHas128, "37" ) )
   ::uuidEtiqueta          := uGetCodigo( hHas128, "9999" )

   if ::nUnidades == 0
      ::nUnidades          := 1
   end

   ::dFechaCaducidad       := uGetCodigo( hHas128, "17" )

   if ValType( uGetCodigo( hHas128, "17" ) ) == "C"
      ::dFechaCaducidad    := Stod( ::dFechaCaducidad )
   end

Return ( .T. )



static FUNCTION TPrepareDocument_resetCodeBar( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::oCodigoBarras:SetFocus()
   ::cCodigoBarras   := Space( 200 )
   ::oCodigoBarras:Refresh()

   ::nPos            := 0
   ::cCodigoArticulo := ""
   ::cLote           := ""
   ::nUnidades       := 1
   ::dFechaCaducidad := Stod( "" )
   ::uuidEtiqueta    := ""

Return ( .T. )



static FUNCTION TPrepareDocument_SetCodigoArticulo( cCodBar ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::cCodigoArticulo       := padr( cSeekCodebar( ::cCodigoBarras, D():ArticulosCodigosBarras( ::nView ), D():Articulos( ::nView ) ), 18 )

Return ( .T. )



static FUNCTION TPrepareDocument_end( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ( ::dbfCabecera )->( dbGoTo( ::nRecnoHead ) )
   ( ::dbfCabecera )->( OrdSetFocus( ::nOrderHead ) )

   ( ::dbfLineas )->( dbGoTo( ::nRecnoLine ) )
   ( ::dbfLineas )->( OrdSetFocus( ::nOrderLine ) )

   if !Empty( ::oBmp )
      ::oBmp:End()
   end


   if !Empty( ::oDlg )
      ::oDlg:End()
   end

Return ( Self )



static FUNCTION TPrepareDocument_processCodeBar( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   if Len( ::aOriginalLines ) == 0
      MsgBeepStop( "No existen lineas por preparar." )
      Return ( self )
   end

   if aScan( ::aUuidQR, ::uuidEtiqueta ) <> 0
      MsgBeepStop( "Ésta etiqueta ya ha sido introducida" )
      ::uuidEtiqueta    := ""
      Return ( self )
   end

   ::nPosScanOriginalLines()

   if ::nPos == 0
      MsgBeepStop( "El artículo introducido no se encuentra para preparar" )
      Return ( self )
   end

   ::AddNewLine()

   ::DelOriginalLine()

Return ( Self )



static FUNCTION TPrepareDocument_AddNewLine( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local nPos
   local aOriginalLine       := aClone( ::aOriginalLines[ ::nPos ] )

   if len( ::aFinalLines ) == 0

      aadd( ::aFinalLines, aOriginalLine )

      if Empty( ::aFinalLines[ 1, ( ::dbfLineas )->( FieldPos( "cLote" ) ) ] ) .AND. !Empty( ::cLote )
         ::aFinalLines[ 1, ( ::dbfLineas )->( FieldPos( "cLote" ) ) ]   := ::cLote
      end

      if Empty( dTos( ::aFinalLines[ 1, ( ::dbfLineas )->( FieldPos( "dFecCad" ) ) ] ) ) .AND. !Empty( dTos( ::dFechaCaducidad ) )
         ::aFinalLines[ 1, ( ::dbfLineas )->( FieldPos( "dFecCad" ) ) ]   := ::dFechaCaducidad
      end

      ::aFinalLines[ 1, ( ::dbfLineas )->( FieldPos( "nCanEnt" ) ) ]    := 1
      ::aFinalLines[ 1, ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ]   := ::nUnidades
      ::aFinalLines[ 1, ( ::dbfLineas )->( FieldPos( "lPreparado" ) ) ] := .T.

   else

      nPos        := ::nPosScanFinalLines()

      if nPos <> 0

         if !Empty( dTos( ::dFechaCaducidad ) )
            ::aFinalLines[ nPos, ( ::dbfLineas )->( FieldPos( "dFecCad" ) ) ] := ::dFechaCaducidad
         end

         ::aFinalLines[ nPos, ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ]   := ::aFinalLines[ nPos, ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ] + ::nUnidades

      else

         if Empty( aOriginalLine[ ( ::dbfLineas )->( FieldPos( "cLote" ) ) ] ) .AND. !Empty( ::cLote )
            aOriginalLine[ ( ::dbfLineas )->( FieldPos( "cLote" ) ) ]   := ::cLote
         end

         if Empty( dTos( aOriginalLine[ ( ::dbfLineas )->( FieldPos( "dFecCad" ) ) ] ) ) .AND. !Empty( dTos( ::dFechaCaducidad ) )
            aOriginalLine[ ( ::dbfLineas )->( FieldPos( "dFecCad" ) ) ]   := ::dFechaCaducidad
         end

         aOriginalLine[ ( ::dbfLineas )->( FieldPos( "nCanEnt" ) ) ]    := 1
         aOriginalLine[ ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ]   := ::nUnidades
         aOriginalLine[ ( ::dbfLineas )->( FieldPos( "lPreparado" ) ) ] := .T.

         aadd( ::aFinalLines, aOriginalLine )

      end

   end

   aAdd( ::aUuidQR, ::uuidEtiqueta )

   ::oBrwOriginalLines:MakeTotals()
   ::oBrwOriginalLines:Refresh()
   ::oBrwFinalLines:MakeTotals()
   ::oBrwFinalLines:Refresh()

Return ( Self )



static FUNCTION TPrepareDocument_DelOriginalLine( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local nResult

   nResult        := ::aOriginalLines[ ::nPos, ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ] - ::nUnidades

   if nResult == 0
      hb_ADel( ::aOriginalLines, ::nPos, .T. )
      ::oBrwOriginalLines:Refresh()
   else
      ::aOriginalLines[ ::nPos, ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ]   := ::aOriginalLines[ ::nPos, ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ] - ::nUnidades
   end

   ::oBrwOriginalLines:MakeTotals()
   ::oBrwOriginalLines:Refresh()
   ::oBrwFinalLines:MakeTotals()
   ::oBrwFinalLines:Refresh()

Return ( Self )



static FUNCTION TPrepareDocument_nPosScanOriginalLines( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::nPos      :=  aScan( ::aOriginalLines, { | aLine |  aLine[ ( ::dbfLineas )->( FieldPos( "cRef" ) ) ] == Padr( ::cCodigoArticulo, 18 ) } )

Return ( Self )



static FUNCTION TPrepareDocument_nPosScanFinalLines( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument


   local nPos        :=  aScan( ::aFinalLines, { | aLine |  aLine[ ( ::dbfLineas )->( FieldPos( "cRef" ) ) ] == Padr( ::cCodigoArticulo, 18 )   .AND. upper( Padr( aLine[ ( ::dbfLineas )->( FieldPos( "cLote" ) ) ], 14 ) ) == upper( Padr( ::cLote, 14 ) ) } )

Return ( nPos )



static FUNCTION TPrepareDocument_setLinesToDocument( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument





   while ( ::dbfLineas )->( dbSeek( ::cIdDocumento ) )

      if dbLock( ::dbfLineas )
         ( ::dbfLineas )->( dbDelete() )
         ( ::dbfLineas )->( dbUnLock() )
      end

   end





   if Len( ::aOriginalLines ) <> 0
      aEval( ::aOriginalLines, {|aTmp| WinGather( aTmp, , ::dbfLineas, , 1 ) } )
   end





   if Len( ::aFinalLines ) <> 0
      aEval( ::aFinalLines, {|aTmp| WinGather( aTmp, , ::dbfLineas, , 1 ) } )
   end





   if Len( ::aKitLines ) <> 0
      aEval( ::aKitLines, {|aTmp| WinGather( aTmp, , ::dbfLineas, , 1 ) } )
   end

Return ( nil )



static FUNCTION TPrepareDocument_setPreparated( lAbaranar ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local nPrepare       := 0

   If( lAbaranar == nil, lAbaranar := .F., ) ;

   do case
      case len( ::aOriginalLines ) == 0 .AND. len( ::aFinalLines ) <> 0
         nPrepare := 4

      case len( ::aOriginalLines ) <> 0 .AND. len( ::aFinalLines ) <> 0

         if lAbaranar
            nPrepare := 3
         else
            nPrepare := 2
         end

      case len( ::aOriginalLines ) <> 0 .AND. len( ::aFinalLines ) == 0
         nPrepare := 1

   end

   if dbDialogLock( ::DbfCabecera )
      ( ::DbfCabecera )->nPrepare   := nPrepare
      ( ::DbfCabecera )->( dbUnLock() )
   end

Return ( nil )



static FUNCTION TPrepareDocument_printLabel( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local oDialog
   local oBmp

   ::cFormatoImpresion  := ConfiguracionesEmpresaModel():getValue( "formatoPreparado", Space( 20 ) )
   ::cImpresora         := ConfiguracionesEmpresaModel():getValue( "impresoraPreparado", Space( 20 ) )

   oDialog = TDialog():New(,,,, "Imprimiendo pedido", "PREPARARPRINT",, .F.,,,,,, .F.,,,,,, .F.,, "oDialog", nil, )





   oBmp := TBitmap():ReDefine( 990, "GC_BARCODE_SCANNER_48",, oDialog,,, .F., .F.,,, .F.,,, .T. )





   ::oNumBultos := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cNumBultos, ::cNumBultos:= u ) }, oDialog,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





   ::oNumEstuches := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::cNumEstuches, ::cNumEstuches:= u ) }, oDialog,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )





   ::oFechaSalida := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::cFechaSalida, ::cFechaSalida:= u ) }, oDialog,,,,,,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   ::oFormatoImpresion := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cFormatoImpresion, ::cFormatoImpresion:= u ) }, oDialog,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 131 )

      ::oFormatoImpresion:bHelp := {|| BrwDocumento( ::oFormatoImpresion, ::oFormatoImpresion:oHelpText, "PC" ) }
      ::oFormatoImpresion:bValid := {|| cDocumento( ::oFormatoImpresion, ::oFormatoImpresion:oHelpText ) }




   ::oImpresora := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::cImpresora, ::cImpresora:= u ) }, oDialog,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )

   TBtnBmp():ReDefine( 141, "gc_printer2_check_16",,,,,{|| PrinterPreferences( ::oImpresora ) }, oDialog, .F., , .F.,  )





   TButton():ReDefine( 510, {||( oDialog:End( 1 ) )}, oDialog,,, .F.,,,, .T. )





   TButton():ReDefine( 550, {||( oDialog:End() )}, oDialog,,, .F.,,,, .T. )

      oDialog:bStart    := {|| ::oFormatoImpresion:lValid() }

   oDialog:Activate( oDialog:bLClicked, oDialog:bMoved, oDialog:bPainted, .T.,,,, oDialog:bRClicked,,, )

   if oDialog:nResult == 1

      ::saveBultos()

      ::Print()

      ConfiguracionesEmpresaModel():setValue( "formatoPreparado", ::cFormatoImpresion )
      ConfiguracionesEmpresaModel():setValue( "impresoraPreparado", ::cImpresora )

   end

   oBmp:End()

Return ( nil )



static FUNCTION TPrepareDocument_saveBultos( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   if dbDialogLock( ::DbfCabecera )
      ( ::DbfCabecera )->nBultos   := ::cNumBultos
      ( ::DbfCabecera )->cRetMat   := AllTrim( Str( ::cNumEstuches ) )
      ( ::DbfCabecera )->dFecEnt   := ::cFechaSalida
      ( ::DbfCabecera )->( dbUnLock() )
   end

Return ( nil )



static FUNCTION TPrepareDocument_print( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   GenPedCli( 1, "Imprimiendo pedido de cliente", ::cFormatoImpresion, ::cImpresora, ::cNumBultos )

Return ( nil )



static FUNCTION TPrepareDocument_Info( nView, oWndBrw ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::New( nView )

   ::lPrepareInfo( oWndBrw )

   ::addStockInfo()
   ::addProducir()
   ::addStockReal()

   ::DialogInfo()

Return self



static FUNCTION TPrepareDocument_DialogInfo( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   ::oDlg = TDialog():New(,,,, "Informe de preparación", "PREPARARINFODOC",, .F.,,,,,, .F.,,,,,, .F.,, "::oDlg", nil, )





   ::oBmp := TBitmap():ReDefine( 990, "GC_BARCODE_SCANNER_48",, ::oDlg,,, .F., .F.,,, .F.,,, .T. )

   ::oBrwOriginalLines                        := IXBrowse():New( ::oDlg )

   ::oBrwOriginalLines:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
   ::oBrwOriginalLines:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

   ::oBrwOriginalLines:SetArray( ::aInfoLines, , , .F. )

   ::oBrwOriginalLines:nMarqueeStyle          := 5
   ::oBrwOriginalLines:lRecordSelector        := .F.
   ::oBrwOriginalLines:lHScroll               := .F.

   ::oBrwOriginalLines:CreateFromResource( 130 )

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Código"
      :bStrData         := {|| if( len( ::aInfoLines ) == 0, "", hGet( ::aInfoLines[ ::oBrwOriginalLines:nArrayAt ], "Codigo" ) ) }
      :nWidth           := 100
   end

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Detalle"
      :bStrData         := {|| if( len( ::aInfoLines ) == 0, "", hGet( ::aInfoLines[ ::oBrwOriginalLines:nArrayAt ], "Nombre" ) ) }
      :nWidth           := 300
   end

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Unidades"
      :bStrData         := {|| if( len( ::aInfoLines ) == 0, "", Trans( hGet( ::aInfoLines[ ::oBrwOriginalLines:nArrayAt ], "Unidades" ), MasUnd() ) ) }
      :nWidth           := 70
      :nDataStrAlign    := 1
      :nHeadStrAlign    := 1
   end

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Stock"
      :bStrData         := {|| if( len( ::aInfoLines ) == 0, "", Trans( hGet( ::aInfoLines[ ::oBrwOriginalLines:nArrayAt ], "Stock" ), MasUnd() ) ) }
      :nWidth           := 70
      :nDataStrAlign    := 1
      :nHeadStrAlign    := 1
   end

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "Stock real"
      :bStrData         := {|| if( len( ::aInfoLines ) == 0, "", Trans( hGet( ::aInfoLines[ ::oBrwOriginalLines:nArrayAt ], "Stockreal" ), MasUnd() ) ) }
      :nWidth           := 70
      :nDataStrAlign    := 1
      :nHeadStrAlign    := 1
   end

   with object ( ::oBrwOriginalLines:AddCol() )
      :cHeader          := "A producir"
      :bStrData         := {|| if( len( ::aInfoLines ) == 0, "", Trans( hGet( ::aInfoLines[ ::oBrwOriginalLines:nArrayAt ], "Producir" ), MasUnd() ) ) }
      :nWidth           := 70
      :nDataStrAlign    := 1
      :nHeadStrAlign    := 1
   end





   TButton():ReDefine( 550, {||( ::End() )}, ::oDlg,,, .F.,,,, .T. )

   ::oDlg:Activate( ::oDlg:bLClicked, ::oDlg:bMoved, ::oDlg:bPainted, .T.,,,, ::oDlg:bRClicked,,, )

Return self



static FUNCTION TPrepareDocument_lPrepareInfo( oWndBrw ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local aResult
   local nRecAct
   local nRecAnt        := ( ::DbfCabecera )->( Recno() )

   ::aInfoLines         := {}
   ::aMateriasPrimas    := {}

   for each nRecAct in ( oWndBrw:oBrw:aSelected )

      ( ::DbfCabecera )->( dbGoTo( nRecAct ) )

      aResult           := PedidosClientesLineasModel():getLinesFromDocument( ( ::DbfCabecera )->cSerPed, ( ::DbfCabecera )->nNumPed, ( ::DbfCabecera )->cSufPed )

      aEval( aResult, {|a| ::aAddInfoLines( a ) } )

   next

   ( ::DbfCabecera )->( dbGoTo( nRecAnt ) )

Return self



static FUNCTION TPrepareDocument_aAddInfoLines( aField ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local nPos  := 0

   if Len( ::aInfoLines ) == 0






      aAdd( ::aInfoLines, {   "Codigo"          => aField[ ( ::dbfLineas )->( FieldPos( "cRef" ) ) ], "Nombre"          => aField[ ( ::dbfLineas )->( FieldPos( "cDetalle" ) ) ], "Unidades"        => aField[ ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ], "Stock"           => 0, "Stockreal"       => 0, "Producir"        => 0 } )

   else

      nPos     := aScan( ::aInfoLines, {|h| hGet( h, "Codigo" ) == aField[ ( ::dbfLineas )->( FieldPos( "cRef" ) ) ] } )

      if nPos == 0






         aAdd( ::aInfoLines, {   "Codigo"       => aField[ ( ::dbfLineas )->( FieldPos( "cRef" ) ) ], "Nombre"       => aField[ ( ::dbfLineas )->( FieldPos( "cDetalle" ) ) ], "Unidades"     => aField[ ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ], "Stock"        => 0, "Stockreal"    => 0, "Producir"     => 0 } )
      else

         hSet( ::aInfoLines[ nPos ], "Unidades", ( hGet( ::aInfoLines[ nPos ], "Unidades" ) + aField[ ( ::dbfLineas )->( FieldPos( "nUniCaja" ) ) ] ) )

      end

   end

Return self



static FUNCTION TPrepareDocument_addStockInfo( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   if len( ::aInfoLines() ) == 0
      Return self
   end

   aEval( ::aInfoLines, {|h| hSet( h, "Stock", StocksModel():nGlobalStockArticulo( hGet( h, "Codigo" ) ) ) } )

Return self



static FUNCTION TPrepareDocument_addProducir( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local hLine
   local nProducir      := 0
   local nStock         := 0

   for each hLine in ::aInfoLines

      nStock            := hGet( hLine, "Stock" )

      if nStock < 0
         nProducir      := hGet( hLine, "Unidades" ) + ( nStock * - 1 )
      else

         if nStock < hGet( hLine, "Unidades" )
            nProducir   := hGet( hLine, "Unidades" ) - nStock
         end

      end

      hSet( hLine, "Producir", nProducir )

   next

Return self



static FUNCTION TPrepareDocument_addStockReal( ) ; local Self AS CLASS TPrepareDocument := QSelf() AS CLASS TPrepareDocument

   local hLine

   for each hLine in ::aInfoLines
      hSet( hLine, "Stockreal", ( hGet( hLine, "Stock" ) - hGet( hLine, "Unidades" ) ) )
   next

Return self







_HB_CLASS TPrepareOrder ; function TPrepareOrder ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TPrepareOrder", iif( .T., { @TPrepareDocument() }, { @HBObject() } ), @TPrepareOrder() ) ) ;

   _HB_MEMBER New( nView); oClass:AddMethod( "New", @TPrepareOrder_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER loadUnprepareLinesFromDocument(); oClass:AddMethod( "loadUnprepareLinesFromDocument", @TPrepareOrder_loadUnprepareLinesFromDocument(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER loadPrepareLinesFromDocument(); oClass:AddMethod( "loadPrepareLinesFromDocument", @TPrepareOrder_loadPrepareLinesFromDocument(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER loadKitLinesFromDocument(); oClass:AddMethod( "loadKitLinesFromDocument", @TPrepareOrder_loadKitLinesFromDocument(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TPrepareOrder ;



static FUNCTION TPrepareOrder_New( nView ) ; local Self AS CLASS TPrepareOrder := QSelf() AS CLASS TPrepareOrder

   ::cTituloVentana           := "pedido de cliente"

   ::cTextoNumeroDocumento    := "Documento : " + ( D():PedidosClientes( nView ) )->cSerPed + "/" + Alltrim( str( ( D():PedidosClientes( nView ) )->nNumPed ) ) + "/" + ( D():PedidosClientes( nView ) )->cSufPed
   ::cTextoClienteDocumento   := "Cliente : " + AllTrim( ( D():PedidosClientes( nView ) )->cCodCli ) + " - " + AllTrim( ( D():PedidosClientes( nView ) )->cNomCli )

   ::cNumBultos               := ( D():PedidosClientes( nView ) )->nBultos
   ::cNumEstuches             := Val( ( D():PedidosClientes( nView ) )->cRetMat )
   ::cFechaSalida             := ( D():PedidosClientes( nView ) )->dFecEnt

   ::cSerieDocumento          := ( D():PedidosClientes( nView ) )->cSerPed
   ::nNumeroDocumento         := ( D():PedidosClientes( nView ) )->nNumPed
   ::cSufijoDocumento         := ( D():PedidosClientes( nView ) )->cSufPed

   ::cIdDocumento             := ( D():PedidosClientes( nView ) )->cSerPed + str( ( D():PedidosClientes( nView ) )->nNumPed ) + ( D():PedidosClientes( nView ) )->cSufPed

   ::DbfCabecera              := ( D():PedidosClientes( nView ) )
   ::dbfLineas                := ( D():PedidosClientesLineas( nView ) )

   ::nView                    := nView

   ::Super:New()

Return( Self )



static FUNCTION TPrepareOrder_loadUnprepareLinesFromDocument( ) ; local Self AS CLASS TPrepareOrder := QSelf() AS CLASS TPrepareOrder

Return( PedidosClientesLineasModel():getLinesFromDocument( ::cSerieDocumento, ::nNumeroDocumento, ::cSufijoDocumento ) )



static FUNCTION TPrepareOrder_loadPrepareLinesFromDocument( ) ; local Self AS CLASS TPrepareOrder := QSelf() AS CLASS TPrepareOrder

Return( PedidosClientesLineasModel():getLinesFromDocument( ::cSerieDocumento, ::nNumeroDocumento, ::cSufijoDocumento, .T. ) )



static FUNCTION TPrepareOrder_loadKitLinesFromDocument( ) ; local Self AS CLASS TPrepareOrder := QSelf() AS CLASS TPrepareOrder

Return( PedidosClientesLineasModel():getLinesKitsFromDocument( ::cSerieDocumento, ::nNumeroDocumento, ::cSufijoDocumento, .T. ) )
