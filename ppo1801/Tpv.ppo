#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 223 ".\.\Prg\Tpv.prg"
memvar cDbfTik
memvar cDbfTil
memvar cDbfTip
memvar cDbfCli
memvar cPouTik
memvar cPorTik
memvar cUndTik
memvar nDouTik
memvar nDorTik
memvar nTotTik
memvar nTotPrm
memvar nTotIvm
memvar aIvaTik
memvar aBrtTik
memvar aBasTik
memvar aImpTik
memvar aIvmTik
memvar nTotBrt
memvar nTotNet
memvar nTotIva
memvar nTotAlb
memvar nTotFac
memvar nTotPax
memvar cCtaCli

memvar nTotDtoEsp
memvar nTotDpp

memvar cDbfAlbCliT
memvar cDbfAlbCliL
memvar cDbfFacCliT
memvar cDbfFacCliL

memvar nTotCos
memvar nTotRnt
memvar nTotPctRnt

memvar aTotIva

static oWndBrw

static nView

static oFr

static nLevel
static oWndBig
static dbfClient
static dbfCodebar
static dbfCajT
static dbfCajL
static dbfTmpP
static dbfTmpV
static dbfTmpA
static dbfTmpE
static dbfTmpC
static dbfTmpN
static dbfOferta
static dbfTblPro
static dbfFacCliT
static dbfFacCliL
static dbfFacCliS
static dbfFacCliP
static dbfAntCliT
static dbfAlbCliT
static dbfAlbCliL
static dbfAlbCliS
static dbfAlbCliP
static dbfObrasT
static dbfAgent
static dbfTarPreL
static dbfTarPreS
static dbfRuta
static dbfAlm
static dbfDoc

static nRieCli
static oRieCli

static dbfCajPorta
static dbfAgeCom
static dbfEmp
static dbfArtDiv
static dbfTemporada
static oRestaurante

static dbfPedCliT
static dbfPedCliL
static dbfPedCliP

static dbfPreCliT
static dbfPreCliL

static dbfTImp

static oVisor
static oInvitacion

static cNewFilP
static cNewFilV
static cNewFilA
static cNewFilE
static cNewFilC
static cNewFilS
static cNewFilN
static oBmpVis
static nOldPvp
static lApartado

static oBandera

static oStock
static oAuditoria
static TComercio

static oCaptura
static oFideliza
static oComercio
static oUbicacion
static cUbicacion          := ""

static oMetMsg
static nMetMsg
static oFntTot
static oFntEur
static oFntBrw
static oFntNum
static cFilBmp
static aDim
static oBtnIni
static oBtnFam
static oSayFam
static oBtnArt
static oBtnNum
static oSayArt
static oBtnTik
static oBtnAlb
static oBtnFac
static oBtnApt
static oBtnVal
static oBtnDev
static oBtnAssVal
static oBtnAssDev
static oBtnOld
static oGrupoSerie
static oBtnUpSerie
static oBtnDownSerie
static oBtnAdd
static oBtnEdt
static oBtnDel
static oDlgDet
static oBtnTipoVta

static oCopTik
static lCopTik             := .T.
static nCopTik             := 1
static lRegalo             := .F.

static lMaximized          := .F.

static aArticulosWeb       := {}

static oTotEsp
static oTotDpp

static oGetRnt
static oSayGetRnt

static oOfficeBar

static aGetTxt
static oGetTxt

static oBrwDet

static oBtnFree
static oSayFree

static oBtnUsuario
static oSayUsuario
static oBtnTarifa
static oBtnEntregar
static oBtnRenombrar
static oBtnPedidos
static oBtnCliente
static oBtnDireccion
static oBtnTelefono

static oTotDiv

static nTotOld

static nSaveMode
static lSave

static oTimerBtn
static oTimer

static cCapCaj
static oNewImp
static oMenu
static nCambioTik          := 0
static nTotalTik           := 0
static cCodArtAnt          := ""
static cCodFamAnt          := ""
static aRecFam             := {}
static lNowAppendLine      := .F.
static aRecArt             := {}
static cOldCodCli          := ""
static cOldCodArt          := ""
static cOldPrpArt          := ""
static oTComandas
static aImpComanda         := {}
static oTipArt
static oFabricante

static cNuevoAlbaran       := ""

static lExternal           := .T.
static nNumBtnFam          := 7
static nNumBtnArt          := 19
static aTipDoc             := { "Tiket", "Albarán", "Factura", "Devolución", "Apartado", "Vale", "Pda", "Cheque regalo" }
static bEditT              := { |aTmp, aGet, cTikT, oBrw, cTot, nTot, nMode, hDocument    | EdtRec( aTmp, aGet, cTikT, oBrw, cTot, nTot, nMode, hDocument ) }
static bEditL              := { |aTmp, aGet, dbfTikL, oBrw, bWhen, bValid, nMode, cNumTik | EdtDet( aTmp, aGet, dbfTikL, oBrw, bWhen, bValid, nMode, cNumTik ) }
static bEditP              := { |aTmp, aGet, dbfTikP, oBrw, bWhen, bValid, nMode, aTmpTik | EdtCob( aTmp, aGet, dbfTikP, oBrw, bWhen, bValid, nMode, aTmpTik ) }
static bEditE              := { |aTmp, aGet, dbfTmpE, oBrw, bWhen, bValid, nMode, aTmpTik | EdtEnt( aTmp, aGet, dbfTmpE, oBrw, bWhen, bValid, nMode, aTmpTik ) }

static oUndMedicion

static bEdtPdaL            := { |aTmp, aGet, dbfTikL, oBrw, bWhen, bValid, nMode | EdtPdaL( aTmp, aGet, dbfTikL, oBrw, bWhen, bValid, nMode ) }
static nMesa
static nArticulo
static oSayVta
static oSayFPago
static oNumCambio
static cSayVta             :="Sala venta"
static oNumEnt
static cNumEnt             := "0"
static lFilterFav          := .F.
static oSayTik
static nEntCli
static nNumTik
static nZona
static nCurSe
static oCbxSalon
static cZona
static cAlmCtr
static dbfConfig
static nCambioCli



static dbfTikL
static dbfTikP
static dbfTikM
static dbfTikS
static dbfIva
static dbfDiv
static dbfFamilia
static dbfArticulo
static dbfTmpL
static dbfTmpS
static dbfKit
static dbfCount
static dbfImp
static dbfComentariosT
static dbfComentariosL
static dbfAlbPrvT
static dbfAlbPrvL
static dbfAlbPrvS
static dbfFacPrvT
static dbfFacPrvL
static dbfFacPrvS
static dbfRctPrvT
static dbfRctPrvL
static dbfRctPrvS
static dbfFacRecT
static dbfFacRecL
static dbfFacRecS

static cNewFilL

static lOpenFiles          := .F.

static cPouDiv
static cPorDiv
static nDouDiv
static nDorDiv
static cPicEur
static cPicUnd

static oTxtTot
static oNumTot
static oTotPdaFam
static oTxtCom
static oTotCom
static oEurTot

static oDlgTpv

static dbfFPago

static aButtonsPago
static aButtonsMoney

static lStopEntCont        := .F.
static lStopEntContLine    := .F.

static lShowBrwLin         := .F.
static lShowBrwFam         := .F.

static lSaveNewTik         := .F.
static lTwoLin             := .F.

static nScreenHorzRes
static nScreenVertRes





static hTextoUbicacion     := {  2 => {|| Rtrim( ( D():tikets( nView ) )->cPntVenta ) }, 0 => {|| "General: "  + Rtrim( ( D():tikets( nView ) )->cAliasTik ) }, 3 => {|| "Para recoger: " + Rtrim( ( D():tikets( nView ) )->cAliasTik ) }, 1 => {|| "Para llevar: " + Rtrim( ( D():tikets( nView ) )->cNomTik ) }, 4 => {|| "Encargo: " + Rtrim( ( D():tikets( nView ) )->cNomTik ) } }

static oDetCamposExtra

static aAlbaranes







STATIC FUNCTION OpenFiles( cPatEmp, lExt, lTactil )

   local oError
   local oBlock
   local cVisor
   local cCajon
   local cFiltro
   local cBalanza
   local cImpresora

   if lOpenFiles
      MsgStop( "Imposible abrir ficheros de tickets de clientes" )
      Return ( .F. )
   end

   If( cPatEmp == nil, cPatEmp := cPatEmp(), ) ;
   If( lExt == nil, lExt := .F., ) ;
   If( lTactil == nil, lTactil := .F., ) ;

   lExternal            := lExt

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      DisableAcceso()

      lOpenFiles        := .T.



      if !lExistTable( cPatEmp + "TikeT.Dbf" )  .OR. !lExistTable( cPatEmp + "TikeL.Dbf" )  .OR. !lExistTable( cPatEmp + "TikeP.Dbf" )
         mkTpv()
      end



      runEventScript( "TPV\beforeOpenFiles" )



      nView             := D():CreateView()

      D():Atipicas( nView )

      D():Get( "LogPorta", nView )

      D():ArticuloLenguaje( nView )

      D():PropiedadesLineas( nView )

      D():Tikets( nView, cOpenStatement() )

      D():SatClientes( nView )

      D():SatClientesLineas( nView )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "TikeL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "TIKEP.DBF" ), ( cCheckArea( "TIKEP", @dbfTikP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "TIKEP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "TIKEM.DBF" ), ( cCheckArea( "TIKEM", @dbfTikM ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "TIKEM.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "TIKES.DBF" ), ( cCheckArea( "TIKES", @dbfTikS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "TIKES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "ALBCLIT.DBF" ), ( cCheckArea( "ALBCLIT", @dbfAlbCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "ALBCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "ALBCLIS.DBF" ), ( cCheckArea( "ALBCLIS", @dbfAlbClis ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "ALBCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIP.DBF" ), ( cCheckArea( "ALBCLIP", @dbfAlbCliP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "FACCLIT.DBF" ), ( cCheckArea( "FACCLIT", @dbfFacCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "FACCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "FACCLIL.DBF" ), ( cCheckArea( "FACCLIL", @dbfFacCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "FACCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "FACCLIS.DBF" ), ( cCheckArea( "FACCLIS", @dbfFacCliS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "FACCLIS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "FACCLIP.DBF" ), ( cCheckArea( "FACCLIP", @dbfFacCliP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "FACCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "CLIENT.DBF" ), ( cCheckArea( "CLIENT", @dbfClient ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "CLIENT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "Cajas.Dbf" ), ( cCheckArea( "CAJAS", @dbfCajT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "Cajas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "CajL.Dbf" ), ( cCheckArea( "CAJL", @dbfCajL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "CajL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ArtCodebar.Dbf" ), ( cCheckArea( "CODEBAR", @dbfCodebar ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ArtCodebar.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTKIT.DBF" ), ( cCheckArea( "ARTTIK", @dbfKit ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTKIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "OFERTA.DBF" ), ( cCheckArea( "OFERTA", @dbfOferta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "OFERTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FPAGO.DBF" ), ( cCheckArea( "FPAGO", @dbfFPago ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FPago.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TBLPRO.DBF" ), ( cCheckArea( "TBLPRO", @dbfTblPro ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TBLPRO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ObrasT.Dbf" ), ( cCheckArea( "OBRAST", @dbfObrasT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ObrasT.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGENTES.DBF" ), ( cCheckArea( "AGENTES", @dbfAgent ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGENTES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RUTA.DBF" ), ( cCheckArea( "RUTA", @dbfRuta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RUTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALMACEN.DBF" ), ( cCheckArea( "ALMACEN", @dbfAlm ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALMACEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTDIV.DBF" ), ( cCheckArea( "ARTDIV", @dbfArtDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTDIV.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TARPREL.DBF" ), ( cCheckArea( "TARPREL", @dbfTarPreL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TARPREL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TARPRES.DBF" ), ( cCheckArea( "TARPRES", @dbfTarPreS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TARPRES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "RDOCUMEN.DBF" ), ( cCheckArea( "RDOCUMEN", @dbfDoc ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "RDOCUMEN.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CTIPO" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp + "NCOUNT.DBF" ), ( cCheckArea( "NCOUNT", @dbfCount ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp + "NCOUNT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "CAJPORTA.DBF" ), ( cCheckArea( "CAJPORTA", @dbfCajPorta ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "CAJPORTA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AGECOM.DBF" ), ( cCheckArea( "AGECOM", @dbfAgeCom ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AGECOM.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatDat() + "EMPRESA.DBF" ), ( cCheckArea( "EMPRESA", @dbfEmp ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatDat() + "EMPRESA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIL.DBF" ), ( cCheckArea( "PEDCLIL", @dbfPedCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PEDCLIP.DBF" ), ( cCheckArea( "PEDCLIP", @dbfPedCliP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PEDCLIP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      if !TDataCenter():OpenPreCliT( @dbfPreCliT )
         lOpenFiles     := .F.
      end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "PRECLIL.DBF" ), ( cCheckArea( "PRECLIL", @dbfPreCliL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "PRECLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECT.DBF" ), ( cCheckArea( "FACRECT", @dbfFacRecT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECL.DBF" ), ( cCheckArea( "FACRECL", @dbfFacRecL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACRECS.DBF" ), ( cCheckArea( "FACRECS", @dbfFacRecS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACRECS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVT.DBF" ), ( cCheckArea( "ALBPROVT", @dbfAlbPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBPROVL.DBF" ), ( cCheckArea( "ALBPROVL", @dbfAlbPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBPROVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AlbPrvS.DBF" ), ( cCheckArea( "AlbPrvS", @dbfAlbPrvS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "AlbPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVT.DBF" ), ( cCheckArea( "FACPRVT", @dbfFacPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVL.DBF" ), ( cCheckArea( "FACPRVL", @dbfFacPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FACPRVS.DBF" ), ( cCheckArea( "FACPRVS", @dbfFacPrvS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "FACPRVS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvT.DBF" ), ( cCheckArea( "RctPrvT", @dbfRctPrvT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvL.DBF" ), ( cCheckArea( "RctPrvL", @dbfRctPrvL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "RctPrvS.DBF" ), ( cCheckArea( "RctPrvS", @dbfRctPrvS ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "RctPrvS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "COMENTARIOST.DBF" ), ( cCheckArea( "COMENTT", @dbfComentariosT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "COMENTARIOST.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "COMENTARIOSL.DBF" ), ( cCheckArea( "COMENTL", @dbfComentariosL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "COMENTARIOSL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ordSetFocus( "CCODDES" )

      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "Temporadas.Dbf" ), ( cCheckArea( "Temporada", @dbfTemporada ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "Temporadas.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

      if !TDataCenter():OpenPedCliT( @dbfPedCliT )
         lOpenFiles        := .F.
      end

      oCaptura             := TCaptura():New( cPatDat() )
      oCaptura:OpenFiles()

      oTComandas           := TComandas():Create( cPatEmp() )
      oTComandas:OpenFiles()

      oBandera             := TBandera():New()

      oAuditoria           := TAuditoria():New()

      oStock               := TStock():Create( cPatEmp() )
      if !oStock:lOpenFiles()
         lOpenFiles        := .F.
      end

      oNewImp              := TNewImp():New( cPatEmp )
      if !oNewImp:OpenFiles()
         lOpenFiles        := .F.
      end

      cVisor               := cVisorEnCaja( Application():CodigoCaja(), dbfCajT )
      if !empty( cVisor )
         oVisor            := TVisor():Create( cVisor )
         if !empty( oVisor )
            oVisor:Wellcome()
         end
      end

      oUndMedicion         := UniMedicion():Create( cPatEmp() )
      if !oUndMedicion:OpenFiles()
         lOpenFiles        := .F.
      end

      oInvitacion          := TInvitacion():Create( cPatEmp() )
      if !oInvitacion:OpenFiles()
         lOpenFiles        := .F.
      end

      oFideliza            := TFideliza():CreateInit( cPatEmp() )
      if !oFideliza:OpenFiles()
         lOpenFiles        := .F.
      end

      oTipArt              := TTipArt():Create( cPatEmp() )
      if !oTipArt:OpenFiles()
         lOpenFiles        := .F.
      end

      oFabricante          := TFabricantes():Create( cPatEmp() )
      if !oFabricante:OpenFiles()
         lOpenFiles        := .F.
      end

      oRestaurante         := TTpvRestaurante():New( cPatEmp() )
      if !oRestaurante:OpenFiles()
         lOpenFiles        := .F.
      end

      TComercio            := TComercio():New( nView, oStock )





      aButtonsPago         := aCreateButtons( dbfFPago )





      cPouDiv              := cPouDiv( cDivEmp(), dbfDiv )
      cPorDiv              := cPorDiv( cDivEmp(), dbfDiv )
      cPicEur              := cPorDiv( cDivChg(), dbfDiv )
      nDouDiv              := nDouDiv( cDivEmp(), dbfDiv )
      nDorDiv              := nRouDiv( cDivEmp(), dbfDiv )

      cPicUnd              := MasUnd()

      public nTotTik       := 0
      public nTotPrm       := 0
      public nTotPax       := 0
      public nTotDtoEsp    := 0
      public nTotDpp       := 0
      public nTotBrt       := 0
      public nTotNet       := 0
      public nTotIva       := 0
      public nTotIvm       := 0
      public aBrtTik       := { 0, 0, 0 }
      public aBasTik       := { 0, 0, 0 }
      public aImpTik       := { 0, 0, 0 }
      public aIvaTik       := { nil, nil, nil }
      public aIvmTik       := { 0, 0, 0 }
      public nTotCos       := 0
      public nTotRnt       := 0
      public nTotPctRnt    := 0

      nScreenHorzRes       := GetSysMetrics( 0 )
      nScreenVertRes       := GetSysMetrics( 1 )





      oDetCamposExtra      := TDetCamposExtra():New()
      oDetCamposExtra:OpenFiles()
      oDetCamposExtra:SetTipoDocumento( "TPV" )



      EnableAcceso()

   RECOVER USING oError

      lOpenFiles           := .F.

      EnableAcceso()

      msgStop( ErrorMessage( oError ), "Imposible abrir las bases de datos de terminal punto de venta" )

   end

   ErrorBlock( oBlock )

   if !lOpenFiles
      CloseFiles()
   end

RETURN ( lOpenFiles )



STATIC FUNCTION cOpenStatement()

   local cStatement     := ""



   cStatement           := runScript( "TPV\SQLOpen.prg" )

   if !empty( cStatement )
      Return ( cStatement )
   end













   if Empty( cStatement )
      cStatement        := "SELECT * FROM " + cPatEmp() + "TikeT"
   end

RETURN  ( cStatement )



STATIC FUNCTION CloseFiles()

   DisableAcceso()

   ( dbfTikL     )->( dbCloseArea() )
   ( dbfTikP     )->( dbCloseArea() )
   ( dbfTikM     )->( dbCloseArea() )
   ( dbfTikS     )->( dbCloseArea() )
   ( dbfClient   )->( dbCloseArea() )
   ( dbfCajT     )->( dbCloseArea() )
   ( dbfCajL     )->( dbCloseArea() )
   ( dbfFPago    )->( dbCloseArea() )
    ( dbfArticulo )->( dbCloseArea() )
   ( dbfCodebar  )->( dbCloseArea() )
   ( dbfKit      )->( dbCloseArea() )
   ( dbfCount    )->( dbCloseArea() )
   ( dbfIva      )->( dbCloseArea() )
   ( dbfOferta   )->( dbCloseArea() )
   ( dbfDiv      )->( dbCloseArea() )
   ( dbfTblPro   )->( dbCloseArea() )
   ( dbfFamilia  )->( dbCloseArea() )
   ( dbfTemporada)->( dbCloseArea() )

   ( dbfObrasT   )->( dbCloseArea() )
   ( dbfAgent    )->( dbCloseArea() )
   ( dbfTarPreL  )->( dbCloseArea() )
   ( dbfTarPreS  )->( dbCloseArea() )
   ( dbfRuta     )->( dbCloseArea() )
   ( dbfAlm      )->( dbCloseArea() )
   ( dbfArtDiv   )->( dbCloseArea() )
   ( dbfDoc      )->( dbCloseArea() )
   ( dbfCajPorta )->( dbCloseArea() )
   ( dbfAgeCom   )->( dbCloseArea() )
   ( dbfEmp      )->( dbCloseArea() )
   ( dbfAlbCliP  )->( dbCloseArea() )

   ( dbfPreCliT  )->( dbCloseArea() )
   ( dbfPreCliL  )->( dbCloseArea() )
   ( dbfPedCliT  )->( dbCloseArea() )
   ( dbfPedCliL  )->( dbCloseArea() )
   ( dbfPedCliP  )->( dbCloseArea() )
   ( dbfAlbCliT  )->( dbCloseArea() )
   ( dbfAlbCliL  )->( dbCloseArea() )
   ( dbfAlbCliS  )->( dbCloseArea() )

   ( dbfFacCliT  )->( dbCloseArea() )
   ( dbfFacCliL  )->( dbCloseArea() )
   ( dbfFacCliS  )->( dbCloseArea() )
   ( dbfFacCliP  )->( dbCloseArea() )

   ( dbfFacRecT  )->( dbCloseArea() )
   ( dbfFacRecL  )->( dbCloseArea() )
   ( dbfFacRecS  )->( dbCloseArea() )

   ( dbfAntCliT  )->( dbCloseArea() )

   ( dbfAlbPrvT  )->( dbCloseArea() )
   ( dbfAlbPrvL  )->( dbCloseArea() )
   ( dbfAlbPrvS  )->( dbCloseArea() )

   ( dbfFacPrvT  )->( dbCloseArea() )
   ( dbfFacPrvL  )->( dbCloseArea() )
   ( dbfFacPrvS  )->( dbCloseArea() )

   ( dbfRctPrvT  )->( dbCloseArea() )
   ( dbfRctPrvL  )->( dbCloseArea() )
   ( dbfRctPrvS  )->( dbCloseArea() )

   ( dbfComentariosT )->( dbCloseArea() )
   ( dbfComentariosL )->( dbCloseArea() )

   if !empty( oCaptura )
      oCaptura:End()
   end

   if !empty( oTComandas )
      oTComandas:End()
   end

   if !Empty( oAuditoria )
      oAuditoria:End()
   end

   if !empty( oStock )
      oStock:end()
   end

   if !empty( oNewImp )
      oNewImp:End()
   end

   if !empty( oVisor )
      oVisor:End()
   end

   if !empty( oUndMedicion )
      oUndMedicion:end()
   end

   if !empty( oInvitacion )
      oInvitacion:End()
   end

   if !empty( oFideliza )
      oFideliza:End()
   end

   if !empty( oTipArt )
      oTipArt:End()
   end

   if !empty( oFabricante )
      oFabricante:End()
   end

   if !empty( oDetCamposExtra )
      oDetCamposExtra:CloseFiles()
   end

   if !Empty( oRestaurante )
      oRestaurante:End()
   end

   TComercio:end()

   D():DeleteView( nView )

   dbfTikL           := nil
   dbfTikM           := nil
   dbfTikS           := nil
   dbfClient         := nil
   dbfCajT           := nil
   dbfCajL           := nil
   dbfFPago          := nil
   dbfArticulo       := nil
   dbfCodebar        := nil
   dbfKit            := nil
   dbfIva            := nil
   dbfCount          := nil
   dbfOferta         := nil
   dbfDiv            := nil
   oBandera          := nil
   dbfTarPreS        := nil
   dbfTarPreL        := nil
   dbfTblPro         := nil
   dbfFamilia        := nil
   dbfAlbCliT        := nil
   dbfAlbCliL        := nil
   dbfFacCliT        := nil
   dbfFacCliL        := nil
   dbfFacCliS        := nil
   dbfFacCliP        := nil
   dbfObrasT         := nil
   dbfAgent          := nil
   dbfRuta           := nil
   dbfAlm            := nil
   dbfArtDiv         := nil
   dbfDoc            := nil
   dbfAgeCom         := nil
   dbfEmp            := nil
   dbfAlbCliP        := nil

   dbfPreCliT        := nil
   dbfPreCliL        := nil
   dbfPedCliT        := nil
   dbfPedCliL        := nil
   dbfPedCliP        := nil
   dbfFacRecT        := nil
   dbfFacRecL        := nil

   dbfAlbPrvT        := nil
   dbfAlbPrvL        := nil
   dbfAlbPrvS        := nil
   dbfFacPrvT        := nil
   dbfFacPrvL        := nil
   dbfRctPrvT        := nil
   dbfRctPrvL        := nil

   oStock            := nil
   oAuditoria        := nil
   oCaptura          := nil
   oTComandas        := nil
   oNewImp           := nil
   oVisor            := nil
   oInvitacion       := nil
   oTipArt           := nil
   oFabricante       := nil

   oFideliza         := nil

   oWndBrw           := nil
   oWndBig           := nil

   oOfficeBar        := nil

   dbfComentariosT   := nil
   dbfComentariosL   := nil

   lOpenFiles        := .F.

   EnableAcceso()

   if lTactilMode() .OR. lTpvMode()
      PostQuitMessage()
   end

Return .T.



Function generateTicketFromDocument( hDocument )

Return ( frontTpv( nil, nil, nil, nil, .F., nil , hDocument ) )



FUNCTION FrontTpv( oMenuItem, oWnd, cCodCli, cCodArt, lEntCon, lExtTpv, hDocument )

   local oBtnEur
   local cTitle
   local oSnd
   local oRpl
   local oFlt
   local lEur           := .F.
   local oPrv
   local oImp
   local oPdf
   local oDel
   local oRotor
   local oScript

   If( oMenuItem == nil, oMenuItem := "terminal_punto_de_venta", ) ;
   If( oWnd == nil, oWnd := oWnd(), ) ;
   If( lEntCon == nil, lEntCon := lEntCon(), ) ;
   If( lExtTpv == nil, lExtTpv := .F., ) ;

   nLevel               := Auth():Level( oMenuItem )
   if nAnd( nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      return .F.
   end





   if oWnd <> nil
      SysRefresh(); oWnd:CloseAll(); SysRefresh()
   end

   if !OpenFiles()
      return .F.
   end

   DisableAcceso()





   cTitle      := "T.P.V. - Sesión: " + Alltrim( Trans( cCurSesion(), "######" ) ) + " - " + dtoc( date() )





   AddMnuNext( "T.P.V.", ProcName() )





















   oWndBrw := TShell():New( 0, 0, 22, 80, cTitle,, oWnd,,, .F.,,, ( D():Tikets( nView ) ),,,,, {"Número",    "Fecha", "Código", "Nombre", "Caja", "Cajero", "Dirección", "Sesión", "Almacén", "Delegación", "Referencia"}, {||( TpvAppRec( oWndBrw:oBrw, bEditT, D():Tikets( nView ), oWnd, cCodCli, cCodArt, hDocument ) )},,,, nil, nLevel, "gc_cash_register_user_16", ( 164 + ( 55 * 256 ) + ( 58 * 65536 ) ),, {||( WinZooRec( oWndBrw:oBrw, bEditT, D():Tikets( nView ) ) )}, .T. )




      oWndBrw:lAutoSeek    := .F.
      oWndBrw:lFechado     := .T.

      oWndBrw:SetYearComboBoxChange( {|| YearComboBoxChange() } )
      oWndBrw:oBrw:bClrStd      := {|| { 0, if( ( D():Tikets( nView ) )->lDelete, ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ), GetSysColor( 5 ) ) } }

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión cerrada"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Tikets( nView ) )->lCloTik }
         :nWidth           := 20
         :SetCheck( { "gc_lock2_12", "Nil16" } )
         :AddResource( "gc_lock2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Cobrado"
         :nHeadBmpNo       := 4
         :bStrData         := {|| "" }
         :bBmpData         := {|| nChkalizer( ( D():Tikets( nView ))->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik, D():Tikets( nView ), dbfTikL, dbfTikP, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, if( lEur, cDivChg(), cDivEmp() ) ) }
         :nWidth           := 20
         :AddResource( "gc_check_12" )
         :AddResource( "gc_shape_square_12" )
         :AddResource( "gc_delete_12" )
         :AddResource( "gc_money2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Contabilizado"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Tikets( nView ) )->lConTik }
         :nWidth           := 20
         :SetCheck( { "gc_folder2_12", "Nil16" } )
         :AddResource( "gc_folder2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Envio"
         :nHeadBmpNo       := 3
         :bStrData         := {|| "" }
         :bEditValue       := {|| ( D():Tikets( nView ) )->lSndDoc }
         :nWidth           := 20
         :SetCheck( { "gc_mail2_12", "Nil16" } )
         :AddResource( "gc_mail2_16" )
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Eliminado"
         :bEditValue       := {|| if( ( D():Tikets( nView ) )->lDelete, "Eliminado", "" ) }
         :nWidth           := 60
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Documento"
         :bEditValue       := {|| aTipTik() }
         :nWidth           := 60
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Número"
         :cSortOrder       := "cNumTik"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cSerTik + "/" + lTrim( ( D():Tikets( nView ) )->cNumTik ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Referencia"
         :cSortOrder       := "cRefTik"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cRefTik }
         :nWidth           := 100
         :lHide            := .T.
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "F.Pago"
         :bEditValue       := {|| AllTrim( ( D():Tikets( nView ) )->cFpgTik ) + "-" + AllTrim( RetFld( ( D():Tikets( nView ) )->cFpgTik, dbfFPago ) ) }
         :nWidth           := 100
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Delegación"
         :cSortOrder       := "cSufTik"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cSufTik }
         :nWidth           := 40
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Sesión"
         :cSortOrder       := "cTurTik"
         :bEditValue       := {|| Trans( ( D():Tikets( nView ) )->cTurTik, "######" ) }
         :nWidth           := 40
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := "dFecTik"
         :bEditValue       := {|| dtoc( ( D():Tikets( nView ) )->dFecTik ) }
         :nWidth           := 80
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Hora"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cHorTik }
         :nWidth           := 40
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Caja"
         :cSortOrder       := "cNcjTik"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cNcjTik }
         :nWidth           := 40
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Cajero"
         :cSortOrder       := "cCcjTik"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cCcjTik }
         :nWidth           := 40
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Código"
         :cSortOrder       := "cCliTik"
         :bEditValue       := {|| AllTrim( ( D():Tikets( nView ) )->cCliTik ) }
         :nWidth           := 70
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Nombre"
         :cSortOrder       := "cNomTik"
         :bEditValue       := {|| AllTrim( ( D():Tikets( nView ) )->cNomTik ) }
         :nWidth           := 180
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Almacén"
         :cSortOrder       := "cAlmTik"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cAlmTik }
         :nWidth           := 60
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Dirección"
         :cSortOrder       := "cCodObr"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cCodObr }
         :nWidth           := 40
         :bLClickHeader    := {| nMRow, nMCol, nFlags, oCol | oWndBrw:ClickOnHeader( oCol ) }
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Base"
         :bEditValue       := {|| ( D():Tikets( nView ) )->nTotNet }
         :cEditPicture     := cPorDiv( ( D():Tikets( nView ) )->cDivTik, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := cImp()
         :bEditValue       := {|| ( D():Tikets( nView ) )->nTotIva }
         :cEditPicture     := cPorDiv( ( D():Tikets( nView ) )->cDivTik, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| ( D():Tikets( nView ) )->nTotTik }
         :cEditPicture     := cPorDiv( ( D():Tikets( nView ) )->cDivTik, dbfDiv )
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Cobrado"
         :bEditValue       := {|| nCobalizer( ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik, D():Tikets( nView ), dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, if( lEur, cDivChg(), cDivEmp() ), .T. ) }
         :nWidth           := 80
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Vales"
         :bEditValue       := {|| nTotValTik( ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik, D():Tikets( nView ), dbfTikL, dbfDiv, if( lEur, cDivChg(), cDivEmp() ), .T. ) }
         :nWidth           := 80
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Anticipos"
         :bEditValue       := {|| nTotAntFacCli( ( D():Tikets( nView ) )->cNumDoc, dbfAntCliT, dbfIva, dbfDiv, if( lEur, cDivChg(), cDivEmp() ), .T. ) }
         :nWidth           := 80
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Diferencias"
         :bEditValue       := {|| nDifalizer( ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik, D():Tikets( nView ), dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfIva, dbfDiv, if( lEur, cDivChg(), cDivEmp() ), .T. ) }
         :nWidth           := 80
         :lHide            := .T.
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( if( lEur, cDivChg(), ( D():Tikets( nView ) )->cDivTik ), dbfDiv ) }
         :nWidth           := 30
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Documento"
         :bEditValue       := {|| ( D():Tikets( nView ) )->cNumDoc }
         :nWidth           := 120
         :lHide            := .T.
      end

      with object ( oWndBrw:AddXCol() )
         :cHeader          := "Identificador"
         :bEditValue       := {|| ( D():Tikets( nView ) )->uuid }
         :nWidth           := 250
         :lHide            := .T.
      end

   oWndBrw:CreateXFromCode()






    oWndBrw:NewAt( "BUS",,, {||( oWndBrw:SearchSetFocus() )}, "(B)uscar", "B",,,,, .F. )

   oWndBrw:AddSeaBar( "justSpace", 11 )







   oWndBrw:NewAt( "NEW",,, {||( oWndBrw:RecAdd() )}, "(A)ñadir", "A",,, 2,, .F. )













   oWndBrw:NewAt( "ZOOM",,, {||( oWndBrw:RecZoom() )}, "(Z)oom", "Z",,, 8,, .F. )

















if !lExtTpv







      oWndBrw:NewAt( "SCROLL_DELETE_",,, {||( LqdVale( oWndBrw ) )}, "Liquidar vale",,,, 16, oDel, .F. )

end







   oImp := oWndBrw:NewAt( "IMP",, "Imprimir tiket", {||( ImpTiket( 1, .F., .T. ) )}, "(I)mprimir", "I",,, 32,, .F. )


      lGenTikCli( oWndBrw:oBrw, oImp, 1 )
if lExtTpv





   oWndBrw:NewAt( "UP",,, {||( oWndBrw:oBrw:GoUp(), oWndBrw:oBrw:Select(0), oWndBrw:oBrw:Select(1), oWndBrw:oBrw:Refresh() )}, "S(u)bir", "U",,,,, .F. )





   oWndBrw:NewAt( "DOWN",,, {||( oWndBrw:oBrw:GoDown(), oWndBrw:oBrw:Select(0), oWndBrw:oBrw:Select(1), oWndBrw:oBrw:Refresh() )}, "(B)ajar", "B",,,,, .F. )

else






   oWndBrw:NewAt( "GC_PRINTER2_",,, {||( DlgPrnTicket( oWndBrw:oBrw ) )}, "Imp(r)imir series", "R",,, 32,, .F. )







   oPrv := oWndBrw:NewAt( "PREV1",, "Previsualizar tiket", {||( ImpTiket( 2 ) )}, "(P)revisualizar", "P",,, 32,, .F. )


      lGenTikCli( oWndBrw:oBrw, oPrv, 2 )






   oPdf := oWndBrw:NewAt( "DOCLOCK",, "Pdf", {||( ImpTiket( 3 ) )}, "Pd(f)", "F",,, 32,, .F. )













   oWndBrw:NewAt( "BMPCONTA",,, {||( DlgCntTicket( oWndBrw, oNewImp, nView ) )}, "Co(n)tabilizar", "N",,, 4,, .F. )

   if RolesModel():getRolCambiarEstado( Auth():rolUuid() )






      oWndBrw:NewAt( "CHGSTATE",,, {||ContTpv( D():Tikets( nView ), oWndBrw:oBrw )}, "Cambiar esta(d)o", "D",,, 4,, .F. )

   end







   oSnd := oWndBrw:NewAt( "LBL",,, {||lSnd( oWndBrw, D():Tikets( nView ) )}, "En(v)iar", "V",, {|This|This:Toggle()}, 4,, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():Tikets( nView ), "lSndDoc", .T., .T., .T. ) )}, "Todos",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():Tikets( nView ), "lSndDoc", .F., .T., .T. ) )}, "Ninguno",,,, 4, oSnd, .F. )







      oWndBrw:NewAt( "LBL",,, {||( lSelectAll( oWndBrw, D():Tikets( nView ), "lSndDoc", .T., .F., .T. ) )}, "Abajo",,,, 4, oSnd, .F. )






   oWndBrw:NewAt( "gc_money2_",,, {||( EdtCobTik( oWndBrw ) )}, "(C)obros", "C",,, 2,, .F. )






   oBtnEur := oWndBrw:NewAt( "gc_currency_euro_",,, {||( lEur := !lEur, oWndBrw:Refresh() )}, "M(o)neda", "O",,,,, .F. )
   if RolesModel():getRolCambiarCampos( Auth():rolUuid() )






      oRpl := oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, D():Tikets( nView ), aItmTik(), "12" ) )}, "Cambiar campos",,, {|This|This:Toggle()}, 4,, .F. )







         oWndBrw:NewAt( "BMPCHG",,, {||( ReplaceCreator( oWndBrw, dbfTikL, aColTik() ) )}, "Lineas",,,, 4, oRpl, .F. )

   end












   oScript := oWndBrw:NewAt( "gc_folder_document_",,, {||( oScript:Expand() )}, "Scripts",,,,,, .F. )
      ImportScript( oWndBrw, oScript, "TPV", nView )

   if Auth():isSuperAdmin()



   oWndBrw:NewAt( "gc_spy_",,, {||( InformeAuditoria( ( D():Tikets( nView ) )->uuid, "12" ) )}, "Auditoría",,,,,, .F. )
   end






   oRotor := oWndBrw:NewAt( "ROTOR",,, {||( oRotor:Expand() )}, "Rotor",,, {|This|This:Toggle()},,, .F. )






      oWndBrw:NewAt( "GC_DOCUMENT_WHITE_",,, {||( Tik2AlbFac( ( D():Tikets( nView ) )->cTipTik, ( D():Tikets( nView ) )->cNumDoc ) )}, "Visualizar documento",,,,, oRotor, .F. )






      oWndBrw:NewAt( "GC_USER_",,, {||( EdtCli( ( D():Tikets( nView ) )->cCliTik ) )}, "Modificar cliente",,,,, oRotor, .F. )






      oWndBrw:NewAt( "INFO",,, {||( InfCliente( ( D():Tikets( nView ) )->cCliTik ) )}, "Informe cliente",,,,, oRotor, .F. )






      oWndBrw:NewAt( "GC_CLIPBOARD_EMPTY_USER_",,, {||( EdtObras( ( D():Tikets( nView ) )->cCliTik, ( D():Tikets( nView ) )->cCodObr, dbfObrasT ) )}, "Modificar obras",,,,, oRotor, .F. )




   oWndBrw:NewAt( "END",,, {||( oWndBrw:End() )}, "(S)alir", "S",,,,, .F. )

   end

   oWndBrw:oActiveFilter:SetFields( aItmTik() )
   oWndBrw:oActiveFilter:SetFilterType( "12" )

   oWndBrw:Activate(, oWndBrw:bLClicked, oWndBrw:bRClicked, oWndBrw:bMoved, oWndBrw:bResized, oWndBrw:bPainted, oWndBrw:bKeyDown, oWndBrw:bInit,,,,,,,,, {|| ( CloseFiles() )},, oWndBrw:bLButtonUp )

   EnableAcceso()

   if !empty( cCodCli ) .OR. !empty( cCodArt ) .OR. !empty( hDocument ) .OR. lEntCon

      if !empty( oWndBrw )
         oWndBrw:RecAdd()
      end

      cCodCli     := nil
      cCodArt     := nil
      hDocument   := nil

   end

Return .T.



Static Function TpvAppRec( oWndBrw, bEditT, cTikT, oWnd, cCodCli, cCodArt, hDocument )

   while ( WinAppRec( oWndBrw, bEditT, cTikT, cCodCli, cCodArt, hDocument ) )

      if lStopEntCont

         Return ( .T. )

      end

   end



   oWndBrw:Select( 0 )
   oWndBrw:Select( 1 )

Return ( .T. )



Static Function ImpTiket( nDevice, lEntrega, lImpMenu, dbfImp, oDatos )

   local oPrnTik
   local nCopClient
   local nNumTik

   If( lEntrega == nil, lEntrega := .F., ) ;
   If( lImpMenu == nil, lImpMenu := .F., ) ;
   If( nDevice == nil, nDevice := 1, ) ;

   if empty( oDatos )
      oDatos            := TFormatosImpresion():Load( dbfCajT )
   end

   nCopClient           := Max( Retfld( ( D():Tikets( nView ) )->cCliTik, dbfClient, "CopiasF" ), 1 )






   if nDevice == 2 .OR. nDevice == 3

      nCopTik           := 1

   else

      if lCopTik

         nCopTik        := nCopiasTipoTicket( ( D():Tikets( nView ) )->cTipTik, lEntrega, dbfCajT )

         if lImpMenu .AND. nCopTik == 0
            nCopTik     := 1
         end

      end

   end






   if Empty( cNuevoAlbaran )

      do case
         case ( D():Tikets( nView ) )->cTipTik == "1"

            do case
               case ( lRegalo )

                  nGenTikCli( nDevice, "Imprimiendo tickets", oDatos:cFormatoRegalo, oDatos:cPrinterRegalo )

                  lRegalo  := .F.

               case ( lEntrega )

                  nGenTikCli( nDevice, "Imprimiendo tickets", oDatos:cFormatoEntrega, oDatos:cPrinterEntrega )

               otherwise

                  nGenTikCli( nDevice, "Imprimiendo tickets", oDatos:cFormatoTiket, oDatos:cPrinterTik )

            end

         case ( D():Tikets( nView ) )->cTipTik == "6"

            if ( D():Tikets( nView ) )->lFreTik

               nGenTikCli( nDevice, "Imprimiendo cheques regalo", oDatos:cFmtTikChk, oDatos:cPrinterTikChk )

            else

               nGenTikCli( nDevice, "Imprimiendo vales", oDatos:cFmtVal, oDatos:cPrinterTikChk )

            end

         case ( D():Tikets( nView ) )->cTipTik == "4"

            nGenTikCli( nDevice, "Imprimiendo devoluciones", oDatos:cFmtTikDev, oDatos:cPrinterDev )

         case ( D():Tikets( nView ) )->cTipTik == "7"

            if lEntrega
               nGenTikCli( nDevice, "Imprimiendo tickets", oDatos:cFmtEntCaj, oDatos:cPrinterEntCaj )
            else
               nGenTikCli( nDevice, "Imprimiendo tickets", oDatos:cFormatoTiket, oDatos:cPrinterTik )
            end

         case ( D():Tikets( nView ) )->cTipTik == "5"

            nGenTikCli( nDevice, "Imprimiendo apartados", oDatos:cFmtApt, oDatos:cPrinterApt )

      end

   end





   if !empty( dbfImp )

      nNumTik  := ( dbfImp )->cSerTik + ( dbfImp )->cNumTik + ( dbfImp )->cSufTik

      if dbSeekInOrd( nNumTik, "cComanda", dbfImp )

         if dbLock( dbfImp )
            ( dbfImp )->lImp        := .T.
            ( dbfImp )->dFTikImp    := GetSysDate()
            ( dbfImp )->cHTikImp    := Substr( Time(), 1, 5 )
            ( dbfImp )->( dbUnLock() )
         end

      end

   end

   if !Empty( cNuevoAlbaran )

      if lImpAlbaranesEnImpresora( ( D():Tikets( nView ) )->cNcjTik, dbfCajT )

         if nDevice == 2
            VisAlbCli( cNuevoAlbaran, .F., "Imprimiendo albaranes", oDatos:cFmtAlbCaj, oDatos:cPrinterAlbCaj )
         else
            PrnAlbCli( cNuevoAlbaran, .F., "Imprimiendo albaranes", oDatos:cFmtAlbCaj, oDatos:cPrinterAlbCaj )
         end

      else

         PrnAlbCli( cNuevoAlbaran, .F., "Imprimiendo albaranes", oDatos:cFmtAlb, oDatos:cPrinterAlb )

      end

   end

   if !empty( oWndBrw )
      oWndBrw:Refresh()
   end

Return nil



Static Function TpvEdtRec( oWndBrw, bEdit, cTikT, oWnd )

   pdaLockSemaphore( cTikT )

   WinEdtRec( oWndBrw, bEdit, cTikT, , , oWnd )

   pdaUnLockSemaphore( cTikT )

   oWndBrw:Select( 0 )
   oWndBrw:Select( 1 )

Return ( .T. )






FUNCTION TpvDelRec()

   local nOrdAlb
   local nRecAnt
   local nOrdAnt
   local cTipDoc        := ( D():Tikets( nView ) )->cTipTik
   local cNumDoc        := ( D():Tikets( nView ) )->cNumDoc
   local cNumTik        := ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik
   local nPos           := 0
   local aDelAlb        := {}

   if ( D():Tikets( nView ) )->lDelete
      Return ( nil )
   end

   CursorWait()



   TComercio:resetProductsToUpdateStocks()



   if !empty( ( D():Tikets( nView ) )->cAlbTik )

      if dbSeekInOrd( ( D():Tikets( nView ) )->cAlbTik, "nNumAlb", dbfAlbCliT )

         if dbLock( dbfAlbCliT )
            ( dbfAlbCliT )->lFacturado    := .F.
            ( dbfAlbCliT )->cNumTik       := Space(13)
            ( dbfAlbCliT )->( dbUnLock() )
         end

         if dbLock( dbfAlbCliT )
            ( dbfAlbCliT )->nFacturado    := 1
            ( dbfAlbCliT )->( dbUnLock() )
         end

      end

      nOrdAlb                             := ( dbfAlbCliL )->( ordsetfocus( "nNumAlb" ) )

      if ( dbfAlbCliL )->( dbSeek( ( D():Tikets( nView ) )->cAlbTik ) )

         while ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb == ( D():Tikets( nView ) )->cAlbTik .AND. !( dbfAlbCliL )->( Eof() )

            if dbLock( dbfAlbCliL )
               ( dbfAlbCliL )->lFacturado := .F.
               ( dbfAlbCliL )->nFacturado := 1
               ( dbfAlbCliL )->( dbUnLock() )
            end

            ( dbfAlbCliL )->( dbSkip() )

         end

      end

      ( dbfAlbCliL )->( ordsetfocus( nOrdAlb ) )

   end





   if !empty( ( D():Tikets( nView ) )->cPedTik )

      if dbSeekInOrd( ( D():Tikets( nView ) )->cPedTik, "nNumPed", dbfPedCliT )

         if dbLock( dbfPedCliT )
            ( dbfPedCliT )->nEstado    := 1
            ( dbfPedCliT )->cNumTik    := Space(13)
            ( dbfPedCliT )->( dbUnLock() )
         end

      end

      if dbSeekInOrd( ( D():Tikets( nView ) )->cPedTik, "nNumPed", dbfPedCliP )

         while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == ( D():Tikets( nView ) )->cPedTik .AND. !( dbfPedCliP )->( eof() )

            if dbLock( dbfPedCliP )
               ( dbfPedCliP )->lPasado := .F.
               ( dbfPedCliT )->( dbUnLock() )
            end

            ( dbfPedCliP )->( dbSkip() )

            sysrefresh()

         end

      end

   end





   if !empty( ( D():Tikets( nView ) )->cPreTik )

      if dbSeekInOrd( ( D():Tikets( nView ) )->cPreTik, "nNumPre", dbfPreCliT )

         if dbLock( dbfPreCliT )
            ( dbfPreCliT )->lEstado    := .F.
            ( dbfPreCliT )->cNumTik    := Space(13)
            ( dbfPreCliT )->( dbUnLock() )
         end

      end

   end





   if ( dbfTikL )->( dbSeek( cNumTik ) )

      while ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil == cNumTik .AND. !( dbfTikL )->( Eof() )

         TComercio:appendProductsToUpadateStocks( ( dbfTikL )->cCbaTil, nView )

         if !Empty( ( dbfTikL )->cNumAlb )

            if aScan( aDelAlb, ( dbfTikL )->cNumAlb ) == 0
               aAdd( aDelAlb, ( dbfTikL )->cNumAlb )
            end

         end



         ( dbfTikL )->( dbSkip() )

         sysrefresh()

      end

   end

   TicketsClientesLineasModel():updateDelete( ( D():Tikets( nView ) )->uuid )










   TicketsClientesPagosModel():updateDelete( ( D():Tikets( nView ) )->uuid )





   if Len( aDelAlb ) > 0

      aEval( aDelAlb, {|cAlbaran| AlbaranesClientesModel():UpdateFacturado( cAlbaran, 1 ), AlbaranesClientesLineasModel():UpdateAllFacturado( cAlbaran, .F. ) } )
   end





   nRecAnt                       := ( D():Tikets( nView ) )->( Recno() )
   nOrdAnt                       := ( D():Tikets( nView ) )->( ordsetfocus( "cDocVal" ) )

   if ( D():Tikets( nView ) )->( dbSeek( cNumTik ) )
      while ( D():Tikets( nView ) )->cValDoc == cNumTik .AND. !( D():Tikets( nView ) )->( eof() )
         if dbLock( D():Tikets( nView ) )
            ( D():Tikets( nView ) )->lLiqTik := .F.
            ( D():Tikets( nView ) )->lSndDoc := .T.
            ( D():Tikets( nView ) )->cTurVal := ""
            ( D():Tikets( nView ) )->cValDoc := ""
            ( D():Tikets( nView ) )->( dbUnLock() )
         end
         ( D():Tikets( nView ) )->( dbSkip() )
         sysrefresh()
      end
   end

   ( D():Tikets( nView ) )->( dbGoTo( nRecAnt ) )
   ( D():Tikets( nView ) )->( ordsetfocus( nOrdAnt ) )





   if !empty( cNumDoc )





      do case
      case cTipDoc == "2"

         while dbSeekInOrd( cNumDoc, "nNumAlb", dbfAlbCliT )
            dbDel( dbfAlbCliT )
         end

         while dbSeekInOrd( cNumDoc, "nNumAlb", dbfAlbCliL )
            TComercio:appendProductsToUpadateStocks( ( dbfAlbCliL )->cRef, ( dbfAlbCliL )->cCodPr1, ( dbfAlbCliL )->cValPr1, ( dbfAlbCliL )->cCodPr2, ( dbfAlbCliL )->cValPr2, nView )
            dbDel( dbfAlbCliL )
         end

         while dbSeekInOrd( cNumDoc, "nNumAlb", dbfAlbCliP )
            dbDel( dbfAlbCliP )
         end

         while dbSeekInOrd( cNumDoc, "nNumAlb", dbfAlbCliS )
            dbDel( dbfAlbCliS )
         end

      end

   end





   TicketsClientesModel():updateDelete( ( D():Tikets( nView ) )->uuid )



   TComercio:updateWebProductStocks()





   AuditoriaModel():addRegister( ( D():Tikets( nView ) )->uuid, "Simplificada eliminada", "12" )

   sysrefresh()

   CursorWE()

Return ( .T. )



STATIC FUNCTION EdtRec( aTmp, aGet, cTikT, oBrw, cCodCli, cCodArt, nMode, hDocument )

   local nOrd
   local oBmpDiv
   local cTitDoc
   local cResource         := "TPVFRONT_1024x768"
   local nScreenVertRes    := GetSysMetrics( 1 )

   aGetTxt                 := Array( 10 )
   oGetTxt                 := Array( 10 )

   if ( nMode == 2 ) .AND. ( ( aTmp[ 4 ] == "4" ) .OR. ( aTmp[ 4 ] == "6" ) )
      MsgStop( "No se pueden modificar vales, devoluciones o cheques regalos." )
      return .F.
   end

   if ( nMode == 1 .OR. nMode == 4 ) .AND. !lCurSesion()
      MsgStop( "No hay sesiones activas, imposible añadir documentos" )
      return .F.
   end

   if nMode == 1 .AND. !empty( cCodCli )
      aTmp[ 11 ]     := cCodCli
   end

   if nMode == 1

      if !uFieldEmpresa( "lGetFpg" )
         aTmp[ 21 ]  := cDefFpg()
      else
         aTmp[ 21 ]  := Space( 2 )
      end

      aTmp[ 72 ]        := win_uuidcreatestring()

   end





   if empty( aTmp[ 12 ] )
      aTmp[ 12 ]     := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end





   if nMode == 4
      cTitDoc              := "Ticket a factura"

      aTmp[ 72 ]        := win_uuidcreatestring()

   else

      cTitDoc              := LblTitle( nMode ) + aTipTik( aTmp ) + " a clientes"

   end





   if aTmp[ 4 ] <> "1" .AND. nMode == 4
      msgStop( "Solo se puede pasar a factura los tickets." )
      return .F.
   end

   if aTmp[ 45 ] .AND. nMode == 4
      MsgStop( "Este ticket ya ha sido convertido a factura." )
      return .F.
   end





   if !lCajaOpen( Application():CodigoCaja() ) .AND. !oUser():lMaster()
      msgStop( "Esta caja " + Application():CodigoCaja() + " esta cerrada." )
      Return .F.
   end





   cCapCaj                 := cCapturaCaja( Application():CodigoCaja(), dbfCajT )

   if empty( aTmp[ 63 ] )
      aTmp[ 63 ]     := RetFld( aTmp[ 11 ], dbfClient, "Telefono" )
   end

   nRieCli                 := oStock:nRiesgo( aTmp[ 11 ] )





   oFntEur                 := TFont():New( "Segoe UI", 0, 48, .F., .T. )





   nOrd                    := ( D():Tikets( nView ) )->( ordsetfocus( 1 ) )





   if BeginTrans( aTmp, aGet, nMode, .T. )
      Return .F.
   end

   nCopTik                 := nCopiasTicketsEnCaja( Application():CodigoCaja(), dbfCajT )
   lCopTik                 := .T.





   do case
      case nScreenVertRes == 600
         cResource         := "TPVFRONT"
         lMaximized        := .F.

      case nScreenVertRes == 768
         cResource         := "TPVFRONT_1024x768"
         lMaximized        := .F.

      case nScreenVertRes == 1024
         cResource         := "TPVFRONT_1280x1024"
         lMaximized        := .F.

   end

   oDlgTpv = TDialog():New(,,,, cTitDoc, cResource,, .F.,,,,,, .F.,,,,,, .F.,, "oDlgTpv", nil, )












        aGet[ 11 ] := TGetHlp():ReDefine( 190, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oDlgTpv,, "@!", {||    ( loaCli( aGet, aTmp, nMode, oGetTxt[ 9 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwClient( aGet[ 11 ], aGet[ 13 ] ), ::lValid() )}, nil, "LUPA",, )









     aGet[ 63 ] := TGetHlp():ReDefine( 106, { | u | If( PCount()==0, aTmp[ 63 ], aTmp[ 63 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 20 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 13 ] := TGetHlp():ReDefine( 191, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 20 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 19 ] := TGetHlp():ReDefine( 101, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 20 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )






      aGet[ 14 ] := TGetHlp():ReDefine( 102, { | u | If( PCount()==0, aTmp[ 14 ], aTmp[ 14 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 20 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,, {|Self|GoogleMaps( aTmp[ 14 ], Rtrim( aTmp[ 15 ] ) + Space( 1 ) + Rtrim( aTmp[ 16 ] ) )}, nil, "gc_earth_lupa_16",, )




      aGet[ 15 ] := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, aTmp[ 15 ], aTmp[ 15 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 20 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 16 ] := TGetHlp():ReDefine( 105, { | u | If( PCount()==0, aTmp[ 16 ], aTmp[ 16 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 20 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )




      aGet[ 18 ] := TGetHlp():ReDefine( 103, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 .AND. ( !aTmp[ 20 ] .OR. oUser():lAdministrador() ) )},, .F., .F.,,,,,, nil,,, )









      aGet[ 12 ] := TGetHlp():ReDefine( 192, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oDlgTpv,, "9", {||    ( aTmp[ 12 ] >= 1 .AND. aTmp[ 12 ] <= 6 )},,,,,, .F., {||     ( nMode <> 3 .AND. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) ) )},, .F., .T.,,, {||      1}, {||      6},, nil,,, )




      oRieCli := TGetHlp():ReDefine( 193, { | u | If( PCount()==0, nRieCli, nRieCli:= u ) }, oDlgTpv,, cPorDiv,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )











        aGet[35] := TGetHlp():ReDefine( 230, { | u | If( PCount()==0, aTmp[35], aTmp[35]:= u ) }, oDlgTpv,,, {||    ( cObras( aGet[ 35 ], oGetTxt[ 5 ], aTmp[ 11 ] ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( brwObras( aGet[ 35 ], oGetTxt[ 5 ], aTmp[ 11 ], dbfObrasT ) )}, nil, "LUPA",, )




      oGetTxt[ 5 ] := TGetHlp():ReDefine( 231, { | u | If( PCount()==0, aGetTxt[ 5 ], aGetTxt[ 5 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 32 ] := TGetHlp():ReDefine( 240, { | u | If( PCount()==0, aTmp[ 32 ], aTmp[ 32 ]:= u ) }, oDlgTpv,,, {||    ( cAgentes( aGet[ 32 ], dbfAgent, oGetTxt[ 6 ], aGet[ 36 ], dbfAgeCom ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ 32 ], oGetTxt[ 6 ] ) )}, nil, "LUPA",, )




      oGetTxt[ 6 ] := TGetHlp():ReDefine( 241, { | u | If( PCount()==0, aGetTxt[ 6  ], aGetTxt[ 6  ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )











        aGet[ 10 ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oDlgTpv,,, {||    ( cAlmacen( aGet[10], dbfAlm, oGetTxt[ 2 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwAlmacen( aGet[10], oGetTxt[ 2 ] ) )}, nil, "LUPA",, )




      oGetTxt[ 2 ] := TGetHlp():ReDefine( 171, { | u | If( PCount()==0, aGetTxt[ 2 ], aGetTxt[ 2 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )












      aGet[ 21 ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ 21 ], aTmp[ 21 ]:= u ) }, oDlgTpv,, "@!", {||    !empty( aTmp[ 21 ] ) .AND. cFpago( aGet[ 21 ], dbfFPago, oGetTxt[ 3 ] )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ 21 ], oGetTxt[ 3 ] ) )}, nil, "LUPA",, )




      oGetTxt[ 3 ] := TGetHlp():ReDefine( 181, { | u | If( PCount()==0, aGetTxt[ 3 ], aGetTxt[ 3 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )











        aGet[ 9 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oDlgTpv,,, {||    cCajas( aGet[ 9 ], dbfCajT, oGetTxt[ 1 ] )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 9 ], oGetTxt[ 1 ] ) )}, nil, "LUPA",, )




      oGetTxt[ 1 ] := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, aGetTxt[ 1 ], aGetTxt[ 1 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )











      aGet[34] := TGetHlp():ReDefine( 220, { | u | If( PCount()==0, aTmp[34], aTmp[34]:= u ) }, oDlgTpv,,, {||    ( cTarifa( aGet[34], oGetTxt[ 8 ] ) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwTarifa( aGet[34], oGetTxt[ 8 ] ) )}, nil, "LUPA",, )




      oGetTxt[ 8 ] := TGetHlp():ReDefine( 221, { | u | If( PCount()==0, aGetTxt[ 8 ], aGetTxt[ 8 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )






      aGet[ 36 ] := TGetHlp():ReDefine( 242, { | u | If( PCount()==0, aTmp[ 36 ], aTmp[ 36 ]:= u ) }, oDlgTpv,, "@E 99.99",,,,,,, .F., {||     ( !empty( aTmp[ 32 ] ) .AND. nMode <> 3 )},, .F., .T.,,,,,, nil,,, )











      aGet[ 33 ] := TGetHlp():ReDefine( 250, { | u | If( PCount()==0, aTmp[ 33 ], aTmp[ 33 ]:= u ) }, oDlgTpv,,, {||    ( cRuta( aGet[ 33 ], dbfRuta, oGetTxt[ 7 ]) )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwRuta( aGet[33 ], dbfRuta, oGetTxt[ 7 ] ) )}, nil, "LUPA",, )




      oGetTxt[ 7 ] := TGetHlp():ReDefine( 251, { | u | If( PCount()==0, aGetTxt[ 7 ], aGetTxt[ 7 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )












        aGet[ 24 ] := TGetHlp():ReDefine( 200, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oDlgTpv,, "@!", {||    ( cDivOut( aGet[ 24 ], oBmpDiv, aGet[ 25 ], @cPouDiv, nil, nil, nil, nil, nil, nil, dbfDiv, oBandera ) )},,,,,, .F., {||     ( nMode == 1 .AND. ( dbfTmpL )->( ordKeyCount() ) == 0 )}, {|nKey,nFlags,Self| ( lRecTotal( aTmp ) ) }, .F., .F.,,,,, {|Self|( BrwDiv( aGet[ 24 ], oBmpDiv, aGet[ 25 ], dbfDiv, oBandera ) )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 201, "BAN_EURO",, oDlgTpv,,, .F., .F.,,, .F.,,, .F. )




      oCopTik := TCheckBox():ReDefine( 260, { | u | If( PCount()==0, lCopTik, lCopTik:= u ) }, oDlgTpv,,,,,,, .F., {||     ( nMode <> 3 )}, .F. )











      TGetHlp():ReDefine( 261, { | u | If( PCount()==0, nCopTik, nCopTik:= u ) }, oDlgTpv,, "99", {||    ( nCopTik >= 0 .AND. nCopTik < 99 )}, "N/W*",,,,, .F., {||     ( !lCopTik )}, {|nKey,nFlags,Self| ( oCopTik:Click( .F. ):Refresh() ) }, .F., .T.,,, {||      0}, {||      99},, nil,,, )





      oBrwDet                 := IXBrowse():New( oDlgTpv )

      oBrwDet:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDet:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDet:bChange         := {|| DisImg( ( dbfTmpL )->cCbaTil ) }

      if ( nMode <> 3 )
         oBrwDet:bLDblClick   := {|| WinEdtRec( oBrwDet, bEditL, dbfTmpL, , , aTmp ), lRecTotal( aTmp ), aGet[ 11 ]:SetFocus() }
      end

      oBrwDet:cAlias          := dbfTmpL

      oBrwDet:nMarqueeStyle   := 6
      oBrwDet:cName           := "TPV.Detalle"

      oBrwDet:CreateFromResource( 210 )

      oCaptura:CreateColumns( cCapCaj, oBrwDet )






      oTxtTot := TSay():ReDefine( 410, {||   "Total"}, oDlgTpv,, "G+/N",, .F., oFntEur, .F., .F., )






      oNumTot := TSay():ReDefine( 420, {||   Trans( 0, cPorDiv )}, oDlgTpv,, "G+/N",, .F., oFntEur, .F., .F., )








      aGet[ 57 ] := TGetHlp():ReDefine( 710, { | u | If( PCount()==0, aTmp[ 57 ], aTmp[ 57 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







      aGet[ 58 ] := TGetHlp():ReDefine( 711, { | u | If( PCount()==0, aTmp[ 58 ], aTmp[ 58 ]:= u ) }, oDlgTpv,, "@ER 999.99%", {||    ( lRecTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      oTotEsp := TGetHlp():ReDefine( 712, { | u | If( PCount()==0, nTotDtoEsp, nTotDtoEsp:= u ) }, oDlgTpv,, "@ER 999.99 ",,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      aGet[ 59 ] := TGetHlp():ReDefine( 720, { | u | If( PCount()==0, aTmp[ 59 ], aTmp[ 59 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )







        aGet[ 60 ] := TGetHlp():ReDefine( 721, { | u | If( PCount()==0, aTmp[ 60 ], aTmp[ 60 ]:= u ) }, oDlgTpv,, "@ER 999.99%", {||    ( lRecTotal( aTmp ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )





      oTotDpp := TGetHlp():ReDefine( 722, { | u | If( PCount()==0, nTotDpp, nTotDpp:= u ) }, oDlgTpv,, "@ER 999.99 ",,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )









      oBmpVis := TBitmap():ReDefine( 600,, cFilBmp, oDlgTpv,,, .F., .T.,,, .F.,,, .F. )







      oSayGetRnt := TSay():ReDefine( 800,, oDlgTpv,,,, .F.,, .F., .F., )



      oGetRnt := TGetHlp():ReDefine( 408, { | u | If( PCount()==0, nTotRnt, nTotRnt:= u ) }, oDlgTpv,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




















      oMetMsg := TApoloMeter():ReDefine( 460, { | u | If( PCount()==0, nMetMsg, nMetMsg:= u ) },, oDlgTpv, .F.,,, .T.,,,, )

      oMetMsg:nClrText   := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
      oMetMsg:nClrBar    := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )
      oMetMsg:nClrBText  := ( 128 + ( 255 * 256 ) + ( 0 * 65536 ) )










      aGet[ 1 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 1 ], aTmp[ 1 ]:= u ) }, oDlgTpv,, "@!", {||    ( aTmp[ 1 ] >= "A" .AND. aTmp[ 1 ] <= "Z"  )},,,,,, .F., {||     ( nMode == 1 .OR. nMode == 4 )},, .F., .T., {||    ( UpSerie( aGet[ 1 ] ) )}, {||  ( DwSerie( aGet[ 1 ] ) )},,,, nil,,, )

         aGet[ 1 ]:bLostFocus := {|| aTmp[ 38 ] := cProCnt( aTmp[ 1 ] ) }





        aGet[ 2 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 2 ], aTmp[ 2 ]:= u ) }, oDlgTpv,,,, "N/W*",,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )





      aGet[ 3 ] := TGetHlp():ReDefine( 111, { | u | If( PCount()==0, aTmp[ 3 ], aTmp[ 3 ]:= u ) }, oDlgTpv,,,, "N/W*",,,,, .F., {||        .F.},, .F., .F.,,,,,, nil,,, )





        TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||         ( nMode <> 3 )},, .F., .T.,,,,,, nil,,, )








      aGet[ 71 ] := TGetHlp():ReDefine( 121, { | u | If( PCount()==0, aTmp[ 71 ], aTmp[ 71 ]:= u ) }, oDlgTpv,, "@R 99:99:99", {||    ( iif(   !validTime( aTmp[ 71 ] ), ( msgStop( "El formato de la hora no es correcto" ), .F. ), .T. ) )},,,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )



      aGet[ 74 ] := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, aTmp[ 74 ], aTmp[ 74 ]:= u ) }, oDlgTpv,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )





      aGet[ 22 ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oDlgTpv,, cPorDiv,,,,,,, .F., {||     (.F.)},, .F., .F.,,,,,, nil,,, )





      aGet[ 23 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 23 ], aTmp[ 23 ]:= u ) }, oDlgTpv,, cPorDiv,,,,,,, .F., {||     (.F.)},, .F., .F.,,,,,, nil,,, )





      aGet[ 8 ] := TGetHlp():ReDefine( 125, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oDlgTpv,,, {||    ( oGetTxt[ 10 ]:cText( UsuariosModel():getNombreWhereCodigo( aTmp[ 8 ] ) ), .T.  )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oGetTxt[ 10 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aGetTxt[ 10 ], aGetTxt[ 10 ]:= u ) }, oDlgTpv,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

   oDlgTpv:bStart       := {|| StartEdtRec( aTmp, aGet, nMode, oDlgTpv, oBrw, oBrwDet, hDocument, cCodArt ) }





   if nMode <> 3
      oDlgTpv:AddFastKey( 113, {|| AppDetRec( oBrwDet, bEditL, aTmp, cPorDiv, cPicEur ), aGet[ 11 ]:SetFocus() } )
      oDlgTpv:AddFastKey( 114, {|| WinEdtRec( oBrwDet, bEditL, dbfTmpL, , , aTmp ), lRecTotal( aTmp ), aGet[ 11 ]:SetFocus() } )
      oDlgTpv:AddFastKey( 115, {|| deleteLineTicket( aTmp, oBrwDet ) } )
      oDlgTpv:AddFastKey( 116, {|| if( ( ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "1" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) ) ), NewTiket( aGet, aTmp, nMode, "1", .F., oBrw, oBrwDet ), ) } )
      oDlgTpv:AddFastKey( 118, {|| if( ( ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "2" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) ) ), NewTiket( aGet, aTmp, nMode, "2", .F., oBrw, oBrwDet ), ) } )
      oDlgTpv:AddFastKey( 120, {|| if( ( ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "6" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) ) ), GuardaApartado( aGet, aTmp, @nMode, "5", .F., oBrw, oBrwDet, oDlgTpv ), ) } )

      oDlgTpv:AddFastKey( 121,{|| oDetCamposExtra:Play( aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ] ) } )

      oDlgTpv:AddFastKey( 65,    {|| if( GetKeyState( 17 ), CreateInfoArticulo(), ) } )
   end



   oDlgTpv:Activate( oDlgTpv:bLClicked, oDlgTpv:bMoved, oDlgTpv:bPainted, .T., {|Self|( ExitNoSave( nMode, dbfTmpL ) )},,, oDlgTpv:bRClicked,,, )





   cDelUsrTik()

   oFntEur:End()
   oBmpDiv:End()





   KillTrans()

   if Select( D():Tikets( nView ) ) <> 0
      ( D():Tikets( nView ) )->( ordsetfocus( nOrd ) )
   end

RETURN ( oDlgTpv:nResult == 1 )



Static Function deleteLineTicket( aTmp, oBrwDet )





   oAuditoria:AddTemporal( { "parent_uuid" => aTmp[ 72 ] , "description" => "Linea eliminada: " + AllTrim( Trans( ( dbfTmpL )->nUntTil, MasUnd() ) ) +  " unidades de " + AllTrim( ( dbfTmpL )->cCbaTil ) + " - " + AllTrim( ( dbfTmpL )->cNomTil ) +  " con precio:  " + AllTrim( Trans( ( dbfTmpL )->nPvpTil, cPorDiv ) ) , "tipodocumento" => "12" } )

   winDelRec( oBrwDet, dbfTmpL, nil, nil, .T. )

Return ( lRecTotal( aTmp ) )



Static Function StartEdtRec( aTmp, aGet, nMode, oDlgTpv, oBrw, oBrwDet, hDocument, cCodArt )

   local oBoton
   local oGrupo
   local oCarpeta

   if empty( oOfficeBar )

      oOfficeBar              := TDotNetBar():New( 0, 0, 2020, 115, oDlgTpv, 1 )

      oOfficeBar:lPaintAll    := .F.
      oOfficeBar:lDisenio     := .F.

      oOfficeBar:SetStyle( 1 )

      oDlgTpv:oTop      := oOfficeBar

      oCarpeta          := TCarpeta():New( oOfficeBar, "T.P.V." )

      oGrupo            := TDotNetGroup():New( oCarpeta, 186, "Lineas", .F. )
         oBtnAdd        := TDotNetButton():New( 60, oGrupo, "New32",                      "Añadir [F2]",          1, {|| AppDetRec( oBrwDet, bEditL, aTmp, cPorDiv, cPicEur ), aGet[ 11 ]:SetFocus() }, , , .F., .F., .F. )
         oBtnEdt        := TDotNetButton():New( 60, oGrupo, "gc_pencil__32",              "Modificar [F3]",       2, {|| WinEdtRec( oBrwDet, bEditL, dbfTmpL, , , aTmp ), lRecTotal( aTmp ), aGet[ 11 ]:SetFocus() }, , , .F., .F., .F. )
         oBtnDel        := TDotNetButton():New( 60, oGrupo, "Del32",                      "Eliminar [F4]",        3, {|| deleteLineTicket( aTmp, oBrwDet ) }, , {|| nMode <> 3 }, .F., .F., .F. )

      oGrupo            := TDotNetGroup():New( oCarpeta, 376, "Cobros", .F. )
         oBtnTik        := TDotNetButton():New( 60, oGrupo, "gc_money2_32",               "Cobrar [F5]",          1, {|| NewTiket( aGet, aTmp, nMode, "1", .F., oBrw, oBrwDet ) }, , {|| nMode <> 3 }, .F., .F., .F. )
         oBtnAlb        := TDotNetButton():New( 60, oGrupo, "gc_document_empty_32",       "Albarán [F7]",         2, {|| NewTiket( aGet, aTmp, nMode, "2", .F., oBrw, oBrwDet ) }, , {|| nMode <> 3 }, .F., .F., .F. )
         oBtnApt        := TDotNetButton():New( 60, oGrupo, "gc_cash_stop_32",            "Apartar [F9]",         3, {|| GuardaApartado( aGet, aTmp, @nMode, "5", .F., oBrw, oBrwDet, oDlgTpv ) }, , {|| nMode <> 3 }, .F., .F., .F. )
         oBtnVal        := TDotNetButton():New( 60, oGrupo, "gc_cash_money_32",           "Cheque regalo",        4, {|| NewTiket( aGet, aTmp, nMode, "8", .F., oBrw, oBrwDet ) }, , {|| nMode <> 3 }, .F., .F., .F. )
         oBtnDev        := TDotNetButton():New( 60, oGrupo, "gc_cash_delete_32",          "Devolución",           5, {|| NewTiket( aGet, aTmp, nMode, "4", .F., oBrw, oBrwDet ) }, , {|| nMode == 1 }, .F., .F., .F. )
         oBtnOld        := TDotNetButton():New( 60, oGrupo, "gc_cash_scroll_32",          "Vale",                 6, {|| NewTiket( aGet, aTmp, nMode, "6", .F., oBrw, oBrwDet ) }, , {|| nMode <> 3 }, .F., .F., .F. )

      oGrupo            := TDotNetGroup():New( oCarpeta, 126, "Tickets", .F. )
         oBtnAssDev     := TDotNetButton():New( 60, oGrupo, "gc_cash_delete_32",          "Asistente devolución", 1, {|| AsistenteDevolucionTiket( aTmp, aGet, nMode, .T. ) }, , {|| nMode == 1 }, .F., .F., .F. )
         oBtnAssVal     := TDotNetButton():New( 60, oGrupo, "gc_cash_scroll_32",          "Asistente vale",       2, {|| AsistenteDevolucionTiket( aTmp, aGet, nMode, .F. ) }, , {|| nMode <> 3 }, .F., .F., .F. )

      oGrupo            := TDotNetGroup():New( oCarpeta, 66, "Albaranes", .F. )
         oBtnAssDev     := TDotNetButton():New( 60, oGrupo, "gc_documents_empty_user_32", "Agrupar albaranes",    1, {|| AgruparAlbaranes( aTmp, aGet, oBrwDet ), oBrwDet:Refresh() }, , {|| nMode == 1 }, .F., .F., .F. )

      oGrupo            := TDotNetGroup():New( oCarpeta, 66, "Salida", .F. )
         oBoton         := TDotNetButton():New( 60, oGrupo, "End32",                      "Salida",               1, {|| oDlgTpv:End() }, , , .F., .F., .F. )

      oCarpeta          := TCarpeta():New( oOfficeBar, "Rotor" )

      oGrupo            := TDotNetGroup():New( oCarpeta, 306, "Cobros", .F. )
         oBoton         := TDotNetButton():New( 60, oGrupo, "gc_user_32",                    "Modificar cliente", 1, {|| if( !empty( aTmp[ 11 ] ), EdtCli( aTmp[ 11 ] ), MsgStop( "Código cliente vacío" ) ) }, , , .F., .F., .F. )
         oBoton         := TDotNetButton():New( 60, oGrupo, "gc_speech_balloon_answer2_32",  "Informe cliente",   2, {|| if( !empty( aTmp[ 11 ] ), InfCliente( aTmp[ 11 ] ), MsgStop( "Código cliente vacío" ) ) }, , , .F., .F., .F. )
         oBoton         := TDotNetButton():New( 60, oGrupo, "gc_worker2_32",                 "Modificar obras",   3, {|| if( !empty( aTmp[ 11 ] ), EdtObras( aTmp[ 11 ], aTmp[ 35 ], dbfObrasT ), MsgStop( "No hay obra asociada para el presupuesto" ) ) }, , , .F., .F., .F. )
         oBoton         := TDotNetButton():New( 60, oGrupo, "gc_object_cube_32",             "Modificar artículo",4, {|| EdtArticulo( ( dbfTmpL )->cCbaTil ) }, , , .F., .F., .F. )
         oBoton         := TDotNetButton():New( 60, oGrupo, "gc_speech_balloon_answer2_32",  "Informe artículo",  5, {|| InfArticulo( ( dbfTmpL )->cCbaTil ) }, , , .F., .F., .F. )

      if Auth():isSuperAdmin()

         oGrupo               := TDotNetGroup():New( oCarpeta, 66,  "Auditoría", .F. )
            oBoton            := TDotNetButton():New( 60, oGrupo,    "gc_spy_32",            "Informe",           1, {|| InformeAuditoria( aTmp[ 72 ], "12" ) }, , , .F., .F., .F. )

      end

      SetButtonEdtRec( nMode, aTmp )

   end

   if nMode == 4

      stateButtons( .F. )
   end

   if isHash( hDocument )

      do case
         case HGetKeyAt( hDocument, 1 ) == "Presupuesto"

            cPreCli( aTmp, aGet, HGetValueAt( hDocument, 1 ), oBrwDet )

         case HGetKeyAt( hDocument, 1 ) == "Pedido"

            cPedCli( aTmp, aGet, HGetValueAt( hDocument, 1 ), oBrwDet )

         case HGetKeyAt( hDocument, 1 ) == "Albaran"

            cAlbCli( aTmp, aGet, HGetValueAt( hDocument, 1 ), oBrwDet )

         case HGetKeyAt( hDocument, 1 ) == "SAT"

            cSatCli( aTmp, aGet, HGetValueAt( hDocument, 1 ), oBrwDet )

      end

      stateButtons( .F., { oBtnTik } )

   end





   if !empty( oBmpVis )
      oBmpVis:Hide()
   end

   if RolesModel():getRolNoMostrarRentabilidad( Auth():rolUuid() )

      if oGetRnt <> nil
         oGetRnt:Hide()
      end

      if oSayGetRnt <> nil
         oSayGetRnt:Hide()
      end

   end





   nTotCos                    := 0
   nTotRnt                    := 0
   nTotPctRnt                 := 0





   if !empty( oDlgTpv )

      if isTrue( lMaximized )
         oDlgTpv:Maximize()
      end

   end

   if nMode == 1

      aGet[ 11 ]:lValid()

      if !lGetUsuario( aGet[ 8 ] )
         oDlgTpv:End()
         Return ( nil )
      end

      if !lGetAgente( aGet[ 32 ], dbfAgent )
         oDlgTpv:End()
         Return ( nil )
      end

      if !empty( cCodArt ) .OR. lEntCon()
         AppDetRec( oBrwDet, bEditL, aTmp, cPorDiv, cPicEur, cCodArt )
      end

   end

   lRecTotal( aTmp )

Return ( nil )



Static Function StateButtons( lState, aExcept )

   If( lState == nil, lState := .F., ) ;
   If( aExcept == nil, aExcept := {}, ) ;

   oBtnAdd:lEnabled     := lState
   oBtnEdt:lEnabled     := lState
   oBtnDel:lEnabled     := lState

   oBtnTik:lEnabled     := lState
   oBtnAlb:lEnabled     := lState

   oBtnApt:lEnabled     := lState
   oBtnVal:lEnabled     := lState
   oBtnDev:lEnabled     := lState
   oBtnOld:lEnabled     := lState

   oBtnAssVal:lEnabled  := lState
   oBtnAssDev:lEnabled  := lState

   aEval( aExcept, {| oBtn | oBtn:lEnabled := !lState } )

   oBtnAdd:Refresh()
   oBtnEdt:Refresh()
   oBtnDel:Refresh()

   oBtnTik:Refresh()
   oBtnAlb:Refresh()

   oBtnApt:Refresh()
   oBtnVal:Refresh()
   oBtnDev:Refresh()
   oBtnOld:Refresh()

   oBtnAssVal:Refresh()
   oBtnAssDev:Refresh()

return ( nil )



Static Function SetButtonEdtRec( nMode, aTmp )

   oBtnAdd:lEnabled     := ( nMode <> 3 )
   oBtnEdt:lEnabled     := ( nMode <> 3 )
   oBtnDel:lEnabled     := ( nMode <> 3 )

   oBtnTik:lEnabled     := ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "1" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) )
   oBtnAlb:lEnabled     := ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "2" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) )

   oBtnApt:lEnabled     := ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "6" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) )
   oBtnVal:lEnabled     := ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "6" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) )
   oBtnDev:lEnabled     := ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "6" .OR. aTmp[ 4 ] == "4" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) )
   oBtnOld:lEnabled     := ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "6" .OR. aTmp[ 4 ] == "6" .OR. aTmp[ 4 ] == "6" ) .AND. ( nMode == 2 ) )

   oBtnAssVal:lEnabled  := ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "6" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) )
   oBtnAssDev:lEnabled  := ( nMode == 1 ) .OR. ( ( aTmp[ 4 ] == "6" .OR. aTmp[ 4 ] == "4" .OR. aTmp[ 4 ] == "5" ) .AND. ( nMode == 2 ) )

Return ( nil )



Static Function RecuperarTicket()

   if !( D():Tikets( nView ) )->lDelete
      MsgStop( "Solo puede recuperar un documento eliminado", "Documento no eliminado" )
      Return ( nil )
   end

   if apoloMsgNoYes( "¿Desea recuperar el registro en curso?", "Confirme recuperación" )

      TicketsClientesPagosModel():Recuperar( ( D():Tikets( nView ) )->uuid )
      TicketsClientesLineasModel():Recuperar( ( D():Tikets( nView ) )->uuid )
      TicketsClientesModel():Recuperar( ( D():Tikets( nView ) )->uuid )





      AuditoriaModel():addRegister( ( D():Tikets( nView ) )->uuid, "Simplificada recuperada", "12" )
   end

Return ( nil )



Static Function cSatCli( aTmp, aGet, cNumSat, oBrwLin )

   local nRecCab
   local nRecLin
   local nOrdCab
   local nOrdLin

   nRecCab           := ( D():SatClientes( nView ) )->( recno() )
   nOrdCab           := ( D():SatClientes( nView ) )->( ordsetfocus( "nNumSat" ) )
   nRecLin           := ( D():SatClientesLineas( nView ) )->( recno() )
   nOrdLin           := ( D():SatClientesLineas( nView ) )->( ordsetfocus( "nNumSat" ) )



   if ( D():SatClientes( nView ) )->( dbSeek( cNumSat ) )

      cOldCodCli     := ( D():SatClientes( nView ) )->cCodCli

      aGet[ 8 ]:cText( ( D():SatClientes( nView ) )->cCodUsr )
      aGet[ 9 ]:cText( ( D():SatClientes( nView ) )->cCodCaj )
      aGet[ 10 ]:cText( ( D():SatClientes( nView ) )->cCodAlm )
      aGet[ 12 ]:cText( ( D():SatClientes( nView ) )->nTarifa )
      aGet[ 11 ]:cText( ( D():SatClientes( nView ) )->cCodCli )
      aGet[ 13 ]:cText( ( D():SatClientes( nView ) )->cNomCli )
      aGet[ 14 ]:cText( ( D():SatClientes( nView ) )->cDirCli )
      aGet[ 63 ]:cText( ( D():SatClientes( nView ) )->cTlfCli )
      aGet[ 15 ]:cText( ( D():SatClientes( nView ) )->cPobCli )
      aGet[ 16 ]:cText( ( D():SatClientes( nView ) )->cPrvCli )
      aGet[ 18 ]:cText( ( D():SatClientes( nView ) )->cPosCli )
      aGet[ 19 ]:cText( ( D():SatClientes( nView ) )->cDniCli )
      aGet[ 21 ]:cText( ( D():SatClientes( nView ) )->cCodPgo )
      aGet[ 24 ]:cText( ( D():SatClientes( nView ) )->cDivSat )
      aGet[ 32 ]:cText( ( D():SatClientes( nView ) )->cCodAge )
      aGet[ 36 ]:cText( ( D():SatClientes( nView ) )->nPctComAge )
      aGet[ 33 ]:cText( ( D():SatClientes( nView ) )->cCodRut )
      aGet[ 34 ]:cText( ( D():SatClientes( nView ) )->cCodTar )
      aGet[ 35 ]:cText( ( D():SatClientes( nView ) )->cCodObr )

      aTmp[ 20 ]  := .T.
      aTmp[ 56 ]  := cNumSat

      aTmp[ 46 ]  := ( D():SatClientes( nView ) )->cCodDlg
      aTmp[ 47 ]  := ( D():SatClientes( nView ) )->cCodGrp
      aTmp[ 25 ]  := ( D():SatClientes( nView ) )->nVdvSat

      if ( D():SatClientesLineas( nView ) )->( dbSeek( cNumSat ) )

         while ( D():SatClientesLineasId( nView ) == cNumSat ) .AND. !( D():SatClientesLineas( nView ) )->( eof() )

            ( dbfTmpL )->( dbAppend() )

            ( dbfTmpL )->cCodUsr    := ( D():SatClientes( nView ) )->cCodUsr

            ( dbfTmpL )->cCbaTil    := ( D():SatClientesLineas( nView ) )->cRef
            ( dbfTmpL )->cNomTil    := ( D():SatClientesLineas( nView ) )->cDetalle
            ( dbfTmpL )->nUntTil    := ( D():SatClientesLineas( nView ) )->nUniCaja
            ( dbfTmpL )->nUndKit    := ( D():SatClientesLineas( nView ) )->nUndKit
            ( dbfTmpL )->nIvaTil    := ( D():SatClientesLineas( nView ) )->nIva
            ( dbfTmpL )->cFamTil    := ( D():SatClientesLineas( nView ) )->cCodFam
            ( dbfTmpL )->nDtoLin    := ( D():SatClientesLineas( nView ) )->nDto
            ( dbfTmpL )->cCodPr1    := ( D():SatClientesLineas( nView ) )->cCodPr1
            ( dbfTmpL )->cCodPr2    := ( D():SatClientesLineas( nView ) )->cCodPr2
            ( dbfTmpL )->cValPr1    := ( D():SatClientesLineas( nView ) )->cValPr1
            ( dbfTmpL )->cValPr2    := ( D():SatClientesLineas( nView ) )->cValPr2
            ( dbfTmpL )->nFacCnv    := ( D():SatClientesLineas( nView ) )->nFacCnv
            ( dbfTmpL )->nDtoDiv    := ( D():SatClientesLineas( nView ) )->nDtoDiv
            ( dbfTmpL )->nCtlStk    := ( D():SatClientesLineas( nView ) )->nCtlStk
            ( dbfTmpL )->cAlmLin    := ( D():SatClientesLineas( nView ) )->cAlmLin
            ( dbfTmpL )->nValImp    := ( D():SatClientesLineas( nView ) )->nValImp
            ( dbfTmpL )->cCodImp    := ( D():SatClientesLineas( nView ) )->cCodImp
            ( dbfTmpL )->nCosDiv    := ( D():SatClientesLineas( nView ) )->nCosDiv
            ( dbfTmpL )->lKitArt    := ( D():SatClientesLineas( nView ) )->lKitArt
            ( dbfTmpL )->lKitChl    := ( D():SatClientesLineas( nView ) )->lKitChl
            ( dbfTmpL )->lKitPrc    := ( D():SatClientesLineas( nView ) )->lKitPrc
            ( dbfTmpL )->lImpLin    := ( D():SatClientesLineas( nView ) )->lImpLin
            ( dbfTmpL )->lControl   := ( D():SatClientesLineas( nView ) )->lControl
            ( dbfTmpL )->mNumSer    := ( D():SatClientesLineas( nView ) )->mNumSer
            ( dbfTmpL )->cCodFam    := ( D():SatClientesLineas( nView ) )->cCodFam
            ( dbfTmpL )->cGrpFam    := ( D():SatClientesLineas( nView ) )->cGrpFam
            ( dbfTmpL )->nLote      := ( D():SatClientesLineas( nView ) )->nLote
            ( dbfTmpL )->cLote      := ( D():SatClientesLineas( nView ) )->cLote

            ( dbfTmpL )->nNumLin    := nLastNum( dbfTmpL )
            ( dbfTmpL )->nPosPrint  := nLastNum( dbfTmpL, "nPosPrint" )



            if ( D():SatClientes( nView ) )->lIvaInc
               ( dbfTmpL )->nPvpTil       := ( D():SatClientesLineas( nView ) )->nPreDiv
            else
               if  uFieldEmpresa( "lUseImp")
                  if uFieldEmpresa( "lIvaImpEsp" )
                     ( dbfTmpL )->nPvpTil := ( D():SatClientesLineas( nView ) )->nPreDiv + ( D():SatClientesLineas( nView ) )->nValImp + ( ( ( ( D():SatClientesLineas( nView ) )->nPreDiv + ( D():SatClientesLineas( nView ) )->nValImp ) * ( D():SatClientesLineas( nView ) )->nIva ) / 100 )
                  else
                     ( dbfTmpL )->nPvpTil := ( D():SatClientesLineas( nView ) )->nPreDiv + ( D():SatClientesLineas( nView ) )->nValImp + ( ( ( D():SatClientesLineas( nView ) )->nPreDiv * ( D():SatClientesLineas( nView ) )->nIva ) / 100 )
                  end
               else
                  ( dbfTmpL )->nPvpTil    := ( D():SatClientesLineas( nView ) )->nPreDiv + ( ( ( D():SatClientesLineas( nView ) )->nPreDiv * ( D():SatClientesLineas( nView ) )->nIva ) / 100 )
               end
            end



            ( dbfTmpL )->( dbUnLock() )

            ( D():SatClientesLineas( nView ) )->( dbSkip() )

         end

      end

   end



   lRecTotal( aTmp )

   ( dbfTmpL )->( dbgotop() )

   oBrwLin:Refresh()



   ( D():SatClientes( nView ) )->( ordsetfocus( nOrdCab ) )
   ( D():SatClientes( nView ) )->( dbgoto( nRecCab ) )
   ( D():SatClientesLineas( nView ) )->( ordsetfocus( nOrdLin ) )
   ( D():SatClientesLineas( nView ) )->( dbgoto( nRecLin ) )

   cNumSat            := ""
   lStopEntContLine   := .T.

Return .T.



Static Function cAlbCli( aTmp, aGet, cNumAlb, oBrwLin )

   local nRecCab
   local nRecLin
   local nOrdCab
   local nOrdLin

   nRecCab             := ( dbfAlbCliT )->( Recno() )
   nRecLin             := ( dbfAlbCliL )->( Recno() )
   nOrdCab             := ( dbfAlbCliT )->( ordsetfocus( "nNumAlb" ) )
   nOrdLin             := ( dbfAlbCliL )->( ordsetfocus( "nNumAlb" ) )





   if ( dbfAlbCliT )->( dbSeek( cNumAlb ) )

      cOldCodCli     := ( dbfAlbCliT )->cCodCli

      aGet[ 8 ]:cText( ( dbfAlbCliT )->cCodUsr )
      aGet[ 9 ]:cText( ( dbfAlbCliT )->cCodCaj )
      aGet[ 10 ]:cText( ( dbfAlbCliT )->cCodAlm )
      aGet[ 12 ]:cText( ( dbfAlbCliT )->nTarifa )
      aGet[ 11 ]:cText( ( dbfAlbCliT )->cCodCli )
      aGet[ 13 ]:cText( ( dbfAlbCliT )->cNomCli )
      aGet[ 14 ]:cText( ( dbfAlbCliT )->cDirCli )
      aGet[ 63 ]:cText( ( dbfAlbCliT )->cTlfCli )
      aGet[ 15 ]:cText( ( dbfAlbCliT )->cPobCli )
      aGet[ 16 ]:cText( ( dbfAlbCliT )->cPrvCli )
      aGet[ 18 ]:cText( ( dbfAlbCliT )->cPosCli )
      aGet[ 19 ]:cText( ( dbfAlbCliT )->cDniCli )
      aGet[ 21 ]:cText( ( dbfAlbCliT )->cCodPago )
      aGet[ 24 ]:cText( ( dbfAlbCliT )->cDivAlb )
      aGet[ 32 ]:cText( ( dbfAlbCliT )->cCodAge )
      aGet[ 36 ]:cText( ( dbfAlbCliT )->nPctComAge )
      aGet[ 33 ]:cText( ( dbfAlbCliT )->cCodRut )
      aGet[ 34 ]:cText( ( dbfAlbCliT )->cCodTar )
      aGet[ 35 ]:cText( ( dbfAlbCliT )->cCodObr )

      aTmp[ 20 ]  := .T.
      aTmp[ 53 ]  := cNumAlb

      aTmp[ 46 ]  := ( dbfAlbCliT )->cCodDlg
      aTmp[ 47 ]  := ( dbfAlbCliT )->cCodGrp
      aTmp[ 25 ]  := ( dbfAlbCliT )->nVdvAlb

      if ( dbfAlbCliL )->( dbSeek( cNumAlb ) )

         while ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb == cNumAlb .AND. !( dbfAlbCliL )->( Eof() )

            ( dbfTmpL )->( dbAppend() )

            ( dbfTmpL )->cCbaTil    := ( dbfAlbCliL )->cRef
            ( dbfTmpL )->cNomTil    := ( dbfAlbCliL )->cDetalle
            if ( dbfAlbCliT )->lIvaInc
               ( dbfTmpL )->nPvpTil := ( dbfAlbCliL )->nPreUnit
            else
               if  uFieldEmpresa( "lUseImp")
                  if uFieldEmpresa( "lIvaImpEsp" )
                     ( dbfTmpL )->nPvpTil := ( dbfAlbCliL )->nPreUnit + ( dbfAlbCliL )->nValImp + ( ( ( ( dbfAlbCliL )->nPreUnit + ( dbfAlbCliL )->nValImp ) * ( dbfAlbCliL )->nIva ) / 100 )
                  else
                     ( dbfTmpL )->nPvpTil := ( dbfAlbCliL )->nPreUnit + ( dbfAlbCliL )->nValImp + ( ( ( dbfAlbCliL )->nPreUnit * ( dbfAlbCliL )->nIva ) / 100 )
                  end
               else
                  ( dbfTmpL )->nPvpTil := ( dbfAlbCliL )->nPreUnit + ( ( ( dbfAlbCliL )->nPreUnit * ( dbfAlbCliL )->nIva ) / 100 )
               end
            end

            ( dbfTmpL )->nUntTil    := ( dbfAlbCliL )->nUniCaja
            ( dbfTmpL )->nUndKit    := ( dbfAlbCliL )->nUndKit
            ( dbfTmpL )->nIvaTil    := ( dbfAlbCliL )->nIva
            ( dbfTmpL )->cFamTil    := ( dbfAlbCliL )->cCodFam
            ( dbfTmpL )->nDtoLin    := ( dbfAlbCliL )->nDto
            ( dbfTmpL )->cCodPr1    := ( dbfAlbCliL )->cCodPr1
            ( dbfTmpL )->cCodPr2    := ( dbfAlbCliL )->cCodPr2
            ( dbfTmpL )->cValPr1    := ( dbfAlbCliL )->cValPr1
            ( dbfTmpL )->cValPr2    := ( dbfAlbCliL )->cValPr2
            ( dbfTmpL )->nFacCnv    := ( dbfAlbCliL )->nFacCnv
            ( dbfTmpL )->nDtoDiv    := ( dbfAlbCliL )->nDtoDiv
            ( dbfTmpL )->nCtlStk    := ( dbfAlbCliL )->nCtlStk
            ( dbfTmpL )->cAlmLin    := ( dbfAlbCliL )->cAlmLin
            ( dbfTmpL )->nValImp    := ( dbfAlbCliL )->nValImp
            ( dbfTmpL )->cCodImp    := ( dbfAlbCliL )->cCodImp
            ( dbfTmpL )->nCosDiv    := ( dbfAlbCliL )->nCosDiv
            ( dbfTmpL )->lKitArt    := ( dbfAlbCliL )->lKitArt
            ( dbfTmpL )->lKitChl    := ( dbfAlbCliL )->lKitChl
            ( dbfTmpL )->lKitPrc    := ( dbfAlbCliL )->lKitPrc
            ( dbfTmpL )->lImpLin    := ( dbfAlbCliL )->lImpLin
            ( dbfTmpL )->lControl   := ( dbfAlbCliL )->lControl
            ( dbfTmpL )->mNumSer    := ( dbfAlbCliL )->mNumSer
            ( dbfTmpL )->cCodFam    := ( dbfAlbCliL )->cCodFam
            ( dbfTmpL )->cGrpFam    := ( dbfAlbCliL )->cGrpFam
            ( dbfTmpL )->nLote      := ( dbfAlbCliL )->nLote
            ( dbfTmpL )->cLote      := ( dbfAlbCliL )->cLote
            ( dbfTmpL )->dFecCad    := ( dbfAlbCliL )->dFecCad
            ( dbfTmpL )->cCodUsr    := ( dbfAlbCliT )->cCodUsr
            ( dbfTmpL )->nNumLin    := nLastNum( dbfTmpL )
            ( dbfTmpL )->nPosPrint  := nLastNum( dbfTmpL, "nPosPrint" )

            ( dbfTmpL )->( dbUnLock() )

            ( dbfAlbCliL )->( dbSkip() )

         end

      end

   end





   lRecTotal( aTmp )

   ( dbfTmpL )->( dbGoTop() )

   oBrwLin:Refresh()





   ( dbfAlbCliT )->( ordsetfocus( nOrdCab ) )
   ( dbfAlbCliL )->( ordsetfocus( nOrdLin ) )
   ( dbfAlbCliT )->( dbGoTo( nRecCab ) )
   ( dbfAlbCliL )->( dbGoTo( nRecLin ) )

   cNumAlb            := ""
   lStopEntContLine   := .T.

Return .T.



Static Function cPedCli( aTmp, aGet, cNumPed, oBrwLin )

   local nRecCab
   local nRecLin
   local nOrdCab
   local nOrdLin

   nRecCab           := ( dbfPedCliT )->( Recno() )
   nRecLin           := ( dbfPedCliL )->( Recno() )
   nOrdCab           := ( dbfPedCliT )->( ordsetfocus( "NNUMPED" ) )
   nOrdLin           := ( dbfPedCliL )->( ordsetfocus( "NNUMPED" ) )





   if ( dbfPedCliT )->( dbSeek( cNumPed ) )

      cOldCodCli     := ( dbfPedCliT )->cCodCli

      aGet[ 8 ]:cText( ( dbfPedCliT )->cCodUsr )
      aGet[ 9 ]:cText( ( dbfPedCliT )->cCodCaj )
      aGet[ 10 ]:cText( ( dbfPedCliT )->cCodAlm )
      aGet[ 12 ]:cText( ( dbfPedCliT )->nTarifa )
      aGet[ 11 ]:cText( ( dbfPedCliT )->cCodCli )
      aGet[ 13 ]:cText( ( dbfPedCliT )->cNomCli )
      aGet[ 14 ]:cText( ( dbfPedCliT )->cDirCli )
      aGet[ 63 ]:cText( ( dbfPedCliT )->cTlfCli )
      aGet[ 15 ]:cText( ( dbfPedCliT )->cPobCli )
      aGet[ 16 ]:cText( ( dbfPedCliT )->cPrvCli )
      aGet[ 18 ]:cText( ( dbfPedCliT )->cPosCli )
      aGet[ 19 ]:cText( ( dbfPedCliT )->cDniCli )
      aGet[ 21 ]:cText( ( dbfPedCliT )->cCodPgo )
      aGet[ 32 ]:cText( ( dbfPedCliT )->cCodAge )
      aGet[ 36 ]:cText( ( dbfPedCliT )->nPctComAge )
      aGet[ 33 ]:cText( ( dbfPedCliT )->cCodRut )
      aGet[ 34 ]:cText( ( dbfPedCliT )->cCodTar )
      aGet[ 35 ]:cText( ( dbfPedCliT )->cCodObr )

      aTmp[ 20 ]  := .T.
      aTmp[ 54 ]  := cNumPed

      aTmp[ 46 ]  := ( dbfPedCliT )->cCodDlg
      aTmp[ 47 ]  := ( dbfPedCliT )->cCodGrp
      aTmp[ 24 ]  := ( dbfPedCliT )->cDivPed
      aTmp[ 25 ]  := ( dbfPedCliT )->nVdvPed

      if ( dbfPedCliL )->( dbSeek( cNumPed ) )

         while ( dbfPedCliL )->cSerPed + Str( ( dbfPedCliL )->nNumPed ) + ( dbfPedCliL )->cSufPed == cNumPed .AND. !( dbfPedCliL )->( Eof() )

            ( dbfTmpL )->( dbAppend() )

            ( dbfTmpL )->cCbaTil    := ( dbfPedCliL )->cRef
            ( dbfTmpL )->cNomTil    := ( dbfPedCliL )->cDetalle
            if ( dbfPedCliT )->lIvaInc
               ( dbfTmpL )->nPvpTil := ( dbfPedCliL )->nPreDiv
            else
               ( dbfTmpL )->nPvpTil := ( dbfPedCliL )->nPreDiv + ( ( ( dbfPedCliL )->nPreDiv * ( dbfPedCliL )->nIva ) / 100 )
            end
            ( dbfTmpL )->nUntTil    := ( dbfPedCliL )->nUniCaja
            ( dbfTmpL )->nUndKit    := ( dbfPedCliL )->nUndKit
            ( dbfTmpL )->nIvaTil    := ( dbfPedCliL )->nIva
            ( dbfTmpL )->cFamTil    := ( dbfPedCliL )->cCodFam
            ( dbfTmpL )->nDtoLin    := ( dbfPedCliL )->nDto
            ( dbfTmpL )->cCodPr1    := ( dbfPedCliL )->cCodPr1
            ( dbfTmpL )->cCodPr2    := ( dbfPedCliL )->cCodPr2
            ( dbfTmpL )->cValPr1    := ( dbfPedCliL )->cValPr1
            ( dbfTmpL )->cValPr2    := ( dbfPedCliL )->cValPr2
            ( dbfTmpL )->nFacCnv    := ( dbfPedCliL )->nFacCnv
            ( dbfTmpL )->nDtoDiv    := ( dbfPedCliL )->nDtoDiv
            ( dbfTmpL )->nCtlStk    := ( dbfPedCliL )->nCtlStk
            ( dbfTmpL )->cAlmLin    := ( dbfPedCliL )->cAlmLin
            ( dbfTmpL )->nValImp    := ( dbfPedCliL )->nValImp
            ( dbfTmpL )->cCodImp    := ( dbfPedCliL )->cCodImp
            ( dbfTmpL )->nCosDiv    := ( dbfPedCliL )->nCosDiv
            ( dbfTmpL )->lKitArt    := ( dbfPedCliL )->lKitArt
            ( dbfTmpL )->lKitChl    := ( dbfPedCliL )->lKitChl
            ( dbfTmpL )->lKitPrc    := ( dbfPedCliL )->lKitPrc
            ( dbfTmpL )->lImpLin    := ( dbfPedCliL )->lImpLin
            ( dbfTmpL )->lControl   := ( dbfPedCliL )->lControl
            ( dbfTmpL )->mNumSer    := ( dbfPedCliL )->mNumSer
            ( dbfTmpL )->cCodFam    := ( dbfPedCliL )->cCodFam
            ( dbfTmpL )->cGrpFam    := ( dbfPedCliL )->cGrpFam
            ( dbfTmpL )->nLote      := ( dbfPedCliL )->nLote
            ( dbfTmpL )->cLote      := ( dbfPedCliL )->cLote
            ( dbfTmpL )->dFecCad    := ( dbfPedCliL )->dFecCad
            ( dbfTmpL )->cCodUsr    := ( dbfPedCliT )->cCodUsr
            ( dbfTmpL )->nNumLin    := nLastNum( dbfTmpL )
            ( dbfTmpL )->nPosPrint  := nLastNum( dbfTmpL, "nPosPrint" )

            ( dbfTmpL )->( dbUnLock() )

            ( dbfPedCliL )->( dbSkip() )

         end

      end





      if ( dbfPedCliP )->( dbSeek( cNumPed ) )

         while ( dbfPedCliP )->cSerPed + Str( ( dbfPedCliP )->nNumPed ) + ( dbfPedCliP )->cSufPed == cNumPed .AND. !( dbfPedCliP )->( Eof() )

            if !( dbfPedCliP )->lPasado

               ( dbfTmpP )->( dbAppend() )

               ( dbfTmpP )->cCodCaj    := ( dbfPedCliP )->cCodCaj
               ( dbfTmpP )->dPgoTik    := ( dbfPedCliP )->dEntrega
               ( dbfTmpP )->nImpTik    := ( dbfPedCliP )->nImporte
               ( dbfTmpP )->cDivPgo    := ( dbfPedCliP )->cDivPgo
               ( dbfTmpP )->nVdvPgo    := ( dbfPedCliP )->nVdvPgo
               ( dbfTmpP )->cFpgPgo    := ( dbfPedCliP )->cCodPgo
               ( dbfTmpP )->cTurPgo    := ( dbfPedCliP )->cTurRec

               ( dbfTmpP )->( dbUnLock() )

            end

            ( dbfPedCliP )->( dbSkip() )

         end

      end

   end





   lRecTotal( aTmp )

   ( dbfTmpL )->( dbGoTop() )

   oBrwLin:Refresh()





   ( dbfPedCliT )->( ordsetfocus( nOrdCab ) )
   ( dbfPedCliL )->( ordsetfocus( nOrdLin ) )
   ( dbfPedCliT )->( dbGoTo( nRecCab ) )
   ( dbfPedCliL )->( dbGoTo( nRecLin ) )

   cNumPed            := ""
   lStopEntContLine   := .T.

return .T.



static function cPreCli( aTmp, aGet, cNumPre, oBrwLin )

   local nRecCab
   local nRecLin
   local nOrdCab
   local nOrdLin

   nRecCab           := ( dbfPreCliT )->( Recno() )
   nRecLin           := ( dbfPreCliL )->( Recno() )
   nOrdCab           := ( dbfPreCliT )->( ordsetfocus( "NNUMPRE" ) )
   nOrdLin           := ( dbfPreCliL )->( ordsetfocus( "NNUMPRE" ) )





   if ( dbfPreCliT )->( dbSeek( cNumPre ) )

      cOldCodCli        := ( dbfPreCliT )->cCodCli

      aGet[ 8 ]:cText( ( dbfPreCliT )->cCodUsr )
      aGet[ 9 ]:cText( ( dbfPreCliT )->cCodCaj )
      aGet[ 10 ]:cText( ( dbfPreCliT )->cCodAlm )
      aGet[ 12 ]:cText( ( dbfPreCliT )->nTarifa )
      aGet[ 11 ]:cText( ( dbfPreCliT )->cCodCli )
      aGet[ 13 ]:cText( ( dbfPreCliT )->cNomCli )
      aGet[ 14 ]:cText( ( dbfPreCliT )->cDirCli )
      aGet[ 15 ]:cText( ( dbfPreCliT )->cPobCli )
      aGet[ 63 ]:cText( ( dbfPreCliT )->cTlfCli )
      aGet[ 16 ]:cText( ( dbfPreCliT )->cPrvCli )
      aGet[ 18 ]:cText( ( dbfPreCliT )->cPosCli )
      aGet[ 19 ]:cText( ( dbfPreCliT )->cDniCli )
      aGet[ 21 ]:cText( ( dbfPreCliT )->cCodPgo )
      aGet[ 24 ]:cText( ( dbfPreCliT )->cDivPre )
      if !empty ( aGet[ 25 ] )
         aGet[ 25 ]:cText( ( dbfPreCliT )->nVdvPre )
      end
      aGet[ 32 ]:cText( ( dbfPreCliT )->cCodAge )
      aGet[ 36 ]:cText( ( dbfPreCliT )->nPctComAge )
      aGet[ 33 ]:cText( ( dbfPreCliT )->cCodRut )
      aGet[ 34 ]:cText( ( dbfPreCliT )->cCodTar )
      aGet[ 35 ]:cText( ( dbfPreCliT )->cCodObr )
      aTmp[ 20 ]  := .T.
      aTmp[ 55 ]  := cNumPre
      aTmp[ 46 ]  := ( dbfPreCliT )->cCodDlg
      aTmp[ 47 ]  := ( dbfPreCliT )->cCodGrp

      if ( dbfPreCliL )->( dbSeek( cNumPre ) )

         while ( dbfPreCliL )->cSerPre + Str( ( dbfPreCliL )->nNumPre ) + ( dbfPreCliL )->cSufPre == cNumPre .AND. !( dbfPreCliL )->( Eof() )

            ( dbfTmpL )->( dbAppend() )

            ( dbfTmpL )->cCbaTil    := ( dbfPreCliL )->cRef

            if !Empty( ( dbfPreCliL )->cDetalle )
               ( dbfTmpL )->cNomTil    := ( dbfPreCliL )->cDetalle
            else
               ( dbfTmpL )->cNomTil    := ( dbfPreCliL )->mLngDes
            end

            if ( dbfAlbCliT )->lIvaInc
               ( dbfTmpL )->nPvpTil := ( dbfPreCliL )->nPreDiv
            else
               ( dbfTmpL )->nPvpTil := ( dbfPreCliL )->nPreDiv + ( ( ( dbfPreCliL )->nPreDiv * ( dbfPreCliL )->nIva ) / 100 )
            end
            ( dbfTmpL )->nUntTil    := ( dbfPreCliL )->nUniCaja
            ( dbfTmpL )->nUndKit    := ( dbfPreCliL )->nUndKit
            ( dbfTmpL )->nIvaTil    := ( dbfPreCliL )->nIva
            ( dbfTmpL )->cFamTil    := ( dbfPreCliL )->cCodFam
            ( dbfTmpL )->nDtoLin    := ( dbfPreCliL )->nDto
            ( dbfTmpL )->cCodPr1    := ( dbfPreCliL )->cCodPr1
            ( dbfTmpL )->cCodPr2    := ( dbfPreCliL )->cCodPr2
            ( dbfTmpL )->cValPr1    := ( dbfPreCliL )->cValPr1
            ( dbfTmpL )->cValPr2    := ( dbfPreCliL )->cValPr2
            ( dbfTmpL )->nFacCnv    := ( dbfPreCliL )->nFacCnv
            ( dbfTmpL )->nDtoDiv    := ( dbfPreCliL )->nDtoDiv
            ( dbfTmpL )->nCtlStk    := ( dbfPreCliL )->nCtlStk
            ( dbfTmpL )->cAlmLin    := ( dbfPreCliL )->cAlmLin
            ( dbfTmpL )->nValImp    := ( dbfPreCliL )->nValImp
            ( dbfTmpL )->cCodImp    := ( dbfPreCliL )->cCodImp
            ( dbfTmpL )->nCosDiv    := ( dbfPreCliL )->nCosDiv
            ( dbfTmpL )->lKitArt    := ( dbfPreCliL )->lKitArt
            ( dbfTmpL )->lKitChl    := ( dbfPreCliL )->lKitChl
            ( dbfTmpL )->lKitPrc    := ( dbfPreCliL )->lKitPrc
            ( dbfTmpL )->lImpLin    := ( dbfPreCliL )->lImpLin
            ( dbfTmpL )->lControl   := ( dbfPreCliL )->lControl
            ( dbfTmpL )->mNumSer    := ( dbfPreCliL )->mNumSer
            ( dbfTmpL )->cCodFam    := ( dbfPreCliL )->cCodFam
            ( dbfTmpL )->cGrpFam    := ( dbfPreCliL )->cGrpFam
            ( dbfTmpL )->nLote      := ( dbfPreCliL )->nLote
            ( dbfTmpL )->cLote      := ( dbfPreCliL )->cLote
            ( dbfTmpL )->dFecCad    := ( dbfPreCliL )->dFecCad
            ( dbfTmpL )->cCodUsr    := ( dbfPreCliT )->cCodUsr
            ( dbfTmpL )->nNumLin    := nLastNum( dbfTmpL )
            ( dbfTmpL )->nPosPrint  := nLastNum( dbfTmpL, "nPosPrint" )

            ( dbfTmpL )->( dbUnLock() )

            ( dbfPreCliL )->( dbSkip() )

         end

      end

   end





   lRecTotal( aTmp )

   ( dbfTmpL )->( dbGoTop() )

   oBrwLin:Refresh()





   ( dbfPreCliT )->( ordsetfocus( nOrdCab ) )
   ( dbfPreCliL )->( ordsetfocus( nOrdLin ) )
   ( dbfPreCliT )->( dbGoTo( nRecCab ) )
   ( dbfPreCliL )->( dbGoTo( nRecLin ) )

   cNumPre            := ""
   lStopEntContLine   := .T.

return .T.



Static function GuardaApartado( aGet, aTmp, nMode, nSave, lBig, oBrw, oBrwDet, oDlgTpv )

   local oError
   local oBlock
   local cSelApartado   := ""
   local nRec
   local nOrdAnt

   if ( dbfTmpL )->( OrdKeyCount() ) == 0

      lSaveNewTik       := .F.

      cSelApartado      := BrwApartados()

      nRec              := ( D():Tikets( nView ) )->( Recno() )
      nOrdAnt           := ( D():Tikets( nView ) )->( ordsetfocus( "CNUMTIK" ) )


      if !empty( cSelApartado )                 .AND. ( D():Tikets( nView ) )->( dbSeek( cSelApartado ) )

         oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
         BEGIN SEQUENCE





         aScatter( D():Tikets( nView ), aTmp )

         BeginTrans( aTmp, aGet, 2, .F. )

         aEval( oDlgTpv:aControls, { | oCtrl | oCtrl:Refresh() } )

         nSaveMode            := 2
         nMode                := 2
         lSaveNewTik          := .F.





         cTitleDialog( aTmp )





         SetButtonEdtRec( nSaveMode, aTmp )





         lRecTotal( aTmp )





         cOldCodCli           := ""

         if !empty( aGet[ 11 ] )
            aGet[ 11 ]:SetFocus()
            aGet[ 11 ]:lValid()
         end

         RECOVER USING oError

         msgStop( ErrorMessage( oError ), "Error al cambiar de ticket" )

         end

         ErrorBlock( oBlock )

      end

      ( D():Tikets( nView ) )->( ordsetfocus( nOrdAnt ) )
      ( D():Tikets( nView ) )->( dbGoTo( nRec ) )

   else

      NewTiket( aGet, aTmp, nMode, nSave, lBig, oBrw, oBrwDet )

   end

Return .T.



static function BrwApartados()

   local oDlg
   local oBrw
   local oGet1
   local cGet1
   local nOrd                    := GetBrwOpt( "BrwTikCli" )
   local oCbxOrd
   local cCbxOrd
   local aCbxOrd                 := { "Número", "Fecha", "Código cliente", "Nombre cliente" }
   local nRecAnt                 := ( D():Tikets( nView ) )->( RecNo() )
   local cApartadoSeleccionado   := ""

   nOrd                          := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd                       := aCbxOrd[ nOrd ]

   nOrd                          := ( D():Tikets( nView ) )->( ordsetfocus( nOrd ) )





   ( D():Tikets( nView ) )->( dbGoTop() )

   if ( D():Tikets( nView ) )->( Eof() )

      MsgStop( "No existen apartados para seleccionar." )

   else

      oDlg = TDialog():New(,,,, "Seleccionar apartado", "HelpEntry",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





         oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,,,,,,,, .F.,, {|nKey,nFlags,Self| AutoSeek( nKey, nFlags, Self, oBrw, D():Tikets( nView ) ) }, .F., .F.,,,,,, nil, "FIND",, )






         oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( D():Tikets( nView ) )->( ordsetfocus( oCbxOrd:nAt ) ), oBrw:Refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

         oBrw                    := IXBrowse():New( oDlg )

         oBrw:bClrSel            := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
         oBrw:bClrSelFocus       := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

         oBrw:cAlias             := D():Tikets( nView )
         oBrw:cName              := "Ticket cliente"
         oBrw:bLDblClick         := {|| oDlg:End( 1 ) }

         oBrw:nMarqueeStyle      := 5

         with object ( oBrw:AddCol() )
            :cHeader             := "Número"
            :cSortOrder          := "cNumTik"
            :bEditValue          := {|| ( D():Tikets( nView ) )->cSerTik + "/" + AllTrim( ( D():Tikets( nView ) )->cNumTik ) + "/" + ( D():Tikets( nView ) )->cSufTik }
            :nWidth              := 70
            :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
         end

         with object ( oBrw:AddCol() )
            :cHeader             := "Fecha"
            :cSortOrder          := "dFecTik"
            :bEditValue          := {|| dtoc( ( D():Tikets( nView ) )->dFecTik ) }
            :nWidth              := 80
            :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
         end

         with object ( oBrw:AddCol() )
            :cHeader             := "Hora"
            :bEditValue          := {|| ( D():Tikets( nView ) )->cHorTik }
            :nWidth              := 80
         end

         with object ( oBrw:AddCol() )
            :cHeader             := "Sesión"
            :bEditValue          := {|| ( D():Tikets( nView ) )->cTurTik + "/" + ( D():Tikets( nView ) )->cSufTik }
            :nWidth              := 80
            :lHide               := .T.
         end

         with object ( oBrw:AddCol() )
            :cHeader             := "Código cliente"
            :bEditValue          := {|| Rtrim( ( D():Tikets( nView ) )->cCliTik ) }
            :cSortOrder          := "cCliTik"
            :nWidth              := 100
            :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
         end

         with object ( oBrw:AddCol() )
            :cHeader             := "Nombre cliente"
            :bEditValue          := {|| AllTrim( ( D():Tikets( nView ) )->cNomTik ) }
            :cSortOrder          := "cNomTik"
            :nWidth              := 350
            :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
         end

         with object ( oBrw:AddCol() )
            :cHeader             := "Importe "
            :bEditValue          := {|| nTotalizer( ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik, D():Tikets( nView ), dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, cDivEmp(), .T. ) }
            :nWidth              := 85
            :nDataStrAlign       := 1
            :nHeadStrAlign       := 1
         end

         oBrw:CreateFromResource( 105 )





         TButton():ReDefine( 500, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )





         TButton():ReDefine( 501, {||( nil )}, oDlg,,, .F., {||     ( .F. )},,, .F. )




         TButton():ReDefine( 1, {||( EndBrwApartados( oDlg ) )}, oDlg,,, .F.,,,, .F. )





         TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:bStart                := {|| oBrw:Load() }

      oDlg:AddFastKey( 116,    {|| EndBrwApartados( oDlg ) } )
      oDlg:AddFastKey( 13,{|| EndBrwApartados( oDlg ) } )

      oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )





      if oDlg:nResult == 1
         cApartadoSeleccionado   := ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik
      end

      SetBrwOpt( "BrwTikCli", ( D():Tikets( nView ) )->( OrdNumber() ) )

   end

   ( D():Tikets( nView ) )->( ordsetfocus( nOrd ) )
   ( D():Tikets( nView ) )->( dbGoTo( nRecAnt ) )

RETURN ( cApartadoSeleccionado )



Static Function EndBrwApartados( oDlg )

   if ( D():Tikets( nView ) )->cTipTik == "5"
      msgStop( "El tipo de documento no es un apartado." )
      Return .F.
   end

   if ( D():Tikets( nView ) )->cCcjTik == Auth():Codigo()
      msgStop( "El usuario que realizo el docuemnto no coincide." )
      Return .F.
   end

   if ( D():Tikets( nView ) )->cNcjTik == Application():CodigoCaja()
      msgStop( "El documento no se realizo en esta caja." )
      Return .F.
   end

   oDlg:end( 1 )

Return ( .T. )







Static Function NewTiket( aGet, aTmp, nMode, nSave, lBig, oBrw, oBrwDet )

   local nRec
   local nOrd
   local aTbl
   local nTotTik
   local cAlmTik
   local cTipTik
   local oError
   local oBlock
   local nOrdAlb
   local cNumDoc           := ""
   local nNumTik           := ""
   local cAlbTik           := aTmp[ 53 ]
   local cPedTik           := aTmp[ 54 ]
   local cPreTik           := aTmp[ 55 ]
   local cSatTik           := aTmp[ 56 ]
   local nValeDiferencia   := 0
   local nValePromocion    := 0
   local lValePromocion    := .F.
   local lValeDiferencia   := .F.

   If( nSave == nil, nSave := "1", ) ;
   If( lBig == nil, lBig := .F., ) ;

   if lSaveNewTik
      Return .T.
   else
      lSaveNewTik          := .T.
   end





   if !lValidaOperacion( aTmp[ 6 ] )
      lSaveNewTik          := .F.
      Return .F.
   end

   if !lValidaSerie( aTmp[ 1 ] )
      lSaveNewTik          := .F.
      Return .F.
   end





   if ( nSave == "8" )
      aTmp[ 64 ]     := .T.
      nSave                := "6"
   else
      aTmp[ 64 ]     := .F.
   end





   if !empty( oDlgDet )
      oDlgDet:nResult      := 2
   end





   if ( dbfTmpL )->( OrdKeyCount() ) == 0
      MsgStop( "No puede almacenar un documento sin lineas." )
      lSaveNewTik          := .F.
      return .F.
   end

   if !empty( aGet[ 11 ] ) .AND. !( aGet[ 11 ]:lValid() )
      aGet[ 11 ]:SetFocus()
      lSaveNewTik          := .F.
      return .F.
   end

   if !empty( aGet[ 10 ] )

      if empty( aTmp[ 10 ] )
         aGet[ 10 ]:SetFocus()
         MsgInfo( "Almacén no puede estar vacio" )
         lSaveNewTik       := .F.
         return .F.
      end

      if !( aGet[ 10 ]:lValid() )
         aGet[ 10 ]:SetFocus()
         lSaveNewTik       := .F.
         return .F.
      end

   end

   if !empty( aGet[ 8 ] ) .AND. empty( aTmp[ 8 ] )
      aGet[ 8 ]:cText( Auth():Codigo() )
   end

   if lRecogerAgentes() .AND. !empty( aGet[ 32 ] ) .AND.  empty( aTmp[ 32 ] )
      msgStop( "Agente no puede estar vacio." )
      aGet[ 32 ]:SetFocus()
      lSaveNewTik         := .F.
      return .F.
   end

   if lRecogerAgentes() .AND. !empty( aGet[ 32 ] ) .AND. !( aGet[ 32 ]:lValid() )
      aGet[ 32 ]:SetFocus()
      lSaveNewTik         := .F.
      return .F.
   end





   oTotDiv              := TotalesTPV():Init()

   nTotTik              := nTotTik( aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ], D():Tikets( nView ), dbfTmpL, dbfDiv, aTmp, nil, .F. )





   do case
      case nSave == "2"

      if empty( aTmp[ 11 ] )
         msgStop( "Código de cliente no puede estar vacio." )
         aGet[ 11 ]:SetFocus()
         lSaveNewTik         := .F.
         return .F.
      end

      if !empty( aGet[ 11 ] ) .AND. lCliBlq( aTmp[ 11 ], dbfClient )


         msgStop( "Cliente bloqueado, no se pueden realizar operaciones de venta" + Chr(13)+Chr(10) +  "Motivo: " + AllTrim( RetFld( aTmp[ 11 ], dbfClient, "cMotBlq" ) ), "Imposible archivar" )
         aGet[ 11 ]:SetFocus()
         lSaveNewTik         := .F.
         return .F.
      end

      if !empty( aGet[ 11 ] ) .AND. !lCliChg( aTmp[ 11 ], dbfClient )
         msgStop( "Este cliente no tiene autorización para venta a credito.", "Imposible archivar como albarán" )
         aGet[ 11 ]:SetFocus()
         lSaveNewTik         := .F.
         return .F.
      end

      if !lBig

         if !empty( aGet[ 21 ] ) .AND. empty( aTmp[ 21 ] )
            MsgStop( "Debe de introducir una forma de pago", "Imposible archivar como albarán" )
            aGet[ 21 ]:SetFocus()
            lSaveNewTik         := .F.
            return .F.
         end

         if !empty( aGet[ 21 ] ) .AND. !( aGet[ 21 ]:lValid() )
            aGet[ 21 ]:SetFocus()
            lSaveNewTik         := .F.
            return .F.
         end

         if lObras() .AND. !empty( aGet[ 35 ] ) .AND. empty( aTmp[ 35 ] )
            MsgStop( "Debe de introducir una dirección", "Imposible archivar como albarán" )
            aGet[ 35 ]:SetFocus()
            lSaveNewTik         := .F.
            return .F.
         end

         if lObras() .AND. !empty( aGet[ 35 ] ) .AND. !( aGet[ 35 ]:lValid() )
            aGet[ 35 ]:SetFocus()
            lSaveNewTik         := .F.
            return .F.
         end

      end

      case nSave == "1" .AND. nTotTik >= 400

         if !empty( aGet[ 13 ] ) .AND. empty( aTmp[ 13 ] )
            msgStop( "Nombre de cliente no puede estar vacio." )
            aGet[ 11 ]:SetFocus()
            lSaveNewTik         := .F.
            return .F.
         end

         if empty( aTmp[ 14 ] ) .AND. !( "GA" $ oWnd():Cargo )
            msgStop( "Domicilio de cliente no puede estar vacio." )
            lSaveNewTik         := .F.
            return .F.
         end

         if empty( aTmp[ 19 ] ) .AND. !( "GA" $ oWnd():Cargo )
            msgStop( "D.N.I. / C.I.F. de cliente no puede estar vacio." )
            lSaveNewTik         := .F.
            return .F.
         end

   end





   if ( nSave <> "4" ) .AND. ( nSave <> "6" ) .AND. ( lFidelity( aGet, aTmp, nMode ) )
      lSaveNewTik       := .F.
      return .F.
   end





   if empty( aTmp[ 1 ] )
      aTmp[ 1 ]  := "A"
   end





   if empty( aTmp[ 5 ] )
      aTmp[ 5 ]  := cCurSesion()
   end





   if empty( aTmp[ 8 ] )
      aTmp[ 8 ]  := Auth():Codigo()
   end





   if empty( aTmp[ 9 ] )
      aTmp[ 9 ]  := Application():CodigoCaja()
   end





   if empty( aTmp[ 12 ] )
      aTmp[ 12 ]  := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end





   oTotDiv              := TotalesTPV():Init()

   nTotTik              := nTotTik( aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ], D():Tikets( nView ), dbfTmpL, dbfDiv, aTmp, nil, .F. )

   aTmp[ 23 ]     := 0
   aTmp[ 22 ]     := nTotTik





   aTmp[ 61 ]     := oFideliza:nPorcentajePrograma( nTotPrm )





   lValePromocion       := ( !Retfld( aTmp[ 11 ], dbfClient, "lExcFid" ) .AND. ( aTmp[ 61 ] <> 0 ) )
   if lValePromocion
      nValePromocion    := nTotPrm * aTmp[ 61 ] / 100
   end





   if lExacto( aTmp ) .OR. lCobro( @aTmp, aGet, @nSave, nMode, @lValeDiferencia, @nValeDiferencia, lBig, oDlgTpv )





      if ( dbfTmpL )->( OrdKeyCount() ) == 0
         MsgStop( "No puede almacenar un documento sin lineas." )
         lSaveNewTik         := .F.
         return .F.
      end





      CursorWait()

      oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE

         AutoMeterDialog( oDlgTpv )
         AutoTextDialog( oDlgTpv )

         TComercio:resetProductsToUpdateStocks()

         BeginTransaction()





         aTmp[ 4 ]     := nSave
         aTmp[ 40 ]     := Date()
         aTmp[ 41 ]     := SubStr( Time(), 1, 5 )
         aTmp[ 50]     := .F.





         do case
         case nMode == 1





            setAutoTextDialog( "Obtenemos el nuevo número" )

            if nSave <> "2"

               aTmp[ 2 ]  := Str( nNewDoc( aTmp[ 1 ], D():Tikets( nView ), "nTikCli", 10, dbfCount ), 10 )
               aTmp[ 3 ]  := RetSufEmp()
               aTmp[ 72    ]  := win_uuidcreatestring()
               nNumTik           := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]

            end





            aTmp[ 7 ]  := Substr( Time(), 1, 5 )
            aTmp[ 26 ]  := .F.

         case nMode == 2

            nNumTik           := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]
            cNumDoc           := aTmp[ 31 ]





            setAutoTextDialog( "Eliminando lineas" )

            while ( dbfTikL )->( dbSeek( nNumTik ) )

               TComercio:appendProductsToUpadateStocks( (dbfTikL)->cCbaTil, nView )

               if dbLock( dbfTikL )
                  ( dbfTikL )->( dbDelete() )
                  ( dbfTikL )->( dbUnLock() )
               end

            end





            setAutoTextDialog( "Eliminando pagos" )

            while ( dbfTikP )->( dbSeek( nNumTik ) )
               if dbLock( dbfTikP )
                  ( dbfTikP )->( dbDelete() )
                  ( dbfTikP )->( dbUnLock() )
               end
            end





            setAutoTextDialog( "Eliminando vales" )

            nOrd  := ( D():Tikets( nView ) )->( ordsetfocus( "cDocVal" ) )
            nRec  := ( D():Tikets( nView ) )->( Recno() )

            while ( D():Tikets( nView ) )->( dbSeek( nNumTik ) ) .AND. !( D():Tikets( nView ) )->( eof() )
               if dbLock( D():Tikets( nView ) )
                  ( D():Tikets( nView ) )->lLiqTik       := .F.
                  ( D():Tikets( nView ) )->lSndDoc       := .T.
                  ( D():Tikets( nView ) )->cValDoc       := ""
                  ( D():Tikets( nView ) )->cTurVal       := ""
                  ( D():Tikets( nView ) )->( dbUnLock() )
               end
            end

            ( D():Tikets( nView ) )->( ordsetfocus( nOrd ) )
            ( D():Tikets( nView ) )->( dbGoTo( nRec ) )





            setAutoTextDialog( "Eliminando anticipos" )

            if !empty( cNumDoc )

            nRec  := ( dbfAntCliT )->( Recno() )
            nOrd  := ( dbfAntCliT )->( ordsetfocus( "cNumDoc" ) )

            while ( dbfAntCliT )->( dbSeek( cNumDoc ) ) .AND. !( dbfAntCliT )->( eof() )
               if dbLock( dbfAntCliT )
                  ( dbfAntCliT )->lLiquidada := .F.
                  ( dbfAntCliT )->dLiquidada := Ctod( "" )
                  ( dbfAntCliT )->cTurLiq    := ""
                  ( dbfAntCliT )->cCajLiq    := ""
                  ( dbfAntCliT )->cNumDoc    := ""
                  ( dbfAntCliT )->( dbUnLock() )
               end
            end

            ( dbfAntCliT )->( ordsetfocus( nOrd ) )
            ( dbfAntCliT )->( dbGoTo( nRec ) )

            end

         end





         setAutoTextDialog( "Anotando los pagos" )

         if ( oTotDiv:lValeMayorTotal() )

            if ( aTmp[ 22 ] <> 0 .AND. nSave <> "5" )

               if dbAppe( dbfTmpP )
                  ( dbfTmpP )->cTurPgo    := cCurSesion()
                  ( dbfTmpP )->dPgoTik    := GetSysDate()
                  ( dbfTmpP )->cTimTik    := SubStr( Time(), 1, 5 )
                  ( dbfTmpP )->cCodCaj    := Application():CodigoCaja()
                  ( dbfTmpP )->cFpgPgo    := aTmp[ 21 ]
                  ( dbfTmpP )->cSerTik    := aTmp[ 1 ]
                  ( dbfTmpP )->cNumTik    := if( ValType( aTmp[ 2 ] ) <> "C", Str( aTmp[ 2 ], 10 ), aTmp[ 2 ] )
                  ( dbfTmpP )->cSufTik    := aTmp[ 3 ]
                  ( dbfTmpP )->nImpTik    := aTmp[ 22 ]
                  ( dbfTmpP )->cDivPgo    := aTmp[ 24 ]
                  ( dbfTmpP )->nVdvPgo    := aTmp[ 25 ]
                  ( dbfTmpP )->nDevTik    := Max( aTmp[ 23 ], 0 )
               else
                  MsgStop( "No se ha podido añadir el registro de pago" )
               end

            end

         end





         nCambioTik           := aTmp[ 23 ]





         if !empty( aTmp[ 53 ] )

            setAutoTextDialog( "Estado albarán" )

            if dbSeekInOrd( aTmp[ 53 ], "nNumAlb", dbfAlbCliT )

               if dbLock( dbfAlbCliT )
                  ( dbfAlbCliT )->lFacturado    := .T.
                  ( dbfAlbCliT )->nFacturado    := 3
                  ( dbfAlbCliT )->cNumTik       := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]
                  ( dbfAlbCliT )->( dbUnLock() )
               end

            end

            nOrdAlb           := ( dbfAlbCliL )->( ordsetfocus( "nNumAlb" ) )

            if ( dbfAlbCliL )->( dbSeek( aTmp[ 53 ] ) )

               while ( dbfAlbCliL )->cSerAlb + Str( ( dbfAlbCliL )->nNumAlb ) + ( dbfAlbCliL )->cSufAlb == aTmp[ 53 ] .AND. !( dbfAlbCliL )->( Eof() )

                  if dbLock( dbfAlbCliL )
                     ( dbfAlbCliL )->lFacturado := .T.
                     ( dbfAlbCliL )->( dbUnLock() )
                  end

                  ( dbfAlbCliL )->( dbSkip() )

               end

            end

            ( dbfAlbCliL )->( ordsetfocus( nOrdAlb ) )

         end



         if !empty( aTmp[ 56 ] )

            setAutoTextDialog( "Estado SAT" )

            nOrdAlb           := ( D():SATClientes( nView ) )->( ordsetfocus( "nNumSat" ) )

            if ( D():SATClientes( nView ) )->( dbseek( aTmp[ 56 ] ) )

               if dbLock( D():SATClientes( nView ) )
                  ( D():SATClientes( nView ) )->lEstado       := .T.
                  ( D():SATClientes( nView ) )->cNumTik       := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]
                  ( D():SATClientes( nView ) )->( dbUnLock() )
               end

            end

            ( D():SATClientes( nView ) )->( ordsetfocus( nOrdAlb ) )

         end



         if !empty( aTmp[ 54 ] )

            setAutoTextDialog( "Estado pedido" )

            if dbSeekInOrd( aTmp[ 54 ], "nNumPed", dbfPedCliT )

               if dbLock( dbfPedCliT )
                  ( dbfPedCliT )->nEstado       := 3
                  ( dbfPedCliT )->cNumTik       := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]
                  ( dbfPedCliT )->( dbUnLock() )
               end

            end

         end



         if !empty( aTmp[ 55 ] )

            setAutoTextDialog( "Estado presupuesto" )

            if dbSeekInOrd( aTmp[ 55 ], "nNumPre", dbfPreCliT )

               if dbLock( dbfPreCliT )
                  ( dbfPreCliT )->lEstado       := .T.
                  ( dbfPreCliT )->cNumTik       := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]
                  ( dbfPreCliT )->( dbUnLock() )
               end

            end

         end



         if hb_isArray( aAlbaranes ) .AND. Len( aAlbaranes ) > 0


            aEval( aAlbaranes, {|hAlbaran| if( hGet( hAlbaran, "LSNDDOC" ), ( AlbaranesClientesModel():UpdateFacturado( hGet( hAlbaran, "CSERALB" ) + Str( hGet( hAlbaran, "NNUMALB" ) ) + hGet( hAlbaran, "CSUFALB" ), 3 ), AlbaranesClientesLineasModel():UpdateAllFacturado( hGet( hAlbaran, "CSERALB" ) + Str( hGet( hAlbaran, "NNUMALB" ) ) + hGet( hAlbaran, "CSUFALB" ), .T. ) ), ) } )

         end





         do case
            case nMode == 4

               SavTik2Neg( aTmp, aGet, nMode, nSave )
               SavTik2Fac( aTmp, aGet, nMode, nSave, nTotTik )

            case nSave == "2"

               SavTik2Alb( aTmp, aGet, nMode, nSave )

            otherwise

               SavTik2Tik( aTmp, aGet, nMode, nSave )

         end





         setAutoTextDialog( "Archivando")





         setAutoTextDialog( "Archivando vales" )

         nRec                          := ( D():Tikets( nView ) )->( Recno() )

         ( dbfTmpV )->( dbGoTop() )
         while !( dbfTmpV )->( eof() )
            if ( D():Tikets( nView ) )->( dbSeek( ( dbfTmpV )->cSerTik + ( dbfTmpV )->cNumTik + ( dbfTmpV )->cSufTik ) )
               if dbLock( D():Tikets( nView ) )
                  ( D():Tikets( nView ) )->lLiqTik := .T.
                  ( D():Tikets( nView ) )->lSndDoc := .T.
                  ( D():Tikets( nView ) )->cValDoc := nNumTik
                  ( D():Tikets( nView ) )->cTurVal := cCurSesion()
                  ( D():Tikets( nView ) )->( dbUnLock() )
               end
            end
            ( dbfTmpV )->( dbSkip() )
         end

         ( D():Tikets( nView ) )->( dbGoTo( nRec ) )





         setAutoTextDialog( "Archivando anticipos" )

         ( dbfTmpA )->( dbGoTop() )
         while !( dbfTmpA )->( eof() )
            if ( dbfAntCliT )->( dbSeek( ( dbfTmpA )->cSerAnt + Str( ( dbfTmpA )->nNumAnt ) + ( dbfTmpA )->cSufAnt ) )
               if dbLock( dbfAntCliT )
                  ( dbfAntCliT )->cNumDoc    := ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac, 9 ) + ( dbfFacCliT )->cSufFac
                  ( dbfAntCliT )->lLiquidada := .T.
                  ( dbfAntCliT )->dLiquidada := GetSysDate()
                  ( dbfAntCliT )->cTurLiq    := cCurSesion()
                  ( dbfAntCliT )->cCajLiq    := Application():CodigoCaja()
                  ( dbfAntCliT )->( dbUnLock() )
               end
            end
            ( dbfTmpA )->( dbSkip() )
         end





         dbCommitAll()





         setAutoTextDialog( "Abriendo la caja" )

         if ( D():Tikets( nView ) )->cTipTik <> "2"
            Application():openDirectCajon()
         end





         if lCopTik .AND. ( nSave <> "5" )
            ImpTiket( 1 )
         end





         if lValeDiferencia .AND. ( nSave <> "6" .OR. nSave <> "4" )

            setAutoTextDialog( "Generando vales" )

            generateVale( nValeDiferencia )

            if lCopTik
               ImpTiket( 1 )
            end

         end





         if ( lValePromocion ) .AND. ( nValePromocion > 0 ) .AND. ( nMode == 1 ) .AND. ( nSave <> "6" )

            setAutoTextDialog( "Generando vales" )

            if uFieldEmpresa( "lMsgPromo" )

               if MsgYesNo( "¿Desea crear el vale por promoción?", "Seleccione una opción" )

                  generatePromocion( nValePromocion, nSave )

                  if lCopTik
                     ImpTiket( 1 )
                  end

               end

            else

                  generatePromocion( nValePromocion, nSave )

                  if lCopTik
                     ImpTiket( 1 )
                  end

            end

         end





         nSaveMode               := 1
         cNuevoAlbaran           := ""



         CommitTransaction()



         TComercio:updateWebProductStocks()

         EndAutoMeterDialog( oDlgTpv )
         EndAutoTextDialog( oDlgTpv )

         oDlgTpv:aEvalWhen()

      RECOVER USING oError

         RollBackTransaction()

         msgStop( "Error en la grabación del ticket" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

      CursorWE()





      if ( lBig ) .OR. ( lEntCon() .AND. ( nMode == 1 ) .AND. ( empty( cAlbTik ) .AND. empty( cPedTik ) .AND. empty( cPreTik ) .AND. empty( cSatTik ) ) )

         setAutoTextDialog( "Inicializado entorno" )

         if BeginTrans( aTmp, aGet, nMode, .T. )
            lSaveNewTik    := .F.
            Return nil
         end





         if !empty( aGet[ 11 ] )
            aGet[ 11 ]:lValid()
         end





         if empty( aTmp[ 12 ] )
            aTmp[ 12 ]  := Max( uFieldEmpresa( "nPreVta" ), 1 )
         end

         if empty( aTmp[ 12 ] ) .AND. !empty( RetFld( cDefCli(), dbfClient, "nTarifa" ) )
            aTmp[ 12 ]  := RetFld( cDefCli(), dbfClient, "nTarifa" )
         end





         if !empty( oBtnIni )
            oBtnIni:Click()
         end





         if oTxtTot <> nil
            oTxtTot:SetText( "Cambio" )
         end

         if ( oNumTot <> nil .AND. cPorDiv <> nil )
            oNumTot:SetText( Trans( nCambioTik, cPorDiv ) )
         end





         if oVisor <> nil
            oVisor:SetBufferLine( { "Total: ",  Trans( nTotTik, cPorDiv ) },     1 )
            oVisor:SetBufferLine( { "Cambio: ", Trans( nCambioTik, cPorDiv ) },  2 )
            oVisor:WriteBufferLine()
         end





         StartEdtRec( aTmp, aGet, nMode, oDlgTpv, oBrw, oBrwDet )

      else

         oDlgTpv:bValid    := {|| .T. }

         lSaveNewTik       := .F.

         oDlgTpv:end( 1 )

      end

      lStopEntCont         := !( empty( cAlbTik ) .AND. empty( cPedTik ) .AND. empty( cPreTik ) .AND. empty( cSatTik ) )

   end

   if lSaveNewTik
      lSaveNewTik          := .F.
   end

Return Nil



FUNCTION nTotUTpv( uTmpL, nDec, nVdv, nPrc )

   local nCalculo    := 0

   If( uTmpL == nil, uTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( nPrc == nil, nPrc := 0, ) ;

   if ValType( uTmpL ) == "C"

      if nPrc == 0 .OR. nPrc == 1
         nCalculo    += ( uTmpL )->nPvpTil
      end

      if nPrc == 0 .OR. nPrc == 2
         nCalculo    += ( uTmpL )->nPcmTil
      end

      nCalculo       -= ( uTmpL )->nDtoDiv

   else

      if nPrc == 0 .OR. nPrc == 1
         nCalculo    += uTmpL:nPvpTil
      end

      if nPrc == 0 .OR. nPrc == 2
         nCalculo    += uTmpL:nPcmTil
      end

      nCalculo       -= uTmpL:nDtoDiv

   end

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

RETURN ( round( nCalculo, nDec ) )



Function nBasUTpv( uTmpL, nDec, nVdv, nPrc )

   local nCalculo := 0

   If( uTmpL == nil, uTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( nPrc == nil, nPrc := 0, ) ;

   nCalculo       := nTotUTpv( uTmpL, nDec, nVdv, nPrc )

   do case
      case ValType( uTmpL ) == "C"
         nCalculo := Round( nCalculo / ( 1 + ( uTmpL )->nIvaTil / 100 ), nDec )

      case ValType( uTmpL ) == "O"
         nCalculo := Round( nCalculo / ( 1 + uTmpL:nIvaTil / 100 ), nDec )

   end

   if nVdv <> 0
      nCalculo    := nCalculo / nVdv
   end

Return ( Round( nCalculo, nDec ) )



Function nImpUTpv( uTikT, uTikL, nDec, nVdv, cPouDiv, nPrc )

   local nCalculo
   local nDtoEsp     := 0
   local nDtoPP      := 0

   If( uTikT == nil, uTikT := if( !Empty( nView ), D():Tikets( nView ), ), ) ;
   If( uTikL == nil, uTikL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( nPrc == nil, nPrc := 0, ) ;

   nCalculo          := nTotUTpv( uTikL, nDec, nVdv, nPrc )

   do case
      case IsChar( uTikL )

         if ( uTikL )->nDtoLin <> 0
            nCalculo -= ( uTikL )->nDtoLin * nCalculo / 100
         end

         if ( uTikL )->nIvaTil <> 0
            nCalculo -= Round( nCalculo / ( 100 / ( uTikL )->nIvaTil + 1 ), nDec )
         end

      case IsObject( uTikL )

         if uTikL:nDtoLin <> 0
            nCalculo -= uTikL:nDtoLin * nCalculo / 100
         end

         if uTikL:nIvaTil <> 0
            nCalculo -= Round( nCalculo / ( 100 / uTikL:nIvaTil + 1 ), nDec )
         end

   end



   do case
      case IsChar( uTikT )

         if ( uTikT )->cTipTik == "4"
            nCalculo := - nCalculo
         end

         nDtoEsp     := Round( nCalculo * ( uTikT )->nDtoEsp / 100, nDec )

         nDtoPp      := Round( nCalculo * ( uTikT )->nDpp / 100, nDec )

         nCalculo    -= nDtoEsp
         nCalculo    -= nDtoPp

      case IsObject( uTikT )

         if uTikT:cTipTik == "4"
            nCalculo := - nCalculo
         end

         nDtoEsp     := Round( nCalculo * uTikT:nDtoEsp / 100, nDec )

         nDtoPp      := Round( nCalculo * uTikT:nDpp / 100, nDec )

         nCalculo    -= nDtoEsp
         nCalculo    -= nDtoPp

   end

Return ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nImpLTpv( uTikT, uTikL, nDec, nRou, nVdv, cPouDiv, nPrc )

   local nCalculo    := 0
   local nDtoEsp     := 0
   local nDtoPp      := 0

   If( nDec == nil, nDec := 0, ) ;
   If( nRou == nil, nRou := 0, ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( nPrc == nil, nPrc := 0, ) ;

   if nPrc == 0 .OR. nPrc == 1
      nCalculo       += nTotLUno( uTikL, nDec, nRou, nVdv, nPrc )
   end

   if nPrc == 0 .OR. nPrc == 2
      nCalculo       += nTotLDos( uTikL, nDec, nRou, nVdv, nPrc )
   end

   do case
      case IsChar( uTikL )

         if ( uTikL )->nIvaTil <> 0
            nCalculo -= Round( nCalculo / ( 100 / ( uTikL )->nIvaTil + 1 ), nDec )
         end

      case IsObject( uTikL )

         if uTikL:nIvaTil <> 0
            nCalculo -= Round( nCalculo / ( 100 / uTikL:nIvaTil + 1 ), nDec )
         end

   end



   do case
      case IsChar( uTikT )

         if ( uTikT )->cTipTik == "4"
            nCalculo := - nCalculo
         end

         nDtoEsp     := Round( nCalculo * ( uTikT )->nDtoEsp / 100, nDec )
         nDtoPp      := Round( nCalculo * ( uTikT )->nDpp / 100, nDec )

         nCalculo    -= nDtoEsp
         nCalculo    -= nDtoPp

      case IsObject( uTikT )

         if uTikT:cTipTik == "4"
            nCalculo := - nCalculo
         end

         nDtoEsp     := Round( nCalculo * uTikT:nDtoEsp / 100, nDec )
         nDtoPp      := Round( nCalculo * uTikT:nDpp / 100, nDec )

         nCalculo    -= nDtoEsp
         nCalculo    -= nDtoPp

   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



FUNCTION nBasLTpv( uTikL, nDec, nRou, nVdv, cPouDiv, nPrc )

   local nCalculo

   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( nPrc == nil, nPrc := 0, ) ;

   nCalculo          := nTotLTpv( uTikL, nDec, nRou, nVdv, nPrc )

   do case
      case IsChar( uTikL )

         if ( uTikL )->nIvaTil <> 0
            nCalculo := Round( nCalculo / ( 1 + ( ( uTikL )->nIvaTil / 100 ) ), nDec )
         end

      case IsObject( uTikL )

         if uTikL:nIvaTil <> 0
            nCalculo := Round( nCalculo / ( 1 + ( uTikL:nIvaTil / 100 ) ), nDec )
         end

   end

RETURN ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



Function nBrtLTpv( uTikT, uTikL, nDec, nVdv, cPouDiv, nPrc )

   local nCalculo

   If( uTikT == nil, uTikT := if( !Empty( nView ), D():Tikets( nView ), ), ) ;
   If( uTikL == nil, uTikL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( nPrc == nil, nPrc := 0, ) ;

   nCalculo          := nTotUTpv( uTikL, nDec, nVdv, nPrc )
   nCalculo          *= nTotNTpv( uTikL )

Return ( if( cPouDiv <> nil, Trans( nCalculo, cPouDiv ), nCalculo ) )



Function nDtoUTpv( dbfTmpL, nDec, nVdv )

   local nCalculo

   If( dbfTmpL == nil, dbfTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := ( dbfTmpL )->nDtoDiv

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

Return ( round( nCalculo, nDec ) )



Function nTotNTikTpv( uDbf )

   local nTotUnd

   If( uDbf == nil, uDbf := dbfTikL, ) ;

   do case
      case ValType( uDbf ) == "A"

         nTotUnd  := uDbf[ 8 ]

      case ValType( uDbf ) == "C"

         nTotUnd  := ( uDbf )->nUntTil

      otherwise

         nTotUnd  := uDbf:nUntTil

   end

Return ( nTotUnd )



Function nTotVTikTpv( uDbf, lCombinado )

   local nTotUnd

   If( uDbf == nil, uDbf := dbfTikL, ) ;
   If( lCombinado == nil, lCombinado := .F., ) ;

   do case
      case ValType( uDbf ) == "A"

         if !lCombinado
            nTotUnd     := uDbf[ 8 ] * NotCero( uDbf[ 23 ] )
         else
            nTotUnd     := uDbf[ 8 ] * NotCero( uDbf[ 50 ] )
         end

      case ValType( uDbf ) == "C"

         if !lCombinado
            nTotUnd     := ( uDbf )->nUntTil * NotCero( ( uDbf )->nFacCnv )
         else
            nTotUnd     := ( uDbf )->nUntTil * NotCero( ( uDbf )->nFcmCnv )
         end

      otherwise

         if !lCombinado
            nTotUnd     := uDbf:nUntTil * NotCero( uDbf:nFacCnv )
         else
            nTotUnd     := uDbf:nUntTil * NotCero( uDbf:nFcmCnv )
         end

   end

Return ( nTotUnd )



Function nIvaLTpv( cTikT, cTikL, nDec, nRou, nVdv, nPrc )

   local nCalculo       := 0

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():Tikets( nView ), ), ) ;
   If( cTikL == nil, cTikL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;
   If( nPrc == nil, nPrc := 0, ) ;

   do case
      case ValType( cTikL ) == "C"

         if ( cTikL )->nIvaTil <> 0

            if empty( nPrc ) .OR. nPrc == 1
               nCalculo += nTotLUno( cTikL, nDec, nRou, nVdv )
            end

            if empty( nPrc ) .OR. nPrc == 2
               nCalculo += nTotLDos( cTikL, nDec, nRou, nVdv )
            end

            nCalculo    -= Round( nCalculo / ( 1 + ( cTikL )->nIvaTil / 100 ), nDec )

         end

      case ValType( cTikL ) == "O"

         if cTikL:nIvaTil <> 0

            if empty( nPrc ) .OR. nPrc == 1
               nCalculo += nTotLUno( cTikL:cAlias, nDec, nRou, nVdv )
            end

            if empty( nPrc ) .OR. nPrc == 2
               nCalculo += nTotLDos( cTikL:cAlias, nDec, nRou, nVdv )
            end

            nCalculo    -= Round( nCalculo / ( 1 + ( cTikL:cAlias )->nIvaTil / 100 ), nDec )

         end

   end

   do case
      case isChar( cTikT ) .AND. ( cTikT )->cTipTik == "4"
         nCalculo          := - nCalculo

      case isObject( cTikT ) .AND. cTikT:cTipTik == "4"
         nCalculo          := - nCalculo

   end

   if nCalculo <> 0 .AND. nVdv <> 0
      nCalculo             := nCalculo / nVdv
   end

Return ( Round( nCalculo, nRou ) )







Function nNetLTpv( dbfTmpL, nDec, nRou, nVdv )

   local nCalculo    := 0

   If( dbfTmpL == nil, dbfTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;

   nCalculo          := nTotLTpv( dbfTmpL, nDec, nRou, nVdv )

   if ( dbfTmpL )->nIvaTil <> 0
      nCalculo       := nCalculo / ( ( ( dbfTmpL )->nIvaTil / 100 ) + 1 )
   end

Return ( Round( nCalculo, nRou ) )



Static Function EdtCobTik( oWndBrw, lBig )

   local nOrd
   local nRec
   local aTmp
   local aGet
   local oBlock
   local oError
   local cSerAlb
   local cNumAlb
   local cSufAlb
   local cNumTik
   local cNumDoc
   local cCodCli
   local nOrdAnt
   local nDifVale    := 0
   local lGenVale    := .F.

   If( lBig == nil, lBig := .F., ) ;

   if ( ( D():Tikets( nView ) )->cTipTik == "5" )
      msgStop( "No se pueden realizar cobros sobre tickets apartados.")
      return nil
   end

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   aTmp              := dbScatter( D():Tikets( nView ) )
   aGet              := Array( ( D():Tikets( nView ) )->( fCount() ) )
   cNumTik           := ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik
   cCodCli           := ( D():Tikets( nView ) )->cCliTik
   cNumDoc           := ( D():Tikets( nView ) )->cNumDoc
   nOrdAnt           := ( D():Tikets( nView ) )->( ordsetfocus( "cNumTik" ) )

   nCopTik           := nCopiasTicketsEnCaja( Application():CodigoCaja(), dbfCajT )





   oTotDiv           := TotalesTPV():Init()





   cNewFilP          := cGetNewFileName( cPatTmp() + "TikP"  )
   dbCreate( cNewFilP, aSqlStruct( aPgoTik() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cNewFilP, cCheckArea( "TikP", @dbfTmpP ), .F. )





   cNewFilV          := cGetNewFileName( cPatTmp() + "TikV"  )
   dbCreate( cNewFilV, aSqlStruct( aItmTik() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cNewFilV, cCheckArea( "TikV", @dbfTmpV ), .F. )





   cNewFilA          := cGetNewFileName( cPatTmp() + "TikA"  )
   dbCreate( cNewFilA, aSqlStruct( aItmAntCli() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cNewFilA, cCheckArea( "TikA", @dbfTmpA ), .F. )





   cNewFilE          := cGetNewFileName( cPatTmp() + "TikE"  )
   dbCreate( cNewFilE, aSqlStruct( aItmAlbPgo() ), cLocalDriver() )
   dbUseArea( .T., cLocalDriver(), cNewFilE, cCheckArea( "TikE", @dbfTmpE ), .F. )

   do case
   case ( D():Tikets( nView ) )->cTipTik == "2"

      aTmp[ 22 ]  := nTotAlbCli( cNumDoc, dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv, nil, nil, .F. )





      nRec              := ( dbfAlbCliP )->( Recno() )
      nOrd              := ( dbfAlbCliP )->( ordsetfocus( "NNUMALB" ) )

      if ( dbfAlbCliP )->( dbSeek( ( D():Tikets( nView ) )->cNumDoc ) )
         while ( ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb ) == cNumDoc .AND. !( dbfAlbCliP )->( eof() )
            dbPass( dbfAlbCliP, dbfTmpE, .T. )
            ( dbfAlbCliP )->( dbSkip() )
         end
      end
      ( dbfTmpE )->( dbGoTop() )

      ( dbfAlbCliP )->( ordsetfocus( nOrd ) )
      ( dbfAlbCliP )->( dbGoTo( nRec ) )

   case ( D():Tikets( nView ) )->cTipTik == "3"

      aTmp[ 22 ]  := nTotFacCli( cNumDoc, dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, nil, nil, .F. )





      if ( dbfFacCliP )->( dbSeek( cNumDoc ) )
         while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == cNumDoc .AND. !( dbfFacCliP )->( eof() )
            if ( dbfFacCliP )->lCobrado
               ( dbfTmpP )->( dbAppend() )
               ( dbfTmpP )->cCodCaj    := ( dbfFacCliP )->cCodCaj
               ( dbfTmpP )->dPgoTik    := ( dbfFacCliP )->dEntrada
               ( dbfTmpP )->nImpTik    := ( dbfFacCliP )->nImporte
               ( dbfTmpP )->cDivPgo    := ( dbfFacCliP )->cDivPgo
               ( dbfTmpP )->nVdvPgo    := ( dbfFacCliP )->nVdvPgo
               ( dbfTmpP )->cPgdPor    := ( dbfFacCliP )->cPgdoPor
               ( dbfTmpP )->cTurPgo    := ( dbfFacCliP )->cTurRec
               ( dbfTmpP )->cCtaRec    := ( dbfFacCliP )->cCtaRec
               ( dbfTmpP )->cFpgPgo    := ( dbfFacCliP )->cCodPgo
            end
            ( dbfFacCliP )->( dbSkip() )
         end
      end

      ( dbfTmpP )->( dbGoTop() )





      nRec  := ( dbfAntCliT )->( Recno() )
      nOrd  := ( dbfAntCliT )->( ordsetfocus( "cNumDoc" ) )

      if ( dbfAntCliT )->( dbSeek( cNumDoc ) )
         while ( dbfAntCliT )->cNumDoc == cNumDoc .AND. !( dbfAntCliT )->( eof() )
            dbPass( dbfAntCliT, dbfTmpA, .T. )
            ( dbfAntCliT )->( dbSkip() )
         end
      end
      ( dbfTmpA )->( dbGoTop() )

      ( dbfAntCliT )->( ordsetfocus( nOrd ) )
      ( dbfAntCliT )->( dbGoTo( nRec ) )

   otherwise

      aTmp[ 22 ]  := nTotTik( cNumTik, D():Tikets( nView ), dbfTikL, dbfDiv, nil, nil, .F. )





      if ( dbfTikP )->( dbSeek( cNumTik ) )
         while ( ( dbfTikP )->cSerTik + ( dbfTikP )->cNumTik + ( dbfTikP )->cSufTik == cNumTik .AND. !( dbfTikP )->( eof() ) )
            dbPass( dbfTikP, dbfTmpP, .T. )
            ( dbfTikP )->( dbSkip() )
         end
      end

      ( dbfTmpP )->( dbGoTop() )





      nRec     := ( D():Tikets( nView ) )->( Recno() )
      nOrd     := ( D():Tikets( nView ) )->( ordsetfocus( "cDocVal" ) )

      if ( D():Tikets( nView ) )->( dbSeek( cNumTik ) )
         while ( D():Tikets( nView ) )->cValDoc == cNumTik .AND. !( D():Tikets( nView ) )->( eof() )
            dbPass( D():Tikets( nView ), dbfTmpV, .T. )
            ( D():Tikets( nView ) )->( dbSkip() )
         end
      end

      ( D():Tikets( nView ) )->( dbGoTo( nRec ) )
      ( D():Tikets( nView ) )->( ordsetfocus( nOrd ) )

      ( dbfTmpV )->( dbGoTop() )

   end





   if lCobro( @aTmp, aGet, aTmp[ 4 ], 2, @lGenVale, @nDifVale, lBig )





      if ( oTotDiv:lValeMayorTotal() )

         if aTmp[ 22 ] <> 0

            if dbAppe( dbfTmpP )
               ( dbfTmpP )->cCtaRec    := cCtaCob()
               ( dbfTmpP )->cTurPgo    := cCurSesion()
               ( dbfTmpP )->dPgoTik    := GetSysDate()
               ( dbfTmpP )->cTimTik    := SubStr( Time(), 1, 5 )
               ( dbfTmpP )->cCodCaj    := Application():CodigoCaja()
               ( dbfTmpP )->cFpgPgo    := aTmp[ 21 ]
               ( dbfTmpP )->cSerTik    := aTmp[ 1 ]
               ( dbfTmpP )->cNumTik    := aTmp[ 2 ]
               ( dbfTmpP )->cSufTik    := aTmp[ 3 ]
               ( dbfTmpP )->nImpTik    := aTmp[ 22 ]
               ( dbfTmpP )->cDivPgo    := aTmp[ 24 ]
               ( dbfTmpP )->nVdvPgo    := aTmp[ 25 ]
               ( dbfTmpP )->nDevTik    := Max( aTmp[ 23 ], 0 )
            else
               MsgStop( "No se ha podido añadir el registro de pago" )
            end

         end

      end

      do case
      case ( D():Tikets( nView ) )->cTipTik == "1" .OR. ( D():Tikets( nView ) )->cTipTik == "4" .OR. ( D():Tikets( nView ) )->cTipTik == "5"





         while ( dbfTikP )->( dbSeek( cNumTik ) )
            if dbLock( dbfTikP )
               ( dbfTikP )->( dbDelete() )
               ( dbfTikP )->( dbUnLock() )
            end
         end





         ( dbfTmpP )->( dbGoTop() )
         while !( dbfTmpP )->( eof() )
            dbPass( dbfTmpP, dbfTikP, .T. )
            ( dbfTmpP )->( dbSkip() )
         end





         nOrd  := ( D():Tikets( nView ) )->( ordsetfocus( "cDocVal" ) )
         nRec  := ( D():Tikets( nView ) )->( Recno() )

         while ( D():Tikets( nView ) )->( dbSeek( cNumTik ) ) .AND. !( D():Tikets( nView ) )->( eof() )
            if dbLock( D():Tikets( nView ) )
               ( D():Tikets( nView ) )->lLiqTik := .F.
               ( D():Tikets( nView ) )->lSndDoc := .T.
               ( D():Tikets( nView ) )->cValDoc := ""
               ( D():Tikets( nView ) )->cTurVal := ""
               ( D():Tikets( nView ) )->( dbUnLock() )
            end
         end

         ( D():Tikets( nView ) )->( ordsetfocus( nOrd ) )
         ( D():Tikets( nView ) )->( dbGoTo( nRec ) )





         nRec  := ( D():Tikets( nView ) )->( Recno() )

         ( dbfTmpV )->( dbGoTop() )
         while !( dbfTmpV )->( eof() )
            if ( D():Tikets( nView ) )->( dbSeek( ( dbfTmpV )->cSerTik + ( dbfTmpV )->cNumTik + ( dbfTmpV )->cSufTik ) )
               if dbLock( D():Tikets( nView ) )
                  ( D():Tikets( nView ) )->lLiqTik := .T.
                  ( D():Tikets( nView ) )->lSndDoc := .T.
                  ( D():Tikets( nView ) )->cValDoc := cNumTik
                  ( D():Tikets( nView ) )->cTurVal := cCurSesion()
                  ( D():Tikets( nView ) )->( dbUnLock() )
               end
            end
            ( dbfTmpV )->( dbSkip() )
         end

         ( D():Tikets( nView ) )->( dbGoTo( nRec ) )

      case ( D():Tikets( nView ) )->cTipTik == "3"

         cSerAlb     := SubStr( cNumDoc, 1, 1 )
         cNumAlb     := Val( SubStr( cNumDoc, 2, 9 ) )
         cSufAlb     := SubStr( cNumDoc, 11, 2 )

         while ( dbfFacCliP )->( dbSeek( cNumDoc ) ) .AND. !( dbfFacCliP )->( eof() )
            if dbLock( dbfFacCliP )
               ( dbfFacCliP )->( dbDelete() )
               ( dbfFacCliP )->( dbUnLock() )
            end
         end





         ( dbfTmpP )->( dbGoTop() )
         while !( dbfTmpP )->( eof() )

            if dbAppe( dbfFacCliP )
               ( dbfFacCliP )->cSerie     := cSerAlb
               ( dbfFacCliP )->nNumFac    := cNumAlb
               ( dbfFacCliP )->cSufFac    := cSufAlb
               ( dbfFacCliP )->lCobrado   := .T.
               ( dbfFacCliP )->cCodCaj    := Application():CodigoCaja()
               ( dbfFacCliP )->cCodCli    := cCodCli
               ( dbfFacCliP )->dPreCob    := GetSysDate()
               ( dbfFacCliP )->nNumRec    := ( dbfTmpP )->( Recno() )
               ( dbfFacCliP )->dEntrada   := ( dbfTmpP )->dPgoTik
               ( dbfFacCliP )->cDivPgo    := ( dbfTmpP )->cDivPgo
               ( dbfFacCliP )->nVdvPgo    := ( dbfTmpP )->nVdvPgo
               ( dbfFacCliP )->cPgdoPor   := ( dbfTmpP )->cPgdPor
               ( dbfFacCliP )->nImporte   := nTotUCobTik( dbfTmpP )
               ( dbfFacCliP )->( dbUnLock() )
            end

            ( dbfTmpP )->( dbSkip() )

         end





         nRec  := ( dbfAntCliT )->( Recno() )
         nOrd  := ( dbfAntCliT )->( ordsetfocus( "cNumDoc" ) )

         While ( dbfAntCliT )->( dbSeek( cNumDoc ) ) .AND. !( dbfAntCliT )->( eof() )
            if dbLock( dbfAntCliT )
               ( dbfAntCliT )->lLiquidada := .F.
               ( dbfAntCliT )->dLiquidada := Ctod("")
               ( dbfAntCliT )->cTurLiq    := ""
               ( dbfAntCliT )->cCajLiq    := ""
               ( dbfAntCliT )->cNumDoc    := ""
               ( dbfAntCliT )->( dbUnLock() )
            end
         end

         ( dbfAntCliT )->( ordsetfocus( nOrd ) )
         ( dbfAntCliT )->( dbGoTo( nRec ) )





         ( dbfTmpA )->( dbGoTop() )
         while !( dbfTmpA )->( eof() )
            if ( dbfAntCliT )->( dbSeek( ( dbfTmpA )->cSerAnt + Str( ( dbfTmpA )->nNumAnt ) + ( dbfTmpA )->cSufAnt ) )
               if dbLock( dbfAntCliT )
                  ( dbfAntCliT )->lLiquidada := .T.
                  ( dbfAntCliT )->lSndDoc    := .T.
                  ( dbfAntCliT )->cNumDoc    := cNumDoc
                  ( dbfAntCliT )->dLiquidada := GetSysDate()
                  ( dbfAntCliT )->cTurLiq    := cCurSesion()
                  ( dbfAntCliT )->cCajLiq    := Application():CodigoCaja()
                  ( dbfAntCliT )->( dbUnLock() )
               end
            end

            ( dbfTmpA )->( dbSkip() )

         end

         if dbLock( dbfFacCliT )
            ( dbfFacCliT )->lSndDoc          := .T.
            ( dbfFacCliT )->( dbUnLock() )
         end





         ChkLqdFacCli( nil, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfIva, dbfDiv )

      case ( D():Tikets( nView ) )->cTipTik == "2"

         cSerAlb     := SubStr( cNumDoc, 1, 1 )
         cNumAlb     := Val( SubStr( cNumDoc, 2, 9 ) )
         cSufAlb     := SubStr( cNumDoc, 11, 2 )





         while ( dbfAlbCliP )->( dbSeek( cNumDoc ) ) .AND. !( dbfAlbCliP )->( eof() )
            if dbLock( dbfAlbCliP )
               ( dbfAlbCliP )->( dbDelete() )
               ( dbfAlbCliP )->( dbUnLock() )
            end
         end





         ( dbfTmpE )->( dbGoTop() )

         while !( dbfTmpE )->( eof() )

            ( dbfAlbCliP )->( dbAppend() )

            ( dbfAlbCliP )->cSerAlb    := cSerAlb
            ( dbfAlbCliP )->nNumAlb    := cNumAlb
            ( dbfAlbCliP )->cSufAlb    := cSufAlb
            ( dbfAlbCliP )->nNumRec    := ( dbfTmpE )->nNumRec
            ( dbfAlbCliP )->cCodCaj    := ( dbfTmpE )->cCodCaj
            ( dbfAlbCliP )->cTurRec    := ( dbfTmpE )->cTurRec
            ( dbfAlbCliP )->cCodCli    := ( dbfTmpE )->cCodCli
            ( dbfAlbCliP )->dEntrega   := ( dbfTmpE )->dEntrega
            ( dbfAlbCliP )->nImporte   := ( dbfTmpE )->nImporte
            ( dbfAlbCliP )->cDescrip   := ( dbfTmpE )->cDescrip
            ( dbfAlbCliP )->cPgdoPor   := ( dbfTmpE )->cPgdoPor
            ( dbfAlbCliP )->cDivPgo    := ( dbfTmpE )->cDivPgo
            ( dbfAlbCliP )->nVdvPgo    := ( dbfTmpE )->nVdvPgo
            ( dbfAlbCliP )->cCodAge    := ( dbfTmpE )->cCodAge
            ( dbfAlbCliP )->cCodPgo    := ( dbfTmpE )->cCodPgo
            ( dbfAlbCliP )->lPasado    := ( dbfTmpE )->lPasado
            ( dbfAlbCliP )->lCloPgo    := .F.

            ( dbfAlbCliP )->( dbUnLock() )

            ( dbfTmpE )->( dbSkip() )

         end

      end





      if ( D():Tikets( nView ) )->cTipTik <> "2"
         Application():openDirectCajon()
      end





      dbGather( aTmp, D():Tikets( nView ) )

   end

   ( D():Tikets( nView ) )->( ordsetfocus( nOrdAnt ) )

   RECOVER USING oError

      msgStop( "Imposible realizar pagos " + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !empty( dbfTmpP ) .AND. ( dbfTmpP )->( Used() )
      ( dbfTmpP )->( dbCloseArea() )
   end

   if !empty( dbfTmpV ) .AND. ( dbfTmpV )->( Used() )
      ( dbfTmpV )->( dbCloseArea() )
   end

   if !empty( dbfTmpA ) .AND. ( dbfTmpA )->( Used() )
      ( dbfTmpA )->( dbCloseArea() )
   end

   if !empty( dbfTmpE ) .AND. ( dbfTmpE )->( Used() )
      ( dbfTmpE )->( dbCloseArea() )
   end

   dbfErase( cNewFilP )
   dbfErase( cNewFilV )
   dbfErase( cNewFilA )
   dbfErase( cNewFilE )

   if !empty( oWndBrw )
      oWndBrw:oBrw:DrawSelect()
   end

return nil






Static Function TmpTiket( aTmp, aGet, nMode, lClean, lImprimirComanda, lLiberarMesa )

   local oError
   local oBlock
   local nRecno
   local cNumDoc                   := ""
   local nNumTik                     := ""
   local nOrdAlb

   If( lClean == nil, lClean := .T., ) ;
   If( lImprimirComanda == nil, lImprimirComanda := .T., ) ;
   If( lLiberarMesa == nil, lLiberarMesa := .F., ) ;





   if ( dbfTmpL )->( ordKeyCount() ) == 0 .AND. !lLiberarMesa
      return .T.
   end





   if !lValidaOperacion( aTmp[ 6 ] )
      return .F.
   end

   if !lValidaSerie( aTmp[ 1 ] )
      Return .F.
   end

   if !empty( aGet[ 11 ] ) .AND. !aGet[ 11 ]:lValid()
      aGet[ 11 ]:SetFocus()
      return .F.
   end

   if !empty( aGet[ 10 ] )

      if empty( aTmp[ 10 ] )
         aGet[ 10 ]:SetFocus()
         MsgInfo( "Almacén no puede estar vacio" )
         return .F.
      end

      if !( aGet[ 10 ]:lValid() )
         aGet[ 10 ]:SetFocus()
         return .F.
      end

   end





   StopAutoImp()





   if empty( aTmp[ 1 ] )
      aTmp[ 1 ]     := "A"
   end





   if empty( aTmp[ 5 ] )
      aTmp[ 5 ]     := cCurSesion()
   end

   if empty( aTmp[ 4 ] )
      aTmp[ 4 ]     := "1"
   end

   if empty( aTmp[ 40 ] )
      aTmp[ 40 ]     := Date()
   end

   if empty( aTmp[ 41 ] )
      aTmp[ 41 ]     := SubStr( Time(), 1, 5 )
   end





   nTotTik                 := nTotTik( aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ], D():Tikets( nView ), dbfTmpL, dbfDiv, aTmp, nil, .F. )
   nTotPax                 := nTotTik / NotCero( aTmp[ 52 ] )

   aTmp[ 23 ]        := 0
   aTmp[ 22 ]        := nTotTik





   oBlock                  := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      oDlgTpv:Disable()





      do case
      case nMode == 1





         if !empty( oMetMsg )
            oMetMsg:cText           := "Obtenemos el nuevo número"
            oMetMsg:Refresh()
         end

         aTmp[ 2 ]           := Str( nNewDoc( aTmp[ 1 ], D():Tikets( nView ), "nTikCli", 10, dbfCount ), 10 )
         aTmp[ 3 ]           := RetSufEmp()
         nNumTik                    := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]





         aTmp[ 7 ]           := Substr( Time(), 1, 5 )
         aTmp[ 26 ]           := .F.

      case nMode == 2

         nNumTik                    := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]
         cNumDoc                    := aTmp[ 31 ]





         if !( D():Tikets( nView ) )->( dbSeek( nNumTik ) )
            if !empty( oMetMsg )
               oMetMsg:cText  := "Ticket no encontrado"
               oMetMsg:Refresh()
            end
         end





         if !empty( oMetMsg )
            oMetMsg:cText     := "Eliminando lineas"
            oMetMsg:Refresh()
         end

         while dbSeekInOrd( nNumTik, "cNumTil", dbfTikL )
            if dbLock( dbfTikL )
               ( dbfTikL )->( dbDelete() )
               ( dbfTikL )->( dbUnLock() )
            end
         end

      end





      if !empty( oMetMsg )
         oMetMsg:cText        := "Archivando lineas"
         oMetMsg:SetTotal( ( dbfTmpL )->( ordKeyCount() ) )
      end

      nRecno               := ( dbfTmpL )->( Recno() )

      ( dbfTmpL )->( dbGoTop() )
      while !( dbfTmpL )->( eof() )

         if !empty( oMetMsg )
            oMetMsg:Set( ( dbfTmpL )->( Recno() ) )
         end

         dbPass( dbfTmpL, dbfTikL, .T., aTmp[ 1 ], aTmp[ 2 ], aTmp[ 3 ] )

         ( dbfTmpL )->( dbSkip() )

      end

      ( dbfTmpL )->( dbGoTo( nRecno ) )





      if !empty( oMetMsg )
         oMetMsg:Set( 0 )
         oMetMsg:cText        := "Archivando ticket"
         oMetMsg:Refresh()
      end

      WinGather( aTmp, aGet, D():Tikets( nView ), nil, nMode, nil, lClean )





      dbCommitAll()





      oDlgTpv:Enable()
      oDlgTpv:aEvalWhen()





   RECOVER USING oError

      msgStop( "Error en la grabación del ticket" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )





   StartAutoImp()

Return ( .T. )



Static Function DlgPrnTicket( oBrw )

   local oDlg
   local oSelTik
   local nSelTik     := 1
   local nOrdAnt     := ( D():Tikets( nView ) )->( ordsetfocus( 1 ) )
   local nRecAnt     := ( D():Tikets( nView ) )->( RecNo() )
   local oSerDes
   local cSerDes     := ( D():Tikets( nView ) )->cSerTik
   local cNumDes     := Val( ( D():Tikets( nView ) )->cNumTik )
   local cSufDes     := ( D():Tikets( nView ) )->cSufTik
   local oSerHas
   local cSerHas     := ( D():Tikets( nView ) )->cSerTik
   local cNumHas     := Val( ( D():Tikets( nView ) )->cNumTik )
   local cSufHas     := ( D():Tikets( nView ) )->cSufTik
   local dFecDes     := ( D():Tikets( nView ) )->dFecTik
   local dFecHas     := ( D():Tikets( nView ) )->dFecTik
   local lInvOrden   := .F.

   local oDatos      := TFormatosImpresion():Load( dbfCajT )

   oDlg = TDialog():New(,,,,, "PRNTICKET",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




        oSelTik := TRadMenu():Redefine( { | u | If( PCount()==0, nSelTik, nSelTik:= u ) }, oDlg,, { 101, 102 }, {||( ( D():Tikets( nView ) )->( ordsetfocus( nSelTik ) ) )},,,, .F.,, )








      oSerDes := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerDes, cSerDes:= u ) }, oDlg,,, {||    ( cSerDes >= "A" .AND. cSerDes <= "Z"  )},,,,,, .F., {||         ( nSelTik == 1 )},, .F., .T., {||    ( UpSerie( oSerDes ) )}, {||  ( DwSerie( oSerDes ) )},,,, nil,,, )






        TGetHlp():ReDefine( 120, { | u | If( PCount()==0, cNumDes, cNumDes:= u ) }, oDlg,, "9999999999",,,,,,, .F., {||     ( nSelTik == 1 )},, .F., .T.,,,,,, nil,,, )




        TGetHlp():ReDefine( 130, { | u | If( PCount()==0, cSufDes, cSufDes:= u ) }, oDlg,,,,,,,,, .F., {||         ( nSelTik == 1 )},, .F., .F.,,,,,, nil,,, )









      oSerHas := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSerHas, cSerHas:= u ) }, oDlg,,, {||    ( cSerHas >= "A" .AND. cSerHas <= "Z"  )}, "N/W*",,,,, .F., {||     ( nSelTik == 1 )},, .F., .T., {||    ( UpSerie( oSerHas ) )}, {||  ( DwSerie( oSerHas ) )},,,, nil,,, )






        TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cNumHas, cNumHas:= u ) }, oDlg,, "9999999999",,,,,,, .F., {||         ( nSelTik == 1 )},, .F., .T.,,,,,, nil,,, )




        TGetHlp():ReDefine( 160, { | u | If( PCount()==0, cSufHas, cSufHas:= u ) }, oDlg,,,,,,,,, .F., {||     ( nSelTik == 1 )},, .F., .F.,,,,,, nil,,, )




        TGetHlp():ReDefine( 170, { | u | If( PCount()==0, dFecDes, dFecDes:= u ) }, oDlg,,,,,,,,, .F., {||         ( nSelTik == 2 )},, .F., .F.,,,,,, nil,,, )




        TGetHlp():ReDefine( 180, { | u | If( PCount()==0, dFecHas, dFecHas:= u ) }, oDlg,,,,,,,,, .F., {||         ( nSelTik == 2 )},, .F., .F.,,,,,, nil,,, )










      oDatos:oFormatoTiket := TGetHlp():ReDefine( 251, { | u | If( PCount()==0, oDatos:cFormatoTiket, oDatos:cFormatoTiket:= u ) }, oDlg,,, {||    ( cDocumento( oDatos:oFormatoTiket, oDatos:oSayFmtTik, dbfDoc ) )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oDatos:oFormatoTiket, oDatos:oSayFmtTik, "TK" ) )}, nil, "LUPA",, )




      oDatos:oSayFmtTik := TGetHlp():ReDefine( 252, { | u | If( PCount()==0, oDatos:cSayFmtTik, oDatos:cSayFmtTik:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oDatos:oPrinterTik := TGetHlp():ReDefine( 253, { | u | If( PCount()==0, oDatos:cPrinterTik, oDatos:cPrinterTik:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      TBtnBmp():ReDefine( 254, "gc_printer2_check_16",,,,,{|| PrinterPreferences( oDatos:oPrinterTik ) }, oDlg, .F., , .F.,  )

      TBtnBmp():ReDefine( 255, "gc_document_text_pencil_12",,,,,{|| EdtDocumento( oDatos:cFormatoTiket ) }, oDlg, .F., , .F.,  )










      oDatos:oFmtVal := TGetHlp():ReDefine( 261, { | u | If( PCount()==0, oDatos:cFmtVal, oDatos:cFmtVal:= u ) }, oDlg,,, {||    ( cDocumento( oDatos:oFmtVal, oDatos:oSayFmtVal, dbfDoc ) )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwDocumento( oDatos:oFmtVal, oDatos:oSayFmtVal, "TK" ) )}, nil, "LUPA",, )




      oDatos:oSayFmtVal := TGetHlp():ReDefine( 262, { | u | If( PCount()==0, oDatos:cSayFmtVal, oDatos:cSayFmtVal:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )




      oDatos:oPrinterVal := TGetHlp():ReDefine( 263, { | u | If( PCount()==0, oDatos:cPrinterVal, oDatos:cPrinterVal:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )

      TBtnBmp():ReDefine( 264, "gc_printer2_check_16",,,,,{|| PrinterPreferences( oDatos:oPrinterVal ) }, oDlg, .F., , .F.,  )

      TBtnBmp():ReDefine( 265, "gc_document_text_pencil_12",,,,,{|| EdtDocumento( oDatos:cFmtVal ) }, oDlg, .F., , .F.,  )



      TCheckBox():ReDefine( 500, { | u | If( PCount()==0, lInvOrden, lInvOrden:= u ) }, oDlg,,,,,,, .F.,, .F. )





      TButton():ReDefine( 505, {||(  PrnSerTik( nSelTik, cSerDes + Str( cNumDes ) + cSufDes, cSerHas + Str( cNumHas ) + cSufHas, dFecDes, dFecHas, oDlg, lInvOrden, oDatos ), oDlg:End( 1 ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 510, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| PrnSerTik( nSelTik, cSerDes + Str( cNumDes ) + cSufDes, cSerHas + Str( cNumHas ) + cSufHas, dFecDes, dFecHas, oDlg, lInvOrden, oDatos ), oDlg:End( 1 ) } )

   oDlg:bStart := { || oSerDes:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

    ( D():Tikets( nView ) )->( ordsetfocus( nOrdAnt ) )
    ( D():Tikets( nView ) )->( dbGoTo( nRecAnt ) )

    oBrw:refresh()

Return ( oDlg:nResult == 1 )







Static Function PrnSerTik( nSelTik, cNumDes, cNumHas, dFecDes, dFecHas, oDlg, lInvOrden, oDatos )

   local oBlock
   local oError
   local nOrdAnt
   local uNumDes
   local uNumHas
   local nRecAnt

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   nRecAnt           := ( D():Tikets( nView ) )->( RecNo() )

   If( nSelTik == nil, nSelTik := 1, ) ;
   If( cNumDes == nil, cNumDes := ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik, ) ;
   If( cNumHas == nil, cNumHas := ( D():Tikets( nView ) )->cSerTik + ( D():Tikets( nView ) )->cNumTik + ( D():Tikets( nView ) )->cSufTik, ) ;

   if nSelTik == 1
      nOrdAnt        := ( D():Tikets( nView ) )->( ordsetfocus( "cNumTik" ) )
      uNumDes        := cNumDes
      uNumHas        := cNumHas
   else
      nOrdAnt        := ( D():Tikets( nView ) )->( ordsetfocus( "dFecTik" ) )
      uNumDes        := dFecDes
      uNumHas        := dFecHas
   end

   if !empty( oDlg )
      oDlg:Disable()
   end

   if !lInvOrden

      if ( D():Tikets( nView ) )->( dbSeek( uNumDes, .T. ) )



         while !( D():Tikets( nView ) )->( eof() )                    .AND. ( D():Tikets( nView ) )->( OrdKeyVal() ) >= uNumDes   .AND. ( D():Tikets( nView ) )->( OrdKeyVal() ) <= uNumHas

            ImpTiket( 1, , .T., , oDatos )

            ( D():Tikets( nView ) )->( dbSkip() )

         end

      end

   else

      if ( D():Tikets( nView ) )->( dbSeek( uNumHas ) )



         while ( D():Tikets( nView ) )->( OrdKeyVal() ) >= uNumDes   .AND. ( D():Tikets( nView ) )->( OrdKeyVal() ) <= uNumHas   .AND. !( D():Tikets( nView ) )->( Bof() )

            ImpTiket( 1, , .T., , oDatos )

            ( D():Tikets( nView ) )->( dbSkip( -1 ) )

         end

      end

   end

   if !empty( oDlg )
      oDlg:Enable()
   end

   ( D():Tikets( nView ) )->( dbGoTo( nRecAnt ) )
   ( D():Tikets( nView ) )->( ordsetfocus( nOrdAnt ) )

   RECOVER USING oError

   msgStop( "Error al imprimir series de tickets.")

   end

   ErrorBlock( oBlock )

Return nil



FUNCTION nTotComTik( cNumTik, cTikT, dbfTikL, nDouDiv, nDorDiv )

   local nTotal      := 0
   local nRecno      := ( dbfTikL )->( RecNo() )

   if ( dbfTikL )->( dbSeek( cNumTik ) )

      while ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil == cNumTik .AND. !( dbfTikL )->( eof() )

         if !( dbfTikL )->lFreTil .OR. ( cTikT )->cTipTik == "4"

            nTotal   += nTotLTpv( dbfTikL, nDouDiv, nDorDiv ) * ( cTikT )->nComAge

         end

         ( dbftikl )->( dbskip(1) )

      end

   end

   ( dbfTikL )->( dbGoTo( nRecno ) )





   nTotal            := Round( nTotal, nDorDiv )

Return ( nTotal )



Function aTotTik( cNumTik, cTikT, dbfTikL, dbfDiv, aTmp, cDivRet, lPic, lExcCnt )

   nTotTik( cNumTik, cTikT, dbfTikL, dbfDiv, aTmp, cDivRet, lPic, lExcCnt )

Return ( { nTotNet, nTotIva, nTotTik, nTotIvm, aIvaTik, aBasTik, aImpTik, aIvmTik } )



Static Function bButtonsPago( cCodPago, oGetPago )

Return ( {|| oGetPago:cText( cCodPago ), oGetPago:lValid() } )

Static Function bButtonsGrad( oButton )







   oButton:bClrGrad  := { | lInvert |  If( lInvert .OR. oButton:lBtnDown,  { { 1/3, nRGB( 255, 253, 222 ), nRGB( 255, 231, 151 ) },  { 2/3, nRGB( 255, 215,  84 ), nRGB( 255, 233, 162 ) }   },  { { 1/2, nRGB( 219, 230, 244 ), nRGB( 207-50, 221-25, 255 ) },  { 1/2, nRGB( 201-50, 217-25, 255 ), nRGB( 231, 242, 255 ) }   } ) }

Return ( nil )





Function nTotLCobTik( dbfTikP, dbfDiv, cDivRet, lPic )

   local cPorDiv
   local nDorDiv
   local cCodDiv
   local nTotal      := 0

   If( lPic == nil, lPic := .F., ) ;

   do case
      case Valtype( dbfTikP ) == "C"
         cCodDiv     := ( dbfTikP )->cDivPgo
      case Valtype( dbfTikP ) == "O"
         cCodDiv     := dbfTikP:cDivPgo
   end

   cPorDiv           := cPorDiv( cCodDiv, dbfDiv )
   nDorDiv           := nRouDiv( cCodDiv, dbfDiv )

   nTotal            := nTotUCobTik( dbfTikP, nDorDiv )

   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      cPorDiv        := cPorDiv( cDivRet, dbfDiv )
      nTotal         := nCnv2Div( nTotal, cCodDiv, cDivRet )
   end

   if lPic
      nTotal         := Trans( nTotal, cPorDiv )
   end

Return ( nTotal )






Function nImpValTik( cNumTik, cTikT, cTikL, cDiv, cDivRet )

   local cPorDiv
   local nDorDiv
   local nOrdAnt
   local cCodDiv
   local nRecAnt
   local nLinAnt
   local nTotTik      := 0

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( cNumTik == nil, cNumTik := ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, ) ;

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @cTikL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "TikeL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   cCodDiv           := ( cTikT )->cDivTik
   nRecAnt           := ( cTikT )->( Recno() )
   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   nDorDiv           := nRouDiv( cCodDiv, cDiv )

   nOrdAnt           := ( cTikT )->( ordsetfocus( "cTikVal" ) )

   if ( cTikT )->( dbSeek( cNumTik ) )

      while ( cTikT )->cTikVal == cNumTik .AND. !( cTikT )->( eof() )

         nTotTik     += nTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, cTikL, cDiv, nil, cDivRet, .F. )

         ( cTikT )->( dbSkip() )

      end

   end

   ( cTikT )->( ordsetfocus( nOrdAnt ) )





   ( cTikT )->( dbGoTo( nRecAnt ) )
   ( cTikT )->( ordsetfocus( nOrdAnt ) )

   ( cTikL )->( dbCloseArea() )





   nTotTik            := Abs( Round( nTotTik, nDorDiv ) )





   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      cPorDiv        := cPorDiv( cDivRet, cDiv )
      nTotTik        := nCnv2Div( nTotTik, cCodDiv, cDivRet )
   end

Return ( nTotTik )







Function nImpValCli( cCliTik, cTikT, cTikL, cDiv, cDivRet )

   local cPorDiv
   local nDorDiv
   local nOrdAnt
   local cCodDiv
   local nRecAnt
   local nLinAnt
   local nTotTik      := 0

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( cCliTik == nil, cCliTik := ( cTikT )->cCliTik, ) ;

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @cTikL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "TikeL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   cCodDiv           := ( cTikT )->cDivTik
   nRecAnt           := ( cTikT )->( Recno() )
   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   nDorDiv           := nRouDiv( cCodDiv, cDiv )

   nOrdAnt           := ( cTikT )->( ordsetfocus( "cCliVal" ) )
   if ( cTikT )->( dbSeek( cCliTik ) )

      while ( cTikT )->cCliTik == cCliTik .AND. !( cTikT )->( eof() )

         nTotTik     += nTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, cTikL, cDiv, nil, cDivRet, .F. )

         ( cTikT )->( dbSkip() )

      end

   end

   ( cTikT )->( ordsetfocus( nOrdAnt ) )





   ( cTikT )->( dbGoTo( nRecAnt ) )
   ( cTikT )->( ordsetfocus( nOrdAnt ) )

   ( cTikL )->( dbCloseArea() )





   nTotTik            := Abs( Round( nTotTik, nDorDiv ) )





   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      cPorDiv        := cPorDiv( cDivRet, cDiv )
      nTotTik        := nCnv2Div( nTotTik, cCodDiv, cDivRet )
   end

Return ( nTotTik )







Function nTotValTik( cNumTik, cTikT, cTikL, cDiv, cDivRet, lPic )

   local cPorDiv
   local nDorDiv
   local nOrdAnt
   local cCodDiv
   local nRecAnt
   local nTotal      := 0

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;
   If( cTikL == nil, cTikL := dbfTikL, ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( lPic == nil, lPic := .F., ) ;
   If( cNumTik == nil, cNumTik := ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, ) ;

   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   nDorDiv           := nRouDiv( cCodDiv, cDiv )

   cCodDiv           := ( cTikT )->cDivTik

   nRecAnt           := ( cTikT )->( Recno() )
   nOrdAnt           := ( cTikT )->( ordsetfocus( "cDocVal" ) )

   if ( cTikT )->( dbSeek( cNumTik ) )

      while ( cTikT )->cValDoc == cNumTik .AND. !( cTikT )->( eof() )

         nTotal      += nTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, cTikL )

         ( cTikT )->( dbSkip() )

      end

   end

   ( cTikT )->( ordsetfocus( nOrdAnt ) )
   ( cTikT )->( dbGoTo( nRecAnt ) )





   nTotal            := Abs( Round( nTotal, nDorDiv ) )





   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      cPorDiv        := cPorDiv( cDivRet, cDiv )
      nTotal         := nCnv2Div( nTotal, cCodDiv, cDivRet )
   end

Return ( if( lPic, Trans( nTotal, cPorDiv ), nTotal ) )







Function nTotValTikInfo( cNumTik, cTikT, cDiv, cDivRet, lPic )

   local cPorDiv
   local nDorDiv
   local nOrdAnt
   local cCodDiv
   local nRecAnt
   local nTotal      := 0
   local dbfTmpTikL

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( lPic == nil, lPic := .F., ) ;
   If( cNumTik == nil, cNumTik := ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, ) ;





   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTmpTikL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "TikeL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end
   ( dbfTmpTikL )->( ordsetfocus( "cNumTil" ) )

   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   nDorDiv           := nRouDiv( cCodDiv, cDiv )

   cCodDiv           := ( cTikT )->cDivTik

   nRecAnt           := ( cTikT )->( Recno() )
   nOrdAnt           := ( cTikT )->( ordsetfocus( "cDocVal" ) )

   if ( cTikT )->( dbSeek( cNumTik ) )

      while ( cTikT )->cValDoc == cNumTik .AND. !( cTikT )->( eof() )

         nTotal      += nTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, dbfTmpTikL )

         ( cTikT )->( dbSkip() )

      end

   end

   ( cTikT )->( ordsetfocus( nOrdAnt ) )
   ( cTikT )->( dbGoTo( nRecAnt ) )





   nTotal            := Abs( Round( nTotal, nDorDiv ) )





   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      cPorDiv        := cPorDiv( cDivRet, cDiv )
      nTotal         := nCnv2Div( nTotal, cCodDiv, cDivRet )
   end





   ( dbfTmpTikL )->( dbCloseArea() )

   dbfTmpTikL           := nil

Return ( if( lPic, Trans( nTotal, cPorDiv ), nTotal ) )



Function nTmpValTik( cTikT, cTikL, cDiv, cDivRet, lPic )

   local cPorDiv
   local nDorDiv
   local nOrdAnt
   local nTotal      := 0
   local cCodDiv     := ( cTikT )->cDivTik
   local nRecAnt     := ( cTikT )->( Recno() )

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;
   If( cTikL == nil, cTikL := dbfTikL, ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( lPic == nil, lPic := .F., ) ;

   cPorDiv           := cPorDiv( cCodDiv, cDiv )
   nDorDiv           := nRouDiv( cCodDiv, cDiv )

   ( cTikT )->( dbGoTop() )
   while !( cTikT )->( eof() )
      nTotal      += nTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, cTikL, cDiv, nil, cDivRet, .F. )
      ( cTikT )->( dbSkip() )
   end





   ( cTikT )->( dbGoTo( nRecAnt ) )





   nTotal            := Abs( Round( nTotal, nDorDiv ) )





   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      cPorDiv        := cPorDiv( cDivRet, cDiv )
      nTotal         := nCnv2Div( nTotal, cCodDiv, cDivRet )
   end

Return ( if( lPic, Trans( nTotal, cPorDiv ), nTotal ) )




Static function BeginTrans( aTmp, aGet, nMode, lNewFile )

   local oError
   local oBlock
   local nRecAnt
   local nOrdAnt
   local lErrors        := .F.
   local cNumTik        := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]
   local cSerCli

   If( lNewFile == nil, lNewFile := .T., ) ;

   CursorWait()

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   if empty( aTmp[ 24 ] )
      aTmp[ 24 ]  := cDivEmp()
   end





   cPouDiv              := cPouDiv( aTmp[ 24 ], dbfDiv )
   cPorDiv              := cPorDiv( aTmp[ 24 ], dbfDiv )
   nDouDiv              := nDouDiv( aTmp[ 24 ], dbfDiv )
   nDorDiv              := nRouDiv( aTmp[ 24 ], dbfDiv )
   cPicEur              := cPorDiv( cDivChg(),        dbfDiv )





   lNowAppendLine       := .F.





   if lNewFile

      ( dbfTmpL   )->( dbCloseArea() )
      ( dbfTmpP   )->( dbCloseArea() )
      ( dbfTmpV   )->( dbCloseArea() )
      ( dbfTmpA   )->( dbCloseArea() )
      ( dbfTmpE   )->( dbCloseArea() )
      ( dbfTmpC   )->( dbCloseArea() )
      ( dbfTmpS   )->( dbCloseArea() )
      ( dbfTmpN   )->( dbCloseArea() )

      if !empty( cNewFilL )
         dbfErase( cNewFilL )
      end

      if !empty( cNewFilP )
         dbfErase( cNewFilP )
      end

      if !empty( cNewFilV )
         dbfErase( cNewFilV )
      end

      if !empty( cNewFilA )
         dbfErase( cNewFilA )
      end

      if !empty( cNewFilE )
         dbfErase( cNewFilE )
      end

      if !empty( cNewFilC )
         dbfErase( cNewFilC )
      end

      if !empty( cNewFilS )
         dbfErase( cNewFilS )
      end

      if !empty( cNewFilN )
         dbfErase( cNewFilN )
      end





      cNewFilL       := cGetNewFileName( cPatTmp() + "TikL" )
      dbCreate( cNewFilL, aSqlStruct( aColTik() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilL, cCheckArea( "TikL", @dbfTmpL ), .F. )
      if !NetErr()
         ( dbfTmpL )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpL )->( OrdCreate( cNewFilL, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      end





      cNewFilP       := cGetNewFileName( cPatTmp() + "TikP" )
      dbCreate( cNewFilP, aSqlStruct( aPgoTik() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilP, cCheckArea( "TikP", @dbfTmpP ), .F. )
      if !NetErr()
         ( dbfTmpP )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpP )->( OrdCreate( cNewFilP, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      end





      cNewFilV       := cGetNewFileName( cPatTmp() + "TikV"  )
      dbCreate( cNewFilV, aSqlStruct( aItmTik() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilV, cCheckArea( "TikV", @dbfTmpV ), .F. )
      if !NetErr()
         ( dbfTmpV )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpV )->( OrdCreate( cNewFilV, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      end





      cNewFilA       := cGetNewFileName( cPatTmp() + "TikA"  )
      dbCreate( cNewFilA, aSqlStruct( aItmAntCli() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilA, cCheckArea( "TikA", @dbfTmpA ), .F. )
      if !NetErr()
         ( dbfTmpA )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpA )->( OrdCreate( cNewFilA, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      end





      cNewFilE       := cGetNewFileName( cPatTmp() + "TikE"  )
      dbCreate( cNewFilE, aSqlStruct( aItmAlbPgo() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilE, cCheckArea( "TikE", @dbfTmpE ), .F. )
      if !NetErr()
         ( dbfTmpE )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpE )->( OrdCreate( cNewFilE, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
      end





      cNewFilC       := cGetNewFileName( cPatTmp() + "TikC" )
      dbCreate( cNewFilC, aSqlStruct( aColTik() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilC, cCheckArea( "TikC", @dbfTmpC ), .F. )
      if !NetErr()
         ( dbfTmpC )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpC )->( OrdCreate( cNewFilC, "CNUMTIL", "CSERTIL + CNUMTIL + CSUFTIL", {|| Field->cSerTil + Field->cNumTil + Field->cSufTil } ) )
      end





      cNewFilN       := cGetNewFileName( cPatTmp() + "TikN" )
      dbCreate( cNewFilN, aSqlStruct( aColTik() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilN, cCheckArea( "TikN", @dbfTmpN ), .F. )

      if !( dbfTmpN )->( netErr() )
         ( dbfTmpN )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpN )->( ordCreate( cNewFilN, "cNumTil", "cSerTil + cNumTil + cSufTil", {|| Field->cSerTil + Field->cNumTil + Field->cSufTil } ) )
      end





      cNewFilS       := cGetNewFileName( cPatTmp() + "TikS" )
      dbCreate( cNewFilS, aSqlStruct( aSerTik() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilS, cCheckArea( "TikS", @dbfTmpS ), .F. )
      if !NetErr()
         ( dbfTmpS )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpS )->( OrdCreate( cNewFilS, "nNumLin", "Str( nNumLin, 4 ) + cCbaTil", {|| Str( Field->nNumLin, 4 ) + Field->cCbaTil } ) )
      end

   else

      ( dbfTmpL   )->( __dbZap() )
      ( dbfTmpP   )->( __dbZap() )
      ( dbfTmpV   )->( __dbZap() )
      ( dbfTmpA   )->( __dbZap() )
      ( dbfTmpE   )->( __dbZap() )
      ( dbfTmpC   )->( __dbZap() )
      ( dbfTmpS   )->( __dbZap() )
      ( dbfTmpN   )->( __dbZap() )

      ( dbfTmpL   )->( dbGoTop() )
      ( dbfTmpP   )->( dbGoTop() )
      ( dbfTmpV   )->( dbGoTop() )
      ( dbfTmpA   )->( dbGoTop() )
      ( dbfTmpE   )->( dbGoTop() )
      ( dbfTmpC   )->( dbGoTop() )
      ( dbfTmpS   )->( dbGoTop() )
      ( dbfTmpN   )->( dbGoTop() )

   end

   do case
   case nMode == 1

      lApartado                        := .F.





      aTmp[ 27    ]              := .T.
      aTmp[ 50   ]              := .T.
      aTmp[ 28    ]              := .F.
      aTmp[ 26    ]              := .F.
      aTmp[ 4    ]              := "1"
      aTmp[ 5    ]              := cCurSesion()
      aTmp[ 3    ]              := RetSufEmp()
      aTmp[ 40    ]              := Date()
      aTmp[ 41    ]              := SubStr( Time(), 1, 5 )
      aTmp[ 6    ]              := getSysDate()
      aTmp[ 71    ]              := getSysTime()
      aTmp[ 51  ]              := ""
      aTmp[ 48   ]              := ""
      aTmp[ 49  ]              := ""
      aTmp[ 11    ]              := cDefCli()
      aTmp[ 13    ]              := RetFld( cDefCli(), dbfClient, "Titulo" )
      aTmp[ 14    ]              := RetFld( cDefCli(), dbfClient, "Domicilio" )
      aTmp[ 15    ]              := RetFld( cDefCli(), dbfClient, "Poblacion" )
      aTmp[ 16    ]              := RetFld( cDefCli(), dbfClient, "Provincia" )
      aTmp[ 18    ]              := RetFld( cDefCli(), dbfClient, "CodPostal" )
      aTmp[ 19    ]              := RetFld( cDefCli(), dbfClient, "Nif" )
      aTmp[ 70    ]              := RetFld( cDefCli(), dbfClient, "nRegIva" )
      aTmp[ 65    ]              := 0

      if !empty( RetFld( cDefCli(), dbfClient, "nTarifa" ) )
         if !empty( aGet[ 12 ] )
            aGet[ 12 ]:cText( RetFld( cDefCli(), dbfClient, "nTarifa" ) )
         else
            aTmp[ 12 ]           := RetFld( cDefCli(), dbfClient, "nTarifa" )
         end
      else
         aTmp[ 12    ]           := Max( uFieldEmpresa( "nPreVta" ), 1 )
      end

      if !empty( aGet[ 11 ] )
         aGet[ 11 ]:cText( cDefCli() )
      end

      if !empty( aGet[ 13 ] )
         aGet[ 13 ]:cText( RetFld( cDefCli(), dbfClient, "Titulo" ) )
      end





      cSerCli                 := RetFld( cDefCli(), dbfClient, "Serie" )

      if !empty( aGet[ 1 ] )
         if empty( cSerCli )
            aGet[ 1 ]:cText( cNewSer( "nTikCli", dbfCount ) )
         else
            aGet[ 1 ]:cText( cSerCli )
         end
      else
         if empty( cSerCli )
            aTmp[ 1 ]  := cNewSer( "nTikCli", dbfCount )
         else
            aTmp[ 1 ]  := cSerCli
         end
      end

      if !empty( oGrupoSerie )
         oGrupoSerie:cPrompt  := "Serie: " + aTmp[ 1 ]
      end

      if !empty( aGet[ 9 ] )
         aGet[ 9 ]:cText( Application():CodigoCaja() )
      else
         aTmp[ 9 ]     := Application():CodigoCaja()
      end

      if !empty( aGet[ 21 ] )
         aGet[ 21 ]:cText( cDefFpg() )
      else
         aTmp[ 21 ]     := cDefFpg()
      end

      if !empty( aGet[ 10 ] )
         aGet[ 10 ]:cText( Application():codigoAlmacen() )
      else
         aTmp[ 10 ]     := Application():codigoAlmacen()
      end

      if !empty( aGet[ 8 ] )
         aGet[ 8 ]:cText( Auth():Codigo() )
      else
         aTmp[ 8 ]     := Auth():Codigo()
      end

      if !empty( aGet[ 38 ] )
         aGet[ 38 ]:cText( cProCnt() )
      else
         aTmp[ 38 ]     := cProCnt()
      end

      aTmp[ 52    ]     := 0

      if !empty( aGet[ 57 ] )
         aGet[ 57 ]:cText( Padr( "General", 50 ) )
      else
         aTmp[ 57 ]     := Padr( "General", 50 )
      end

      if !empty( aGet[ 58 ] )
         aGet[ 58 ]:cText( 0 )
      else
         aTmp[ 58 ]     := 0
      end

      if !empty( aGet[ 59 ] )
         aGet[ 59    ]:cText( Padr( "Pronto pago", 50 ) )
      else
         aTmp[ 59    ]     := Padr( "Pronto pago", 50 )
      end

      if !empty( aGet[ 60 ] )
         aGet[ 60    ]:cText( 0 )
      else
         aTmp[ 60    ]     := 0
      end

      if !empty( oTotEsp )
         oTotEsp:cText( 0 )
      end

      if !empty( oTotDpp )
         oTotDpp:cText( 0 )
      end





      if !empty( oBtnTipoVta )
         oBtnTipoVta:cPrompt           := "Ticket"
         oBtnTipoVta:cxBmp             := "gc_cash_register_user_32"
      end

   case nMode == 2 .OR. nMode == 3 .OR. nMode == 4

      if nMode == 4





         cSerCli                       := RetFld( cDefCli(), dbfClient, "Serie" )

         if !empty( aGet[ 1 ] )
            if empty( cSerCli )
               aGet[ 1 ]:cText( cNewSer( "nFacCli", dbfCount ) )
            else
               aGet[ 1 ]:cText( cSerCli )
            end
         else
            if empty( cSerCli )
               aTmp[ 1 ]        := cNewSer( "nFacCli", dbfCount )
            else
               aTmp[ 1 ]        := cSerCli
            end
         end

         aTmp[ 2 ]              := ""
         aTmp[ 5 ]              := cCurSesion()

      end

      lApartado                        := ( aTmp[ 4 ] == "5" .OR. aTmp[ 4 ] == "1" )

      aTmp[ 27 ]                 := .T.

      if ( D():Tikets( nView ) )->cTipTik == "2"

         LoaAlb2Tik()





         nRecAnt  := ( dbfAlbCliP )->( Recno() )
         nOrdAnt  := ( dbfAlbCliP )->( ordsetfocus( "NNUMALB" ) )

         if ( dbfAlbCliP )->( dbSeek( ( D():Tikets( nView ) )->cNumDoc ) )
            while ( ( dbfAlbCliP )->cSerAlb + Str( ( dbfAlbCliP )->nNumAlb ) + ( dbfAlbCliP )->cSufAlb ) == ( D():Tikets( nView ) )->cNumDoc .AND. !( dbfAlbCliP )->( eof() )
               dbPass( dbfAlbCliP, dbfTmpE, .T. )
               ( dbfAlbCliP )->( dbSkip() )
            end
         end
         ( dbfTmpE )->( dbGoTop() )

         ( dbfAlbCliP )->( ordsetfocus( nOrdAnt ) )
         ( dbfAlbCliP )->( dbGoTo( nRecAnt ) )

      elseif ( D():Tikets( nView ) )->cTipTik == "3"

         if ( dbfFacCliL )->( dbSeek( ( D():Tikets( nView ) )->cNumDoc ) )

            while ( ( dbfFacCliL )->cSerie + Str( ( dbfFacCliL )->nNumFac ) + ( dbfFacCliL )->cSufFac == ( D():Tikets( nView ) )->cNumDoc .AND. !( dbfFacCliL )->( eof() ) )

               ( dbfTmpL )->( dbAppend() )
               ( dbfTmpL )->cCbaTil    := ( dbfFacCliL )->cRef
               ( dbfTmpL )->cNomTil    := ( dbfFacCliL )->cDetalle
               ( dbfTmpL )->nPvpTil    := ( dbfFacCliL )->nPreUnit
               ( dbfTmpL )->nDtoLin    := ( dbfFacCliL )->nDto
               ( dbfTmpL )->nIvaTil    := ( dbfFacCliL )->nIva
               ( dbfTmpL )->cCodPr1    := ( dbfFacCliL )->cCodPr1
               ( dbfTmpL )->cCodPr2    := ( dbfFacCliL )->cCodPr2
               ( dbfTmpL )->cValPr1    := ( dbfFacCliL )->cValPr1
               ( dbfTmpL )->cValPr2    := ( dbfFacCliL )->cValPr2
               ( dbfTmpL )->nFacCnv    := ( dbfFacCliL )->nFacCnv
               ( dbfTmpL )->nDtoDiv    := ( dbfFacCliL )->nDtoDiv
               ( dbfTmpL )->nCtlStk    := ( dbfFacCliL )->nCtlStk
               ( dbfTmpL )->nValImp    := ( dbfFacCliL )->nValImp
               ( dbfTmpL )->cCodImp    := ( dbfFacCliL )->cCodImp
               ( dbfTmpL )->mNumSer    := ( dbfFacCliL )->mNumSer
               ( dbfTmpL )->nUntTil    := nTotNFacCli( dbfFacCliL )
               ( dbfTmpL )->( dbUnLock() )

               ( dbfFacCliL )->( dbSkip() )

            end
         end
         ( dbfTmpL )->( dbGoTop() )





         if ( dbfFacCliP )->( dbSeek( ( D():Tikets( nView ) )->cNumDoc ) )

            while ( dbfFacCliP )->cSerie + Str( ( dbfFacCliP )->nNumFac ) + ( dbfFacCliP )->cSufFac == ( D():Tikets( nView ) )->cNumDoc .AND. !( dbfFacCliP )->( eof() )

               if ( dbfFacCliP )->lCobrado
                  ( dbfTmpP )->( dbAppend() )
                  ( dbfTmpP )->cCodCaj    := ( dbfFacCliP )->cCodCaj
                  ( dbfTmpP )->dPgoTik    := ( dbfFacCliP )->dEntrada
                  ( dbfTmpP )->nImpTik    := ( dbfFacCliP )->nImporte
                  ( dbfTmpP )->cDivPgo    := ( dbfFacCliP )->cDivPgo
                  ( dbfTmpP )->nVdvPgo    := ( dbfFacCliP )->nVdvPgo
                  ( dbfTmpP )->cPgdPor    := ( dbfFacCliP )->cPgdoPor
                  ( dbfTmpP )->cTurPgo    := ( dbfFacCliP )->cTurRec
                  ( dbfTmpP )->cCtaRec    := ( dbfFacCliP )->cCtaRec
                  ( dbfTmpP )->cFpgPgo    := ( dbfFacCliP )->cCodPgo
               end

               ( dbfFacCliP )->( dbSkip() )

            end

         end





         nRecAnt  := ( dbfAntCliT )->( Recno() )
         nOrdAnt  := ( dbfAntCliT )->( ordsetfocus( "cNumDoc" ) )

         if ( dbfAntCliT )->( dbSeek( ( D():Tikets( nView ) )->cNumDoc ) )
            while ( dbfAntCliT )->cNumDoc == ( D():Tikets( nView ) )->cNumDoc .AND. !( dbfAntCliT )->( eof() )
               dbPass( dbfAntCliT, dbfTmpA, .T. )
               ( dbfAntCliT )->( dbSkip() )
            end
         end
         ( dbfTmpA )->( dbGoTop() )

         ( dbfAntCliT )->( ordsetfocus( nOrdAnt ) )
         ( dbfAntCliT )->( dbGoTo( nRecAnt ) )

      else





         if ( dbfTikL )->( dbSeek( cNumTik ) )
            while ( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil == cNumTik .AND. !( dbfTikL )->( eof() ) )

               if dbLock( dbfTikL )
                  ( dbfTikL )->nUndAnt    := ( dbfTikL )->nUntTil
                  ( dbfTikL )->nPvpAnt    := ( dbfTikL )->nPvpTil
                  ( dbfTikL )->( dbUnLock() )
               end

               dbPass( dbfTikL, dbfTmpL, .T. )
               ( dbfTikL )->( dbSkip() )
            end

         end

         ( dbfTmpL )->( dbGoTop() )





         if ( dbfTikP )->( dbSeek( cNumTik ) )
            while ( ( dbfTikP )->cSerTik + ( dbfTikP )->cNumTik + ( dbfTikP )->cSufTik == cNumTik .AND. !( dbfTikP )->( eof() ) )
               dbPass( dbfTikP, dbfTmpP, .T. )
               ( dbfTikP )->( dbSkip() )
            end
         end

         ( dbfTmpP )->( dbGoTop() )





         nRecAnt     := ( D():Tikets( nView ) )->( Recno() )
         nOrdAnt     := ( D():Tikets( nView ) )->( ordsetfocus( "cDocVal" ) )

         if ( D():Tikets( nView ) )->( dbSeek( cNumTik ) )
            while ( D():Tikets( nView ) )->cValDoc == cNumTik .AND. !( D():Tikets( nView ) )->( eof() )
               dbPass( D():Tikets( nView ), dbfTmpV, .T. )
               ( D():Tikets( nView ) )->( dbSkip() )
            end
         end

         ( D():Tikets( nView ) )->( dbGoTo( nRecAnt ) )
         ( D():Tikets( nView ) )->( ordsetfocus( nOrdAnt ) )

         ( dbfTmpV )->( dbGoTop() )

      end

   end

   oAuditoria:initTemporal()





   cTextoOfficeBar( aTmp )





   cOldCodCli           := aTmp[ 11 ]





   if !empty( aGetTxt )
      aGetTxt[ 1 ]      := RetFld( aTmp[ 9 ], dbfCajT )
      aGetTxt[ 2 ]      := RetFld( aTmp[ 10 ], dbfAlm )
      aGetTxt[ 3 ]      := RetFld( aTmp[ 21 ], dbfFPago )
      aGetTxt[ 5 ]      := RetFld( aTmp[ 11 ] + aTmp[ 35 ], dbfObrasT, "cNomObr" )
      aGetTxt[ 6 ]      := RetFld( aTmp[ 32 ], dbfAgent )
      aGetTxt[ 7 ]      := RetFld( aTmp[ 33 ], dbfRuta )
      aGetTxt[ 8 ]      := RetFld( aTmp[ 34 ], dbfTarPreS )
      aGetTxt[ 9 ]      := RetFld( aTmp[ 11 ], dbfClient,   "Telefono" )
      aGetTxt[ 10]      := UsuariosModel():getNombreWhereCodigo( aTmp[ 8 ] )
   end





   lSave                := .F.





   if !empty( oBrwDet )
      oBrwDet:Refresh()
   end

   RECOVER USING oError

      msgStop( ErrorMessage( oError ), "Imposible crear tablas temporales." )

      KillTrans()

      lErrors           := .T.

   end

   ErrorBlock( oBlock )

   CursorWE()

Return ( lErrors )



Static Function KillTrans( oBrwPgo, oBrwVal )

   CursorWait()

   if !empty( dbfTmpL ) .AND. ( dbfTmpL )->( Used() )
      ( dbfTmpL )->( dbCloseArea() )
   end

   if !empty( dbfTmpP ) .AND. ( dbfTmpP )->( Used() )
      ( dbfTmpP )->( dbCloseArea() )
   end

   if !empty( dbfTmpV ) .AND. ( dbfTmpV )->( Used() )
      ( dbfTmpV )->( dbCloseArea() )
   end

   if !empty( dbfTmpA ) .AND. ( dbfTmpA )->( Used() )
      ( dbfTmpA )->( dbCloseArea() )
   end

   if !empty( dbfTmpE ) .AND. ( dbfTmpE )->( Used() )
      ( dbfTmpE )->( dbCloseArea() )
   end

   if !empty( dbfTmpC ) .AND. ( dbfTmpC )->( Used() )
      ( dbfTmpC )->( dbCloseArea() )
   end

   if !empty( dbfTmpS ) .AND. ( dbfTmpS )->( Used() )
      ( dbfTmpS )->( dbCloseArea() )
   end

   if !empty( dbfTmpN ) .AND. ( dbfTmpN )->( Used() )
      ( dbfTmpN )->( dbCloseArea() )
   end

   dbfErase( cNewFilL )
   dbfErase( cNewFilP )
   dbfErase( cNewFilV )
   dbfErase( cNewFilA )
   dbfErase( cNewFilE )
   dbfErase( cNewFilC )
   dbfErase( cNewFilS )
   dbfErase( cNewFilN )

   oOfficeBar  := nil

   dbfTmpL     := nil
   dbfTmpP     := nil
   dbfTmpV     := nil
   dbfTmpA     := nil
   dbfTmpE     := nil
   dbfTmpC     := nil
   dbfTmpS     := nil
   dbfTmpN     := nil

   CursorWE()

Return .T.



Static Function ClickOnBrowse( nRow, aTmp, aGet, oBrwDet )

   local nBrwHeight

   nBrwHeight        := oBrwDet:HeaderHeight() + ( oBrwDet:nRowHeight * oBrwDet:nDataRows )

   if !( nRow < nBrwHeight )

      AppDetRec( oBrwDet, bEditL, aTmp, cPorDiv, cPicEur )

      aGet[ 11 ]:SetFocus()

   end

Return ( .T. )
































































































STATIC FUNCTION AppDetRec( oBrw, bEditL, aTmp, cPorDiv, cPicEur, cCodArt )

   SysRefresh()

   if lStopEntContLine
      lStopEntContLine  := .F.
      return ( lRecTotal( aTmp ) )
   end

   if empty( aTmp[ 12 ] )
      aTmp[ 12 ]  := Max( uFieldEmpresa( "nPreVta" ), 1 )
   end





   lNowAppendLine       := .T.

   while WinAppRec( oBrw, bEditL, dbfTmpL, , cCodArt, aTmp )

      sysrefresh()

      if !empty( cCodArt )
         cCodArt        := nil
      end

      sysrefresh()

   end

RETURN ( lRecTotal( aTmp ) )






STATIC FUNCTION EdtDet( aTmp, aGet, dbfTmpL, oBrw, bWhen, cCodArt, nMode, aTik )

   local n
   local oCol
   local aPos
   local oBtn
   local oBtnCancel
   local lTwo                 := .F.
   local nTop
   local nLeft
   local nWidth
   local nHeight
   local oBtnSer
   local oGetTotal
   local nGetTotal            := 0
   local lMsgVta              := .F.
   local lNotVta              := .F.
   local cName
   local nCaptura
   local oCodBarras
   local cCodBarras           := Space( 18 )
   local oGetNombrePropiedad1
   local oGetNombrePropiedad2

   if empty( oBrw )
      RETURN ( .F. )
   end





   if nMode == 1

      oBrw:GoBottom()

      aTmp[ 8 ]     := 1
      aTmp[ 46 ]     := 0
      aTmp[ 47 ]     := 0
      aTmp[ 48 ]     := 0
      aTmp[ 2 ]     := aTik[ 2 ]
      aTmp[ 27 ]     := aTik[ 10 ]
      aTmp[ 31 ]     := nLastNum( dbfTmpL )
      aTmp[ 85 ]   := nLastNum( dbfTmpL, "nPosPrint" )
      aTmp[ 10 ]     := nIva( dbfIva, cDefIva() )
      aTmp[ 86   ]     := win_uuidcreatestring()

      if ( dbfTmpL )->( eof() )
         nTop              := ( ( oBrw:nRowSel - 1 ) * oBrw:nRowHeight ) + oBrw:HeaderHeight() - 1
      else
         nTop              := ( ( oBrw:nRowSel ) * oBrw:nRowHeight ) + oBrw:HeaderHeight() - 1
      end

      if !empty( cCodArt )
         aTmp[ 5 ]  := cCodArt
      end

   else

      nTop                 := ( ( oBrw:nRowSel - 1 ) * oBrw:nRowHeight ) + oBrw:HeaderHeight() - 1

   end





   nLeft                   := 25

   aPos                    := { nTop, nLeft }
   aPos                    := ClientToScreen( oBrw:hWnd, aPos )

   nTop                    := aPos[ 1 ]
   nLeft                   := aPos[ 2 ]
   nHeight                 := oBrw:nRowHeight + nTop
   nWidth                  := oBrw:BrwWidth() + nLeft - 15





   if empty( cCodArt )
      cOldCodArt           := aTmp[ 5 ]
   end

   cOldPrpArt              := aTmp[ 19 ] + aTmp[ 20 ] + aTmp[ 21 ] + aTmp[ 22 ]










   oDlgDet = TDialog():New( nTop, nLeft, nHeight, nWidth,,,, .F., nOR( 268435456, 2147483648, 4 ),,,, oBrw, .T.,,,,,, .F.,, "oDlgDet", nil, )
      for each oCol in oBrw:aCols

         cName       := oCol:Cargo[ 1 ]
         nCaptura    := oCol:Cargo[ 2 ]

         do case
            case cName == "Código del artículo"







               aGet[ 5 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oDlgDet,,, "@!",,,, oBrw:oFont, .F.,, .F.,, .F., {||     ( nMode == 1 )}, .F., .F.,, .F., .F., .T.,, .F.,,,,,,, "LUPA", )

               aGet[ 5 ]:bLostFocus         := {|| LoaArt( aGet, aTmp, oBrw, oGetTotal, aTik, lTwo, nMode, oDlgDet, @lMsgVta, @lNotVta ) }
               aGet[ 5 ]:bHelp              := {|| SetLostFocusOff(), BrwArticulo( aGet[ 5 ], aGet[ 6 ] ), SetLostFocusOn() }

               do case
               case nCaptura == 1
                  aGet[ 5 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 5 ]:bValid          := {|| lCodigoArticulo( aGet, aTmp, .T. ) }
               case nCaptura == 3
                  aGet[ 5 ]:lNeedGetFocus   := .T.
               end

               aGet[ 5 ]:Cargo              := "Código del artículo"

            case cName == "Unidades"







               aGet[ 8 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oDlgDet,,, cPicUnd,,,,, .F.,, .F.,, .F.,, .F., .T., {|nKey, nFlags, Self| ( lCalcDeta( aTmp, oGetTotal ) )}, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 8 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 8 ]:bValid          := {|| !empty( aTmp[ 8 ] ) }
               case nCaptura == 3
                  aGet[ 8 ]:lNeedGetFocus   := .T.
               end

               aGet[ 8 ]:Cargo              := "Unidades"

            case cName == "Medición 1"






               aGet[ 46 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 46 ], aTmp[ 46 ]:= u ) }, oDlgDet,,, cPicUnd,,,,, .F.,, .F.,, .F.,, .F., .T., {|nKey, nFlags, Self| ( lCalcDeta( aTmp, oGetTotal ) )}, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 46 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 46 ]:bValid          := {|| .T. }
               case nCaptura == 3
                  aGet[ 46 ]:lNeedGetFocus   := .T.
               end

               aGet[ 46 ]:Cargo              := "Medición 1"

            case cName == "Medición 2"







               aGet[ 47 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 47 ], aTmp[ 47 ]:= u ) }, oDlgDet,,, cPicUnd,,,,, .F.,, .F.,, .F.,, .F., .T., {|nKey, nFlags, Self| ( lCalcDeta( aTmp, oGetTotal ) )}, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 47 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 47 ]:bValid          := {|| .T. }
               case nCaptura == 3
                  aGet[ 47 ]:lNeedGetFocus   := .T.
               end

               aGet[ 47 ]:Cargo              := "Medición 2"

            case cName == "Medición 3"







               aGet[ 48 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 48 ], aTmp[ 48 ]:= u ) }, oDlgDet,,, cPicUnd,,,,, .F.,, .F.,, .F.,, .F., .T., {|nKey, nFlags, Self| ( lCalcDeta( aTmp, oGetTotal ) )}, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 48 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 48 ]:bValid          := {|| .T. }
               case nCaptura == 3
                  aGet[ 48 ]:lNeedGetFocus   := .T.
               end

               aGet[ 48 ]:Cargo              := "Medición 3"

            case cName == "Propiedad 1"










               aGet[ 21 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 21 ], aTmp[ 21 ]:= u ) }, oDlgDet,,, "@!", {||    ( if( lPrpAct( aTmp[ 21 ], nil, aTmp[ 19 ], dbfTblPro ), LoaArt( aGet, aTmp, oBrw, oGetTotal, aTik, lTwo, nMode, oDlgDet, @lMsgVta, @lNotVta ), .F. ) )},,, oBrw:oFont, .F.,, .F.,, .F., {||     ( !empty( aTmp[ 19 ] ) )}, .F., .F.,, .F., .F., .T.,, .F.,,,,,,, "LUPA", )

               aGet[ 21 ]:bHelp              := {|| SetLostFocusOff(), brwPropiedadActual( aGet[ 21 ], nil, aTmp[ 19 ] ), SetLostFocusOn() }

               do case
               case nCaptura == 1
                  aGet[ 21 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 21 ]:bWhen           := {|| .T. }
               case nCaptura == 3
                  aGet[ 21 ]:lNeedGetFocus   := .T.
               end

            case cName == "Propiedad 2"










               aGet[ 22 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 22 ], aTmp[ 22 ]:= u ) }, oDlgDet,,, "@!", {||    ( if( lPrpAct( aTmp[ 22 ], nil, aTmp[ 20 ], dbfTblPro ), LoaArt( aGet, aTmp, oBrw, oGetTotal, aTik, lTwo, nMode, oDlgDet, @lMsgVta, @lNotVta ), .F. ) )},,, oBrw:oFont, .F.,, .F.,, .F., {||     ( !empty( aTmp[ 20 ] ) )}, .F., .F.,, .F., .F., .T.,, .F.,,,,,,, "LUPA", )

               aGet[ 22 ]:bHelp              := {|| SetLostFocusOff(), brwPropiedadActual( aGet[ 22 ], nil, aTmp[ 20 ] ), SetLostFocusOn() }

               do case
               case nCaptura == 1
                  aGet[ 22 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 22 ]:bWhen           := {|| .T. }
               case nCaptura == 3
                  aGet[ 22 ]:lNeedGetFocus   := .T.
               end

            case cName == "Nombre propiedad 1"





               oGetNombrePropiedad1 := TSay():New( 0, 0, {||   nombrePropiedad( aTmp[ 19 ], aTmp[ 21 ], nView )}, oDlgDet, "@!", oBrw:oFont, .F., .F., .F., .F.,,,,, .F., .F., .F., .F., .F., .F., .F., "oGetNombrePropiedad1",, .F. )

            case cName == "Nombre propiedad 2"





               oGetNombrePropiedad2 := TSay():New( 0, 0, {||   nombrePropiedad( aTmp[ 20 ], aTmp[ 22 ], nView )}, oDlgDet, "@!", oBrw:oFont, .F., .F., .F., .F.,,,,, .F., .F., .F., .F., .F., .F., .F., "oGetNombrePropiedad2",, .F. )

            case cName == "Lote"





               aGet[ 42 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 42 ], aTmp[ 42 ]:= u ) }, oDlgDet,,,,,,, oBrw:oFont, .F.,, .F.,, .F.,, .F., .T.,, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 42 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 42 ]:bWhen           := {|| !empty( aTmp[ 42 ] ) }
               case nCaptura == 3
                  aGet[ 42 ]:lNeedGetFocus   := .T.
               end

               aGet[ 42 ]:bValid              := {|| lValidaLote( aTmp, aGet ) }

            case cName == "Caducidad"






               aGet[ 76 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 76 ], aTmp[ 76 ]:= u ) }, oDlgDet,,,,,,, oBrw:oFont, .F.,, .F.,, .F.,, .F., .T.,, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 76 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 76 ]:bWhen           := {|| !empty( aTmp[ 76 ] ) }
               case nCaptura == 3
                  aGet[ 76 ]:lNeedGetFocus   := .T.
               end

            case cName == "Detalle"







               aGet[ 6 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oDlgDet,,,, {||    ( .T. )},,, oBrw:oFont, .F.,, .F.,, .F., {||     ( lModDes() )}, .F., .F.,, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 6 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 6 ]:bWhen           := {|| lModDes() .OR. empty( aTmp[ 6 ] ) }
               case nCaptura == 3
                  aGet[ 6 ]:lNeedGetFocus   := .T.
               end

            case cName == "Importe"








               aGet[ 7 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 7 ], aTmp[ 7 ]:= u ) }, oDlgDet,,, cPouDiv,,,, oBrw:oFont, .F.,, .F.,, .F.,, .F., .T., {|nKey, nFlags, Self| ( lCalcDeta( aTmp, oGetTotal ) )}, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 7 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 7 ]:bWhen           := {|| empty( aTmp[ 7 ] ) }
               case nCaptura == 3
                  aGet[ 7 ]:lNeedGetFocus   := .T.
               end

            case cName == "Descuento lineal"









               aGet[ 24 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 24 ], aTmp[ 24 ]:= u ) }, oDlgDet,,, cPouDiv,, ( 255 + ( 0 * 256 ) + ( 0 * 65536 ) ),, oBrw:oFont, .F.,, .F.,, .F.,, .F., .T., {|nKey, nFlags, Self| ( lCalcDeta( aTmp, oGetTotal ) )}, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 24 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 24 ]:bWhen           := {|| empty( aTmp[ 24 ] ) }
               case nCaptura == 3
                  aGet[ 24 ]:lNeedGetFocus   := .T.
               end

            case cName == "Descuento porcentual"







               aGet[ 18 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oDlgDet,,, "@E 999.99",,,, oBrw:oFont, .F.,, .F.,, .F.,, .F., .T., {|nKey, nFlags, Self| ( lCalcDeta( aTmp, oGetTotal ) )}, .F., .F., .T.,, .F.,,,,,,,, )

               do case
               case nCaptura == 1
                  aGet[ 18 ]:bWhen           := {|| .F. }
               case nCaptura == 2
                  aGet[ 18 ]:bWhen           := {|| empty( aTmp[ 18 ] ) }
               case nCaptura == 3
                  aGet[ 18 ]:lNeedGetFocus   := .T.
               end

            case cName == "Total"







               oGetTotal := TGetHlp():New( 0, 0, { | u | If( PCount()==0, nGetTotal, nGetTotal:= u ) }, oDlgDet,,, cPorDiv,,,, oBrw:oFont, .F.,, .F.,, .F., {||     .F.}, .F., .T.,, .F., .F., .T.,, .F.,,,,,,,, )

            case cName == "Número de serie"





               oBtnSer := TButton():New( 0, 0, ( "&Series" ), oDlgDet, {||   ( SetLostFocusOff(), EditarNumeroSerie( aTmp, oStock, nMode ), SetLostFocusOn() )},,,, oBrw:oFont, .F., .F., .F.,, .F.,,, .F., "oBtnSer", .F. )

            case cName == "Promoción"





               aGet[ 58 ] := TBitmap():New( 0, 0, 16, 16, "gc_star2_blue_16",, .T., oDlgDet,,, .F., .F.,,, .F.,, .F.,, .F. )

               aGet[ 58 ]:lTransparent   := .T.

            case cName == "Oferta"





               aGet[ 67 ] := TBitmap():New( 0, 0, 16, 16, "gc_star2_16",, .T., oDlgDet,,, .F., .F.,,, .F.,, .F.,, .F. )

               aGet[ 67 ]:lTransparent   := .T.

            case cName == "Número de línea"







               aGet[ 31 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 31 ], aTmp[ 31 ]:= u ) }, oDlgDet,,, "9999",,,, oBrw:oFont, .F.,, .F.,, .F., {||     .F.}, .F., .T.,, .F., .F., .T.,, .F.,,,,,,,, )

            case cName == "Ubicación"






               oUbicacion := TGetHlp():New( 0, 0, { | u | If( PCount()==0, cUbicacion, cUbicacion:= u ) }, oDlgDet,,, "@!",,,, oBrw:oFont, .F.,, .F.,, .F., {||     ( .T. )}, .F., .F.,, .F., .F., .T.,, .F.,,,,,,,, )

            case cName == "Código de barras"






               oCodBarras := TGetHlp():New( 0, 0, { | u | If( PCount()==0, cCodBarras, cCodBarras:= u ) }, oDlgDet,,, "@!",,,, oBrw:oFont, .F.,, .F.,, .F., {||     ( .F. )}, .F., .F.,, .F., .F., .T.,, .F.,,,,,,,, )

            case cName == "Porcentaje I.V.A."







               aGet[ 10 ] := TGetHlp():New( 0, 0, { | u | If( PCount()==0, aTmp[ 10 ], aTmp[ 10 ]:= u ) }, oDlgDet,,, "@E 999.99", {||    lTiva( dbfIva, aTmp[ 10 ] )},,, oBrw:oFont, .F.,, .F.,, .F.,, .F., .F., {|nKey, nFlags, Self| ( lCalcDeta( aTmp, oGetTotal ) )}, .F., .F., .T.,, .F.,,,,,,,, )

         end

      next









      oBtn := TButton():New( 0, 0, ( if( nMode == 1, "&A", "&M" ) ), oDlgDet, {||   ( SavLine( aTmp, aGet, dbfTmpL, oBrw, aTik, oGetTotal, lTwo, nMode, oBtn, cPorDiv, cPicEur, lMsgVta, lNotVta, cCodArt, oStock ) )},,,, oBrw:oFont, .T., .F., .F.,, .F., {||     ( nMode <> 3 )},, .F., "oBtn", .F. )






      oBtnCancel := TButton():New( 0, 0, ( "Cancelar" ), oDlgDet, {||   ( oDlgDet:end( 2 ) )},,,, oBrw:oFont, .F., .F., .F.,, .F., {||     ( nMode <> 3 )},, .F., "oBtnCancel", .F. )

      oDlgDet:AddFastKey( 122, {|| GetPesoBalanza( aGet, oBtn ) } )

      oDlgDet:bKeyDown        := {| nKey | EdtDetKeyDown( nKey, aGet, oDlgDet, oBtn ) }
      oDlgDet:bStart          := {|| startDlgDet( oDlgDet, cCodArt, aGet, aTmp, nMode, oBrw, oBtn, oBtnCancel ) }
      oDlgDet:bLostFocus      := {|| dlgLostFocus( nMode, aTmp ) }

      setLostFocusOff()

   oDlgDet:Activate( , , , .F., , .T. )


   oBrw:setFocus()
   oBrw:Refresh()

RETURN ( oDlgDet:nResult == 1 )



STATIC FUNCTION clickDlgDet( nRow, nCol, oDlg )

   msgalert( nRow )
   msgalert( nCol )

   if nRow < 0 .OR. nCol < 0 .OR. nRow > oDlg:nHeight - 0 .OR. nCol > oDlg:nWidth
      msgStop( "clicked outside" )
   else
      setCapture( oDlg:hWnd )
   end

RETURN ( nil )



STATIC FUNCTION startDlgDet( oDlgDet, cCodArt, aGet, aTmp, nMode, oBrw, oBtn, oBtnCancel )

   if !empty( cCodArt )
      aGet[ 5 ]:lValid()
   end

   SetDlgMode( oDlgDet, aTmp, aGet, nMode, oBrw, oBtn, oBtnCancel )

RETURN ( nil )



STATIC FUNCTION EditGetLostFocus( oGet, hWndFocus, oDlgDet )

   if getLostFocus()
      RETURN NIL
   end

   if ( ascan( oDlgDet:aControls, {|oControl| oControl:hWnd == hWndFocus } ) == 0 )
      oDlgDet:end( 2 )
   end

RETURN NIL



Static Function SetDlgMode( oDlg, aTmp, aGet, nMode, oBrw, oBtn, oBtnCancel )

   local n
   local oCtl
   local nRow
   local nCol
   local nWidth
   local nHeight
   local nGWidth  := 25



   for n := 1 to len( oDlg:aControls ) - 2

      nRow        := 3
      nCol        := oBrw:aCols[ n ]:nDisplayCol - 25
      nWidth      := oBrw:aCols[ n ]:nWidth - 2
      nHeight     := oBrw:nRowHeight - 4

      nGWidth     += oBrw:aCols[ n ]:nWidth - 1

      oDlg:aControls[ n ]:Move( nRow, nCol, nWidth, nHeight, .T. )

   next

   oBtn:Move( nRow, nGWidth, nHeight + 4, nHeight + 4, .T. )

   oBtnCancel:Move( nRow, nGWidth + 18, nHeight + 50, nHeight + 4, .T. )

   if empty( aTmp[ 7 ] ) .OR. oUser():lAdministrador() .OR. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) )
      if( !empty( aGet[ 7 ] ), aGet[ 7 ]:HardEnable(), )
      if( !empty( aGet[ 24 ] ), aGet[ 24 ]:HardEnable(), )
      if( !empty( aGet[ 18 ] ), aGet[ 18 ]:HardEnable(), )
   else
      if( !empty( aGet[ 7 ] ), aGet[ 7 ]:HardDisable(), )
      if( !empty( aGet[ 24 ] ), aGet[ 24 ]:HardDisable(), )
      if( !empty( aGet[ 18 ] ), aGet[ 18 ]:HardDisable(), )
   end

   if !empty( aGet[ 58 ] )

      if aTmp[ 58 ]
         aGet[ 58 ]:Show()
      else
         aGet[ 58 ]:Hide()
      end

   end

   if !empty( aGet[ 67 ] )

      if aTmp[ 67 ]
         aGet[ 67 ]:Show()
      else
         aGet[ 67 ]:Hide()
      end

   end





   for each oCtl in oDlg:aControls

      if !empty( oCtl ) .AND. oCtl:ClassName == "TGETHLP"

         if empty( oCtl:bWhen ) .OR. Eval( oCtl:bWhen )

            if oCtl:lNeedGetFocus .AND. !oCtl:lGotFocus

               oCtl:SetFocus()

               Return .T.

            end

         end

      end

   next

return .T.






Static Function lCalcDeta( aTmp, oTotal, lTotal )

   local nCalculo

   If( lTotal == nil, lTotal := .F., ) ;

   nCalculo       := aTmp[ 7 ]
   nCalculo       *= aTmp[ 8 ]

    IF aTmp[ 18 ] <> 0
        nCalculo     -= nCalculo * aTmp[ 18 ] / 100
    end

   nCalculo       -= aTmp[ 24 ]

   if !empty( oTotal )
      oTotal:cText( nCalculo )
   end

Return if( !lTotal, .T., nCalculo )



Static Function EdtDetKeyDown( nKey, aGet, oDlg, oBtn )

   do case
      case nKey == 27

         oDlg:End()

      case nKey == 13

         oBtn:Click()

      case nKey == 116

         if !empty( aGet[ 5 ]:VarGet() )

            Eval( oBtn:bAction )

         else

            oDlg:End()

            if !empty( oBtnTik:bWhen ) .AND. Eval( oBtnTik:bWhen )
               Eval( oBtnTik:bAction )
            end

         end

      case nKey == 118

         if !empty( aGet[ 5 ]:VarGet() )

            Eval( oBtn:bAction )

         else

            oDlg:End()

            if !empty( oBtnAlb:bWhen ) .AND. Eval( oBtnAlb:bWhen )
               Eval( oBtnAlb:bAction )
            end

         end

















      case nKey == 120

         if !empty( aGet[ 5 ]:VarGet() )

            Eval( oBtn:bAction )

         else

            oDlg:End()

            if !empty( oBtnApt:bWhen ) .AND. Eval( oBtnApt:bWhen )
               Eval( oBtnApt:bAction )
            end

         end

      case nKey == 65 .AND. GetKeyState( 17 )

         SetLostFocusOff()
         CreateInfoArticulo()
         SetLostFocusOn()

   end

Return nil







STATIC FUNCTION SavLine( aTmp, aGet, dbfTmpL, oBrw, aTik, oGetTotal, lTwo, nMode, oBtn, cPorDiv, cPicEur, lMsgVta, lNotVta, cCodArt, oStock )

   local lOk
   local oCtl
   local aClo
   local aXbYStr        := { 0, 0 }
   local nStockActual
   local hAtipica

   aClo                 := aClone( aTmp )





   oBtn:SetFocus()





   if !empty( aGet[ 7 ] )
      aGet[ 7 ]:Refresh()
   end

   if !empty( aGet[ 8 ] )
      aGet[ 8 ]:Refresh()
   end

   if aTmp[ 8 ] == 0
      aTmp[ 8 ] := 1
   end





   for each oCtl in oDlgDet:aControls

      if !empty( oCtl ) .AND. oCtl:ClassName == "TGETHLP"

         if empty( oCtl:bWhen ) .OR. Eval( oCtl:bWhen )

            if oCtl:lNeedGetFocus .AND. !oCtl:lGotFocus

               SetLostFocusOff()
               msgWait( "Campo obligatorio", "Info", 0 )
               SetLostFocusOn()

               oCtl:SetFocus()

               Return .F.

            end

         end

      end

   next





   if empty( aTmp[ 8 ] )
      aGet[ 8 ]:SetFocus()
      return .F.
   end

   if !lCodigoArticulo( aGet, aTmp, .F. )
      aGet[ 5 ]:SetFocus()
      return .F.
   end





   if ( nMode == 1 ) .AND. RetFld( aTmp[ 5 ], dbfArticulo, "lNumSer" ) .AND. !( dbfTmpS )->( dbSeek( Str( aTmp[ 31 ], 4 ) + aTmp[ 5 ] ) )

      SetLostFocusOff()
      MsgStop( "Tiene que introducir números de serie para este artículo." )
      SetLostFocusOn()

      SetLostFocusOff()
      EditarNumeroSerie( aTmp, oStock, nMode )
      SetLostFocusOn()

      Return .F.

   end

   if lTwo .AND. empty( aTmp[14 ] )

      SetLostFocusOff()
      msgWait( "Introduzca artículo combinado", "Stop", 0 )
      SetLostFocusOn()

      aGet[ 14 ]:setFocus()

      return .F.

   end

   if !empty( aTmp[ 19 ] ) .AND. empty( aTmp[ 21 ] ) .AND. !empty( aGet[ 21 ] )

      SetLostFocusOff()
      MsgBeepStop( "Primera propiedad no puede estar vacia", "Aviso del sistema" )
      SetLostFocusOn()

      aGet[ 21 ]:SetFocus()

      return .F.

   end

   if !empty( aTmp[ 20 ] ) .AND. empty( aTmp[ 22 ] ) .AND. !empty( aGet[ 22 ] )

      SetLostFocusOff()
      MsgBeepStop( "Segunda propiedad no puede estar vacia", "Aviso del sistema" )
      SetLostFocusOn()

      aGet[ 22 ]:SetFocus()

      return .F.

   end





   if empty( aTmp[ 7 ] )

      if !lPermitirVentaSinValorar( aTmp[ 5 ], dbfArticulo, dbfFamilia )

         aGet[ 7 ]:SetFocus()
         return .F.

      else

         SetLostFocusOff()
         lOk   := ApoloMsgNoYes( "Precio igual a cero, ¿desea continuar con la venta?" )
         SetLostFocusOn()

         if !lOk
            aGet[ 7 ]:SetFocus()
            return .F.
         end

      end

   end



   if lPrecioMinimo( aTmp[ 5 ], aTmp[ 7 ], nMode, dbfArticulo )

      SetLostFocusOff()
      msgBeepStop( "El precio de venta es inferior al precio mínimo." )
      SetLostFocusOn()

      return .F.

   end





   if ( aTmp[ 7 ] > 0 ) .AND. ( aTmp[ 7 ] - aTmp[ 24 ] <= 0 )

      SetLostFocusOff()
      MsgBeepStop( "Descuento lineal mayor o igual que precio unitario" )
      SetLostFocusOn()

      aGet[ 24 ]:SetFocus()

      return .F.

   end





   if lNotVta .OR. lMsgVta

      nStockActual   := StocksModel():nStockArticulo( aTmp[ 5 ], aTik[ 10 ], aTmp[ 19 ], aTmp[ 20 ], aTmp[ 21 ], aTmp[ 22 ], aTmp[ 42 ] )

      nStockActual   -= nVentasPrevias( aTmp[ 5 ], dbfTmpL, nMode )

      if ( nStockActual - aTmp[ 8 ] ) < 0

         if lNotVta

            SetLostFocusOff()
            MsgStop( "No hay stock suficiente, tenemos " + Alltrim( Trans( nStockActual, MasUnd() ) ) + " unidad(es) disponible(s) en almacén " + AllTrim( aTik[ 10 ] ) + "." )
            SetLostFocusOn()

            return .F.

         end

         if lMsgVta

            SetLostFocusOff()
            lOk   := apoloMsgNoYes( "No hay stock suficiente, tenemos " + Alltrim( Trans( nStockActual, MasUnd() ) ) + " unidad(es) disponible(s) en almacén " + AllTrim( aTik[ 10 ] ) + ".", "¿Continuar con la venta?" )
            SetLostFocusOn()

            if !lOk
               return .F.
            end

         end

      end

   end



   if !( isPropertiesInProduct( aTmp, nMode ) )

      if !msgBeepYesNo( "Estas propiedades no estan definidas en la ficha del artículo", "¿Desea continuar?" )
         return .F.
      end

   end



   lStdChange( aTmp, aGet )



   if ( nMode == 1 .OR. nMode == 4 )

      if isfalse( runEventScript( "TPV\Lineas\beforeAppend", aTmp, aTik, nView, dbfTmpL ) )
         Return .F.
      end

   end



   if oVisor <> nil
      oVisor:SetBufferLine( { aTmp[ 6 ], Trans( aTmp[ 7 ], cPouDiv ) }, 1 )
   end



   TComercio:appendProductsToUpadateStocks( aTmp[ 5 ], nView )





   if nMode == 1





      hAtipica := hAtipica( hValue( aTmp, aTik ) )

      if !empty( hAtipica )


         if hhaskey( hAtipica, "nTipoXY" )               .AND. hhaskey( hAtipica, "nUnidadesGratis" )

            if hAtipica[ "nUnidadesGratis" ] <> 0
               aXbYStr     := { hAtipica[ "nTipoXY" ], hAtipica[ "nUnidadesGratis" ] }
            end

         end

      end

      if aXbYStr[ 1 ] == 0





         if !aTmp[ 67 ]

            aXbyStr              := nXbYOferta( aTmp[ 5 ], aTik[ 11 ], aTik[ 47 ], 1, aTmp[ 8 ], aTik[ 6 ], dbfOferta, 1 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 67 ]  := .T.
            end

         end





         if !aTmp[ 67 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 5 ], dbfArticulo, "FAMILIA", "CODIGO" ), aTik[ 11 ], aTik[ 47 ], 1, aTmp[ 8 ], aTik[ 6 ], dbfOferta, 2 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 67 ]  := .T.
            end

         end





         if !aTmp[ 67 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 5 ], dbfArticulo, "CCODTIP", "CODIGO" ), aTik[ 11 ], aTik[ 47 ], 1, aTmp[ 8 ], aTik[ 6 ], dbfOferta, 3 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 67 ]  := .T.
            end

         end





         if !aTmp[ 67 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 5 ], dbfArticulo, "CCODTEMP", "CODIGO" ), aTik[ 11 ], aTik[ 47 ], 1, aTmp[ 8 ], aTik[ 6 ], dbfOferta, 5 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 67 ]  := .T.
            end

         end





         if !aTmp[ 67 ]

            aXbyStr              := nXbYOferta( RetFld( aTmp[ 5 ], dbfArticulo, "CCODFAB", "CODIGO" ), aTik[ 11 ], aTik[ 47 ], 1, aTmp[ 8 ], aTik[ 6 ], dbfOferta, 6 )

            if aXbYStr[ 1 ] <> 0
               aTmp[ 67 ]  := .T.
            end

         end

      end





      if aXbYStr[ 1 ] <> 0 .AND. aXbYStr[ 2 ] <> 0

         if aXbYStr[ 1 ] == 2

            if aTmp[ 8 ] < 0
               aTmp[ 8 ]  += aXbYStr[ 2 ]
            else
               aTmp[ 8 ]  -= aXbYStr[ 2 ]
            end

            aClo                 := aClone( aTmp )

            WinGather( aTmp, nil, dbfTmpL, nil, nMode, nil, .F. )

            AppendKit( aClo, aTik )

            if aTmp[ 8 ] < 0
               aTmp[ 8 ]  := -( aXbYStr[ 2 ] )
            else
               aTmp[ 8 ]  := aXbYStr[ 2 ]
            end

            aTmp[ 7 ]     := 0
            aTmp[ 18 ]     := 0
            aTmp[ 24 ]     := 0

            aClo                 := aClone( aTmp )

            WinGather( aTmp, aGet, dbfTmpL, nil, nMode )

            AppendKit( aClo, aTik )

         end

      else





         if lIsCode( aTmp, dbfTmpL, oBrw )

            aGet[ 5 ]:cText( Space( 14 ) )
            aGet[ 6 ]:cText( Space( 250 ) )
            aGet[ 7 ]:cText( 0 )
            aGet[ 8 ]:cText( 0 )

         else









            oAuditoria:AddTemporal( {  "parent_uuid" => aTik[ 72 ] , "description" => "Linea añadida: " + AllTrim( Trans( aTmp[ 8 ], MasUnd() ) ) +  " unidades de " + AllTrim( aTmp[ 5 ] ) + " - " + AllTrim( aTmp[ 6 ] ) +  " con precio:  " + AllTrim( Trans( aTmp[ 7 ], cPorDiv ) ) , "tipodocumento" => "12" } )





            WinGather( aTmp, aGet, dbfTmpL, nil, nMode )

            AppendAsociado( aClo, aTik )

            AppendKit( aClo, aTik )

         end

      end

   else











      oAuditoria:AddTemporal( {  "parent_uuid" => aTik[ 72 ] , "description" => "Linea modificada: " + AllTrim( Trans( aTmp[ 8 ], MasUnd() ) ) +  " unidades de " + AllTrim( aTmp[ 5 ] ) + " - " + AllTrim( aTmp[ 6 ] ) +  " con precio:  " + AllTrim( Trans( aTmp[ 7 ], cPorDiv ) ) +  " con unidades anteriores:  " + AllTrim( Trans( aTmp[ 65 ], MasUnd() ) ) +  " con precio anterior:  " + AllTrim( Trans( aTmp[ 91 ], cPorDiv ) ) , "tipodocumento" => "12" } )





      WinGather( aTmp, aGet, dbfTmpL, nil, nMode )

   end

   cOldCodArt           := ""

   oGetTotal:cText( 0 )





   lRecTotal( aTik )

   if oVisor <> nil
      oVisor:SetBufferLine( { "Total", Trans( nTotTik, cPorDiv ) }, 2 )
      oVisor:WriteBufferLine()
   end





   if !empty( oDlgDet )
      SetLostFocusOff()
      oDlgDet:End( 1 )
      SetLostFocusOn()
   end





   oBrw:Refresh( .T. )

RETURN ( .T. )



STATIC FUNCTION lCodigoArticulo( aGet, aTmp, lMessage, oDlg )

   local lCodArt        := .T.
   local cValPr1        := Space( 20 )
   local cValPr2        := Space( 20 )
   local cCodArt        := aGet[ 5 ]:VarGet()

   If( lMessage == nil, lMessage := .T., ) ;

   if empty( cCodArt )
      return ( !lRetCodArt() )
   end





   cCodArt              := cSeekCodebar( cCodArt, dbfCodebar, dbfArticulo )





   if !aSeekProp( cCodArt, cValPr1, cValPr2, dbfArticulo, dbfTblPro )

      if lMessage

         SetLostFocusOff()
         MsgBeepStop( "Artículo con código " + rtrim( cCodArt ) + " no encontrado" )
         SetLostFocusOn()

      end

      lCodArt           := .F.

    else

      aGet[ 5 ]:cText( cCodArt )

      lCodArt           := .T.

    end

Return ( lCodArt )






STATIC FUNCTION LoaArt( aGet, aTmp, oBrw, oGetTotal, aTik, lTwo, nMode, oDlg, lMsgVta, lNotVta )

   local lOk         := .T.
   local nTotal      := 0
   local cCodFam
   local cPrpArt
   local nImpOfe
   local nCosPro
   local nPrePro     := 0
   local cValPr1     := ""
   local cValPr2     := ""
   local cGrpCli     := RetFld( aTik[ 11 ], dbfClient, "CCODGRP" )
   local cCodArt     := aGet[ 5 ]:cText()
   local nNumDto     := 0
   local nDtoLin     := 0
   local hAtipica
   local cLote
   local dFechaCaducidad
   local cArtLotCad

   if empty( cCodArt )
      if lRetCodArt()
         return .F.
      else
         return .T.
      end
   end





   nOldPvp           := 0





   if At( ";", cCodArt ) <> 0

      cArtLotCad           := cCodArt

      cCodArt              := Padr( SubStr( cArtLotCad, 1, ( At( ";", cArtLotCad ) - 1 ) ), 18 )
      cArtLotCad           := SubStr( cArtLotCad, At( ";", cArtLotCad ) + 1 )
      cLote                := Padr( SubStr( cArtLotCad, 1, ( At( ";", cArtLotCad ) - 1 ) ), 64 )
      dFechaCaducidad      := ctod( AllTrim( SubStr( cArtLotCad, At( ";", cArtLotCad ) + 1 ) ) )

   else





      cCodArt           := cSeekCodebar( cCodArt, dbfCodebar, dbfArticulo )

   end





   if aSeekProp( @cCodArt, @cValPr1, @cValPr2, dbfArticulo, dbfTblPro )

      if ( dbfArticulo )->lObs
         msgstop( "Artículo catalogado como obsoleto" )
         aGet[ 5 ]:cText( Space( 18 ) )
         aGet[ 5 ]:SetFocus()
         return .F.
      end

      if nMode == 1

         aGet[ 5 ]:cText( cCodArt )







            if !empty( ( dbfArticulo)->cDesTik )
               aGet[ 6 ]:cText( ( dbfArticulo )->cDesTik )
            else
               aGet[ 6 ]:cText( ( dbfArticulo )->Nombre  )
            end







         if ( dbfArticulo )->lMosCom .AND. !empty( ( dbfArticulo )->mComent )
            MsgStop( Trim( ( dbfArticulo )->mComent ) )
         end





         if !empty( ( dbfArticulo )->cDesCmd )
            aTmp[ 57 ]                 := ( dbfArticulo )->cDesCmd
         else
            aTmp[ 57 ]                 := aTmp[ 6 ]
         end





         if !Empty( aGet[ 42 ] ) .AND. ( dbfArticulo )->lLote

            if !Empty( cLote )
               aGet[ 42 ]:cText( cLote )
               aGet[ 76 ]:cText(  )
            else
               aGet[ 42 ]:cText( ( dbfArticulo )->cLote )
            end

         end

         if !Empty( aGet[ 76 ] )
            aGet[ 76 ]:cText( dFechaCaducidad )
         end





         aTmp[ 11 ]                    := ( dbfArticulo )->Familia





         aTmp[ 25 ]                    := ( dbfArticulo )->lTipAcc

         if !empty( aGet[ 7 ] )
            aGet[ 7 ]:lNeedGetFocus   := aTmp[ 25 ]
         end

         lMsgVta                             := ( dbfArticulo )->lMsgVta
         lNotVta                             := ( dbfArticulo )->lNotVta





         if ( dbfArticulo )->lKitArt

            aTmp[ 32 ]     := ( dbfArticulo )->lKitArt
            aTmp[ 35 ]     := lImprimirCompuesto( ( dbfArticulo )->Codigo, dbfArticulo )
            aTmp[ 34 ]     := lPreciosCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )

            if lStockCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )
               aTmp[ 26 ]  := ( dbfArticulo )->nCtlStock
            else
               aTmp[ 26 ]  := 3
            end

         else

            aTmp[ 35 ]     := .F.
            aTmp[ 26 ]     := ( dbfArticulo )->nCtlStock

         end





         aTmp[ 19 ]        := ( dbfArticulo )->cCodPrp1
         aTmp[ 20 ]        := ( dbfArticulo )->cCodPrp2

         if !empty( aTmp[ 19 ] ) .AND. !empty( aGet[ 21 ] )

            if !empty( cValPr1 )
               aGet[ 21 ]:cText( cCodPrp( aTmp[ 19 ], cValPr1, dbfTblPro ) )
            end

         end

         if !empty( aTmp[ 20 ] ) .AND. !empty( aGet[ 22 ] )

            if !empty( cValPr2 )
               aGet[ 22 ]:cText( cCodPrp( aTmp[ 20 ], cValPr2, dbfTblPro ) )
            end

         end





         cCodFam              := ( dbfArticulo )->Familia
         if !empty( cCodFam )
            aTmp[ 39 ]  := cCodFam
            aTmp[ 40 ]  := cGruFam( cCodFam, dbfFamilia )
         end





         if aTik[ 70 ] <= 1

            if !empty( aGet[ 10 ] )
               aGet[ 10 ]:cText( nIva( dbfIva, ( dbfArticulo )->TipoIva ) )
            end

            aTmp[ 10 ]  := nIva( dbfIva, ( dbfArticulo )->TipoIva )

         end





         if !empty( ( dbfArticulo )->cCodImp )
            aTmp[ 29 ]  := ( dbfArticulo )->cCodImp
            aTmp[ 28 ]  := oNewImp:nValImp( ( dbfArticulo )->cCodImp, .T., aTmp[ 10 ] )
         end





         if ( dbfArticulo )->lFacCnv
            aTmp[ 23 ]  := ( dbfArticulo )->nFacCnv
         end

      else

         if ( cOldCodArt <> cCodArt )

            aGet[ 5 ]:cText( cCodArt )

            if !empty( ( dbfArticulo)->cDesTik )
               aGet[ 6 ]:cText( ( dbfArticulo )->cDesTik )
            else
               aGet[ 6 ]:cText( ( dbfArticulo )->Nombre  )
            end





            aTmp[ 11 ]        := ( dbfArticulo )->Familia
            aTmp[ 25 ]        := ( dbfArticulo )->lTipAcc

            lNotVta                 := ( dbfArticulo )->lNotVta





            if ( dbfArticulo )->lKitArt
               aTmp[ 32 ]     := ( dbfArticulo )->lKitArt
               aTmp[ 35 ]     := lImprimirCompuesto( ( dbfArticulo )->Codigo, dbfArticulo )
               aTmp[ 34 ]     := lPreciosCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )
               if lStockCompuestos( ( dbfArticulo )->Codigo, dbfArticulo )
                  aTmp[ 26 ]  := ( dbfArticulo )->nCtlStock
               else
                  aTmp[ 26 ]  := 3
               end
            else
               aTmp[ 35 ]     := .F.
               aTmp[ 26 ]     := ( dbfArticulo )->nCtlStock
            end





            if dbSeekInOrd( ( dbfArticulo )->Familia, "cCodFam", dbfFamilia )
               aTmp[ 19 ]     := ( dbfArticulo )->cCodPrp1
               aTmp[ 20 ]     := ( dbfArticulo )->cCodPrp2
            else
               aTmp[ 19 ]     := Space( 20 )
               aTmp[ 20 ]     := Space( 20 )
            end





            cCodFam  := RetFamArt( cCodArt, dbfArticulo )
            if !empty( cCodFam )
               aTmp[ 39 ]  := cCodFam
               aTmp[ 40 ]  := cGruFam( cCodFam, dbfFamilia )
            end





            if aTik[ 70 ] <= 1
               aTmp[ 10 ]  := nIva( dbfIva, ( dbfArticulo )->TipoIva )
            end





            if !empty( ( dbfArticulo )->cCodImp )
               aTmp[ 29 ]     := ( dbfArticulo )->cCodImp
               if aTik[ 70 ] <= 1
                  aTmp[ 28 ]  := oNewImp:nValImp( ( dbfArticulo )->cCodImp, .T., aTmp[ 10 ] )
               end
            end

         end

      end





      cPrpArt              := aTmp[ 19 ] + aTmp[ 20 ] + aTmp[ 21 ] + aTmp[ 22 ]

      if ( cOldCodArt <> cCodArt ) .OR. ( cPrpArt <> cOldPrpArt )





         if nMode == 1
            cCodFam        := RetFamArt( cCodArt, dbfArticulo )
         else
            cCodFam        := aTmp[39]
         end





         nCosPro           := nCosPro( cCodArt, aTmp[ 19 ], aTmp[ 21 ], aTmp[ 20 ], aTmp[ 22 ], dbfArtDiv )



         aTmp[ ( dbfTikL )->( FieldPos( "cUnidad" ) ) ]           := ( dbfArticulo )->cUnidad

         if oUndMedicion:oDbf:Seek( ( dbfArticulo )->cUnidad )

            if !empty( oUndMedicion:oDbf:cTextoDim1 )
               if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ] )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]:cText( ( dbfArticulo )->nLngArt )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]:Show()
               else
                  aTmp[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]  := ( dbfArticulo )->nLngArt
               end
            else
               if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ] )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]:Hide()
               else
                  aTmp[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]  := 0
               end
            end

            if !empty( oUndMedicion:oDbf:cTextoDim2 )
               if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ] )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]:cText( ( dbfArticulo )->nAltArt )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]:Show()
               else
                  aTmp[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]  := ( dbfArticulo )->nAltArt
               end
            else
               if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ] )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]:Hide()
               else
                  aTmp[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]  := 0
               end
            end

            if !empty( oUndMedicion:oDbf:cTextoDim3 )
               if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ] )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]:cText( ( dbfArticulo )->nAncArt )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]:Show()
               else
                  aTmp[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]  := ( dbfArticulo )->nAncArt
               end
            else
               if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ] )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
                  aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]:Hide()
               else
                  aTmp[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]  := 0
               end
            end

         else

            if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ] )
               aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]:cText( 0 )
               aGet[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]:Hide()
            else
               aTmp[ ( dbfTikL )->( fieldpos( "nMedUno" ) ) ]  := 0
            end

            if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ] )
               aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]:cText( 0 )
               aGet[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]:Hide()
            else
               aTmp[ ( dbfTikL )->( fieldpos( "nMedDos" ) ) ]  := 0
            end

            if !empty( aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ] )
               aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]:cText( 0 )
               aGet[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]:Hide()
            else
               aTmp[ ( dbfTikL )->( fieldpos( "nMedTre" ) ) ]  := 0
            end

         end

         nCosPro              := nCosto( nil, dbfArticulo, dbfKit )

         if aGet[ 30 ] <> nil
            aGet[ 30 ]:cText( nCosPro )
         else
            aTmp[ 30 ]  := nCosPro
         end

         nPrePro              := nPrePro( cCodArt, aTmp[ 19 ], aTmp[ 21 ], aTmp[ 20 ], aTmp[ 22 ], aTik[ 12 ], if( aTik[ 70 ] <= 1, .T., .F. ), dbfArtDiv, dbfTarPreL, aTik[34] )

         if nPrePro == 0

            nTotal            := nRetPreArt( aTik[ 12 ], aTik[ 24 ], if( aTik[ 70 ] <= 1, .T., .F. ), dbfArticulo, dbfDiv, dbfKit, dbfIva, .T. )

            if nTotal <> 0
               nOldPvp        := nTotal
               aGet[ 7 ]:cText( nTotal )
               oGetTotal:cText( aTmp[ 7 ] * aTmp[ 8 ] )
            end

         else

            aGet[ 7 ]:cText( nPrePro )

         end





         nNumDto              := RetFld( aTik[ 11 ], dbfClient, "nDtoArt" )

         if nNumDto <> 0

            do case
               case nNumDto == 1
                  nDtoLin     := ( dbfArticulo )->nDtoArt1

               case nNumDto == 2
                  nDtoLin     := ( dbfArticulo )->nDtoArt2

               case nNumDto == 3
                  nDtoLin     := ( dbfArticulo )->nDtoArt3

               case nNumDto == 4
                  nDtoLin     := ( dbfArticulo )->nDtoArt4

               case nNumDto == 5
                  nDtoLin     := ( dbfArticulo )->nDtoArt5

               case nNumDto == 6
                  nDtoLin     := ( dbfArticulo )->nDtoArt6

            end

            if nDtoLin <> 0

               if !empty( aGet[ 18 ] )
                  aGet[ 18 ]:cText( nDtoLin )
               end

            end

         end





         if nDtoLin == 0
            if !empty( aGet[ 18 ] )
               aGet[ 18 ]:cText( nDescuentoFamilia( cCodFam, dbfFamilia ) )
            else
               aTmp[ 18 ]  := nDescuentoFamilia( cCodFam, dbfFamilia )
            end
         end





         aTmp[ 58 ]    := oFideliza:InPrograma( aTmp[ 5 ], aTik[ 6 ], dbfArticulo )

         if !empty( aGet[ 58 ] )
            if aTmp[ 58 ]
               aGet[ 58 ]:Show()
            else
               aGet[ 58 ]:Hide()
            end
         end





         do case
         case !empty( aTik[ 34 ] )



            nImpOfe     := RetPrcTar( cCodArt, aTik[ 34 ], aTmp[ 19 ], aTmp[ 20 ], aTmp[ 21 ], aTmp[ 22 ], dbfTarPreL, aTik[ 12 ] )
            if nImpOfe  <> 0
               aGet[ 7 ]:cText( nImpOfe + ( ( nImpOfe * aTmp[ 10 ] ) / 100 ) )
            end



            nImpOfe     := RetPctTar( cCodArt, cCodFam, aTik[ 34 ], aTmp[ 19 ], aTmp[ 20 ], aTmp[ 21 ], aTmp[ 22 ], dbfTarPreL )
            if nImpOfe  <> 0
               aGet[18 ]:cText( nImpOfe )
            end



            nImpOfe     := RetLinTar( cCodArt, cCodFam, aTik[ 34 ], aTmp[ 19 ], aTmp[ 20 ], aTmp[ 21 ], aTmp[ 22 ], dbfTarPreL )
            if nImpOfe  <> 0
               aGet[ 24 ]:cText( nImpOfe )
            end

         end





         hAtipica := hAtipica( hValue( aTmp, aTik ) )

         if !empty( hAtipica )

            if hhaskey( hAtipica, "nTarifaFamilia" ) .AND. hAtipica[ "nTarifaFamilia" ] > 0

               aGet[ 7 ]:cText( nRetPreArt( hAtipica[ "nTarifaFamilia" ], aTik[ 24 ], if( aTik[ 70 ] <= 1, .T., .F. ), dbfArticulo, dbfDiv, dbfKit, dbfIva, .T. ) )

            end

            if hhaskey( hAtipica, "nImporte" )
               if hAtipica[ "nImporte" ] <> 0
                  aGet[ 7 ]:cText( hAtipica[ "nImporte" ] )
               end
            end

            if hhaskey( hAtipica, "nDescuentoPorcentual" ) .AND. aTmp[ 18 ] == 0
               if hAtipica[ "nDescuentoPorcentual"] <> 0
                  aGet[ 18 ]:cText( hAtipica[ "nDescuentoPorcentual"] )
               end
            end

            if hhaskey( hAtipica, "nDescuentoLineal" ) .AND. aTmp[ 24 ] == 0
               if hAtipica[ "nDescuentoLineal" ] <> 0
                  aGet[ 24 ]:cText( hAtipica[ "nDescuentoLineal" ] )
               end
            end

         end

      end





      lBuscaOferta( cCodArt, aGet, aTmp, aTik, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )





      cOldCodArt  := cCodArt
      cOldPrpArt  := cPrpArt

      if empty( aTmp[ 7 ] ) .OR. ( RolesModel():getRolCambiarPrecios( Auth():rolUuid() ) )
         if( !empty( aGet[ 7 ] ), aGet[ 7 ]:HardEnable(), )
         if( !empty( aGet[ 24 ] ), aGet[ 24 ]:HardEnable(), )
         if( !empty( aGet[ 18 ] ), aGet[ 18 ]:HardEnable(), )
      else
         if( !empty( aGet[ 7 ] ), aGet[ 7 ]:HardDisable(), )
         if( !empty( aGet[ 24 ] ), aGet[ 24 ]:HardDisable(), )
         if( !empty( aGet[ 18 ] ), aGet[ 18 ]:HardDisable(), )
      end

   else

      SetLostFocusOff()
      MsgBeepStop( "Artículo con código " + rtrim( cCodArt ) + " no encontrado" )
      SetLostFocusOn()

      Return .F.

   end

Return .T.



Static Function lExacto( aTmp )

   local lImporteExacto := lImporteExacto()

   if lImporteExacto
      aTmp[ 22 ]  -= nTotCobTik( nil, dbfTmpP, dbfDiv, cDivEmp() )
      aTmp[ 22 ]  -= nTmpValTik( dbfTmpV, dbfTikL, dbfDiv, cDivEmp() )
      aTmp[ 22 ]  -= nTotAntFacCli( nil, dbfTmpA, dbfIva, dbfDiv, cDivEmp() )
   end

Return ( lImporteExacto )



Static Function ClickButtonsPago( oBtnPago, aGet )

   aEval( aButtonsPago, {|o| o:oButton:lBtnDown := .F., o:oButton:Refresh() } )

   oBtnPago:lBtnDown := .T.

   aGet[ 21 ]:cText( oBtnPago:Cargo )
   aGet[ 21 ]:lValid()

Return ( nil )



Static Function ClickButtonsMode( aTmp )

   do case
      case aTmp[ 4 ] == "1"

         aTmp[ 4 ]        := "3"
         oBtnTipoVta:cPrompt     := "Factura"
         oBtnTipoVta:cxBmp       := "gc_document_text_user_32"

      case aTmp[ 4 ] == "3"

            aTmp[ 4 ]     := "1"
            oBtnTipoVta:cPrompt  := "Ticket"
            oBtnTipoVta:cxBmp    := "gc_cash_register_user_32"

      case aTmp[ 4 ] == "2"

         aTmp[ 4 ]        := "1"
         oBtnTipoVta:cPrompt     := "Ticket"
         oBtnTipoVta:cxBmp       := "gc_cash_register_user_32"

   end

Return ( nil )







STATIC FUNCTION lCobro( aTmp, aGet, nSave, nMode, lGenVale, nDifVale, lBig, oDlgTpv )

   local n
   local oDlg
   local oBtnTop
   local oBtnDwn
   local oBtnAceptar
   local oBtnInsertarCobro
   local oBtnAceptarImprimir
   local oBtnAceptarRegalo
   local oBtnCancelar
   local oBtnCalculator
   local oBrwPgo
   local oBrwVal
   local oFntDlg
   local aBtnCob           := Array( 8 )
   local aSay              := Array( 3 )
   local aGetCob           := Array( 5 )
   local lIntClk           := .T.
   local aBtnFormaPago     := Array( 5 )
   local aSayFormaPago     := Array( 5 )
   local oBmpTitulo
   local oSayTitulo
   local cImageTitle
   local cTextTitle        := ""
   local lWhen
   local nScreenVertRes    := GetSysMetrics( 1 )
   local cResource         := "COBROTPV_1024x768"

   If( nSave == nil, nSave := "1", ) ;
   If( nMode == nil, nMode := 2, ) ;
   If( lBig == nil, lBig := .F., ) ;

   if ( nSave == "5" )
      Return ( .T. )
   end

   lWhen                   := ( nSave <> "4" .AND. nSave <> "6" ) .OR. ( nMode == 1 )

   if isNil( aButtonsMoney )
      aButtonsMoney        := Array(16)
   end





   if !empty( oDlgTpv )
      aEval( oDlgTpv:aControls, { | oCtrl | oCtrl:Disable() } )
   end

   oFntDlg                 := TFont():New( "Segoe UI", 12, 32, .F., .T.,  )

   if empty( oTotDiv )
      oTotDiv              := TotalesTPV():Init()
   end

   oTotDiv:nTotal          := aTmp[ 22 ]

   if empty( aTmp[ 11 ] )
      aTmp[ 11 ]     := cDefCli()
   end

   if nMode == 1 .AND. empty( aTmp[ 21 ] )
      if !uFieldEmpresa( "lGetFpg" )
         aTmp[ 21 ]  := cDefFpg()
      else
         aTmp[ 21 ]  := Space( 2 )
      end
   end





   if nMode == 4
      ( dbfTmpP )->( __dbZap() )
   end

   ( dbfTmpP )->( dbGoTop() )





   do case
      case nSave == "1"
         cImageTitle := "gc_cash_register_user_48"
         cTextTitle  := "El documento actual se cobrará y guardará como un ticket de cliente."
      case nSave == "2"
         cImageTitle := "gc_document_empty_user_48"
         cTextTitle  := "El documento actual se guardará como un albaran de cliente."
      case nSave == "3"
         cImageTitle := "gc_document_text_user2_48"
         cTextTitle  := "El documento actual se guardará como una factura de cliente."
      case nSave == "4"
         cImageTitle := "gc_cash_register_delete_48"
         cTextTitle  := "El documento actual se guardará como una devolución a cliente."
      case nSave == "6" .AND. !aTmp[ 64 ]
         cImageTitle := "gc_cash_register_delete_48"
         cTextTitle  := "El documento actual se guardará como un vale a cliente."
      case nSave == "6" .AND. aTmp[ 64 ]
         cImageTitle := "gc_cash_register_gift_48"
         cTextTitle  := "El documento actual se guardará como un cheque regalo."
      case nSave == "5"
         cImageTitle := "gc_cash_register_delete_48"
         cTextTitle  := "El documento actual se guardará como un apartado."
   end





   do case
      case nScreenVertRes == 600
         cResource   := "COBROTPV_800x600"
      case nScreenVertRes == 768
         cResource   := "COBROTPV_1024x768"
      case nScreenVertRes == 1024
         cResource   := "COBROTPV_1280x1024"
   end





   oDlg = TDialog():New(,,,, cTextTitle, cResource,, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmpTitulo := TBitmap():ReDefine( 500, ( cImageTitle ),, oDlg,,, .F., .F.,,, .F.,,, .T. )

      oSayTitulo := TSay():ReDefine( 510, {|| ( cTextTitle )}, oDlg,,,, .F.,, .F., .F., )

      aSay[ 1 ] := TSay():ReDefine( 910,, oDlg,,,, .F.,, .F., .F., )
      aSay[ 2 ] := TSay():ReDefine( 911,, oDlg,,,, .F.,, .F., .F., )
      aSay[ 3 ] := TSay():ReDefine( 912,, oDlg,,,, .F.,, .F., .F., )












      aGet[ 21 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 21 ], aTmp[ 21 ]:= u ) }, oDlg,,, {||       cFpago( aGet[ 21 ], dbfFPago, aGet[ 21 ]:oHelpText )},,, oFntDlg,,, .F., {||        ( lWhen )},, .F., .F.,,,,,, nil,,, 121 )

         aGet[ 21 ]:bHelp  := {|| BrwPgoTactil( aGet[ 21 ], dbfFPago, aGet[ 21 ]:oHelpText ) }





      for n := 1 to len( aButtonsPago )

         aButtonsPago[ n ]:oButton        := ApoloBtnBmp():Redefine( ( 600 + n ), aButtonsPago[ n ]:cBigResource, , , , , {|o| ClickButtonsPago( o, aGet ) }, oDlg, , , .F., .F., aButtonsPago[ n ]:cText, , , , .T., "TOP", .T., , , .F., )
         aButtonsPago[ n ]:oButton:Cargo  := aButtonsPago[ n ]:cCode
         aButtonsPago[ n ]:oButton:bWhen  := {|| ( lWhen ) }

         if aButtonsPago[ n ]:oButton:Cargo == aTmp[ 21 ]
            aButtonsPago[ n ]:oButton:lBtnDown := .T.
         end

      next










      oTotDiv:oTotal := TSay():ReDefine( 150, {||      oTotDiv:nTotal}, oDlg, cPorDiv,,, .F., oFntDlg, .F., .F., )










      oTotDiv:oEntregado := TSay():ReDefine( 160, {||      oTotDiv:nEntregado}, oDlg, cPorDiv,,, .F., oFntDlg, .F., .F., )










      aButtonsMoney[ 1 ] := TButtonBmp():ReDefine( 800, {||( ClkMoneda( 500, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img500Euros",,, .F. )






      aButtonsMoney[ 2 ] := TButtonBmp():ReDefine( 801, {||( ClkMoneda( 200, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img200Euros",,, .F. )






      aButtonsMoney[ 3 ] := TButtonBmp():ReDefine( 802, {||( ClkMoneda( 100, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img100EUROS",,, .F. )






      aButtonsMoney[ 4 ] := TButtonBmp():ReDefine( 803, {||( ClkMoneda( 50, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img50EUROS",,, .F. )






      aButtonsMoney[ 5 ] := TButtonBmp():ReDefine( 804, {||( ClkMoneda( 20, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img20EUROS",,, .F. )






      aButtonsMoney[ 6 ] := TButtonBmp():ReDefine( 805, {||( ClkMoneda( 10, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img10EUROS",,, .F. )






      aButtonsMoney[ 7 ] := TButtonBmp():ReDefine( 806, {||( ClkMoneda( 5, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img5EUROS",,, .F. )






      aButtonsMoney[ 8 ] := TButtonBmp():ReDefine( 807, {||( ClkMoneda( 2, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img2EUROS",,, .F. )






      aButtonsMoney[ 9 ] := TButtonBmp():ReDefine( 808, {||( ClkMoneda( 1, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img1EURO",,, .F. )






      aButtonsMoney[ 10 ] := TButtonBmp():ReDefine( 809, {||( ClkMoneda( 0.50, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img50CENT",,, .F. )






      aButtonsMoney[ 11 ] := TButtonBmp():ReDefine( 810, {||( ClkMoneda( 0.20, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img20CENT",,, .F. )






      aButtonsMoney[ 12 ] := TButtonBmp():ReDefine( 811, {||( ClkMoneda( 0.10, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img10CENT",,, .F. )






      aButtonsMoney[ 13] := TButtonBmp():ReDefine( 812, {||( ClkMoneda( 0.05, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img5CENT",,, .F. )






      aButtonsMoney[ 14 ] := TButtonBmp():ReDefine( 813, {||( ClkMoneda( 0.02, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img2CENT",,, .F. )






      aButtonsMoney[ 15 ] := TButtonBmp():ReDefine( 814, {||( ClkMoneda( 0.01, oTotDiv:oCobrado, @lIntClk ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img1CENT",,, .F. )






      aButtonsMoney[ 16 ] := TButtonBmp():ReDefine( 815, {||( ClkMoneda( 0, oTotDiv:oCobrado, .T. ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "Img0EUROS",,, .F. )












      oTotDiv:oCobrado := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, oTotDiv:nCobrado, oTotDiv:nCobrado:= u ) }, oDlg,, cPorDiv, {||    ( ChkCobro( aTmp, oTotDiv ) )},,, oFntDlg,,, .F., {||     ( lWhen )},, .F., .F.,,,,,, nil,,, )






      oBtnCalculator := TButtonBmp():ReDefine( 220, {||( Calculadora( 0, oTotDiv:oCobrado ), ChkCobro( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F., "gc_calculator_32",,, .F. )










      oTotDiv:oCambio := TSay():ReDefine( 180, {||      oTotDiv:nCambio}, oDlg, cPorDiv,,, .F., oFntDlg, .F., .F., )





      oBtnInsertarCobro    := ApoloBtnBmp():Redefine( 554, "gc_money2_plus_32", , , , ,            {|| lAddCobro( @aTmp, oTotDiv, oBrwPgo ) }, oDlg, , {|| lWhen }, .F., .F., "Añadir cobro combinado", , , , .T., "TOP", .T., , , .F. )
      oBtnAceptarRegalo    := ApoloBtnBmp():Redefine( 553, "gc_gift_disk_32", , , , , {|| if( lValidaCobro( aGet, @aTmp, @lGenVale, @nDifVale, nSave, oDlg ), ( lCopTik := .T., lRegalo := .T., oDlg:end( 1 ) ), ) }, oDlg, , {|| lWhen }, .F., .F., "Aceptar y ticket regalo", , , , .T., "TOP", .T., , , .F. )
      oBtnAceptarImprimir  := ApoloBtnBmp():Redefine( 1, "gc_printer2_disk_32", , , , ,   {|| if( lValidaCobro( aGet, @aTmp, @lGenVale, @nDifVale, nSave, oDlg ), ( lCopTik := .T., oDlg:end( 1 ) ), ) }, oDlg, , {|| lWhen }, .F., .F., "Aceptar e imprimir [F6]", ,,, .T., "TOP", .T., , , .F. )
      oBtnAceptar          := ApoloBtnBmp():Redefine( 552, "gc_check_32", , , , ,                 {|| if( lValidaCobro( aGet, @aTmp, @lGenVale, @nDifVale, nSave, oDlg ), ( lCopTik := .F., oDlg:end( 1 ) ), ) }, oDlg, , {|| lWhen }, .F., .F., "Aceptar sin imprimir [F5]", ,,, .T., "TOP", .T., , , .F. )
      oBtnCancelar         := ApoloBtnBmp():Redefine( 2, "Del32", , , , ,                {|| oDlg:end() }, oDlg, , , .F., .F., "Cancelar", , , , .T., "TOP", .T., , , .F. )






      if nSave == "2"









         aBtnCob[ 1 ] := TButton():ReDefine( 300, {||( WinAppRec( oBrwPgo, bEditE, dbfTmpE, , , aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





         aBtnCob[ 2 ] := TButton():ReDefine( 301, {||( WinEdtRec( oBrwPgo, bEditE, dbfTmpE, , , aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





         aBtnCob[ 3 ] := TButton():ReDefine( 302, {||( if( ( dbfTmpE )->lCloPgo .AND. !oUser():lAdministrador(), MsgStop( "Solo pueden eliminar las entregas cerradas los administradores." ), dbDelRec( oBrwPgo, dbfTmpE ) ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





         aBtnCob[ 6 ] := TButton():ReDefine( 303, {||( PrnEntAlbCli( ( dbfTmpE )->cSerAlb + Str( ( dbfTmpE )->nNumAlb ) + ( dbfTmpE )->cSufAlb + Str( ( dbfTmpE )->nNumRec ), .F., dbfTmpE ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )

         oBrwPgo                 := IXBrowse():New( oDlg )

         oBrwPgo:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
         oBrwPgo:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

         if ( lWhen )
            oBrwPgo:bLDblClick   := {|| WinEdtRec( oBrwPgo, bEditE, dbfTmpE, , aTmp ) }
         end

         oBrwPgo:cAlias          := dbfTmpE
         oBrwPgo:nMarqueeStyle   := 5
         oBrwPgo:cName           := "Pagos.TPV"

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Cerrado"
            :nHeadBmpNo       := 3
            :bEditValue       := {|| ( dbfTmpE )->lCloPgo }
            :nWidth           := 20
            :SetCheck( { "Sel16", "Nil16" } )
            :AddResource( "gc_lock2_16" )
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpE )->dEntrega ) }
            :nWidth           := 80
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Sesión"
            :bEditValue       := {|| ( dbfTmpE )->cTurRec }
            :nWidth           := 40
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Caja"
            :bEditValue       := {|| ( dbfTmpE )->cCodCaj }
            :nWidth           := 40
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Pago"
            :bEditValue       := {|| ( dbfTmpE )->cCodPgo + Space( 1 ) + RetFld( ( dbfTmpE )->cCodPgo, dbfFPago ) }
            :nWidth           := 140
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Descripción"
            :bEditValue       := {|| ( dbfTmpE )->cDescrip }
            :lHide            := .T.
            :nWidth           := 100
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| nEntAlbCli( dbfTmpE, dbfDiv, cDivEmp(), .T. ) }
            :nWidth           := 80
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         oBrwPgo:CreateFromResource( 310 )

      else







         aBtnCob[ 1 ] := TButton():ReDefine( 300, {||(  if( !( dbfTmpP )->lCloPgo, ( WinAppRec( oBrwPgo, bEditP, dbfTmpP, , , aTmp ), CalImpCob( aTmp ) ), ( MsgStop( "Pago cerrado" ) ) ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )







         aBtnCob[ 2 ] := TButton():ReDefine( 301, {||(  if( !( dbfTmpP )->lCloPgo, ( WinEdtRec( oBrwPgo, bEditP, dbfTmpP, , , aTmp ), CalImpCob( aTmp ) ), ( MsgStop( "Pago cerrado" ) ) ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )







         aBtnCob[ 3 ] := TButton():ReDefine( 302, {||(  if( !( dbfTmpP )->lCloPgo, ( DbDelRec( oBrwPgo, dbfTmpP ), CalImpCob( aTmp ) ), ( MsgStop( "Pago cerrado" ) ) ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )




         aBtnCob[ 6 ] := TButton():ReDefine( 303, {||( nil )}, oDlg,,, .F.,,,, .F. )

         oBrwPgo                 := IXBrowse():New( oDlg )

         oBrwPgo:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
         oBrwPgo:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

         if ( lWhen )
            oBrwPgo:bLDblClick   := {|| if( !( dbfTmpP )->lCloPgo, ( WinEdtRec( oBrwPgo, bEditP, dbfTmpP, , , aTmp ), CalImpCob( aTmp ) ), ( MsgStop( "Pago cerrado" ) ) ) }
         end

         oBrwPgo:cAlias          := dbfTmpP
         oBrwPgo:nMarqueeStyle   := 5
         oBrwPgo:cName           := "Pagos.TPV"

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Cerrado"
            :nHeadBmpNo       := 3
            :bEditValue       := {|| ( dbfTmpP )->lCloPgo }
            :nWidth           := 20
            :SetCheck( { "Sel16", "Nil16" } )
            :AddResource( "gc_lock2_16" )
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Fecha"
            :bEditValue       := {|| Dtoc( ( dbfTmpP )->dPgoTik ) }
            :nWidth           := 80
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Sesión"
            :bEditValue       := {|| ( dbfTmpP )->cTurPgo }
            :nWidth           := 50
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Caja"
            :bEditValue       := {|| ( dbfTmpP )->cCodCaj }
            :nWidth           := 40
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Pago"
            :bEditValue       := {|| ( dbfTmpP )->cFpgPgo + Space( 1 ) + RetFld( ( dbfTmpP )->cFpgPgo, dbfFPago ) }
            :nWidth           := 140
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Descripción"
            :lHide            := .T.
            :bEditValue       := {|| ( dbfTmpP )->cPgdPor }
            :nWidth           := 100
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Importe"
            :bEditValue       := {|| ( dbfTmpP )->nImpTik }
            :cEditPicture     := cPorDiv
            :nWidth           := 80
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         with object ( oBrwPgo:AddCol() )
            :cHeader          := "Devolución"
            :bEditValue       := {|| ( dbfTmpP )->nDevTik }
            :cEditPicture     := cPorDiv
            :nWidth           := 80
            :nDataStrAlign    := 1
            :nHeadStrAlign    := 1
         end

         oBrwPgo:CreateFromResource( 310 )

      end

      do case
      case nSave == "1"

      TGroup():ReDefine( 900, "Vales", oDlg )





      aBtnCob[ 4 ] := TButton():ReDefine( 320, {||( BrwVale( D():Tikets( nView ), dbfTikL, dbfIva, dbfDiv, dbfTmpV, oBrwVal, .F., aTmp ), CalImpCob( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      aBtnCob[ 5 ] := TButton():ReDefine( 321, {||( WinDelRec( oBrwVal, dbfTmpV, nil, nil, .T. ), CalImpCob( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      aBtnCob[ 7 ] := TButton():ReDefine( 322, {||( GetVale( oBrwVal, aTmp ), CalImpCob( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      aBtnCob[ 8 ] := TButton():ReDefine( 323, {||( BrwVale( D():Tikets( nView ), dbfTikL, dbfIva, dbfDiv, dbfTmpV, oBrwVal, .T., aTmp ), CalImpCob( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )

      oBrwVal                 := IXBrowse():New( oDlg )

      oBrwVal:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwVal:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwVal:cAlias          := dbfTmpV
      oBrwVal:nMarqueeStyle   := 6
      oBrwVal:cName           := "Vales.TPV"

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Número"
         :bEditValue       := {|| ( dbfTmpV )->cSerTik + "/" + lTrim( ( dbfTmpV )->cNumTik ) + "/" + ( dbfTmpV )->cSufTik  }
         :nWidth           := 60
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Fecha"
         :bEditValue       := {|| Dtoc( ( dbfTmpV )->dFecTik ) }
         :nWidth           := 70
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| ( dbfTmpV )->cTurTik }
         :nWidth           := 50
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
         :lHide            := .T.
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Código"
         :bEditValue       := {|| ( dbfTmpV )->cCliTik }
         :nWidth           := 60
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Nombre"
         :bEditValue       := {|| ( dbfTmpV )->cNomTik }
         :nWidth           := 140
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( dbfTmpV )->cCcjTik }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Almacén"
         :bEditValue       := {|| ( dbfTmpV )->cAlmTik }
         :nWidth           := 40
         :lHide            := .T.
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotalizer( ( dbfTmpV )->cSerTik + ( dbfTmpV )->cNumTik + ( dbfTmpV )->cSufTik, D():Tikets( nView ), dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, cDivEmp(), .T. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( ( dbfTmpV )->cDivTik, dbfDiv )}
         :nWidth           := 20
      end

      oBrwVal:CreateFromResource( 330 )

      case nSave == "3"

      TGroup():ReDefine( 900, "Anticipos", oDlg )





      aBtnCob[ 4 ] := TButton():ReDefine( 320, {||( BrwAntCli( nil, dbfAntCliT, dbfIva, dbfDiv, dbfTmpA, oBrwVal ), CalImpCob( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      aBtnCob[ 5 ] := TButton():ReDefine( 321, {||( WinDelRec( oBrwVal, dbfTmpA, nil, nil, .T. ), CalImpCob( aTmp ) )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )

      oBrwVal                 := IXBrowse():New( oDlg )

      oBrwVal:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwVal:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwVal:cAlias          := dbfTmpA
      oBrwVal:nMarqueeStyle   := 5
      oBrwVal:cName           := "Anticipos.TPV"

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Número"
         :bEditValue       := {|| ( dbfTmpA )->cSerAnt + "/" + lTrim( Str( ( dbfTmpA )->nNumAnt ) ) + "/" + ( dbfTmpA )->cSufAnt }
         :nWidth           := 80
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Fecha"
         :bEditValue       := {|| Dtoc( ( dbfTmpA )->dFecAnt ) }
         :nWidth           := 80
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Sesión"
         :bEditValue       := {|| ( dbfTmpA )->cTurAnt }
         :nWidth           := 50
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Código"
         :bEditValue       := {|| ( dbfTmpA )->cCodCli }
         :nWidth           := 80
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Nombre"
         :bEditValue       := {|| ( dbfTmpA )->cNomCli }
         :nWidth           := 180
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Caja"
         :bEditValue       := {|| ( dbfTmpA )->cCodCaj }
         :nWidth           := 40
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Almacén"
         :bEditValue       := {|| ( dbfTmpA )->cCodAlm }
         :nWidth           := 40
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Importe"
         :bEditValue       := {|| nTotAntCli( dbfTmpA, dbfIva, dbfDiv, nil, cDivEmp(), .T. ) }
         :nWidth           := 80
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end

      with object ( oBrwVal:AddCol() )
         :cHeader          := "Div."
         :bEditValue       := {|| cSimDiv( ( dbfTmpA )->cDivAnt, dbfDiv ) }
         :nWidth           := 20
      end

      oBrwVal:CreateFromResource( 330 )

      otherwise





      aBtnCob[ 4 ] := TButton():ReDefine( 320, {||( nil )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      aBtnCob[ 5 ] := TButton():ReDefine( 321, {||( nil )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      aBtnCob[ 7 ] := TButton():ReDefine( 322, {||( nil )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      aBtnCob[ 8 ] := TButton():ReDefine( 323, {||( nil )}, oDlg,,, .F., {||     ( lWhen )},,, .F. )





      oBrwVal := TWBrowse():ReDefine( 330, {|| { "" } }, oDlg, {""},,,,,,,,,,,,, .F.,,,,, )

      end

      oDlg:bStart    := {|| StartCobro( aTmp, aGet, aSay, aGetCob, oBrwPgo, oBrwVal, aBtnCob, oBtnTop, oBtnDwn, oBtnInsertarCobro, oBtnAceptarRegalo, oBtnCalculator, nSave, nMode, lBig ) }

      oDlg:AddFastKey( 116, {|| if( !empty( oBtnAceptar ), oBtnAceptar:Click(), ) } )
      oDlg:AddFastKey( 117, {|| if( !empty( oBtnAceptarImprimir ), oBtnAceptarImprimir:Click(), ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )





   if !empty( oDlgTpv )
      aEval( oDlgTpv:aControls, { | oCtrl | oCtrl:Enable() } )
   end

   oFntDlg:end()

   if oBmpTitulo <> nil
      oBmpTitulo:end()
   end

RETURN ( oDlg:nResult == 1 )



Static Function StartCobro( aTmp, aGet, aSay, aGetCob, oBrwPgo, oBrwVal, aBtnCob, oBtnTop, oBtnDwn, oBtnInsertarCobro, oBtnAceptarRegalo, oBtnCalculator, nSave, nMode, lBig )

   CalImpCob( aTmp )

   ChkCobro( aTmp )





   if aGetCob[ 2 ] <> nil
      aGetCob[ 2 ]:lValid()
   end

   if aGetCob[ 3 ] <> nil
      aGetCob[ 3 ]:lValid()
   end

   if !lBig

      do case
      case ( nSave == "6" .AND. aTmp[ 64 ] )

         if !empty( oBrwVal )
            oBrwVal:Hide()
         end

         if !empty( aBtnCob[ 4 ] )
            aBtnCob[ 4 ]:Hide()
         end

         if !empty( aBtnCob[ 5 ] )
            aBtnCob[ 5 ]:Hide()
         end

         if !empty( aBtnCob[ 6 ] )
            aBtnCob[ 6 ]:Hide()
         end

         if !empty( aBtnCob[ 7 ] )
            aBtnCob[ 7 ]:Hide()
         end

         if !empty( aBtnCob[ 8 ] )
            aBtnCob[ 8 ]:Hide()
         end

      case ( nSave == "6" .AND. !aTmp[ 64 ] )

         aEval( aButtonsPago, {|o| o:oButton:Hide() } )
         aEval( aButtonsMoney, {|o| o:Hide() } )

         if !empty( oBtnInsertarCobro )
            oBtnInsertarCobro:Hide()
         end

         if !empty( oBtnAceptarRegalo )
            oBtnAceptarRegalo:Hide()
         endif

         oTotDiv:oEntregado:Hide()
         oTotDiv:oCobrado:Hide()
         oTotDiv:oCambio:Hide()

         if ( !empty( aBtnCob[ 1 ] ), aBtnCob[ 1 ]:Hide(), )
         if ( !empty( aBtnCob[ 2 ] ), aBtnCob[ 2 ]:Hide(), )
         if ( !empty( aBtnCob[ 3 ] ), aBtnCob[ 3 ]:Hide(), )
         if ( !empty( aBtnCob[ 4 ] ), aBtnCob[ 4 ]:Hide(), )
         if ( !empty( aBtnCob[ 5 ] ), aBtnCob[ 5 ]:Hide(), )
         if ( !empty( aBtnCob[ 6 ] ), aBtnCob[ 6 ]:Hide(), )
         if ( !empty( aBtnCob[ 7 ] ), aBtnCob[ 7 ]:Hide(), )
         if ( !empty( aBtnCob[ 8 ] ), aBtnCob[ 8 ]:Hide(), )

         aSay[ 1 ]:Hide()
         aSay[ 2 ]:Hide()
         aSay[ 3 ]:Hide()

         if !empty( aGetCob[ 1 ] )
            aGetCob[ 1 ]:SetFocus()
         end

         if !empty( oBrwVal )
            oBrwVal:Hide()
         end

         if !empty( oBrwPgo )
            oBrwPgo:Hide()
         end

         if !empty( oBtnCalculator )
            oBtnCalculator:Hide()
         end

      case ( nSave == "2" ) .OR. ( nSave == "4" ) .OR. ( nSave == "5" )

         oTotDiv:oEntregado:Hide()
         oTotDiv:oCobrado:Hide()
         oTotDiv:oCambio:Hide()

         if !empty( aBtnCob[ 4 ] )
            aBtnCob[ 4 ]:Hide()
         end

         if !empty( aBtnCob[ 5 ] )
            aBtnCob[ 5 ]:Hide()
         end

         if ( nSave == "2" )
            if !empty( aBtnCob[ 6 ] )
               aBtnCob[ 6 ]:Show()
            else
               aBtnCob[ 6 ]:Hide()
            end
         end

         if !empty( aBtnCob[ 7 ] )
            aBtnCob[ 7 ]:Hide()
         end

         if !empty( aBtnCob[ 8 ] )
            aBtnCob[ 8 ]:Hide()
         end

         aSay[ 1 ]:Hide()
         aSay[ 2 ]:Hide()
         aSay[ 3 ]:Hide()

         if !empty( aGetCob[ 1 ] )
            aGetCob[ 1 ]:SetFocus()
         end

         if !empty( oBrwVal )
            oBrwVal:Hide()
         end

         if !empty( oBtnCalculator )
            oBtnCalculator:Hide()
         end

      case nSave == "3"

         if !empty( aGetCob[ 1 ] )
            aGetCob[ 1 ]:SetFocus()
         end

         if !empty( aBtnCob[ 6 ] )
            aBtnCob[ 6 ]:Hide()
         end

      end



      if ( nSave == "2" ) .OR. ( nSave == "3" )

         aGet[ 21 ]:Show()
         aGet[ 21 ]:lValid()

         aEval( aButtonsPago, {|oBtn| if( !empty( oBtn:oButton ), oBtn:oButton:Hide(), ), if( !empty( oBtn:oSay ), oBtn:oSay:Hide(), ) } )

      else

         aGet[ 21 ]:Hide()

         aEval( aButtonsPago, {|oBtn| if( !empty( oBtn:oButton ), oBtn:oButton:Show(), ), if( !empty( oBtn:oSay ), oBtn:oSay:Show(), ) } )

      end



      if nMode <> 1

         if oBtnTop <> nil
            oBtnTop:Hide()
         end

         if oBtnDwn <> nil
            oBtnDwn:Hide()
         end

         if nSave <> "2" .AND. !empty( aBtnCob[ 6 ] )
            aBtnCob[ 6 ]:Hide()
         end

      end

   end

   if !lBig





      if !empty( aGet[ 11 ] )
         aGet[ 11 ]:lValid()
      end

   end

Return .T.



Static Function lValidaCobro( aGet, aTmp, lGenVale, nDifVale, nSave, oDlg )

   local nTotalVale





   if empty( aTmp[ 21 ] )
      msgStop( "Tiene que seleccionar una forma de pago" )
      aGet[ 21 ]:SetFocus()
      Return .F.
   end





   aEval( oDlg:aControls, {|o| o:Disable() } )





   ChkCobro( aTmp )





   nTotalVale              := nTmpValTik( dbfTmpV, dbfTikL, dbfDiv, cDivEmp() )
   nDifVale                := nTotalVale - oTotDiv:nTotal





   aTmp[ 50 ]       := .F.





   if lNegativo( oTotDiv:nCambio ) .AND. ( nSave == "1" .OR. nSave == "3" .OR. ( nSave == "6" .AND. aTmp[ 64 ] ) )

      if !MsgBeepYesNo( "¿Desea vender a credito al cliente " + Chr(13)+Chr(10) + Alltrim( aTmp[ 13 ] ) + "?", "Importe insuficiente" )

         aEval( oDlg:aControls, {|o| o:Enable() } )

         return .F.

      else

         aTmp[ 28 ]  := .F.

      end

   else

      aTmp[ 28 ]     := .T.

   end





   if nTotalVale > 0 .AND. nDifVale > 0
      if MsgBeepYesNo( "¿Desea generar un vale por la diferencia?", "Importe de vale excede el total" )
         lGenVale          := .T.
      end
   end

   aTmp[ 22 ]        := oTotDiv:nCobrado
   aTmp[ 23 ]        := oTotDiv:nCambio





   aEval( oDlg:aControls, {|o| o:Enable() } )

return .T.



static function CalImpCob( aTmp )

   oTotDiv:nCobrado        := nTotCobTik( nil, dbfTmpP, dbfDiv, cDivEmp() )
   oTotDiv:nVale           := nTmpValTik( dbfTmpV, dbfTikL, dbfDiv, cDivEmp() )
   oTotDiv:nAnticipo       := nTotAntFacCli( nil, dbfTmpA, dbfIva, dbfDiv, cDivEmp() )
   oTotDiv:nEntregado      := ( oTotDiv:nCobrado + oTotDiv:nVale + oTotDiv:nAnticipo )
   oTotDiv:nCobrado        := ( oTotDiv:nTotal - oTotDiv:nEntregado )
   oTotDiv:nCambio         := - ( oTotDiv:nTotal - oTotDiv:nEntregado - oTotDiv:nCobrado )

   if !empty( oTotDiv:oEntregado )
      oTotDiv:oEntregado:Refresh()
   end

   if !empty( oTotDiv:oCobrado )
      oTotDiv:oCobrado:Refresh()
   end

   if !empty( oTotDiv:oCambio )
      oTotDiv:oCambio:Refresh()
   end

return .T.



static function ChkCobro( aTmp )

   oTotDiv:nCambio            := - ( oTotDiv:nTotal - oTotDiv:nEntregado - oTotDiv:nCobrado )

   if !empty( oTotDiv:oCobrado )
      oTotDiv:oCobrado:Refresh()
   end

   if !empty( oTotDiv:oCambio )
      oTotDiv:oCambio:Refresh()
   end

return .T.




















Static Function BrwVale( cTikT, dbfTikL, dbfIva, dbfDiv, dbfTmpV, oBrwVal, lCliente, aTmp )

   local oDlg
    local oBrw
   local aGet1
    local cGet1
   local dbfVal
   local lError         := .F.
   local oError
   local oBlock
   local cNewFil
   local oCbxOrd
   local oBtnSelect
   local oBtnUnSelect
   local cCbxOrd        := "Número"
   local aCbxOrd        := { "Número", "Código cliente", "Nombre cliente" }
   local cCodCliente    := aTmp[ 11 ]
   local cText          := ""
   local nRecAnt        := ( D():Tikets( nView ) )->( RecNo() )
   local nOrdAnt        := ( D():Tikets( nView ) )->( ordsetfocus( "cCliVal" ) )

   If( lCliente == nil, lCliente := .F., ) ;





   cNewFil              := cGetNewFileName( cPatTmp() + "TikT" )

   dbCreate( cNewFil, aSqlStruct( aItmTik() ), cLocalDriver() )

   dbUseArea( .T., cLocalDriver(), cNewFil, cCheckArea( "TikT", @dbfVal ), .F. )
   if !NetErr()
      ( dbfVal )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfVal )->( OrdCreate( cNewFil, "cNumTik", "cSerTik + cNumTik + cSufTik", {|| Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( dbfVal )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfVal )->( OrdCreate( cNewFil, "cCliTik", "cCliTik", {|| Field->cCliTik } ) )

      ( dbfVal )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfVal )->( OrdCreate( cNewFil, "cNomTik", "cNomTik", {|| Field->cNomTik } ) )
   end





   ( D():Tikets( nView ) )->( dbGoTop() )

   if !lCliente

      while !( D():Tikets( nView ) )->( eof() )
         dbPass( D():Tikets( nView ), dbfVal, .T. )
         ( D():Tikets( nView ) )->( dbSkip() )
      end

   else

      if ( D():Tikets( nView ) )->( dbSeek( cCodCliente ) )
         while ( D():Tikets( nView ) )->cCliTik == cCodCliente .AND. !( D():Tikets( nView ) )->( eof() )
            dbPass( D():Tikets( nView ), dbfVal, .T. )
            ( D():Tikets( nView ) )->( dbSkip() )
         end
      end

   end





   ( dbfVal  )->( ordsetfocus( "cNumTik" ) )
   ( dbfTmpV )->( dbGoTop() )

   while !( dbfTmpV )->( eof() )
      if ( dbfVal )->( dbSeek( ( dbfTmpV )->cSerTik + ( dbfTmpV )->cNumTik + ( dbfTmpV )->cSufTik ) )
        ( dbfVal )->lSelDoc   := .T.
      end
      ( dbfTmpV )->( dbSkip() )
   end

   ( dbfVal  )->( ordsetfocus( "cNumTik" ) )
   ( dbfVal  )->( dbGoTop() )





   oDlg = TDialog():New(,,,, "Seleccionar vales", "HelpEntry",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )








      aGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,, "@!", {||    ( OrdClearScope( oBrw, dbfVal ) )},,,,,, .F.,, {|nKey,nFlags,Self| ( AutoSeek( nKey, nFlags, Self, oBrw, dbfVal, .T. ) ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( CambiarOrd( oBrw, oCbxOrd, dbfVal ) )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                    := IXBrowse():New( oDlg )

      oBrw:bClrSel            := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus       := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias             := dbfVal
      oBrw:cName              := "Vale detalle"
      oBrw:bLDblClick         := {|| if( dbLock( dbfVal ), ( ( dbfVal )->lSelDoc := !( dbfVal )->lSelDoc, ( dbfVal )->( dbUnLock() ) ), ), oBrw:DrawSelect() }

      oBrw:nMarqueeStyle      := 5

      with object ( oBrw:AddCol() )
         :cHeader             := "Se. Seleccionado"
         :bStrData            := {|| "" }
         :bEditValue          := {|| ( dbfVal )->lSelDoc }
         :nWidth              := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Número"
         :cSortOrder          := "cLiqVal"
         :bEditValue          := {|| ( dbfVal )->cSerTik + "/" + AllTrim( ( dbfVal )->cNumTik ) + "/" + ( dbfVal )->cSufTik }
         :nWidth              := 70
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Fecha"
         :bEditValue          := {|| Dtoc( ( dbfVal )->dFecTik ) }
         :nWidth              := 70
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Código cliente"
         :bEditValue          := {|| Rtrim( ( dbfVal )->cCliTik ) }
         :cSortOrder          := "cCliVal"
         :nWidth              := 75
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Nombre cliente"
         :bEditValue          := {|| AllTrim( ( dbfVal )->cNomTik ) }
         :cSortOrder          := "cNomVal"
         :nWidth              := 150
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Importe "
         :bEditValue          := {|| nTotalizer( ( dbfVal )->cSerTik + ( dbfVal )->cNumTik + ( dbfVal )->cSufTik, dbfVal, dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, cDivEmp(), .T. ) }
         :nWidth              := 85
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Div."
         :bEditValue          := {|| cSimDiv( ( dbfVal )->cDivTik, dbfDiv ) }
         :nWidth              := 30
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Sesión"
         :bEditValue          := {|| ( dbfVal )->cTurTik + "/" + ( dbfVal )->cSufTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Hora"
         :bEditValue          := {|| ( dbfVal )->cHorTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Caja"
         :bEditValue          := {|| ( dbfVal )->cNcjTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Cajero"
         :bEditValue          := {|| ( dbfVal )->cCcjTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Almacén"
         :bEditValue          := {|| ( dbfVal )->cAlmTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      oBrw:CreateFromResource( 105 )




      oBtnSelect := TButton():ReDefine( 500, {||( ( dbfVal )->lSelDoc := .T., oBrw:DrawSelect() )}, oDlg,,, .F.,,,, .F. )




      oBtnUnSelect := TButton():ReDefine( 501, {||( ( dbfVal )->lSelDoc := .F., oBrw:DrawSelect() )}, oDlg,,, .F.,,,, .F. )




        TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116,       {|| oDlg:end( 1 ) } )
   oDlg:AddFastKey( 13,   {|| oDlg:end( 1 ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( SetWindowText( oBtnSelect:hWnd, "&Seleccionar" ), SetWindowText( oBtnUnSelect:hWnd, "&Deseleccionar" ), oBrw:Load() )}, oDlg:bRClicked,,, )





   if oDlg:nResult == 1

      ( dbfTmpV )->( __dbZap() )

      ( dbfVal )->( dbGoTop() )
      while !( dbfVal )->( Eof() )

         if ( dbfVal )->lSelDoc

            if ( dbfVal )->dFecTik + uFieldEmpresa( "nDiaVale" ) > GetSysDate()
               lError   := .T.
               cText    += Space( 6 ) + "El vale " + ( dbfVal )->cSerTik + "/" +  AllTrim( ( dbfVal )->cNumTik ) + " no ha alcanzado la fecha para su liqidación." + Chr(13)+Chr(10)
            end

            if ( dbfVal )->cCliTik <> cCodCliente
               lError   := .T.
               cText    += Space( 6 ) + "El vale " + ( dbfVal )->cSerTik + "/" +  AllTrim( ( dbfVal )->cNumTik ) + " no pertenece al mismo cliente que el ticket." + Chr(13)+Chr(10)
            endif

            if !lError
               dbPass( dbfVal, dbfTmpV, .T. )
            end

         end

         ( dbfVal )->( dbSkip() )

      end

      ( dbfVal )->( dbGoTop() )

      if !empty( cText )
         MsgStop( "Atención : " +  Chr(13)+Chr(10) + cText )
      end

   end





   if !empty( cNewFil ) .AND. ( cNewFil )->( Used() )
      ( cNewFil )->( dbCloseArea() )
   end

   ( D():Tikets( nView ) )->( ordsetfocus( nOrdAnt ) )
   ( D():Tikets( nView ) )->( dbGoTo( nRecAnt ) )

   dbfErase( cNewFil )

   if oBrwVal <> nil
      oBrwVal:Refresh()
   end

RETURN ( oDlg:nResult == 1 )



STATIC FUNCTION CambiarOrd( oBrw, oCbx, cTikT )

   local nOrd  := oCbx:nAt

   do case
      case ( nOrd == 1 )
         ( D():Tikets( nView ) )->( ordsetfocus( "cLiqVal" ) )

      case ( nOrd == 2 )
         ( D():Tikets( nView ) )->( ordsetfocus( "cCliVal" ) )

      case ( nOrd == 3 )
         ( D():Tikets( nView ) )->( ordsetfocus( "cNomVal" ) )

   end

   oBrw:GoTop()

Return nil







STATIC FUNCTION lStdChange( aTmp, aGet )





   if nOldPvp <> aTmp[ 7 ]





      if aTmp[ 25 ] .AND. !empty( nOldPvp )
         aGet[ 8 ]:cText( aTmp[ 7 ] / nOldPvp )
         aGet[ 7 ]:cText( nOldPvp )
      end

   end

RETURN .T.







STATIC FUNCTION lIsCode( aTmp, dbfTmpL, oBrw )

    local lReturn    := .F.
   local nRecno   := ( dbfTmpL )->( RecNo() )





   if ( dbfKit )->( dbSeek( aTmp[ 5 ] ) )
      Return ( lReturn )
   end





   ( dbfTmpL )->( dbGoTop() )
   while !( dbfTmpL )->( eof() )















      if ( dbfTmpL )->cCbaTil == Padr( aTmp[ 5 ], 18 )        .AND.  ( dbfTmpL )->cComTil == aTmp[ 13 ]                    .AND.  ( dbfTmpL )->cCodPr1 == aTmp[ 19 ]                    .AND.  ( dbfTmpL )->cValPr1 == aTmp[ 21 ]                    .AND.  ( dbfTmpL )->cCodPr2 == aTmp[ 20 ]                    .AND.  ( dbfTmpL )->cValPr2 == aTmp[ 22 ]                    .AND.  ( dbfTmpL )->nPvpTil == aTmp[ 7 ]                    .AND.  ( dbfTmpL )->nDtoLin == aTmp[ 18 ]                    .AND.  ( dbfTmpL )->cLote == aTmp[ 42 ]                        .AND.  ( dbfTmpL )->dFecCad == aTmp[ 76 ]                    .AND.  Rtrim( ( dbfTmpL )->cNomTil ) == Rtrim( aTmp[ 6 ] )





         ( dbfTmpL )->nUntTil += aTmp[ 8 ]





         lReturn  := .T.

         exit

      end

      ( dbfTmpL )->( dbSkip() )

   end

   ( dbfTmpL )->( dbGoTo( nRecno ) )

   if oBrw <> nil
      oBrw:Refresh()
   end

Return ( lReturn )



STATIC FUNCTION nVentasPrevias( cCodArt, dbfTmpL, nMode )

   local nRecno            := ( dbfTmpL )->( RecNo() )
   local nVentasPrevias    := 0

   if nMode == 1





      ( dbfTmpL )->( dbGoTop() )
      while !( dbfTmpL )->( eof() )





         if ( dbfTmpL )->cCbaTil == cCodArt
            nVentasPrevias += ( dbfTmpL )->nUntTil
         end

         ( dbfTmpL )->( dbSkip() )

      end

   end

   ( dbfTmpL )->( dbGoTo( nRecno ) )

RETURN ( nVentasPrevias )






STATIC FUNCTION lChkOfe( aTmp, aTik, dbfTmpL, oBrw )

    local lOfe        := .F.
    local dFecTik    := aTik[ 6 ]
   local nRecno   := ( dbfTmpL )->( RecNo() )

   ( dbfTmpL )->( dbGoTop() )

   WHILE !( dbfTmpL )->( eof() )





      IF !( dbfTmpL )->LOFETIL





         IF lIsOfe( dFecTik, aTmp, dbfTmpL, dbfOferta )





                lOfe := .T.

            end

        end

      ( dbfTmpL )->( dbSkip() )

    end

   ( dbfTmpL )->( dbGoTo( nRecno ) )

    oBrw:refresh()

RETURN lOfe







STATIC FUNCTION lIsOfe( dFecOfe, aTmp, dbfTemp, dbfOferta )

    local lPreOfe    := .F.
   local cCodArt  := ( dbfTmpL )->cCbaTil
   local nUntArt  := ( dbfTmpL )->nUntTil





   if ( dbfOferta )->( dbSeek( cCodArt ) )

      while ( dbfOferta )->cArtOfe == cCodArt .AND. !( dbfOferta )->( eof() )






         if ( dFecOfe >= ( dbfOferta )->dIniOfe .OR. empty( ( dbfOferta )->dIniOfe ) ) .AND.  ( dFecOfe <= ( dbfOferta )->dFinOfe .OR. empty( ( dbfOferta )->dFinOfe ) )






            if ( dbfOferta )->nMaxOfe == 0                                 .OR.  nUntArt + ( dbfOferta )->nUdvOfe > ( dbfOferta )->nMaxOfe







               if mod( nUntArt, ( dbfOferta )->nUnvOfe ) == 0







                  ( dbfTmpL )->cNomTil  := ( dbfOferta )->CDESOFE
                  ( dbfTmpL )->nUntTil  := nUntArt / ( dbfOferta )->NUNVOFE
                  ( dbfTmpL )->nPvpTil  := ( dbfOferta )->nPreIva1
                  ( dbfTmpL )->lOfeTil  := .T.

                  lPreOfe               := .T.

                        EXIT

               end

            end

         end

        ( dbfOferta )->( dbSkip() )

      end

   end

RETURN lPreOfe







STATIC FUNCTION lIsOfeYet( dbfTmpL, oBrw )

    local aTmp
    local nRecIni
   local nRecFin  := ( dbfTmpL )->( recno() )

   ( dbfTmpL )->( dbGoTop() )

   while !( dbfTmpL )->( eof() ) .AND. ( dbfTmpL )->( ordKeyCount() ) > 1

      nRecIni  := ( dbfTmpL )->( RecNo() )
      aTmp     := dbScatter( dbfTmpL )
      ( dbfTmpL )->( dbSkip(1) )

      while !( dbfTmpL )->( eof() )








         IF ( dbfTmpL )->cCbaTil == aTmp[ 5 ] .AND.  ( dbfTmpL )->cNomTil == aTmp[ 6 ] .AND.  ( dbfTmpL )->nPvpTil == aTmp[ 7 ] .AND.  ( dbfTmpL )->lFreTil == aTmp[ 17 ]





            aTmp[ 8 ] += ( dbfTmpL )->NUNTTIL
            delRecno( dbfTmpL, oBrw )
            dbGather( aTmp, dbfTmpL )

         end

         ( dbfTmpL )->( dbSkip() )

      end

      ( dbfTmpL )->( dbGoTo( ++nRecIni ) )

    end

   ( dbfTmpL )->( dbGoTo( nRecFin ) )

RETURN NIL







STATIC FUNCTION ChgDiv( cCodDiv, dbfDiv, oNumTot )

   cPouDiv              := cPouDiv( cCodDiv, dbfDiv )

   if oNumTot <> nil
        oNumTot:cPicture    := cPouDiv
        oNumTot:refresh()
   end

   if oBrwDet <> nil
        oBrwDet:refresh()
   end

RETURN .T.







FUNCTION dFecTik( cNumTik, uTikT )

   local dDate    := ctod( "" )

   if ValType( uTikT ) == "C"

      if ( uTikT )->( dbSeek( cNumTik ) )
         dDate    := ( uTikT )->dFecTik
      end

   else

      if uTikT:Seek( cNumTik )
         dDate    := uTikT:dFecTik
      end

   end

RETURN dDate







FUNCTION tFecTik( cNumTik, uTikT )

   local tDate    := Replicate( "0", 6 )

   if IsObject( uTikT )
      if uTikT:Seek( cNumTik )
         tDate    := uTikT:tFecTik
      end
   else
      if ( uTikT )->( dbSeek( cNumTik ) )
         tDate    := ( uTikT )->tFecTik
      end
   end

RETURN tDate




























function nPreTpv( uTmp, dbfTmpL )

   local nDec
   local nVdv
   local nCalculo := 0

   if valtype( uTmp ) == "A"
      nDec     := nDouDiv( uTmp[ 24 ], dbfDiv )
      nVdv     := uTmp[ 25 ]
   else
      nDec     := nDouDiv( ( uTmp )->cDivTik, dbfDiv )
      nVdv     := ( uTmp )->nVdvTik
   end

   if !( dbfTmpL )->lFreTil

      nCalculo := ( dbfTmpL )->nPvpTil
      nCalculo -= ( dbfTmpL )->nDtoDiv
      nCalculo -= ( dbfTmpL )->nDtoLin * nCalculo / 100
      nCalculo += ( dbfTmpL )->nPcmTil

      if nVdv <> 0
         nCalculo    := Round( nCalculo / nVdv, nDec )
      end

   end

RETURN ( nCalculo )






function nVtaTik( cCodCli, dDesde, dHasta, cTikT, dbfTikL, dbfIva, dbfDiv, nYear )

   local nCon     := 0
   local aSta     := aGetStatus( cTikT )





   if ( cTikT )->( dbSeek( cCodCli ) )

      while ( cTikT )->cCliTik = cCodCli .AND. !( cTikT )->( Eof() )



         if ( dDesde == nil .OR. ( cTikT )->dFecTik >= dDesde ) .AND. ( dHasta == nil .OR. ( cTikT )->dFecTik <= dHasta ) .AND. ( nYear == nil .OR. Year( ( cTikT )->dFecTik ) == nYear )

            if ( cTikT )->cTipTik == "1"

               nCon  += nTotTik( ( cTikT )->cSerTik + (cTikT)->cNumTik + (cTikT)->cSufTik, cTikT, dbfTikL, dbfDiv, nil, cDivEmp(), .F. )

            elseif ( cTikT )->cTipTik == "4"

               nCon  -= nTotTik( ( cTikT )->cSerTik + (cTikT)->cNumTik + (cTikT)->cSufTik, cTikT, dbfTikL, dbfDiv, nil, cDivEmp(), .F. )

            end

         end

         ( cTikT )->( dbSkip() )

         SysRefresh()

      end

   end

   SetStatus( cTikT, aSta )

return nCon



function nPdtTik( cCodCli, dDesde, dHasta, cTikT, dbfTikL, dbfTikP, dbfIva, dbfDiv )

   local nCon     := 0
   local aSta     := aGetStatus( cTikT )





   if ( cTikT )->( dbSeek( cCodCli ) )

      while ( cTikT )->cCliTik = cCodCli .AND. !( cTikT )->( Eof() )



         if !( cTikT )->lLiqTik                                 .AND. ( dDesde == nil .OR. ( cTikT )->dFecTik >= dDesde ) .AND. ( dHasta == nil .OR. ( cTikT )->dFecTik <= dHasta )

            if ( cTikT )->cTipTik == "1"

               nCon  += nTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, dbfTikL, dbfDiv, nil, cDivEmp(), .F. )
               nCon  -= nTotCobTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, dbfTikP, dbfDiv, cDivEmp() )

            elseif ( cTikT )->cTipTik == "4"

               nCon  -= nTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, dbfTikL, dbfDiv, nil, cDivEmp(), .F. )
               nCon  += nTotCobTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, dbfTikP, dbfDiv, cDivEmp() )

            end

         end

         ( cTikT )->( dbSkip() )

         SysRefresh()

      end

   end

   SetStatus( cTikT, aSta )

return nCon






function nCobTik( cCodCli, dDesde, dHasta, cTikT, dbfTikP, dbfIva, dbfDiv, nYear )

   local nCon     := 0
   local aSta     := aGetStatus( cTikT )

   ( cTikT )->( ordsetfocus( "CCLITIK" ) )





   if ( cTikT )->( dbSeek( cCodCli ) )

      while ( cTikT )->cCliTik = cCodCli .AND. !( cTikT )->( Eof() )



         if ( dDesde == nil .OR. ( cTikT )->dFecTik >= dDesde ) .AND. ( dHasta == nil .OR. ( cTikT )->dFecTik <= dHasta ) .AND. ( nYear == nil .OR. Year( ( cTikT )->dFecTik ) == nYear )

            if ( cTikT )->cTipTik == "1"

               nCon  += nTotCobTik( ( cTikT )->cSerTik + (cTikT)->cNumTik + (cTikT)->cSufTik, dbfTikP, dbfDiv, cDivEmp() )

            elseif ( cTikT )->cTipTik == "4"

               nCon  -= nTotCobTik( ( cTikT )->cSerTik + (cTikT)->cNumTik + (cTikT)->cSufTik, dbfTikP, dbfDiv, cDivEmp() )

            end

         end

         ( cTikT )->( dbSkip() )

         SysRefresh()

      end

   end

   SetStatus( cTikT, aSta )

return nCon



Function nValTik( cCodCli, dDesde, dHasta, cTikT, dbfTikL, dbfDiv, nYear )

   local nCon     := 0
   local aSta     := aGetStatus( cTikT )

   ( cTikT )->( ordsetfocus( "cCliVal" ) )

   if ( cTikT )->( dbSeek( cCodCli ) )

      while ( cTikT )->cCliTik == cCodCli .AND. !( cTikT )->( eof() )



         if ( dDesde == nil .OR. ( cTikT )->dFecTik >= dDesde ) .AND. ( dHasta == nil .OR. ( cTikT )->dFecTik <= dHasta ) .AND. ( nYear == nil .OR. Year( ( cTikT )->dFecTik ) == nYear )

            nCon  += nTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, dbfTikL, dbfDiv, , , .F. )

         end

         ( cTikT )->( dbSkip() )

      end

   end

   SetStatus( cTikT, aSta )

return nCon



Function oWndTactil()

Return oWndBrw



Static Function lValidDlgTpv( aTmp, aGet, nSaveMode )

   local lValid   := .T.

   if ( dbfTmpL )->( ordKeyCount() ) <> 0 .AND. ApoloMsgNoYes( "¿Desea guardar el ticket antes de salir?", "Selecciona una opción", .T. )
      lValid      :=  TmpTiket( aTmp, aGet, nSaveMode, .F. )
   end

Return lValid



Static Function cTitleDialog( aTmp )





   oDlgTpv:cTitle             := LblTitle( nSaveMode ) + "tickets a clientes "

   if !empty( aTmp[ 2 ] )
      oDlgTpv:cTitle          += Space( 1 )
      oDlgTpv:cTitle          += "[ Ticket : " + aTmp[ 1 ] + "/" + Alltrim( aTmp[ 2 ] ) + "/" + Alltrim( aTmp[ 3 ] ) + "]"
   end

   oDlgTpv:Refresh()

Return ( nil )



Static Function EdtCob( aTmp, aGet, cTikP, oBrw, bWhen, bValid, nMode, aTmpTik )

    local oDlg
   local oSay
   local cSay
   local oBmpDiv
   local cImpDiv
   local oGetCaj
   local cGetCaj
   local oGetFpg
   local cGetFpg
   local oGetSubCta
   local cGetSubCta

   if nMode == 1
      aTmp[ 13 ]  := 1
      aTmp[ 12 ]  := cDivEmp()
      aTmp[ 8 ]  := cDefFpg()
      aTmp[ 18 ]  := cCurSesion()
      aTmp[ 5 ]  := Application():CodigoCaja()
   end

   cImpDiv              := cPorDiv( aTmp[ 12 ], dbfDiv )
   cGetCaj              := RetFld( aTmp[ 5 ], dbfCajT, "cNomCaj" )
   cGetFpg              := RetFld( aTmp[ 8 ], dbfFPago )
   cSay                 := Num2Text( aTmp[ 9 ] )

   oDlg = TDialog():New(,,,,, "PgoTiket",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      aGet[ 18 ] := TGetHlp():ReDefine( 90, { | u | If( PCount()==0, aTmp[ 18 ], aTmp[ 18 ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( .F. )},, .F., .F.,,,,,, nil,,, )







      aGet[ 6 ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ 6 ], aTmp[ 6 ]:= u ) }, oDlg,,,,,,,,, .F., {||     ( nMode <> 3 )},, .F., .T.,,,,, {|Self|aGet[ 6 ]:cText( Calendario( aTmp[ 6 ] ) )}, nil, "LUPA",, )





      aGet[ 11 ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ 11 ], aTmp[ 11 ]:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )









      aGet[ 8 ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ 8 ], aTmp[ 8 ]:= u ) }, oDlg,,, {||    cFpago( aGet[ 8 ], dbfFPago, oGetFpg )},,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, )
      aGet[ 8 ]:bHelp  := {|| BrwFPago( aGet[ 8 ], oGetFpg, .F. ) }




      oGetFpg := TGetHlp():ReDefine( 161, { | u | If( PCount()==0, cGetFpg, cGetFpg:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )











      aGet[ 5 ] := TGetHlp():ReDefine( 280, { | u | If( PCount()==0, aTmp[ 5 ], aTmp[ 5 ]:= u ) }, oDlg,,, {||    cCajas( aGet[ 5 ], dbfCajT, oGetCaj )},,,,,, .F., {||         ( nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ 5 ], oGetCaj ) )}, nil, "LUPA",, )




      oGetCaj := TGetHlp():ReDefine( 281, { | u | If( PCount()==0, cGetCaj, cGetCaj:= u ) }, oDlg,,,,,,,,, .F., {||     .F.},, .F., .F.,,,,,, nil,,, )









      aGet[ 12 ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ 12 ], aTmp[ 12 ]:= u ) }, oDlg,, "@!", {||    (  cDivOut( aGet[ 12 ], oBmpDiv, aGet[ 13 ], nil, nil, @cImpDiv, nil, nil, nil, nil, dbfDiv, oBandera ), aGet[ 9 ]:SetPicture( cImpDiv ), .T. )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|BrwDiv( aGet[ 12 ], oBmpDiv, aGet[ 13 ], dbfDiv, oBandera )}, nil, "LUPA",, )




        oBmpDiv := TBitmap():ReDefine( 121, "BAN_EURO",, oDlg,,, .F., .F.,,, .F.,,, .F. )






      aGet[ 13 ] := TGetHlp():ReDefine( 122, { | u | If( PCount()==0, aTmp[ 13 ], aTmp[ 13 ]:= u ) }, oDlg,, "@E 999,999.9999",, "N/W*",,,,, .F., {||        ( .F. )},, .F., .F.,,,,,, nil,,, )







      aGet[ 9 ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ 9 ], aTmp[ 9 ]:= u ) }, oDlg,, ( cPorDiv ), {||    ( oSay:SetText( Num2Text( aTmp[ 9 ] ) ), .T. )}, "N/W*",,,,, .F., {||     ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      oSay := TSay():ReDefine( 140, {|| cSay}, oDlg,, "N/W*",, .F.,, .F., .F., )









      aGet[ 19 ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ 19 ], aTmp[ 19 ]:= u ) }, oDlg,, ( Replicate( "X", nLenSubcuentaContaplus() ) ), {||    ( MkSubcuenta( aGet[ 19 ], { aTmp[ 19 ] }, oGetSubCta ) )}, "N/W*",,,,, .F., {||     ( nLenCuentaContaplus() <> 0 .AND. nMode <> 3 )},, .F., .F.,,,,, {|Self|( BrwChkSubcuenta( aGet[ 19 ], oGetSubCta ) )}, nil, "LUPA",, )





        oGetSubCta := TGetHlp():ReDefine( 151, { | u | If( PCount()==0, cGetSubCta, cGetSubCta:= u ) }, oDlg,,,, "N/W*",,,,, .F., {||         .F.},, .F., .F.,,,,,, nil,,, )





        TButton():ReDefine( 1, {||( WinGather( aTmp, aGet, dbfTmpP, oBrw, nMode ), oDlg:end( 1 ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:AddFastKey( 116, {|| WinGather( aTmp, aGet, dbfTmpP, oBrw, nMode ), oDlg:end( 1 ) } )



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( aGet[ 12 ]:lValid(), aGet[ 19 ]:lValid() )}, oDlg:bRClicked,,, )

   oBmpDiv:end()

Return ( oDlg:nResult == 1 )



Static Function loaCli( aGet, aTmp, nMode, oTelefonoClient, oMailClient )

   local lValid      := .F.
   local lChgCodCli  := .F.
   local cNewCodCli  := aGet[ 11 ]:VarGet()

   if empty( cNewCodCli )
      Return .T.
   end

   if At( ".", cNewCodCli ) <> 0
      cNewCodCli     := PntReplace( aGet[ 11 ], "0", RetNumCodCliEmp() )
   else
      cNewCodCli     := Rjust( cNewCodCli, "0", RetNumCodCliEmp() )
   end

   lChgCodCli        := ( empty( cOldCodCli ) .OR. AllTrim( cOldCodCli ) <> AllTrim( cNewCodCli ) )

   if ( dbfClient )->( dbSeek( cNewCodCli ) )

      if ( nMode == 1 ) .AND. ( ( dbfClient )->lInaCli )


         msgStop( "Cliente inactivo, no se pueden realizar operaciones de venta" + Chr(13)+Chr(10) +  "Motivo: " + alltrim( ( dbfClient )->cMotIna ), "Imposible crear documento" )
         Return .F.
      end

      if ( nMode == 1 ) .AND. ( ( dbfClient )->lBlqCli )


         msgStop( "Cliente bloqueado, no se pueden realizar operaciones de venta" + Chr(13)+Chr(10) +  "Motivo: " + alltrim( ( dbfClient )->cMotBlq ), "Imposible crear documento" )
         Return .F.
      end





      if ( lChgCodCli )
         aTmp[ 20 ]  := ( dbfClient )->lModDat
      end

      aGet[ 11 ]:cText( ( dbfClient )->Cod )

      if empty( aGet[ 12 ]:varGet() ) .OR. lChgCodCli
         aGet[ 12 ]:cText( ( dbfClient )->nTarifa )
      end

      if ( dbfClient )->nColor <> 0
         aGet[ 13 ]:SetColor( , ( dbfClient )->nColor )
      end

      if lChgCodCli
         aGet[ 13 ]:cText( ( dbfClient )->Titulo  )
      end

      if empty( aGet[ 14 ]:varGet() ) .OR. lChgCodCli
         aGet[ 14 ]:cText( ( dbfClient )->Domicilio )
      end

      if empty( aGet[ 15 ]:varGet() ) .OR. lChgCodCli
         aGet[ 15 ]:cText( ( dbfClient )->Poblacion )
      end

      if empty( aGet[ 63 ]:varGet() ) .OR. lChgCodCli
         aGet[ 63 ]:cText( ( dbfClient )->Telefono )
      end

      if empty( aGet[ 16 ]:varGet() ) .OR. lChgCodCli
         aGet[ 16 ]:cText( ( dbfClient )->Provincia )
      end

      if empty( aGet[ 18 ]:varGet() ) .OR. lChgCodCli
         aGet[ 18 ]:cText( ( dbfClient )->CodPostal )
      end

      if empty( aGet[ 19 ]:varGet() ) .OR. lChgCodCli
         aGet[ 19 ]:cText( ( dbfClient )->Nif )
      end

      if empty( aTmp[ 47 ] ) .OR. lChgCodCli
         aTmp[ 47 ]  := ( dbfClient )->cCodGrp
      end

      if !empty( oRieCli ) .AND. lChgCodCli
         oStock:SetRiesgo( cNewCodCli, oRieCli, ( dbfClient )->Riesgo )
      end

      if lChgCodCli
         if ( ( dbfClient )->lCreSol ) .AND. ( nRieCli >= ( dbfClient )->Riesgo )
            msgStop( "Este cliente supera el limite de riesgo permitido.")
         end
      end





      if ( lChgCodCli ) .AND. !empty( aGet[ 35 ] )

         if dbSeekInOrd( cNewCodCli, "lDefObr", dbfObrasT )
            aGet[ 35 ]:cText( ( dbfObrasT )->cCodObr )
         else
            aGet[ 35 ]:cText( Space( 10 ) )
         end

         aGet[ 35 ]:lValid()

      end

      if oTelefonoClient <> nil
         oTelefonoClient:SetText( ( dbfClient )->Telefono )
      end

      if oMailClient <> nil
         oMailClient:SetText( ( dbfClient )->cMeiInt )
      end





      if lChgCodCli

         if !empty( aGet[ 57 ] )
            aGet[ 57 ]:cText( ( dbfClient )->cDtoEsp )
         else
            aTmp[ 57 ]  := ( dbfClient )->cDtoEsp
         end

         if !empty( aGet[ 58 ] )
            aGet[ 58 ]:cText( ( dbfClient )->nDtoEsp )
         else
            aTmp[ 58 ]  := ( dbfClient )->nDtoEsp
         end

         if !empty( aGet[ 59    ] )
            aGet[ 59    ]:cText( ( dbfClient )->cDpp )
         else
            aTmp[ 59    ]  := ( dbfClient )->cDpp
         end

         if !empty( aGet[ 60    ] )
            aGet[ 60    ]:cText( ( dbfClient )->nDpp )
         else
            aTmp[ 60    ]  := ( dbfClient )->nDpp
         end

      end





      if nMode == 1

         if !empty( ( dbfClient )->Serie ) .AND. lChgCodCli
            aGet[ 1 ]:cText( ( dbfClient )->Serie )
         end

         if empty( aGet[ 10 ]:varGet() ) .AND. lChgCodCli .AND. !empty( ( dbfClient )->cCodAlm )
            aGet[ 10 ]:cText( ( dbfClient )->cCodAlm )
            aGet[ 10 ]:lValid()
         end

         if ( empty( aGet[ 34 ]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( dbfClient )->cCodTar )
            aGet[ 34 ]:cText( ( dbfClient )->cCodTar )
            aGet[ 34 ]:lValid()
         end

         if ( empty( aGet[ 21 ]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( dbfClient )->CodPago )
            if !uFieldEmpresa( "lGetFpg" )
               aGet[ 21 ]:cText( ( dbfClient )->CodPago )
            end
            aGet[ 21 ]:lValid()
         end

         if ( empty( aGet[ 32 ]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( dbfClient )->cAgente )
            aGet[ 32 ]:cText( ( dbfClient )->cAgente )
            aGet[ 32 ]:lValid()
         end

         if ( empty( aGet[ 33 ]:varGet() ) .OR. lChgCodCli ) .AND. !empty( ( dbfClient )->cCodRut )
            aGet[ 33 ]:cText( ( dbfClient )->cCodRut )
            aGet[ 33 ]:lValid()
         end

         aTmp[ 70 ]  := ( dbfClient )->nRegIva

      end

      if ( dbfClient )->lMosCom .AND. !empty( ( dbfClient )->mComent ) .AND. lChgCodCli
         MsgStop( Trim( ( dbfClient )->mComent ) )
      end

      if lObras() .AND. empty( aTmp[ 35 ] ) .AND. lChgCodCli
         msgWait( "Introduzca la dirección", "Info", 0 )
         aGet[ 35 ]:SetFocus()
      end

      cOldCodCli     := cNewCodCli
      lValid         := .T.

   else

        msgStop( "Cliente no encontrado" )

   end





   if lChgCodCli
      lRecTotal( aTmp )
   end

Return lValid



Static Function TPadl( cExp, n )

Return Padl( AllTrim( cExp ), n )



Function SavTik2Alb( aTik, aGet, nMode, nSave )

   local aTotal
   local cSerTik                 := aTik [ 1 ]
   local cNumTik                 := aTik [ 2 ]
   local cSufTik                 := aTik [ 3 ]
   local nNewAlbCli
   local nOrdAnt

   if nMode == 1 .OR. lApartado





      cNumTik                    := nNewDoc( aTik[ 1 ], dbfAlbCliT, "nAlbCli", , dbfCount )
      cSufTik                    := RetSufEmp()





      cNuevoAlbaran              := cSerTik + Str( cNumTik ) + cSufTik

      ( dbfAlbCliT )->( dbAppend() )

      ( dbfAlbCliT )->cSerAlb    := cSerTik
      ( dbfAlbCliT )->nNumAlb    := cNumTik
      ( dbfAlbCliT )->cSufAlb    := cSufTik
      ( dbfAlbCliT )->cNumDoc    := cSerTik + Str( cNumTik, 9 ) + cSufTik
      ( dbfAlbCliT )->cTurAlb    := cCurSesion()
      ( dbfAlbCliT )->dFecCre    := aTik[ 40 ]
      ( dbfAlbCliT )->cTimCre    := aTik[ 41 ]
      ( dbfAlbCliT )->dFecAlb    := aTik[ 6 ]
      ( dbfAlbCliT )->tFecAlb    := aTik[ 71 ]
      ( dbfAlbCliT )->cCodUsr    := aTik[ 8 ]
      ( dbfAlbCliT )->cDtoEsp    := aTik[ 57 ]
      ( dbfAlbCliT )->nDtoEsp    := aTik[ 58 ]
      ( dbfAlbCliT )->cDpp       := aTik[ 59    ]
      ( dbfAlbCliT )->nDpp       := aTik[ 60    ]
      ( dbfAlbCliT )->cCodPago   := aTik[ 8 ]

      ( dbfAlbCliT )->( dbUnLock() )





      aTik[ 31 ]              := cSerTik + Str( cNumTik, 9 ) + cSufTik

   else





      cSerTik                       := SubStr( aTik[ 31 ], 1, 1 )
      cNumTik                       := Val( SubStr( aTik[ 31 ], 2, 9 ) )
      cSufTik                       := SubStr( aTik[ 31 ], 11, 2 )

      if !( dbfAlbCliT )->( dbSeek( aTik[ 31 ] ) )
         ( dbfAlbCliT )->( dbAppend() )
         ( dbfAlbCliT )->cSerAlb    := cSerTik
         ( dbfAlbCliT )->nNumAlb    := cNumTik
         ( dbfAlbCliT )->cSufAlb    := cSufTik
         ( dbfAlbCliT )->dFecCre    := aTik[ 40 ]
         ( dbfAlbCliT )->cTimCre    := aTik[ 41 ]
         ( dbfAlbCliT )->cTurAlb    := aTik[ 5 ]
         ( dbfAlbCliT )->( dbUnLock() )
      end





      nOrdAnt  := ( dbfAlbCliL )->( ordsetfocus( "NNUMALB" ) )

      while ( dbfAlbCliL )->( dbSeek( aTik[ 31 ] ) ) .AND. !( dbfAlbCliL )->( eof() )

         TComercio:appendProductsToUpadateStocks( (dbfAlbCliL)->cRef, nView )

         if dbLock( dbfAlbCliL )
            ( dbfAlbCliL )->( dbDelete() )
            ( dbfAlbCliL )->( dbUnLock() )
         end

      end

      ( dbfAlbCliL )->( ordsetfocus( nOrdAnt ) )

   end





   if dbLock( dbfAlbCliT )

      ( dbfAlbCliT )->lFacturado    := .F.
      ( dbfAlbCliT )->nFacturado    := 1
      ( dbfAlbCliT )->lSndDoc       := .T.
      ( dbfAlbCliT )->lIvaInc       := .T.
      ( dbfAlbCliT )->cCodCli       := aTik[ 11 ]
      ( dbfAlbCliT )->cCodAlm       := aTik[ 10 ]
      ( dbfAlbCliT )->cCodCaj       := aTik[ 9 ]
      ( dbfAlbCliT )->cNomCli       := aTik[ 13 ]
      ( dbfAlbCliT )->cCodPago      := aTik[ 21 ]
      ( dbfAlbCliT )->cDivAlb       := aTik[ 24 ]
      ( dbfAlbCliT )->nVdvAlb       := aTik[ 25 ]
      ( dbfAlbCliT )->cRetMat       := aTik[ 30 ]
      ( dbfAlbCliT )->cCodAge       := aTik[ 32 ]
      ( dbfAlbCliT )->cCodRut       := aTik[ 33 ]
      ( dbfAlbCliT )->cCodTar       := aTik[ 34 ]
      ( dbfAlbCliT )->cCodObr       := aTik[ 35 ]
      ( dbfAlbCliT )->nPctComAge    := aTik[ 36 ]
      ( dbfAlbCliT )->cDtoEsp       := aTik[ 57 ]
      ( dbfAlbCliT )->nDtoEsp       := aTik[ 58 ]
      ( dbfAlbCliT )->cDpp          := aTik[ 59    ]
      ( dbfAlbCliT )->nDpp          := aTik[ 60    ]

      if empty( ( dbfAlbCliT )->cTurAlb )
         ( dbfAlbCliT )->cTurAlb    := cCurSesion()
      end





      ( dbfAlbCliT )->cDirCli       := aTik[ 14 ]
      ( dbfAlbCliT )->cPobCli       := aTik[ 15 ]
      ( dbfAlbCliT )->cPrvCli       := aTik[ 16 ]
      ( dbfAlbCliT )->cPosCli       := aTik[ 18 ]
      ( dbfAlbCliT )->cDniCli       := aTik[ 19 ]

      ( dbfAlbCliT )->( dbUnLock() )

   end





   ( dbfTmpL )->( dbGoTop() )
   while !( dbfTmpL )->( eof() )

      ( dbfAlbCliL )->( dbAppend() )
      ( dbfAlbCliL )->cSerAlb    := ( dbfAlbCliT )->cSerAlb
      ( dbfAlbCliL )->nNumAlb    := ( dbfAlbCliT )->nNumAlb
      ( dbfAlbCliL )->cSufAlb    := ( dbfAlbCliT )->cSufAlb
      ( dbfAlbCliL )->cRef       := ( dbfTmpL    )->cCbaTil
      ( dbfAlbCliL )->cDetalle   := ( dbfTmpL    )->cNomTil
      ( dbfAlbCliL )->nPreUnit   := ( dbfTmpL    )->nPvpTil
      ( dbfAlbCliL )->nDto       := ( dbfTmpL    )->nDtoLin
      ( dbfAlbCliL )->nIva       := ( dbfTmpL    )->nIvaTil
      ( dbfAlbCliL )->nUniCaja   := ( dbfTmpL    )->nUntTil
      ( dbfAlbCliL )->cCodPr1    := ( dbfTmpL    )->cCodPr1
      ( dbfAlbCliL )->cCodPr2    := ( dbfTmpL    )->cCodPr2
      ( dbfAlbCliL )->cValPr1    := ( dbfTmpL    )->cValPr1
      ( dbfAlbCliL )->cValPr2    := ( dbfTmpL    )->cValPr2
      ( dbfAlbCliL )->nFacCnv    := ( dbfTmpL    )->nFacCnv
      ( dbfAlbCliL )->nDtoDiv    := ( dbfTmpL    )->nDtoDiv
      ( dbfAlbCliL )->nCtlStk    := ( dbfTmpL    )->nCtlStk
      ( dbfAlbCliL )->nValImp    := ( dbfTmpL    )->nValImp
      ( dbfAlbCliL )->cCodImp    := ( dbfTmpL    )->cCodImp
      ( dbfAlbCliL )->lKitChl    := ( dbfTmpL    )->lKitChl
      ( dbfAlbCliL )->lKitArt    := ( dbfTmpL    )->lKitArt
      ( dbfAlbCliL )->lKitPrc    := ( dbfTmpL    )->lKitPrc
      ( dbfAlbCliL )->mNumSer    := ( dbfTmpL    )->mNumSer
      ( dbfAlbCliL )->dFecAlb    := ( dbfAlbCliT )->dFecAlb
      ( dbfAlbCliL )->tFecAlb    := ( dbfAlbCliT )->tFecAlb
      ( dbfAlbCliL )->cAlmLin    := aTik[ 10 ]
      ( dbfAlbCliL )->lIvaLin    := .T.
      ( dbfAlbCliL )->nNumLin    := ( dbfTmpL    )->nNumLin
      ( dbfAlbCliL )->nPosPrint  := ( dbfTmpL    )->nPosPrint

      if !Empty( ( dbfTmpL )->cLote )
         ( dbfAlbCliL )->cLote   := ( dbfTmpL )->cLote
         ( dbfAlbCliL )->lLote   := .T.
      end
      ( dbfAlbCliL )->( dbUnLock() )

      TComercio:appendProductsToUpadateStocks( ( dbfTmpL )->cCbaTil, nView )

      ( dbfTmpL )->( dbSkip() )

   end





   while ( dbfAlbCliP )->( dbSeek( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb ) ) .AND. !( dbfAlbCliP )->( eof() )

      if dbLock( dbfAlbCliP )
         ( dbfAlbCliP )->( dbDelete() )
         ( dbfAlbCliP )->( dbUnLock() )
      end

      ( dbfAlbCliP )->( dbSkip() )

   end





   ( dbfTmpE )->( dbGoTop() )

   while !( dbfTmpE )->( eof() )

      ( dbfAlbCliP )->( dbAppend() )

      ( dbfAlbCliP )->cSerAlb    := cSerTik
      ( dbfAlbCliP )->nNumAlb    := cNumTik
      ( dbfAlbCliP )->cSufAlb    := cSufTik
      ( dbfAlbCliP )->nNumRec    := ( dbfTmpE )->nNumRec
      ( dbfAlbCliP )->cCodCaj    := ( dbfTmpE )->cCodCaj
      ( dbfAlbCliP )->cTurRec    := ( dbfTmpE )->cTurRec
      ( dbfAlbCliP )->cCodCli    := ( dbfTmpE )->cCodCli
      ( dbfAlbCliP )->dEntrega   := ( dbfTmpE )->dEntrega
      ( dbfAlbCliP )->nImporte   := ( dbfTmpE )->nImporte
      ( dbfAlbCliP )->cDescrip   := ( dbfTmpE )->cDescrip
      ( dbfAlbCliP )->cPgdoPor   := ( dbfTmpE )->cPgdoPor
      ( dbfAlbCliP )->cDivPgo    := ( dbfTmpE )->cDivPgo
      ( dbfAlbCliP )->nVdvPgo    := ( dbfTmpE )->nVdvPgo
      ( dbfAlbCliP )->cCodAge    := ( dbfTmpE )->cCodAge
      ( dbfAlbCliP )->cCodPgo    := ( dbfTmpE )->cCodPgo
      ( dbfAlbCliP )->lCloPgo    := .F.
      ( dbfAlbCliP )->lPasado    := ( dbfTmpE )->lPasado

      ( dbfAlbCliP )->( dbUnLock() )

      ( dbfTmpE )->( dbSkip() )

   end





   aTotal                        := aTotAlbCli( aTik[ 31 ], dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv )

   aTik[ 65 ]              := aTotal[1]
   aTik[ 66 ]              := aTotal[2]
   aTik[ 67 ]              := aTotal[4]

   if dbLock( dbfAlbCliT )
      ( dbfAlbCliT )->nTotNet    := aTotal[1]
      ( dbfAlbCliT )->nTotIva    := aTotal[2]
      ( dbfAlbCliT )->nTotReq    := aTotal[3]
      ( dbfAlbCliT )->nTotAlb    := aTotal[4]
      ( dbfAlbCliT )->( dbUnLock() )
   end







return ( nNewAlbCli )



Function nTotalizer( cNumTik, cTikT, cTikL, cTikP, cAlbCliT, cAlbCliL, cFacCliT, cFacCliL, cFacCliP, cIva, cDiv, cCodDiv, lPic )

   local uTotal         := 0
   local aTotal         := {}

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():Tikets( nView ), ), ) ;
   If( cTikL == nil, cTikL := dbfTikL, ) ;
   If( cTikP == nil, cTikP := dbfTikP, ) ;
   If( cAlbCliT == nil, cAlbCliT := dbfAlbCliT, ) ;
   If( cAlbCliL == nil, cAlbCliL := dbfAlbCliL, ) ;
   If( cFacCliT == nil, cFacCliT := dbfFacCliT, ) ;
   If( cFacCliL == nil, cFacCliL := dbfFacCliL, ) ;
   If( cFacCliP == nil, cFacCliP := dbfFacCliP, ) ;
   If( cIva == nil, cIva := dbfIva, ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( lPic == nil, lPic := .T., ) ;

   if empty( cTikT ) .OR. empty( cTikL )
      Return ( uTotal )
   end

   if empty( cNumTik )
      cNumTik           := ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik
   end

   public nTotAlb       := 0
   public nTotFac       := 0
   public aBrtTik       := { 0, 0, 0 }
   public aBasTik       := { 0, 0, 0 }
   public aImpTik       := { 0, 0, 0 }
   public aIvaTik       := { nil, nil, nil }
   public aIvmTik       := { 0, 0, 0 }
   public cCtaCli       := cClientCuenta( ( cTikT )->cCliTik )

   uTotal               := if( lPic, "0", 0 )

   do case
      case ( cTikT )->cTipTik == "2"

         if ( cAlbCliT )->( dbSeek( ( cTikT )->cNumDoc ) )

            aTotal      := aTotAlbCli( ( cTikT )->cNumDoc, cAlbCliT, cAlbCliL, cIva, cDiv )

            uTotal      := aTotal[ 4 ]
            nTotAlb     := uTotal

            aBrtTik     := { aTotal[ 8 ][ 1, 1 ], aTotal[ 8 ][ 2, 1 ], aTotal[ 8 ][ 3, 1 ] }
            aBasTik     := { aTotal[ 8 ][ 1, 2 ], aTotal[ 8 ][ 2, 2 ], aTotal[ 8 ][ 3, 2 ] }
            aImpTik     := { aTotal[ 8 ][ 1, 8 ], aTotal[ 8 ][ 2, 8 ], aTotal[ 8 ][ 3, 8 ] }
            aIvaTik     := { aTotal[ 8 ][ 1, 3 ], aTotal[ 8 ][ 2, 3 ], aTotal[ 8 ][ 3, 3 ] }
            aIvmTik     := { aTotal[ 8 ][ 1, 6 ], aTotal[ 8 ][ 2, 6 ], aTotal[ 8 ][ 3, 6 ] }

         end

      case ( cTikT )->cTipTik == "3"

         if ( cFacCliT )->( dbSeek( ( cTikT )->cNumDoc ) )

            aTotal      := aTotFacCli( ( cTikT )->cNumDoc, cFacCliT, cFacCliL, cIva, cDiv, cFacCliP )

            uTotal      := aTotal[ 4 ]
            nTotFac     := uTotal

            aBrtTik     := { aTotal[ 8 ][ 1, 1 ], aTotal[ 8 ][ 2, 1 ], aTotal[ 8 ][ 3, 1 ] }
            aBasTik     := { aTotal[ 8 ][ 1, 2 ], aTotal[ 8 ][ 2, 2 ], aTotal[ 8 ][ 3, 2 ] }
            aImpTik     := { aTotal[ 8 ][ 1, 8 ], aTotal[ 8 ][ 2, 8 ], aTotal[ 8 ][ 3, 8 ] }
            aIvaTik     := { aTotal[ 8 ][ 1, 3 ], aTotal[ 8 ][ 2, 3 ], aTotal[ 8 ][ 3, 3 ] }
            aIvmTik     := { aTotal[ 8 ][ 1, 6 ], aTotal[ 8 ][ 2, 6 ], aTotal[ 8 ][ 3, 6 ] }

         end

      otherwise

         uTotal         := nTotTik( cNumTik, cTikT, cTikL, cDiv, nil, cCodDiv, lPic )

   end

return ( uTotal )



Static Function nChkalizer( cNumTik, cTikT, dbfTikL, dbfTikP, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, cCodDiv )

   local nPgo     := 1
   local aStatus  := aGetStatus( D():Tikets( nView ), .T. )
   local nRec     := ( dbfFacCliT )->( RecNo() )
   local nOrdAnt  := ( dbfFacCliT )->( ordsetfocus( "nNumFac" ) )

   if ( D():Tikets( nView ) )->( dbSeek( cNumTik ) )

      do case
      case ( D():Tikets( nView ) )->cTipTik == "2"

         if RetFld( ( D():Tikets( nView ) )->cNumDoc, dbfAlbCliT, "lFacturado" )
            nPgo  := 1
         else
            nPgo  := 3
         end

      case ( D():Tikets( nView ) )->cTipTik == "3"

         if ( dbfFacCliT )->( dbSeek( ( D():Tikets( nView ) )->cNumDoc ) )
            nPgo  := nChkPagFacCli( ( D():Tikets( nView ) )->cNumDoc, dbfFacCliT, dbfFacCliP )
         else
            nPgo  := 3
         end

      case ( D():Tikets( nView ) )->cTipTik == "6"

         nPgo     := if( ( D():Tikets( nView ) )->lLiqTik, 1, 3 )

      otherwise

         nPgo     := nChkPagTik( cNumTik, D():Tikets( nView ), dbfTikL, dbfTikP, dbfIva, dbfDiv )

      end

   end

   ( dbfFacCliT )->( ordsetfocus( nOrdAnt ) )
   ( dbfFacCliT )->( dbGoTo( nRec ) )

   SetStatus( D():Tikets( nView ), aStatus )

Return ( nPgo )



Function nCobalizer( cNumTik, cTikT, dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, cCodDiv, lPic )

   local nPgo     := if( lPic, "", 0 )
   local aStatus  := aGetStatus( cTikT, .T. )

   If ( cTikT )->( dbSeek( cNumTik ) )

      Do Case
      Case ( cTikT )->cTipTik == "3"

         nPgo     := nPagFacCli( ( cTikT )->cNumDoc, dbfFacCliT, dbfFacCliP, dbfIva, dbfDiv, cCodDiv, .T., lPic )




      Case  ( cTikT )->cTipTik == "1" .OR. ( cTikT )->cTipTik == "4" .OR. ( cTikT )->cTipTik == "5" .OR. ( cTikT )->cTipTik == "6"

         nPgo     := nTotCobTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, dbfTikP, dbfDiv, cCodDiv, lPic )

      end

   end

   SetStatus( cTikT, aStatus )

Return ( nPgo )



Function nDifalizer( cNumTik, cTikT, dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfAntCliT, dbfIva, dbfDiv, cCodDiv, lPic )

   local cPorDiv  := cPorDiv( cCodDiv, dbfDiv )
   local nTot     := nTotalizer( cNumTik, cTikT, dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, cCodDiv, .F. )
   nTot           -= nCobalizer( cNumTik, cTikT, dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, cCodDiv, .F. )
   nTot           -= nTotValTik( cNumTik, cTikT, dbfTikL, dbfDiv, cCodDiv, .F. )
   nTot           -= nTotAntFacCli( ( cTikT )->cNumDoc, dbfAntCliT, dbfIva, dbfDiv, cCodDiv, .F. )

Return ( if( lPic, Trans( nTot, cPorDiv ), nTot ) )



static function LoaAlb2Tik()

   if ( dbfAlbCliL )->( DbSeek( ( D():tikets( nView ) )->cNumDoc ) )
      while ( ( dbfAlbCliL )->CSERALB + Str( ( dbfAlbCliL )->NNUMALB ) + ( dbfAlbCliL )->CSUFALB == ( D():tikets( nView ) )->cNumDoc .AND. !( dbfAlbCliL )->( eof() ) )

         ( dbfTmpL )->( dbAppend() )
         ( dbfTmpL )->cCbaTil    := ( dbfAlbCliL )->CREF
         ( dbfTmpL )->cNomTil    := ( dbfAlbCliL )->CDETALLE
         ( dbfTmpL )->nPvpTil    := ( dbfAlbCliL )->NPREUNIT
         ( dbfTmpL )->nDtoLin    := ( dbfAlbCliL )->NDTO
         ( dbfTmpL )->nIvaTil    := ( dbfAlbCliL )->NIVA
         ( dbfTmpL )->nUntTil    := If( ( dbfAlbCliL )->NCANENT <> 0, ( dbfAlbCliL )->NCANENT, 1 ) * ( dbfAlbCliL )->NUNICAJA
         ( dbfTmpL )->cCodPr1    := ( dbfAlbCliL )->CCODPR1
         ( dbfTmpL )->cCodPr2    := ( dbfAlbCliL )->CCODPR2
         ( dbfTmpL )->cValPr1    := ( dbfAlbCliL )->CVALPR1
         ( dbfTmpL )->cValPr2    := ( dbfAlbCliL )->CVALPR2
         ( dbfTmpL )->nFacCnv    := ( dbfAlbCliL )->NFACCNV
         ( dbfTmpL )->nDtoDiv    := ( dbfAlbCliL )->NDTODIV
         ( dbfTmpL )->nCtlStk    := ( dbfAlbCliL )->nCtlStk
         ( dbfTmpL )->nValImp    := ( dbfAlbCliL )->nValImp
         ( dbfTmpL )->cCodImp    := ( dbfAlbCliL )->cCodImp
         ( dbfTmpL )->mNumSer    := ( dbfAlbCliL )->mNumSer
         ( dbfTmpL )->( dbRUnLock() )

         ( dbfAlbCliL )->( dbSkip() )

      end
   end
  ( dbfTmpL )->( dbGoTop() )

return nil



function SavTik2Fac( aTik, aGet, nMode, nSave, nTotal )

   local aTotal
   local nNumRec                 := 0
   local cCliTik                 := aTik[ 11 ]
   local cSerFacCli
   local nNewFacCli
   local cSufFacCli
   local cCliFacCli
   local cNomFacCli
   local dFecFacCli
   local nOrdAnt
   local cCodFam
   local tFecFacCli              := ""

   if nMode == 4
      aTik[ 2 ]           := Str( nNewDoc( aTik[ 1 ], D():tikets( nView ), "NTIKCLI", 10, dbfCount ), 10 )
      aTik[ 3 ]           := retSufEmp()
      aTik[ 6 ]           := getSysDate()
      aTik[ 71 ]           := getSysTime()
      aTik[ 27 ]           := .T.
      aTik[ 26 ]           := .F.
   end

   if nMode == 1 .OR. nMode == 4 .OR. lApartado





      cSerFacCli                 := aTik[ 1 ]
      nNewFacCli                 := nNewDoc( aTik [ 1 ], dbfFacCliT, "NFACCLI", , dbfCount )
      cSufFacCli                 := RetSufEmp()
      cCliFacCli                 := aTik[ 11 ]
      cNomFacCli                 := aTik[ 13 ]
      dFecFacCli                 := aTik[ 6 ]
      tFecFacCli                 := aTik[ 71 ]

      ( dbfFacCliT )->( dbAppend() )
      ( dbfFacCliT )->cSerie     := cSerFacCli
      ( dbfFacCliT )->nNumFac    := nNewFacCli
      ( dbfFacCliT )->cSufFac    := cSufFacCli
      ( dbfFacCliT )->dFecFac    := dFecFacCli
      ( dbfFacCliT )->TFecFac    := tFecFacCli
      ( dbfFacCliT )->cTurFac    := cCurSesion()
      ( dbfFacCliT )->dFecCre    := aTik[ 40 ]
      ( dbfFacCliT )->cTimCre    := aTik[ 41 ]
      ( dbfFacCliT )->cCodUsr    := aTik[ 8 ]
      ( dbfFacCliT )->cNumDoc    := aTik[ 1 ] + aTik[ 2 ] + aTik[ 3 ]
      ( dbfFacCliT )->cDtoEsp    := aTik[ 57 ]
      ( dbfFacCliT )->nDtoEsp    := aTik[ 58 ]
      ( dbfFacCliT )->cDpp       := aTik[ 59 ]
      ( dbfFacCliT )->nDpp       := aTik[ 60 ]
      ( dbfFacCliT )->( dbUnLock() )





      aTik[ 31 ]           := cSerFacCli + Str( nNewFacCli, 9 ) + cSufFacCli

   else

      cCliFacCli                 := aTik[ 11 ]
      cNomFacCli                 := aTik[ 13 ]
      dFecFacCli                 := aTik[ 6 ]
      tFecFacCli                 := aTik[ 71 ]





      if ( dbfFacCliT )->( dbSeek( aTik[ 31 ] ) )

         cSerFacCli              := ( dbfFacCliT )->cSerie
         nNewFacCli              := ( dbfFacCliT )->nNumFac
         cSufFacCli              := ( dbfFacCliT )->cSufFac





         nOrdAnt  := ( dbfFacCliL )->( ordsetfocus( "NNUMFAC" ) )

         while ( dbfFacCliL )->( dbSeek( aTik[ 31 ] ) ) .AND. !( dbfFacCliL )->( eof() )
            TComercio:appendProductsToUpadateStocks( (dbfFacCliL)->cRef, nView )
            if dbLock( dbfFacCliL )
               ( dbfFacCliL )->( dbDelete() )
               ( dbfFacCliL )->( dbUnLock() )
            end
         end

         ( dbfFacCliL )->( ordsetfocus( nOrdAnt ) )

      else

         MsgStop( "No se encuentra documento asociado" )
         return nil

      end

   end





   if dbLock( dbfFacCliT )

      if empty( ( dbfFacCliT )->dFecFac )
         ( dbfFacCliT )->dFecFac    := aTik[ 6 ]
      end

      if empty( ( dbfFacCliT )->tFecFac )
         ( dbfFacCliT )->tFecFac    := aTik[ 71 ]
      end

      ( dbfFacCliT )->lSndDoc       := .T.
      ( dbfFacCliT )->lIvaInc       := .T.
      ( dbfFacCliT )->cCodAlm       := aTik[ 10 ]
      ( dbfFacCliT )->cCodCaj       := aTik[ 9 ]
      ( dbfFacCliT )->cCodCli       := aTik[ 11 ]
      ( dbfFacCliT )->cNomCli       := aTik[ 13 ]
      ( dbfFacCliT )->cDirCli       := aTik[ 14 ]
      ( dbfFacCliT )->cPobCli       := aTik[ 15 ]
      ( dbfFacCliT )->cPrvCli       := aTik[ 16 ]
      ( dbfFacCliT )->cPosCli       := aTik[ 18 ]
      ( dbfFacCliT )->cDniCli       := aTik[ 19 ]
      ( dbfFacCliT )->cCodPago      := aTik[ 21 ]
      ( dbfFacCliT )->cDivFac       := aTik[ 24 ]
      ( dbfFacCliT )->nVdvFac       := aTik[ 25 ]
      ( dbfFacCliT )->cRetMat       := aTik[ 30 ]
      ( dbfFacCliT )->cCodAge       := aTik[ 32 ]
      ( dbfFacCliT )->cCodRut       := aTik[ 33 ]
      ( dbfFacCliT )->cCodTar       := aTik[ 34 ]
      ( dbfFacCliT )->cCodObr       := aTik[ 35 ]
      ( dbfFacCliT )->nPctComAge    := aTik[ 36 ]
      ( dbfFacCliT )->cDtoEsp       := aTik[ 57 ]
      ( dbfFacCliT )->nDtoEsp       := aTik[ 58 ]
      ( dbfFacCliT )->cDpp          := aTik[ 59    ]
      ( dbfFacCliT )->nDpp          := aTik[ 60    ]

      ( dbfFacCliT )->( dbUnLock() )

   end





   ( dbfTmpL )->( dbGoTop() )
   while !( dbfTmpL )->( eof() )

      ( dbfFacCliL )->( dbAppend() )
      ( dbfFacCliL )->cSerie     := cSerFacCli
      ( dbfFacCliL )->nNumFac    := nNewFacCli
      ( dbfFacCliL )->cSufFac    := cSufFacCli
      ( dbfFacCliL )->dFecFac    := dFecFacCli
      ( dbfFacCliL )->tFecFac    := tFecFacCli
      ( dbfFacCliL )->cRef       := ( dbfTmpL )->cCbaTil
      ( dbfFacCliL )->cDetalle   := ( dbfTmpL )->cNomTil
      ( dbfFacCliL )->nPreUnit   := ( dbfTmpL )->nPvpTil
      ( dbfFacCliL )->nDto       := ( dbfTmpL )->nDtoLin
      ( dbfFacCliL )->nIva       := ( dbfTmpL )->nIvaTil
      ( dbfFacCliL )->nUniCaja   := ( dbfTmpL )->nUntTil
      ( dbfFacCliL )->cCodPr1    := ( dbfTmpL )->cCodPr1
      ( dbfFacCliL )->cCodPr2    := ( dbfTmpL )->cCodPr2
      ( dbfFacCliL )->cValPr1    := ( dbfTmpL )->cValPr1
      ( dbfFacCliL )->cValPr2    := ( dbfTmpL )->cValPr2
      ( dbfFacCliL )->nFacCnv    := ( dbfTmpL )->nFacCnv
      ( dbfFacCliL )->nDtoDiv    := ( dbfTmpL )->nDtoDiv
      ( dbfFacCliL )->nCtlStk    := ( dbfTmpL )->nCtlStk
      ( dbfFacCliL )->nValImp    := ( dbfTmpL )->nValImp
      ( dbfFacCliL )->cCodImp    := ( dbfTmpL )->cCodImp
      ( dbfFacCliL )->lKitPrc    := ( dbfTmpL )->lKitPrc
      ( dbfFacCliL )->lKitArt    := ( dbfTmpL )->lKitArt
      ( dbfFacCliL )->lKitChl    := ( dbfTmpL )->lKitChl
      ( dbfFacCliL )->mNumSer    := ( dbfTmpL )->mNumSer
      ( dbfFacCliL )->cAlmLin    := aTik[ 10 ]
      ( dbfFacCliL )->lIvaLin    := .T.
      cCodFam                    := RetFamArt( ( dbfTmpL )->cCbaTil, dbfArticulo )
      ( dbfFacCliL )->cCodFam    := cCodFam
      ( dbfFacCliL )->cGrpFam    := cGruFam( cCodFam, dbfFamilia )
      ( dbfFacCliL )->nNumLin    := ( dbfTmpL )->nNumLin
      ( dbfFacCliL )->nPosPrint  := ( dbfTmpL )->nPosPrint

      ( dbfFacCliL )->( dbUnLock() )

      TComercio:appendProductsToUpadateStocks( ( dbfTmpL )->cCbaTil, nView )

      ( dbfTmpL )->( dbSkip() )

   end





   while ( dbfFacCliP )->( dbSeek( ( dbfFacCliT )->cSerie + Str( ( dbfFacCliT )->nNumFac ) + ( dbfFacCliT )->cSufFac ) ) .AND. !( dbfFacCliP )->( eof() )

      if dbLock( dbfFacCliP )
         ( dbfFacCliP )->( dbDelete() )
         ( dbfFacCliP )->( dbUnLock() )
      end

      ( dbfFacCliP )->( dbSkip() )

   end





   ( dbfTmpP )->( dbGoTop() )
   while !( dbfTmpP )->( eof() )

      ( dbfFacCliP )->( dbAppend() )

      ( dbfFacCliP )->lCobrado   := .T.
      ( dbfFacCliP )->cSerie     := cSerFacCli
      ( dbfFacCliP )->nNumFac    := nNewFacCli
      ( dbfFacCliP )->cSufFac    := cSufFacCli
      ( dbfFacCliP )->nNumRec    := ++nNumRec
      ( dbfFacCliP )->cCodCli    := cCliFacCli
      ( dbfFacCliP )->cNomCli    := cNomFacCli
      ( dbfFacCliP )->cCodCaj    := Application():CodigoCaja()
      ( dbfFacCliP )->dFecCre    := GetSysDate()
      ( dbfFacCliP )->cHorCre    := SubStr( Time(), 1, 5 )
      ( dbfFacCliP )->dPreCob    := aTik[ 6 ]
      ( dbfFacCliP )->dFecVto    := aTik[ 6 ]
      ( dbfFacCliP )->cCodPgo    := aTik[ 21 ]
      ( dbfFacCliP )->dEntrada   := ( dbfTmpP )->dPgoTik
      ( dbfFacCliP )->cDivPgo    := ( dbfTmpP )->cDivPgo
      ( dbfFacCliP )->nVdvPgo    := ( dbfTmpP )->nVdvPgo
      ( dbfFacCliP )->cPgdoPor   := ( dbfTmpP )->cPgdPor
      ( dbfFacCliP )->cTurRec    := ( dbfTmpP )->cTurPgo
      ( dbfFacCliP )->cCtaRec    := ( dbfTmpP )->cCtaRec
      ( dbfFacCliP )->nImporte   := nTotUCobTik( dbfTmpP )

      ( dbfFacCliP )->( dbUnLock() )

      ( dbfTmpP )->( dbSkip() )

      nTotal                     -= ( dbfFacCliP )->nImporte

   end





   aTotal                        := aTotFacCli( aTik[ 31 ], dbfFacCliT, dbfFacCliL, dbfIva, dbfDiv, dbfFacCliP, dbfAntCliT )

   aTik[ 65 ]              := aTotal[1]
   aTik[ 66 ]              := aTotal[2]
   aTik[ 67 ]              := aTotal[4]

   if dbLock( dbfFacCliT )
      ( dbfFacCliT )->nTotNet    := aTotal[1]
      ( dbfFacCliT )->nTotIva    := aTotal[2]
      ( dbfFacCliT )->nTotReq    := aTotal[3]
      ( dbfFacCliT )->nTotFac    := aTotal[4]
      ( dbfFacCliT )->( dbUnLock() )
   end





   WinGather( aTik, aGet, D():tikets( nView ), oBrwDet, nMode, nil, .T. )

return ( nNewFacCli )



Static Function SavTik2Neg( aTmp, aGet, nMode, nSave )

   local aTbl
   local cNumTik
   local cSerTik





   if dbDialogLock( D():Tikets( nView ) )
      ( D():Tikets( nView ) )->lCnvTik := .T.
      ( D():Tikets( nView ) )->lSndDoc := .T.
      ( D():Tikets( nView ) )->( dbUnLock() )
   end





   aTbl                    := dbScatter( D():Tikets( nView ) )
   cSerTik                 := aTbl[ 1 ]
   cNumTik                 := Str( nNewDoc( aTbl[ 1 ], D():Tikets( nView ), "nTikCli", 10, dbfCount ), 10 )
   aTbl[ 5 ]        := cCurSesion()
   aTbl[ 2 ]        := cNumTik
   aTbl[ 3 ]        := RetSufEmp()
   aTbl[ 4 ]        := "1"
   aTbl[ 6 ]        := GetSysDate()
   aTbl[ 27 ]        := .T.
   aTbl[ 26 ]        := .F.
   aTbl[ 65 ]        := - aTbl[ 65 ]
   aTbl[ 66 ]        := - aTbl[ 66 ]
   aTbl[ 67 ]        := - aTbl[ 67 ]

   dbGather( aTbl, D():Tikets( nView ), .T. )





   ( dbfTmpL )->( dbGoTop() )
   while !( dbfTmpL )->( eof() )

      aTbl                 := dbScatter( dbfTmpL )
      aTbl[ 1 ]     := cSerTik
      aTbl[ 2 ]     := cNumTik
      aTbl[ 3 ]     := RetSufEmp()
      aTbl[ 8 ]     := - aTbl[ 8 ]

      dbGather( aTbl, dbfTikL, .T. )

      ( dbfTmpL )->( dbSkip() )

   end

   ( dbfTmpL )->( dbGoTop() )





   ( dbfTmpP )->( dbGoTop() )
   while !( dbfTmpP )->( eof() )

      aTbl                 := dbScatter( dbfTmpP )
      aTbl[ 1 ]     := cSerTik
      aTbl[ 2 ]     := cNumTik
      aTbl[ 3 ]     := RetSufEmp()
      aTbl[ 9 ]     := - ( aTbl[ 9 ] - aTbl[ 10 ] )

      dbGather( aTbl, dbfTikP, .T. )

      ( dbfTmpP )->( dbSkip() )

   end

   ( dbfTmpP )->( dbGoTop() )

Return nil



Static Function SavTik2Tik( aTmp, aGet, nMode, nSave, nNumDev )

   local nRec
   local aTotal





   aArticulosWeb           := {}

   if !empty( oMetMsg )
      oMetMsg:cText        := "Archivando lineas"
      oMetMsg:Refresh()
   end

   nRec                    := ( dbfTmpL )->( Recno() )

   ( dbfTmpL )->( dbGoTop() )
   while !( dbfTmpL )->( eof() )

      if ( dbfTmpL )->dFecTik <> aTmp[ 6 ]
         ( dbfTmpL )->dFecTik := aTmp[ 6 ]
      end

      if ( dbfTmpL )->TFecTik <> aTmp[ 71 ]
         ( dbfTmpL )->TFecTik := aTmp[ 71 ]
      end

      if Empty( ( dbfTmpL )->Uuid )
         ( dbfTmpL )->uuid    := win_uuidcreatestring()
      end

      if ( dbfTmpL )->ParUuid <> aTmp[ 72 ]
         ( dbfTmpL )->ParUuid := aTmp[ 72 ]
      end

      dbPass( dbfTmpL, dbfTikL, .T., aTmp[ 1 ], aTmp[ 2 ], aTmp[ 3 ], aTmp[ 4 ] )

      TComercio:appendProductsToUpadateStocks( (dbfTikL)->cCbaTil, nView )

      ( dbfTmpL )->( dbSkip() )

   end
   ( dbfTmpL )->( dbGoTo( nRec ) )




   if !empty( oMetMsg )
      oMetMsg:cText           := "Archivando pagos"
      oMetMsg:Refresh()
   end

   ( dbfTmpP )->( dbGoTop() )
   while !( dbfTmpP )->( eof() )

      if Empty( ( dbfTmpP )->Uuid )
         ( dbfTmpP )->uuid    := win_uuidcreatestring()
      end

      if ( dbfTmpP )->ParUuid <> aTmp[ 72 ]
         ( dbfTmpP )->ParUuid := aTmp[ 72 ]
      end

      dbPass( dbfTmpP, dbfTikP, .T., aTmp[ 1 ], aTmp[ 2 ], aTmp[ 3 ] )

      ( dbfTmpP )->( dbSkip() )

   end





   if !empty( oMetMsg )
      oMetMsg:cText           := "Archivando series"
      oMetMsg:Refresh()
   end

   nRec                    := ( dbfTmpS )->( Recno() )
   ( dbfTmpS )->( dbGoTop() )
   while !( dbfTmpS )->( eof() )
      dbPass( dbfTmpS, dbfTikS, .T., aTmp[ 1 ], aTmp[ 2 ], aTmp[ 3 ], aTmp[ 4 ], aTmp[ 6 ] )
      ( dbfTmpS )->( dbSkip() )
   end
   ( dbfTmpS )->( dbGoTo( nRec ) )





   if !empty( oMetMsg )
      oMetMsg:cText  := "Archivando ticket"
      oMetMsg:Refresh()
   end





   SysRefresh()





   aTmp[ 22 ]  += nTotValTik( aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ], D():Tikets( nView ), dbfTikL, dbfDiv )





   aTotal            := aTotTik( aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ], D():Tikets( nView ), dbfTmpL, dbfDiv, aTmp, nil, .F. )

   aTmp[ 65 ]  := aTotal[1]
   aTmp[ 66 ]  := aTotal[2]
   aTmp[ 67 ]  := aTotal[3]






   do case
      case nMode == 1



         AuditoriaModel():addRegister( aTmp[ 72 ], "Simplificada añadida " + aTmp[ 1 ] + "/" + AllTrim( aTmp[ 2 ] ) + "/" + aTmp[ 3 ], "12" )

      case nMode == 2

         oAuditoria:SaveTemporal()

   end





   WinGather( aTmp, nil, D():Tikets( nView ), nil, nMode )

Return nil







FUNCTION SndTikCli( lMark, cTikT, dbfFacCliT, dbfAlbCliT )





   if dbDialogLock( cTikT )
      ( cTikT )->lSndDoc := lMark
      ( cTikT )->( dbRUnLock() )
   end





   do case
   case ( cTikT )->cTipTik == "3"

      if ( dbfFacCliT )->( dbSeek( ( cTikT )->cNumDoc ) )

         if dbDialogLock( dbfFacCliT )
            ( dbfFacCliT )->lSndDoc := lMark
            ( dbfFacCliT )->( dbRUnLock() )
         end

      end

   case ( cTikT )->cTipTik == "2"

      if ( dbfAlbCliT )->( dbSeek( ( cTikT )->cNumDoc ) )

         if dbDialogLock( dbfAlbCliT )
            ( dbfAlbCliT )->lSndDoc := lMark
            ( dbfAlbCliT )->( dbRUnLock() )
         end

      end

   end

Return nil



Static Function nChkPagTik( cNumTik, cTikT, dbfTikL, dbfTikP, dbfIva, dbfDiv )

   local nTot
   local nCob
   local nBmp     := 1

   if !( D():Tikets( nView ) )->lPgdTik

      nTot        := ( D():Tikets( nView ) )->nTotTik
      nCob        := nTotCobTik( cNumTik, dbfTikP, dbfDiv )

      do case
      case !lMayorIgual( nTot, nCob )
         nBmp     := 1
      case ( nCob > 0 )
         nBmp     := 2
      otherwise
         nBmp     := 3
      end

   end

return ( nBmp )



function cTipTik( cNumTik, uTikCliT )

   local cTipTik  := "1"

   if ValType( uTikCliT ) == "C"

      if ( uTikCliT )->( dbSeek( cNumTik ) )
         cTipTik  := ( uTikCliT )->cTipTik
      end

   else

      if uTikCliT:Seek( cNumTik )
         cTipTik  := uTikCliT:cTipTik
      end

   end

return ( cTipTik )



function nTotDTikCli( cCodArt, cTikCliT, cTikCliL, cCodAlm )

   local nTotVta  := 0
   local nRecno   := ( cTikCliL )->( Recno() )
   local cTipTik  := cTipTik( ( cTikCliL )->cSerTil + ( cTikCliL )->cNumTil + ( cTikCliL )->cSufTil, cTikCliT )

   if ( cTikCliL )->( dbSeek( cCodArt ) )

      while ( cTikCliL )->cCbaTil == cCodArt .AND. !( cTikCliL )->( eof() )

         if cCodAlm <> nil
            if ( cTikCliT )->cAlmTik == cCodAlm
               if cTipTik == "1"
                  nTotVta  += ( cTikCliL )->nUntTil
               elseif cTipTik == "4"
                  nTotVta  -= ( cTikCliL )->nUntTil
               end
            end
         else
            if cTipTik == "1"
               nTotVta  += ( cTikCliL )->nUntTil
            elseif cTipTik == "4"
               nTotVta  -= ( cTikCliL )->nUntTil
            end
         end

         ( cTikCliL )->( dbSkip() )

      end

   end

   ( cTikCliL )->( dbGoTo( nRecno ) )

return ( nTotVta )






function nTotVTikCli( cCodArt, cTikCliT, dbfTikCliL, nDec, nDor )

   local nTotVta  := 0
   local nRecno   := ( dbfTikCliL )->( Recno() )
   local cTipTik  := cTipTik( ( dbfTikCliL )->cSerTil + ( dbfTikCliL )->cNumTil + ( dbfTikCliL )->cSufTil, cTikCliT )

   if ( dbfTikCliL )->( dbSeek( cCodArt ) )

      while ( dbfTikCliL )->cCbaTil == cCodArt .AND. !( dbfTikCliL )->( eof() )

         if cTipTik == "1"
            nTotVta  += nTotLTpv( dbfTikCliL, nDec, nDor )
         elseif cTipTik == "4"
            nTotVta  -= nTotLTpv( dbfTikCliL, nDec, nDor )
         end

         ( dbfTikCliL )->( dbSkip() )

      end

   end

   ( dbfTikCliL )->( dbGoTo( nRecno ) )

return ( nTotVta )



static function nCopiasTipoTicket( cTipTik, lEntrega, dbfCajT )

   local nCopies  := 1

   do case
      case cTipTik == "1"

        do case
            case ( lRegalo == .T. )
               nCopies := nCopiasTicketsRegaloEnCaja( Application():CodigoCaja(), dbfCajT )

            case ( lEntrega == .T. )
               nCopies := nCopiasEntregasEnCaja( Application():CodigoCaja(), dbfCajT )

            otherwise
               nCopies := nCopiasTicketsEnCaja( Application():CodigoCaja(), dbfCajT )

         end

      case cTipTik == "6"
         nCopies := nCopiasValesEnCaja( Application():CodigoCaja(), dbfCajT )

      case cTipTik == "4"
         nCopies := nCopiasDevolucionesEnCaja( Application():CodigoCaja(), dbfCajT )

      case cTipTik == "2"
         nCopies := nCopiasAlbaranesEnCaja( Application():CodigoCaja(), dbfCajT )

      case cTipTik == "3"
         nCopies := nCopiasFacturasEnCaja( Application():CodigoCaja(), dbfCajT )

   end

return nCopies



static function ClkMoneda( nImporte, oGet, lInit )

   local nVal  := oGet:VarGet()

   if lInit
      nVal     := nImporte
      lInit    := .F.
   else
      nVal     += nImporte
   end

   oGet:cText( nVal )

return nil






Function aTipTik( uTikT )

   local nTipTik

   If( uTikT == nil, uTikT := if( !Empty( nView ), D():Tikets( nView ), ), ) ;

   do case
      case Valtype( uTikT ) == "C"

         if ( uTikT )->lFreTik
            nTipTik     := Len( aTipDoc )
         else
            nTipTik     := Val( ( uTikT )->cTipTik )
            nTipTik     := Min( Max( nTipTik, 1 ), ( Len( aTipDoc ) - 1 ) )
         end

      case Valtype( uTikT ) == "A"

         if uTikT[ 64 ]
            nTipTik     := Len( aTipDoc )
         else
            nTipTik     := Val( uTikT[ 4 ] )
            nTipTik     := Min( Max( nTipTik, 1 ), ( Len( aTipDoc ) - 1 ) )
         end

      case Valtype( uTikT ) == "O"

         if uTikT:lFreTik
            nTipTik     := Len( aTipDoc )
         else
            nTipTik     := Val( uTikT:cTipTik )
            nTipTik     := Min( Max( nTipTik, 1 ), ( Len( aTipDoc ) - 1 ) )
         end

   end

Return ( aTipDoc[ nTipTik ] )



static function DisImg( cCodArt )

   local cFilBmp     := RetImg( cCodArt, dbfArticulo )

   cFilBmp           := cFileBmpName( cFilBmp )

   if file( cFilBmp )
      oBmpVis:Show()
      oBmpVis:ReLoad( , cFilBmp )
   else
      oBmpVis:Hide()
   end

return ( .T. )



FUNCTION Tik2AlbFac( nTipTik, cNumDoc )

do case
   case nTipTik == "2"
      EdtAlbCli( cNumDoc )
   case nTipTik == "3"
      EdtFacCli( cNumDoc )
   otherwise
      msginfo( "No hay documento asociado", cNumDoc )
end

return nil



STATIC FUNCTION ContTpv( cTikT, oBrw )

   local oDlg
   local oSerIni
   local oSerFin
   local nRecno      := ( D():Tikets( nView ) )->( recno() )
   local nOrdAnt     := ( D():Tikets( nView ) )->( ordsetfocus(1) )
   local cSerIni     := ( D():Tikets( nView ) )->cSerTik
   local cSerFin     := ( D():Tikets( nView ) )->cSerTik
   local nDocIni     := Val( ( D():Tikets( nView ) )->cNumTik )
   local nDocFin     := Val( ( D():Tikets( nView ) )->cNumTik )
   local cSufIni     := ( D():Tikets( nView ) )->cSufTik
   local cSufFin     := ( D():Tikets( nView ) )->cSufTik
   local oChk1
   local lChk1       := .T.

   oDlg = TDialog():New(,,,,, "CONTPV",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )









   oSerIni := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cSerIni, cSerIni:= u ) }, oDlg,, "@!", {||    ( cSerIni >= "A" .AND. cSerIni <= "Z" )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerIni ) )}, {||  ( DwSerie( oSerIni ) )},,,, nil,,, )









   oSerFin := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cSerFin, cSerFin:= u ) }, oDlg,, "@!", {||    ( cSerFin >= "A" .AND. cSerFin <= "Z" )},,,,,, .T.,,, .F., .T., {||    ( UpSerie( oSerFin ) )}, {||  ( DwSerie( oSerFin ) )},,,, nil,,, )






   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, nDocIni, nDocIni:= u ) }, oDlg,, "999999999",, "N/W*",,,,, .F.,,, .F., .T.,,,,,, nil,,, )






   TGetHlp():ReDefine( 130, { | u | If( PCount()==0, nDocFin, nDocFin:= u ) }, oDlg,, "999999999",, "N/W*",,,,, .F.,,, .F., .T.,,,,,, nil,,, )





   TGetHlp():ReDefine( 140, { | u | If( PCount()==0, cSufIni, cSufIni:= u ) }, oDlg,, "##",, "N/W*",,,,, .F.,,, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 150, { | u | If( PCount()==0, cSufFin, cSufFin:= u ) }, oDlg,, "##",, "N/W*",,,,, .F.,,, .F., .F.,,,,,, nil,,, )



   oChk1 := TCheckBox():ReDefine( 160, { | u | If( PCount()==0, lChk1, lChk1:= u ) }, oDlg,,,,,,, .F.,, .F. )




   TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





   TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )
   oDlg:bStart := { || oSerIni:SetFocus() }

    oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      ( D():Tikets( nView ) )->( dbGoTop())
      ( D():Tikets( nView ) )->( ordsetfocus( 1 ) )

      ( D():Tikets( nView ) )->( dbSeek( cSerIni + Str( nDocIni, 10 ) + cSufIni, .T. ) )

      while (D():Tikets( nView ))->cSerTik + (D():Tikets( nView ))->cNumTik + (D():Tikets( nView ))->cSufTik <= cSerFin + Str( nDocFin, 10 ) + cSufFin .AND. !(D():Tikets( nView ))->( eof() )

         if lChk1

            if ( D():Tikets( nView ) )->( dbRLock() )
               ( D():Tikets( nView ) )->lConTik := .T.
               ( D():Tikets( nView ) )->( dbUnlock() )
            end

         else

            if ( D():Tikets( nView ) )->( dbRLock() )
               ( D():Tikets( nView ) )->lConTik := .F.
               ( D():Tikets( nView ) )->( dbUnlock() )
            end

         end

      ( D():Tikets( nView ) )->( dbSkip() )

      end

   end

   ( D():Tikets( nView ) )->( ordsetfocus( nOrdAnt ) )
   ( D():Tikets( nView ) )->( dbGoTo( nRecNo ) )

   oBrw:Refresh()

RETURN ( oDlg:nResult == 1 )



Function NameToField( cName )

   local cField   := {|| "" }

   cName          := AllTrim( cName )

   do case
      case cName == "Código del artículo"
         cField   := {|| ( dbfTmpL )->cCbaTil }
      case cName == "Unidades"
         cField   := {|| nTotNTpv( dbfTmpL, cPicUnd ) }
      case cName == "Propiedad 1"
         cField   := {|| ( dbfTmpL )->cValPr1 }
      case cName == "Propiedad 2"
         cField   := {|| ( dbfTmpL )->cValPr2 }
      case cName == "Nombre propiedad 1"
         cField   := {|| nombrePrimeraPropiedadTicketsLineas( dbfTmpL ) }
      case cName == "Nombre propiedad 2"
         cField   := {|| nombreSegundaPropiedadTicketsLineas( dbfTmpL ) }
      case cName == "Lote"
         cField   := {|| ( dbfTmpL )->cLote }
      case cName == "Caducidad"
         cField   := {|| ( dbfTmpL )->dFecCad }
      case cName == "Medición 1"
         cField   := {|| Trans( ( dbfTmpL )->nMedUno, MasUnd() ) }
      case cName == "Medición 2"
         cField   := {|| Trans( ( dbfTmpL )->nMedDos, MasUnd() ) }
      case cName == "Medición 3"
         cField   := {|| Trans( ( dbfTmpL )->nMedTre, MasUnd() ) }
      case cName == "Detalle"
         cField   := {|| Rtrim( ( dbfTmpL )->cNomTil ) }
      case cName == "Importe"
         cField   := {|| Trans( ( dbfTmpL )->nPvpTil, cPouDiv ) }
      case cName == "Descuento lineal"
         cField   := {|| Trans( nDtoUTpv( dbfTmpL, nDouDiv ), cPouDiv ) }
      case cName == "Descuento porcentual"
         cField   := {|| Trans( ( dbfTmpL )->nDtoLin, "@E 999.99" ) }
      case cName == "Total"
         cField   := {|| Trans( nTotLTpv( dbfTmpL, nDouDiv, nDorDiv ), cPorDiv ) }
      case cName == "Número de serie"
         cField   := {|| ( dbfTmpL )->mNumSer }
      case cName == "Promoción"
         cField   := {|| ( dbfTmpL )->lInPromo }
      case cName == "Oferta"
         cField   := {|| ( dbfTmpL )->lLinOfe }
      case cName == "Número de línea"
         cField   := {|| Trans( ( dbfTmpL )->nNumLin, "9999" ) }
      case cName == "Ubicación"
         cField   := {|| retFld( ( dbfTmpL )->cCbaTil + ( dbfTmpL )->cAlmLin, D():ArticuloStockAlmacenes( nView ), "cUbica" ) }
      case cName == "Código de barras"
         cField   := {|| cCodigoBarrasDefecto( ( dbfTmpL )->cCbaTil, dbfCodeBar ) }
      case cName == "Porcentaje I.V.A."
         cField   := {|| ( dbfTmpL )->nIvaTil }
   end

RETURN ( cField )



STATIC FUNCTION LqdVale( oWndBrw )

   if ( D():Tikets( nView ) )->cTipTik == "6"

      if !( D():Tikets( nView ) )->lLiqTik

         if dbLock( D():Tikets( nView ) )
            ( D():Tikets( nView ) )->lLiqTik := .T.
            ( D():Tikets( nView ) )->( dbUnLock() )
         end

      else

         msgStop( "Este documento ya está liquidado." )

      end

   else

      msgStop( "Este documento no se almacenó como vale." )

   end

   oWndBrw:SetFocus()
   oWndBrw:Refresh()

RETURN NIL



FUNCTION AppTikCli( cCodCli, cCodArt, lOpenBrowse )

   local nLevel         := Auth():Level( "terminal_punto_de_venta" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FrontTpv( nil, nil, cCodCli, cCodArt )
         oWndBrw:RecAdd()
      end

   else

      if OpenFiles( nil, .T. )
         WinAppRec( nil, bEditT, D():Tikets( nView ), cCodCli, cCodArt )
         CloseFiles()
      end

   end

Return .T.



FUNCTION InitTikCli( nNumTik )

   local nLevel         := Auth():Level( "terminal_punto_de_venta" )

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
      nTotTik()
      WinEdtRec( nil, bEditT, D():Tikets( nView ) )
   else
      MsgStop( "No se encuentra ticket" )
   end

Return .T.






FUNCTION EdtTikCli( nNumTik, lOpenBrowse )

   local nLevel         := Auth():Level( "terminal_punto_de_venta" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FrontTpv( , , , , .F. )
         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            oWndBrw:RecEdit()
         else
            MsgStop( "No se encuentra ticket" )
         end
      end

   else

      if OpenFiles( nil, .T. )

         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )

            nTotTik()

            WinEdtRec( nil, bEditT, D():Tikets( nView ) )
         else
            MsgStop( "No se encuentra ticket" )
         end

         CloseFiles()

      end

   end

Return .T.






FUNCTION ZooTikCli( nNumTik, lOpenBrowse  )

   local nLevel         := Auth():Level( "terminal_punto_de_venta" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FrontTpv( , , , , .F. )
         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            oWndBrw:RecZoom()
         else
            MsgStop( "No se encuentra ticket" )
         end
      end

   else

      if OpenFiles( nil, .T. )
         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            nTotTik()
            WinZooRec( nil, bEditT, D():Tikets( nView ) )
         else
            MsgStop( "No se encuentra ticket" )
         end
         CloseFiles()
      end

   end

RETURN NIL






FUNCTION DelTikCli( nNumTik, lOpenBrowse )

   local nLevel         := Auth():Level( "terminal_punto_de_venta" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FrontTpv( , , , , .F. )
         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            DeleteRegister( oWndBrw, D():Tikets( nView ), {|| TpvDelRec() } )
         else
            MsgStop( "No se encuentra ticket" )
         end
      end

   else

      if OpenFiles( nil, .T. )
         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            nTotTik()
            DeleteRegister( oWndBrw, D():Tikets( nView ), {|| TpvDelRec() } )
         else
            MsgStop( "No se encuentra ticket" )
         end
         CloseFiles()
      end

   end

RETURN NIL






FUNCTION PrnTikCli( nNumTik, lOpenBrowse )

   local nLevel         := Auth():Level( "terminal_punto_de_venta" )
   local nOrdAnt

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   do case
   case lOpenBrowse

      if FrontTpv( , , , , .F. )
         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            ImpTiket( 1 )
         else
            MsgStop( "No se encuentra ticket" )
         end
      end

   case lOpenFiles

      if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
         nTotTik()
         ImpTiket( 1 )
      else
         MsgStop( "No se encuentra ticket:" + nNumTik )
      end

   otherwise

      if OpenFiles( nil, .T. )

         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            nTotTik()
            ImpTiket( 1 )
         else
            MsgStop( "No se encuentra ticket" )
         end

         CloseFiles()

      end

   end

RETURN NIL






FUNCTION VisTikCli( nNumTik, lOpenBrowse )

   local nLevel         := Auth():Level( "terminal_punto_de_venta" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   if lOpenBrowse

      if FrontTpv( , , , , .F. )
         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            ImpTiket( 2 )
         else
            MsgStop( "No se encuentra ticket" )
         end
      end

   else

      if OpenFiles( nil, .T. )
         if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
            nTotTik()
            ImpTiket( 2 )
         else
            MsgStop( "No se encuentra ticket" )
         end
         CloseFiles()
      end

   end

RETURN NIL



Function EdtCobTikCli( nNumTik, lOpenBrowse )

   local nLevel         := Auth():Level( "terminal_punto_de_venta" )

   If( lOpenBrowse == nil, lOpenBrowse := .F., ) ;

   if nAnd( nLevel, 1 ) == 0 .OR. nAnd( nLevel, 4 ) == 0
      msgStop( "Acceso no permitido." )
      return .T.
   end

   Sysrefresh()

   if OpenFiles( nil, .T. )
      if dbSeekInOrd( nNumTik, "cNumTik", D():Tikets( nView ) )
         EdtCobTik()
      else
         MsgStop( "No se encuentra ticket" )
      end
      CloseFiles()
   end

   Sysrefresh()

Return .T.



static function lFacturaAlbaran()

   if ( D():Tikets( nView ) )->cTipTik == "2"
      if !RetFld( ( D():Tikets( nView ) )->cNumDoc, dbfAlbCliT, "lFacturado" )
         FactCli( nil, nil, { "Albaran" => ( D():Tikets( nView ) )->cNumDoc } )
      else
         msgStop( "El albarán ya ha sido facturado" )
      end
   else
      msgStop( "Sólo se pueden generar facturas desde albaranes" )
   end

Return ( .T. )



Static Function Recalcula( aTmp )

   local nRec





   nRec        := ( dbfTmpL )->( Recno() )

   ( dbfTmpL )->( dbGoTop() )
   while !( dbfTmpL )->( eof() )

      if lValLine( dbfTmpL ) .AND. !( dbfTmpL )->lFreTil


         if dbSeekInOrd( ( dbfTmpL )->cCbaTil, "CodeBar", dbfArticulo ) .OR. dbSeekInOrd( ( dbfTmpL )->cCbaTil, "Codigo", dbfArticulo )

            ( dbfTmpL )->nPvpTil    := nRetPreArt( aTmp[ 12 ], aTmp[ 24 ], .T., dbfArticulo, dbfDiv, dbfKit, dbfIva, .T. )

         end

      end

      (  dbfTmpL )->( dbskip() )

   end

   ( dbfTmpL )->( dbGoTo( nRec ) )

   lRecTotal( aTmp )

   oBrwDet:Refresh()

Return .T.



Static Function AppendAsociado( uTmpLin, aTik )

   local cCodArt
   local cSerTil
   local cNumTil
   local cSufTil
   local cAlmLin
   local nUntTil
   local nIvaTil
   local nNumLin
   local nPosPrint

   if ValType( uTmpLin ) == "A"
      cCodArt                       := uTmpLin[ 5 ]
      cSerTil                       := uTmpLin[ 1 ]
      cNumTil                       := uTmpLin[ 2 ]
      cSufTil                       := uTmpLin[ 3 ]
      nNumLin                       := uTmpLin[ 31 ]
      nPosPrint                     := uTmpLin[ 85 ]
      cAlmLin                       := uTmpLin[ 27 ]
      nUntTil                       := uTmpLin[ 8 ]
      nIvaTil                       := uTmpLin[ 10 ]
   else
      cCodArt                       := ( uTmpLin )->cCbaTil
      cSerTil                       := ( uTmpLin )->cSerTil
      cNumTil                       := ( uTmpLin )->cNumTil
      cSufTil                       := ( uTmpLin )->cSufTil
      nNumLin                       := ( uTmpLin )->nNumLin
      nPosPrint                     := ( uTmpLin )->nPosPrint
      cAlmLin                       := ( uTmpLin )->cAlmLin
      nUntTil                       := ( uTmpLin )->nUntTil
      nIvaTil                       := ( uTmpLin )->nIvaTil
   end

   cCodArt                          := Alltrim( cCodArt )

   if ( D():Asociado( nView ) )->( dbSeek( cCodArt ) )

      while Alltrim( ( D():Asociado( nView ) )->cCodArt ) == ( cCodArt ) .AND. !( D():Asociado( nView ) )->( eof() )

         if ( dbfArticulo )->( dbSeek( ( D():Asociado( nView ) )->cRefAsc ) )

            ( dbfTmpL )->( dbAppend() )

            ( dbfTmpL )->cSerTil    := cSerTil
            ( dbfTmpL )->cNumTil    := cNumTil
            ( dbfTmpL )->cSufTil    := cSufTil
            ( dbfTmpL )->nNumLin    := nNumLin
            ( dbfTmpL )->nPosPrint  := nPosPrint
            ( dbfTmpL )->cAlmLin    := cAlmLin
            ( dbfTmpL )->nUntTil    := nUntTil * ( D():Asociado( nView ) )->nUndAsc

            ( dbfTmpL )->cCbaTil    := ( D():Asociado( nView ) )->cRefAsc
            ( dbfTmpL )->cNomTil    := ( dbfArticulo )->Nombre
            ( dbfTmpL )->cFamTil    := ( dbfArticulo )->Familia
            ( dbfTmpL )->lTipAcc    := ( dbfArticulo )->lTipAcc
            ( dbfTmpL )->nCtlStk    := ( dbfArticulo )->nCtlStock
            ( dbfTmpL )->cCodImp    := ( dbfArticulo )->cCodImp

            if ( dbfArticulo )->lFacCnv
               ( dbfTmpL )->nFacCnv := ( dbfArticulo )->nFacCnv
            end

            ( dbfTmpL )->nValImp    := oNewImp:nValImp( ( dbfArticulo )->cCodImp, .T., nIvaTil )
            ( dbfTmpL )->nCosDiv    := ( dbfArticulo )->pCosto





            if !empty( nIvaTil )
               ( dbfTmpL )->nIvaTil := nIva( dbfIva, ( dbfArticulo )->TipoIva )
            else
               ( dbfTmpL )->nIvaTil := 0
            end

            ( dbfTmpL )->nPvpTil := nRetPreArt( aTik[ 12 ], aTik[ 24 ], .T., dbfArticulo, dbfDiv, dbfKit, dbfIva, .T. )
            ( dbfTmpL )->nCtlStk := ( dbfArticulo )->nCtlStock

         end

         ( D():Asociado( nView ) )->( dbSkip() )

      end

   end

Return ( nil )



Static Function AppendKit( uTmpLin, aTik )

   local cCodArt
   local cSerTil
   local cNumTil
   local cSufTil
   local cAlmLin
   local nUntTil
   local nIvaTil
   local nNumLin
   local nPosPrint

   if ValType( uTmpLin ) == "A"
      cCodArt                       := uTmpLin[ 5 ]
      cSerTil                       := uTmpLin[ 1 ]
      cNumTil                       := uTmpLin[ 2 ]
      cSufTil                       := uTmpLin[ 3 ]
      nNumLin                       := uTmpLin[ 31 ]
      nPosPrint                     := uTmpLin[ 85 ]
      cAlmLin                       := uTmpLin[ 27 ]
      nUntTil                       := uTmpLin[ 8 ]
      nIvaTil                       := uTmpLin[ 10 ]
   else
      cCodArt                       := ( uTmpLin )->cCbaTil
      cSerTil                       := ( uTmpLin )->cSerTil
      cNumTil                       := ( uTmpLin )->cNumTil
      cSufTil                       := ( uTmpLin )->cSufTil
      nNumLin                       := ( uTmpLin )->nNumLin
      nPosPrint                     := ( uTmpLin )->nPosPrint
      cAlmLin                       := ( uTmpLin )->cAlmLin
      nUntTil                       := ( uTmpLin )->nUntTil
      nIvaTil                       := ( uTmpLin )->nIvaTil
   end

   cCodArt                          := Alltrim( cCodArt )

   if ( dbfKit )->( dbSeek( cCodArt ) )

      while Alltrim( ( dbfKit )->cCodKit ) == ( cCodArt ) .AND. !( dbfKit )->( eof() )

         if ( dbfArticulo )->( dbSeek( ( dbfKit )->cRefKit ) )

            ( dbfTmpL )->( dbAppend() )

            ( dbfTmpL )->cSerTil    := cSerTil
            ( dbfTmpL )->cNumTil    := cNumTil
            ( dbfTmpL )->cSufTil    := cSufTil
            ( dbfTmpL )->nNumLin    := nNumLin
            ( dbfTmpL )->nPosPrint  := nPosPrint
            ( dbfTmpL )->cAlmLin    := cAlmLin
            ( dbfTmpL )->nUntTil    := nUntTil * ( dbfKit )->nUndKit

            ( dbfTmpL )->cCbaTil    := ( dbfKit      )->cRefKit
            ( dbfTmpL )->cNomTil    := ( dbfArticulo )->Nombre
            ( dbfTmpL )->cFamTil    := ( dbfArticulo )->Familia
            ( dbfTmpL )->lTipAcc    := ( dbfArticulo )->lTipAcc
            ( dbfTmpL )->nCtlStk    := ( dbfArticulo )->nCtlStock
            ( dbfTmpL )->cCodImp    := ( dbfArticulo )->cCodImp

            if ( dbfArticulo )->lFacCnv
               ( dbfTmpL )->nFacCnv := ( dbfArticulo )->nFacCnv
            end

            ( dbfTmpL )->nValImp    := oNewImp:nValImp( ( dbfArticulo )->cCodImp, .T., nIvaTil )
            ( dbfTmpL )->nCosDiv    := nCosto( nil, dbfArticulo, dbfKit )





            if !empty( nIvaTil )
               ( dbfTmpL )->nIvaTil := nIva( dbfIva, ( dbfArticulo )->TipoIva )
            else
               ( dbfTmpL )->nIvaTil := 0
            end





            ( dbfTmpL )->lKitChl    := .T.
            ( dbfTmpL )->lImpLin    := lImprimirComponente( cCodArt, dbfArticulo )
            ( dbfTmpL )->lKitPrc    := lPreciosComponentes( cCodArt, dbfArticulo )

            if ( dbfTmpL )->lKitPrc
               ( dbfTmpL )->nPvpTil := nRetPreArt( aTik[ 12 ], aTik[ 24 ], .T., dbfArticulo, dbfDiv, dbfKit, dbfIva, .T. )
            end

            if lStockComponentes( cCodArt, dbfArticulo )
               ( dbfTmpL )->nCtlStk := ( dbfArticulo )->nCtlStock
            else
               ( dbfTmpL )->nCtlstk := 3
            end

            if ( dbfArticulo )->lKitArt
               AppendKit( dbfTmpL, aTik )
            end

         end

         ( dbfKit )->( dbSkip() )

      end

   end

Return ( nil )



FUNCTION nTotValLiq( cNumTik, cTikT, dbfTikL, dbfDiv, aTmp, cDivRet, lPic, lExcCnt )

   local nRec  := ( cTikT )->( Recno() )

   local nTik  := nTotTik( cNumTik, cTikT, dbfTikL, dbfDiv, aTmp, cDivRet, lPic, lExcCnt )
   local nVal  := nTotTik( ( cTikT )->cValDoc, cTikT, dbfTikL, dbfDiv, aTmp, cDivRet, lPic, lExcCnt )

   ( cTikT )->( dbGoTo( nRec ) )

Return ( Min( nTik, nVal ) )



FUNCTION IsTpv( cPath )

Return ( .T. )







_HB_CLASS TotalesTPV ; function TotalesTPV ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TotalesTPV", iif( .F., { }, { @HBObject() } ), @TotalesTPV() ) ) ;

   _HB_MEMBER Init(); oClass:AddMethod( "Init", @TotalesTPV_Init(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lValeMayorTotal(); oClass:AddInline( "lValeMayorTotal", {|Self | ( ( Self ) ), ( ( ::nVale <= ::nTotal ) .OR. ( ::nTotal < 0 ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER { nTotal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nTotal"}, .F. )
   _HB_MEMBER { nEntregado } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nEntregado"}, .F. )
   _HB_MEMBER { nCobrado } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCobrado"}, .F. )
   _HB_MEMBER { nVale } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nVale"}, .F. )
   _HB_MEMBER { nAnticipo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nAnticipo"}, .F. )
   _HB_MEMBER { nCobradoDivisa } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCobradoDivisa"}, .F. )
   _HB_MEMBER { nCambio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCambio"}, .F. )

   _HB_MEMBER { oTotal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oTotal"}, .F. )
   _HB_MEMBER { oEntregado } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oEntregado"}, .F. )
   _HB_MEMBER { oCobrado } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCobrado"}, .F. )
   _HB_MEMBER { oCobradoDivisa } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCobradoDivisa"}, .F. )
   _HB_MEMBER { oCambio } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCambio"}, .F. )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TotalesTPV ;

static FUNCTION TotalesTPV_Init( ) ; local Self AS CLASS TotalesTPV := QSelf() AS CLASS TotalesTPV

   ::nTotal             := 0
   ::nCobrado           := 0
   ::nVale              := 0
   ::nAnticipo          := 0
   ::nEntregado         := 0
   ::nCobrado           := 0
   ::nCobradoDivisa     := 0
   ::nCambio            := 0

   ::oTotal             := nil
   ::oEntregado         := nil
   ::oCobrado           := nil
   ::oCobradoDivisa     := nil
   ::oCambio            := nil

Return ( Self )







_HB_CLASS TTiketsClientesSenderReciver ; function TTiketsClientesSenderReciver ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TTiketsClientesSenderReciver", iif( .T., { @TSenderReciverItem() }, { @HBObject() } ), @TTiketsClientesSenderReciver() ) ) ;

   _HB_MEMBER { cFileName } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFileName"}, .F. )

   _HB_MEMBER CreateData(); oClass:AddMethod( "CreateData", @TTiketsClientesSenderReciver_CreateData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RestoreData(); oClass:AddMethod( "RestoreData", @TTiketsClientesSenderReciver_RestoreData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SendData(); oClass:AddMethod( "SendData", @TTiketsClientesSenderReciver_SendData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER ReciveData(); oClass:AddMethod( "ReciveData", @TTiketsClientesSenderReciver_ReciveData(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Process(); oClass:AddMethod( "Process", @TTiketsClientesSenderReciver_Process(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validateRecepcion( tmpTikT, cdbfTikT); oClass:AddMethod( "validateRecepcion", @TTiketsClientesSenderReciver_validateRecepcion(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TTiketsClientesSenderReciver ;



static FUNCTION TTiketsClientesSenderReciver_CreateData( ) ; local Self AS CLASS TTiketsClientesSenderReciver := QSelf() AS CLASS TTiketsClientesSenderReciver

   local lSnd        := .F.
   local cdbfTikT
   local dbfTikL
   local dbfTikP
   local tmpTikT
   local tmpTikL
   local tmpTikP

   if ::oSender:lServer
      ::cFileName         := "TikCli" + win_uuidcreatestring() + ".All"
   else
      ::cFileName         := "TikCli" + win_uuidcreatestring() + "." + RetSufEmp()
   end

   ::oSender:SetText( "Enviando tikets de clientes" )

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @cdbfTikT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
   ordSetFocus( "lSndDoc" )

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "TikeL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEP.DBF" ), ( cCheckArea( "TIKEP", @dbfTikP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end





   mkTpv( cPatSnd() )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @tmpTikT ) ), iif( .F. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "TIKET.CDX" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @tmpTikL ) ), iif( .F. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "TikeL.Cdx" ) )

   dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "TIKEP.DBF" ), ( cCheckArea( "TIKEP", @tmpTikP ) ), iif( .F. .OR. .F., ! .F., NIL ), .F. )
   if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "TIKEP.CDX" ) )

   if !empty( ::oSender:oMtr )
      ::oSender:oMtr:nTotal := ( cdbfTikT )->( OrdKeyCount() )
   end

   if ( cdbfTikT )->( dbSeek( .T. ) )

      while ( cdbfTikT )->lSndDoc .AND. !( cdbfTikT )->( eof() )

         lSnd  := .T.

         dbPass( cdbfTikT, tmpTikT, .T. )
         ::oSender:SetText( ( cdbfTikT )->cSerTik + "/" + AllTrim( ( cdbfTikT )->cNumTik ) + "/" + AllTrim( ( cdbfTikT )->cSufTik ) + "; " + Dtoc( ( cdbfTikT )->dFecTik ) + "; " + AllTrim( ( cdbfTikT )->cCliTik ) + "; " + ( cdbfTikT )->cNomTik )





         if ( dbfTikL )->( dbSeek( ( cdbfTikT )->cSerTik + ( cdbfTikT )->cNumTik + ( cdbfTikT )->cSufTik ) )
            while ( cdbfTikT )->cSerTik + ( cdbfTikT )->cNumTik + ( cdbfTikT )->cSufTik == ( dbfTikL )->CSERTIL + ( dbfTikL )->CNUMTIL + ( dbfTikL )->CSUFTIL .AND. !( dbfTikL )->( eof() )
               dbPass( dbfTikL, tmpTikL, .T. )
               ( dbfTikL )->( dbSkip() )
            end
         end





         if ( dbfTikP )->( dbSeek( ( cdbfTikT )->cSerTik + ( cdbfTikT )->cNumTik + ( cdbfTikT )->cSufTik ) )
            while ( cdbfTikT )->cSerTik + ( cdbfTikT )->cNumTik + ( cdbfTikT )->cSufTik == ( dbfTikP )->cSerTik + ( dbfTikP )->cNumTik + ( dbfTikP )->cSufTik .AND. !( dbfTikP )->( eof() )
               dbPass( dbfTikP, tmpTikP, .T. )
               ( dbfTikP )->( dbSkip() )
            end
         end

         ( cdbfTikT )->( dbSkip() )

         if !empty( ::oSender:oMtr )
            ::oSender:oMtr:Set( ( cdbfTikT )->( OrdKeyNo() ) )
         end

      end

   end





   ( tmpTikT )->( dbCloseArea() )
   ( tmpTikL )->( dbCloseArea() )
   ( tmpTikP )->( dbCloseArea() )
   ( cdbfTikT )->( dbCloseArea() )
   ( dbfTikL )->( dbCloseArea() )
   ( dbfTikP )->( dbCloseArea() )

   if lSnd

      ::oSender:SetText( "Comprimiendo tikets de clientes" )

      if ::oSender:lZipData( ::cFileName )
         ::oSender:SetText( "Ficheros comprimidos" )
      else
         ::oSender:SetText( "ERROR al crear fichero comprimido" )
      end

   else

      ::oSender:SetText( "No hay registros tikets para enviar" )

   end

Return ( Self )



static FUNCTION TTiketsClientesSenderReciver_RestoreData( ) ; local Self AS CLASS TTiketsClientesSenderReciver := QSelf() AS CLASS TTiketsClientesSenderReciver

   local cdbfTikT

   if ::lSuccesfullSend





      dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @cdbfTikT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
      if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end
      ( cdbfTikT )->( ordsetfocus( "lSndDoc" ) )

      while ( cdbfTikT )->( dbSeek( .T. ) ) .AND. !( cdbfTikT )->( eof() )
         if ( cdbfTikT )->( dbRLock() )
            ( cdbfTikT )->lSndDoc := .F.
            ( cdbfTikT )->( dbRUnlock() )
         end
      end

      ( cdbfTikT )->( dbCloseArea() )

   end

Return ( Self )



static FUNCTION TTiketsClientesSenderReciver_SendData( ) ; local Self AS CLASS TTiketsClientesSenderReciver := QSelf() AS CLASS TTiketsClientesSenderReciver

   if file( cPatOut() + ::cFileName )

      if ::oSender:SendFiles( cPatOut() + ::cFileName, ::cFileName )
         ::lSuccesfullSend := .T.
         ::oSender:SetText( "Fichero enviado " + ::cFileName )
      else
         ::oSender:SetText( "ERROR al enviar fichero" )
      end

   end

Return ( Self )



static FUNCTION TTiketsClientesSenderReciver_ReciveData( ) ; local Self AS CLASS TTiketsClientesSenderReciver := QSelf() AS CLASS TTiketsClientesSenderReciver

   local n
   local aExt

   aExt     := ::oSender:aExtensions()





   ::oSender:SetText( "Recibiendo tikets de clientes" )

   for n := 1 to len( aExt )
      ::oSender:GetFiles( "TikCli*." + aExt[ n ], cPatIn() )
   next

   ::oSender:SetText( "Tickets de clientes recibidos" )

Return Self



static FUNCTION TTiketsClientesSenderReciver_Process( ) ; local Self AS CLASS TTiketsClientesSenderReciver := QSelf() AS CLASS TTiketsClientesSenderReciver

   local m
   local oStock
   local tmpTikT
   local tmpTikL
   local tmpTikP
   local dbfDiv
   local cdbfTikT
   local dbfTikL
   local dbfTikP
   local dbfClient
   local nTotTik
   local nTotTikOld
   local nTotTikNew
   local oBlock
   local oError
   local aFiles      := Directory( cPatIn() + "TikCli*.*" )





   ::oSender:SetText( "Importando tikets de clientes" )

   for m := 1 TO len( aFiles )

      ::oSender:SetText( "Procesando fichero : " + aFiles[ m, 1 ] )

      oBlock         := ErrorBlock( {| oError | ApoloBreak( oError ) } )
      BEGIN SEQUENCE





      if ::oSender:lUnZipData( cPatIn() + aFiles[ m, 1 ] )







         if lExistTable( cPatSnd() + "TIKET.DBF", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "TIKEL.DBF", cLocalDriver() ) .AND. lExistTable( cPatSnd() + "TIKEP.DBF", cLocalDriver() )

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @cdbfTikT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikL ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "TikeL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "TIKEP.DBF" ), ( cCheckArea( "TIKEP", @dbfTikP ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
            if !lAIS() ; ordListAdd( ( cPatEmp() + "TIKEP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

            dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "TIKET.DBF" ), ( cCheckArea( "TIKET", @tmpTikT ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
            if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "TIKET.CDX" ) )

            dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @tmpTikL ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
            if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "TikeL.Cdx" ) )

            dbUseArea( .T., ( cLocalDriver() ), ( cPatSnd() + "TIKEP.DBF" ), ( cCheckArea( "TIKEP", @tmpTikP ) ), iif( .F. .OR. .F., ! .F., NIL ), .T. )
            if ! .T. ; ordListClear() ; end ; ordListAdd( ( cPatSnd() + "TIKEP.CDX" ) )

            oStock            := TStock():New()
            oStock:cTikT      := cdbfTikT
            oStock:cTikL      := dbfTikL

            if !empty( ::oSender:oMtr )
               ::oSender:oMtr:nTotal := ( tmpTikT )->( ordKeyCount() )
            end

            while !( tmpTikT )->( eof() )

               if ::validateRecepcion( tmpTikT, cdbfTikT )

                  while ( cdbfTikT )->( dbseek( ( tmpTikT )->cSerTik + ( tmpTikT )->cNumTik + ( tmpTikT )->cSufTik ) )
                     dbLockDelete( cdbfTikT )
                  end

                  dbPass( tmpTikT, cdbfTikT, .T. )

                  if dbLock( cdbfTikT )
                     ( cdbfTikT )->lSndDoc := .F.
                     ( cdbfTikT )->( dbUnLock() )
                  end

                  ::oSender:SetText( "Reemplazado : " + ( cdbfTikT )->cSerTik + "/" + AllTrim( ( cdbfTikT )->cNumTik ) + "/" + AllTrim( ( cdbfTikT )->cSufTik ) + "; " + Dtoc( ( cdbfTikT )->dFecTik ) + "; " + AllTrim( ( cdbfTikT )->cCliTik ) + "; " + ( cdbfTikT )->cNomTik )





                  while ( dbfTikL )->( dbSeek( ( tmpTikT )->cSerTik + ( tmpTikT )->cNumTik + ( tmpTikT )->cSufTik ) )
                     if dbLock( dbfTikL )
                        ( dbfTikL )->( dbDelete() )
                        ( dbfTikL )->( dbUnLock() )
                     end
                  end





                  while ( dbfTikP )->( dbSeek( ( tmpTikT )->cSerTik + ( tmpTikT )->cNumTik + ( tmpTikT )->cSufTik ) )
                     if dbLock( dbfTikP )
                        ( dbfTikP )->( dbDelete() )
                        ( dbfTikP )->( dbUnLock() )
                     end
                  end





                  if ( tmpTikL )->( dbSeek( ( tmpTikT )->cSerTik + ( tmpTikT )->cNumTik + ( tmpTikT )->cSufTik ) )
                     while ( tmpTikT )->cSerTik + ( tmpTikT )->cNumTik + ( tmpTikT )->cSufTik == ( tmpTikL )->cSerTil + ( tmpTikL )->cNumTil + ( tmpTikL )->cSufTil .AND. !( tmpTikL )->( eof() )
                        dbPass( tmpTikL, dbfTikL, .T. )
                        ( tmpTikL )->( dbSkip() )
                     end
                  end





                  if ( tmpTikP )->( dbSeek( ( tmpTikT )->cSerTik + ( tmpTikT )->cNumTik + ( tmpTikT )->cSufTik ) )
                     while ( tmpTikT )->cSerTik + ( tmpTikT )->cNumTik + ( tmpTikT )->cSufTik == ( tmpTikP )->cSerTik + ( tmpTikP )->cNumTik + ( tmpTikP )->cSufTik .AND. !( tmpTikP )->( eof() )
                        dbPass( tmpTikP, dbfTikP, .T. )
                        ( tmpTikP )->( dbSkip() )
                     end
                  end

               end

               ( tmpTikT )->( dbSkip() )

               if !empty( ::oSender:oMtr )
                  ::oSender:oMtr:Set( ( tmpTikT )->( OrdKeyNo() ) )
               end

               SysRefresh()

            end

            if !empty( ::oSender:oMtr )
               ::oSender:oMtr:nTotal := ( tmpTikT )->( ordKeyCount() )
            end





            ( cdbfTikT   )->( dbCloseArea() )
            ( dbfTikL   )->( dbCloseArea() )
            ( dbfTikP   )->( dbCloseArea() )
            ( dbfDiv    )->( dbCloseArea() )
            ( tmpTikT   )->( dbCloseArea() )
            ( tmpTikL   )->( dbCloseArea() )
            ( tmpTikP   )->( dbCloseArea() )

            oStock:end()

            fErase( cPatSnd() + "TikeT.Dbf" )
            fErase( cPatSnd() + "TikeL.Dbf" )
            fErase( cPatSnd() + "TikeP.Dbf" )

            ::oSender:AppendFileRecive( aFiles[ m, 1 ] )

         else

            ::oSender:SetText( "Faltan ficheros" )

            if !lExistTable( cPatSnd() + "TikeT.Dbf", cLocalDriver() )
               ::oSender:SetText( "Falta " + cPatSnd() + "TikeT.Dbf" )
            end

            if !lExistTable( cPatSnd() + "TikeL.Dbf", cLocalDriver() )
               ::oSender:SetText( "Falta " + cPatSnd() + "TikeL.Dbf" )
            end

            if !lExistTable( cPatSnd() + "TikeP.Dbf", cLocalDriver() )
               ::oSender:SetText( "Falta " + cPatSnd() + "TikeP.Dbf" )
            end

         end

      end

      RECOVER USING oError

         ( cdbfTikT   )->( dbCloseArea() )
         ( dbfTikL   )->( dbCloseArea() )
         ( dbfTikP   )->( dbCloseArea() )
         ( dbfClient )->( dbCloseArea() )
         ( dbfDiv    )->( dbCloseArea() )
         ( tmpTikT   )->( dbCloseArea() )
         ( tmpTikL   )->( dbCloseArea() )
         ( tmpTikP   )->( dbCloseArea() )

         ::oSender:SetText( "Error procesando fichero " + aFiles[ m, 1 ] )
         ::oSender:SetText( ErrorMessage( oError ) )

      end

      ErrorBlock( oBlock )

   next

Return Self



static FUNCTION TTiketsClientesSenderReciver_validateRecepcion( tmpTikT, cdbfTikT ) ; local Self AS CLASS TTiketsClientesSenderReciver := QSelf() AS CLASS TTiketsClientesSenderReciver

   ::cErrorRecepcion       := "Pocesando tickets de cliente número " + ( cdbfTikT )->cSerTik + "/" + alltrim( ( cdbfTikT )->cNumTik ) + "/" + alltrim( ( cdbfTikT )->cSufTik ) + " "

   if !( lValidaOperacion( ( tmpTikT )->dFecTik, .F. ) )
      ::cErrorRecepcion    += "la fecha " + dtoc( ( tmpTikT )->dFecTik ) + " no es valida en esta empresa"
      Return .F.
   end

   if !( cdbfTikT )->( dbSeek( ( tmpTikT )->cSerTik + ( tmpTikT )->cNumTik + ( tmpTikT )->cSufTik ) )
      Return .T.
   end

   if dtos( ( cdbfTikT )->dFecCre ) + ( cdbfTikT )->cTimCre > dtos( ( tmpTikT )->dFecCre ) + ( tmpTikT )->cTimCre
      ::cErrorRecepcion    += "la fecha en la empresa " + dtoc( ( cdbfTikT )->dFecCre ) + " " + ( cdbfTikT )->cTimCre + " es más reciente que la recepción " + dtoc( ( tmpTikT )->dFecCre ) + " " + ( tmpTikT )->cTimCre
      Return .F.
   end

Return ( .T. )



Static Function GenTikCli( nDevice, cCaption, cCodDoc, cPrinter )

   local oDevice

   if ( D():Tikets( nView ) )->( ordKeyCount() ) == 0
      return nil
   end

   If( nDevice == nil, nDevice := 1, ) ;
   If( cCaption == nil, cCaption := "Imprimiendo tickets a clientes", ) ;
   If( cCodDoc == nil, cCodDoc := cFormatoTicketEnCaja( Application():CodigoCaja(), dbfCajT ), ) ;
   If( cPrinter == nil, cPrinter := cWindowsPrinterEnCaja( Application():CodigoCaja(), dbfCajT ), ) ;

   if Empty( cPrinter )
      cPrinter          := ImpresoraDefectoUsuario()
   end

   if empty( cCodDoc )
      cCodDoc           := cFormatoTicketEnCaja( Application():CodigoCaja(), dbfCajT )
   end

   if !lExisteDocumento( cCodDoc, dbfDoc )
      return nil
   end





   PrintReportTikCli( nDevice, 1, cPrinter )





   cCortePapelEnCaja( Application():CodigoCaja(), dbfCajT, dbfCajL )

Return .F.



Static Function nGenTikCli( nDevice, cCaption, cCodDoc, cPrinter )

   local nImpYet     := 0

   While nImpYet < nCopTik

      if nImpYet < 1 .OR. ApoloMsgNoYes( "¿Desea imprimir el tiket Nº" + Str( nImpYet + 1, 2 ) + "?", "Elija una opción" )

         GenTikCli( nDevice, cCaption, cCodDoc, cPrinter )

      end

      ++nImpYet

   end

return nil



Static Function lGenTikCli( oBrw, oBtn, nDevice )

   local bAction

   If( nDevice == nil, nDevice := 1, ) ;

   if empty( oBtn )
      return nil
   end

   IF !( D():Documentos( nView ) )->( dbSeek( "TK" ) )







      oWndBrw:NewAt( "GC_DOCUMENT_WHITE_",,, {||( msgStop( "No hay documentos predefinidos" ) )}, "No hay documentos",,,, 4, oBtn, .F. )

   ELSE

      WHILE ( D():Documentos( nView ) )->CTIPO == "TK" .AND. !( D():Documentos( nView ) )->( eof() )

         bAction  := bGenTikCli( nDevice, "Imprimiendo ticket de cliente", ( D():Documentos( nView ) )->Codigo )

         oWndBrw:NewAt( "gc_document_white_", , , bAction, Rtrim( ( D():Documentos( nView ) )->cDescrip ) , , , , , oBtn )

         ( D():Documentos( nView ) )->( dbSkip() )

      end

   end

   SysRefresh()

return nil



static function bGenTikCli( nDevice, cTitle, cCodDoc )

   local nDev  := by( nDevice )
   local cTit  := by( cTitle  )
   local cCod  := by( cCodDoc )
   local bGen  := {|| GenTikCli( nDevice, cTit, cCod ) }

return ( bGen )



Static Function DataReport( oFr )





   oFr:ClearDataSets()

   oFr:SetWorkArea(     "Tickets", ( D():tikets( nView ) )->( Select() ) )
   oFr:SetFieldAliases( "Tickets", cItemsToReport( aItmTik() ) )

   oFr:SetWorkArea(     "Lineas de tickets", ( dbfTikL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de tickets", cItemsToReport( aColTik() ) )

   oFr:SetWorkArea(     "Lineas de comandas", ( dbfTikL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de comandas", cItemsToReport( aColTik() ) )

   oFr:SetWorkArea(     "Lineas de albaranes", ( dbfAlbCliL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de albaranes", cItemsToReport( aColAlbCli() ) )

   oFr:SetWorkArea(     "Lineas de facturas", ( dbfFacCliL )->( Select() ) )
   oFr:SetFieldAliases( "Lineas de facturas", cItemsToReport( aColFacCli() ) )

   oFr:SetWorkArea(     "Pagos de tickets", ( dbfTikP )->( Select() ) )
   oFr:SetFieldAliases( "Pagos de tickets", cItemsToReport( aPgoTik() ) )

   oFr:SetWorkArea(     "Empresa", ( dbfEmp )->( Select() ) )
   oFr:SetFieldAliases( "Empresa", cItemsToReport( aItmEmp() ) )

   oFr:SetWorkArea(     "Clientes", ( dbfClient )->( Select() ) )
   oFr:SetFieldAliases( "Clientes", cItemsToReport( aItmCli() ) )

   oFr:SetWorkArea(     "Obras", ( dbfObrasT )->( Select() ) )
   oFr:SetFieldAliases( "Obras",  cItemsToReport( aItmObr() ) )

   oFr:SetWorkArea(     "Almacenes", ( dbfAlm )->( Select() ) )
   oFr:SetFieldAliases( "Almacenes", cItemsToReport( aItmAlm() ) )

   oFr:SetWorkArea(     "Rutas", ( dbfRuta )->( Select() ) )
   oFr:SetFieldAliases( "Rutas", cItemsToReport( aItmRut() ) )

   oFr:SetWorkArea(     "Agentes", ( dbfAgent )->( Select() ) )
   oFr:SetFieldAliases( "Agentes", cItemsToReport( aItmAge() ) )

   oFr:SetWorkArea(     "Formas de pago", ( dbfFpago )->( Select() ) )
   oFr:SetFieldAliases( "Formas de pago", cItemsToReport( aItmFPago() ) )

   oFr:SetWorkArea(     "Artículos", ( dbfArticulo )->( Select() ) )
   oFr:SetFieldAliases( "Artículos", cItemsToReport( aItmArt() ) )

   oFr:SetWorkArea(     "Propiedades", ( dbfTblPro )->( Select() ) )
   oFr:SetFieldAliases( "Propiedades", cItemsToReport( aItmPro() ) )

   oFr:SetWorkArea(     "Familias", ( dbfFamilia )->( Select() ) )
   oFr:SetFieldAliases( "Familias", cItemsToReport( aItmFam() ) )

   oFr:SetWorkArea(     "Orden comanda", oTComandas:oDbf:nArea )
   oFr:SetFieldAliases( "Orden comanda", cObjectsToReport( oTComandas:oDbf ) )

   oFr:SetWorkArea(     "Unidades de medición",  oUndMedicion:Select() )
   oFr:SetFieldAliases( "Unidades de medición",  cObjectsToReport( oUndMedicion:oDbf ) )

   oFr:SetWorkArea(     "Tipos de artículos",  oTipArt:Select() )
   oFr:SetFieldAliases( "Tipos de artículos",  cObjectsToReport( oTipArt:oDbf ) )

   oFr:SetWorkArea(     "Fabricantes",  oFabricante:Select() )
   oFr:SetFieldAliases( "Fabricantes",  cObjectsToReport( oFabricante:oDbf ) )

   oFr:SetWorkArea(     "Temporadas", ( dbfTemporada )->( Select() ) )
   oFr:SetFieldAliases( "Temporadas", cItemsToReport( aItmTemporada() ) )

   oFr:SetWorkArea(     "Impuestos especiales",  oNewImp:Select() )
   oFr:SetFieldAliases( "Impuestos especiales",  cObjectsToReport( oNewImp:oDbf ) )

   oFr:SetWorkArea(     "Pagos de facturas", ( dbfFacCliP )->( Select() ) )
   oFr:SetFieldAliases( "Pagos de facturas", cItemsToReport( aItmRecCli() ) )

   oFr:SetWorkArea(     "SalaVenta",  oRestaurante:Select() )
   oFr:SetFieldAliases( "SalaVenta",  cObjectsToReport( oRestaurante:oDbf ) )

Return nil



Static Function BuildRelationReport( oFr )

   oFr:SetWorkArea(     "Tickets", ( D():tikets( nView ) )->( Select() ), .F., { 1, 1, 0 } )

   oFr:SetMasterDetail( "Tickets", "Lineas de tickets",              {|| ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik } )
   oFr:SetMasterDetail( "Tickets", "Lineas de comandas",             {|| ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik } )
   oFr:SetMasterDetail( "Tickets", "Lineas de albaranes",            {|| ( D():tikets( nView ) )->cNumDoc } )
   oFr:SetMasterDetail( "Tickets", "Lineas de facturas",             {|| ( D():tikets( nView ) )->cNumDoc } )
   oFr:SetMasterDetail( "Tickets", "Pagos de tickets",               {|| ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik } )
   oFr:SetMasterDetail( "Tickets", "Empresa",                        {|| cCodigoEmpresaEnUso() } )
   oFr:SetMasterDetail( "Tickets", "Clientes",                       {|| ( D():tikets( nView ) )->cCliTik } )
   oFr:SetMasterDetail( "Tickets", "Obras",                          {|| ( D():tikets( nView ) )->cCliTik + ( D():tikets( nView ) )->cCodObr } )
   oFr:SetMasterDetail( "Tickets", "Almacen",                        {|| ( D():tikets( nView ) )->cAlmTik } )
   oFr:SetMasterDetail( "Tickets", "Rutas",                          {|| ( D():tikets( nView ) )->cCodRut } )
   oFr:SetMasterDetail( "Tickets", "Agentes",                        {|| ( D():tikets( nView ) )->cCodAge } )
   oFr:SetMasterDetail( "Tickets", "Usuarios",                       {|| ( D():tikets( nView ) )->cCcjTik } )
   oFr:SetMasterDetail( "Tickets", "SalaVenta",                      {|| ( D():tikets( nView ) )->cCodSala } )
   oFr:SetMasterDetail( "Tickets", "Pagos de facturas",              {|| ( D():tikets( nView ) )->cNumDoc } )

   oFr:SetMasterDetail( "Lineas de tickets", "Artículos",            {|| ( dbfTikL )->cCbaTil } )
   oFr:SetMasterDetail( "Lineas de tickets", "Familia",              {|| ( dbfTikL )->cFamTil } )
   oFr:SetMasterDetail( "Lineas de tickets", "Orden comanda",        {|| ( dbfTikL )->cCodTImp } )
   oFr:SetMasterDetail( "Lineas de tickets", "Unidades de medición", {|| ( dbfTikL )->cUnidad } )
   oFr:SetMasterDetail( "Lineas de tickets", "Tipos de artículos",   {|| RetFld( ( dbfTikL )->cCbaTil, dbfArticulo, "cCodTip" ) } )
   oFr:SetMasterDetail( "Lineas de tickets", "Fabricantes",          {|| RetFld( ( dbfTikL )->cCbaTil, dbfArticulo, "cCodFab" ) } )
   oFr:SetMasterDetail( "Lineas de tickets", "Temporadas",           {|| RetFld( ( dbfTikL )->cCbaTil, dbfArticulo, "cCodTemp" ) } )
   oFr:SetMasterDetail( "Lineas de tickets", "Propiedades",          {|| ( dbfTikL )->cCodPr1 + ( dbfTikL )->cValPr1 } )

   oFr:SetMasterDetail( "Pagos de tickets",  "Formas de pago",       {|| ( dbfTikP )->cFpgPgo } )
   oFr:SetMasterDetail( "Lineas de tickets", "Impuestos especiales", {|| ( dbfTikL )->cCodImp } )



   oFr:SetResyncPair(   "Tickets", "Lineas de tickets" )
   oFr:SetResyncPair(   "Tickets", "Lineas de comandas" )
   oFr:SetResyncPair(   "Tickets", "Lineas de albaranes" )
   oFr:SetResyncPair(   "Tickets", "Lineas de facturas" )
   oFr:SetResyncPair(   "Tickets", "Empresa" )
   oFr:SetResyncPair(   "Tickets", "Clientes" )
   oFr:SetResyncPair(   "Tickets", "Obras" )
   oFr:SetResyncPair(   "Tickets", "Almacenes" )
   oFr:SetResyncPair(   "Tickets", "Rutas" )
   oFr:SetResyncPair(   "Tickets", "Agentes" )
   oFr:SetResyncPair(   "Tickets", "Formas de pago" )
   oFr:SetResyncPair(   "Tickets", "Usuarios" )
   oFr:SetResyncPair(   "Tickets", "SalaVenta" )
   oFr:SetResyncPair(   "Tickets", "Pagos de facturas" )

   oFr:SetResyncPair(   "Lineas de tickets", "Artículos" )
   oFr:SetResyncPair(   "Lineas de tickets", "Familias" )
   oFr:SetResyncPair(   "Lineas de tickets", "Orden comanda" )
   oFr:SetResyncPair(   "Lineas de tickets", "Unidades de medición" )
   oFr:SetResyncPair(   "Lineas de tickets", "Tipos de artículos" )
   oFr:SetResyncPair(   "Lineas de tickets", "Fabricantes" )
   oFr:SetResyncPair(   "Lineas de tickets", "Temporadas" )
   oFr:SetResyncPair(   "Lineas de tickets", "Propiedades" )

   oFr:SetResyncPair(   "Pagos de tickets", "Formas de pago" )
   oFr:SetResyncPair(   "Lineas de tickets", "Impuestos especiales" )

Return nil



Static Function ClearRelationReport( oFr )

   oFr:ClearMasterDetail( "Lineas de tickets" )
   oFr:ClearMasterDetail( "Lineas de comandas" )
   oFr:ClearMasterDetail( "Lineas de albaranes" )
   oFr:ClearMasterDetail( "Lineas de facturas" )
   oFr:ClearMasterDetail( "Pagos de tickets" )
   oFr:ClearMasterDetail( "Empresa" )
   oFr:ClearMasterDetail( "Clientes" )
   oFr:ClearMasterDetail( "Obras" )
   oFr:ClearMasterDetail( "Almacen" )
   oFr:ClearMasterDetail( "Rutas" )
   oFr:ClearMasterDetail( "Agentes" )
   oFr:ClearMasterDetail( "Usuarios" )
   oFr:ClearMasterDetail( "SalaVenta" )
   oFr:ClearMasterDetail( "Pagos de facturas" )

   oFr:ClearMasterDetail( "Artículos" )
   oFr:ClearMasterDetail( "Familia" )
   oFr:ClearMasterDetail( "Orden comanda" )
   oFr:ClearMasterDetail( "Unidades de medición" )
   oFr:ClearMasterDetail( "Tipos de artículos" )
   oFr:ClearMasterDetail( "Fabricantes" )
   oFr:ClearMasterDetail( "Temporadas" )

   oFr:ClearMasterDetail( "Formas de pago" )
   oFr:ClearMasterDetail( "Impuestos especiales" )




   oFr:ClearResyncPair(   "Tickets", "Lineas de tickets" )
   oFr:ClearResyncPair(   "Tickets", "Lineas de comandas" )
   oFr:ClearResyncPair(   "Tickets", "Lineas de albaranes" )
   oFr:ClearResyncPair(   "Tickets", "Lineas de facturas" )
   oFr:ClearResyncPair(   "Tickets", "Empresa" )
   oFr:ClearResyncPair(   "Tickets", "Clientes" )
   oFr:ClearResyncPair(   "Tickets", "Obras" )
   oFr:ClearResyncPair(   "Tickets", "Almacenes" )
   oFr:ClearResyncPair(   "Tickets", "Rutas" )
   oFr:ClearResyncPair(   "Tickets", "Agentes" )
   oFr:ClearResyncPair(   "Tickets", "Formas de pago" )
   oFr:ClearResyncPair(   "Tickets", "Usuarios" )
   oFr:ClearResyncPair(   "Tickets", "SalaVenta" )
   oFr:ClearResyncPair(   "Tickets", "Pagos de facturas" )

   oFr:ClearResyncPair(   "Lineas de tickets", "Artículos" )
   oFr:ClearResyncPair(   "Lineas de tickets", "Familias" )
   oFr:ClearResyncPair(   "Lineas de tickets", "Orden comanda" )
   oFr:ClearResyncPair(   "Lineas de tickets", "Unidades de medición" )
   oFr:ClearResyncPair(   "Lineas de tickets", "Tipos de artículos" )
   oFr:ClearResyncPair(   "Lineas de tickets", "Fabricantes" )
   oFr:ClearResyncPair(   "Lineas de tickets", "Temporadas" )

   oFr:ClearResyncPair(   "Pagos de tickets", "Formas de pago" )
   oFr:ClearResyncPair(   "Lineas de tickets", "Impuestos especiales" )

Return nil



Static Function VariableReport( oFr )





   oFr:AddVariable(     "Tickets",             "Total ticket",                            "GetHbVar('nTotTik')" )
   oFr:AddVariable(     "Tickets",             "Total bruto",                             "GetHbVar('nTotBrt')" )
   oFr:AddVariable(     "Tickets",             "Total neto",                              "GetHbVar('nTotNet')" )
   oFr:AddVariable(     "Tickets",             "Total " + cImp(),                         "GetHbVar('nTotIva')" )
   oFr:AddVariable(     "Tickets",             "Total IVM",                               "GetHbVar('nTotIvm')" )
   oFr:AddVariable(     "Tickets",             "Total albarán",                           "GetHbVar('nTotAlb')" )
   oFr:AddVariable(     "Tickets",             "Total factura",                           "GetHbVar('nTotFac')" )
   oFr:AddVariable(     "Tickets",             "Precio por pax.",                         "GetHbVar('nTotPax')" )
   oFr:AddVariable(     "Tickets",             "Total descuento general",                 "GetHbVar('nTotDtoEsp')" )
   oFr:AddVariable(     "Tickets",             "Total descuento pronto pago",             "GetHbVar('nTotDpp')" )
   oFr:AddVariable(     "Tickets",             "Cuenta por defecto del cliente",          "GetHbVar('cCtaCli')" )

   oFr:AddVariable(     "Tickets",             "Bruto primer tipo de " + cImp(),          "GetHbArrayVar('aBrtTik',1)" )
   oFr:AddVariable(     "Tickets",             "Bruto segundo tipo de " + cImp(),         "GetHbArrayVar('aBrtTik',2)" )
   oFr:AddVariable(     "Tickets",             "Bruto tercer tipo de " + cImp(),          "GetHbArrayVar('aBrtTik',3)" )
   oFr:AddVariable(     "Tickets",             "Base primer tipo de " + cImp(),           "GetHbArrayVar('aBasTik',1)" )
   oFr:AddVariable(     "Tickets",             "Base segundo tipo de " + cImp(),          "GetHbArrayVar('aBasTik',2)" )
   oFr:AddVariable(     "Tickets",             "Base tercer tipo de " + cImp(),           "GetHbArrayVar('aBasTik',3)" )
   oFr:AddVariable(     "Tickets",             "Porcentaje primer tipo " + cImp(),        "GetHbArrayVar('aIvaTik',1)" )
   oFr:AddVariable(     "Tickets",             "Porcentaje segundo tipo " + cImp(),       "GetHbArrayVar('aIvaTik',2)" )
   oFr:AddVariable(     "Tickets",             "Porcentaje tercer tipo " + cImp(),        "GetHbArrayVar('aIvaTik',3)" )
   oFr:AddVariable(     "Tickets",             "Importe primer tipo " + cImp(),           "GetHbArrayVar('aImpTik',1)" )
   oFr:AddVariable(     "Tickets",             "Importe segundo tipo " + cImp(),          "GetHbArrayVar('aImpTik',2)" )
   oFr:AddVariable(     "Tickets",             "Importe tercer tipo " + cImp(),           "GetHbArrayVar('aImpTik',3)" )
   oFr:AddVariable(     "Tickets",             "Importe primer tipo IVMH",                "GetHbArrayVar('aIvmTik',1)" )
   oFr:AddVariable(     "Tickets",             "Importe segundo tipo IVMH",               "GetHbArrayVar('aIvmTik',2)" )
   oFr:AddVariable(     "Tickets",             "Importe tercer tipo IVMH",                "GetHbArrayVar('aIvmTik',3)" )

   oFr:AddVariable(     "Tickets",             "Total vale en compra",                    "CallHbFunc('nImpValTik')" )
   oFr:AddVariable(     "Tickets",             "Total vales acumulados cliente",          "CallHbFunc('nImpValCli')" )
   oFr:AddVariable(     "Tickets",             "Total entregas a cuenta",                 "CallHbFunc('nTotalEntregado')" )
   oFr:AddVariable(     "Tickets",             "Total vales liquidados en compra",        "CallHbFunc('nTotValTikInfo')" )

   oFr:AddVariable(     "Tickets",             "Ubicación del ticket",                    "CallHbFunc( 'cTxtUbicacion' )" )

   oFr:AddVariable(     "Tickets",             "Nombre usuario",                          "CallHbFunc( 'nombreUsuarioTicket' )" )

   oFr:AddVariable(     "Lineas de tickets",   "Detalle del artículo en ticket",                "CallHbFunc('cTextoLineaTicket')" )
   oFr:AddVariable(     "Lineas de tickets",   "Detalle del ticket en distinto idioma",         "CallHbFunc('cTextoLineaTicketLeng')" )
   oFr:AddVariable(     "Lineas de tickets",   "Total unidades artículo",                       "CallHbFunc('nTotNTpv')" )
   oFr:AddVariable(     "Lineas de tickets",   "Precio unitario del artículo",                  "CallHbFunc('nTotUTpv')" )
   oFr:AddVariable(     "Lineas de tickets",   "Precio unitario con descuentos",                "CallHbFunc('nNetLTpv')" )
   oFr:AddVariable(     "Lineas de tickets",   "Importe descuento línea del factura",           "CallHbFunc('nDtoLTpv')" )
   oFr:AddVariable(     "Lineas de tickets",   "Total " + cImp() + " línea de factura",         "CallHbFunc('nIvaLTpv')" )
   oFr:AddVariable(     "Lineas de tickets",   "Total IVMH línea de factura",                   "CallHbFunc('nIvmLTpv')" )
   oFr:AddVariable(     "Lineas de tickets",   "Total línea de factura",                        "CallHbFunc('nTotLTpv')" )

   oFr:AddVariable(     "Lineas de albaranes", "Detalle del artículo del albarán",              "CallHbFunc('cTpvDesAlbCli')"  )
   oFr:AddVariable(     "Lineas de albaranes", "Detalle del albarán en distinto idioma",        "CallHbFunc('cTpvDesAlbCliLeng')"  )
   oFr:AddVariable(     "Lineas de albaranes", "Total unidades artículo del albarán",           "CallHbFunc('nTpvTotNAlbCli')" )
   oFr:AddVariable(     "Lineas de albaranes", "Precio unitario del artículo del albarán",      "CallHbFunc('nTpvTotUAlbCli')" )
   oFr:AddVariable(     "Lineas de albaranes", "Total línea de albarán",                        "CallHbFunc('nTpvTotLAlbCli')" )

   oFr:AddVariable(     "Lineas de facturas",  "Detalle del artículo de la factura",            "CallHbFunc('cTpvDesFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",  "Detalle de la factura en distinto idioma",      "CallHbFunc('cTpvDesFacCliLeng')" )
   oFr:AddVariable(     "Lineas de facturas",  "Total unidades artículo de la factura",         "CallHbFunc('nTpvTotNFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",  "Precio unitario del artículo de la factura",    "CallHbFunc('nTpvTotUFacCli')" )
   oFr:AddVariable(     "Lineas de facturas",  "Total línea de factura.",                       "CallHbFunc('nTpvTotLFacCli')" )

Return nil



Function cTxtUbicacion( cTikT )

   local cUbicacion  := ""

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;

   cUbicacion        := Eval( hGet( hTextoUbicacion, ( cTikT )->nUbiTik ) )

RETURN ( cUbicacion )



Function cTextoLineaTicket( cTikL )

   local cTexto   := ""

   If( cTikL == nil, cTikL := dbfTikL, ) ;

   cTexto         := Rtrim( ( dbfTikL )->cNomTil )

   if !empty( ( dbfTikL )->cNcmTil )
      cTexto      += " con " + Chr(13)+Chr(10) + ( dbfTikL )->cNcmTil
   end

   if !empty( ( dbfTikL )->lKitChl )
      cTexto      := Space( 3 ) + "<" + cTexto + ">"
   end

Return ( AllTrim( cTexto ) )



Function cTextoLineaTicketLeng( cTikL, cArtLeng )

   local cTexto      := ""
   local nOrdAnt

   If( cTikL == nil, cTikL := dbfTikL, ) ;
   If( cArtLeng == nil, cArtLeng := D():ArticuloLenguaje( nView ), ) ;

   nOrdAnt           := ( cArtLeng )->( ordsetfocus( "CARTLEN" ) )

   if !( cArtLeng )->( dbSeek( ( dbfTikL )->cCbaTil + getLenguajeSegundario() ) )
      cTexto         := Rtrim( ( dbfTikL )->cNomTil )
   else
      if !empty( ( cArtLeng )->cDesArt )
        cTexto       := AllTrim( ( cArtLeng )->cDesArt )
      else
        cTexto       := AllTrim( ( cArtLeng )->cDesTik )
      end
   end

   if !empty( ( dbfTikL )->cNcmTil )
      cTexto         += " con " + Chr(13)+Chr(10) + ( dbfTikL )->cNcmTil
   end

   if !empty( ( dbfTikL )->lKitChl )
      cTexto         := Space( 3 ) + "<" + cTexto + ">"
   end

Return( cTexto )



Function DesignReportTikCli( oFr, dbfDoc )

   local lCloseFiles := !lOpenFiles

   if lOpenFiles .OR. OpenFiles()





      DataReport( oFr )





      if !empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")

      else

         oFr:SetProperty(     "Report",            "ScriptLanguage", "PascalScript" )







         oFr:SetProperty(     "Report.ScriptText", "Text", +  "procedure DetalleOnMasterDetail(Sender: TfrxComponent);"   + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "CallHbFunc('nTotalizer');"                                 + Chr(13) + Chr(10) +  "end;"                                                      + Chr(13) + Chr(10) +  "begin"                                                     + Chr(13) + Chr(10) +  "end." )

         oFr:AddPage(         "MainPage" )

         oFr:AddBand(         "CabeceraDocumento", "MainPage", 2 )
         oFr:SetProperty(     "CabeceraDocumento", "Top", 0 )
         oFr:SetProperty(     "CabeceraDocumento", "Height", 200 )

         oFr:AddBand(         "MasterData",  "MainPage", 6 )
         oFr:SetProperty(     "MasterData",  "Top", 200 )
         oFr:SetProperty(     "MasterData",  "Height", 0 )
         oFr:SetProperty(     "MasterData",  "StartNewPage", .T. )
         oFr:SetObjProperty(  "MasterData",  "DataSet", "Tickets" )

         oFr:AddBand(         "DetalleColumnas",   "MainPage", 7  )
         oFr:SetProperty(     "DetalleColumnas",   "Top", 230 )
         oFr:SetProperty(     "DetalleColumnas",   "Height", 28 )
         oFr:SetObjProperty(  "DetalleColumnas",   "DataSet", "Lineas de Tickets" )
         oFr:SetProperty(     "DetalleColumnas",   "OnMasterDetail", "DetalleOnMasterDetail" )

         oFr:AddBand(         "PieDocumento",      "MainPage", 3 )
         oFr:SetProperty(     "PieDocumento",      "Top", 930 )
         oFr:SetProperty(     "PieDocumento",      "Height", 110 )

      end





      VariableReport( oFr )

      BuildRelationReport( oFr )





      oFr:DesignReport()





      ClearRelationReport( oFr )

      oFr:DestroyFr()





      if lCloseFiles
         CloseFiles()
      end

   else

      return .F.

   end

Return .T.



Function PrintReportTikCli( nDevice, nCopies, cPrinter )

   local oBlock

   If( nDevice == nil, nDevice := 2, ) ;
   If( nCopies == nil, nCopies := 1, ) ;

   if Empty( cPrinter )
      cPrinter          := ImpresoraDefectoUsuario()
   end

   SysRefresh()

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE





      oFr                  := frReportManager():New()
      oFr:LoadLangRes(     "Spanish.Xml" )

      oFr:SetEventHandler( "Designer", "OnSaveReport", {|| oFr:SaveToBlob( ( dbfDoc )->( Select() ), "mReport" ) } )





      DataReport( oFr )





      BuildRelationReport( oFr )





      if !empty( ( dbfDoc )->mReport )

         oFr:LoadFromBlob( ( dbfDoc )->( Select() ), "mReport")





         VariableReport( oFr )





         oFr:PrepareReport()





         do case
            case nDevice == 2

               oFr:ShowPreparedReport()

            case nDevice == 1

               oFr:PrintOptions:SetPrinter( cPrinter )
               oFr:PrintOptions:SetCopies( nCopies )
               oFr:PrintOptions:SetShowDialog( .F. )
               oFr:Print()

            case nDevice == 3

               oFr:SetProperty(  "PDFExport", "EmbeddedFonts",    .T. )
               oFr:SetProperty(  "PDFExport", "PrintOptimized",   .T. )
               oFr:SetProperty(  "PDFExport", "Outline",          .T. )
               oFr:DoExport(     "PDFExport" )

         end

      end





      ClearRelationReport( oFr )

   end

   ErrorBlock( oBlock )





   if !empty( oFr )
      oFr:DestroyFr()
   end

   oFr := nil

RETURN .T.








function cTpvDesAlbCli()
return cDesAlbCli( dbfAlbCliL )



function cTpvDesAlbCliLeng()
return cDesAlbCliLeng( dbfAlbCliL, , D():ArticuloLenguaje( nView ) )



function nTpvTotNAlbCli()
return nTotNAlbCli( dbfAlbCliL )



function nTpvTotUAlbCli()
return nTotUAlbCli( dbfAlbCliL )



function nTpvTotLAlbCli()
return nTotLAlbCli( dbfAlbCliL )



function cTpvDesFacCli()
return cDesFacCli( dbfFacCliL )



function cTpvDesFacCliLeng()
return cDesFacCliLeng( dbfFacCliL, , D():ArticuloLenguaje( nView ) )



function nTpvTotNFacCli()
return nTotNFacCli( dbfFacCliL )



function nTpvTotUFacCli()
return nTotUFacCli( dbfFacCliL )



function nTpvTotLFacCli()
return nTotLFacCli( dbfFacCliL )



function cTpvDesCmd( cTikL )

   local cReturn     := ""

   If( cTikL == nil, cTikL := dbfTikL, ) ;

   if !empty( ( cTikL )->cNomCmd )
      cReturn        := Rtrim( ( cTikL )->cNomCmd )
   else
      cReturn        := Rtrim( ( cTikL )->cNomTil )
   end

RETURN ( cReturn )



Static Function nNumeroFamilias()

   local nRegistrosMostrar := ( dbfFamilia )->( ordKeyCount() )
   nRegistrosMostrar       -= ( dbfFamilia )->( ordKeyNo() )
   nRegistrosMostrar++



   if len( aRecFam ) > 1
      nRegistrosMostrar++
   end



   if nRegistrosMostrar > nNumBtnFam
      nRegistrosMostrar    := nNumBtnFam - 1
   end

Return ( nRegistrosMostrar )



Static Function lMostrarFamilias()

   local lMostrarFamilias  := .F.
   local nRegistrosMostrar := 0

   if ( dbfFamilia )->( ordKeyNo() ) <> 0
      lMostrarFamilias     := ( ( dbfFamilia )->( ordKeyCount() ) - ( dbfFamilia )->( ordKeyNo() ) > 0 )
   end

Return ( lMostrarFamilias )



Static Function RenombrarUbicacion( aTmp, aGet )

   local cNombreUbicacion  := VirtualKey( .F., aTmp[ 51 ], "Asignar alias" )

   if !empty( cNombreUbicacion )

      aTmp[ 51 ]   := cNombreUbicacion

      cTitleDialog( aTmp )

   end

Return .T.



Static Function EdtEnt( aTmp, aGet, dbfTmpE, oBrw, bWhen, bValid, nMode, aTmpTik )

   local oDlg
   local oBmpDiv
   local cPorDiv

   If( aTmpTik == nil, aTmpTik := dbScatter( D():tikets( nView ) ), ) ;

   do case
      case nMode == 1

         aTmp[ ( dbfTmpE )->( FieldPos( "cTurRec" ) ) ]   := cCurSesion()
         aTmp[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ]   := Application():CodigoCaja()
         aTmp[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ]   := aTmpTik[ 11 ]
         aTmp[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ]   := aTmpTik[ 32 ]
         aTmp[ ( dbfTmpE )->( FieldPos( "cDivPgo" ) ) ]   := aTmpTik[ 24 ]
         aTmp[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ]   := aTmpTik[ 21 ]

      case nMode == 2

         if aTmp[ ( dbfTmpE )->( FieldPos( "lCloPgo" ) ) ] .AND. !oUser():lAdministrador()
            msgStop( "Solo pueden modificar las entregas cerradas los administradores." )
            return .F.
         end

   end

   cPorDiv           := cPorDiv(aTmp[ ( dbfTmpE )->( FieldPos( "cDivPgo" ) ) ], dbfDiv )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + "entrega a cuenta", "ENTREGAS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      aGet[ ( dbfTmpE )->( FieldPos( "nImporte" ) ) ] := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "nImporte" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "nImporte" ) ) ]:= u ) }, oDlg,, ( cPorDiv ),,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )









      aGet[ ( dbfTmpE )->( FieldPos( "cDivPgo" ) ) ] := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "cDivPgo" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "cDivPgo" ) ) ]:= u ) }, oDlg,, "@!", {||    ( cDivOut( aGet[ ( dbfTmpE )->( FieldPos( "cDivPgo" ) ) ], oBmpDiv, aGet[ ( dbfTmpE )->( FieldPos( "nVdvPgo" ) ) ], nil, nil, @cPorDiv, nil, nil, nil, nil, dbfDiv, oBandera ) )},,,,,, .F., {||     ( .F. )},, .F., .F.,,,,, {|Self|BrwDiv( aGet[ ( dbfTmpE )->( FieldPos( "cDivPgo" ) ) ], oBmpDiv, aGet[ ( dbfTmpE )->( FieldPos( "nVdvPgo" ) ) ], dbfDiv, oBandera )}, nil, "LUPA",, )




      oBmpDiv := TBitmap():ReDefine( 151, "BAN_EURO",, oDlg,,, .F., .F.,,, .F.,,, .F. )










      aGet[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ] := TGetHlp():ReDefine( 180, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ]:= u ) }, oDlg,, "@!", {||    ( cFPago( aGet[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ], dbfFPago, aGet[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ]:oHelpText ) )}, "N/W*",,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwFPago( aGet[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ], aGet[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ]:oHelpText ) )}, nil, "LUPA",, 181 )







      aGet[ ( dbfTmpE )->( FieldPos( "dEntrega" ) ) ] := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "dEntrega" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "dEntrega" ) ) ]:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .T.,,,,, {|Self|aGet[ ( dbfTmpE )->( FieldPos( "dEntrega" ) ) ]:cText( Calendario( aTmp[ ( dbfTmpE )->( FieldPos( "dEntrega" ) ) ] ) )}, nil, "LUPA",, )








      aGet[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ] := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ]:= u ) }, oDlg,,, {||    ( cClient( aGet[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ], dbfClient, aGet[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ]:oHelpText ) )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwClient( aGet[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ], aGet[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ]:oHelpText ) )}, nil, "LUPA",, 111 )








      aGet[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ] := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ]:= u ) }, oDlg,,, {||    ( cAgentes( aGet[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ], dbfAgent, aGet[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ]:oHelpText ) )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwAgentes( aGet[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ], aGet[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ]:oHelpText ) )}, nil, "LUPA",, 121 )




      aGet[ ( dbfTmpE )->( FieldPos( "cDescrip" ) ) ] := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "cDescrip" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "cDescrip" ) ) ]:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




      aGet[ ( dbfTmpE )->( FieldPos( "cPgdoPor" ) ) ] := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "cPgdoPor" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "cPgdoPor" ) ) ]:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )








      aGet[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ] := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, aTmp[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ], aTmp[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ]:= u ) }, oDlg,,, {||    cCajas( aGet[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ], dbfCajT, aGet[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ]:oHelpText )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( BrwCajas( aGet[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ], aGet[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ]:oHelpText ) )}, nil, "LUPA",, 171 )





      TButton():ReDefine( 1, {||( ValidEdtEnt( aTmp, aGet, oBrw, oDlg, nMode, dbfTmpE ) )}, oDlg,,, .F., {||     ( nMode <> 3 )},,, .F. )





        TButton():ReDefine( 2, {||( oDlg:End() )}, oDlg,,, .F.,,,, .T. )

   if nMode <> 3
      oDlg:AddFastKey( 116, {|| ValidEdtEnt( aTmp, aGet, oBrw, oDlg, nMode, dbfTmpE ) } )
   end

   oDlg:bStart    := {|| StartRec( aGet, aTmp ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oBandera:End()
   oBmpDiv:End()

RETURN ( oDlg:nResult == 1 )



Static Function ValidEdtEnt( aTmp, aGet, oBrw, oDlg, nMode, dbfTmpE )

   if nMode == 1
      aTmp[ ( dbfTmpE )->( FieldPos( "nNumRec" ) ) ]   := ( dbfTmpE )->( RecNo() ) + 1
   end

   WinGather( aTmp, aGet, dbfTmpE, oBrw, nMode )

   oDlg:End( 1 )

Return .T.



static function StartRec( aGet, aTmp )

   aGet[ ( dbfTmpE )->( FieldPos( "nImporte" ) ) ]:SetFocus()

   aGet[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ]:oHelpText:cText( RetFld( aTmp[ ( dbfTmpE )->( FieldPos( "cCodPgo" ) ) ], dbfFPago, "cDesPago" ) )
   aGet[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ]:oHelpText:cText( RetFld( aTmp[ ( dbfTmpE )->( FieldPos( "cCodCli" ) ) ], dbfClient, "Titulo" ) )
   aGet[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ]:oHelpText:cText( RetFld( aTmp[ ( dbfTmpE )->( FieldPos( "cCodCaj" ) ) ], dbfCajT, "cNomCaj" ) )
   aGet[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ]:oHelpText:cText( cNbrAgent( aTmp[ ( dbfTmpE )->( FieldPos( "cCodAge" ) ) ], dbfAgent ) )

return .T.



Static Function CrearDescuento( dbfTmpL, oBrwDet )

   local oDlg
   local nRec
   local oBtnUnaLinea
   local oBtnTodasLineas
   local oGetPorcentaje
   local nGetPorcentaje := 10
   local oFnt           := TFont():New( "Segoe UI", 14, 46, .F., .T. )

   oDlg = TDialog():New(,,,,, "DTO_TCT",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )

      oBtnUnaLinea      := TBtnBmp():ReDefine( 100, "gc_table_selection_row_32",,,,,{|| oBtnUnaLinea:GoDown(), oBtnTodasLineas:GoUp() }, oDlg, .F., , .F. )

      oBtnTodasLineas   := TBtnBmp():ReDefine( 110, "gc_table_selection_all_32",,,,,{|| oBtnUnaLinea:GoUp(), oBtnTodasLineas:GoDown() }, oDlg, .F., , .F. )




      TButton():ReDefine( 200, {||( oGetPorcentaje:cText( 10 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 210, {||( oGetPorcentaje:cText( 20 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 220, {||( oGetPorcentaje:cText( 30 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 230, {||( oGetPorcentaje:cText( 40 ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 240, {||( oGetPorcentaje:cText( 50 ) )}, oDlg,,, .F.,,,, .F. )





      TButtonBmp():ReDefine( 300, {||( oGetPorcentaje++ )}, oDlg,,, .F.,,,, .F., "gc_navigate_plus_32",,, .F. )





      TButtonBmp():ReDefine( 310, {||( oGetPorcentaje-- )}, oDlg,,, .F.,,,, .F., "gc_navigate_minus_32",,, .F. )










      oGetPorcentaje := TGetHlp():ReDefine( 320, { | u | If( PCount()==0, nGetPorcentaje, nGetPorcentaje:= u ) }, oDlg,, "@E 999.99",,,, oFnt,,, .F.,,, .F., .T.,,, {||      0}, {||      100},, nil,,, )
   oDlg:bStart    := {|| oBtnUnaLinea:GoDown() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      if oBtnUnaLinea:lPressed

         ( dbfTmpL )->nDtoLin := nGetPorcentaje

      else

         nRec     := ( dbfTmpL )->( Recno() )

         ( dbfTmpL )->( dbGoTop() )
         while !( dbfTmpL )->( Eof() )
            ( dbfTmpL )->nDtoLin := nGetPorcentaje
            ( dbfTmpL )->( dbSkip() )
         end

         ( dbfTmpL )->( dbGoTo( nRec ) )

      end

   end

   oFnt:end()

   if !empty( oBrwDet )
      oBrwDet:Refresh()
   end

Return ( nil )



Static Function CrearInvitacion( dbfTmpL, oBrwDet )

   local oDlg
   local nRec
   local oBtnUnaLinea
   local oBtnTodasLineas
   local oBtnCancel
   local oImgInv
   local oLstInv

   oDlg = TDialog():New(,,,,, "INV_TCT",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )

      oBtnTodasLineas   := ApoloBtnBmp():ReDefine( 100, "gc_table_selection_all_32",,,,,{|| oBtnUnaLinea:GoUp(), oBtnTodasLineas:GoDown() }, oDlg, .F., , .F. )

      oBtnUnaLinea      := ApoloBtnBmp():ReDefine( 110, "gc_table_selection_row_32",,,,,{|| oBtnUnaLinea:GoDown(), oBtnTodasLineas:GoUp() }, oDlg, .F., , .F. )

      oImgInv           := TImageList():New( 48, 48 )
      oLstInv           := TListView():Redefine( 120, oDlg )
      oLstInv:nOption   := 0
      oLstInv:bClick    := {| nOpt | EndInvitacion( nOpt, oLstInv, oBtnUnaLinea, dbfTmpL, oInvitacion:oDbf:cAlias, oDlg ) }





      oBtnCancel := TButtonBmp():ReDefine( 550, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F., "gc_delete_48",,, .F. )

      oDlg:bStart       := {|| oBtnTodasLineas:GoDown() }



   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,, {|Self|( InitInvitaciones( oDlg, oImgInv, oLstInv ) )}, oDlg:bRClicked,,, )

   if !empty( oBrwDet )
      oBrwDet:Refresh()
   end

Return ( nil )



Static Function EndInvitacion( nOpt, oLstInv, oBtnUnaLinea, dbfTmpL, dbfInv, oDlg )

   local nRec

   if nOpt == 0

      msgStop( "Debe seleccionar una opción válida." )

   else

      if ( dbfInv )->( OrdKeyGoTo( nOpt ) )

         if oBtnUnaLinea:lPressed

            if ( dbfInv )->lPreInv
               ( dbfTmpL )->nPvpTil    := ( dbfInv )->nPreInv
            else
               ( dbfTmpL )->nPvpTil    := 0
            end

            ( dbfTmpL )->nPcmTil       := 0
            ( dbfTmpL )->cCodInv       := ( dbfInv )->cCodInv

         else

            nRec     := ( dbfTmpL )->( Recno() )

            ( dbfTmpL )->( dbGoTop() )
            while !( dbfTmpL )->( Eof() )

               if ( dbfInv )->lPreInv
                  ( dbfTmpL )->nPvpTil := ( dbfInv )->nPreInv
               else
                  ( dbfTmpL )->nPvpTil := 0
               end

               ( dbfTmpL )->nPcmTil    := 0
               ( dbfTmpL )->cCodInv    := ( dbfInv )->cCodInv

               ( dbfTmpL )->( dbSkip() )

            end

            ( dbfTmpL )->( dbGoTo( nRec ) )

         end

      end

      oDlg:End( 1 )

   end

return ( .T. )



Function InitInvitaciones( oDlg, oImgInv, oLstInv )

   local nInvi := 0

   if !empty( oImgInv ) .AND. !empty( oLstInv ) .AND. !empty( oInvitacion )

      oInvitacion:oDbf:GoTop()

      while !oInvitacion:oDbf:Eof()

         oLstInv:SetImageList( oImgInv )

         oImgInv:AddMasked( TBitmap():Define( oInvitacion:cBigResource() ), ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )

         oLstInv:InsertItem( nInvi, Capitalize( oInvitacion:oDbf:cNomInv ) )

         oInvitacion:oDbf:Skip()

         nInvi++

      end

   end

RETURN ( nil )



Static Function GetPesoBalanza( aGet, oBtn )

   local oBal
   local nGetFocus   := GetFocus()

   oBal   := TCommPort():Create( cBalanzaEnCaja( Application():CodigoCaja(), dbfCajT ) )

   if oBal:OpenPort()

      aGet[ 8 ]:cText( oBal:GetPeso( aGet[ 7 ]:VarGet() ) )

      if !empty( nGetFocus )
         SendMessage( nGetFocus, 1024+1024, 0, 0 )
      end

      if !empty( oBtn )
         oBtn:Click()
      end

      oBal:ClosePort()
      oBal:End()

   else

      MsgStop( "El puerto de la balanza no se ha creado correctamente" )

   end

Return nil



Function SynTikCli( cPath )

   local oBlock
   local oError
   local aTotTik
   local aTotAlb
   local aTotFac
   local cTikT
   local hConsolidacion

   If( cPath == nil, cPath := cPatEmp(), ) ;

   oBlock            := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   dbUseArea( .T., ( cDriver() ), ( cPath + "TIKET.DBF" ), ( cCheckArea( "TIKET", @cTikT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPath + "TIKET.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPath + "TIKEL.DBF" ), ( cCheckArea( "TIKEL", @dbfTikL ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPath + "TikeL.Cdx" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPath + "TIKEP.DBF" ), ( cCheckArea( "TIKEP", @dbfTikP ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPath + "TIKEP.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPath + "TIKES.DBF" ), ( cCheckArea( "TIKES", @dbfTikS ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPath + "TIKES.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "FAMILIAS.DBF" ), ( cCheckArea( "FAMILIAS", @dbfFamilia ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "FAMILIAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ARTICULO.DBF" ), ( cCheckArea( "ARTICULO", @dbfArticulo ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ARTICULO.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "AntCliT.DBF" ), ( cCheckArea( "AntCliT", @dbfAntCliT ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "AntCliT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIT.DBF" ), ( cCheckArea( "ALBCLIT", @dbfAlbCliT ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIT.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatEmp() + "ALBCLIL.DBF" ), ( cCheckArea( "ALBCLIL", @dbfAlbCliL ) ), iif( .F. .OR. .T., ! .T., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatEmp() + "ALBCLIL.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "DIVISAS.DBF" ), ( cCheckArea( "DIVISAS", @dbfDiv ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "DIVISAS.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end

   dbUseArea( .T., ( cDriver() ), ( cPatDat() + "TIVA.DBF" ), ( cCheckArea( "TIVA", @dbfIva ) ), iif( .T. .OR. .F., ! .F., NIL ), .F. )
   if !lAIS() ; ordListAdd( ( cPatDat() + "TIVA.CDX" ) ) ; else ; ordSetFocus( 1 ) ; end





   ( cTikT )->( ordsetfocus( 0 ) )
   ( cTikT )->( dbGoTop() )

   while !( cTikT )->( eof() )

      if empty( ( cTikT )->cSufTik )
         ( cTikT )->cSufTik := "00"
      end

      if !empty( ( cTikT )->cNumDoc ) .AND. Len( AllTrim( ( cTikT )->cNumDoc ) ) <> 12
         ( cTikT )->cNumDoc := AllTrim( ( cTikT )->cNumDoc ) + "00"
      end

      if !empty( ( cTikT )->cAlbTik ) .AND. Len( AllTrim( ( cTikT )->cAlbTik ) ) <> 12
         ( cTikT )->cAlbTik := AllTrim( ( cTikT )->cAlbTik ) + "00"
      end

      if !empty( ( cTikT )->cPedTik ) .AND. Len( AllTrim( ( cTikT )->cPedTik ) ) <> 12
         ( cTikT )->cPedTik := AllTrim( ( cTikT )->cPedTik ) + "00"
      end

      if !empty( ( cTikT )->cPreTik ) .AND. Len( AllTrim( ( cTikT )->cPreTik ) ) <> 12
         ( cTikT )->cPreTik := AllTrim( ( cTikT )->cPreTik ) + "00"
      end

      if !empty( ( cTikT )->cTikVal ) .AND. Len( AllTrim( ( cTikT )->cTikVal ) ) <> 13
         ( cTikT )->cTikVal := AllTrim( ( cTikT )->cTikVal ) + "00"
      end

      if empty( ( cTikT )->cNcjTik )
         ( cTikT )->cNcjTik   := "000"
      end

      if empty( ( cTikT )->uuid )
         ( cTikT )->uuid      := win_uuidcreatestring()
      end

      ( cTikT )->( dbSkip() )

      SysRefresh()

   end

   ( cTikT )->( ordsetfocus( 1 ) )





   ( dbfTikP )->( ordsetfocus( 0 ) )
   ( dbfTikP )->( dbGoTop() )

   while !( dbfTikP )->( eof() )

      if empty( ( dbfTikP )->cSufTik )
         ( dbfTikP )->cSufTik := "00"
      end

      if empty( ( dbfTikP )->cCodCaj )
         ( dbfTikP )->cCodCaj := Application():CodigoCaja()
      end

      if empty( ( dbfTikP )->uuid )
         ( dbfTikP )->uuid    := win_uuidcreatestring()
      end

      if Empty( ( dbfTikP )->ParUuid ) .OR. ( ( dbfTikP )->ParUuid <> RetFld( ( dbfTikP )->cSerTik + ( dbfTikP )->cNumTik + ( dbfTikP )->cSufTik, cTikT, "uuid" ) )
         ( dbfTikP )->ParUuid := RetFld( ( dbfTikP )->cSerTik + ( dbfTikP )->cNumTik + ( dbfTikP )->cSufTik, cTikT, "uuid" )
      end

      ( dbfTikP )->( dbSkip() )

      SysRefresh()

   end

   ( cTikT )->( ordsetfocus( 1 ) )





   ( dbfTikL )->( ordsetfocus( 0 ) )
   ( dbfTikL )->( dbGoTop() )

   while !( dbfTikL )->( eof() )

      if empty( ( dbfTikL )->cSufTil )
         ( dbfTikL )->cSufTil := "00"
      end

      if !empty( ( dbfTikL )->cNumDev ) .AND. Len( AllTrim( ( dbfTikL )->cNumDev ) ) <> 13
         ( dbfTikL )->cNumDev := AllTrim( ( dbfTikL )->cNumDev ) + "00"
      end

      if !empty( ( dbfTikL )->cCbaTil ) .AND. empty( ( dbfTikL )->cCodFam )
         ( dbfTikL )->cCodFam := RetFamArt( ( dbfTikL )->cCbaTil, dbfArticulo )
      end

      if !empty( ( dbfTikL )->cCbaTil ) .AND. !empty( ( dbfTikL )->cCodFam )
         ( dbfTikL )->cGrpFam := cGruFam( ( dbfTikL )->cCodFam, dbfFamilia )
      end

      if empty( ( dbfTikL )->cLote ) .AND. !empty( ( dbfTikL )->nLote )
         ( dbfTikL )->cLote   := AllTrim( Str( ( dbfTikL )->nLote ) )
      end

      if empty( ( dbfTikL )->cAlmLin ) .OR. ( dbfTikL )->cAlmLin <> RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "cAlmTik" )
         ( dbfTikL )->cAlmLin := RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "cAlmTik" )
      end

      if ( dbfTikL )->cTipTil <> RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "cTipTik" )
         ( dbfTikL )->cTipTil := RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "cTipTik" )
      end

      if ( dbfTikL )->dFecTik <> RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "dFecTik" )
         ( dbfTikL )->dFecTik := RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "dFecTik" )
      end

      if ( dbfTikL )->tFecTik <> RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "tFecTik" )
         ( dbfTikL )->tFecTik := RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "tFecTik" )
      end

      if empty( ( dbfTikL )->nPosPrint )
         ( dbfTikL )->nPosPrint  := ( dbfTikL )->nNumLin
      end

      if empty( ( dbfTikL )->uuid )
         ( dbfTikL )->uuid       := win_uuidcreatestring()
      end

      if Empty( ( dbfTikL )->ParUuid ) .OR. ( ( dbfTikL )->ParUuid <> RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "uuid" ) )
         ( dbfTikL )->ParUuid := RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, cTikT, "uuid" )
      end

      ( dbfTikL )->( dbSkip() )

      SysRefresh()

   end

   ( dbfTikL )->( ordsetfocus( 1 ) )



   ( dbfTikS )->( ordsetfocus( 0 ) )
   ( dbfTikS )->( dbGoTop() )

   while !( dbfTikS )->( eof() )

      if empty( ( dbfTikS )->cSufTik )
         ( dbfTikS )->cSufTik := "00"
      end

      if ( dbfTikS )->dFecTik <> RetFld( ( dbfTikS )->cSerTik + ( dbfTikS )->cNumTik + ( dbfTikS )->cSufTik, cTikT, "dFecTik" )
         ( dbfTikS )->dFecTik := RetFld( ( dbfTikS )->cSerTik + ( dbfTikS )->cNumTik + ( dbfTikS )->cSufTik, cTikT, "dFecTik" )
      end

      ( dbfTikS )->( dbSkip() )

      SysRefresh()

   end

   ( dbfTikS )->( ordsetfocus( 1 ) )





   ( cTikT )->( dbGoTop() )

   while !( cTikT )->( eof() )

      do case
         case ( cTikT )->cTipTik == "2"

            if dbSeekInOrd( ( cTikT )->cNumDoc, "nNumAlb", dbfAlbCliT )

               aTotAlb  := aTotAlbCli( ( dbfAlbCliT )->cSerAlb + Str( ( dbfAlbCliT )->nNumAlb ) + ( dbfAlbCliT )->cSufAlb, dbfAlbCliT, dbfAlbCliL, dbfIva, dbfDiv, ( dbfAlbCliT )->cDivAlb )

               if ( ( cTikT )->nTotNet <> aTotAlb[1] .OR. ( cTikT )->nTotIva <> aTotAlb[2] .OR. ( cTikT )->nTotTik <> aTotAlb[4] )

                  ( cTikT )->nTotNet := aTotAlb[1]
                  ( cTikT )->nTotIva := aTotAlb[2]
                  ( cTikT )->nTotTik := aTotAlb[4]

               end

            end

         otherwise

            aTotTik     := aTotTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, dbfTikL, dbfDiv, , ( cTikT )->cDivTik )

            if ( cTikT )->nTotNet <> aTotTik[1] .OR. ( cTikT )->nTotIva <> aTotTik[2] .OR. ( cTikT )->nTotTik <> aTotTik[3]

               ( cTikT )->nTotNet    := aTotTik[1]
               ( cTikT )->nTotIva    := aTotTik[2]
               ( cTikT )->nTotTik    := aTotTik[3]

            end

            aTotTik     := nTotCobTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, dbfTikP, dbfDiv )
            aTotTik     += nTotValTik( ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, cTikT, dbfTikL, dbfDiv )

            if ( cTikT )->nCobTik <> aTotTik
               ( cTikT )->nCobTik    := aTotTik
            end

      end

      ( cTikT )->( dbSkip() )

      SysRefresh()

   end

   RECOVER USING oError

      msgStop( "Imposible sincronizar tickets de clientes" + Chr(13)+Chr(10) + ErrorMessage( oError ) )

   end

   ErrorBlock( oBlock )

   if !empty( cTikT ) .AND. ( cTikT )->( Used() )
      ( cTikT )->( dbCloseArea() )
   end

   if !empty( dbfTikL ) .AND. ( dbfTikL )->( Used() )
      ( dbfTikL )->( dbCloseArea() )
   end

   if !empty( dbfTikP ) .AND. ( dbfTikP )->( Used() )
      ( dbfTikP )->( dbCloseArea() )
   end

   if !empty( dbfTikS ) .AND. ( dbfTikS )->( Used() )
      ( dbfTikS )->( dbCloseArea() )
   end

   if !empty( dbfFamilia ) .AND. ( dbfFamilia )->( Used() )
      ( dbfFamilia )->( dbCloseArea() )
   end

   if !empty( dbfArticulo ) .AND. ( dbfArticulo )->( Used() )
      ( dbfArticulo )->( dbCloseArea() )
   end

   if !empty( dbfDiv ) .AND. ( dbfDiv )->( Used() )
      ( dbfDiv )->( dbCloseArea() )
   end

   if !empty( dbfAntCliT ) .AND. ( dbfAntCliT )->( Used() )
      ( dbfAntCliT )->( dbCloseArea() )
   end

   if !empty( dbfIva ) .AND. ( dbfIva )->( Used() )
      ( dbfIva )->( dbCloseArea() )
   end

   if !empty( dbfAlbCliT ) .AND. ( dbfAlbCliT )->( Used() )
      ( dbfAlbCliT )->( dbCloseArea() )
   end

   if !empty( dbfAlbCliL ) .AND. ( dbfAlbCliL )->( Used() )
      ( dbfAlbCliL )->( dbCloseArea() )
   end

return nil



Function lStartAvisoPedidos()

   if !empty( oBtnPedidos )
      lStopAvisoPedidos()
      oTimerBtn               := TTimer():New( 900, {|| lSelectedButton() }, )
      oTimerBtn:Activate()
   end

return .T.



Function lStopAvisoPedidos()

   if !empty( oTimerBtn )
      oTimerBtn:End()
      oTimerBtn               := nil
   endif

return .T.



Function lSelectedButton()

   if !empty( oBtnPedidos )
      oBtnPedidos:lSelected   := !oBtnPedidos:lSelected
      oBtnPedidos:Refresh()
   end

return .T.



Function ProcesaPedidosWeb( aTmp )

   local cNumeroPedido

   if ( dbfTmpL )->( ordKeyCount() ) <> 0
      msgstop( "Existe una venta en curso, concluya la venta antes de continuar." )
      return nil
   end

   cNumeroPedido  := MuestraPedidosWeb( oBtnPedidos )

   if !empty( cNumeroPedido )



      if ( dbfPedCLiT )->( dbSeek( cNumeroPedido ) )

         aTmp[ 11 ]  := ( dbfPedCliT )->cCodCli
         aTmp[ 12 ]  := ( dbfPedCliT )->nTarifa
         aTmp[ 13 ]  := ( dbfPedCliT )->cNomCli
         aTmp[ 14 ]  := ( dbfPedCliT )->cDirCli
         aTmp[ 15 ]  := ( dbfPedCliT )->cPobCli
         aTmp[ 16 ]  := ( dbfPedCliT )->cPrvCli
         aTmp[ 18 ]  := ( dbfPedCliT )->cPosCli
         aTmp[ 19 ]  := ( dbfPedCliT )->cDniCli

      end



      if ( dbfPedCLiL )->( dbSeek( cNumeroPedido ) )

         while ( dbfPedCLiL )->cSerPed + Str( ( dbfPedCLiL )->nNumPed ) + ( dbfPedCLiL )->cSufPed == cNumeroPedido .AND. !( dbfPedCLiL )->( eof() )

            ( dbfTmpL )->( dbAppend() )

            ( dbfTmpL )->cCbaTil    := ( dbfPedCliL )->cRef
            ( dbfTmpL )->cNomTil    := ( dbfPedCliL )->cDetalle
            ( dbfTmpL )->nPvpTil    := ( dbfPedCliL )->nPreDiv
            ( dbfTmpL )->nUntTil    := ( dbfPedCliL )->nCanPed
            ( dbfTmpL )->nUndKit    := ( dbfPedCliL )->nUndKit
            ( dbfTmpL )->nIvaTil    := ( dbfPedCliL )->nIva
            ( dbfTmpL )->cFamTil    := ( dbfPedCliL )->cCodFam
            ( dbfTmpL )->nDtoLin    := ( dbfPedCliL )->nDto
            ( dbfTmpL )->nDtoDiv    := ( dbfPedCliL )->nDtoDiv
            ( dbfTmpL )->cCodPr1    := ( dbfPedCliL )->cCodPr1
            ( dbfTmpL )->cCodPr2    := ( dbfPedCliL )->cCodPr2
            ( dbfTmpL )->cValPr1    := ( dbfPedCliL )->cValPr1
            ( dbfTmpL )->cValPr2    := ( dbfPedCliL )->cValPr2
            ( dbfTmpL )->cAlmLin    := ( dbfPedCliL )->cAlmLin
            ( dbfTmpL )->nValImp    := ( dbfPedCliL )->nValImp
            ( dbfTmpL )->cCodImp    := ( dbfPedCliL )->cCodImp
            ( dbfTmpL )->nNumLin    := ( dbfPedCliL )->nNumLin
            ( dbfTmpL )->nPosPrint  := ( dbfPedCliL )->nPosPrint
            ( dbfTmpL )->lKitArt    := ( dbfPedCliL )->lKitArt
            ( dbfTmpL )->lKitChl    := ( dbfPedCliL )->lKitChl
            ( dbfTmpL )->cCodFam    := ( dbfPedCliL )->cCodFam
            ( dbfTmpL )->cGrpFam    := ( dbfPedCliL )->cGrpFam
            ( dbfTmpL )->nLote      := ( dbfPedCliL )->nLote
            ( dbfTmpL )->dFecCad    := ( dbfPedCliL )->dFecCad
            ( dbfTmpL )->nNumMed    := ( dbfPedCliL )->nNumMed
            ( dbfTmpL )->nMedUno    := ( dbfPedCliL )->nMedUno
            ( dbfTmpL )->nMedDos    := ( dbfPedCliL )->nMedDos
            ( dbfTmpL )->nMedTre    := ( dbfPedCliL )->nMedTre

            ( dbfTmpL )->cImpCom1   := Retfld( ( dbfPedCliL )->cRef, dbfArticulo, "cTipImp1" )
            ( dbfTmpL )->cImpCom2   := Retfld( ( dbfPedCliL )->cRef, dbfArticulo, "cTipImp2" )

            ( dbfPedCLiL )->( dbSkip() )

         end

      end

      oBrwDet:Refresh()

      lRecTotal( aTmp )

   end

Return nil



static function SeleccionarDefecto( cDefCom, dbfComentariosT, dbfComentariosL, oBrwLineasComentarios, oBrwComentarios )

   if !empty( cDefCom )

      if ( dbfComentariosT )->( dbSeek( cDefCom ) )

         oBrwComentarios:Select( 0 )
         oBrwComentarios:Select( 1 )
         ChangeComentarios( dbfComentariosT, dbfComentariosL, oBrwLineasComentarios )

      end

   end

return .T.



static function cTextoOfficeBar( aTmp )

   local uValor

   if !empty( oBtnCliente )

      uValor         := AllTrim( RetFld( aTmp[ 11 ], dbfClient, "Titulo" ) )

      oBtnCliente:cCaption( if( !empty( uValor ), uValor, "..." ) )

   end

   if !empty( oBtnDireccion )

      uValor         := AllTrim( RetFld( aTmp[ 11 ], dbfClient, "Domicilio" ) )

      oBtnDireccion:cCaption( if( !empty( uValor ), uValor, "..." ) )

   end

   if !empty( oBtnTelefono )

      uValor         := AllTrim( RetFld( aTmp[ 11 ], dbfClient, "Telefono" ) ) + Space( 1 ) + AllTrim( RetFld( aTmp[ 11 ], dbfClient, "cMeiInt" ) )

      oBtnTelefono:cCaption( if( !empty( uValor ), uValor, "..." ) )

   end

Return nil



Static Function lSeleccionaCliente( aTmp )

   local cCliente       := BrwCliTactil( nil, nil, nil, .T. )

   aTmp[ 11  ]    := cCliente

   aTmp[ 13  ]    := RetFld( cCliente, dbfClient, "Titulo" )
   aTmp[ 14  ]    := RetFld( cCliente, dbfClient, "Domicilio" )
   aTmp[ 15  ]    := RetFld( cCliente, dbfClient, "Poblacion" )
   aTmp[ 16  ]    := RetFld( cCliente, dbfClient, "Provincia" )
   aTmp[ 18  ]    := RetFld( cCliente, dbfClient, "CodPostal" )
   aTmp[ 19  ]    := RetFld( cCliente, dbfClient, "Nif" )
   aTmp[ 12  ]    := Max( RetFld( cCliente, dbfClient, "nTarifa" ), 1 )

   cTextoOfficeBar( aTmp )

Return .T.



static function lNumeroComensales( aTmp )

   aTmp[ 52 ]     := nVirtualNumKey( "gc_users_family_32", "Número comensales" )

   lRecTotal( aTmp )

Return .T.



Static Function lCambiaTicket( lSubir, aTmp, aGet, nMode )

   local oError
   local oBlock





   if lSubir

      if ( D():tikets( nView ) )->( OrdKeyno() ) == 1
         MsgStop( "Ya estas en el primer registro" )
         return nil
      end

   else

      if ( D():tikets( nView ) )->( OrdKeyno() ) == ( D():tikets( nView ) )->( OrdKeyCount() )
         MsgStop( "Ya estas en el último registro" )
         return nil
      end

   end

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

   nSaveMode            := 2





   if lSubir
      ( D():tikets( nView ) )->( dbSkip( -1 ) )
   else
      ( D():tikets( nView ) )->( dbSkip() )
   end





   aScatter( D():tikets( nView ), aTmp )

   BeginTrans( aTmp, aGet, nMode, .F. )





   cTitleDialog( aTmp )





   SetButtonEdtRec( nSaveMode, aTmp )





   lRecTotal( aTmp )





   cOldCodCli        := ""

   if !empty( aGet[ 11 ] )
      aGet[ 11 ]:SetFocus()
      aGet[ 11 ]:lValid()
   end

   RECOVER USING oError

   msgStop( ErrorMessage( oError ), "Error al cambiar de ticket" )

   end

   ErrorBlock( oBlock )

Return .T.



Static Function lCambiaSerie( aTmp, lSubir, oGrupoSerie )

   if lSubir
      aTmp[ 1 ]        := cUpSerie( aTmp[ 1 ] )
      oGrupoSerie:cPrompt     := "Serie: " + aTmp[ 1 ]
   else
      aTmp[ 1 ]        := cDwSerie( aTmp[ 1 ] )
      oGrupoSerie:cPrompt     := "Serie: " + aTmp[ 1 ]
   end

Return .T.



Function ImprimirTiketPda()

Return nil



Function SetAutoImp()

   local nSecondTime

   if empty( oTimer )

      nSecondTime    := uFieldEmpresa( "nTiempoImp", 0 )

      if nSecondTime <> 0
         oTimer      := TTimer():New( nSecondTime * 1000, {|| ImprimirTiketPda() } )
         oTimer:Activate()
      end

   end

Return nil



Function KillAutoImp()

   if !empty( oTimer )
      oTimer:End()
   end

   oTimer         := nil

Return( nil )



Function StartAutoImp()

   if !empty( oTimer )
      oTimer:Activate()
   end

Return( nil )



Function StopAutoImp()

   if !empty( oTimer )
      oTimer:DeActivate()
   end

Return( nil )



Static Function SumaUnidad( aTmp, oBrwLin )

   ( dbfTmpL )->lImpCom    := .F.

   ( dbfTmpL )->nUntTil++

   lRecTotal( aTmp )

   oBrwLin:Refresh()

Return nil



Static Function RestaUnidad( aTmp, oBrwLin )

   if !( dbfTmpL )->lArtServ

      if ( dbfTmpL )->nUntTil == 1

         if ApoloMsgNoYes( "¿ Desea eliminar el artículo seleccionado ?", "Elija una opción" )
            ( dbfTmpL )->nUntTil--
            ( dbfTmpL )->lAnulado   := .T.
         end
      else
         ( dbfTmpL )->nUntTil--
         ( dbfTmpL )->lAnulado      := .T.
      end






      lRecTotal( aTmp )

   end

   oBrwLin:Refresh()

Return nil






static Function ComprobarFamilia( dbfTmpL, oFntTit, oBrwLin, cNumTik, oTitArt, oTitPrc )

   oBrwLin:GoBottom()

   if RetFld( ( dbfTmpL )->cCodFam, dbfFamilia, "lMostrar" )

      pdaComentario( oFntTit, dbfTmpL, RetFld( ( dbfTmpL )->cCodFam, dbfFamilia, "cComFam" ) )

   end





   if !empty( oTitArt )
      oTitArt:SetText( if( empty( ( dbfTmpL )->cComent ), Upper( Rtrim( ( dbfTmpL )->cNomTil ) ),"[*] " + Upper( Rtrim( ( dbfTmpL )->cNomTil ) ) ) )
   end

   if !empty( oTitPrc )
      oTitPrc:SetText( AllTrim( Trans( nTotLTpv( dbfTmpL, nDouDiv, nDorDiv ), cPorDiv ) ) )
   end

Return nil







Static Function pdaComentario( oFntTit, dbfTmpL, cDefCom )

   local oDlg
   local oBrwComentariosT
   local oBrwComentariosL
   local oGetComentario
   local cGetComentario

   if ( dbfTmpL )->( ordKeyCount() ) == 0
      MsgStop( "No puede añadir un comentario." )
      return .F.
   end

   cGetComentario       := ( dbfTmpL )->cComent

   oDlg = TDialog():New(,,,,, "COMENTARIOSTS",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      oGetComentario := TGetHlp():ReDefine( 300, { | u | If( PCount()==0, cGetComentario, cGetComentario:= u ) }, oDlg,,,,,, oFntTit,,, .F.,,, .F., .F.,,,,,, nil,,, )

      oBrwComentariosT                 := IXBrowse():New( oDlg )

      oBrwComentariosT:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwComentariosT:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwComentariosT:cAlias          := dbfComentariosT
      oBrwComentariosT:cName           := "ComentaT.PDA"

      oBrwComentariosT:lHScroll        := .F.
      oBrwComentariosT:lRecordSelector := .F.

      oBrwComentariosT:nMarqueeStyle   := 5
      oBrwComentariosT:CreateFromResource( 100 )

      oBrwComentariosT:bChange         := {|| ChangeComentarios( , , oBrwComentariosL ) }

      with object ( oBrwComentariosT:AddCol() )
         :cHeader                      := "Tipos de comentarios"
         :bEditValue                   := {|| Upper( ( dbfComentariosT )->cDescri ) }
         :nWidth                       := 220
      end

      oBrwComentariosL                 := IXBrowse():New( oDlg )

      oBrwComentariosL:bClrSel         := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwComentariosL:bClrSelFocus    := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwComentariosL:cAlias          := dbfComentariosL
      oBrwComentariosL:cName           := "ComentaL.PDA"
      oBrwComentariosL:lHScroll        := .F.
      oBrwComentariosL:lRecordSelector := .F.

      oBrwComentariosL:nMarqueeStyle   := 5
      oBrwComentariosL:CreateFromResource( 110 )

      oBrwComentariosL:bLDblClick      := {|| ChangeLineasComentarios( oGetComentario ) }

      with object ( oBrwComentariosL:AddCol() )
         :cHeader                      := "Comentarios"
         :bEditValue                   := {|| Upper( ( dbfComentariosL )->cDescri ) }
         :nWidth                       := 220
      end

      TBtnBmp():ReDefine( 500, "gc_check_16",,,,,{|| EndComentario( oDlg, dbfTmpL, oGetComentario ) }, oDlg, .F., , .F., , , , , , .F.  )
      TBtnBmp():ReDefine( 550, "END16",,,,,{|| oDlg:End( 2 ) }, oDlg, .F., , .F., , , , , , .F.  )

      oDlg:bStart                      := {|| SeleccionarDefecto( cDefCom, dbfComentariosT, dbfComentariosL, oBrwComentariosL, oBrwComentariosT ) }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .F.,,,, oDlg:bRClicked,,, )

Return .T.



Static Function GuardarBtnLibre( oDlg, oGetNombre, oGetUnidades, oGetPrecio, oBrwLin, aTmp, cImpComanda )

   local cNombre     := oGetNombre:VarGet()
   local nUnidades   := oGetUnidades:VarGet()
   local nPrecio     := oGetPrecio:VarGet()

   if !empty( cNombre )

      ( dbfTmpL )->( dbAppend() )

      if !( dbfTmpL )->( NetErr() )
         ( dbfTmpL )->cNomTil := cNombre
         ( dbfTmpL )->nUntTil := nUnidades
         ( dbfTmpL )->nPvpTil := nPrecio
         ( dbfTmpL )->nIvaTil    := nIva( dbfIva, cDefIva() )
         ( dbfTmpL )->cAlmLin    := Application():codigoAlmacen()
         ( dbfTmpL )->cImpCom1   := cImpComanda
      end

      lRecTotal( aTmp )

      oBrwLin:Refresh()

      oDlg:End( 1 )

   else

      msginfo("No puede almacenar un articulo sin nombre")

   end

Return nil











function cPdaZona( cNombre )

   if empty( cZona )
      cZona    := cNombre
   end

Return cZona







Function pdaSesion()

Return Nil







Static Function pdaNewTiket( aTmp, aGet, nMode, lempty, lNota, lCobrar )

Return .T.



static function pdaLiberarCero( cSerie, cNumero, cSufijo )

Return .T.



Static Function PdaNotaTiket( aTmp, aGet, nMode, nNumTik )

Return .T.



Static Function PdaCobrarTiket( aTmp, aGet, nMode )

Return nil



Static Function pdaStarCobro( aButtonsPago )

Return nil



Static Function pdaImpresionTicket( nNumTik )

Return .T.



Static Function pdaCobro( aTmp, aGet, nMode )

return .T.



Static Function LoadFavoritos( oBrwArticulo )

   ( dbfArticulo )->( ordsetfocus( "nPosTcl" ) )
   ( dbfArticulo )->( dbGoTop() )

   oBrwArticulo:Refresh()

RETURN ( nil )



Static Function cTitleSalaVenta( oSayVta, oSayTit )

Return ( nil )



Static Function bpdaButtonsPago( cCode, cText, aTmp )

Return ( {|| aTmp[ 21 ] := cCode, oSayFPago:SetText( AllTrim( cText ) ) } )



Static Function cImageBtn( cCode )

   local cBtnImagen

   do case
      case cCode == "00"
         cBtnImagen  := "gc_money2_16"
      case cCode == "01"
         cBtnImagen  := "gc_credit_cards_16"
      case cCode == "02"
         cBtnImagen  := "gc_moneybag_euro_16"
      case cCode == "03"
         cBtnImagen  := "gc_symbol_percent_16"
      case cCode == "04"
         cBtnImagen  := "gc_shopping_basket_16"
   end

Return cBtnImagen



Static Function pdaEntregando( nValor, aTmp )

   local nCambio
   local nTotal

   if nValor == "C"
      cNumEnt     := "0"
      nCambio     := 0
   else

      cNumEnt     += nValor

      nTotal      := nTotTik( aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ], D():tikets( nView ), dbfTmpL, dbfDiv, aTmp, nil, .F. )

      nCambio     := Val( cNumEnt ) + nEntCli  - nTotal

   end

   oNumEnt:SetText( Trans( Val( cNumEnt ), cPorDiv ) )
   oNumCambio:SetText( Trans( nCambio, cPorDiv ) )

   nCambioCli     := nCambio

Return nil



static function EdtPdaL( aTmp, aGet, dbfTmpL, oBrw, aTmpHead, lNegative, nMode )

   If( lNegative == nil, lNegative := .F., ) ;





   aTmp[ 4 ]     := aTmpHead[ 4 ]
   aTmp[ 27 ]     := aTmpHead[ 10 ]
   aTmp[ 51  ]    := aTmpHead[ 8 ]

   aTmp[ 5 ]     := ( dbfArticulo )->Codigo
   aTmp[ 6 ]     := ( dbfArticulo )->Nombre

   if !empty( ( dbfArticulo )->cDesCmd )
      aTmp[ 57 ]  := ( dbfArticulo )->cDesCmd
   else
      aTmp[ 57 ]  := ( dbfArticulo )->Nombre
   end

   aTmp[ 7 ]     := nRetPreArt( aTmpHead[ 12 ], aTmpHead[ 24 ], .T., dbfArticulo, dbfDiv, dbfKit, dbfIva )
   if lNegative
      aTmp[ 8 ]  := -1
   else
      aTmp[ 8 ]  := 1
   end

   aTmp[ 9 ]     := 0
   aTmp[ 10 ]     := nIva( dbfIva, ( dbfArticulo )->TipoIva )
   aTmp[ 12 ]     := .F.
   aTmp[ 19 ]     := Space( 20 )
   aTmp[ 20 ]     := Space( 20 )
   aTmp[ 21 ]     := Space( 40 )
   aTmp[ 22 ]     := Space( 40 )

   if ( dbfArticulo )->lFacCnv
      aTmp[ 23 ]  := ( dbfArticulo )->nFacCnv
   end

   aTmp[ 26 ]     := ( dbfArticulo )->nCtlStock
   aTmp[ 30 ]     := ( dbfArticulo )->pCosto
   aTmp[ 31 ]     := 1
   aTmp[ 32 ]     := .F.
   aTmp[ 33 ]     := .F.
   aTmp[ 34 ]     := .F.
   aTmp[ 35 ]     := .F.
   aTmp[ 37]     := .F.
   aTmp[ 39 ]     := ( dbfArticulo )->Familia
   aTmp[ 40 ]     := RetFld( ( dbfArticulo )->Familia, dbfFamilia, "CCODGRP" )

   if ( dbfArticulo )->lLote
      aTmp[ 42 ]    := ( dbfArticulo )->cLote
   end

   aTmp[ 52 ]     := .F.

   aTmp[ 68 ] := ( dbfArticulo )->cTipImp1
   aTmp[ 69 ] := ( dbfArticulo )->cTipImp2





   WinGather( aTmp, , dbfTmpL, , nMode )

   lRecTotal( aTmpHead )

return nil







FUNCTION mkTpv( cPath, lAppend, cPathOld, oMeter )

    local cTikT
    local dbfTikL
   local dbfTikP
   local dbfTikC
   local dbfImp
   local dbfMesas
   local oldTikT
   local oldTikL
   local oldTikP
   local oldTikC
   local oldImp
   local oldMesas

   If( lAppend == nil, lAppend := .F., ) ;
   If( cPath == nil, cPath := cPatEmp(), ) ;

   if oMeter <> nil
        oMeter:cText    := "Generando Bases"
      SysRefresh()
   end

   if !lExistTable( cPath + "TIKET.DBF", cLocalDriver() )
      dbCreate( cPath + "TIKET.DBF", aSqlStruct( aItmTik() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "TIKEL.DBF", cLocalDriver() )
      dbCreate( cPath + "TIKEL.DBF", aSqlStruct( aColTik() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "TIKEP.DBF", cLocalDriver() )
      dbCreate( cPath + "TIKEP.DBF", aSqlStruct( aPgoTik() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "TIKEC.DBF", cLocalDriver() )
      dbCreate( cPath + "TIKEC.DBF", aSqlStruct( aPgoCli() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "TIKES.DBF", cLocalDriver() )
      dbCreate( cPath + "TIKES.DBF", aSqlStruct( aSerTik() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "TIKEM.DBF", cLocalDriver() )
      dbCreate( cPath + "TIKEM.DBF", aSqlStruct( aMesTik() ), cLocalDriver() )
   end

   if !lExistTable( cPath + "TIKETIMP.DBF", cLocalDriver() )
      dbCreate( cPath + "TIKETIMP.DBF", aSqlStruct( aImpTik() ), cLocalDriver() )
   end

   rxTpv( cPath, cLocalDriver() )

   if lAppend .AND. lIsDir( cPathOld )

      dbUseArea( .T., cDriver(), cPath + "TikeT.Dbf", cCheckArea( "TIKET",  @cTikT ), .F. )
      ( cTikT )->( ordListAdd( cPath + "TikeT.Cdx" ) )
      ( cTikT )->( ordsetfocus( "cLiqVal" ) )

      dbUseArea( .T., cDriver(), cPath + "TikeL.Dbf", cCheckArea( "TIKETL", @dbfTikL ), .F. )
      ( dbfTikL )->( ordListAdd( cPath + "TikeL.Cdx" ) )

      dbUseArea( .T., cDriver(), cPath + "TikeP.Dbf", cCheckArea( "TIKETP", @dbfTikP ), .F. )
      ( dbfTikP )->( ordListAdd( cPath + "TikeP.Cdx" ) )

      dbUseArea( .T., cDriver(), cPath + "TikeC.Dbf", cCheckArea( "TiketC", @dbfTikC ), .F. )
      ( dbfTikC )->( ordListAdd( cPath + "TikeC.Cdx" ) )

      dbUseArea( .T., cDriver(), cPath + "TikeM.Dbf", cCheckArea( "TiketM", @dbfMesas ), .F. )
      ( dbfMesas )->( ordListAdd( cPath + "TikeM.Cdx" ) )

      dbUseArea( .T., cDriver(), cPathOld + "TikeT.Dbf", cCheckArea( "TIKET",  @oldTikT ), .F. )
      ( oldTikT )->( ordListAdd( cPathOld + "TikeT.Cdx" ) )
      ( oldTikT )->( ordsetfocus( "cLiqVal" ) )

      dbUseArea( .T., cDriver(), cPathOld + "TikeL.Dbf", cCheckArea( "TIKETL", @oldTikL ), .F. )
      ( oldTikL )->( ordListAdd( cPathOld + "TikeL.Cdx" ) )

      dbUseArea( .T., cDriver(), cPathOld + "TikeP.Dbf", cCheckArea( "TIKETP", @oldTikP ), .F. )
      ( oldTikP )->( ordListAdd( cPathOld + "TikeP.Cdx" ) )

      dbUseArea( .T., cDriver(), cPathOld + "TikeC.Dbf", cCheckArea( "TiketC", @oldTikC ), .F. )
      ( oldTikC )->( ordListAdd( cPathOld + "TikeC.Cdx" ) )

      dbUseArea( .T., cDriver(), cPathOld + "TikeM.Dbf", cCheckArea( "TikeM", @oldMesas ), .F. )
      ( oldMesas )->( ordListAdd( cPathOld + "TikeM.Cdx" ) )

      dbUseArea( .T., cDriver(), cPathOld + "TiketImp.Dbf", cCheckArea( "TiketImp", @oldImp ), .F. )
      ( oldImp )->( ordListAdd( cPath + "TiketImp.Cdx" ) )

      ( oldTikT )->( dbGoTop() )
      while !( oldTikT )->( eof() )

         dbCopy( oldTikT, cTikT, .T. )

         if ( oldTikL )->( dbSeek( ( oldTikT )->cSerTik + ( oldTikT )->cNumTik + ( oldTikT )->cSufTik ) )
            while ( oldTikL )->cSerTil + ( oldTikL )->cNumTil + ( oldTikL )->cSufTil == ( oldTikT )->cSerTik + ( oldTikT )->cNumTik + ( oldTikT )->cSufTik .AND. !( oldTikL )->( eof() )
               dbCopy( oldTikL, dbfTikL, .T. )
               ( oldTikL )->( dbSkip() )
            end
         end

         if ( oldTikP )->( dbSeek( ( oldTikT )->cSerTik + ( oldTikT )->cNumTik + ( oldTikT )->cSufTik ) )
            while ( oldTikP )->cSerTik + ( oldTikP )->cNumTik + ( oldTikP )->cSufTik == ( oldTikT )->cSerTik + ( oldTikT )->cNumTik + ( oldTikT )->cSufTik .AND. !( oldTikP )->( eof() )
               dbCopy( oldTikP, dbfTikP, .T. )
               ( oldTikP )->( dbSkip() )
            end
         end

         ( oldTikT )->( dbSkip() )

      end





      ( oldTikC )->( dbGoTop() )
      while !( oldTikC )->( eof() )
         dbCopy( oldTikC, dbfTikC, .T. )
         ( oldTikC )->( dbSkip() )
      end





      ( oldMesas )->( dbGoTop() )
      while !( oldMesas )->( eof() )
         dbCopy( oldMesas, dbfMesas, .T. )
         ( oldMesas )->( dbSkip() )
      end





      ( cTikT )->( dbEval( {|| ( cTikT )->cTurTik := Space( 6 ) },,,,, .F. ) )





      ( cTikT  )->( dbCloseArea() )
      ( dbfTikL  )->( dbCloseArea() )
      ( dbfTikP  )->( dbCloseArea() )
      ( dbfTikC  )->( dbCloseArea() )
      ( dbfImp   )->( dbCloseArea() )
      ( dbfMesas )->( dbCloseArea() )

      ( oldTikT  )->( dbCloseArea() )
      ( oldTikL  )->( dbCloseArea() )
      ( oldTikP  )->( dbCloseArea() )
      ( oldTikC  )->( dbCloseArea() )
      ( oldImp   )->( dbCloseArea() )
      ( oldMesas )->( dbCloseArea() )

   end

Return nil



FUNCTION rxTpv( cPath, cDriver )

    local cTikT
    local dbfTikL
   local dbfTikP
   local dbfTikC
   local dbfTikM
   local dbfTikS
   local dbfImp

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   if !lExistTable( cPath + "TIKET.DBF", cDriver )
      dbCreate( cPath + "TIKET.DBF", aSqlStruct( aItmTik() ), cDriver )
   end

   if !lExistTable( cPath + "TIKEL.DBF", cDriver )
      dbCreate( cPath + "TIKEL.DBF", aSqlStruct( aColTik() ), cDriver )
   end

   if !lExistTable( cPath + "TIKEP.DBF", cDriver )
      dbCreate( cPath + "TIKEP.DBF", aSqlStruct( aPgoTik() ), cDriver )
   end

   if !lExistTable( cPath + "TIKEC.DBF", cDriver )
      dbCreate( cPath + "TIKEC.DBF", aSqlStruct( aPgoCli() ), cDriver )
   end

   if !lExistTable( cPath + "TIKEM.DBF", cDriver )
      dbCreate( cPath + "TIKEM.DBF", aSqlStruct( aMesTik() ), cDriver )
   end

   if !lExistTable( cPath + "TIKES.DBF", cDriver )
      dbCreate( cPath + "TIKES.DBF", aSqlStruct( aSerTik() ), cDriver )
   end

   if !lExistTable( cPath + "TIKETIMP.DBF", cDriver )
      dbCreate( cPath + "TIKETIMP.DBF", aSqlStruct( aImpTik() ), cDriver )
   end

   fEraseIndex( cPath + "TikeT.Cdx", cDriver )
   fEraseIndex( cPath + "TikeL.Cdx", cDriver )
   fEraseIndex( cPath + "TikeP.Cdx", cDriver )
   fEraseIndex( cPath + "TikeC.Cdx", cDriver )
   fEraseIndex( cPath + "TikeM.Cdx", cDriver )
   fEraseIndex( cPath + "TikeS.Cdx", cDriver )
   fEraseIndex( cPath + "TiketImp.Cdx", cDriver )





   dbUseArea( .T., cDriver, cPath + "TIKET.DBF", cCheckArea( "TIKET", @cTikT ), .F. )

   if !( cTikT )->( neterr() )
      ( cTikT )->( __dbPack() )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "CNUMTIK", "CSERTIK + CNUMTIK + CSUFTIK", {|| Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {|| !Deleted() }, , , , , , , , , .T. ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "dFecTik", "dFecTik", {|| Field->dFecTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "CCLITIK", "CCLITIK", {|| Field->CCLITIK } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "CNOMTIK", "CNOMTIK", {|| Field->CNOMTIK } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "CNCJTIK", "CCCJTIK", {|| Field->CNCJTIK } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "CCCJTIK", "CCCJTIK", {|| Field->CCCJTIK } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "CRETMAT", "CRETMAT", {|| Field->CRETMAT } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. !empty( cTurTik )", {||!Deleted() .AND. !empty( Field->cTurTik ) }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "CTURTIK", "CTURTIK + CSUFTIK + CNCJTIK", {|| Field->CTURTIK + Field->cSufTik + Field->CNCJTIK } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cAlmTik", "CALMTIK", {|| Field->CALMTIK } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cSufTik", "cSufTik", {|| Field->cSufTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted() }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "CNUMDOC", "CNUMDOC", {|| Field->CNUMDOC } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted() }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "LSNDDOC", "LSNDDOC", {|| Field->LSNDDOC } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted() }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cCodUsr", "cCcjTik + Dtos( dFecCre ) + cTimCre", {|| Field->cCcjTik + Dtos( Field->dFecCre ) + Field->cTimCre } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. cTipTik == '6'", {||!Deleted() .AND. Field->cTipTik == "6" }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cDocVal", "cValDoc", {|| Field->cValDoc } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. cTipTik == '6'", {||!Deleted() .AND. Field->cTipTik == "6" }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cNumVal", "cSerTik + cNumTik + cSufTik", {|| Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. cTipTik == '6' .and. !lLiqTik", {||!Deleted() .AND. Field->cTipTik == "6" .AND. !Field->lLiqTik }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cLiqVal", "cSerTik + cNumTik + cSufTik", {|| Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. lLiqTik", {|| !Deleted() .AND. Field->lLiqTik }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cTurVal", "cTurVal + cSufTik + cNcjTik", {|| Field->cTurVal + Field->cSufTik + Field->cNcjTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. ( cTipTik == '1' .or. cTipTik == '7' ) .and. !lPgdTik .and. !lCloTik", {|| !Deleted() .AND. Field->cTipTik == "1" .AND. !Field->lPgdTik .AND. !Field->lCloTik } ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cCodSal", "cCodSala + cPntVenta", {|| Field->cCodSala + Field->cPntVenta } ) )

      ( cTikT )->( ordCondSet( "!Deleted().and. cTipTik == '6' .and. !lLiqTik", {|| !Deleted() .AND. Field->cTipTik == "6" .AND. !Field->lLiqTik }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cCliVal", "cCliTik", {|| Field->cCliTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted().and. cTipTik == '6' .and. !lLiqTik", {|| !Deleted() .AND. Field->cTipTik == "6" .AND. !Field->lLiqTik }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cNomVal", "cNomTik", {|| Field->cNomTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. cTipTik == '6' .and. !lLiqTik", {|| !Deleted() .AND. Field->cTipTik == "6" .AND. !Field->lLiqTik }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cTikVal", "cTikVal", {|| Field->cTikVal } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. !Field->lLiqTik .and. ( cTipTik == '1' .or. cTipTik == '7' )", {||!Deleted() .AND. !Field->lLiqTik .AND. ( Field->cTipTik == "1" .OR. Field->cTipTik == "7" ) }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "lCliTik", "cCliTik", {|| Field->cCliTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( cTikT )->( ordCreate( cPath + "TIKET.CDX", "cValTik", "cTikVal", {|| Field->cTikVal } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. lAbierto .and. !lDelete", {|| !Deleted() .AND. Field->lAbierto .AND. !Field->lDelete } ) )
      ( cTikT )->( ordCreate( cPath + "TikeT.Cdx", "lCloTik", "cSerTik + cNumTik + cSufTik", {|| Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. lAbierto", {|| !Deleted() .AND. Field->lAbierto } ) )
      ( cTikT )->( ordCreate( cPath + "TikeT.Cdx", "nUbiTik", "Str( nUbiTik )", {|| Str( Field->nUbiTik ) } ) )

      ( cTikT )->( ordCondSet( "!Deleted() .and. !lCloTik .and. !lPgdTik", {|| !Deleted() .AND. !Field->lCloTik .AND. !Field->lPgdTik } ) )
      ( cTikT )->( ordCreate( cPath + "TikeT.Cdx", "lCloUbiTik", "Str( nUbiTik ) + cSerTik + cNumTik + cSufTik", {|| Str( Field->nUbiTik ) + Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TikeT.Cdx", "iNumTik", "'12' + CSERTIK + CNUMTIK + CSUFTIK", {|| "12" + Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TikeT.Cdx", "cCodObr", "cCodObr + dtos( dFecTik )", {|| Field->cCodObr + dtos( Field->dFecTik ) } ) )

      ( cTikT )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( cTikT )->( ordCreate( cPath + "TikeT.Cdx", "cRefTik", "cRefTik", {|| Field->cRefTik } ) )

      ( cTikT )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de tikets" )
   end

   dbUseArea( .T., cDriver, cPath + "TIKEL.DBF", cCheckArea( "TIKEL", @dbfTikL ), .F. )

   if !( dbfTikL )->( neterr() )
      ( dbfTikL )->( __dbPack() )

      ( dbfTikL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "CNUMTIL", "CSERTIL + CNUMTIL + CSUFTIL", {|| Field->CSERTIL + Field->CNUMTIL + Field->CSUFTIL } ) )

      ( dbfTikL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "CCBATIL", "CCBATIL", {|| Field->CCBATIL } ) )

      ( dbfTikL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "CCOMTIL", "CCOMTIL", {|| Field->CCOMTIL } ) )

      ( dbfTikL )->( ordCondSet("!lValidado .and. !lControl .and. !Deleted() .and. cTipTil != '2' .and. cTipTil != '3' .and. nCtlStk < 2", {|| !Field->lValidado .AND. !Field->lControl .AND. !Deleted() .AND. Field->cTipTil <> "2" .AND. Field->cTipTil <> "3" .AND. Field->nCtlStk < 2 }, , , , , , , , , .T. ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "cStkFast", "cCbaTil + cAlmLin + dtos( dFecTik )", {|| Field->cCbaTil + Field->cAlmLin + dtos( Field->dFecTik ) } ) )

      ( dbfTikL )->( ordCondSet("!Deleted() .and. cComTil != '' .and. cTipTil != '2' .and. cTipTil != '3' .and. nCtlStk < 2", {||!Deleted() .AND. Field->cComTil <> "" .AND. Field->cTipTil <> "2" .AND. Field->cTipTil <> "3" .AND. Field->nCtlStk < 2 }, , , , , , , , , .T. ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "cStkComb", "cComTil  + cAlmLin + dtos( dFecTik )", {|| Field->cComTil + Field->cAlmLin + dtos( Field->dFecTik ) } ) )

      ( dbfTikL )->( ordCondSet("!Deleted() .and. cTipTil == '6' ", {||!Deleted()  .AND. Field->cTipTil == "6" } ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "cTikVal", "CSERTIL + CNUMTIL + CSUFTIL", {|| Field->CSERTIL + Field->CNUMTIL + Field->CSUFTIL } ) )

      ( dbfTikL )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "nOrTImp", "nOrTImp", {|| Field->nOrTImp } ) )

      ( dbfTikL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "CNUMCBA", "CSERTIL + CNUMTIL + CSUFTIL + CCBATIL", {|| Field->CSERTIL + Field->CNUMTIL + Field->CSUFTIL + Field->CCBATIL } ) )

      ( dbfTikL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "cNumDev", "cNumDev + Str( nNumLin )", {|| Field->cNumDev + Str( Field->nNumLin ) } ) )

      ( dbfTikL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "cDevTik", "cNumDev", {|| Field->cNumDev } ) )

      ( dbfTikL )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "iNumTik", "'12' + cSerTil + cNumTil + cSufTil", {|| "12" + Field->cSerTil + Field->cNumTil + Field->cSufTil } ) )

      ( dbfTikL )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikL )->( ordCreate( cPath + "TikeL.Cdx", "nOrdLin", "cSerTil + cNumTil + cSufTil + Str( nLinMnu ) + Str( nNumLin )", {|| Field->cSerTil + Field->cNumTil + Field->cSufTil + Str( Field->nLinMnu ) + Str( Field->nNumLin ) } ) )

      ( dbfTikL )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de tikets" )
   end

   dbUseArea( .T., cDriver, cPath + "TIKEP.DBF", cCheckArea( "TIKEP", @dbfTikP ), .F. )
   if !( dbfTikP )->( neterr() )
      ( dbfTikP )->( __dbPack() )

      ( dbfTikP )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikP )->( ordCreate( cPath + "TIKEP.CDX", "CNUMTIK", "CSERTIK + CNUMTIK + CSUFTIK", {|| Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( dbfTikP )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikP )->( ordCreate( cPath + "TIKEP.CDX", "DPGOTIK", "DPGOTIK", {|| Field->DPGOTIK } ) )

      ( dbfTikP )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikP )->( ordCreate( cPath + "TIKEP.CDX", "CTURPGO", "cTurPgo + cSufTik + cCodCaj", {|| Field->cTurPgo + Field->cSufTik + Field->cCodCaj } ) )

      ( dbfTikP )->( ordCondSet("!Deleted()", {||!Deleted()}  ) )
      ( dbfTikP )->( ordCreate( cPath + "TIKEP.CDX", "cFpgPgo", "cFpgPgo", {|| Field->cFpgPgo } ) )

      ( dbfTikP )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfTikP )->( ordCreate( cPath + "TIKEP.CDX", "NNUMPGO", "Str( nNumPgo ) + cSufPgo", {|| Str( Field->nNumPgo ) + Field->cSufPgo } ) )

      ( dbfTikP )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfTikP )->( ordCreate( cPath + "TikeP.Cdx", "iNumTik", "'31' + cSerTik + cNumTik + cSufTik + Str( nNumRec )", {|| "31" + Field->cSerTik + Field->cNumTik + Field->cSufTik + Str( Field->nNumRec ) } ) )

      ( dbfTikP )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de tikets" )
   end

   dbUseArea( .T., cDriver, cPath + "TIKEC.DBF", cCheckArea( "TIKEC", @dbfTikC ), .F. )
   if !( dbfTikC )->( neterr() )

      ( dbfTikC )->( __dbPack() )

      ( dbfTikC )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfTikC )->( ordCreate( cPath + "TIKEC.CDX", "nNumPgo", "Str( nNumPgo ) + cSufPgo", {|| Str( Field->nNumPgo ) + Field->cSufPgo } ) )

      ( dbfTikC )->( ordCondSet( "!Deleted()", {|| !Deleted() }  ) )
      ( dbfTikC )->( ordCreate( cPath + "TIKEC.CDX", "cCodCli", "cCodCli", {|| Field->cCodCli } ) )

      ( dbfTikC )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de tikets" )
   end

  dbUseArea( .T., cDriver, cPath + "TIKETIMP.DBF", cCheckArea( "TIKETIMP", @dbfImp ), .F. )
   if !( dbfImp )->( neterr() )
      ( dbfImp )->( __dbPack() )

      ( dbfImp )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfImp )->( ordCreate( cPath + "TIKETIMP.CDX", "CNUMTIL", "CSERTIK + CNUMTIK + CSUFTIK", {|| Field->CSERTIK + Field->CNUMTIK + Field->CSUFTIK } ) )

      ( dbfImp )->( ordCondSet( "!Deleted() .AND. !LIMP ", {||!Deleted() .AND. !Field->LIMP } ) )
      ( dbfImp )->( ordCreate( cPath + "TIKETIMP.CDX", "CIMPTIK", "CSERTIK + CNUMTIK + CSUFTIK", {|| Field->CSERTIK + Field->CNUMTIK + Field->CSUFTIK } ) )

      ( dbfImp )->( ordCondSet( "!Deleted() .AND. !LIMP .AND. !LCOMANDA", {||!Deleted() .AND. !Field->LIMP .AND. !Field->LCOMANDA } ) )
      ( dbfImp )->( ordCreate( cPath + "TIKETIMP.CDX", "CCOMANDA", "CSERTIK + CNUMTIK + CSUFTIK", {|| Field->CSERTIK + Field->CNUMTIK + Field->CSUFTIK } ) )

      ( dbfImp )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de Impresion" )
   end

   dbUseArea( .T., cDriver, cPath + "TikeM.DBF", cCheckArea( "TIKEM", @dbfTikM ), .F. )
   if !( dbfTikM )->( neterr() )
      ( dbfTikM )->( __dbPack() )

      ( dbfTikM )->( ordCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTikM )->( ordCreate( cPath + "TikeM.CDX", "cMesa", "cCodSala + cPntVenta", {|| Field->cCodSala + Field->cPntVenta } ) )

      ( dbfTikM )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de mesas libres" )
   end

   dbUseArea( .T., cDriver, cPath + "TikeS.Dbf", cCheckArea( "TikeS", @dbfTikS ), .F. )
   if !( dbfTikS )->( neterr() )
      ( dbfTikS )->( __dbPack() )

      ( dbfTikS )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfTikS )->( ordCreate( cPath + "TikeS.Cdx", "nNumTik", "cSerTik + cNumTik + cSufTik + Str( nNumLin )", {|| Field->cSerTik + Field->cNumTik + Field->cSufTik + Str( Field->nNumLin ) } ) )

      ( dbfTikS )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfTikS )->( ordCreate( cPath + "TikeS.Cdx", "cRefSer", "cCbaTil + cAlmLin + cNumSer", {|| Field->cCbaTil + Field->cAlmLin + Field->cNumSer } ) )

      ( dbfTikS )->( ordCondSet( "!Deleted()", {|| !Deleted() } ) )
      ( dbfTikS )->( ordCreate( cPath + "TikeS.Cdx", "cNumSer", "cNumSer", {|| Field->cNumSer } ) )

      ( dbfTikS )->( ordCondSet( "!Deleted()", {||!Deleted()}  ) )
      ( dbfTikS )->( ordCreate( cPath + "TikeS.Cdx", "iNumTik", "'12' + cSerTik + cNumTik + cSufTik", {|| "12" + Field->cSerTik + Field->cNumTik + Field->cSufTik } ) )

      ( dbfTikS )->( dbCloseArea() )
   else
      msgStop( "Imposible abrir en modo exclusivo la tabla de numeros de series" )
   end

RETURN NIL



function aPgoTik()

   local aPgoTik  := {}

   aAdd( aPgoTik, { "cSerTik",  "C",      1,     0, "Serie del tiket"            } )
   aAdd( aPgoTik, { "cNumTik",  "C",     10,     0, "Número del tiket"           } )
   aAdd( aPgoTik, { "cSufTik",  "C",      2,     0, "Sufijo del tiket"           } )
   aAdd( aPgoTik, { "nNumRec",  "N",      2,     0, "Número de orden del pago"   } )
   aAdd( aPgoTik, { "cCodCaj",  "C",      3,     0, "Código de caja"             } )
   aAdd( aPgoTik, { "dPgoTik",  "D",      8,     0, "Fecha del pago"             } )
   aAdd( aPgoTik, { "cTimTik",  "C",      5,     0, "Hora del pago"              } )
   aAdd( aPgoTik, { "cFpgPgo",  "C",      2,     0, "Forma de pago del recibo"   } )
   aAdd( aPgoTik, { "nImpTik",  "N",     16,     6, "Importe del pago"           } )
   aAdd( aPgoTik, { "nDevTik",  "N",     16,     6, "Importe del cambio"         } )
   aAdd( aPgoTik, { "cPgdPor",  "C",     50,     0, "Pagado por"                 } )
   aAdd( aPgoTik, { "cDivPgo",  "C",      3,     0, "Divisa de pago"             } )
   aAdd( aPgoTik, { "nVdvPgo",  "N",     16,     6, "Valor de la divisa"         } )
   aAdd( aPgoTik, { "lConPgo",  "L",      1,     0, "Pago contabilizado (S/N)"   } )
   aAdd( aPgoTik, { "cCtaPgo",  "C",     12,     0, "Cuenta de pago"             } )
   aAdd( aPgoTik, { "lCloPgo",  "L",      1,     0, "Pago cerrado (S/N)"         } )
   aAdd( aPgoTik, { "lSndPgo",  "L",      1,     0, "Enviar documento"           } )
   aAdd( aPgoTik, { "cTurPgo",  "C",      6,     0, "Sesión del pago"            } )
   aAdd( aPgoTik, { "cCtaRec",  "C",     12,     0, "Cuenta de contabilidad"     } )
   aAdd( aPgoTik, { "nNumPgo",  "N",      9,     0, "Número pago cliente"        } )
   aAdd( aPgoTik, { "cSufPgo",  "C",      2,     0, "Sufijo pago cliente"        } )
   aAdd( aPgoTik, { "lDelete",  "L",      1,     0, "Marca de pago eliminado"    } )
   aAdd( aPgoTik, { "uuid",     "C",     40,     0, "uuid del pago"              } )
   aAdd( aPgoTik, { "paruuid",  "C",     40,     0, "uuid de la cabecera"        } )

RETURN ( aPgoTik )



function aMesTik()

   local aMesTik  := {}

   aAdd( aMesTik , { "cCodSala", "C",      3,     0, "Código de sala" }            )
   aAdd( aMesTik , { "cPntVenta","C",     30,     0, "Punto de venta" }            )

RETURN ( aMesTik )



function aPgoCli()

   local aPgoCli  := {}

   aAdd( aPgoCli, { "nNumPgo",  "N",      9,     0, "Pago cliente.Número"                    } )
   aAdd( aPgoCli, { "cSufPgo",  "C",      2,     0, "Pago cliente.Sufijo"                    } )
   aAdd( aPgoCli, { "cCodCaj",  "C",      3,     0, "Pago cliente.Número de caja"            } )
   aAdd( aPgoCli, { "dPgoTik",  "D",      8,     0, "Pago cliente.Fecha del pago"            } )
   aAdd( aPgoCli, { "cFpgPgo",  "C",      2,     0, "Pago cliente.Forma de pago del recibo"  } )
   aAdd( aPgoCli, { "nImpPgo",  "N",     16,     6, "Pago cliente.Importe del pago"          } )
   aAdd( aPgoCli, { "nDevPgo",  "N",     16,     6, "Pago cliente.Importe de la devolución"  } )
   aAdd( aPgoCli, { "nTotPgo",  "N",     16,     6, "Pago cliente.Total importe pago"        } )
   aAdd( aPgoCli, { "cCodCli",  "C",     12,     0, "Pago cliente.Código cliente"            } )
   aAdd( aPgoCli, { "cDivPgo",  "C",      3,     0, "Pago cliente.Divisa de pago"            } )
   aAdd( aPgoCli, { "nVdvPgo",  "N",     16,     6, "Pago cliente.Valor de la divisa"        } )
   aAdd( aPgoCli, { "lCloPgo",  "L",      1,     0, "Pago cliente.Pago cerrado (S/N)"        } )
   aAdd( aPgoCli, { "cCtaRec",  "C",     12,     0, "Pago cliente.Cuenta de contabilidad"    } )
   aAdd( aPgoCli, { "cTurPgo",  "C",      6,     0, "Pago cliente.Sesión"                    } )

RETURN ( aPgoCli )



function aItmTik()

   local aItmTik  := {}

   aAdd( aItmTik, { "cSerTik",  "C",      1,     0, "Serie del tiket" }                                       )
   aAdd( aItmTik, { "cNumTik",  "C",     10,     0, "Número del tiket" }                                      )
   aAdd( aItmTik, { "cSufTik",  "C",      2,     0, "Sufijo del tiket" }                                      )
   aAdd( aItmTik, { "cTipTik",  "C",      1,     0, "Tipo del documento" }                                    )
   aAdd( aItmTik, { "cTurTik",  "C",      6,     0, "Sesión del tiket" }                                      )
   aAdd( aItmTik, { "dFecTik",  "D",      8,     0, "Fecha del tiket" }                                       )
   aAdd( aItmTik, { "cHorTik",  "C",      5,     0, "Hora del tiket" }                                        )
   aAdd( aItmTik, { "cCcjTik",  "C",      3,     0, "Código del cajero" }                                     )
   aAdd( aItmTik, { "cNcjTik",  "C",      3,     0, "Código de caja" }                                        )
   aAdd( aItmTik, { "cAlmTik",  "C",     16,     0, "Código del almacén" }                                    )
   aAdd( aItmTik, { "cCliTik",  "C",     12,     0, "Código del cliente" }                                    )
   aAdd( aItmTik, { "nTarifa",  "N",      1,     0, "Tarifa de precios" }                                     )
   aAdd( aItmTik, { "cNomTik",  "C",     80,     0, "Nombre del cliente" }                                    )
   aAdd( aItmTik, { "cDirCli",  "C",    200,     0, "Domicilio del cliente" }                                 )
   aAdd( aItmTik, { "cPobCli",  "C",    200,     0, "Población del cliente" }                                 )
   aAdd( aItmTik, { "cPrvCli",  "C",    100,     0, "Provincia del cliente" }                                 )
   aAdd( aItmTik, { "nCodProv", "N",      2,     0, "Número de provincia cliente" }                           )
   aAdd( aItmTik, { "cPosCli",  "C",     15,     0, "Código postal del cliente" }                             )
   aAdd( aItmTik, { "cDniCli",  "C",     30,     0, "DNI/Cif del cliente" }                                   )
   aAdd( aItmTik, { "lModCli",  "L",      1,     0, "Lógico de modificar datos del cliente" }                 )
   aAdd( aItmTik, { "cFpgTik",  "C",      2,     0, "Forma de pago del tiket" }                               )
   aAdd( aItmTik, { "nCobTik",  "N",     16,     6, "Importe cobrado" }                                       )
   aAdd( aItmTik, { "nCamTik",  "N",     16,     6, "Devolución" }                                            )
   aAdd( aItmTik, { "cDivTik",  "C",      3,     0, "Código de la divisa" }                                   )
   aAdd( aItmTik, { "nVdvTik",  "N",     10,     3, "Valor de la divisa" }                                    )
   aAdd( aItmTik, { "lCloTik",  "L",      1,     0, "Lógico de cerrado" }                                     )
   aAdd( aItmTik, { "lSndDoc",  "L",      1,     0, "Lógico de enviado" }                                     )
   aAdd( aItmTik, { "lPgdTik",  "L",      1,     0, "Lógico de pagado" }                                      )
   aAdd( aItmTik, { "cRetPor",  "C",    100,     0, "Retirado por" }                                          )
   aAdd( aItmTik, { "cRetMat",  "C",     20,     0, "Matrícula" }                                             )
   aAdd( aItmTik, { "cNumDoc",  "C",     12,     0, "Número del documento" }                                  )
   aAdd( aItmTik, { "cCodAge",  "C",      3,     0, "Código del agente" }                                     )
   aAdd( aItmTik, { "cCodRut",  "C",      4,     0, "Código de la ruta" }                                     )
   aAdd( aItmTik, { "cCodTar",  "C",      5,     0, "Código de la tarifa" }                                   )
   aAdd( aItmTik, { "cCodObr",  "C",     10,     0, "Código de la dirección" }                                )
   aAdd( aItmTik, { "nComAge",  "N",      6,     2, "Porcentaje de comisión del agente" }                     )
   aAdd( aItmTik, { "lLiqTik",  "L",      1,     0, "Tiket liquidado" }                                       )
   aAdd( aItmTik, { "cCodPro",  "C",      9,     0, "Código de proyecto en contabilidad"}                     )
   aAdd( aItmTik, { "lConTik",  "L",      1,     0, "Tiket contabilizado" }                                   )
   aAdd( aItmTik, { "dFecCre",  "D",      8,     0, "Fecha de creación del documento" }                       )
   aAdd( aItmTik, { "cTimCre",  "C",      5,     0, "Hora de creación del documento" }                        )
   aAdd( aItmTik, { "lSelDoc",  "L",      1,     0, "" }                                                      )
   aAdd( aItmTik, { "cValDoc",  "C",     13,     0, "Número del vale relacionado" }                           )
   aAdd( aItmTik, { "cTurVal",  "C",      6,     0, "Sesión de la liquidación del vale" }                     )
   aAdd( aItmTik, { "lCnvTik",  "L",      1,     0, "Lógico para tiket convertido a factura" }                )
   aAdd( aItmTik, { "cCodDlg",  "C",      2,     0, "Código delegación" }                                     )
   aAdd( aItmTik, { "cCodGrp",  "C",      4,     0, "Código de grupo de cliente" }                            )
   aAdd( aItmTik, { "cCodSala", "C",      3,     0, "Código de sala" }                                        )
   aAdd( aItmTik, { "cPntVenta","C",     30,     0, "Punto de venta" }                                        )
   aAdd( aItmTik, { "lAbierto", "L",      1,     0, "Lógico de ticket abierto" }                              )
   aAdd( aItmTik, { "cAliasTik","C",     80,     0, "Alias del tiket" }                                       )
   aAdd( aItmTik, { "nNumCom",  "N",      2,     0, "Número de comensales" }                                  )
   aAdd( aItmTik, { "cAlbTik",  "C",     12,     0, "Número del albarán del que proviene" }                   )
   aAdd( aItmTik, { "cPedTik",  "C",     12,     0, "Número del pedido del que proviene" }                    )
   aAdd( aItmTik, { "cPreTik",  "C",     12,     0, "Número del presupuesto del que proviene" }               )
   aAdd( aItmTik, { "cSatTik",  "C",     12,     0, "Número del SAT del que proviene" }                       )
   aAdd( aItmTik, { "cDtoEsp",  "C",     50,     0, "Descripción de porcentaje de descuento especial" }       )
   aAdd( aItmTik, { "nDtoEsp",  "N",      6,     2, "Porcentaje de descuento especial" }                      )
   aAdd( aItmTik, { "cDpp",     "C",     50,     0, "Descripción de porcentaje de descuento por pronto pago" })
   aAdd( aItmTik, { "nDpp",     "N",      6,     2, "Porcentaje de descuento por pronto pago" }               )
   aAdd( aItmTik, { "nPctPrm",  "N",      6,     2, "Porcentaje de promoción por fidelización" }              )
   aAdd( aItmTik, { "cTikVal",  "C",     13,     0, "Numero del tiket de quien se genero el vale" }           )
   aAdd( aItmTik, { "cTlfCli",  "C",     20,     0, "Teléfono del cliente" }                                  )
   aAdd( aItmTik, { "lFreTik",  "L",      1,     0, "Ticket regalo" }                                         )
   aAdd( aItmTik, { "nTotNet",  "N",     16,     6, "Total neto" }                                            )
   aAdd( aItmTik, { "nTotIva",  "N",     16,     6, "Total " + cImp() }                                       )
   aAdd( aItmTik, { "nTotTik",  "N",     16,     6, "Total ticket" }                                          )
   aAdd( aItmTik, { "lLiqDev",  "L",      1,     0, "Liquidado por devolución" }                              )
   aAdd( aItmTik, { "nUbiTik",  "N",      1,     0, "Tipo de ubicación" }                                     )
   aAdd( aItmTik, { "nRegIva",  "N",      1,     0, "Régimen de " + cImp() }                                  )
   aAdd( aItmTik, { "tFecTik",  "C",      6,     0, "Hora del tiket stock" }                                  )
   aAdd( aItmTik, { "uuid",     "C",     40,     0, "Uuui del tiket" }                                        )
   aAdd( aItmTik, { "lDelete",  "L",      1,     0, "Marca de ticket eliminado" }                             )
   aAdd( aItmTik, { "cRefTik",  "C",     40,     0, "Referencia simplificada" }                               )

return ( aItmTik )



function aColTik()

   local aColTik  :={}

   aAdd( aColTik, { "cSerTil",  "C",      1,     0, "Serie del tiket",                    "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cNumTil",  "C",     10,     0, "Número del tiket",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cSufTil",  "C",      2,     0, "Sufijo del tiket",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cTipTil",  "C",      1,     0, "Tipo de documento",                  "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCbaTil",  "C",     18,     0, "Código del barras del producto",     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cNomTil",  "C",    250,     0, "Nombre del producto",                "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nPvpTil",  "N",     16,     6, "Precio de venta del producto",       "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nUntTil",  "N",     16,     6, "Unidades vendidas del producto",     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nUndKit",  "N",     16,     6, "Unidades productos kit",             "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nIvaTil",  "N",      5,     2, "Porcentaje de " + cImp() + " del producto",     "",       "", "( cDbfCol )" } )
   aAdd( aColTik, { "cFamTil",  "C",      5,     0, "Família la que pertenece el producto", "",                "", "( cDbfCol )" } )
   aAdd( aColTik, { "lOfeTil",  "L",      1,     0, "Oferta ya aplicada",                 "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cComTil",  "C",     18,     0, "Código de barras de combinado",      "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cNcmTil",  "C",    100,     0, "Nombre del producto combinado",      "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nPcmTil",  "N",     16,     6, "Precio de venta del producto combinado", "",              "", "( cDbfCol )" } )
   aAdd( aColTik, { "cFcmTil",  "C",      5,     0, "Familia la que pertenece el producto combinado", "",      "", "( cDbfCol )" } )
   aAdd( aColTik, { "lFreTil",  "L",      1,     0, "Lineas sin cargo",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nDtoLin",  "N",      6,     2, "Descuento en linea",                 "'@E 999.9'",        "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCodPr1",  "C",     20,     0, "Código de la primera propiedad",     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCodPr2",  "C",     20,     0, "Código de la segunda propiedad",     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cValPr1",  "C",     20,     0, "Valor de la primera propiedad",      "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cValPr2",  "C",     20,     0, "Valor de la segunda propiedad",      "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nFacCnv",  "N",     16,     6, "Factor de conversión",               "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nDtoDiv",  "N",     16,     6, "Descuento lineal de la compra",      "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lTipAcc",  "L",      1,     0, "",                                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nCtlStk",  "N",      1,     0, "",                                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cAlmLin",  "C",     16,     0, "Código de almacén en línea",         "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nValImp",  "N",     16,     6, "Importe del impuesto",               "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCodImp",  "C",      3,     0, "Código de IVMH",                     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nCosDiv",  "N",     16,     6, "Precio de costo",                    "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nNumLin",  "N",      4,     0, "Número de la línea",                 "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lKitArt",  "L",      1,     0, "Línea con escandallo",               "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lKitChl",  "L",      1,     0, "Línea pertenciente a escandallo",    "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lKitPrc",  "L",      1,     0, "",                                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lImpLin",  "L",      1,     0, "Imprimir línea",                     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nMesGrt",  "N",      2,     0, "Meses de garantía",                  "'99'",              "", "( cDbfCol )" } )
   aAdd( aColTik, { "lControl", "L",      1,     0, "Línea de control",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "mNumSer",  "M",     10,     0, "",                                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCodFam",  "C",     16,     0, "Código de familia",                  "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cGrpFam",  "C",      3,     0, "Código del grupo de familia",        "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nLote",    "N",      9,     0, "",                                   "@Z 999999999",      "", "( cDbfCol )" } )
   aAdd( aColTik, { "cLote",    "C",     64,     0, "Número de lote",                     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nNumPgo",  "N",      9,     0, "Número pago cliente",                "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cSufPgo",  "C",      2,     0, "Sufijo pago cliente",                "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nNumMed",  "N",      1,     0, "Número de mediciones",               "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColTik, { "nMedUno",  "N",     16,     6, "Primera unidad de medición",         "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColTik, { "nMedDos",  "N",     16,     6, "Segunda unidad de medición",         "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColTik, { "nMedTre",  "N",     16,     6, "Tercera unidad de medición",         "MasUnd()",          "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCodInv",  "C",      2,     0, "Código invitación",                  "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nFcmCnv",  "N",     16,     6, "Factor de conversion para combinados","",                 "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCodUsr",  "C",      3,     0, "Código de usuario",                  "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lImpCom",  "L",      1,     0, "Lógico para comanda impresa",        "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nImpCom",  "N",     16,     6, "Numero de unidades impresas",        "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nImpCom1", "N",      1,     0, "Primera impresora comanda",          "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nImpCom2", "N",      1,     0, "Segunda impresora comanda",          "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cComent",  "C",    250,     0, "Comentario para el artículo",        "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cNomCmd",  "M",     10,     0, "Comentario para la comanda",         "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lInPromo", "L",      1,     0, "Lógico para linea en promoción",     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lArtServ", "L",      1,     0, "Lógico para artículo servido",       "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCodTImp", "C",      3,     0, "Codigo de tipo de comanda",          "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nOrTImp",  "N",      1,     0, "Orden de impresión tipo de comanda", "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cUnidad",  "C",      2,     0, "Unidades de venta",                  "" ,                 "", "( cDbfCol )" } )
   aAdd( aColTik, { "lDev",     "L",      1,     0, "Lógico para artículo devuelto",      "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cNumDev",  "C",     13,     0, "Número de devolución o vale",        "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nUndAnt",  "N",     16,     6, "Unidades anteriores",                "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lAnulado", "L",      1,     0, "Lógico línea anulada",               "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lLinOfe",  "L",      1,     0, "Línea con oferta",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cImpCom1", "C",     50,     0, "Primer tipo impresora comanda",      "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cImpCom2", "C",     50,     0, "Segundo tipo impresora comanda",     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "dFecTik",  "D",      8,     0, "Fecha del tiket",                    "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nCosTil",  "N",     16,     6, "Precio de costo de combinado",       "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cTxtInv",  "C",     30,     0, "Texto invitación",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cOrdOrd",  "C",      2,     0, "Código de orden de comanda",         "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cNomOrd",  "C",     30,     0, "Orden de comanda",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lDelTil",  "L",      1,     0, "Línea borrada",                      "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "dFecCad",  "D",      1,     0, "Fecha de caducidad",                 "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lMnuTil",  "L",      1,     0, "Línea de menú padre",                "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cCodMnu",  "C",      3,     0, "Código de menú",                     "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nLinMnu",  "N",      4,     0, "Número de linea de menú",            "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nComStk",  "N",      1,     0, "",                                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "tFecTik",  "C",      6,     0, "",                                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lPeso",    "L",      1,     0, "Lógico articulo con peso",           "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lSave",    "L",      1,     0, "",                                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lMnuAco",  "L",      1,     0, "Lógico menu acompañamiento",         "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nPosPrint","N",      4,     0, "Posición de impresión",              "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "uuid",     "C",     40,     0, "Uuui de la línea",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lComent",  "L",      1,     0, "Línea de comentario",                "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lValidado","L",      1,     0, "Lógico validado con consolidación",  "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "lDelete",  "L",      1,     0, "Marca línea de ticket eliminado",    "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "paruuid",  "C",     40,     0, "uuid de la cabecera",                "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "nPvpAnt",  "N",     16,     6, "Precio anterior",                    "",                  "", "( cDbfCol )" } )
   aAdd( aColTik, { "cNumAlb",  "C",     12,     0, "Número de albarán de procedencia",   "",                  "", "( cDbfCol )" } )

Return ( aColTik )



function aImpTik()

   local aImpTik  := {}

   aAdd( aImpTik, { "cSerTik",  "C",      1,    0, "Serie del tiket"                        } )
   aAdd( aImpTik, { "cNumTik",  "C",     10,    0, "Número del tiket"                       } )
   aAdd( aImpTik, { "cSufTik",  "C",      2,    0, "Sufijo del tiket"                       } )
   aAdd( aImpTik, { "lComanda", "L",      1,    0, "Lógio de comanda"                       } )
   aAdd( aImpTik, { "lImp",     "L",      1,    0, "Lógico de imprimido"                    } )
   aAdd( aImpTik, { "dFecTik",  "D",      8,    0, "Fecha mandado a impresion"              } )
   aAdd( aImpTik, { "cHorTik",  "C",      5,    0, "Hora mandado a impresion"               } )
   aAdd( aImpTik, { "dFTikImp", "D",      8,    0, "Fecha de impresion"                     } )
   aAdd( aImpTik, { "cHTikImp", "C",      5,    0, "Hora de impresion"                      } )

RETURN ( aImpTik )



function aSerTik()

   local aColTik  := {}

   aAdd( aColTik,  { "cSerTik", "C",      1,    0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColTik,  { "cNumTik", "C",     10,    0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColTik,  { "cSufTik", "C",      2,    0, "",                                 "",                  "", "( cDbfCol )" } )
   aAdd( aColTik,  { "cTipTil", "C",      1,    0, "Tipo de ticket",                   "",                  "", "( cDbfCol )" } )
   aAdd( aColTik,  { "dFecTik", "D",      8,    0, "Fecha de ticket",                  "",                  "", "( cDbfCol )" } )
   aAdd( aColTik,  { "nNumLin", "N",      4,    0, "Número de la línea",               "'9999'",            "", "( cDbfCol )" } )
   aAdd( aColTik,  { "cCbaTil", "C",     18,    0, "Referencia del artículo",          "",                  "", "( cDbfCol )" } )
   aAdd( aColTik,  { "cAlmLin", "C",     16,    0, "Almacen del artículo",             "",                  "", "( cDbfCol )" } )
   aAdd( aColTik,  { "lUndNeg", "L",      1,    0, "Lógico de valor absoluto",         "",                  "", "( cDbfCol )" } )
   aAdd( aColTik,  { "cNumSer", "C",     30,    0, "Número de serie",                  "",                  "", "( cDbfCol )" } )

return ( aColTik )





FUNCTION nTotTik( cNumTik, cTikT, cTikL, cDiv, aTmp, cDivRet, lPic, lExcCnt )

   local n
   local bCond
   local nRecLin
   local nDouDiv
   local cCodDiv
   local nVdvDiv
   local cTipTik
   local nOrdAnt
   local nTotLin        := 0
   local nBasLin        := 0
   local nBrtLin        := 0
   local nIvmLin        := 0
   local nNumCom        := 0
   local nDtoEsp        := 0
   local nDpp           := 0
   local nDescuentoEsp  := 0
   local nDescuentoPp   := 0

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;
   If( cTikL == nil, cTikL := dbfTikL, ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( cNumTik == nil, cNumTik := ( cTikT )->cSerTik + ( cTikT )->cNumTik + ( cTikT )->cSufTik, ) ;
   If( lPic == nil, lPic := .F., ) ;

   public nTotTik       := 0
   public nTotPrm       := 0
   public nTotPax       := 0
   public nTotDtoEsp    := 0
   public nTotDpp       := 0
   public nTotNet       := 0
   public nTotBrt       := 0
   public nTotIva       := 0
   public nTotIvm       := 0
   public aBrtTik       := { 0, 0, 0 }
   public aBasTik       := { 0, 0, 0 }
   public aImpTik       := { 0, 0, 0 }
   public aIvaTik       := { nil, nil, nil }
   public aIvmTik       := { 0, 0, 0 }
   public aTotIva       := { { 0,0,nil,0,0,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0,0,0 }, { 0,0,nil,0,0,0,0,0,0,0,0 } }
   public nTotCos       := 0
   public nTotRnt       := 0
   public nTotPctRnt    := 0

   nRecLin              := ( cTikL )->( Recno() )

   if aTmp <> nil
      cCodDiv           := aTmp[ 24 ]
      nVdvDiv           := aTmp[ 25 ]
      cTipTik           := aTmp[ 4 ]
      nNumCom           := aTmp[ 52 ]
      nDtoEsp           := aTmp[ 58 ]
      nDpp              := aTmp[ 60    ]
      bCond             := {|| !( cTikL )->( eof() ) }
      ( cTikL )->( dbGoTop() )
   else
      cCodDiv           := ( cTikT )->cDivTik
      nVdvDiv           := ( cTikT )->nVdvTik
      cTipTik           := ( cTikT )->cTipTik
      nNumCom           := ( cTikT )->nNumCom
      nDtoEsp           := ( cTikT )->nDtoEsp
      nDpp              := ( cTikT )->nDpp
      bCond             := {|| ( cTikL )->cSerTil + ( cTikL )->cNumTil + ( cTikL )->cSufTil == cNumTik .AND. !( cTikL )->( eof() ) }
      nOrdAnt           := ( cTikL )->( ordsetfocus( "cNumTil" ) )
      ( cTikL )->( dbSeek( cNumTik ) )
   end

   nDouDiv              := nDouDiv( cCodDiv, cDiv )
   nDorDiv              := nRouDiv( cCodDiv, cDiv )
   cPorDiv              := cPorDiv( cCodDiv, cDiv )

   while Eval( bCond )

      if lValLine( cTikL ) .AND. !( cTikL )->lFreTil .AND. !( cTikL )->lDelTil



         if ( lExcCnt == nil                                .OR. ( lExcCnt .AND. ( cTikL )->nCtlStk <> 2 )       .OR. (!lExcCnt .AND. ( cTikL )->nCtlStk == 2 ) )

            nTotLin           := nTotLTpv( cTikL, nDouDiv, nDorDiv )

            if nDtoEsp <> 0
               nDescuentoEsp  := ( nTotLin * nDtoEsp ) / 100
            else
               nDescuentoEsp  := 0
            end

            if nDpp <> 0
               nDescuentoPp   := ( nTotLin * nDpp ) / 100
            else
               nDescuentoPp   := 0
            end

            nIvmLin           := nIvmLTpv( cTikL, nDouDiv, nDorDiv )
            nBasLin           := nTotLin - nDescuentoEsp - nDescuentoPp

            if ( cTikL )->nIvaTil <> 0

               if uFieldEmpresa( "lIvaImpEsp" )
                  nBasLin     := ( nTotLin ) / ( 1 + ( ( cTikL )->nIvaTil / 100 ) )
                  nBasLin     -= nIvmLin
               else
                  nBasLin     := ( nTotLin - nIvmLin ) / ( 1 + ( ( cTikL )->nIvaTil / 100 ) )
               end

            else
               nBasLin        := nTotLin
            end

            do case
            case aIvaTik[ 1 ] == nil .OR. aIvaTik[ 1 ] == ( cTikL )->nIvaTil

               aIvaTik[ 1 ]   := ( cTikL )->nIvaTil
               aBrtTik[ 1 ]   += nTotLin
               aBasTik[ 1 ]   += nBasLin
               aImpTik[ 1 ]   += ( nTotLin - nIvmLin - nBasLin )
               aIvmTik[ 1 ]   += nIvmLin

            case aIvaTik[ 2 ] == nil .OR. aIvaTik[ 2 ] == ( cTikL )->nIvaTil

               aIvaTik[ 2 ]   := ( cTikL )->nIvaTil
               aBrtTik[ 2 ]   += nTotLin
               aBasTik[ 2 ]   += nBasLin
               aImpTik[ 2 ]   += ( nTotLin - nIvmLin - nBasLin )
               aIvmTik[ 2 ]   += nIvmLin

            case aIvaTik[ 3 ] == nil .OR. aIvaTik[ 3 ] == ( cTikL )->nIvaTil

               aIvaTik[ 3 ]   := ( cTikL )->nIvaTil
               aBrtTik[ 3 ]   += nTotLin
               aBasTik[ 3 ]   += nBasLin
               aImpTik[ 3 ]   += ( nTotLin - nIvmLin - nBasLin )
               aIvmTik[ 3 ]   += nIvmLin

            end

            nTotTik           += nTotLin
            nTotDtoEsp        += nDescuentoEsp
            nTotDpp           += nDescuentoPp

            nTotCos           += nCosLTpv( cTikL, nDouDiv, nDorDiv )

            if ( cTikL )->lInPromo
               nTotPrm        += nTotLin - nDescuentoEsp - nDescuentoPp
            end

         end

      end

      ( cTikL )->( dbskip() )

   end

   nTotBrt           := aBrtTik[ 1 ] + aBrtTik[ 2 ] + aBrtTik[ 3 ]
   nTotNet           := aBasTik[ 1 ] + aBasTik[ 2 ] + aBasTik[ 3 ]
   nTotIva           := aImpTik[ 1 ] + aImpTik[ 2 ] + aImpTik[ 3 ]
   nTotIvm           := aIvmTik[ 1 ] + aIvmTik[ 2 ] + aIvmTik[ 3 ]





   nTotTik           -= nTotDtoEsp
   nTotTik           -= nTotDpp





   nTotPax           := nTotTik / NotCero( nNumCom )





   nTotRnt           := Round( nTotNet - nTotCos, nDorDiv )

   nTotPctRnt        := nRentabilidad( nTotNet, 0, nTotCos )





   nTotTik           := Round( nTotTik, nDorDiv )





   for n := 1 to len( aBrtTik )

      aTotIva[ n, 1 ]   := aBrtTik[n]
      aTotIva[ n, 2 ]   := aBasTik[n]
      aTotIva[ n, 3 ]   := aIvaTik[n]
      aTotIva[ n, 6 ]   := aIvmTik[n]
      aTotIva[ n, 8 ]   := aImpTik[n]

   next





   if !empty( nOrdAnt )
      ( cTikL )->( ordsetfocus( nOrdAnt ) )
   end

   ( cTikL )->( dbGoTo( nRecLin ) )

RETURN ( if( lPic, Trans( nTotTik, cPorDiv ), nTotTik ) )








FUNCTION nIvmLTpv( dbfTmpL, nDec, nRou, nVdv )

   local nCalculo    := 0

   If( dbfTmpL == nil, dbfTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRou == nil, nRou := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 1, ) ;





   if !( dbfTmpL )->lFreTil
      nCalculo       := ( dbfTmpL )->nValImp
      nCalculo       *= nTotNTpv( dbfTmpL )
   end

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nRou ) )







FUNCTION nTotLTpv( uTmpL, nDec, nRouDec, nVdv )

   local nCalculo := nTotLUno( uTmpL, nDec, nRouDec, nVdv )
   nCalculo       += nTotLDos( uTmpL, nDec, nRouDec, nVdv )

RETURN ( nCalculo )



Function nTotLDos( uTmpL, nDec, nRouDec, nVdv )

   local nCalculo    := 0

   If( uTmpL == nil, uTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRouDec == nil, nRouDec := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 0, ) ;





   do case
   case ValType( uTmpL ) == "C"

      if !( uTmpL )->lFreTil

         nCalculo    := Round( ( uTmpL )->nPcmTil, nDec )
         nCalculo    *= nTotNTpv( uTmpL )

      end

   otherwise

      if !uTmpL:lFreTil

         nCalculo    := Round( uTmpL:nPcmTil, nDec )
         nCalculo    *= nTotNTpv( uTmpL )

      end

   end

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nRouDec ) )



Function nTotLUno( uTmpL, nDec, nRouDec, nVdv )

   local nCalculo    := 0

   If( uTmpL == nil, uTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRouDec == nil, nRouDec := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 0, ) ;





   do case
   case ValType( uTmpL ) == "C"

      if !( uTmpL )->lFreTil

         nCalculo       := Round( ( uTmpL )->nPvpTil, nDec )

         if ( uTmpL )->nDtoLin <> 0
            nCalculo    -= ( uTmpL )->nDtoLin * nCalculo / 100
         end

         nCalculo       *= nTotNTpv( uTmpL )

         nCalculo       -= Round( ( uTmpL )->nDtoDiv, nDec )

      end

   otherwise

      if !uTmpL:lFreTil

         nCalculo       := Round( uTmpL:nPvpTil, nDec )

         if uTmpL:nDtoLin <> 0
            nCalculo    -= uTmpL:nDtoLin * nCalculo / 100
         end

         nCalculo       *= nTotNTpv( uTmpL )

         nCalculo       -= Round( uTmpL:nDtoDiv, nDec )

      end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nRouDec ) )



Function nDtoLTpv( uTmpL, nDec, nRouDec, nVdv )

   local nCalculo    := 0

   If( uTmpL == nil, uTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRouDec == nil, nRouDec := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 0, ) ;





   do case
   case ValType( uTmpL ) == "C"

      if !( uTmpL )->lFreTil .AND. ( uTmpL )->nDtoLin <> 0

         nCalculo       := Round( ( uTmpL )->nPvpTil, nDec )

         nCalculo       *= nTotNTpv( uTmpL )

         nCalculo       := ( uTmpL )->nDtoLin * nCalculo / 100

      end

   otherwise

      if !uTmpL:lFreTil .AND. uTmpL:nDtoLin <> 0

         nCalculo       := Round( uTmpL:nPvpTil, nDec )

         nCalculo       *= nTotNTpv( uTmpL )

         nCalculo       := uTmpL:nDtoLin * nCalculo / 100

      end

   end

   if nVdv <> 0
      nCalculo          := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nRouDec ) )



Function nCosLTpv( uTmpL, nDec, nRouDec, nVdv, nPrc )

   local nCalculo    := 0

   If( uTmpL == nil, uTmpL := dbfTikL, ) ;
   If( nDec == nil, nDec := nDouDiv(), ) ;
   If( nRouDec == nil, nRouDec := nRouDiv(), ) ;
   If( nVdv == nil, nVdv := 0, ) ;
   If( nPrc == nil, nPrc := 0, ) ;





   do case
   case IsChar( uTmpL )

      if nPrc == 0 .OR. nPrc == 1
         nCalculo    += Round( ( uTmpL )->nCosDiv, nDec )
      end

      if nPrc == 0 .OR. nPrc == 2
         nCalculo    += Round( ( uTmpL )->nCosTil, nDec )
      end

   case IsObject( uTmpL )

      if nPrc == 0 .OR. nPrc == 1
         nCalculo    += Round( uTmpL:nCosDiv, nDec )
      end

      if nPrc == 0 .OR. nPrc == 2
         nCalculo    += Round( uTmpL:nCosTil, nDec )
      end

   end

   nCalculo          *= nTotNTpv( uTmpL )

   if nVdv <> 0
      nCalculo       := nCalculo / nVdv
   end

RETURN ( Round( nCalculo, nRouDec ) )







FUNCTION nTotNTpv( uTmpL, cMasUnd )

   local nTotNTpv

   If( uTmpL == nil, uTmpL := dbfTikL, ) ;

   do case
   case ValType( uTmpL ) == "A"
      nTotNTpv    := uTmpL[ 8 ]
      nTotNTpv    *= NotCero( uTmpL[ 9 ] )

   case ValType( uTmpL ) == "C"
      nTotNTpv    := ( uTmpL )->nUntTil
      nTotNTpv    *= NotCero( ( uTmpL )->nUndKit )

   otherwise
      nTotnTpv    := uTmpL:nUntTil
      nTotnTpv    *= NotCero( uTmpL:nUndKit )

   end

RETURN ( if( cMasUnd <> nil, Trans( nTotNTpv, cMasUnd ), nTotNTpv ) )






FUNCTION nTotNComandas()

   local nTotNTpv    := 0

   if !empty( dbfTmpC )
      nTotNTpv       := ( dbfTmpC )->nUntTil
      nTotNTpv       *= NotCero( ( dbfTmpC )->nUndKit )
      RETURN ( nTotNTpv )
   end

   if !empty( dbfTikL )
      nTotNTpv       := ( dbfTikL )->nUntTil
      nTotNTpv       *= NotCero( ( dbfTikL )->nUndKit )
   end

RETURN ( nTotNTpv )






Function nTotNTickets( cTikL )

   local nTotNTickets   := 0

   If( cTikL == nil, cTikL := dbfTikL, ) ;

   if ( ( cTikL )->cTipTil == "1" .OR. ( cTikL )->cTipTil == "5" )
      nTotNTickets      := ( cTikL )->nUntTil
   else
      nTotNTickets      := - ( cTikL )->nUntTil
   end

Return ( nTotNTickets )






STATIC FUNCTION lRecTotal( aTmp, lRefreshTotal )

   local nTotal

   If( lRefreshTotal == nil, lRefreshTotal := .T., ) ;

   nTotal                  := nTotTik( aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ], D():tikets( nView ), dbfTmpL, dbfDiv, aTmp, nil, .F. )

   if oTotEsp <> nil
      oTotEsp:Refresh()
   end

   if oTotDpp <> nil
      oTotDpp:Refresh()
   end

   if lRefreshTotal

      if oNumTot <> NIL
         oNumTot:SetText( Trans( nTotal, cPorDiv ) )
      end

   end

   if oTotPdaFam <> NIL
      oTotPdaFam:SetText( Trans( nTotal, cPorDiv ) )
   end

   if oEurTot <> NIL
      oEurTot:SetText( Trans( nCnv2Div( nTotal, aTmp[ 24 ], cDivChg() ), cPicEur ) )
   end

   if lRefreshTotal

      if oTxtTot <> NIL
         oTxtTot:SetText( "Total" )
      end

   end

   if oTxtCom <> nil
      oTxtCom:SetText( "Comensales: " + AllTrim( Str( aTmp[ 52 ] ) ) )
   end

   if oTotCom <> nil
      oTotCom:SetText( AllTrim( Trans( nTotal / NotCero( aTmp[ 52 ] ), cPorDiv ) ) + " pax." )
   end

   if oGetRnt <> nil
      oGetRnt:SetText( AllTrim( Trans( nTotRnt, cPorDiv ) + Space( 1 ) + " : " + AllTrim( Trans( nTotPctRnt, "999.99" ) ) + "%" ) )
   end

RETURN .T.





Function nTotCobTik( cNumTik, dbfTikP, dbfDiv, cDivRet, lPic )

   local bCon
   local cPorDiv
   local nDorDiv
   local nTotal      := 0
   local cCodDiv     := ( dbfTikP )->cDivPgo
   local aSta        := aGetStatus( dbfTikP, .T. )

   If( lPic == nil, lPic := .F., ) ;

   if cNumTik == nil
      bCon           := {|| !( dbfTikP )->( eof() ) }
      ( dbfTikP )->( dbGoTop() )
   else
      bCon           := {|| ( dbfTikP )->cSerTik + ( dbfTikP )->cNumTik + ( dbfTikP )->cSufTik == cNumTik .AND. !( dbfTikP )->( eof() ) }
      ( dbfTikP )->( dbSeek( cNumTik ) )
   end

   cPorDiv           := cPorDiv( cCodDiv, dbfDiv )
   nDorDiv           := nRouDiv( cCodDiv, dbfDiv )

   while Eval( bCon )
      nTotal         += nTotUCobTik( dbfTikP, nDorDiv )
      ( dbfTikP )->( dbSkip() )
   end

   nTotal            := Round( nTotal, nDorDiv )

   SetStatus( dbfTikP, aSta )

   if cDivRet <> nil .AND. cCodDiv <> cDivRet
      cPorDiv        := cPorDiv( cDivRet, dbfDiv )
      nTotal         := nCnv2Div( nTotal, cCodDiv, cDivRet )
   end

Return ( if( lPic, Trans( nTotal, cPorDiv ), nTotal ) )



Function nTotUCobTik( dbfTikP, nDorDiv, nVdv )

   local nTotCob  := 0

   If( nVdv == nil, nVdv := 1, ) ;

   do case
      case ValType( dbfTikP ) == "C"
         nTotCob  := ( dbfTikP )->nImpTik - ( dbfTikP )->nDevTik
      case ValType( dbfTikP ) == "O"
         nTotCob  := dbfTikP:nImpTik - dbfTikP:nDevTik
   end

   if nDorDiv <> nil
      nTotCob     := Round( nTotCob, nDorDiv )
   end

   if nVdv <> 0
      nTotCob     := nTotCob / nVdv
   end

Return ( nTotCob )



Static Function ChangeComentarios( cComentariosT, cComentariosL, oBrwLineasComentarios )

   If( cComentariosT == nil, cComentariosT := dbfComentariosT, ) ;
   If( cComentariosL == nil, cComentariosL := dbfComentariosL, ) ;





   ( cComentariosL )->( OrdScope( 0, ( cComentariosT )->cCodigo ) )
   ( cComentariosL )->( OrdScope( 1, ( cComentariosT )->cCodigo ) )





   oBrwLineasComentarios:GoTop()
   oBrwLineasComentarios:Select( 0 )
   oBrwLineasComentarios:Select( 1 )
   oBrwLineasComentarios:Refresh( .T. )

return nil



Static Function ChangeLineasComentarios( oGetComentario, cComentariosL )

   local cText

   If( cComentariosL == nil, cComentariosL := dbfComentariosL, ) ;

   cText                   := AllTrim( oGetComentario:VarGet() )

   if empty( cText )
      cText                := AllTrim( ( cComentariosL )->cDescri )
   else
      cText                += ", " + AllTrim( ( cComentariosL )->cDescri )
   end

   oGetComentario:cText( Padr( cText, 250 ) )

Return ( nil )



Static Function EndComentario( oDlg, dbfTmpL, oGetComentario )

   local cText             := oGetComentario:VarGet()

   if dbLock( dbfTmpL )
      ( dbfTmpL )->cComent := AllTrim( cText )
      ( dbfTmpL )->( dbUnLock() )
   end

   oDlg:End( 1 )

return ( nil )



Static Function YearComboBoxChange()

   if ( oWndBrw:oWndBar:cYearComboBox() <> "[Todos]" )
      oWndBrw:oWndBar:setYearComboBoxExpression( "Year( Field->dFecTik ) == " + oWndBrw:oWndBar:cYearComboBox() )
   else
      oWndBrw:oWndBar:setYearComboBoxExpression( "" )
   end

   oWndBrw:chgFilter()

Return nil



FUNCTION cUpSerie( cSer )

   local nAsc
   local cChr

   if empty( cSer ) .OR. cSer < "A"
      cSer     := "A"
      nAsc     := Asc( cSer )
   else
      nAsc     := Asc( cSer ) + 1
   end

   cChr        := Chr( nAsc )

   if cChr > "Z"
      cChr     := "Z"
   end

return cChr



FUNCTION cDwSerie( cSer )

   local nAsc
   local cChr
   local cSerie

   nAsc        := Asc( cSer ) - 1
   cChr        := Chr( nAsc )

   if cChr < "A"
      cChr     := "A"
   end

return cChr



Static Function SetLostFocusOn()

   oDlgDet:Cargo           := .T.

Return ( .T. )



Static Function SetLostFocusOff()

   oDlgDet:Cargo           := .F.

Return ( .T. )



Static Function getLostFocus()

Return ( isLogic( oDlgDet:Cargo ) .AND. ( oDlgDet:Cargo ) )



Static Function dlgLostFocus( nMode, aTmp )

   if getLostFocus()
      if ( nMode <> 1 ) .OR. ( empty( aTmp[ 5 ] ) .AND. empty( aTmp[ 6 ] ) )
         oDlgDet:End()
      end
   end

Return ( .T. )





Static Function lFidelity( aGet, aTmp, nMode )

   local oDlg

   if !uFieldEmpresa( "lFidelity" )
      return .F.
   end

   if nMode <> 1
      return .F.
   end

   if !empty( aTmp[ 11 ] ) .AND. ( aTmp[ 11 ] <> cDefCli() )
      return .F.
   end

   oDlg  := TDialog():New( , , , , , "Fidelity" )

      TBitmap():ReDefine( 600, "gc_id_card_transp_48", , oDlg,)

      ApoloBtnBmp():Redefine( 500, "gc_id_card_32", , , , , {|| oDlg:end( 1 ), if( !empty( aGet[ 11 ] ), aGet[ 11 ]:SetFocus(), ) }, oDlg, , , .F., .F., "Si. [ F5 ]", ,,, .T., "TOP", .T., , , .F., )

      ApoloBtnBmp():Redefine( 510, "gc_id_card_delete_32", , , , , {|| oDlg:end( 1 ), appCli( .F. ) }, oDlg, , , .F., .F., "No, pero deseo tenerla. [ F6 ]", ,,, .T., "TOP", .T., , , .F., )

      ApoloBtnBmp():Redefine( 2, "Del32", , , , , {|| oDlg:end() }, oDlg, , , .F., .F., "Gracias, en otra ocasión. [ ESC ]", ,,, .T., "TOP", .T., , , .F., )

      oDlg:AddFastKey( 116, {|| oDlg:end( 1 ), aGet[ 11 ]:SetFocus()} )
      oDlg:AddFastKey( 117, {|| oDlg:end( 1 ), appCli( .F. ) } )

   oDlg:Activate( , , , .T. )

Return ( oDlg:nResult == 1 )



Static Function GetVale( oBrwVal, aTmp )

   local oDlg
   local oGet
   local lError   := .F.
   local cGet     := Space( 13 )
   local cCodCli  := aTmp[ 11 ]
   local nRecAnt  := ( D():tikets( nView ) )->( RecNo() )
   local nOrdAnt  := ( D():tikets( nView ) )->( ordsetfocus( "cLiqVal" ) )
   local cTyp     := ( D():tikets( nView ) )->( dbOrderInfo( 24 ) )
   local nRec     := ( dbfTmpV )->( RecNo() )

   oDlg = TDialog():New(,,,,, "GetVale",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )




      oGet := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, cGet, cGet:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




      TButton():ReDefine( ( 1 ), {||oDlg:end( 1 )}, oDlg,,, .F.,,,, .F. )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      if lBigSeek( nil, Upper( cGet ), D():tikets( nView ) )





         ( dbfTmpV )->( __dbLocate( {|| ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik == ( dbfTmpV )->cSerTik + ( dbfTmpV )->cNumTik + ( dbfTmpV )->cSufTik } ) )

         if !( dbfTmpV )->( Found() )

            if ( D():tikets( nView ) )->dFecTik + uFieldEmpresa( "nDiaVale" ) > GetSysDate()
               lError   := .T.
               MsgStop( "El vale introducido no han alcanzado la fecha para su liquidación." )
            end

            if ( D():tikets( nView ) )->cCliTik <> cCodCli
               lError   := .T.
               MsgStop( "El vale introducido pertenece a otro cliente." )
            end

            if !lError

               dbPass( D():tikets( nView ), dbfTmpV, .T. )

               if dbLock( D():tikets( nView ) )
                  ( D():tikets( nView ) )->lSelDoc := .F.
                  ( D():tikets( nView ) )->( dbUnLock() )
               end

            end

         else

            MsgStop( "Vale ya incorporado." )

         end

      else

         MsgStop( "Vale no encontrado." )

      end

   end





   ( D():tikets( nView ) )->( ordsetfocus( nOrdAnt ) )
   ( D():tikets( nView ) )->( dbGoTo( nRecAnt ) )

   ( dbfTmpV )->( dbGoTo( nRec ) )





   if oBrwVal <> nil
      oBrwVal:Refresh()
   end

Return .F.



Function EINFTDIAACTUACIONES()

Return nil



Static Function AgruparAlbaranes( aTmp, aGet, oBrwDet )

   local oDlg
   local oBmp
   local oTitle1
   local oTitle2

   if Empty( aTmp[11] )
      MsgStop( "Tiene que seleccionar un cliente para agrupar sus albaranes" )
      aGet[11]:SetFocus()
      Return .F.
   end

   if ( dbfTmpL )->( ordKeyCount() ) > 0
      Return .F.
   end

   aAlbaranes           := AlbaranesClientesModel():ListNoFacturados( aTmp[11], aTmp[35] )
   aEval( aAlbaranes, {|h| hSet( h, "LSNDDOC", .T. ) } )

   if Len( aAlbaranes ) == 0
      MsgStop( "El cliente seleccionado no tiene albaranes por facturar" )
      aGet[11]:SetFocus()
      Return .F.
   end



   oDlg = TDialog():New(,,,, "Agrupando albaranes de clientes", "SET_ALBARAN_SIMPLIFICADA",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmp := TBitmap():ReDefine( 500, "gc_document_text_gear_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )



      oTitle1 := TSay():ReDefine( 501, {|| rTrim( aTmp[13] )}, oDlg,,,, .F.,, .F., .F., )



      oTitle2 := TSay():ReDefine( 502, {|| if( empty( aTmp[35] ), "TODAS", aTmp[35] )}, oDlg,,,, .F.,, .F., .F., )





      oBrwDet                        := IXBrowse():New( oDlg )

      oBrwDet:bClrSel                := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrwDet:bClrSelFocus           := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrwDet:nMarqueeStyle          := 5
      oBrwDet:lRecordSelector        := .F.
      oBrwDet:lHscroll               := .F.
      oBrwDet:lFooter                := .T.
      oBrwDet:cName                  := "AgruparAlbaranEnTiket"

      oBrwDet:SetArray( aAlbaranes, .T., , .F. )

      oBrwDet:CreateFromResource( 130 )

      oBrwDet:bLDblClick   := {|| hSet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "LSNDDOC", !hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "LSNDDOC" ) ), oBrwDet:Refresh() }

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Seleccionado"
         :cSortOrder       := 1
         :bStrData         := {|| "" }
         :bEditValue       := {|| hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "LSNDDOC" ) }
         :nWidth           := 20
         :SetCheck( { "Sel16", "Nil16" } )
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Número"
         :cSortOrder       := 2
         :bEditValue       := {|| hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "CSERALB" ) + "/" + AllTrim( str( hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "NNUMALB" ) ) ) + "/" + hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "CSUFALB" ) }
         :nWidth           := 120
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Fecha"
         :cSortOrder       := 4
         :bEditValue       := {|| Dtoc( hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "DFECALB" ) ) }
         :nWidth           := 120
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Cliente"
         :cSortOrder       := 5
         :bEditValue       := {|| AllTrim( hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "CCODCLI" ) ) + Space(1) + AllTrim( hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "CNOMCLI" ) ) }
         :nWidth           := 450
      end

      with object ( oBrwDet:AddCol() )
         :cHeader          := "Total"
         :bEditValue       := {|| AllTrim( Trans( hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "NTOTALB" ), cPorDiv ) ) }
         :nWidth           := 120
         :nDataStrAlign    := 1
         :nHeadStrAlign    := 1
      end




      TButton():ReDefine( 516, {||(  aEval( aAlbaranes, {|h| hSet( h, "LSNDDOC", .T. ) } ), oBrwDet:Refresh() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 517, {||(  aEval( aAlbaranes, {|h| hSet( h, "LSNDDOC", .F. ) } ), oBrwDet:Refresh() )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 518, {||( ZooAlbCli( hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "CSERALB" ) + str( hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "NNUMALB" ) ) + hGet( oBrwDet:aArrayData[ oBrwDet:nArrayAt ], "CSUFALB" ) ) )}, oDlg,,, .F.,,,, .F. )




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:AddFastKey( 116, {|| oDlg:end( 1 ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if oDlg:nResult == 1

      msgrun( "Procesando albaranes de clientes seleccionados", "Espere por favor...",  {|| aEval( aAlbaranes, {|h| if( hGet( h, "LSNDDOC" ), insertAlbaran( h, aTmp ), ) } ) } )

      oCaptura:CreateColumns( cCapCaj, oBrwDet )

      lRecTotal( aTmp )

   end

Return nil



Static Function insertAlbaran( hAlbaran, aTmp )

   local cDesAlb
   local aLines                  := {}
   local hLine





   if lNumAlb() .OR. lNumObr() .OR. lSuAlb()

      cDesAlb                    := ""
      if lNumObr()
         cDesAlb                 += Alltrim( cNumObr() ) + " " + StrTran( hGet( hAlbaran, "CCODOBR" ), " ", "" ) + Space( 1 )
         cDesAlb                 += if( !empty( hGet( hAlbaran, "CCODOBR" ) ), AllTrim( RetFld( hGet( hAlbaran, "CCODCLI" ) + hGet( hAlbaran, "CCODOBR" ), dbfObrasT, "cNomObr" ) ), "" )
      end
      if lNumAlb()
         cDesAlb                 += Alltrim( cNumAlb() ) + " " + hGet( hAlbaran, "CSERALB" ) + "/" + AllTrim( Str( hGet( hAlbaran, "NNUMALB" ) ) ) + "/" + hGet( hAlbaran, "CSUFALB" ) + Space( 1 )
      end
      if lSuAlb()
         cDesAlb                 += Alltrim( cSuAlb()  ) + " " + StrTran( hGet( hAlbaran, "CCODSUALB" ), " ", "" ) + Space( 1 )
      end
      cDesAlb                    += " - Fecha " + Dtoc( hGet( hAlbaran, "DFECALB" ) )

      ( dbfTmpL )->( dbAppend() )

      ( dbfTmpL )->cTipTil       := "1"
      ( dbfTmpL )->cCbaTil       := Space( 18 )
      ( dbfTmpL )->cNomTil       := cDesAlb
      ( dbfTmpL )->cAlmLin       := aTmp[ 10 ]
      ( dbfTmpL )->lImpLin       := .T.
      ( dbfTmpL )->lControl      := .T.
      ( dbfTmpL )->cCodUsr       := Auth():Codigo()
      ( dbfTmpL )->dFecTik       := aTmp[ 6 ]
      ( dbfTmpL )->lDelTil       := .F.
      ( dbfTmpL )->tFecTik       := aTmp[ 71 ]
      ( dbfTmpL )->uuid          := win_uuidcreatestring()
      ( dbfTmpL )->lDelete       := .F.
      ( dbfTmpL )->paruuid       := aTmp[ 72 ]
      ( dbfTmpL )->nNumLin       := nLastNum( dbfTmpL )
      ( dbfTmpL )->nPosPrint     := nLastNum( dbfTmpL, "nPosPrint" )
      ( dbfTmpL )->cNumAlb       := hGet( hAlbaran, "CSERALB" ) + Str( hGet( hAlbaran, "NNUMALB" ) ) + hGet( hAlbaran, "CSUFALB" )

      ( dbfTmpL )->( dbUnLock() )

   end





   aLines                        := AlbaranesClientesLineasModel():aLines( hGet( hAlbaran, "CSERALB" ) + Str( hGet( hAlbaran, "NNUMALB" ) ) + hGet( hAlbaran, "CSUFALB" ) )

   if Len( aLines ) > 0

      for each hLine in aLines

         ( dbfTmpL )->( dbAppend() )

         ( dbfTmpL )->cTipTil       := "1"
         ( dbfTmpL )->cCbaTil       := hGet( hLine, "CREF" )
         ( dbfTmpL )->cNomTil       := if( !Empty( hGet( hLine, "CREF" ) ), hGet( hLine, "CDETALLE" ), hGet( hLine, "MLNGDES" ) )
         ( dbfTmpL )->nPvpTil       := hGet( hLine, "NPREUNIT" )
         ( dbfTmpL )->nUntTil       := hGet( hLine, "NUNICAJA" )
         ( dbfTmpL )->nUndKit       := hGet( hLine, "NUNDKIT" )
         ( dbfTmpL )->nIvaTil       := hGet( hLine, "NIVA" )
         ( dbfTmpL )->nDtoLin       := hGet( hLine, "NDTO" )
         ( dbfTmpL )->cCodPr1       := hGet( hLine, "CCODPR1" )
         ( dbfTmpL )->cCodPr2       := hGet( hLine, "CCODPR2" )
         ( dbfTmpL )->cValPr1       := hGet( hLine, "CVALPR1" )
         ( dbfTmpL )->cValPr2       := hGet( hLine, "CVALPR2" )
         ( dbfTmpL )->nFacCnv       := hGet( hLine, "NFACCNV" )
         ( dbfTmpL )->nDtoDiv       := hGet( hLine, "NDTODIV" )
         ( dbfTmpL )->nCtlStk       := hGet( hLine, "NCTLSTK" )
         ( dbfTmpL )->cAlmLin       := hGet( hLine, "CALMLIN" )
         ( dbfTmpL )->nValImp       := hGet( hLine, "NVALIMP" )
         ( dbfTmpL )->cCodImp       := hGet( hLine, "CCODIMP" )
         ( dbfTmpL )->nCosDiv       := hGet( hLine, "NCOSDIV" )
         ( dbfTmpL )->nNumLin       := nLastNum( dbfTmpL )
         ( dbfTmpL )->lKitArt       := hGet( hLine, "LKITART" )
         ( dbfTmpL )->lKitChl       := hGet( hLine, "LKITCHL" )
         ( dbfTmpL )->lKitPrc       := hGet( hLine, "LKITPRC" )
         ( dbfTmpL )->lImpLin       := hGet( hLine, "LIMPLIN" )
         ( dbfTmpL )->nMesGrt       := hGet( hLine, "NMESGRT" )
         ( dbfTmpL )->lControl      := hGet( hLine, "LCONTROL" )
         ( dbfTmpL )->cCodFam       := hGet( hLine, "CCODFAM" )
         ( dbfTmpL )->cGrpFam       := hGet( hLine, "CGRPFAM" )
         ( dbfTmpL )->nLote         := hGet( hLine, "NLOTE" )
         ( dbfTmpL )->cLote         := hGet( hLine, "CLOTE" )
         ( dbfTmpL )->nNumMed       := hGet( hLine, "NNUMMED" )
         ( dbfTmpL )->nMedUno       := hGet( hLine, "NMEDUNO" )
         ( dbfTmpL )->nMedDos       := hGet( hLine, "NMEDDOS" )
         ( dbfTmpL )->nMedTre       := hGet( hLine, "NMEDTRE" )
         ( dbfTmpL )->cCodUsr       := Auth():Codigo()
         ( dbfTmpL )->cUnidad       := hGet( hLine, "CUNIDAD" )
         ( dbfTmpL )->dFecTik       := aTmp[ 6 ]
         ( dbfTmpL )->lDelTil       := .F.
         ( dbfTmpL )->dFecCad       := hGet( hLine, "DFECCAD" )
         ( dbfTmpL )->tFecTik       := aTmp[ 71 ]
         ( dbfTmpL )->nPosPrint     := nLastNum( dbfTmpL, "NPOSPRINT" )
         ( dbfTmpL )->uuid          := win_uuidcreatestring()
         ( dbfTmpL )->lDelete       := .F.
         ( dbfTmpL )->paruuid       := aTmp[ 72 ]
         ( dbfTmpL )->cNumAlb       := hGet( hAlbaran, "CSERALB" ) + Str( hGet( hAlbaran, "NNUMALB" ) ) + hGet( hAlbaran, "CSUFALB" )

         ( dbfTmpL )->( dbUnLock() )

      next

   end

Return nil



Static Function AsistenteDevolucionTiket( aTmp, aGet, nMode, lDevolucion )

   local o
   local oDlg
   local oBmp
   local dbfTmp
   local oBrwDev
   local oNumero
   local cNumero
   local cNewFil
   local nTotSel

   nTotSel        := 0

   cNewFilL       := cGetNewFileName( cPatTmp() + "TikLDEV" )

   dbCreate( cNewFilL, aSqlStruct( aColTik() ), cLocalDriver() )

   dbUseArea( .T., cLocalDriver(), cNewFilL, cCheckArea( "TikL", @dbfTmp ), .F. )
   if !NetErr()
      ( dbfTmp )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
      ( dbfTmp )->( OrdCreate( cNewFilL, "Recno", "Str( Recno() )", {|| Str( Recno() ) } ) )
   end

   oDlg = TDialog():New(,,,,, "ASSVALEDEVOLUCION",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmp := TBitmap():ReDefine( 500, "gc_cash_register_delete_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )









      oNumero := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cNumero, cNumero:= u ) }, oDlg,, "@!", {||       ( validaDevolucionTiket( oNumero, oBrwDev, aTmp, aGet, oDlg, dbfTmp ) )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( brwTikCli( oNumero ) )}, nil, "LUPA",, )




      oBrwDev                    := IXBrowse():New( oDlg )

      oBrwDev:lFooter            := .T.
      oBrwDev:bClrStd            := {|| if( ( dbfTmp )->nUntTil > 0, { 0, GetSysColor( 5 ) }, { 8421504, GetSysColor( 5 ) } ) }
      oBrwDev:bClrSel            := {|| if( ( dbfTmp )->nUntTil > 0, { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) }, { 8421504, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } ) }
      oBrwDev:bClrSelFocus       := {|| if( ( dbfTmp )->nUntTil > 0, { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) }, { 8421504, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } ) }
      oBrwDev:Cargo              := {}
      oBrwDev:nMarqueeStyle      := 5

      oBrwDev:cAlias             := dbfTmp

      with object ( oBrwDev:AddCol() )
         :cHeader                := ""
         :bEditValue             := {|| aScan( oBrwDev:Cargo, Eval( oBrwDev:bBookMark ) ) > 0 }
         :nWidth                 := 20
         :SetCheck( { "Sel16", "Nil16" }, {|| SelectLinea( @nTotSel, dbfTmp, oBrwDev ) } )
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Código"
         :bEditValue             := {|| ( dbfTmp )->cCbaTil }
         :nWidth                 := 60
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Und."
         :bEditValue             := {|| ( dbfTmp )->nUntTil }
         :cEditPicture           := cPicUnd
         :nWidth                 := 40
         :nEditType              := 1
         :nDataStrAlign          := 1
         :nHeadStrAlign          := 1
         :bOnPostEdit            := {|o,x| if( x <= ( dbfTmp )->nUntTil .AND. x > 0, ( dbfTmp )->nUntTil := x, ) }
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Prp. 1"
         :bEditValue             := {|| ( dbfTmp )->cValPr1 }
         :nWidth                 := 35
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Prp. 2"
         :bEditValue             := {|| ( dbfTmp )->cValPr2 }
         :nWidth                 := 35
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Lote"
         :bEditValue             := {|| ( dbfTmp )->cLote }
         :nWidth                 := 40
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Caducidad"
         :bEditValue             := {|| ( dbfTmp )->dFecCad }
         :nWidth                 := 80
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Detalle"
         :bEditValue             := {|| Rtrim( ( dbfTmp )->cNomTil ) }
         :nWidth                 := 180
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Total"
         :bEditValue             := {|| Trans( nTotLTpv( dbfTmp, nDouDiv, nDorDiv ), cPorDiv ) }
         :nWidth                 := 80
         :bFooter                := {|| Trans( nTotSel, cPorDiv ) }
         :nDataStrAlign          := 1
         :nHeadStrAlign          := 1
         :nFootStrAlign          := 1
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "Dto. lineal"
         :bEditValue             := {|| Trans( nDtoUTpv( dbfTmpL, nDouDiv ), cPouDiv ) }
         :nWidth                 := 60
         :nDataStrAlign          := 1
         :nHeadStrAlign          := 1
      end

      with object ( oBrwDev:AddCol() )
         :cHeader                := "%Dto"
         :bEditValue             := {|| Trans( ( dbfTmp )->nDtoLin, "@EZ 999.99" ) }
         :nWidth                 := 35
         :nDataStrAlign          := 1
         :nHeadStrAlign          := 1
      end

      oBrwDev:CreateFromResource( 110 )

      oBrwDev:lHScroll           := .T.
      oBrwDev:lVScroll           := .T.
      oBrwDev:lRecordSelector    := .T.
      oBrwDev:bLDblClick         := {|| SelectLinea( @nTotSel, dbfTmp, oBrwDev ) }




      TButton():ReDefine( 120, {||( SelectLinea( @nTotSel, dbfTmp, oBrwDev ) )}, oDlg,,, .F.,,,, .F. )





      if lDevolucion

         for each o in ( aButtonsPago )
            o:oButton         := ApoloBtnBmp():Redefine( ( 600 + hb_EnumIndex() ), o:cBigResource, , , , , {|o| FinalizaDevolucionTicket( o, aTmp, aGet, dbfTmp, oNumero, oBrwDev, oDlg ) }, oDlg, , , .F., .F., "Devolución " + Rtrim( o:cText ), , , , .T., "TOP", .T., , , .F. )
            o:oButton:Cargo   := o:cCode
         next

         oDlg:bStart          := {|| aEval( aButtonsPago, {|o| if( !empty( o:oButton:Cargo ), o:oButton:Show(), ) } ) }

      else

         o                    := ApoloBtnBmp():Redefine( 1, "gc_document_text_delete_32", , , , , {|| FinalizaDevolucionTicket( , aTmp, aGet, dbfTmp, oNumero, oBrwDev, oDlg ) }, oDlg, , , .F., .F., "Emitir vale", , , , .T., "TOP", .T., , , .F. )

         oDlg:bStart          := {|| o:Show() }

      end

      ApoloBtnBmp():Redefine( 2, "Del32", , , , , {|| oDlg:end() }, oDlg, , , .F., .F., "Cancelar", , , , .T., "TOP", .T., , , .F. )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oBmp:End()

   if !empty( dbfTmp ) .AND. ( dbfTmp )->( Used() )
      ( dbfTmp )->( dbCloseArea() )
   end

   dbfErase( cNewFilL )

   dbfTmp                     := nil

Return ( oDlg:nResult == 1 )



Static Function SelectLinea( nTotSel, dbfTmp, oBrwDev )

   local nScan
   local uBook

   if ( dbfTmp )->nUntTil > 0

      uBook       := Eval( oBrwDev:bBookMark )

      nScan       := aScan( oBrwDev:Cargo, uBook )
      if nScan == 0

         nTotSel  += nTotLTpv( dbfTmp, nDouDiv, nDorDiv )

         aAdd( oBrwDev:Cargo, uBook )

      else

         nTotSel  -= nTotLTpv( dbfTmp, nDouDiv, nDorDiv )

         hb_ADel( oBrwDev:Cargo, nScan, .T. )

      end

      oBrwDev:Refresh()

   else

      cInformeDevolucionTpv( dbfTmp )

   end

Return nil



Static Function ValidaDevolucionTiket( oNumero, oBrwDev, aTmp, aGet, oDlg, dbfTmp )

   local lErr
   local nRecAnt
   local nOrdAnt
   local nRecLin
   local nOrdLin
   local cNumero

   cNumero        := Upper( oNumero:VarGet() )

   if empty( cNumero )
      Return .T.
   end

   oDlg:Disable()

   lErr           := .F.
   nRecAnt        := ( D():tikets( nView ) )->( RecNo() )
   nOrdAnt        := ( D():tikets( nView ) )->( ordsetfocus( "cNumTik" ) )

   if !lBigSeek( nil, cNumero, D():tikets( nView ), nil, nil, nil, 11 )

      lErr        := .T.
      msgStop( "Documento " + alltrim( cNumero ) + " no encontrado." )

   else

      if ( D():tikets( nView ) )->cTipTik <> "1"

         lErr     := .T.
         msgStop( "Documento " + alltrim( cNumero ) + " no es un ticket." )

      else

         oNumero:cText( ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik )





         aTmp[ 11 ]     := ( D():tikets( nView ) )->cCliTik
         aTmp[ 13 ]     := ( D():tikets( nView ) )->cNomTik
         aTmp[ 19 ]     := ( D():tikets( nView ) )->cDniCli
         aTmp[ 14 ]     := ( D():tikets( nView ) )->cDirCli
         aTmp[ 15 ]     := ( D():tikets( nView ) )->cPobCli
         aTmp[ 16 ]     := ( D():tikets( nView ) )->cPrvCli
         aTmp[ 18 ]     := ( D():tikets( nView ) )->cPosCli





         if ( dbfTikL )->( dbSeek( ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik ) )

            while ( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil == ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik .AND. !( dbfTikL )->( eof() ) )

               dbPass( dbfTikL, dbfTmp, .T. )





               ( dbfTmp )->nUntTil  -= nDevNTpv( ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik, dbfTikL )





               ( dbfTmp )->cNumDev  := ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik





               ( dbfTikL )->( dbSkip() )

            end

         end

         if !empty( oBrwDev )
            oBrwDev:Refresh()
            oBrwDev:GoTop()
         end

      end

   end

   ( D():tikets( nView ) )->( OrdScope( 0, nil ) )
   ( D():tikets( nView ) )->( OrdScope( 1, nil ) )
   ( D():tikets( nView ) )->( ordsetfocus( nOrdAnt ) )
   ( D():tikets( nView ) )->( dbGoTo( nRecAnt ) )

   oDlg:Enable()

   if !lErr
      oNumero:Disable()
   end

Return ( .T. )



Static Function FinalizaDevolucionTicket( oBtn, aTmp, aGet, dbfTmp, oNumero, oBrwDev, oDlg )

   local nRec
   local nOrd
   local aTotalTicket
   local cSerieTicket
   local nNumeroTicket
   local cSufijoTicket
   local cNumeroTicket
   local nTotalTicket            := 0
   local cTipoDocumento          := !empty( oBtn )
   local nTotalDevolucion        := 0
   local nTotTicketOriginal      := 0
   local nTotTicketResultado     := 0
   local nPorcentajeFidelizacion := 0
   local nValePromocion          := 0
   local lValePromocion          := .F.
   local aBlankT                 := {}
   local aBlankL                 := {}

   if len( oBrwDev:Cargo ) == 0
      msgStop( "Debe seleccionar al menos una línea" )
      return ( .F. )
   end

   CursorWait()

   oDlg:Disable()





   cNumeroTicket        := alltrim( oNumero:VarGet() )
   cSerieTicket         := aTmp[ 1 ]
   nNumeroTicket        := str( nNewDoc( aTmp[ 1 ], D():tikets( nView ), "nTikCli", 10, dbfCount ), 10 )
   cSufijoTicket        := retSufEmp()

   if !empty(oBtn)
      cTipoDocumento    := "4"
   else
      cTipoDocumento    := "6"
   end

   aTmp[ 1 ]     := cSerieTicket
   aTmp[ 2 ]     := nNumeroTicket
   aTmp[ 3 ]     := cSufijoTicket






   aTmp[ 24 ]     := cDivEmp()
   aTmp[ 25 ]     := nValDiv( cDivEmp(), dbfDiv )
   aTmp[ 5 ]     := cCurSesion()
   aTmp[ 8 ]     := Auth():Codigo()
   aTmp[ 9 ]     := Application():CodigoCaja()
   aTmp[ 12 ]     := Max( uFieldEmpresa( "nPreVta" ), 1 )
   aTmp[ 40 ]     := Date()
   aTmp[ 41 ]     := SubStr( Time(), 1, 5 )
   aTmp[ 7 ]     := Substr( Time(), 1, 5 )
   aTmp[ 50]     := .F.
   aTmp[ 26 ]     := .F.
   aTmp[ 28 ]     := .T.
   aTmp[ 4 ]     := cTipoDocumento






   winGather( aTmp, nil, D():tikets( nView ), nil, 1, nil, .F. )





   for each nRec in ( oBrwDev:Cargo )
      ( dbfTmp )->( dbgoto( nRec ) )
      dbPass( dbfTmp, dbfTikL, .T., cSerieTicket, nNumeroTicket, cSufijoTicket, cTipoDocumento )
   next





   nRec                       := ( D():tikets( nView ) )->( recno() )
   nOrd                       := ( D():tikets( nView ) )->( ordsetfocus( "cNumTik" ) )

   if ( D():tikets( nView ) )->( dbSeek( cSerieTicket + nNumeroTicket + cSufijoTicket ) )

      aTotalTicket            := aTotTik( cSerieTicket + nNumeroTicket + cSufijoTicket, D():tikets( nView ), dbfTikL, dbfDiv, nil, nil, .F. )

      if dbLock( D():tikets( nView ) )

         ( D():tikets( nView ) )->nTotNet := aTotalTicket[ 1 ]
         ( D():tikets( nView ) )->nTotIva := aTotalTicket[ 2 ]
         ( D():tikets( nView ) )->nTotTik := aTotalTicket[ 3 ]

         ( D():tikets( nView ) )->( dbUnLock() )

      endif

   end

   ( D():tikets( nView ) )->( ordsetfocus( nOrd ) )
   ( D():tikets( nView ) )->( dbgoto( nRec ) )






   if ( cTipoDocumento == "4" ) .AND. ( !empty( aTotalTicket ) ) .AND. ( aTotalTicket[ 3 ] <> 0 )

      if dbAppe( dbfTikP )
         ( dbfTikP )->cSerTik    := cSerieTicket
         ( dbfTikP )->cNumTik    := nNumeroTicket
         ( dbfTikP )->cSufTik    := cSufijoTicket
         ( dbfTikP )->cTurPgo    := cCurSesion()
         ( dbfTikP )->dPgoTik    := getSysDate()
         ( dbfTikP )->cTimTik    := substr( Time(), 1, 5 )
         ( dbfTikP )->cCodCaj    := Application():CodigoCaja()
         ( dbfTikP )->cFpgPgo    := oBtn:Cargo
         ( dbfTikP )->cDivPgo    := cDivEmp()
         ( dbfTikP )->nVdvPgo    := nValDiv( cDivEmp(), dbfDiv )
         ( dbfTikP )->nImpTik    := aTotalTicket[ 3 ]
      end

   end






   nRec                       := ( D():tikets( nView ) )->( recno() )
   nOrd                       := ( D():tikets( nView ) )->( ordsetfocus( "cTikVal" ) )

   if ( D():tikets( nView ) )->( dbSeek( cNumeroTicket ) )

      if dbLock( D():tikets( nView ) )
         ( D():tikets( nView ) )->lLiqTik := .T.
         ( D():tikets( nView ) )->lLiqDev := .T.
         ( D():tikets( nView ) )->( dbUnLock() )
      endif

   end

   ( D():tikets( nView ) )->( ordsetfocus( nOrd ) )
   ( D():tikets( nView ) )->( dbgoto( nRec ) )





   Application():openDirectCajon()







   ImpTiket( 1 )





   nTotalDevolucion           := nTotalDevoluciones( Padr( cNumeroTicket, 13 ), D():tikets( nView ), dbfTikL )





   if dbSeekInOrd( cNumeroTicket, "cNumTik", D():tikets( nView ) ) .AND. dbSeekInOrd( cNumeroTicket, "cNumTil", dbfTikL )

      nTotTicketOriginal      := nTotTik()
      nTotTicketResultado     := nTotTicketOriginal - nTotalDevolucion





      nPorcentajeFidelizacion := oFideliza:nPorcentajePrograma( nTotTicketResultado )





      lValePromocion          := ( !retfld( ( D():tikets( nView ) )->cCliTik, dbfClient, "lExcFid" ) .AND. ( nPorcentajeFidelizacion <> 0 ) )
      if lValePromocion
         nValePromocion       := nTotTicketResultado * nPorcentajeFidelizacion / 100
      end

   end






   if ( lValePromocion ) .AND. ( nValePromocion > 0 )

      setAutoTextDialog( "Generando vales" )

      generatePromocion( nValePromocion )

      ImpTiket( 1 )

   end











































   oDlg:Enable()

   CursorWE()

   oDlg:End( 1 )

Return ( .T. )



static function nTotalDevoluciones( cNumeroTicket, cTikT, cTikL )

   local i
   local nRecT          := ( cTikT )->( Recno() )
   local nRecL          := ( cTikL )->( Recno() )
   local nOrdT          := ( cTikT )->( ordsetfocus( "cNumTik" ) )
   local nOrdL          := ( cTikL )->( ordsetfocus( "cDevTik" ) )
   local cValAnt        := ""
   local aDevoluciones  := {}
   local nTotal         := 0

   if ( cTikL )->( dbSeek( cNumeroTicket ) )

      while ( cTikL )->cNumDev == cNumeroTicket .AND. !( cTikL )->( Eof() )

         if aScan( aDevoluciones, ( cTikL )->cSerTil + ( cTikL )->cNumTil + ( cTikL )->cSufTil ) == 0
            aAdd( aDevoluciones, ( cTikL )->cSerTil + ( cTikL )->cNumTil + ( cTikL )->cSufTil )
         end

         ( cTikL )->( dbSkip() )

      end

   end

   if Len( aDevoluciones ) <> 0

      for i := 1 to Len( aDevoluciones )

         if ( cTikT )->( dbSeek( aDevoluciones[i] ) )
            nTotal      += nTotTik()
         end

      next

   end

   ( cTikT )->( ordsetfocus( nOrdT ) )
   ( cTikL )->( ordsetfocus( nOrdL ) )
   ( cTikT )->( dbGoTo( nRecT ) )
   ( cTikL )->( dbGoTo( nRecT ) )

return ( nTotal )



Static Function nDevNTpv( cNumero, dbfTikL )

   local nRec
   local nOrd
   local nDev
   local cNum

   nDev           := 0
   nRec           := ( dbfTikL )->( Recno() )
   nOrd           := ( dbfTikL )->( ordsetfocus( "cNumDev" ) )
   cNum           := Str( ( dbfTikL )->nNumLin )

   if ( dbfTikL )->( dbSeek( cNumero + cNum ) )
      while ( dbfTikL )->cNumDev == cNumero .AND. Str( ( dbfTikL )->nNumLin ) == cNum .AND. !( dbfTikL )->( eof() )
         nDev     += nTotNTpv( dbfTikL )
         ( dbfTikL )->( dbSkip() )
      end
   end

   ( dbfTikL )->( dbGoto( nRec ) )
   ( dbfTikL )->( ordsetfocus( nOrd ) )

Return ( nDev )



Static Function cInformeDevolucionTpv( dbfTmp )

   local cNum
   local nRec
   local nOrd
   local aInf
   local oBrw
   local oDlg
   local oBmp

   if empty( ( dbfTmp )->cSerTil )
      Return ( nil )
   end

   cNum           := ""
   nRec           := ( dbfTikL )->( Recno() )
   nOrd           := ( dbfTikL )->( ordsetfocus( "cNumDev" ) )
   aInf           := {}

   if ( dbfTikL )->( dbSeek( ( dbfTmp )->cSerTil + ( dbfTmp )->cNumTil + ( dbfTmp )->cSufTil + Str( ( dbfTmp )->nNumLin ) ) )
      aAdd( aInf, { "Número",       ( dbfTikL )->cSerTil + "/" + Alltrim( ( dbfTikL )->cNumTil ) + "/" + Alltrim( ( dbfTikL )->cSufTil ) } )
      aAdd( aInf, { "Fecha",        Dtoc( RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),   "dFecTik" ) ) } )
      aAdd( aInf, { "Hora",         RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cHorTik" ) } )
      aAdd( aInf, { "Usuario",      RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cCcjTik" ) } )
      aAdd( aInf, { "Caja",         RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cNcjTik" ) } )
      aAdd( aInf, { "Almacen",      RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cAlmTik" ) } )
      aAdd( aInf, { "Sesión",       Alltrim( RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),"cTurTik" ) ) } )
      aAdd( aInf, { "Cliente",      RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cNomTik" ) } )
      aAdd( aInf, { "Dirección",    RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cDirCli" ) } )
      aAdd( aInf, { "Cod. postal",  RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cPosCli" ) } )
      aAdd( aInf, { "Población",    RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cPobCli" ) } )
      aAdd( aInf, { "Provincia",    RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cPrvCli" ) } )
      aAdd( aInf, { "Teléfono",     RetFld( ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil, D():tikets( nView ),         "cTlfCli" ) } )
      aAdd( aInf, { "Unidades",     AllTrim( nTotNTpv( dbfTikL, cPicUnd ) ) } )
      aAdd( aInf, { "Importe",      AllTrim( Trans( nTotLTpv( dbfTikL, nDouDiv, nDorDiv ), cPorDiv ) ) } )
   end

   ( dbfTikL )->( dbGoto( nRec ) )
   ( dbfTikL )->( ordsetfocus( nOrd ) )

   if !empty( aInf )

      oDlg = TDialog():New(,,,,, "TICKETINFO",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmp := TBitmap():ReDefine( 500, "gc_cash_register_delete_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )

      oBrw                       := IXBrowse():New( oDlg )

      oBrw:bClrSel               := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus          := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:SetArray( aInf, , , .F. )

      oBrw:nMarqueeStyle         := 5
      oBrw:lRecordSelector       := .F.
      oBrw:lHScroll              := .F.

      oBrw:CreateFromResource( 100 )

      with object ( oBrw:AddCol() )
         :cHeader                := "Info"
         :bStrData               := {|| aInf[ oBrw:nArrayAt, 1 ] }
         :nWidth                 := 80
      end

      with object ( oBrw:AddCol() )
         :cHeader                := "Valor"
         :bStrData               := {|| aInf[ oBrw:nArrayAt, 2 ] }
         :nWidth                 := 300
      end




      TButton():ReDefine( 1, {||( oDlg:End() )}, oDlg,,, .F.,,,, .F. )

      oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

      oBmp:End()

   else

      MsgStop( "No se ha podido recopilar información." )

   end

Return ( nil )



Static Function dFecMaxVale( cNumTik, cTikT  )

   local dFecMaxVale    := Ctod( "" )
   local nRec
   local nOrdAnt

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;





   nRec                 := ( cTikT )->( Recno() )
   nOrdAnt              := ( cTikT )->( ordsetfocus( "CDOCVAL" ) )

   if ( cTikT )->( dbSeek( cNumTik ) )

      while ( cTikT )->cValDoc == cNumTik .AND. !( cTikT )->( Eof() )

         if dFecMaxVale == Ctod( "" )

            dFecMaxVale := ( cTikT )->dFecTik

         else

            if ( cTikT )->dFecTik < dFecMaxVale
               dFecMaxVale := ( cTikT )->dFecTik
            end

         end

      ( cTikT )->( dbSkip() )

      end

   end





   ( cTikT )->( ordsetfocus( nOrdAnt ) )
   ( cTikT )->( dbGoTo( nRec ) )

   if empty( dFecMaxVale )
      dFecMaxVale       := Date()
   end

return ( dFecMaxVale )



Static Function BrwTikCli( oGet )

   local oDlg
    local oBrw
   local oGet1
    local cGet1
   local nRec
   local nOrd           := GetBrwOpt( "BrwTikCli" )
   local oCbxOrd
   local cCbxOrd
   local aCbxOrd        := { "Número", "Fecha", "Código cliente", "Nombre cliente" }
   local cText          := ""



   nOrd                 := Min( Max( nOrd, 1 ), len( aCbxOrd ) )
   cCbxOrd              := aCbxOrd[ nOrd ]

   nRec                 := ( D():tikets( nView ) )->( RecNo() )
   nOrd                 := ( D():tikets( nView ) )->( ordsetfocus( nOrd ) )

   ( D():tikets( nView ) )->( dbGoTop() )



   oDlg = TDialog():New(,,,, "Seleccionar tickets", "HelpEntry",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oGet1 := TGetHlp():ReDefine( 104, { | u | If( PCount()==0, cGet1, cGet1:= u ) }, oDlg,,,,,,,,, .F.,, {|nKey,nFlags,Self| AutoSeek( nKey, nFlags, Self, oBrw, D():tikets( nView ), , , , , , 11 ) }, .F., .F.,,,,,, nil, "FIND",, )






        oCbxOrd := TComboBox():ReDefine( 102, { | u | If( PCount()==0, cCbxOrd, cCbxOrd:= u ) }, aCbxOrd, oDlg,,, {|Self|( ( D():tikets( nView ) )->( ordsetfocus( oCbxOrd:nAt ) ), oBrw:Refresh(), oGet1:SetFocus() )},,,, .F.,,,,,,, "oCbxOrd",,,,,,, )

      oBrw                    := IXBrowse():New( oDlg )

      oBrw:bClrSel            := {|| { 0, ( 229 + ( 229 * 256 ) + ( 229 * 65536 ) ) } }
      oBrw:bClrSelFocus       := {|| { 0, ( 167 + ( 205 * 256 ) + ( 240 * 65536 ) ) } }

      oBrw:cAlias             := D():tikets( nView )
      oBrw:cName              := "Ticket cliente"
      oBrw:bLDblClick         := {|| EndBrwTikCli( oGet, oDlg ) }

      oBrw:nMarqueeStyle      := 5

      with object ( oBrw:AddCol() )
         :cHeader             := "Número"
         :cSortOrder          := "cNumTik"
         :bEditValue          := {|| ( D():tikets( nView ) )->cSerTik + "/" + AllTrim( ( D():tikets( nView ) )->cNumTik ) + "/" + ( D():tikets( nView ) )->cSufTik }
         :nWidth              := 70
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Fecha"
         :cSortOrder          := "dFecTik"
         :bEditValue          := {|| Dtoc( ( D():tikets( nView ) )->dFecTik ) }
         :nWidth              := 70
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Código cliente"
         :bEditValue          := {|| Rtrim( ( D():tikets( nView ) )->cCliTik ) }
         :cSortOrder          := "cCliTik"
         :nWidth              := 75
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Nombre cliente"
         :bEditValue          := {|| AllTrim( ( D():tikets( nView ) )->cNomTik ) }
         :cSortOrder          := "cNomTik"
         :nWidth              := 300
         :bLClickHeader       := {| nMRow, nMCol, nFlags, oCol | oCbxOrd:Set( oCol:cHeader ) }
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Importe "
         :bEditValue          := {|| nTotalizer( ( D():tikets( nView ))->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik, D():tikets( nView ), dbfTikL, dbfTikP, dbfAlbCliT, dbfAlbCliL, dbfFacCliT, dbfFacCliL, dbfFacCliP, dbfIva, dbfDiv, cDivEmp(), .T. ) }
         :nWidth              := 85
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Div."
         :bEditValue          := {|| cSimDiv( ( D():tikets( nView ) )->cDivTik, dbfDiv ) }
         :nWidth              := 30
         :nDataStrAlign       := 1
         :nHeadStrAlign       := 1
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Sesión"
         :bEditValue          := {|| ( D():tikets( nView ) )->cTurTik + "/" + ( D():tikets( nView ) )->cSufTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Hora"
         :bEditValue          := {|| ( D():tikets( nView ) )->cHorTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Caja"
         :bEditValue          := {|| ( D():tikets( nView ) )->cNcjTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Cajero"
         :bEditValue          := {|| ( D():tikets( nView ) )->cCcjTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      with object ( oBrw:AddCol() )
         :cHeader             := "Almacén"
         :bEditValue          := {|| ( D():tikets( nView ) )->cAlmTik }
         :nWidth              := 80
         :lHide               := .T.
      end

      oBrw:CreateFromResource( 105 )




        TButton():ReDefine( 1, {||( EndBrwTikCli( oGet, oDlg ) )}, oDlg,,, .F.,,,, .F. )





        TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

   oDlg:bStart                := {|| oBrw:Load() }

   oDlg:AddFastKey( 116,    {|| EndBrwTikCli( oGet, oDlg ) } )
   oDlg:AddFastKey( 13,{|| EndBrwTikCli( oGet, oDlg ) } )

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )



   SetBrwOpt( "BrwTikCli", ( D():tikets( nView ) )->( OrdNumber() ) )

   CursorWE()

   oGet:SetFocus()





   ( D():tikets( nView ) )->( ordsetfocus( nOrd ) )
   ( D():tikets( nView ) )->( dbGoTo( nRec ) )

RETURN ( oDlg:nResult == 1 )



Static Function EndBrwTikCli( oGet, oDlg )

   if ( D():tikets( nView ) )->cTipTik <> "1"
      MsgStop( "El tipo de documento seleccionado debe ser un ticket" )
      Return .F.
   end

   if !empty( oGet )


      oGet:cText( ( D():tikets( nView ) )->cSerTik + ( D():tikets( nView ) )->cNumTik + ( D():tikets( nView ) )->cSufTik )
   end

   oDlg:end( 1 )

RETURN ( .T. )



Function nTotalEntregado( cNumDoc, cTikT, cAlbCliP, cDiv )

   If( cTikT == nil, cTikT := if( !Empty( nView ), D():tikets( nView ), ), ) ;
   If( cDiv == nil, cDiv := dbfDiv, ) ;
   If( cAlbCliP == nil, cAlbCliP := dbfAlbCliP, ) ;
   If( cNumDoc == nil, cNumDoc := ( cTikT )->cNumDoc, ) ;

Return nPagAlbCli( cNumDoc, cAlbCliP, cDiv )





Function ArticuloServido( oBrwLin, dbfTmpL )

   if ( dbfTmpL )->lArtServ

      ( dbfTmpL )->lArtServ := .F.
   else

      ( dbfTmpL )->lArtServ := .T.

   end

   oBrwLin:Refresh()

Return nil





_HB_CLASS TFormatosImpresion ; function TFormatosImpresion ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TFormatosImpresion", iif( .F., { }, { @HBObject() } ), @TFormatosImpresion() ) ) ;

   _HB_MEMBER { cCodCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodCaj"}, .F. )

   _HB_MEMBER { oFormatoTiket } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFormatoTiket"}, .F. )
   _HB_MEMBER { cFormatoTiket } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFormatoTiket"}, .F. )

   _HB_MEMBER { oSayFmtTik } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayFmtTik"}, .F. )
   _HB_MEMBER { cSayFmtTik } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSayFmtTik"}, .F. )

   _HB_MEMBER { oPrinterTik } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPrinterTik"}, .F. )
   _HB_MEMBER { cPrinterTik } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterTik"}, .F. )
   _HB_MEMBER { nCopiasTik } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCopiasTik"}, .F. )

   _HB_MEMBER { oFmtVal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFmtVal"}, .F. )
   _HB_MEMBER { cFmtVal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtVal"}, .F. )
   _HB_MEMBER { oSayFmtVal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayFmtVal"}, .F. )
   _HB_MEMBER { cSayFmtVal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSayFmtVal"}, .F. )
   _HB_MEMBER { oPrinterVal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPrinterVal"}, .F. )
   _HB_MEMBER { cPrinterVal } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterVal"}, .F. )

   _HB_MEMBER { oFmtAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFmtAlb"}, .F. )
   _HB_MEMBER { cFmtAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtAlb"}, .F. )
   _HB_MEMBER { oSayFmtAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayFmtAlb"}, .F. )
   _HB_MEMBER { cSayFmtAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSayFmtAlb"}, .F. )
   _HB_MEMBER { oPrinterAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPrinterAlb"}, .F. )
   _HB_MEMBER { cPrinterAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterAlb"}, .F. )
   _HB_MEMBER { nCopiasAlb } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCopiasAlb"}, .F. )

   _HB_MEMBER { oFmtFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oFmtFac"}, .F. )
   _HB_MEMBER { cFmtFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtFac"}, .F. )
   _HB_MEMBER { oSayFmtFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayFmtFac"}, .F. )
   _HB_MEMBER { cSayFmtFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cSayFmtFac"}, .F. )
   _HB_MEMBER { oPrinterFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oPrinterFac"}, .F. )
   _HB_MEMBER { cPrinterFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterFac"}, .F. )
   _HB_MEMBER { nCopiasFac } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCopiasFac"}, .F. )

   _HB_MEMBER { cFormatoRegalo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFormatoRegalo"}, .F. )
   _HB_MEMBER { cPrinterRegalo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterRegalo"}, .F. )
   _HB_MEMBER { nCopiasRegalo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCopiasRegalo"}, .F. )

   _HB_MEMBER { cFmtTikChk } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtTikChk"}, .F. )
   _HB_MEMBER { cPrinterTikChk } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterTikChk"}, .F. )

   _HB_MEMBER { cFormatoEntrega } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFormatoEntrega"}, .F. )
   _HB_MEMBER { cPrinterEntrega } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterEntrega"}, .F. )
   _HB_MEMBER { nCopiasEntrega } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nCopiasEntrega"}, .F. )

   _HB_MEMBER { cFmtTikDev } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtTikDev"}, .F. )
   _HB_MEMBER { cPrinterDev } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterDev"}, .F. )

   _HB_MEMBER { cFmtAlbCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtAlbCaj"}, .F. )
   _HB_MEMBER { cPrinterAlbCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterAlbCaj"}, .F. )

   _HB_MEMBER { cFmtFacCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtFacCaj"}, .F. )
   _HB_MEMBER { cPrinterFacCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterFacCaj"}, .F. )

   _HB_MEMBER { cFmtEntCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtEntCaj"}, .F. )
   _HB_MEMBER { cPrinterEntCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterEntCaj"}, .F. )

   _HB_MEMBER { cFmtApt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cFmtApt"}, .F. )
   _HB_MEMBER { cPrinterApt } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cPrinterApt"}, .F. )

   _HB_MEMBER Load( dbfCajT); oClass:AddMethod( "Load", @TFormatosImpresion_Load(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TFormatosImpresion ;



static FUNCTION TFormatosImpresion_Load( dbfCajT ) ; local Self AS CLASS TFormatosImpresion := QSelf() AS CLASS TFormatosImpresion

   local cCodCaj     := Application():CodigoCaja()

   ::cFormatoTiket   := cFormatoTicketEnCaja(   cCodCaj, dbfCajT )
   ::cFmtVal         := cFormatoValeEnCaja(     cCodCaj, dbfCajT )
   ::cFmtAlb         := cFormatoAlbaranEnCaja(  cCodCaj, dbfCajT )

   ::cSayFmtTik      := cNombreDoc( ::cFormatoTiket )
   ::cSayFmtVal      := cNombreDoc( ::cFmtVal )
   ::cSayFmtAlb      := cNombreDoc( ::cFmtAlb )

   ::cPrinterTik     := cPrinterTiket(    cCodCaj, dbfCajT )

   if Empty( ::cPrinterTik )
      ::cPrinterTik  := ImpresoraDefectoUsuario()
   end

   ::cPrinterVal     := cPrinterVale(     cCodCaj, dbfCajT )

   if Empty( ::cPrinterVal )
      ::cPrinterVal  := ImpresoraDefectoUsuario()
   end

   ::cPrinterAlb     := cPrinterAlbaran(  cCodCaj, dbfCajT )

   if Empty( ::cPrinterAlb )
      ::cPrinterAlb  := ImpresoraDefectoUsuario()
   end

   ::cFormatoRegalo  := cFormatoTicketRegaloEnCaja(   cCodCaj, dbfCajT )
   ::cPrinterRegalo  := cPrinterRegalo(               cCodCaj, dbfCajT )

   ::cFmtTikChk      := cFormatoChequeRegaloEnCaja(   cCodCaj, dbfCajT )
   ::cPrinterTikChk  := cPrinterChequeRegalo(         cCodCaj, dbfCajT )

   ::cFormatoEntrega := cFormatoEntregaEnCaja(     cCodCaj, dbfCajT )
   ::cPrinterEntrega := cPrinterEntrega(           cCodCaj, dbfCajT )
   ::cFmtTikDev      := cFormatoDevolucionEnCaja(  cCodCaj, dbfCajT )
   ::cPrinterDev     := cPrinterDevolucion(        cCodCaj, dbfCajT )
   ::cFmtAlbCaj      := cFormatoAlbaranEnCaja(     cCodCaj, dbfCajT )
   ::cPrinterAlbCaj  := cWindowsPrinterEnCaja(     cCodCaj, dbfCajT )

   ::cFmtEntCaj      := cFormatoEntregaEnCaja(  cCodCaj, dbfCajT )
   ::cPrinterEntCaj  := cPrinterEntrega(        cCodCaj, dbfCajT )

   ::cFmtApt         := cFormatoApartadosEnCaja(      cCodCaj, dbfCajT )
   ::cPrinterApt     := cPrinterApartados(            cCodCaj, dbfCajT )

   ::nCopiasTik      := nCopiasTicketsEnCaja(         cCodCaj, dbfCajT )
   ::nCopiasAlb      := nCopiasAlbaranesEnCaja(       cCodCaj, dbfCajT )
   ::nCopiasEntrega  := nCopiasEntregasEnCaja(        cCodCaj, dbfCajT )
   ::nCopiasRegalo   := nCopiasTicketsRegaloEnCaja(   cCodCaj, dbfCajT )

return self





Function ImpresionAnulaciones( cNumTik )

   local cPrinter          := ""
   local cFormato          := ""
   local aImp              := {}
   local nPos
   local lCreateTemporal   := .F.
   local cWav              := ""

   CursorWait()

   if empty( dbfTmpN )

      cNewFilN             := cGetNewFileName( cPatTmp() + "TikA" )

      dbCreate( cNewFilN, aSqlStruct( aColTik() ), cLocalDriver() )
      dbUseArea( .T., cLocalDriver(), cNewFilN, cCheckArea( "TikA", @dbfTmpN ), .F. )
      if !NetErr()
         ( dbfTmpN )->( OrdCondSet( "!Deleted()", {||!Deleted() } ) )
         ( dbfTmpN )->( OrdCreate( cNewFilN, "cNumTil", "cSerTil + cNumTil + cSufTil", {|| Field->cSerTil + Field->cNumTil + Field->cSufTil } ) )
      end

      lCreateTemporal      := .T.

   else

      ( dbfTmpN )->( __dbZap() )

   end

   if dbSeekInOrd( cNumTik, "cNumTiL", dbfTikL )

      while ( dbfTikL )->cSerTil + ( dbfTikL )->cNumTil + ( dbfTikL )->cSufTil == cNumTik .AND. !( dbfTikL )->( Eof() )

         if ( dbfTikL )->lAnulado

            dbPass( dbfTikL, dbfTmpN, .T. )





            if dbLock( dbfTikL )
               ( dbfTikL )->lAnulado    := .F.
               ( dbfTikL )->( dbUnLock() )
            end





            if !empty( ( dbfTikL )->cImpCom1 ) .AND. AllTrim( ( dbfTikL )->cImpCom1 )  <> "No imprimir"

               if aScan( aImp, ( dbfTikL )->cImpCom1 ) == 0
                  aAdd( aImp, ( dbfTikL )->cImpCom1 )
               end

            end





            if !empty( ( dbfTikL )->cImpCom2 ) .AND. AllTrim( ( dbfTikL )->cImpCom2 ) <> "No imprimir"

               if aScan( aImp, ( dbfTikL )->cImpCom2 ) == 0
                  aAdd( aImp, ( dbfTikL )->cImpCom2 )
               end

            end

         end

      ( dbfTikL )->( dbSkip() )

      end

   end





   for nPos := 1 to len( aImp )





      ( dbfTmpN )->( dbSetFilter( {|| ( Field->cImpCom1 == aImp[ nPos ] .OR. Field->cImpCom2 == aImp[ nPos ] ) }, "( Field->cImpCom1 == aImp[ nPos ] .or. Field->cImpCom2 == aImp[ nPos ] )" ) )





      if dbSeekInOrd( cNumTik, "cNumTik", D():tikets( nView ) )

         cPrinter := cNombreImpresoraComanda( Application():CodigoCaja(), aImp[ nPos ], dbfCajL )
         cFormato := cFormatoAnulacionEnCaja( Application():CodigoCaja(), aImp[ nPos ], dbfCajT, dbfCajL )

         if !empty( cPrinter )
            GenTikCli( 1, "Imprimiendo anulacion", cFormato, AllTrim( cPrinter ), .F., .T., aImp[ nPos ] )
         end

      end





      ( dbfTmpN )->( dbClearFilter() )





      cWav        := AllTrim( cWavImpresoraComanda( Application():CodigoCaja(), aImp[ nPos ], dbfCajL ) )

      if !empty( cWav ) .AND. File( cWav )

         SndPlaySound( cWav )

      end

   next





   if lCreateTemporal

      if !empty( dbfTmpN ) .AND. ( dbfTmpN )->( Used() )
         ( dbfTmpN )->( dbCloseArea() )
      end

      dbfErase( cNewFilN )

      dbfTmpN  := nil

   end

   CursorWE()

return ( .T. )



static function lBuscaOferta( cCodArt, aGet, aTmp, aTmpTik, dbfOferta, dbfArticulo, dbfDiv, dbfKit, dbfIva  )

   local sOfeArt
   local nTotalLinea    := 0


   if ( dbfArticulo )->Codigo == cCodArt .OR. ( dbfArticulo )->( dbSeek( cCodArt ) )





      nTotalLinea := lCalcDeta( aTmp, nil, .T. )

      sOfeArt     := sOfertaArticulo( Padr( cCodArt, 18 ), aTmpTik[ 11 ], aTmpTik[ 47 ], aTmp[ 8 ], aTmpTik[ 6 ], dbfOferta, aTmpTik[ 12 ], .T., aTmp[19], aTmp[20], aTmp[21], aTmp[22], aTmp[ 24 ], 1, nTotalLinea )

      if !empty( sOfeArt )

         if ( sOfeArt:nPrecio <> 0 )
            aGet[ 7 ]:cText( sOfeArt:nPrecio )
         end

         if ( sOfeArt:nDtoPorcentual <> 0 )
            aGet[ 18 ]:cText( sOfeArt:nDtoPorcentual )
         end

         if ( sOfeArt:nDtoLineal <> 0)
            aGet[ 24 ]:cText( sOfeArt:nDtoLineal )
         end

         aTmp[ 67  ] := .T.

         if !empty( aGet[ 67 ] )
            aGet[ 67 ]:Show()
         end

      end

      if !aTmp[ 67 ]





         sOfeArt     := sOfertaFamilia( ( dbfArticulo )->Familia, aTmpTik[ 11 ], aTmpTik[ 47 ], aTmpTik[ 6 ], dbfOferta, aTmpTik[ 12 ], dbfArticulo, aTmp[ 8 ], 1, nTotalLinea )

         if !empty( sOfeArt )

            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 18 ]:cText( sOfeArt:nDtoPorcentual )
            end

            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 24 ]:cText( sOfeArt:nDtoLineal )
            end

            aTmp[ 67 ]  := .T.

            if !empty( aGet[ 67 ] )
               aGet[ 67 ]:Show()
            end

         end

      end

      if !aTmp[ 67 ]





         sOfeArt     := sOfertaTipoArticulo( ( dbfArticulo )->cCodTip, aTmpTik[ 11 ], aTmpTik[ 47 ], aTmpTik[ 6 ], dbfOferta, aTmpTik[ 12 ], dbfArticulo, aTmp[ 8 ], 1, nTotalLinea )

         if !empty( sOfeArt )

            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 18 ]:cText( sOfeArt:nDtoPorcentual )
            end

            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 24 ]:cText( sOfeArt:nDtoLineal )
            end

            aTmp[ 67 ]  := .T.

            if !empty( aGet[ 67 ] )
               aGet[ 67 ]:Show()
            end

         end

      end

      if !aTmp[ 67 ]





         sOfeArt     := sOfertaTemporada( ( dbfArticulo )->cCodTemp, aTmpTik[ 11 ], aTmpTik[ 47 ], aTmpTik[ 6 ], dbfOferta, aTmpTik[ 12 ], dbfArticulo, aTmp[ 8 ], 1, nTotalLinea )

         if !empty( sOfeArt )

            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 18 ]:cText( sOfeArt:nDtoPorcentual )
            end

            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 24 ]:cText( sOfeArt:nDtoLineal )
            end

            aTmp[ 67 ]  := .T.

            if !empty( aGet[ 67 ] )
               aGet[ 67 ]:Show()
            end

         end

      end

      if !aTmp[ 67 ]





         sOfeArt     := sOfertaFabricante( ( dbfArticulo )->cCodFab, aTmpTik[ 11 ], aTmpTik[ 47 ], aTmpTik[ 6 ], dbfOferta, aTmpTik[ 12 ], dbfArticulo, aTmp[ 8 ], 1, nTotalLinea )

         if !empty( sOfeArt )

            if ( sOfeArt:nDtoPorcentual <> 0 )
               aGet[ 18 ]:cText( sOfeArt:nDtoPorcentual )
            end

            if ( sOfeArt:nDtoLineal <> 0 )
               aGet[ 24 ]:cText( sOfeArt:nDtoLineal )
            end

            aTmp[ 67 ]  := .T.

            if !empty( aGet[ 67 ] )
               aGet[ 67 ]:Show()
            end

         end

      end

   end

return .T.



Static Function EditarNumeroSerie( aTmp, oStock, nMode )

   local oNumerosSeries

   with object ( TNumerosSerie() )

      :lTicket          := .T.

      :nMode            := nMode

      :cCodArt          := aTmp[ 5 ]
      :cCodAlm          := aTmp[ 27 ]
      :nNumLin          := aTmp[ 31 ]

      :nTotalUnidades   := nTotNTpv( aTmp )

      :oStock           := oStock

      :uTmpSer          := dbfTmpS

      :Resource()

   end

Return ( nil )



Static Function lAddCobro( aTmp, oTotDiv, oBrwPgo )

   CursorWait()

   if aTmp[ 22 ] <> 0

      if dbAppe( dbfTmpP )
         ( dbfTmpP )->cCtaRec    := cCtaCob()
         ( dbfTmpP )->cTurPgo    := cCurSesion()
         ( dbfTmpP )->dPgoTik    := GetSysDate()
         ( dbfTmpP )->cTimTik    := SubStr( Time(), 1, 5 )
         ( dbfTmpP )->cCodCaj    := Application():CodigoCaja()
         ( dbfTmpP )->nImpTik    := oTotDiv:nCobrado
         ( dbfTmpP )->cFpgPgo    := aTmp[ 21 ]
         ( dbfTmpP )->cSerTik    := aTmp[ 1 ]
         ( dbfTmpP )->cNumTik    := aTmp[ 2 ]
         ( dbfTmpP )->cSufTik    := aTmp[ 3 ]
         ( dbfTmpP )->cDivPgo    := aTmp[ 24 ]
         ( dbfTmpP )->nVdvPgo    := aTmp[ 25 ]
         ( dbfTmpP )->nDevTik    := Max( aTmp[ 23 ], 0 )
      else
         MsgStop( "No se ha podido añadir el registro de pago" )
      end

   end

   CalImpCob( aTmp )

   oBrwPgo:Refresh()

   CursorWE()

Return ( nil )



FUNCTION sTotTikCli( cNumTik, cTikT, cTikL, cDiv, cDivRet )

   local sTotal
   local a
   local aIva := {}
   local hIva := {=>}

   nTotTik( cNumTik, cTikT, cTikL, cDiv, nil, cDivRet )

   sTotal                                 := sTotal()

   sTotal:nTotalBruto                     := nTotBrt
   sTotal:nTotalNeto                      := nTotNet
   sTotal:nTotalIva                       := nTotIva
   sTotal:nTotalDocumento                 := nTotTik
   sTotal:nTotalCosto                     := nTotCos
   sTotal:nTotalImpuestoHidrocarburos     := nTotIvm
   sTotal:nTotalRentabilidad              := nTotRnt

   sTotal:nTotalDescuentoProntoPago       := nTotDpp

   sTotal:aBrtTik                         := aBrtTik
   sTotal:aBasTik                         := aBasTik
   sTotal:aIvmTik                         := aIvmTik
   sTotal:aIvaTik                         := aIvaTik



   for each a in aTotIva










      hIva     := {  "porcentajeiva"   => a[3], "logrecargo"      => .F., "porcentajere"    => 0, "bruto"           => a[1], "neto"            => a[2], "impiva"          => a[8], "impre"           => 0, "nivmh"           => a[6], "ntransporte"     => 0, "npntver"         => 0 }

      aAdd( aIva, hIva )

      hIva     := {=>}

   next

   sTotal:aTotalIva                       := aIva

Return ( sTotal )





Static Function lValidaLote( aTmp, aGet )

   local nOrdAnt
   local nRecAnt
   local lEncontrado       :=.F.

   if empty( aTmp[ 42 ] )
      return .T.
   end



   nRecAnt           := ( dbfFacPrvL )->( RecNo() )
   nOrdAnt           := ( dbfFacPrvL )->( ordsetfocus( "cArtLote" ) )

   if ( dbfFacPrvL )->( dbSeek( aTmp[ 5 ] + aTmp[ 42 ] ) )

      lEncontrado :=.T.
      aGet[ 76 ]:cText( ( dbfFacPrvL )->dFecCad )
   end
   ( dbfFacPrvL )->( ordsetfocus( nOrdAnt ) )
   ( dbfFacPrvL )->( dbGoTo( nRecAnt ) )


   if !(lEncontrado)

      nRecAnt           := ( dbfAlbPrvL )->( RecNo() )
      nOrdAnt           := ( dbfAlbPrvL )->( ordsetfocus( "cArtLote" ) )

      if ( dbfAlbPrvL )->( dbSeek( aTmp[ 5 ] + aTmp[ 42 ] ) )
         if !Empty( aGet[ 76 ] )
            aGet[ 76 ]:cText( ( dbfAlbPrvL )->dFecCad )
         else
            aTmp[ 76 ]  := ( dbfAlbPrvL )->dFecCad
         end
      end

      ( dbfAlbPrvL )->( ordsetfocus( nOrdAnt ) )
      ( dbfAlbPrvL )->( dbGoTo( nRecAnt ) )

   end

Return .T.



static Function ActualizaStockWeb()

   if !empty( oComercio )

      oComercio:MeterTotal( GetAutoMeterDialog() )

      oComercio:TextTotal( GetAutoTextDialog() )

      oComercio:buildActualizaStockProductPrestashop()

   end

Return .T.



Static Function hValue( aTmp, aTmpTik )

   local hValue                  := {=>}

   hValue[ "cCodigoArticulo"   ] := aTmp[ 5 ]
   hValue[ "cCodigoPropiedad1" ] := aTmp[ 19 ]
   hValue[ "cCodigoPropiedad2" ] := aTmp[ 20 ]
   hValue[ "cValorPropiedad1"  ] := aTmp[ 21 ]
   hValue[ "cValorPropiedad2"  ] := aTmp[ 22 ]
   hValue[ "cCodigoFamilia"    ] := aTmp[ 11 ]
   hValue[ "nCajas"            ] := 1
   hValue[ "nUnidades"         ] := aTmp[ 8 ]

   hValue[ "cCodigoCliente"    ] := aTmpTik[ 11 ]
   hValue[ "cCodigoGrupo"      ] := aTmpTik[ 47 ]
   hValue[ "lIvaIncluido"      ] := .T.
   hValue[ "dFecha"            ] := aTmpTik[ 6 ]
   hValue[ "nTarifaPrecio"     ] := aTmpTik[ 12 ]

   hValue[ "nTipoDocumento"    ] := "12"
   hValue[ "nView"             ] := nView

Return ( hValue )



Static Function generateVale( nValeDiferencia )

   local aTmp
   local aTbl
   local cNumTik





   aTmp              := dbScatter( D():tikets( nView ) )

   cNumTik           := aTmp[ 1 ] + aTmp[ 2 ] + aTmp[ 3 ]

   aTmp[ 2 ]  := Str( nNewDoc( aTmp[ 1 ], D():tikets( nView ), "nTikCli", 10, dbfCount ), 10 )
   aTmp[ 3 ]  := RetSufEmp()
   aTmp[ 6 ]  := dFecMaxVale( cNumTik, D():tikets( nView )  )
   aTmp[ 7 ]  := Substr( Time(), 1, 5 )
   aTmp[ 40 ]  := Date()
   aTmp[ 41 ]  := SubStr( Time(), 1, 5 )
   aTmp[ 4 ]  := "6"
   aTmp[ 65 ]  := nValeDiferencia
   aTmp[ 67 ]  := nValeDiferencia

   dbGather( aTmp, D():tikets( nView ), .T. )





   aTbl              := dbBlankRec( dbfTmpL )

   aTbl[ 1 ]  := aTmp[ 1 ]
   aTbl[ 2 ]  := aTmp[ 2 ]
   aTbl[ 3 ]  := aTmp[ 3 ]
   aTbl[ 6 ]  := "Vale por diferencias"
   aTbl[ 8 ]  := 1
   aTbl[ 31 ]  := 1
   aTbl[ 7 ]  := nValeDiferencia

   dbGather( aTbl, dbfTikL, .T. )

Return ( nil )



Static Function generatePromocion( nValePromocion, nSave )

   local aTmp
   local aTbl

   if ( !empty( nSave ) .AND. nSave == "4" )
      nValePromocion    := - nValePromocion
   end





   aTmp                 := dbScatter( D():tikets( nView ) )

   aTmp[ 2 ]     := Str( nNewDoc( aTmp[ 1 ], D():tikets( nView ), "nTikCli", 10, dbfCount ), 10 )
   aTmp[ 3 ]     := RetSufEmp()
   aTmp[ 7 ]     := Substr( Time(), 1, 5 )
   aTmp[ 40 ]     := Date()
   aTmp[ 41 ]     := SubStr( Time(), 1, 5 )
   aTmp[ 4 ]     := "6"
   aTmp[ 62 ]     := nNumTik
   aTmp[ 26 ]     := .F.
   aTmp[ 65 ]     := nValePromocion
   aTmp[ 67 ]     := nValePromocion

   dbGather( aTmp, D():tikets( nView ), .T. )





   aTbl                 := dbBlankRec( dbfTmpL )

   aTbl[ 1 ]     := aTmp[ 1 ]
   aTbl[ 2 ]     := aTmp[ 2 ]
   aTbl[ 3 ]     := aTmp[ 3 ]
   aTbl[ 4 ]     := "6"
   aTbl[ 8 ]     := 1
   aTbl[ 31 ]     := 1
   aTbl[ 6 ]     := "Vale por promoción"
   aTbl[ 7 ]     := nValePromocion

   dbGather( aTbl, dbfTikL, .T. )

Return ( nil )



Function nombrePrimeraPropiedadTicketsLineas( dbfTmpL )

   If( dbfTmpL == nil, dbfTmpL := dbfTikL, ) ;

Return ( nombrePropiedad( ( dbfTmpL )->cCodPr1, ( dbfTmpL )->cValPr1, nView ) )



Function nombreSegundaPropiedadTicketsLineas( dbfTmpL )

   If( dbfTmpL == nil, dbfTmpL := dbfTikL, ) ;

Return ( nombrePropiedad( ( dbfTmpL )->cCodPr2, ( dbfTmpL )->cValPr2, nView ) )



Function nombreUsuarioTicket( dbfTmpT )

   If( dbfTmpT == nil, dbfTmpT := D():Tikets( nView ), ) ;

Return ( UsuariosModel():getNombreWhereCodigo( ( dbfTmpT )->cCcjTik ) )






Function isPropertiesInProduct( aTmp, nMode )

   local cCode       := padr( aTmp[ 5 ], 18 )
   local cProperties := padr( aTmp[ 21 ], 20 )
   cProperties       += padr( aTmp[ 22 ], 20 )

   if !( dbSeekInOrd( cCode, "cValPrp", dbfArtDiv ) )
      return .T.
   end

   if dbSeekInOrd( cCode + cProperties, "cValPrp", dbfArtDiv )
      return .T.
   end

Return .F.



FUNCTION hStockBufferTikCli( aTmp, lComb )

   local hBuffer     := {=>}

   If( lComb == nil, lComb := .F., ) ;

   do case
      case hb_isArray( aTmp )

         if lComb
            hset( hBuffer, "codigo_articulo", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "cComTil" ) ) ] ) )
         else
            hset( hBuffer, "codigo_articulo", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "cCbaTil" ) ) ] ) )
         end

         hset( hBuffer, "codigo_almacen_entrada", "" )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "cAlmLin" ) ) ] ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "cCodPr1" ) ) ] ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "cValPr1" ) ) ] ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "cCodPr2" ) ) ] ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "cValPr2" ) ) ] ) )
         hset( hBuffer, "lote", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "clote" ) ) ] ) )
         hset( hBuffer, "bultos_articulo", 0 )
         hset( hBuffer, "cajas_articulo", 0 )
         hset( hBuffer, "unidades_articulo", nTotNTpv( aTmp ) )
         hset( hBuffer, "fecha", aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "dFecTik" ) ) ] )
         hset( hBuffer, "hora", AllTrim( aTmp[ ( D():TiketsLineas( nView ) )->( fieldpos( "tFecTik" ) ) ] ) )

      case hb_isChar( aTmp )

         if lComb
            hset( hBuffer, "codigo_articulo", AllTrim( ( aTmp )->cComTil ) )
         else
            hset( hBuffer, "codigo_articulo", AllTrim( ( aTmp )->cCbaTil ) )
         end

         hset( hBuffer, "codigo_almacen_entrada", "" )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( ( aTmp )->cAlmLin ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( ( aTmp )->cCodPr1 ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( ( aTmp )->cValPr1 ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( ( aTmp )->cCodPr2 ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( ( aTmp )->cValPr2 ) )
         hset( hBuffer, "lote", AllTrim( ( aTmp )->clote ) )
         hset( hBuffer, "bultos_articulo", 0 )
         hset( hBuffer, "cajas_articulo", 0 )
         hset( hBuffer, "unidades_articulo", nTotNTpv( aTmp ) )
         hset( hBuffer, "fecha", ( aTmp )->dFecTik )
         hset( hBuffer, "hora", AllTrim( ( aTmp )->tFecTik ) )


      case hb_isObject( aTmp )

         if lComb
            hset( hBuffer, "codigo_articulo", AllTrim( aTmp:cComTil ) )
         else
            hset( hBuffer, "codigo_articulo", AllTrim( aTmp:cCbaTil ) )
         end

         hset( hBuffer, "codigo_almacen_entrada", "" )
         hset( hBuffer, "codigo_almacen_salida", AllTrim( aTmp:cAlmLin ) )
         hset( hBuffer, "codigo_primera_propiedad", AllTrim( aTmp:cCodPr1 ) )
         hset( hBuffer, "valor_primera_propiedad", AllTrim( aTmp:cValPr1 ) )
         hset( hBuffer, "codigo_segunda_propiedad", AllTrim( aTmp:cCodPr2 ) )
         hset( hBuffer, "valor_segunda_propiedad", AllTrim( aTmp:cValPr2 ) )
         hset( hBuffer, "lote", AllTrim( aTmp:clote ) )
         hset( hBuffer, "bultos_articulo", 0 )
         hset( hBuffer, "cajas_articulo", 0 )
         hset( hBuffer, "unidades_articulo", nTotNTpv( aTmp ) )
         hset( hBuffer, "fecha", aTmp:dFecTik )
         hset( hBuffer, "hora", AllTrim( aTmp:tFecTik ) )

   end

RETURN ( hBuffer )
