#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 9 ".\.\Prg\Usuario.prg"
_HB_CLASS TUsuarios ; function TUsuarios ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "TUsuarios", iif( .T., { @TMant() }, { @HBObject() } ), @TUsuarios() ) ) ;

   _HB_MEMBER { cMru } ; oClass:AddMultiData(, "gc_businesspeople_16", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cMru"}, .F. )
   _HB_MEMBER { cBitmap } ; oClass:AddMultiData(, ( 33 + ( 115 * 256 ) + ( 70 * 65536 ) ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cBitmap"}, .F. )

   _HB_MEMBER { nView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"nView"}, .F. )

   _HB_MEMBER { oGetCodigo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetCodigo"}, .F. )
   _HB_MEMBER { oGetNombre } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetNombre"}, .F. )

   _HB_MEMBER { oGetUser } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetUser"}, .F. )
   _HB_MEMBER { cGetUser } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cGetUser"}, .F. )
   _HB_MEMBER { aGetUser } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aGetUser"}, .F. )

   _HB_MEMBER { oGetPassword } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetPassword"}, .F. )
   _HB_MEMBER { cGetPassword } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cGetPassword"}, .F. )
   _HB_MEMBER { oGetRepeatPassword } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetRepeatPassword"}, .F. )
   _HB_MEMBER { cGetRepeatPassword } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cGetRepeatPassword"}, .F. )

   _HB_MEMBER { oComboRoles } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oComboRoles"}, .F. )
   _HB_MEMBER { cComboRoles } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cComboRoles"}, .F. )
   _HB_MEMBER { aComboRoles } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aComboRoles"}, .F. )

   _HB_MEMBER { oDialog } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oDialog"}, .F. )

   _HB_MEMBER { oListView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oListView"}, .F. )
   _HB_MEMBER { oImageList } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oImageList"}, .F. )

   _HB_MEMBER { oCodEmp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodEmp"}, .F. )
   _HB_MEMBER { cCodEmp } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodEmp"}, .F. )
   _HB_MEMBER { oCodDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodDlg"}, .F. )
   _HB_MEMBER { cCodDlg } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodDlg"}, .F. )
   _HB_MEMBER { oCodCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodCaj"}, .F. )
   _HB_MEMBER { cCodCaj } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodCaj"}, .F. )
   _HB_MEMBER { oCodAlm } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodAlm"}, .F. )
   _HB_MEMBER { cCodAlm } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodAlm"}, .F. )
   _HB_MEMBER { oCodAge } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodAge"}, .F. )
   _HB_MEMBER { cCodAge } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodAge"}, .F. )
   _HB_MEMBER { oCodRut } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oCodRut"}, .F. )
   _HB_MEMBER { cCodRut } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodRut"}, .F. )
   _HB_MEMBER { oImpDef } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oImpDef"}, .F. )
   _HB_MEMBER { cImpDef } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cImpDef"}, .F. )

   _HB_MEMBER DefineFiles(); oClass:AddMethod( "DefineFiles", @TUsuarios_DefineFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER New( cPath, oWndParent, oMenuItem); oClass:AddMethod( "New", @TUsuarios_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER Create( cPath); oClass:AddMethod( "Create", @TUsuarios_Create(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @TUsuarios_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER OpenFiles( lExclusive); oClass:AddMethod( "OpenFiles", @TUsuarios_OpenFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER CloseFiles(); oClass:AddMethod( "CloseFiles", @TUsuarios_CloseFiles(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Resource( nMode); oClass:AddMethod( "Resource", @TUsuarios_Resource(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER lPreSave(); oClass:AddMethod( "lPreSave", @TUsuarios_lPreSave(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER isLogin(); oClass:AddMethod( "isLogin", @TUsuarios_isLogin(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER initRecourceLogin(); oClass:AddMethod( "initRecourceLogin", @TUsuarios_initRecourceLogin(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER resourceLogin(); oClass:AddMethod( "resourceLogin", @TUsuarios_resourceLogin(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER ValidateLogin( oDlg); oClass:AddMethod( "ValidateLogin", @TUsuarios_ValidateLogin(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER isLoginTCT(); oClass:AddInline( "isLoginTCT", {|Self | ( ( Self ) ), ( ::ResourceTCT() == 1 ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER ResourceTCT(); oClass:AddMethod( "ResourceTCT", @TUsuarios_ResourceTCT(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER startResourceTct(); oClass:AddMethod( "startResourceTct", @TUsuarios_startResourceTct(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER initResourceTct(); oClass:AddMethod( "initResourceTct", @TUsuarios_initResourceTct(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER ValidateTCT( nOpt); oClass:AddMethod( "ValidateTCT", @TUsuarios_ValidateTCT(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Config(); oClass:AddMethod( "Config", @TUsuarios_Config(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER SaveConfig(); oClass:AddMethod( "SaveConfig", @TUsuarios_SaveConfig(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS TUsuarios ;



static FUNCTION TUsuarios_DefineFiles( cPath, cDriver ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   If( cPath == nil, cPath := ::cPath, ) ;
   If( cDriver == nil, cDriver := cDriver(), ) ;

   ::oDbf := DbfServer( "USUARIOS.DBF", "USUARIOS" ):New( "USUARIOS.DBF",, ( cDriver ), "Usuarios", ( cPath ) )

      ::oDbf:AddField( "bstate", "B", 14, 0,,,, {|| if( isUserActive( ::oDbf:uuid ), "En uso", "" ) }, "Estado", .F., 100, .F., {} )
      ::oDbf:AddField( "bInacUse", "B", 14, 0,,,, {|| if( ::oDbf:lInacUse, "Inactivo", "" ) }, "Inactivo", .F., 100, .F., {} )
      ::oDbf:AddField( "uuid", "C", 40, 0,, win_uuidcreatestring(),,, "Identificador", .F.,, .T., {} )
      ::oDbf:AddField( "codigo", "C", 3, 0,,,,, "Código", .F., 50, .F., {} )
      ::oDbf:AddField( "nombre", "C", 100, 0,,,,, "Nombre", .F., 250, .F., {} )
      ::oDbf:AddField( "email", "C", 100, 0,,,,, "Email", .F., 250, .F., {} )
      ::oDbf:AddField( "password", "C", 100, 0,,,,, "Password", .F.,, .T., {} )
      ::oDbf:AddField( "lsuper", "L", 1, 0,,,,, "Lógico super usuario", .F.,, .T., {} )
      ::oDbf:AddField( "roluuid", "C", 40, 0,,,,, "Uuid rol", .F.,, .T., {} )
      ::oDbf:AddField( "lastpc", "C", 100, 0,,,,, "Última pc", .F.,, .T., {} )
      ::oDbf:AddField( "lastemp", "C", 4, 0,,,,, "Última empresa", .F.,, .T., {} )
      ::oDbf:AddField( "cEmpExc", "C", 4, 0,,,,, "Empresa exclusiva", .F.,, .T., {} )
      ::oDbf:AddField( "cDlgExc", "C", 2, 0,,,,, "Delegaión exclusiva", .F.,, .T., {} )
      ::oDbf:AddField( "cCajExc", "C", 3, 0,,,,, "Caja exclusiva", .F.,, .T., {} )
      ::oDbf:AddField( "cAlmExc", "C", 16, 0,,,,, "Almacén exclusivo", .F.,, .T., {} )
      ::oDbf:AddField( "cAgeExc", "C", 3, 0,,,,, "Agente exclusivo", .F.,, .T., {} )
      ::oDbf:AddField( "cRutExc", "C", 4, 0,,,,, "Ruta exclusivo", .F.,, .T., {} )
      ::oDbf:AddField( "cImpDef", "C", 200, 0,,,,, "Impresora por defecto", .F.,, .T., {} )
      ::oDbf:AddField( "lInacUse", "L", 1, 0,,,,, "Usuario inactivo", .F.,, .T., {} )

      ::oDbf:AddIndex( "Código", "USUARIOS.CDX", "codigo",,, .F., .F., "Código",,, .T., .F. )
      ::oDbf:AddIndex( "Nombre", "USUARIOS.CDX", "nombre",,, .F., .F., "Nombre",,, .T., .F. )
      ::oDbf:AddIndex( "Email", "USUARIOS.CDX", "email",,, .F., .F., "Email",,, .T., .F. )



RETURN ( ::oDbf )



static FUNCTION TUsuarios_New( cPath, oWndParent, oMenuItem ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   If( cPath == nil, cPath := cPatEmp(), ) ;
   If( oWndParent == nil, oWndParent := GetWndFrame(), ) ;
   If( oMenuItem == nil, oMenuItem := "usuarios", ) ;

   if Empty( ::nLevel )
      ::nLevel          := Auth():Level( oMenuItem )
   end





   if oWndParent <> nil
      oWndParent:CloseAll()
   end

   ::cPath              := cPath
   ::oWndParent         := oWndParent
   ::oDbf               := nil
   ::lReport            := .F.

   ::aComboRoles        := RolesModel():getNameList()

   ::cHtmlHelp          := "Usuarios"

RETURN ( Self )



static FUNCTION TUsuarios_Create( cPath ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   If( cPath == nil, cPath := cPatEmp(), ) ;

   ::cPath              := cPath
   ::oDbf               := nil

RETURN ( Self )



static FUNCTION TUsuarios_OpenFiles( lExclusive, cPath ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   local lOpen          := .T.
   local oError
   local oBlock

   If( lExclusive == nil, lExclusive := .F., ) ;
   If( cPath == nil, cPath := cPatDat(), ) ;

   oBlock               := ErrorBlock( {| oError | ApoloBreak( oError ) } )
   BEGIN SEQUENCE

      ::nView           := D():CreateView()

      if Empty( ::oDbf )
         ::oDbf         := ::DefineFiles( cPath )
      end

      ::oDbf:Activate( .F., !( lExclusive ) )

   RECOVER USING oError

      lOpen             := .F.

      ::CloseFiles()

      msgStop( ErrorMessage( oError ), "Imposible abrir las bases de datos de usuarios" )

   end

   ErrorBlock( oBlock )

RETURN ( lOpen )



static FUNCTION TUsuarios_CloseFiles( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   if ::oDbf <> nil .AND. ::oDbf:Used()
      ::oDbf:End()
   end

   D():DeleteView( ::nView )

   ::oDbf               := nil
   ::nView              := nil

RETURN .T.



static FUNCTION TUsuarios_Activate( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   if !Auth():isSuperAdmin()
      MsgStop( "Solo puede acceder el ususario Super administrador" )
      Return ( Self )
   end

   if nAnd( ::nLevel, 1 ) == 0
      msgStop( "Acceso no permitido." )
      Return ( Self )
   end





   if ::oWndParent <> nil
      ::oWndParent:CloseAll()
   end

   if Empty( ::oDbf ) .OR. !::oDbf:Used()
      ::lOpenFiles      := ::OpenFiles()
   end





   if ::lOpenFiles

      ::CreateShell( ::nLevel )

      ::oWndBrw:bDup    := nil
      ::oWndBrw:GralButtons( Self )






      ::oWndBrw:NewAt( "CNFCLI",,, {||( ::Config() )}, "Confi(g)uración", "G",,, 4,, .F. )

      ::oWndBrw:EndButtons( Self )

      if ::cHtmlHelp <> nil
         ::oWndBrw:cHtmlHelp  := ::cHtmlHelp
      end

      ::oWndBrw:Activate( nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, {|| ::CloseFiles() } )

   end

RETURN ( Self )



static FUNCTION TUsuarios_Resource( nMode ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   local oDlg
   local oBmp

   ::cGetPassword          := Space( 100 )
   ::cGetRepeatPassword    := Space( 100 )

   ::cComboRoles           := RolesModel():getNombre( ::oDbf:roluuid )

   oDlg = TDialog():New(,,,, LblTitle( nMode ) + " usuario", "USUARIO",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmp := TBitmap():ReDefine( 900, "gc_businesspeople_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )




      ::oGetCodigo := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::oDbf:codigo, ::oDbf:codigo:= u ) }, oDlg,,,,,,,,, .F., {||        ( nMode == 1 .OR. nMode == 4 )},, .F., .F.,,,,,, nil,,, )




      ::oGetNombre := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::oDbf:nombre, ::oDbf:nombre:= u ) }, oDlg,,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )




      TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::oDbf:email, ::oDbf:email:= u ) }, oDlg,,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      ::oGetPassword := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cGetPassword, ::cGetPassword:= u ) }, oDlg,,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )





      ::oGetRepeatPassword := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, ::cGetRepeatPassword, ::cGetRepeatPassword:= u ) }, oDlg,,,,,,,,, .F., {||        ( nMode <> 3 )},, .F., .F.,,,,,, nil,,, )






      ::oComboRoles := TComboBox():ReDefine( 140, { | u | If( PCount()==0, ::cComboRoles, ::cComboRoles:= u ) }, ::aComboRoles, oDlg,,,,,,, .F., {||        ( nMode <> 3 )},,,,,, "::oComboRoles",,,,,,, )




      TCheckBox():ReDefine( 150, { | u | If( PCount()==0, ::oDbf:lInacUse, ::oDbf:lInacUse:= u ) }, oDlg,,,,,,, .F., {||        ( !::oDbf:lsuper )}, .F. )





      TButton():ReDefine( 1, {||( if( ::lPreSave( nMode ), oDlg:end( 1 ), ) )}, oDlg,,, .F., {||        ( nMode <> 3 )},,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      if nMode <> 3
         oDlg:AddFastKey( 116, {|| if( ::lPreSave( nMode ), oDlg:end( 1 ), ) } )
      end

      oDlg:bStart    := {|| ::oGetCodigo:SetFocus() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if !Empty( oBmp )
      oBmp:end()
   end

RETURN ( oDlg:nResult == 1 )



static FUNCTION TUsuarios_lPreSave( nMode ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   if Empty( ::oDbf:codigo )
      MsgStop( "El campo codigo es obligatorio" )
      ::oGetCodigo:SetFocus()
      Return .F.
   end

   if nMode == 1 .AND. UsuariosModel():existe( ::oDbf:codigo )
      MsgStop( "Código ya existente" )
      ::oGetCodigo:SetFocus()
      Return .F.
   end

   if Empty( ::oDbf:nombre )
      MsgStop( "El campo nombre es obligatorio" )
      ::oGetNombre:SetFocus()
      Return .F.
   end

   if !Empty( ::oGetPassword:VarGet() )

      if Len( AllTrim( ::oGetPassword:VarGet() ) ) < 8 .OR. Len( AllTrim( ::oGetPassword:VarGet() ) ) > 18

         MsgStop( "- Contraseña debe de tener al menos ocho caracteres y un máximo de dieciocho" + Chr(13)+Chr(10) +  "- No puede contener espacios" )
         ::oGetPassword:SetFocus()
         Return .F.
      end

      if AllTrim( ::oGetPassword:VarGet() ) <> AllTrim( ::oGetRepeatPassword:VarGet() )
         MsgStop( "Las contraseñas no coinciden" )
         ::oGetPassword:SetFocus()
         Return .F.
      end

      ::oDbf:password   := UsuariosModel():Crypt( AllTrim( ::oGetPassword:VarGet() ) )

   end

   if nMode == 1
      ::oDbf:uuid       := win_uuidcreatestring()
   end

   if Empty( ::oComboRoles:VarGet() )
      ::oDbf:roluuid    := ""
   else
      ::oDbf:roluuid    := RolesModel():getuuid( ::oComboRoles:VarGet() )
   end

RETURN ( .T. )



static FUNCTION TUsuarios_isLogin( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   UsuariosModel():checkSuperUser()

   if ( ::resourceLogin() <> 1 )
      RETURN ( .F. )
   end

   UsuariosModel():setUsuarioPcEnUso( Alltrim( netname() ) + AllTrim( WNetGetUser() ), Auth():uuid() )

   AsistenciasModel():RegEntrada()

RETURN ( .T. )



static FUNCTION TUsuarios_initRecourceLogin( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   if Upper( GetPvProfString(  "main",    "SeleccionUltimoUsuario", ".T.",     cIniAplication() ) ) == ".T."
      ::cGetUser              := Padr( UsuariosModel():getNombreUsuarioWhereNetName( Alltrim( netname() ) + AllTrim( WNetGetUser() ) ), 100 )
   else
      ::cGetUser              := space( 100 )
   end

   ::cGetPassword             := space( 100 )

   ::aGetUser                 := UsuariosModel():getNamesUsuarios()

RETURN ( .T. )



static FUNCTION TUsuarios_resourceLogin( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   local oBitmap

   ::initRecourceLogin()


   ::oDialog = TDialog():New(,,,,, "LOGINADS",, .F.,,,,,, .F.,,,,,, .F.,, "::oDialog", nil, )





   oBitmap := TBitmap():ReDefine( 900, "gestool_logo",, ::oDialog,,, .F., .F.,,, .F.,,, .T. )





   ::oGetUser := TComboBox():ReDefine( 100, { | u | If( PCount()==0, ::cGetUser, ::cGetUser:= u ) }, ::aGetUser, ::oDialog,,,,,,, .F.,,,,,,, "::oGetUser",,,,,,, )




   ::oGetPassword := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cGetPassword, ::cGetPassword:= u ) }, ::oDialog,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




   TButton():ReDefine( 1, {||( ::ValidateLogin() )}, ::oDialog,,, .F.,,,, .F. )

   ::oDialog:AddFastKey( 116, {|| ::ValidateLogin() } )

   ::oDialog:Activate( , , , .T. )

   if !Empty( oBitmap )
      oBitmap:end()
   end

RETURN ( ::oDialog:nResult )



static FUNCTION TUsuarios_ValidateLogin( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   local hUsuario

   if Empty( AllTrim( ::cGetUser ) )
      MsgStop( "Nombre de usuario no puede estar vacío." )
      ::oGetUser:SetFocus()
      RETURN ( nil )
   end

   if !UsuariosModel():validNameUser( ::cGetUser )
      MsgStop( "El usuario introducido no existe." )
      ::oGetUser:SetFocus()
      RETURN ( nil )
   end

   hUsuario    := UsuariosModel():validUserPassword( ::cGetUser, ::cGetPassword )

   if Empty( hUsuario )
      MsgStop( "Contraseña erronea" )
      ::oGetPassword:SetFocus()
      RETURN ( nil )
   end

   if setUserActive( hget( hUsuario, "UUID" ) )
      MsgStop( "Usuario actualmente en uso" )
      RETURN ( nil )
   end

   Auth( hUsuario )

RETURN ( ::oDialog:end( 1 )  )



static FUNCTION TUsuarios_ResourceTCT( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   local oBitmap

   ::oImageList   := TImageList():New( 50, 50 )

   ::oImageList:AddMasked( TBitmap():Define( "gc_businessman2_50" ),   ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_user2_50" ),          ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )


   ::oDialog = TDialog():New(,,,,, "LOGIN_TACTIL_ADS",, .F.,,,,,, .F.,,,,,, .F.,, "::oDialog", nil, )





   oBitmap := TBitmap():ReDefine( 900, "gestool_logo",, ::oDialog,,, .F., .F.,,, .F.,,, .T. )

   ::oListView          := TListView():Redefine( 100, ::oDialog )
   ::oListView:nOption  := 0
   ::oListView:bClick   := {| nOpt | ::ValidateTCT( nOpt ) }




   TButton():ReDefine( 2, {||( ::oDialog:End( 2 ) )}, ::oDialog,,, .F.,,,, .F. )

   ::oDialog:bStart := {|| ::startResourceTct() }

   ::oDialog:Activate( , , , .T., , , {|| ::initResourceTct() } )

   if !Empty( oBitmap )
      oBitmap:end()
   end

RETURN ( ::oDialog:nResult )



static FUNCTION TUsuarios_startResourceTct( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   local oStatement

   oStatement  := UsuariosModel():fetchDirect()

   if !empty( oStatement )

      while !( oStatement )->( Eof() )

         if !isUserActive( ( oStatement )->uuid )

            with object ( TListViewItem():New() )
               :Cargo   := ( oStatement )->nombre
               :cText   := Capitalize( ( oStatement )->nombre )
               :nImage  := 0
               :nGroup  := 1
               :Create( ::oListView )
            end

         end

         ( oStatement )->( dbSkip() )

      end

   end

   ::oListView:Refresh()

Return ( nil )



static FUNCTION TUsuarios_initResourceTct( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   ::oListView:SetImageList( ::oImageList )
   ::oListView:EnableGroupView()
   ::oListView:SetIconSpacing( 120, 140 )

   with object ( TListViewGroup():New() )
      :cHeader := "Usuarios"
      :Create( ::oListView )
   end

RETURN ( nil )



static FUNCTION TUsuarios_ValidateTCT( nOpt ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   local cUsuario
   local cPassword
   local hUsuario

   if empty( ::oListView )
      RETURN ( nil )
   end

   if empty( ::oListView:getItem( nOpt ) )
      RETURN ( nil )
   end

   cUsuario          := ::oListView:GetItem( nOpt ):Cargo

   cPassword         := VirtualKey( .T., , "Introduzca contraseña" )

   hUsuario          := UsuariosModel():validUserPassword( cUsuario, cPassword )

   if Empty( hUsuario )

      ApoloMsgStop( "Contraseña erronea" )

   else

      if setUserActive( hget( hUsuario, "UUID" ) )
         ApoloMsgStop( "Usuario actualmente en uso" )
      else
         Auth( hUsuario )
         ::oDialog:End( 1 )
      end

   end

RETURN ( nil )



static FUNCTION TUsuarios_Config( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios

   local oDlg
   local oBmp

   ::cCodEmp      := ::oDbf:cEmpExc
   ::cCodDlg      := ::oDbf:cDlgExc
   ::cCodCaj      := ::oDbf:cCajExc
   ::cCodAlm      := ::oDbf:cAlmExc
   ::cCodAge      := ::oDbf:cAgeExc
   ::cCodRut      := ::oDbf:cRutExc
   ::cImpDef      := ::oDbf:cImpDef

   oDlg = TDialog():New(,,,, "Configuraciones", "CFG_USER",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmp := TBitmap():ReDefine( 500, "gc_wrench_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )





      ::oCodEmp := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cCodEmp, ::cCodEmp:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 111 )

         ::oCodEmp:bValid     := {|| cEmpresa( ::oCodEmp, D():Empresa( ::nView ), ::oCodEmp:oHelpText ) }
         ::oCodEmp:bHelp      := {|| BrwEmpresa( ::oCodEmp, D():Empresa( ::nView ), ::oCodEmp:oHelpText ) }






      ::oCodDlg := TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::cCodDlg, ::cCodDlg:= u ) }, oDlg,,,,,,,,, .F., {||        ( !Empty( ::oCodEmp:VarGet() ) )},, .F., .F.,,,,,, nil, "LUPA",, 121 )

         ::oCodDlg:bValid     := {|| cDelegacion( ::oCodDlg, D():Delegaciones( ::nView ), ::oCodDlg:oHelpText, AllTrim( ::oCodEmp:VarGet() ) ) }
         ::oCodDlg:bHelp      := {|| BrwDelegacion( ::oCodDlg, D():Delegaciones( ::nView ), ::oCodDlg:oHelpText, AllTrim( ::oCodEmp:VarGet() ) ) }





      ::oCodCaj := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cCodCaj, ::cCodCaj:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 131 )

         ::oCodCaj:bValid     := {|| cCajas( ::oCodCaj, ,::oCodCaj:oHelpText ) }
         ::oCodCaj:bHelp      := {|| BrwCajas( ::oCodCaj, ::oCodCaj:oHelpText ) }





      ::oCodAlm := TGetHlp():ReDefine( 140, { | u | If( PCount()==0, ::cCodAlm, ::cCodAlm:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 141 )

         ::oCodAlm:bValid     := {|| cAlmacen( ::oCodAlm, ,::oCodAlm:oHelpText ) }
         ::oCodAlm:bHelp      := {|| BrwAlmacen( ::oCodAlm, ::oCodAlm:oHelpText ) }





      ::oCodAge := TGetHlp():ReDefine( 150, { | u | If( PCount()==0, ::cCodAge, ::cCodAge:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 151 )

         ::oCodAge:bValid     := {|| cAgentes( ::oCodAge, , ::oCodAge:oHelpText ) }
         ::oCodAge:bHelp      := {|| BrwAgentes( ::oCodAge, ::oCodAge:oHelpText ) }





      ::oCodRut := TGetHlp():ReDefine( 160, { | u | If( PCount()==0, ::cCodRut, ::cCodRut:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil, "LUPA",, 161 )

         ::oCodRut:bValid     := {|| cRuta( ::oCodRut, ,::oCodRut:oHelpText ) }
         ::oCodRut:bHelp      := {|| BrwRuta( ::oCodRut, , ::oCodRut:oHelpText ) }



      ::oImpDef := TGetHlp():ReDefine( 170, { | u | If( PCount()==0, ::cImpDef, ::cImpDef:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )

      TBtnBmp():ReDefine( 171, "gc_printer2_check_16",,,,,{|| PrinterPreferences( ::oImpDef ) }, oDlg, .F., , .F.,  )




      TButton():ReDefine( 1, {||( ::SaveConfig(), oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:AddFastKey( 116, {|| ::SaveConfig(), oDlg:end( 1 ) } )

      oDlg:bStart := {|| ::oCodEmp:lValid(), ::oCodDlg:lValid(), ::oCodCaj:lValid(), ::oCodAlm:lValid(), ::oCodAge:lValid(), ::oCodRut:lValid() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   if !Empty( oBmp )
      oBmp:end()
   end

RETURN ( oDlg:nResult == 1 )



static FUNCTION TUsuarios_SaveConfig( ) ; local Self AS CLASS TUsuarios := QSelf() AS CLASS TUsuarios








   UsuariosModel():updateConfig( ::oDbf:uuid, ::oCodEmp:VarGet() , ::oCodDlg:VarGet() , ::oCodCaj:VarGet() , ::oCodAlm:VarGet() , ::oCodAge:VarGet() , ::oCodRut:VarGet() , ::oImpDef:VarGet() )

RETURN ( nil )







Function CryptUsersPasswords()

   local oUser    := TUsuarios():New( cPatDat() )

   if !Empty( oUser )

      if oUser:OpenFiles()

         oUser:oDbf:GoTop()

         while !oUser:oDbf:Eof()

            oUser:oDbf:Load()
            oUser:oDbf:password  := UsuariosModel():Crypt( oUser:oDbf:password )
            oUser:oDbf:Save()

            oUser:oDbf:Skip()

         end

         oUser:CloseFiles()

      end

      oUser:end()

   end

RETURN ( nil )



Function lGetUsuario( oGetUsuario, dbfUsr )

   local oDlg
   local oSayUsuario
   local oBmpUsuario
   local oCodigoUsuario
   local cCodigoUsuario := Space( 3 )
   local oUser          := TUsuarios():New( cPatDat() )

   if !lRecogerUsuario()
      Return .T.
   end

   oUser:OpenFiles()

   oDlg = TDialog():New(,,,,, "GetUsuario",, .F.,,,,,, .F.,,,,,, .F.,, "oDlg", nil, )





      oBmpUsuario := TBitmap():ReDefine( 500, "gc_businessman_48",, oDlg,,, .F., .F.,,, .F.,,, .T. )




      oSayUsuario := TSay():ReDefine( 510, {||      "Usuario"}, oDlg,,,, .F.,, .F., .F., )







      oCodigoUsuario := TGetHlp():ReDefine( 100, { | u | If( PCount()==0, cCodigoUsuario, cCodigoUsuario:= u ) }, oDlg,,, {||    ( oUser:Existe( oCodigoUsuario, oCodigoUsuario:oHelpText, "Nombre" ) )},,,,,, .F.,,, .F., .F.,,,,, {|Self|( oUser:Buscar( oCodigoUsuario, "codigo" ) )}, nil, "LUPA",, 110 )




      TButton():ReDefine( 1, {||( oDlg:end( 1 ) )}, oDlg,,, .F.,,,, .F. )





      TButton():ReDefine( 2, {||( oDlg:end() )}, oDlg,,, .F.,,,, .T. )

      oDlg:bStart       := { || oCodigoUsuario:SetFocus(), oCodigoUsuario:SelectAll() }

   oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T.,,,, oDlg:bRClicked,,, )

   oBmpUsuario:End()

   if oDlg:nResult == 1

      if !Empty( oGetUsuario )
         oGetUsuario:cText( cCodigoUsuario )
         oGetUsuario:lValid()
      end

   end

   oUser:CloseFiles()
   oUser:end()

Return ( oDlg:nResult == 1 )



Function ImpresoraDefectoUsuario()

   local cImpresora  := UsuariosModel():getUsuarioImpresoraDefecto( Auth():uuid )

   if Empty( cImpresora )
      cImpresora     := PrnGetName()
   end

Return ( AllTrim( cImpresora ) )
