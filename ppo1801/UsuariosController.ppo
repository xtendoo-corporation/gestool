#line 91 "\fwh1801\include\FiveWin.Ch"
         EXTERNAL FW_GT
















extern errorsys









































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 9 ".\Prg\Controllers\UsuariosController.prg"
_HB_CLASS UsuariosController ; function UsuariosController ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "UsuariosController", iif( .T., { @SQLNavigatorController() }, { @HBObject() } ), @UsuariosController() ) ) ;

   _HB_MEMBER { oAjustableController } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oAjustableController"}, .F. )

   _HB_MEMBER { oRolesController } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oRolesController"}, .F. )

   _HB_MEMBER { cUuidUsuario } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cUuidUsuario"}, .F. )

   _HB_MEMBER { aCajas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aCajas"}, .F. )
   _HB_MEMBER { oComboCaja } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oComboCaja"}, .F. )
   _HB_MEMBER { cUuidCajaExclusiva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cUuidCajaExclusiva"}, .F. )
   _HB_MEMBER { cNombreCajaExclusiva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNombreCajaExclusiva"}, .F. )

   _HB_MEMBER { aEmpresas } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aEmpresas"}, .F. )
   _HB_MEMBER { oComboEmpresa } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oComboEmpresa"}, .F. )
   _HB_MEMBER { cCodigoEmpresaExclusiva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cCodigoEmpresaExclusiva"}, .F. )
   _HB_MEMBER { cNombreEmpresaExclusiva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNombreEmpresaExclusiva"}, .F. )

   _HB_MEMBER { aAlmacenes } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aAlmacenes"}, .F. )
   _HB_MEMBER { oComboAlmacen } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oComboAlmacen"}, .F. )
   _HB_MEMBER { cUuidAlmacenExclusivo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cUuidAlmacenExclusivo"}, .F. )
   _HB_MEMBER { cNombreAlmacenExclusivo } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNombreAlmacenExclusivo"}, .F. )

   _HB_MEMBER { aDelegaciones } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aDelegaciones"}, .F. )
   _HB_MEMBER { oComboDelegacion } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oComboDelegacion"}, .F. )
   _HB_MEMBER { cUuidDelegacionExclusiva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cUuidDelegacionExclusiva"}, .F. )
   _HB_MEMBER { cNombreDelegacionExclusiva } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cNombreDelegacionExclusiva"}, .F. )

   _HB_MEMBER { oLoginView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oLoginView"}, .F. )
   _HB_MEMBER { oLoginTactilView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oLoginTactilView"}, .F. )

   _HB_MEMBER { cValidError } ; oClass:AddMultiData(, "", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cValidError"}, .F. )

   _HB_MEMBER New(); oClass:AddMethod( "New", @UsuariosController_New(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER End(); oClass:AddMethod( "End", @UsuariosController_End(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER isLogin(); oClass:AddMethod( "isLogin", @UsuariosController_isLogin(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER isTactilLogin(); oClass:AddMethod( "isTactilLogin", @UsuariosController_isTactilLogin(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setConfig(); oClass:AddMethod( "setConfig", @UsuariosController_setConfig(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER loadConfig(); oClass:AddMethod( "loadConfig", @UsuariosController_loadConfig(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER saveConfig(); oClass:AddMethod( "saveConfig", @UsuariosController_saveConfig(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER startingActivate(); oClass:AddMethod( "startingActivate", @UsuariosController_startingActivate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER changeComboEmpresa(); oClass:AddMethod( "changeComboEmpresa", @UsuariosController_changeComboEmpresa(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validUserPassword(); oClass:AddMethod( "validUserPassword", @UsuariosController_validUserPassword(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER checkSuperUser(); oClass:AddMethod( "checkSuperUser", @UsuariosController_checkSuperUser(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS UsuariosController ;



static FUNCTION UsuariosController_New( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   ::Super:New()

   ::cTitle                := "Usuarios"

   ::setName( "usuarios" )

   ::lTransactional        := .T.

   ::lConfig               := .T.

   ::hImage                := { "16" => "gc_businesspeople_16" }

   ::oModel                := SQLUsuariosModel():New( self )

   ::oRepository           := UsuariosRepository():New( self )

   ::oBrowseView           := UsuariosBrowseView():New( self )

   ::oDialogView           := UsuariosView():New( self )

   ::oValidator            := UsuariosValidator():New( self, ::oDialogView )

   ::oLoginView            := UsuariosLoginView():New( self )

   ::oLoginTactilView      := UsuariosLoginTactilView():New( self )

   ::oAjustableController  := AjustableController():New( self )

   ::oGetSelector          := GetSelector():New( self )



   ::oFilterController:setTableToFilter( ::getName() )

   ::setEvent( "openingDialog",  {|| ::oDialogView:openingDialog() } )
   ::setEvent( "closedDialog",   {|| ::oDialogView:closedDialog() } )

RETURN ( Self )



static FUNCTION UsuariosController_End( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   if !empty( ::oModel )
      ::oModel:End()
      ::oModel                := nil
   endif

   if !empty( ::oBrowseView )
      ::oBrowseView:End()
      ::oBrowseView           := nil
   endif

   if !empty( ::oDialogView )
      ::oDialogView:End()
      ::oDialogView           := nil
   endif

   if !empty( ::oValidator )
      ::oValidator:End()
      ::oValidator            := nil
   endif

   if !empty( ::oAjustableController )
      ::oAjustableController:End()
      ::oAjustableController  := nil
   end

   if !empty( ::oRolesController )
      ::oRolesController:End()
      ::oRolesController      := nil
   end

   ::Super:End()

   Self                       := nil

RETURN ( nil )



static FUNCTION UsuariosController_setConfig( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController


   if ::loadConfig() .AND.  ::oAjustableController:DialogViewActivate()

      ::saveConfig()

   end

RETURN ( self )



static FUNCTION UsuariosController_loadConfig( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   ::cUuidUsuario                := ::getRowSet():fieldGet( "uuid" )

   if empty( ::cUuidUsuario )
      RETURN ( .F. )
   end

   ::aEmpresas                   := EmpresasModel():aNombresSeleccionables()
   ::cCodigoEmpresaExclusiva     := ::oAjustableController:oModel:getUsuarioEmpresaExclusiva( ::cUuidUsuario )
   ::cNombreEmpresaExclusiva     := EmpresasModel():getNombreFromCodigo( ::cCodigoEmpresaExclusiva )

   ::aCajas                      := CajasModel():aNombresSeleccionables()
   ::cUuidCajaExclusiva          := ::oAjustableController:oModel:getUsuarioCajaExclusiva( ::cUuidUsuario )
   ::cNombreCajaExclusiva        := CajasModel():getNombreFromUuid( ::cUuidCajaExclusiva )

   ::aAlmacenes                  := AlmacenesModel():aNombresFromEmpresa( ::cCodigoEmpresaExclusiva )
   ::cUuidAlmacenExclusivo       := ::oAjustableController:oModel:getUsuarioAlmacenExclusivo( ::cUuidUsuario )
   ::cNombreAlmacenExclusivo     := AlmacenesModel():getNombreFromUuidAndEmpresa( ::cUuidAlmacenExclusivo, ::cCodigoEmpresaExclusiva )

   ::aDelegaciones               := DelegacionesModel():aNombres( ::cCodigoEmpresaExclusiva )
   ::cUuidDelegacionExclusiva    := ::oAjustableController:oModel:getUsuarioDelegacionExclusiva( ::cUuidUsuario )
   ::cNombreDelegacionExclusiva  := DelegacionesModel():getNombreFromUuid( ::cUuidDelegacionExclusiva )

RETURN ( .T. )



static FUNCTION UsuariosController_saveConfig( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   ::cCodigoEmpresaExclusiva     := EmpresasModel():getCodigoFromNombre( ::cNombreEmpresaExclusiva )
   ::cUuidCajaExclusiva          := CajasModel():getUuidFromNombre( ::cNombreCajaExclusiva )
   ::cUuidAlmacenExclusivo       := AlmacenesModel():getUuidFromNombreAndEmpresa( ::cNombreAlmacenExclusivo, ::cCodigoEmpresaExclusiva )
   ::cUuidDelegacionExclusiva    := DelegacionesModel():getUuidFromNombre( ::cNombreDelegacionExclusiva )

   ::oAjustableController:oModel:setUsuarioEmpresaExclusiva( ::cCodigoEmpresaExclusiva, ::cUuidUsuario )
   ::oAjustableController:oModel:setUsuarioCajaExclusiva( ::cUuidCajaExclusiva, ::cUuidUsuario )
   ::oAjustableController:oModel:setUsuarioAlmacenExclusivo( ::cUuidAlmacenExclusivo, ::cUuidUsuario )
   ::oAjustableController:oModel:setUsuarioDelegacionExclusiva( ::cUuidDelegacionExclusiva, ::cUuidUsuario )

RETURN ( self )



static FUNCTION UsuariosController_startingActivate( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   local oPanel               := ::oAjustableController:oDialogView:oExplorerBar:AddPanel( "Propiedades usuario", nil, 1 )

   ::oComboEmpresa            := oPanel:addComboBox( "Empresa exclusiva", @::cNombreEmpresaExclusiva, ::aEmpresas )
   ::oComboEmpresa:bChange    := {|| ::changeComboEmpresa() }

   ::oComboDelegacion         := oPanel:addComboBox( "Delegación exclusiva", @::cNombreDelegacionExclusiva, ::aDelegaciones )

   ::oComboCaja               := oPanel:addComboBox( "Caja exclusiva", @::cNombreCajaExclusiva, ::aCajas )

   ::oComboAlmacen            := oPanel:addComboBox( "Almacén exclusivo", @::cNombreAlmacenExclusivo, ::aAlmacenes )

   ::changeComboEmpresa( .T. )

RETURN ( self )



static FUNCTION UsuariosController_changeComboEmpresa( lInit ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   If( lINIT == nil, lINIT := .F., ) ;





   if !lInit





      if empty( ::cNombreEmpresaExclusiva )
         ::aDelegaciones := {}
      else
         ::aDelegaciones := DelegacionesModel():aNombres( EmpresasModel():getCodigoFromNombre( AllTrim( ::cNombreEmpresaExclusiva ) ) )
      end

      ::oComboDelegacion:SetItems( ::aDelegaciones )
      ::oComboDelegacion:Refresh()





      if empty( ::cNombreEmpresaExclusiva )
         ::aAlmacenes := {}
      else
         ::aAlmacenes := AlmacenesModel():aNombresFromEmpresa( EmpresasModel():getCodigoFromNombre( AllTrim( ::cNombreEmpresaExclusiva ) ) )
      end

      ::oComboAlmacen:SetItems( ::aAlmacenes )
      ::oComboAlmacen:Refresh()

   end



   iif(  empty( ::cNombreEmpresaExclusiva ), ( ::oComboDelegacion:Disable(), ::oComboDelegacion:Set( "" ) ), ::oComboDelegacion:Enable() )



   iif(  empty( ::cNombreEmpresaExclusiva ), ( ::oComboCaja:Disable(), ::oComboCaja:Set( "" ) ), ::oComboCaja:Enable() )



   iif(  empty( ::cNombreEmpresaExclusiva ), ( ::oComboAlmacen:Disable(), ::oComboAlmacen:Set( "" ) ), ::oComboAlmacen:Enable() )

RETURN ( self )



static FUNCTION UsuariosController_validUserPassword( cUsuario, cPassword ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   local hUsuario

   hUsuario                   := ::oModel:validUserPassword( cUsuario, cPassword )

   if empty( hUsuario )
      ::cValidError           := "Usuario y contraseña no coinciden"
      RETURN ( .F. )
   end

   if setUserActive( hget( hUsuario, "uuid" ) )
      ::cValidError           := "Usuario actualmente en uso"
      RETURN ( .F. )
   end

   Auth( hUsuario )

RETURN ( .T. )



static FUNCTION UsuariosController_isLogin( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   if ( ::oLoginView:Activate() <> 1 )
      RETURN ( .F. )
   end

   ::oModel:setUsuarioPcEnUso( Alltrim( netname() ) + AllTrim( WNetGetUser() ), Auth():uuid() )

RETURN ( .T. )



static FUNCTION UsuariosController_isTactilLogin( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   if ( ::oLoginTactilView:Activate() <> 1 )
      RETURN ( .F. )
   end

RETURN ( .T. )



static FUNCTION UsuariosController_checkSuperUser( ) ; local Self AS CLASS UsuariosController := QSelf() AS CLASS UsuariosController

   local hUsuario

   hUsuario       := ::oModel:getWhere( "super_user = 1" )

   if !hb_ishash( hUsuario )
      msgStop( "No se ha definido super usuario" )
      RETURN ( .F. )
   end

   if !empty( hget( hUsuario, "password" ) )
      RETURN ( .F. )
   end

   ::Edit( hget( hUsuario, "id" ) )

RETURN ( .T. )









_HB_CLASS SQLUsuariosModel ; function SQLUsuariosModel ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "SQLUsuariosModel", iif( .T., { @SQLBaseModel() }, { @HBObject() } ), @SQLUsuariosModel() ) ) ;

   _HB_MEMBER { cTableName } ; oClass:AddMultiData(, "usuarios", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cTableName"}, .F. )

   _HB_MEMBER { cConstraints } ; oClass:AddMultiData(, "PRIMARY KEY (id), KEY (uuid)", nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cConstraints"}, .F. )

   _HB_MEMBER getColumns(); oClass:AddMethod( "getColumns", @SQLUsuariosModel_getColumns(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getInsertUsuariosSentence(); oClass:AddMethod( "getInsertUsuariosSentence", @SQLUsuariosModel_getInsertUsuariosSentence(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Crypt(); oClass:AddInline( "Crypt", {|Self, cPassword | ( ( Self ) ), ( hb_crypt( alltrim( cPassword ), "snorlax" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER Decrypt(); oClass:AddInline( "Decrypt", {|Self, cPassword | ( ( Self ) ), ( hb_decrypt( alltrim( cPassword ), "snorlax" ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getNombreWhereCodigo( cCodigo); oClass:AddMethod( "getNombreWhereCodigo", @SQLUsuariosModel_getNombreWhereCodigo(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
   _HB_MEMBER getNombreWhereUuid(); oClass:AddInline( "getNombreWhereUuid", {|Self, uuid | ( ( Self ) ), ( ::getField( "nombre", "uuid", uuid ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getUuidWhereNombre(); oClass:AddInline( "getUuidWhereNombre", {|Self, nombre | ( ( Self ) ), ( ::getField( "uuid", "nombre", nombre ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validUserPassword( cNombre, cPassword); oClass:AddMethod( "validUserPassword", @SQLUsuariosModel_validUserPassword(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER validSuperUserPassword( cPassword); oClass:AddMethod( "validSuperUserPassword", @SQLUsuariosModel_validSuperUserPassword(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER fetchDirect(); oClass:AddMethod( "fetchDirect", @SQLUsuariosModel_fetchDirect(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getNombreUsuarioWhereNetName(); oClass:AddInline( "getNombreUsuarioWhereNetName", {|Self, cNetName | ( ( Self ) ), ( ::getField( "nombre", "last_pcname", cNetName ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setUsuarioPcEnUso(); oClass:AddInline( "setUsuarioPcEnUso", {|Self, cPcName, UuidUsuario | ( ( Self ) ), ( ::updateFieldWhereUuid(  UuidUsuario, "last_pcname", cPcName ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER setUsuarioEmpresaEnUso(); oClass:AddInline( "setUsuarioEmpresaEnUso", {|Self, cCodEmp, UuidUsuario | ( ( Self ) ), ( ::updateFieldWhereUuid(  UuidUsuario, "last_empresa", cCodEmp ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getUsuarioEmpresa(); oClass:AddInline( "getUsuarioEmpresa", {|Self, uuid | ( ( Self ) ), ( ::getField( "last_empresa", "uuid", uuid ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER getUsuariosToJson(); oClass:AddMethod( "getUsuariosToJson", @SQLUsuariosModel_getUsuariosToJson(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER SeederToADS(); oClass:AddMethod( "SeederToADS", @SQLUsuariosModel_SeederToADS(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS SQLUsuariosModel ;



static FUNCTION SQLUsuariosModel_getColumns( ) ; local Self AS CLASS SQLUsuariosModel := QSelf() AS CLASS SQLUsuariosModel


   hset( ::hColumns, "id",             {  "create"    => "INTEGER AUTO_INCREMENT"                  , "default"   => {|| 0 } }                                 )


   hset( ::hColumns, "uuid",           {  "create"    => "VARCHAR(40) NOT NULL UNIQUE"             , "default"   => {|| win_uuidcreatestring() } }            )


   hset( ::hColumns, "codigo",         {  "create"    => "VARCHAR( 20 )"                           , "default"   => {|| space( 20 ) } }                       )


   hset( ::hColumns, "nombre",         {  "create"    => "VARCHAR ( 100 ) NOT NULL UNIQUE"         , "default"   => {|| space( 100 ) } }                      )


   hset( ::hColumns, "email",          {  "create"    => "VARCHAR ( 100 ) NOT NULL"                , "default"   => {|| space( 100 ) } }                      )


   hset( ::hColumns, "password",       {  "create"    => "VARCHAR ( 100 )"                         , "default"   => {|| space( 100 ) } }                      )


   hset( ::hColumns, "remember_token", {  "create"    => "VARCHAR ( 100 )"                         , "default"   => {|| "" } }                                )


   hset( ::hColumns, "super_user",     {  "create"    => "TINYINT ( 1 )"                           , "default"   => {|| "0" } }                               )


   hset( ::hColumns, "rol_uuid",       {  "create"    => "VARCHAR( 40 )"                           , "default"   => {|| space( 40 ) } }                       )


   hset( ::hColumns, "last_pcname",    {  "create"    => "VARCHAR( 100 )"                          , "default"   => {|| space( 100 ) } }                      )


   hset( ::hColumns, "last_empresa",   {  "create"    => "VARCHAR( 4 )"                            , "default"   => {|| space( 4 ) } }                        )

   ::getTimeStampColumns()

RETURN ( ::hColumns )



static FUNCTION SQLUsuariosModel_getNombreWhereCodigo( cCodigo ) ; local Self AS CLASS SQLUsuariosModel := QSelf() AS CLASS SQLUsuariosModel

   local cName

   cName := ::getField( "nombre", "codigo", cCodigo )

Return ( if( Empty( cName ), "", cName ) )



static FUNCTION SQLUsuariosModel_getInsertUsuariosSentence( ) ; local Self AS CLASS SQLUsuariosModel := QSelf() AS CLASS SQLUsuariosModel

   local cSQL
   local cUuidRol

   cUuidRol    := RolesRepository():getUuidWhereNombre( "Super administrador" )

   cSQL        := "INSERT IGNORE INTO " + ::cTableName + " "
   cSQL        += "( uuid, "
   cSQL        +=    "codigo, "
   cSQL        +=    "nombre, "
   cSQL        +=    "email, "
   cSQL        +=    "password, "
   cSQL        +=    "super_user, "
   cSQL        +=    "rol_uuid ) "
   cSQL        += "VALUES "
   cSQL        +=    "( UUID(), "
   cSQL        +=    "'999', "
   cSQL        +=    "'Super administrador', "
   cSQL        +=    "'', "
   cSQL        +=    "'', "
   cSQL        +=    "'1', "
   cSQL        +=    quoted( cUuidRol ) + " )"

RETURN ( cSQL )



static FUNCTION SQLUsuariosModel_validUserPassword( cNombre, cPassword ) ; local Self AS CLASS SQLUsuariosModel := QSelf() AS CLASS SQLUsuariosModel

   local cSQL  := "SELECT * FROM " + ::getTableName()                         + " "
   cSQL        +=    "WHERE nombre = " + quoted( cNombre )                    + " "
   if ( alltrim( cPassword ) <> "snorlax" ) .AND. !( "NOPASSWORD" $ appParamsMain() .OR. "NOPASSWORD" $ appParamsSecond() )
      cSQL     +=     "AND password = " + quoted( ::Crypt( cPassword ) )      + " "
   end
   cSQL        +=    "LIMIT 1"

RETURN ( ::getDatabase():firstTrimedFetchHash( cSQL ) )



static FUNCTION SQLUsuariosModel_validSuperUserPassword( cPassword ) ; local Self AS CLASS SQLUsuariosModel := QSelf() AS CLASS SQLUsuariosModel

   local cSQL  := "SELECT * FROM " + ::getTableName()                         + " "
   cSQL        +=    "WHERE super_user = 1"                                   + " "
   if ( alltrim( cPassword ) <> "snorlax" )
      cSQL     +=       "AND password = " + quoted( ::Crypt( cPassword ) )    + " "
   end
   cSQL        +=    "LIMIT 1"

RETURN ( ::getDatabase():firstTrimedFetchHash( cSQL ) )



static FUNCTION SQLUsuariosModel_fetchDirect( ) ; local Self AS CLASS SQLUsuariosModel := QSelf() AS CLASS SQLUsuariosModel

   local cSQL  := "SELECT * FROM " + ::getTableName()

RETURN ( ::getDatabase():Query( cSQL ) )



static FUNCTION SQLUsuariosModel_getUsuariosToJson( ) ; local Self AS CLASS SQLUsuariosModel := QSelf() AS CLASS SQLUsuariosModel


   local cSql  := "SELECT Codigo, Nombre "                            +  "FROM " + ::getTableName()

RETURN ( ::getDatabase():selectFetchArray( cSql ) )



static FUNCTION SQLUsuariosModel_SeederToADS( ) ; local Self AS CLASS SQLUsuariosModel := QSelf() AS CLASS SQLUsuariosModel

   local cSql  := "SELECT * FROM " + ::getTableName()

RETURN ( getSQLDataBase():selectFetchHash( cSql ) )








_HB_CLASS UsuariosBrowseView ; function UsuariosBrowseView ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "UsuariosBrowseView", iif( .T., { @SQLBrowseView() }, { @HBObject() } ), @UsuariosBrowseView() ) ) ;

   _HB_MEMBER addColumns(); oClass:AddMethod( "addColumns", @UsuariosBrowseView_addColumns(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS UsuariosBrowseView ;



static FUNCTION UsuariosBrowseView_addColumns( ) ; local Self AS CLASS UsuariosBrowseView := QSelf() AS CLASS UsuariosBrowseView

   with object ( ::oBrowse:AddCol() )
      :cSortOrder          := "id"
      :cHeader             := "Id"
      :nWidth              := 80
      :bEditValue          := {|| ::getRowSet():fieldGet( "id" ) }
      :bLClickHeader       := {| row, col, flags, oColumn | ::onClickHeader( oColumn ) }
   end

   with object ( ::oBrowse:AddCol() )
      :cSortOrder          := "uuid"
      :cHeader             := "Uuid"
      :nWidth              := 180
      :bEditValue          := {|| ::getRowSet():fieldGet( "uuid" ) }
      :bLClickHeader       := {| row, col, flags, oColumn | ::onClickHeader( oColumn ) }
      :lHide               := .T.
   end

   with object ( ::oBrowse:AddCol() )
      :cHeader             := "Estado"
      :nWidth              := 180
      :bStrData            := {|| if( isUserActive( ::getRowSet():fieldGet( "uuid" ) ), "En uso", "" ) }
      :bLClickHeader       := {| row, col, flags, oColumn | ::onClickHeader( oColumn ) }
      :Cargo               := .T.
   end

   with object ( ::oBrowse:AddCol() )
      :cSortOrder          := "codigo"
      :cHeader             := "Código"
      :nWidth              := 120
      :bEditValue          := {|| ::getRowSet():fieldGet( "codigo" ) }
      :bLClickHeader       := {| row, col, flags, oColumn | ::onClickHeader( oColumn ) }
   end

   with object ( ::oBrowse:AddCol() )
      :cSortOrder          := "nombre"
      :cHeader             := "Nombre"
      :nWidth              := 300
      :bEditValue          := {|| ::getRowSet():fieldGet( "nombre" ) }
      :bLClickHeader       := {| row, col, flags, oColumn | ::onClickHeader( oColumn ) }
   end

   with object ( ::oBrowse:AddCol() )
      :cSortOrder          := "email"
      :cHeader             := "Email"
      :nWidth              := 300
      :bEditValue          := {|| ::getRowSet():fieldGet( "email" ) }
      :bLClickHeader       := {| row, col, flags, oColumn | ::onClickHeader( oColumn ) }
   end

   with object ( ::oBrowse:AddCol() )
      :cSortOrder          := "creado"
      :cHeader             := "Creado"
      :cEditPicture        := "@DT"
      :nWidth              := 140
      :nHeadStrAlign       := 0
      :nDataStrAlign       := 0
      :lHide               := .T.
      :bEditValue          := {|| ::getRowSet():fieldGet( "created_at" ) }
      :bLClickHeader       := {| row, col, flags, oColumn | ::onClickHeader( oColumn ) }
   end

   with object ( ::oBrowse:AddCol() )
      :cSortOrder          := "modificado"
      :cHeader             := "Modificado"
      :cEditPicture        := "@DT"
      :nWidth              := 140
      :nHeadStrAlign       := 0
      :nDataStrAlign       := 0
      :lHide               := .T.
      :bEditValue          := {|| ::getRowSet():fieldGet( "updated_at" ) }
      :bLClickHeader       := {| row, col, flags, oColumn | ::onClickHeader( oColumn ) }
   end

RETURN ( self )







_HB_CLASS UsuariosView ; function UsuariosView ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "UsuariosView", iif( .T., { @SQLBaseView() }, { @HBObject() } ), @UsuariosView() ) ) ;

   _HB_MEMBER { oGetPassword } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetPassword"}, .F. )
   _HB_MEMBER { cGetPassword } ; oClass:AddMultiData(, space( 100 ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cGetPassword"}, .F. )
   _HB_MEMBER { oGetRepeatPassword } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetRepeatPassword"}, .F. )
   _HB_MEMBER { cGetRepeatPassword } ; oClass:AddMultiData(, space( 100 ), nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cGetRepeatPassword"}, .F. )

   _HB_MEMBER { oComboRol } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oComboRol"}, .F. )
   _HB_MEMBER { cComboRol } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cComboRol"}, .F. )
   _HB_MEMBER { aComboRoles } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aComboRoles"}, .F. )

   _HB_MEMBER { lSuperUser } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"lSuperUser"}, .F. )

   _HB_MEMBER openingDialog(); oClass:AddMethod( "openingDialog", @UsuariosView_openingDialog(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER closedDialog(); oClass:AddMethod( "closedDialog", @UsuariosView_closedDialog(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @UsuariosView_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER saveView( oDialog); oClass:AddMethod( "saveView", @UsuariosView_saveView(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS UsuariosView ;



static FUNCTION UsuariosView_openingDialog( ) ; local Self AS CLASS UsuariosView := QSelf() AS CLASS UsuariosView

   ::cGetPassword          := space( 100 )

   ::cGetRepeatPassword    := space( 100 )

   ::cComboRol             := ::oController:oRolesController:oRepository:getNombre( ::getModel():getBuffer( "rol_uuid" ) )
   ::aComboRoles           := ::oController:oRolesController:oRepository:getNombres()

RETURN ( self )



static FUNCTION UsuariosView_closedDialog( ) ; local Self AS CLASS UsuariosView := QSelf() AS CLASS UsuariosView

   ::getModel():setBuffer( "rol_uuid", ::oController:oRolesController:oRepository:getUuid( ::cComboRol ) )

RETURN ( self )



static FUNCTION UsuariosView_Activate( ) ; local Self AS CLASS UsuariosView := QSelf() AS CLASS UsuariosView



   ::oDialog = TDialog():New(,,,, ::lblTitle() + "usuario", "USUARIO",, .F.,,,,,, .F.,,,,,, .F.,, "::oDialog", nil, )





   ::oBitmap := TBitmap():ReDefine( 900, "gc_businesspeople_48",, ::oDialog,,, .F., .F.,,, .F.,,, .T. )




   ::oMessage := TSay():ReDefine( 800,, ::oDialog,,,, .F., getBoldFont(), .F., .F., )





   TGetHlp():ReDefine( 100, { | u | If( PCount()==0, ::getModel():hBuffer[ "codigo" ], ::getModel():hBuffer[ "codigo" ]:= u ) }, ::oDialog,,, {||       ( ::oController:validate( "codigo" ) )},,,,,, .F., {||        ( ::oController:isAppendOrDuplicateMode() )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::getModel():hBuffer[ "nombre" ], ::getModel():hBuffer[ "nombre" ]:= u ) }, ::oDialog,,, {||       ( ::oController:validate( "nombre" ) )},,,,,, .F., {||        ( ::oController:isNotZoomMode() )},, .F., .F.,,,,,, nil,,, )





   TGetHlp():ReDefine( 120, { | u | If( PCount()==0, ::getModel():hBuffer[ "email" ], ::getModel():hBuffer[ "email" ]:= u ) }, ::oDialog,,, {||       ( ::oController:validate( "email" ) )},,,,,, .F., {||        ( ::oController:isNotZoomMode() )},, .F., .F.,,,,,, nil,,, )





   ::oGetPassword := TGetHlp():ReDefine( 130, { | u | If( PCount()==0, ::cGetPassword, ::cGetPassword:= u ) }, ::oDialog,,,,,,,,, .F., {||        ( ::oController:isNotZoomMode() )},, .F., .F.,,,,,, nil,,, )

   ::oGetPassword:bValid         := {|| ::oController:validate( "password", ::cGetPassword ) }





   ::oGetRepeatPassword := TGetHlp():ReDefine( 131, { | u | If( PCount()==0, ::cGetRepeatPassword, ::cGetRepeatPassword:= u ) }, ::oDialog,,,,,,,,, .F., {||        ( ::oController:isNotZoomMode() )},, .F., .F.,,,,,, nil,,, )

   ::oGetRepeatPassword:bValid   := {|| ::oController:validate( "repeatPassword", ::cGetRepeatPassword ) }






   ::oComboRol := TComboBox():ReDefine( 140, { | u | If( PCount()==0, ::cComboRol, ::cComboRol:= u ) }, ::aComboRoles, ::oDialog,,,,,,, .F., {||        ( ::oController:isNotZoomMode() )},,,,,, "::oComboRol",,,,,,, )





   TButton():ReDefine( 1, {||( ::saveView( ::oDialog ) )}, ::oDialog,,, .F., {||        ( ::oController:isNotZoomMode() )},,, .F. )





   TButton():ReDefine( 2, {||( ::oDialog:end() )}, ::oDialog,,, .F.,,,, .T. )

   ::oDialog:AddFastKey( 116, {|| ::saveView() } )

   ::oDialog:Activate( , , , .T. )

   ::oBitmap:end()

RETURN ( ::oDialog:nResult )



static FUNCTION UsuariosView_saveView( ) ; local Self AS CLASS UsuariosView := QSelf() AS CLASS UsuariosView

   if !( validateDialog( ::oDialog ) )
      RETURN ( .F. )
   end

   if !empty( ::cGetPassword )
      ::getModel():setBuffer( "password", ::getModel():Crypt( ::cGetPassword ) )
   end

   ::oDialog:end( 1 )

RETURN ( ::oDialog:nResult )







_HB_CLASS UsuariosValidator ; function UsuariosValidator ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "UsuariosValidator", iif( .T., { @SQLBaseValidator() }, { @HBObject() } ), @UsuariosValidator() ) ) ;

   _HB_MEMBER getValidators(); oClass:AddMethod( "getValidators", @UsuariosValidator_getValidators(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Password(); oClass:AddMethod( "Password", @UsuariosValidator_Password(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER RepeatPassword(); oClass:AddMethod( "RepeatPassword", @UsuariosValidator_RepeatPassword(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS UsuariosValidator ;



static FUNCTION UsuariosValidator_getValidators( ) ; local Self AS CLASS UsuariosValidator := QSelf() AS CLASS UsuariosValidator








   ::hValidators  := {  "codigo" =>          {  "required"        => "El código es un dato requerido", "unique"          => "El código ya existe" }, "nombre" =>          {  "required"        => "El nombre es un dato requerido", "unique"          => "El nombre ya existe" }, "email" =>           {  "mail"            => "El email no es valido" }, "password" =>        {  "password"        => "- Contraseña debe de tener al menos ocho caracteres y un máximo de dieciseis" + Chr(13)+Chr(10) +  "- No puede contener espacios"  }, "repeatPassword" =>  {  "repeatPassword"  => "Las contraseñas no coinciden" } }

RETURN ( ::hValidators )



static FUNCTION UsuariosValidator_Password( uValue ) ; local Self AS CLASS UsuariosValidator := QSelf() AS CLASS UsuariosValidator

   uValue         := alltrim( uValue )

   if ::oController:isAppendMode() .OR. empty( ::oController:getModel():hBuffer[ "password" ] )
      RETURN ( ::Super:Password( uValue ) )
   end

   if ::oController:isEditMode() .AND. !empty( uValue )
      RETURN ( ::Super:Password( uValue ) )
   end

RETURN ( .T. )



static FUNCTION UsuariosValidator_RepeatPassword( uValue ) ; local Self AS CLASS UsuariosValidator := QSelf() AS CLASS UsuariosValidator

   if empty( ::oController:oDialogView:cGetPassword )
      RETURN ( .T. )
   end

RETURN ( alltrim( ::oController:oDialogView:cGetPassword ) == alltrim( uValue ) )








_HB_CLASS UsuariosRepository ; function UsuariosRepository ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "UsuariosRepository", iif( .T., { @SQLBaseRepository() }, { @HBObject() } ), @UsuariosRepository() ) ) ;

   _HB_MEMBER getTableName(); oClass:AddInline( "getTableName", {|Self | ( ( Self ) ), ( SQLUsuariosModel():getTableName() ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS UsuariosRepository ;







_HB_CLASS UsuariosLoginView ; function UsuariosLoginView ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "UsuariosLoginView", iif( .T., { @SQLBaseView() }, { @HBObject() } ), @UsuariosLoginView() ) ) ;

   _HB_MEMBER { oSayError } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayError"}, .F. )

   _HB_MEMBER { oGetPassword } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oGetPassword"}, .F. )
   _HB_MEMBER { cGetPassword } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cGetPassword"}, .F. )

   _HB_MEMBER { oComboUsuario } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oComboUsuario"}, .F. )
   _HB_MEMBER { cComboUsuario } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"cComboUsuario"}, .F. )
   _HB_MEMBER { aComboUsuarios } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"aComboUsuarios"}, .F. )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @UsuariosLoginView_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER onActivate(); oClass:AddMethod( "onActivate", @UsuariosLoginView_onActivate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER Validate(); oClass:AddMethod( "Validate", @UsuariosLoginView_Validate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER sayError(); oClass:AddInline( "sayError", {|Self, cError | ( ( Self ) ), ( ::oSayError:setText( cError ), ::oSayError:Show(), dialogSayNo( ::oDialog ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER changeComboUsuario(); oClass:AddMethod( "changeComboUsuario", @UsuariosLoginView_changeComboUsuario(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS UsuariosLoginView ;



static FUNCTION UsuariosLoginView_onActivate( ) ; local Self AS CLASS UsuariosLoginView := QSelf() AS CLASS UsuariosLoginView

   ::cGetPassword          := space( 100 )
   ::aComboUsuarios        := ::oController:oModel:getArrayNombres()

   if Upper( GetPvProfString(  "main",    "SeleccionUltimoUsuario", ".T.",     cIniAplication() ) ) == ".T."
      ::cComboUsuario         := ::oController:oModel:getNombreUsuarioWhereNetName( Alltrim( netname() ) + AllTrim( WNetGetUser() ) )
   else
      ::cComboUsuario         := ""
   end

RETURN ( self )



static FUNCTION UsuariosLoginView_Activate( ) ; local Self AS CLASS UsuariosLoginView := QSelf() AS CLASS UsuariosLoginView

   ::onActivate()


   ::oDialog = TDialog():New(,,,,, "LOGIN",, .F.,,,,,, .F.,,,,,, .F.,, "::oDialog", nil, )





   ::oBitmap := TBitmap():ReDefine( 900, "gestool_logo",, ::oDialog,,, .F., .F.,,, .F.,,, .T. )





   ::oComboUsuario := TComboBox():ReDefine( 100, { | u | If( PCount()==0, ::cComboUsuario, ::cComboUsuario:= u ) }, ::aComboUsuarios, ::oDialog,,,,,,, .F.,,,,,,, "::oComboUsuario",,,,,,, )

      ::oComboUsuario:bChange    := {|| ::changeComboUsuario() }




   ::oGetPassword := TGetHlp():ReDefine( 110, { | u | If( PCount()==0, ::cGetPassword, ::cGetPassword:= u ) }, ::oDialog,,,,,,,,, .F.,,, .F., .F.,,,,,, nil,,, )




   ::oSayError := TSay():ReDefine( 120,, ::oDialog,, ( 183 + ( 28 * 256 ) + ( 28 * 65536 ) ),, .F.,, .F., .F., )




   TButton():ReDefine( 1, {||( ::Validate() )}, ::oDialog,,, .F.,,,, .F. )

   ::oDialog:AddFastKey( 116, {|| ::Validate() } )

   ::oDialog:Activate( , , , .T. )

   ::oBitmap:end()

RETURN ( ::oDialog:nResult )



static FUNCTION UsuariosLoginView_Validate( ) ; local Self AS CLASS UsuariosLoginView := QSelf() AS CLASS UsuariosLoginView

   if ::oController:validUserPassword( ::cComboUsuario, ::cGetPassword )
      ::oDialog:end( 1 )
   else
      ::sayError( ::oController:cValidError )
   end

RETURN ( nil )



static FUNCTION UsuariosLoginView_changeComboUsuario( ) ; local Self AS CLASS UsuariosLoginView := QSelf() AS CLASS UsuariosLoginView

   if isUserActive( ::oController:oModel:getUuidWhereNombre( ::cComboUsuario ) )
      ::sayError( "Ususario en uso" )
   else
      ::oSayError:Hide()
   end

RETURN ( nil )








_HB_CLASS UsuariosLoginTactilView ; function UsuariosLoginTactilView ( ... ) ; STATIC s_oClass ; LOCAL nScope, oClass, oInstance ; IF s_oClass == NIL .AND. __clsLockDef( @s_oClass ) ; BEGIN SEQUENCE ; nScope := 1 ; ( ( nScope ) ) ; oClass := iif( .F.,, HBClass():new( "UsuariosLoginTactilView", iif( .T., { @SQLBaseView() }, { @HBObject() } ), @UsuariosLoginTactilView() ) ) ;

   _HB_MEMBER { oSayError } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oSayError"}, .F. )

   _HB_MEMBER { oImageList } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oImageList"}, .F. )

   _HB_MEMBER { oListView } ; oClass:AddMultiData(,, nScope + iif( .F., 16, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ), {"oListView"}, .F. )

   _HB_MEMBER Activate(); oClass:AddMethod( "Activate", @UsuariosLoginTactilView_Activate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER startActivate(); oClass:AddMethod( "startActivate", @UsuariosLoginTactilView_startActivate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )
      _HB_MEMBER initActivate(); oClass:AddMethod( "initActivate", @UsuariosLoginTactilView_initActivate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER sayError(); oClass:AddInline( "sayError", {|Self, cError | ( ( Self ) ), ( ::oSayError:setText( cError ), ::oSayError:Show(), dialogSayNo( ::oDialog ) ) }, nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

   _HB_MEMBER Validate( nOpt); oClass:AddMethod( "Validate", @UsuariosLoginTactilView_Validate(), nScope + iif( .F., 8, 0 ) + iif( .F., 256, 0 ) + iif( .F., 2048, 0 ) )

oClass:Create() ; ; ALWAYS ; __clsUnlockDef( @s_oClass, oClass ) ; end ; oInstance := oClass:Instance() ; IF __objHasMsg( oInstance, "InitClass" ) ; oInstance:InitClass( ... ) ; END ; RETURN oInstance ; END ; RETURN s_oClass:Instance() AS CLASS UsuariosLoginTactilView ;



static FUNCTION UsuariosLoginTactilView_startActivate( ) ; local Self AS CLASS UsuariosLoginTactilView := QSelf() AS CLASS UsuariosLoginTactilView

   local oStatement

   oStatement  := SQLUsuariosModel():fetchDirect()

   if !empty( oStatement )

      while oStatement:fetchDirect()

         with object ( TListViewItem():New() )
            :Cargo   := oStatement:fieldget( "nombre" )
            :cText   := Capitalize( oStatement:fieldget( "nombre" ) )
            :nImage  := 0
            :nGroup  := 1
            :Create( ::oListView )
         end

      end

      oStatement:free()

   end

   ::oListView:Refresh()

RETURN ( self )



static FUNCTION UsuariosLoginTactilView_initActivate( ) ; local Self AS CLASS UsuariosLoginTactilView := QSelf() AS CLASS UsuariosLoginTactilView

   ::oListView:SetImageList( ::oImageList )
   ::oListView:EnableGroupView()
   ::oListView:SetIconSpacing( 120, 140 )

   with object ( TListViewGroup():New() )
      :cHeader := "Usuarios"
      :Create( ::oListView )
   end

RETURN ( self )



static FUNCTION UsuariosLoginTactilView_Activate( ) ; local Self AS CLASS UsuariosLoginTactilView := QSelf() AS CLASS UsuariosLoginTactilView

   ::oImageList   := TImageList():New( 50, 50 )

   ::oImageList:AddMasked( TBitmap():Define( "gc_businessman2_50" ),   ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )
   ::oImageList:AddMasked( TBitmap():Define( "gc_user2_50" ),          ( 255 + ( 0 * 256 ) + ( 255 * 65536 ) ) )


   ::oDialog = TDialog():New(,,,,, "LOGIN_TACTIL",, .F.,,,,,, .F.,,,,,, .F.,, "::oDialog", nil, )





   ::oBitmap := TBitmap():ReDefine( 900, "gestool_logo",, ::oDialog,,, .F., .F.,,, .F.,,, .T. )

   ::oListView          := TListView():Redefine( 100, ::oDialog )
   ::oListView:nOption  := 0
   ::oListView:bClick   := {| nOpt | ::Validate( nOpt ) }




   ::oSayError := TSay():ReDefine( 120,, ::oDialog,, ( 183 + ( 28 * 256 ) + ( 28 * 65536 ) ),, .F.,, .F., .F., )




   TButton():ReDefine( 2, {||( ::oDialog:End( 2 ) )}, ::oDialog,,, .F.,,,, .F. )

   ::oDialog:bStart := {|| ::startActivate() }

   ::oDialog:Activate( , , , .T., , , {|| ::initActivate() } )

   ::oBitmap:end()

RETURN ( ::oDialog:nResult )



static FUNCTION UsuariosLoginTactilView_Validate( nOpt ) ; local Self AS CLASS UsuariosLoginTactilView := QSelf() AS CLASS UsuariosLoginTactilView

   local cUsuario
   local cPassword

   if empty( ::oListView )
      RETURN ( nil )
   end

   if empty( ::oListView:getItem( nOpt ) )
      RETURN ( nil )
   end

   cUsuario          := ::oListView:GetItem( nOpt ):Cargo

   cPassword         := VirtualKey( .T., , "Introduzca contraseña" )

   if ::oController:validUserPassword( cUsuario, cPassword )
      ::oDialog:End( 1 )
   else
      ::sayError( ::oController:cValidError )
   end

RETURN ( nil )
